<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>19.18. Highly Available Storage (HAST)</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD гарын авлага" /><link rel="up" href="disks.html" title="Бүлэг 19. Хадгалалт" /><link rel="prev" href="swap-encrypting.html" title="19.17. Swap зайг шифрлэх" /><link rel="next" href="GEOM.html" title="Бүлэг 20. GEOM: Модульчлагдсан Диск Хувиргах Тогтолцоо" /><link rel="copyright" href="legalnotice.html" title="Хуулийн заалт" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">19.18. Highly Available Storage (HAST)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="swap-encrypting.html">Өмнөх</a> </td><th width="60%" align="center">Бүлэг 19. Хадгалалт</th><td width="20%" align="right"> <a accesskey="n" href="GEOM.html">Дараах</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="disks-hast"></a>19.18. Highly Available Storage (HAST)</h2></div><div><span class="authorgroup">Хувь нэмэр болгон оруулсан <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Даниел</span> <span class="surname">Гэрзо</span></span>. </span></div><div><span class="authorgroup">Зарим нэг зүйлс нэмэрлэсэн <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Фредди</span> <span class="surname">Кэш</span></span>, <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Павел Жакуб</span> <span class="surname">Давидек</span></span>, <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Майкл В.</span> <span class="surname">Лукас</span></span> ба <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Виктор</span> <span class="surname">Петерсон</span></span>. </span></div></div></div><a id="idp83322576" class="indexterm"></a><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83323728"></a>19.18.1. Ерөнхий зүйл</h3></div></div></div><p>Байнгын бэлэн ажиллагаатай байх (High-availability) нь
	бизнесийн чухал програм хангамжуудын хувьд хамгийн гол
	шаардлага бөгөөд тийм хадгалалтын төхөөрөмж нь уг орчны
	түлхүүр хэсэг юм. Highly Available STorage буюу
	<acronym class="acronym">HAST<em><span class="remark">Highly Available
	  STorage</span></em></acronym>-г Pawel Jakub Dawidek хөгжүүлсэн бөгөөд
	энэ нь өгөгдлийг TCP/IP сүлжээнд холбогдсон хэд хэдэн
	тусдаа байгаа машинууд дээр тунгалгаар хадгалах боломжийг
	бүрдүүлдэг. <acronym class="acronym">HAST</acronym>-г сүлжээний RAID1 (толь) гэж
	ойлгож болох бөгөөд GNU/<span class="trademark">Linux</span>® тавцангийн хувьд байдаг
	DRBD® хадгалалтын системтэй төстэй юм. <acronym class="acronym">CARP</acronym>
	зэрэг FreeBSD-н бусад байнгын бэлэн ажиллагааг хангагч боломжуудын хамтаар
	<acronym class="acronym">HAST</acronym> нь тоног төхөөрөмжийн эвдрэлээс ангид
	байнгын бэлэн ажиллагаатай хадгалалтын кластер бүтээх боломжийг
	бүрдүүлдэг.</p><p>Энэ хэсгийг уншаад та дараах зүйлсийг мэдэх болно:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><acronym class="acronym">HAST</acronym> гэж юу болох, хэрхэн ажилладаг болон
	    ямар боломжуудыг хангадаг талаар.</p></li><li class="listitem"><p>FreeBSD дээр <acronym class="acronym">HAST</acronym>-г хэрхэн тохируулж
	    ашиглах талаар.</p></li><li class="listitem"><p><acronym class="acronym">CARP</acronym> болон <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">devd</span>(8)</span></a>-г
	    хэрхэн тохируулж уян хатан хадгалалтын систем бүтээх талаар.</p></li></ul></div><p>Энэ хэсгийг уншихаасаа өмнө та дараах зүйлсийг мэдсэн байх шаардлагатай:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="trademark">UNIX</span>® болон FreeBSD-ийн үндсийг ойлгосон байх
	    (<a class="xref" href="basics.html" title="Бүлэг 4. Юниксийн үндэс">Бүлэг 4, <em>Юниксийн үндэс</em></a>).</p></li><li class="listitem"><p>Сүлжээний интерфэйсүүд болон FreeBSD-н бусад гол дэд системүүдийг хэрхэн
	    тохируулах талаар мэддэг байх (<a class="xref" href="config-tuning.html" title="Бүлэг 12. Тохиргоо ба Тааруулалт">Бүлэг 12, <em>Тохиргоо ба Тааруулалт</em></a>).</p></li><li class="listitem"><p>FreeBSD-н сүлжээний талаар сайн мэддэг байх
	    (<a class="xref" href="network-communication.html" title="хэсэг IV. Сүлжээний Холболт">хэсэг IV, «Сүлжээний Холболт»</a>).</p></li><li class="listitem"><p>FreeBSD 8.1-RELEASE буюу түүнээс хойшхи хувилбарыг ашиглах.</p></li></ul></div><p><acronym class="acronym">HAST</acronym> төслийг FreeBSD сан <a class="link" href="http://www.omc.net/" target="_top">OMCnet Internet Service GmbH</a>
	болон <a class="link" href="http://www.transip.nl/" target="_top">TransIP BV</a>-н дэмжлэгтэйгээр
	санхүүжүүлжээ.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83343568"></a>19.18.2. HAST-н боломжууд</h3></div></div></div><p><acronym class="acronym">HAST</acronym> системийн гол
	боломжуудад:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Локал хатуу дискний хөтчүүд дээрх I/O алдаануудыг
	    халхлахад ашиглаж болох боломж.</p></li><li class="listitem"><p>FreeBSD-н дэмждэг дурын файлын системийг ашиглах боломжийг
	    бүрдүүлдэг файлын системээс үл хамаарсан байдал.</p></li><li class="listitem"><p>Тухайн цэг унасан байх үед зөвхөн өөрчлөгдсөн блокуудыг синхрончлох замаар
	    үр ашигтай, хурдан дахин синхрончлох боломж.</p></li><li class="listitem"><p>Нэмэлт нөөц бололцоог нэмэхийн тулд
	    аль хэдийн бий болгосон орчинд ашиглах боломж.</p></li><li class="listitem"><p><acronym class="acronym">CARP</acronym>,
	    <span class="application">Heartbeat</span> эсвэл бусад
	    хэрэгслүүдийн хамтаар уян хатан, бөх бат хадгалалтын
	    системийг бүтээхэд цуг ашиглаж боломж.</p></li></ul></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83370832"></a>19.18.3. HAST-н ажиллагаа</h3></div></div></div><p><acronym class="acronym">HAST</acronym> нь дурын хадгалалтын төхөөрөмжийн
	хувьд блок түвшний синхрон олшруулалтыг хэд хэдэн машин уруу
	хийдэг болохоор хамгийн багадаа хоёр цэг (физик машинууд) шаарддаг
	— Эдгээр нь <code class="literal">анхдагч</code> (бас
	<code class="literal">мастер</code> гэгддэг) цэг болон
	<code class="literal">хоёрдогч</code> (<code class="literal">боол</code>) цэг юм.
	Энэ хоёр машиныг хамтад нь кластер гэж дуудах болно.</p><div xmlns="" class="note"><h3 class="admontitle">Тэмдэглэл: </h3><p xmlns="http://www.w3.org/1999/xhtml">HAST нь одоогоор хоёр кластерын цэгээр
	  хязгаарлагдсан байгаа.</p></div><p><acronym class="acronym">HAST</acronym> нь анхдагч-хоёрдогч тохиргоогоор
	ажилладаг болохоор тухайн үед зөвхөн нэг кластерын цэгийг
	идэвхтэй байхыг зөвшөөрдөг. <code class="literal">анхдагч</code> цэг буюу
	<code class="literal">актив</code> нь <acronym class="acronym">HAST</acronym>-р удирдуулсан
	төхөөрөмжүүдэд хандах I/O хүсэлтүүдтэй ажилладаг цэг юм.
	<code class="literal">хоёрдогч</code> цэг нь дараа нь <code class="literal">primary</code>
	цэгээсээ автоматаар синхрончлогддог.</p><p><acronym class="acronym">HAST</acronym> системийн
	физик хэсгүүд нь:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>локал диск (анхдагч цэг дээрх)</p></li><li class="listitem"><p>алсын машин дээрх диск (хоёрдогч цэг)</p></li></ul></div><p><acronym class="acronym">HAST</acronym> нь блок түвшинд синхроноор
	ажилладаг бөгөөд энэ нь файлын системүүд болон програм хангамжуудын
	хувьд тунгалаг болгодог. <acronym class="acronym">HAST</acronym> нь
	бусад хэрэгслүүд эсвэл програм хангамжуудад ашиглах боломжтойгоор
	<code class="filename">/dev/hast/</code> санд ердийн
	GEOM үйлчилгээ үзүүлэгчдээр хангадаг бөгөөд ингэснээр
	<acronym class="acronym">HAST</acronym>-р хангагдсан төхөөрөмжүүд болон
	түүхий дискнүүд, хуваалтууд гэх зэргүүдийн хооронд ялгаа байхгүй
	болдог байна.</p><p>Бичих, устгах, эсвэл flush үйлдэл бүрийг локал диск болон
	алсын диск рүү TCP/IP ашиглан илгээдэг. Унших үйлдэлд
	локал диск дээрх мэдээлэл шинэ биш эсвэл I/O алдаа гараагүй л бол
	локал дискнээс хариу өгдөг. Хэрэв тийм тохиолдол байвал
	унших үйлдлийг хоёрдогч цэг рүү илгээдэг.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83381840"></a>19.18.3.1. Синхрончлол ба Олшруулалтын горимууд</h4></div></div></div><p><acronym class="acronym">HAST</acronym> нь унасан байдлаас хурдан сэргээх
	  боломжийг бий болгохыг оролддог. Энэ зорилгоор цэг унасны дараа
	  синхрончлох хугацааг багасгах нь хамгийн чухал юм. Синхрончлолыг
	  хурдан хангахын тулд <acronym class="acronym">HAST</acronym> нь диск дээрх
	  бохир өгөгдлүүдийн битмапыг зохицуулж байдаг бөгөөд ердийн
	  синхрончлолын үед зөвхөн тэдгээрийг синхрончилдог (эхний синхрончлолыг
	  тооцолгүйгээр).</p><p>Синхрончлолтой ажиллах олон аргууд байдаг.
	  <acronym class="acronym">HAST</acronym> нь янз бүрийн синхрончлолын аргуудтай (доор дурдсан)
	  ажиллахын тулд хэд хэдэн олшруулалтын горимыг хийдэг:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="emphasis"><em>memsync</em></span>: локал бичих үйлдэл
	      дууссан ба алсын цэг өгөгдөл ирснийг баталгаажуулсан бөгөөд
	      өгөгдлийг яг хадгалахаас өмнөх үед бичих үйлдэл дууссан гэж үздэг.
	      Алсын цэг дээрх өгөгдөл баталгаажуулалт илгээгдсэний дараа
	      хадгалагддаг. Энэ горим нь саатлыг багасгах зориулалттай
	      бөгөөд маш сайн найдвартай байдлыг хангадаг.
	      <span class="emphasis"><em>memsync</em></span> олшруулалтын горим нь одоогоор
	      хийгдээгүй байгаа.</p></li><li class="listitem"><p><span class="emphasis"><em>fullsync</em></span>: локал болон алсын бичих
	      үйлдэл хийгдэж дууссаны дараа бичих үйлдэл дууссан гэж үздэг. Энэ нь
	      хамгийн найдвартай бөгөөд удаан горим юм. Энэ горим нь анхдагч
	      байдаг.</p></li><li class="listitem"><p><span class="emphasis"><em>async</em></span>: локал бичих үйлдэл дууссан үед
	      бичих үйлдлийг дууссан гэж үздэг. Энэ нь хамгийн хурдан бөгөөд
	      аюултай олшруулалтын горим юм. Энэ горимыг бусад горимын хувьд
	      саатал хэтэрхий өндөр байгаа алсын цэг рүү олшруулахдаа
	      ашиглах ёстой. <span class="emphasis"><em>async</em></span> олшруулалтын горим
	      одоогоор хийгдээгүй байгаа.</p></li></ul></div><div xmlns="" class="warning"><h3 class="admontitle">Сануулга: </h3><p xmlns="http://www.w3.org/1999/xhtml">Зөвхөн <span class="emphasis"><em>fullsync</em></span> олшруулалтын горим
	    одоогоор дэмжигдсэн.</p></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83390032"></a>19.18.4. HAST-н тохиргоо</h3></div></div></div><p><acronym class="acronym">HAST</acronym> нь ажиллахын тулд
	<code class="literal">GEOM_GATE</code> дэмжлэгийг шаарддаг.
	<code class="literal">GENERIC</code> цөм нь анхдагчаар
	<code class="literal">GENERIC</code>-г <span class="emphasis"><em>агуулдаггүй</em></span>
	боловч FreeBSD-н анхдагч суулгацад дуудагдах боломжтой
	<code class="filename">geom_gate.ko</code> модуль байдаг.
	Мөн дараах мөрийг цөмийн тохиргооны файлд нэмэн
	<code class="literal">GEOM_GATE</code> дэмжлэгийг цөмд оруулан бүтээж
	болдог:</p><pre class="programlisting">options	GEOM_GATE</pre><p><acronym class="acronym">HAST</acronym> тогтолцоо нь үйлдлийн
	системийн өнцгөөс харахад хэд хэдэн хэсгээс тогтдог:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>өгөгдлийн синхрончлолд зориулсан <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hastd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">hastd</span>(8)</span></a>
	    демон,</p></li><li class="listitem"><p>хэрэглэгчийн талбарын удирдлагын хэрэгсэл <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hastctl&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">hastctl</span>(8)</span></a>,</p></li><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hast.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">hast.conf</span>(5)</span></a> тохиргооны файл.</p></li></ul></div><p>Дараах жишээ хоёр цэгийг
	<code class="literal">мастер</code>-<code class="literal">боол</code> /
	<code class="literal">анхдагч</code>-<code class="literal">хоёрдогч</code>
	үйлдлийн хувьд өгөгдлийг уг хоёр цэгийн хооронд олшруулахын
	тулд <acronym class="acronym">HAST</acronym> ашиглан тохируулах талаар
	тайлбарлана. Цэгүүдийг <em class="replaceable"><code>172.16.0.1</code></em> IP
	хаягтай <code class="literal">hasta</code> болон
	<em class="replaceable"><code>172.16.0.2</code></em> IP хаягтай
	<code class="literal">hastb</code> гэж нэрлэе.
	Эдгээр цэгүүд нь <acronym class="acronym">HAST</acronym> үйлдлийн хувьд ижил хэмжээтэй
	өөр өөрийн <code class="filename">/dev/ad6</code>
	хатуу дисктэй байна. <acronym class="acronym">HAST</acronym> нөөцийг (заримдаа
	эх үүсвэр гэгддэг, өөрөөр хэлбэл <code class="filename">/dev/hast/</code> дахь GEOM үйлчилгээ
	үзүүлэгч) <code class="filename">test</code>
	гэж нэрлэнэ.</p><p><acronym class="acronym">HAST</acronym>-н тохиргоог
	<code class="filename">/etc/hast.conf</code> файлд хийнэ. Энэ файл нь
	хоёр цэг дээр ижил байх ёстой. Боломжит хамгийн хялбар
	тохиргоо дараах байдалтай байна:</p><pre class="programlisting">resource test {
	on hasta {
		local /dev/ad6
		remote 172.16.0.2
	}
	on hastb {
		local /dev/ad6
		remote 172.16.0.1
	}
}</pre><p>Илүү дэлгэрэнгүй тохиргооны талаар
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hast.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">hast.conf</span>(5)</span></a> гарын авлагаас үзнэ үү.</p><div xmlns="" class="tip"><h3 class="admontitle">Зөвлөгөө: </h3><p xmlns="http://www.w3.org/1999/xhtml">Мөн <code class="literal">remote</code> гэсэн хэсэгт хостын
	  нэрийг ашиглаж бас болно. Тэр тохиолдолд тэдгээр хостуудыг
	  таних боломжтой байх ёстойг анхаараарай, өөрөөр хэлбэл
	  тэдгээр нь <code class="filename">/etc/hosts</code> файл юм уу эсвэл
	  локал <acronym class="acronym">DNS</acronym> дээр тодорхойлогдсон байх
	  ёстой.</p></div><p>Одоо хоёр цэг дээр тохиргоо байгаа болохоор
	<acronym class="acronym">HAST</acronym> нөөцийг үүсгэх боломжтой. Хоёр
	цэг дээр дараах тушаалыг ажиллуулж эхний мета өгөгдлийг
	локал диск дээр байрлуулж <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hastd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">hastd</span>(8)</span></a> демонг ажиллуулна:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>hastctl create test</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/hastd onestart</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Тэмдэглэл: </h3><p xmlns="http://www.w3.org/1999/xhtml">GEOM үйлчилгээ үзүүлэгчдийг одоо байгаа файлын
	  систем дээр ашиглаж <span class="emphasis"><em>болохгүй</em></span>
	  (жишээ нь <acronym class="acronym">HAST</acronym>-р удирдуулсан нөөц рүү
	  одоо байгаа хадгалалтын төхөөрөмжийг хувиргах). Учир нь
	  энэ процедур нь ямар нэг мета өгөгдлийг үйлчилгээ
	  үзүүлэгч дээр хадгалах хэрэгтэй байдаг бөгөөд шаардлагатай
	  зай хангалттай байхгүй байх болно.</p></div><p>HAST цэгийн үүргийг
	(<code class="literal">анхдагч</code> эсвэл <code class="literal">хоёрдогч</code>)
	администратор тохируулах юм уу эсвэл
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hastctl&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">hastctl</span>(8)</span></a> хэрэгсэл ашиглан <span class="application">Heartbeat</span>
	зэрэг бусад програмаар тохируулж болно. Анхдагч цэг рүү
	(<code class="literal">hasta</code>) шилжээд
	дараах тушаалыг өгнө:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>hastctl role primary test</code></strong></pre><p>Үүнтэй адилаар хоёрдогч цэг дээр
	(<code class="literal">hastb</code>)
	дараах тушаалыг ажиллуулна:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>hastctl role secondary test</code></strong></pre><div xmlns="" class="caution"><h3 class="admontitle">Анхааруулга: </h3><p xmlns="http://www.w3.org/1999/xhtml">Хоёр цэг хоорондоо холбогдож чадахгүй бөгөөд
	  хоёулаа анхдагч гэж тохируулагдсан бол үүнийг
	  <code class="literal">split-brain</code> гэж нэрлэдэг.
	  Энэ тохиолдолд алдааг олж засварлахын тулд <a class="xref" href="disks-hast.html#disks-hast-sb" title="19.18.5.2. Split-brain нөхцлөөс сэргэж гарах">Хэсэг 19.18.5.2, «Split-brain нөхцлөөс сэргэж гарах»</a> хэсэгт зааснаар ажиллана.</p></div><p>Цэг бүр дээр <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hastctl&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">hastctl</span>(8)</span></a> хэрэгсэл
	ашиглан үр дүнг шалгаж болно:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>hastctl status test</code></strong></pre><p>Хамгийн чухал текст нь <code class="literal">status</code>
	мөр бөгөөд хоёр цэг дээр <code class="literal">complete</code> гэж
	байх ёстой. Хэрэв энэ нь <code class="literal">degraded</code>
	гэж байх юм бол ямар нэг юм болохоо больсныг илтгэнэ.
	Энэ үед цэгүүдийн хооронд синхрончлол явагдаад эхэлчихсэн
	байна. <code class="command">hastctl status</code> тушаал
	<code class="literal">dirty</code> гэдэг дээр 0 байт харуулж байвал
	синхрончлол дууссан гэсэн үг юм.</p><p>Дараагийн алхам бол <code class="filename">/dev/hast/test</code>
	GEOM үйлчилгээ үзүүлэгч дээр файлын систем үүсгэж холбох явдал юм.
	Үүнийг <code class="literal">анхдагч</code> цэг (учир нь
	<code class="filename">/dev/hast/test</code>
	зөвхөн <code class="literal">primary</code> цэг дээр харагдана) дээр
	хийх ёстой. Хатуу дискийн хэмжээнээс хамаарч хэдэн
	минут үргэлжилж болох юм:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/hast/test</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mkdir /hast/test</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/hast/test /hast/test</code></strong></pre><p><acronym class="acronym">HAST</acronym> тогтолцоог зөв тохируулсны дараа
	хамгийн сүүлийн алхам бол <acronym class="acronym">HAST</acronym> систем
	ачаалах үед автоматаар эхэлсэн байхыг шалгах явдал юм.
	Дараах мөрийг <code class="filename">/etc/rc.conf</code> файлд
	нэмж өгөх шаардлагатай:</p><pre class="programlisting">hastd_enable="YES"</pre><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83453264"></a>19.18.4.1. Нэгээс нөгөөд шилжих тохиргоо</h4></div></div></div><p>Энэ жишээний зорилго нь өгөгдсөн дурын цэг ажиллахаа
	  больсон тохиолдолд ажиллаж байх уян хатан хадгалалтын
	  систем бүтээх явдал юм.
	  Кластерын <code class="literal">анхдагч</code> цэг ажиллахаа болих
	  тохиолдол байж болно. Хэрэв ийм явдал боллоо гэхэд
	  <code class="literal">хоёрдогч</code> цэг сааталгүйгээр авч
	  ажиллан файлын системийг шалган холбож өгөгдлийн нэг
	  ч битийг алдалгүйгээр үргэлжлүүлэн ажиллах ёстой.</p><p>Энэ зорилтод хүрэхийн тулд FreeBSD-ийн
	  IP давхарга дээр автоматаар шилжих боломжийг
	  бүрдүүлдэг <acronym class="acronym">CARP</acronym>-г ашиглах шаардлагатай
	  байдаг. <acronym class="acronym">CARP</acronym> (Common Address Redundancy Protocol)
	  ижил сүлжээнд олон хостууд IP хаяг
	  хуваалцаж хэрэглэх боломжийг бүрдүүлдэг. <acronym class="acronym">CARP</acronym>-г
	  кластерын цэг бүр дээр <a class="xref" href="carp.html" title="32.13. Common Address Redundancy Protocol (CARP)">Хэсэг 32.13, «Common Address Redundancy Protocol (CARP)»</a> хэсэгт зааснаар
	  тохируулна. Үүнийг хийсний дараа цэг бүр
	  хуваалцсан IP <em class="replaceable"><code>172.16.0.254</code></em> гэсэн
	    хаягтай <code class="filename">carp0</code> гэсэн интерфэйстэй байх
	    болно. Кластерын анхдагч <acronym class="acronym">HAST</acronym> цэг
	    мастер <acronym class="acronym">CARP</acronym> цэг байх ёстой.</p><p>Өмнөх хэсэгт үүсгэсэн <acronym class="acronym">HAST</acronym> нөөц
	  сүлжээн дэх бусад хостууд руу экспорт хийгдэхэд
	  бэлэн болсон байна. Үүнийг <acronym class="acronym">NFS</acronym>,
	  <span class="application">Samba</span> гэх мэтүүдийн тусламжтайгаар
	  хуваалцсан IP хаяг <em class="replaceable"><code>172.16.0.254</code></em>
	  ашиглан экспорт хийх замаар хийнэ. Шийдэгдээгүй цор
	  ганц асуудал бол анхдагч цэг унахад автоматаар шилжих
	  асуудал юм.</p><p>Хэрэв <acronym class="acronym">CARP</acronym> интерфэйсүүд унаж босоод
	  байвал FreeBSD үйлдлийн систем <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">devd</span>(8)</span></a> үйл явдал гаргах
	  бөгөөд энэ нь <acronym class="acronym">CARP</acronym> интерфэйсүүд дээр
	  төлвийг харах боломжийг бүрдүүлдэг. <acronym class="acronym">CARP</acronym>
	  интерфэйс дээрх төлвийн өөрчлөлт нь аль нэг цэг ажиллахаа
	  байсан эсвэл ажиллаж эхэлснийг харуулна. Эдгээр төлвийн өөрчлөлт нь
	  HAST шилжилтийг автоматаар зохицуулах тусгай скриптийг
	  ажиллуулах боломжтой юм.</p><p><acronym class="acronym">CARP</acronym> интерфэйсүүд дээрх төлвийн өөрчлөлтүүдийг
	  барьж чадахын тулд дараах тохиргоог цэг бүр дээр
	  <code class="filename">/etc/devd.conf</code> файлд хийж өгөх ёстой:</p><pre class="programlisting">notify 30 {
	match "system" "IFNET";
	match "subsystem" "carp0";
	match "type" "LINK_UP";
	action "/usr/local/sbin/carp-hast-switch master";
};

notify 30 {
	match "system" "IFNET";
	match "subsystem" "carp0";
	match "type" "LINK_DOWN";
	action "/usr/local/sbin/carp-hast-switch slave";
};</pre><p>Шинэ тохиргоог идэвхтэй болгохын тулд
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">devd</span>(8)</span></a>-г цэг бүр дээр дахин ажиллуулна:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/devd restart</code></strong></pre><p><code class="filename">carp0</code> интерфэйс унаж босож байгаа
	  тохиолдолд (өөрөөр хэлбэр интерфэйсийн төлөв өөрчлөлгдсөн тохиолдолд)
	  систем мэдээлэл өгөх бөгөөд энэ нь <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">devd</span>(8)</span></a> дэд системд
	  скрипт ажиллуулах боломжийг бүрдүүлэх бөгөөд энэ тохиолдолд
	  <code class="filename">/usr/local/sbin/carp-hast-switch</code> байна. Энэ скрипт нь
	  автоматаар шилжих шилжилтийг зохицуулах юм. Дээрх <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">devd</span>(8)</span></a>
	  тохиргооны талаар дэлгэрэнгүйг <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devd.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">devd.conf</span>(5)</span></a> гарын авлагаас
	  үзнэ үү.</p><p>Ийм скриптийн жишээ дараах байдлаар байж болох юм:</p><pre class="programlisting">#!/bin/sh

# Original script by Freddie Cash &lt;fjwcash@gmail.com&gt;
# Modified by Michael W. Lucas &lt;mwlucas@BlackHelicopters.org&gt;
# and Viktor Petersson &lt;vpetersson@wireload.net&gt;

# The names of the HAST resources, as listed in /etc/hast.conf
resources="test"

# delay in mounting HAST resource after becoming master
# make your best guess
delay=3

# logging
log="local0.debug"
name="carp-hast"

# end of user configurable stuff

case "$1" in
	master)
		logger -p $log -t $name "Switching to primary provider for ${resources}."
		sleep ${delay}

		# Wait for any "hastd secondary" processes to stop
		for disk in ${resources}; do
			while $( pgrep -lf "hastd: ${disk} \(secondary\)" &gt; /dev/null 2&gt;&amp;1 ); do
				sleep 1
			done

			# Switch role for each disk
			hastctl role primary ${disk}
			if [ $? -ne 0 ]; then
				logger -p $log -t $name "Unable to change role to primary for resource ${disk}."
				exit 1
			fi
		done

		# Wait for the /dev/hast/* devices to appear
		for disk in ${resources}; do
			for I in $( jot 60 ); do
				[ -c "/dev/hast/${disk}" ] &amp;&amp; break
				sleep 0.5
			done

			if [ ! -c "/dev/hast/${disk}" ]; then
				logger -p $log -t $name "GEOM provider /dev/hast/${disk} did not appear."
				exit 1
			fi
		done

		logger -p $log -t $name "Role for HAST resources ${resources} switched to primary."


		logger -p $log -t $name "Mounting disks."
		for disk in ${resources}; do
			mkdir -p /hast/${disk}
			fsck -p -y -t ufs /dev/hast/${disk}
			mount /dev/hast/${disk} /hast/${disk}
		done

	;;

	slave)
		logger -p $log -t $name "Switching to secondary provider for ${resources}."

		# Switch roles for the HAST resources
		for disk in ${resources}; do
			if ! mount | grep -q "^/dev/hast/${disk} on "
			then
			else
				umount -f /hast/${disk}
			fi
			sleep $delay
			hastctl role secondary ${disk} 2&gt;&amp;1
			if [ $? -ne 0 ]; then
				logger -p $log -t $name "Unable to switch role to secondary for resource ${disk}."
				exit 1
			fi
			logger -p $log -t $name "Role switched to secondary for resource ${disk}."
		done
	;;
esac</pre><p>Товчхондоо скрипт нь эдгээр алхмуудыг цэг <code class="literal">мастер</code> /
	  <code class="literal">анхдагч</code> болох үед хийнэ:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Өгөгдсөн цэг дээр <acronym class="acronym">HAST</acronym> нөөцийг анхдагч
	      болгоно.</p></li><li class="listitem"><p><acronym class="acronym">HAST</acronym> нөөц доор байгаа файлын системийг
	      шалгана.</p></li><li class="listitem"><p>Тохирох газарт нь нөөцүүдийг холбоно.</p></li></ul></div><p><code class="literal">нөөц</code> /
	  <code class="literal">хоёрдогч</code> болсон тохиолдолд:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><acronym class="acronym">HAST</acronym> нөөцүүдийг салгана.</p></li><li class="listitem"><p><acronym class="acronym">HAST</acronym> нөөцүүдийг хоёрдогч болгож
	      бууруулна.</p></li></ul></div><div xmlns="" class="caution"><h3 class="admontitle">Анхааруулга: </h3><p xmlns="http://www.w3.org/1999/xhtml">Энэ нь зөвхөн боломжой шийдэл байдаг гэдгийг харуулсан
	    жишээ скрипт гэдгийг санаарай. Энэ нь бүх л боломжит
	    нөхцлийг тооцоогүй бөгөөд шаардлагатай үйлчилгээг эхлүүлэх/зогсоох
	    гэх мэтээр сайжруулж өргөтгөх юм уу эсвэл
	    дураараа өөрчлөх боломжтой юм.</p></div><div xmlns="" class="tip"><h3 class="admontitle">Зөвлөгөө: </h3><p xmlns="http://www.w3.org/1999/xhtml">Энэ жишээн дээр бид стандарт UFS файлын системийг
	    ашигласан. Сэргээхэд шаардлагатай цагийг багасгахын
	    тулд журнал дэмжигдсэн UFS эсвэл ZFS файлын системийг
	    ашиглаж болох юм.</p></div><p>Нэмэлт жишээнүүд бүхий илүү дэлгэрэнгүй мэдээллийг
	  <a class="link" href="http://wiki.FreeBSD.org/HAST" target="_top">HAST Wiki</a> хуудаснаас
	  олж болно.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83498320"></a>19.18.5. Алдааг олж засварлах</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83498960"></a>19.18.5.1. Алдааг олж засварлах ерөнхий аргууд</h4></div></div></div><p><acronym class="acronym">HAST</acronym> ерөнхийдөө асуудалгүй ажиллах
	  ёстой. Гэхдээ бусад програмуудын нэгэн адил ажиллах ёстойгоосоо
	  өөрөөр ажиллах тохиолдол байдаг. Асуудлын шалтгаан өөр өөр
	  байж болох боловч гол шалгах юм нь кластерын цэгүүдийн
	  хооронд цаг синхрончлогдсон байгаа эсэхийг мэдэх явдал
	  юм.</p><p><acronym class="acronym">HAST</acronym>-н асуудлуудыг шалгаж байхдаа
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hastd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">hastd</span>(8)</span></a>-г <code class="literal">-d</code> өгөгдөлтэйгээр
	  ажиллуулан <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hastd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">hastd</span>(8)</span></a>-н дибаг түвшинг ихэсгэж үзэх ёстой.
	  Дибаг түвшинг дахин дахин ихэсгэхийн
	  тулд энэ аргументыг олон удаа тавьж өгч болно. Энэ замаар
	  маш их хэрэгтэй мэдээллийг олж авч болно.
	  Мөн <code class="literal">-F</code> аргументыг ашиглан <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=hastd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">hastd</span>(8)</span></a>
	  демонг ил ажиллуулах нь зүйтэй байдаг.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="disks-hast-sb"></a>19.18.5.2. Split-brain нөхцлөөс сэргэж гарах</h4></div></div></div><p><code class="literal">split-brain</code> гэдэг нь хоёр цэг нэг нэгэнтэйгээ
	  холбогдож чадахгүй бөгөөд хоёул анхдагч цэг гэж тохируулагдсан
	  үе юм. Энэ нь аюултай нөхцөл
	  бөгөөд учир нь энэ тохиолдолд өгөгдөлд хоёр цэг хоёул
	  нийцгүй өөрчлөлтийг хийх боломжийг олгодог. Энэ нөхцлийг
	  системийн администратор гараар засварлах шаардлагатай.</p><p>Администратор аль цэг хамгийн чухал өөрчлөлттэй байгаа дээр шийдвэр
	  гаргаж (эсвэл гараар нийлүүлэн) <acronym class="acronym">HAST</acronym>-д
	  эвдэрсэн өгөгдөл бүхий цэгийн бүтэн синхрончлол хийх
	  боломжийг олгох ёстой. Ингэхийн тулд дараах тушаалуудыг
	  дахин синхрончлол шаардлагатай байгаа цэг дээр ажиллуулна:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>hastctl role init &lt;resource&gt;</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>hastctl create &lt;resource&gt;</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>hastctl role secondary &lt;resource&gt;</code></strong></pre></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="swap-encrypting.html">Өмнөх</a> </td><td width="20%" align="center"><a accesskey="u" href="disks.html">Дээш</a></td><td width="40%" align="right"> <a accesskey="n" href="GEOM.html">Дараах</a></td></tr><tr><td width="40%" align="left" valign="top">19.17. Swap зайг шифрлэх </td><td width="20%" align="center"><a accesskey="h" href="index.html">Эхлэл</a></td><td width="40%" align="right" valign="top"> Бүлэг 20. GEOM: Модульчлагдсан Диск Хувиргах Тогтолцоо</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Энэ болон бусад баримтуудыг
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>
    хаягаас татаж авч болно.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>FreeBSD-ийн талаар
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;
    хаягтай холбоо барихаасаа өмнө
    <a href="http://www.FreeBSD.org/docs.html">баримтыг</a> уншина уу.<br></br>
    Энэ бичиг баримттай холбоотой асуулт байвал
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;
    хаягаар цахим захидал явуулна уу.<br></br>
    Энэ бичиг баримтын орчуулгатай холбоотой асуулт байвал
    &lt;<a href="mailto:admin@mnbsd.org">admin@mnbsd.org</a>&gt;
    хаягаар цахим захидал явуулна уу.</small></p></body></html>