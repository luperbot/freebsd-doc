<?xml version="1.0" encoding="iso-8859-7" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-7" /><title>29.4. Network Information System (NIS/YP)</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Εγχειρίδιο του FreeBSD" /><link rel="up" href="network-servers.html" title="Κεφάλαιο 29. Εξυπηρετητές Δικτύου" /><link rel="prev" href="network-nfs.html" title="29.3. Network File System (NFS)" /><link rel="next" href="network-dhcp.html" title="29.5. Automatic Network Configuration (DHCP)" /><link rel="copyright" href="legalnotice.html" title="Νομική Σημείωση" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">29.4. Network Information System (NIS/YP)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="network-nfs.html">Προηγ</a> </td><th width="60%" align="center">Κεφάλαιο 29. Εξυπηρετητές Δικτύου</th><td width="20%" align="right"> <a accesskey="n" href="network-dhcp.html">Επόμενο</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="network-nis"></a>29.4. Network Information System (NIS/YP)</h2></div><div><span class="authorgroup">Written by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Bill</span> <span class="surname">Swingle</span></span>. </span></div><div><span class="authorgroup">Enhanced by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Eric</span> <span class="surname">Ogren</span></span> και <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Udo</span> <span class="surname">Erdelhoff</span></span>. </span></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97546320"></a>29.4.1. What Is It?</h3></div></div></div><a id="idp97559376" class="indexterm"></a><a id="idp97559888" class="indexterm"></a><a id="idp97560400" class="indexterm"></a><a id="idp97560912" class="indexterm"></a><a id="idp97561424" class="indexterm"></a><a id="idp97561936" class="indexterm"></a><a id="idp97562448" class="indexterm"></a><p><acronym class="acronym">NIS</acronym>,
        which stands for Network Information Services, was developed
        by Sun Microsystems to centralize administration of <span class="trademark">UNIX</span>(R)
        (originally <span class="trademark">SunOS</span>TM) systems.  It has now essentially become
        an industry standard; all major <span class="trademark">UNIX</span>(R) like systems
        (<span class="trademark">Solaris</span>TM, HP-UX, <span class="trademark">AIX</span>(R), Linux, NetBSD, OpenBSD, FreeBSD,
        etc) support <acronym class="acronym">NIS</acronym>.</p><a id="idp97566544" class="indexterm"></a><p><acronym class="acronym">NIS</acronym>
	was formerly known as Yellow Pages, but because of trademark
	issues, Sun changed the name.  The old term (and yp) is still
	often seen and used.</p><a id="idp97580496" class="indexterm"></a><p>It is a RPC-based client/server system that allows a group
	of machines within an NIS domain to share a common set of
	configuration files.  This permits a system administrator to
	set up NIS client systems with only minimal configuration data
	and add, remove or modify configuration data from a single
	location.</p><a id="idp97582032" class="indexterm"></a><p>It is similar to the <span class="trademark">Windows NT</span>(R) domain system; although
        the internal implementation of the two are not at all similar,
        the basic functionality can be compared.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97583568"></a>29.4.2. Terms/Processes You Should Know</h3></div></div></div><p>There are several terms and several important user
        processes that you will come across when attempting to
        implement NIS on FreeBSD, whether you are trying to create an
        NIS server or act as an NIS client:</p><a id="idp97584592" class="indexterm"></a><a id="idp97585488" class="indexterm"></a><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody><tr><td>NIS domainname</td><td>An NIS master server and all of its clients
		(including its slave servers) have a NIS domainname.
		Similar to an <span class="trademark">Windows NT</span>(R) domain name, the NIS
		domainname does not have anything to do with
		<acronym class="acronym">DNS</acronym>.</td></tr><tr><td><span class="application">rpcbind</span></td><td>Must be running in order to enable
		<acronym class="acronym">RPC</acronym> (Remote Procedure Call, a
		network protocol used by NIS).  If
		<span class="application">rpcbind</span> is not running, it
		will be impossible to run an NIS server, or to act as
		an NIS client.</td></tr><tr><td><span class="application">ypbind</span></td><td><span class="quote">«<span class="quote">Binds</span>»</span> an NIS client to its NIS
		server.  It will take the NIS domainname from the
		system, and using <acronym class="acronym">RPC</acronym>, connect to
		the server.  <span class="application">ypbind</span> is the
		core of client-server communication in an NIS
		environment; if <span class="application">ypbind</span> dies
		on a client machine, it will not be able to access the
		NIS server.</td></tr><tr><td><span class="application">ypserv</span></td><td>Should only be running on NIS servers; this is
		the NIS server process itself.  If <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ypserv</span>(8)</span></a>
		dies, then the server will no longer be able to
		respond to NIS requests (hopefully, there is a slave
		server to take over for it).  There are some
		implementations of NIS (but not the FreeBSD one), that
		do not try to reconnect to another server if the
		server it used before dies.  Often, the only thing
		that helps in this case is to restart the server
		process (or even the whole server) or the
		<span class="application">ypbind</span> process on the
		client.
	      </td></tr><tr><td><span class="application">rpc.yppasswdd</span></td><td>Another process that should only be running on
		NIS master servers; this is a daemon that will allow NIS
		clients to change their NIS passwords.  If this daemon
		is not running, users will have to login to the NIS
		master server and change their passwords there.</td></tr></tbody></table></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97605584"></a>29.4.3. How Does It Work?</h3></div></div></div><p>There are three types of hosts in an NIS environment:
	master servers, slave servers, and clients.  Servers act as a
	central repository for host configuration information.  Master
	servers hold the authoritative copy of this information, while
	slave servers mirror this information for redundancy.  Clients
	rely on the servers to provide this information to
	them.</p><p>Information in many files can be shared in this manner.
	The <code class="filename">master.passwd</code>,
	<code class="filename">group</code>, and <code class="filename">hosts</code>
	files are commonly shared via NIS.  Whenever a process on a
	client needs information that would normally be found in these
	files locally, it makes a query to the NIS server that it is
	bound to instead.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97612368"></a>29.4.3.1. Machine Types</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A <span class="emphasis"><em>NIS master server</em></span><a id="idp97614032" class="indexterm"></a>.  This
              server, analogous to a <span class="trademark">Windows NT</span>(R) primary domain
              controller, maintains the files used by all of the NIS
              clients.  The <code class="filename">passwd</code>,
              <code class="filename">group</code>, and other various files used
              by the NIS clients live on the master server.</p><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><p xmlns="http://www.w3.org/1999/xhtml">It is possible for one machine to be an NIS
              master server for more than one NIS domain.  However,
              this will not be covered in this introduction, which
              assumes a relatively small-scale NIS
              environment.</p></div></li><li class="listitem"><p><span class="emphasis"><em>NIS slave servers</em></span><a id="idp97617616" class="indexterm"></a>.  Similar to
              the <span class="trademark">Windows NT</span>(R) backup domain controllers, NIS slave
              servers maintain copies of the NIS master's data files.
              NIS slave servers provide the redundancy, which is
              needed in important environments.  They also help to
              balance the load of the master server: NIS Clients
              always attach to the NIS server whose response they get
              first, and this includes slave-server-replies.</p></li><li class="listitem"><p><span class="emphasis"><em>NIS clients</em></span><a id="idp97619792" class="indexterm"></a>.  NIS clients, like
              most <span class="trademark">Windows NT</span>(R) workstations, authenticate against the
              NIS server (or the <span class="trademark">Windows NT</span>(R) domain controller in the
              <span class="trademark">Windows NT</span>(R) workstations case) to log on.</p></li></ul></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97622864"></a>29.4.4. Using NIS/YP</h3></div></div></div><p>This section will deal with setting up a sample NIS
        environment.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97623888"></a>29.4.4.1. Planning</h4></div></div></div><p>Let us assume that you are the administrator of a small
          university lab.  This lab, which consists of 15 FreeBSD
          machines, currently has no centralized point of
          administration; each machine has its own
          <code class="filename">/etc/passwd</code> and
          <code class="filename">/etc/master.passwd</code>.  These files are
          kept in sync with each other only through manual
          intervention; currently, when you add a user to the lab, you
          must run <code class="command">adduser</code> on all 15 machines.
          Clearly, this has to change, so you have decided to convert
          the lab to use NIS, using two of the machines as
          servers.</p><p>Therefore, the configuration of the lab now looks something
          like:</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Machine name</th><th>IP address</th><th>Machine role</th></tr></thead><tbody><tr><td><code class="systemitem">ellington</code></td><td><code class="systemitem">10.0.0.2</code></td><td>NIS master</td></tr><tr><td><code class="systemitem">coltrane</code></td><td><code class="systemitem">10.0.0.3</code></td><td>NIS slave</td></tr><tr><td><code class="systemitem">basie</code></td><td><code class="systemitem">10.0.0.4</code></td><td>Faculty workstation</td></tr><tr><td><code class="systemitem">bird</code></td><td><code class="systemitem">10.0.0.5</code></td><td>Client machine</td></tr><tr><td><code class="systemitem">cli[1-11]</code></td><td><code class="systemitem">10.0.0.[6-17]</code></td><td>Other client machines</td></tr></tbody></table></div><p>If you are setting up a NIS scheme for the first time, it
	  is a good idea to think through how you want to go about it.  No
	  matter what the size of your network, there are a few decisions
	  that need to be made.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97644240"></a>29.4.4.1.1. Choosing a NIS Domain Name</h5></div></div></div><a id="idp97644880" class="indexterm"></a><p>This might not be the <span class="quote">«<span class="quote">domainname</span>»</span> that
	    you are used to.  It is more accurately called the
	    <span class="quote">«<span class="quote">NIS domainname</span>»</span>.  When a client broadcasts
	    its requests for info, it includes the name of the NIS
	    domain that it is part of.  This is how multiple servers
	    on one network can tell which server should answer which
	    request.  Think of the NIS domainname as the name for a
	    group of hosts that are related in some way.</p><p>Some organizations choose to use their Internet
	    domainname for their NIS domainname.  This is not
	    recommended as it can cause confusion when trying to debug
	    network problems.  The NIS domainname should be unique
	    within your network and it is helpful if it describes the
	    group of machines it represents.  For example, the Art
	    department at Acme Inc. might be in the
	    <span class="quote">«<span class="quote">acme-art</span>»</span> NIS domain.  For this example,
	    assume you have chosen the name
	    <code class="literal">test-domain</code>.</p><a id="idp97648336" class="indexterm"></a><p>However, some operating systems (notably <span class="trademark">SunOS</span>TM) use
          their NIS domain name as their Internet domain name.  If one
          or more machines on your network have this restriction, you
          <span class="emphasis"><em>must</em></span> use the Internet domain name as
          your NIS domain name.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97658448"></a>29.4.4.1.2. Physical Server Requirements</h5></div></div></div><p>There are several things to keep in mind when choosing
	    a machine to use as a NIS server.  One of the unfortunate
	    things about NIS is the level of dependency the clients
	    have on the server.  If a client cannot contact the server
	    for its NIS domain, very often the machine becomes
	    unusable.  The lack of user and group information causes
	    most systems to temporarily freeze up.  With this in mind
	    you should make sure to choose a machine that will not be
	    prone to being rebooted regularly, or one that might be
	    used for development.  The NIS server should ideally be a
	    stand alone machine whose sole purpose in life is to be an
	    NIS server.  If you have a network that is not very
	    heavily used, it is acceptable to put the NIS server on a
	    machine running other services, just keep in mind that if
	    the NIS server becomes unavailable, it will affect
	    <span class="emphasis"><em>all</em></span> of your NIS clients
	    adversely.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97660112"></a>29.4.4.2. NIS Servers</h4></div></div></div><p> The canonical copies of all NIS information are stored
	  on a single machine called the NIS master server.  The
	  databases used to store the information are called NIS maps.
	  In FreeBSD, these maps are stored in
	  <code class="filename">/var/yp/[domainname]</code> where
	  <code class="filename">[domainname]</code> is the name of the NIS
	  domain being served.  A single NIS server can support
	  several domains at once, therefore it is possible to have
	  several such directories, one for each supported domain.
	  Each domain will have its own independent set of
	  maps.</p><p>NIS master and slave servers handle all NIS requests
	  with the <code class="command">ypserv</code> daemon.
	  <code class="command">ypserv</code> is responsible for receiving
	  incoming requests from NIS clients, translating the
	  requested domain and map name to a path to the corresponding
	  database file and transmitting data from the database back
	  to the client.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97663056"></a>29.4.4.2.1. Setting Up a NIS Master Server</h5></div></div></div><a id="idp97663696" class="indexterm"></a><p>Setting up a master NIS server can be relatively
	    straight forward, depending on your needs.  FreeBSD comes
	    with support for NIS out-of-the-box.  All you need is to
	    add the following lines to
	    <code class="filename">/etc/rc.conf</code>, and FreeBSD will do the
	    rest for you.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><pre class="programlisting">nisdomainname="test-domain"</pre><p>
                This line will set the NIS domainname to
                <code class="literal">test-domain</code>
                upon network setup (e.g. after reboot).</p></li><li class="step"><pre class="programlisting">nis_server_enable="YES"</pre><p>
                This will tell FreeBSD to start up the NIS server processes
                when the networking is next brought up.</p></li><li class="step"><pre class="programlisting">nis_yppasswdd_enable="YES"</pre><p>
                This will enable the <code class="command">rpc.yppasswdd</code>
                daemon which, as mentioned above, will allow users to
                change their NIS password from a client machine.</p></li></ol></div><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><p xmlns="http://www.w3.org/1999/xhtml">Depending on your NIS setup, you may need to add
              further entries.  See the <a class="link" href="network-nis.html#network-nis-server-is-client" title="29.4.10. NIS Servers That Are Also NIS Clients">section about NIS
              servers that are also NIS clients</a>, below, for
              details.</p></div><p>Now, all you have to do is to run the command
            <code class="command">/etc/netstart</code> as superuser.  It will
            set up everything for you, using the values you defined in
            <code class="filename">/etc/rc.conf</code>.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97672528"></a>29.4.4.2.2. Initializing the NIS Maps</h5></div></div></div><a id="idp97673168" class="indexterm"></a><p>The <span class="emphasis"><em>NIS maps</em></span> are database files,
            that are kept in the <code class="filename">/var/yp</code>
            directory.  They are generated from configuration files in
            the <code class="filename">/etc</code> directory of the NIS master,
            with one exception: the
            <code class="filename">/etc/master.passwd</code> file.  This is for
            a good reason, you do not want to propagate passwords to
            your <code class="systemitem">root</code> and other administrative
            accounts to all the servers in the NIS domain.  Therefore,
            before we initialize the NIS maps, you should:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp /etc/master.passwd /var/yp/master.passwd</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /var/yp</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>vi master.passwd</code></strong></pre><p>You should remove all entries regarding system
            accounts (<code class="systemitem">bin</code>,
            <code class="systemitem">tty</code>, <code class="systemitem">kmem</code>,
            <code class="systemitem">games</code>, etc), as well as any accounts
            that you do not want to be propagated to the NIS clients
            (for example <code class="systemitem">root</code> and any other UID 0
            (superuser) accounts).</p><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><p xmlns="http://www.w3.org/1999/xhtml">Make sure the
            <code class="filename">/var/yp/master.passwd</code> is neither group
            nor world readable (mode 600)!  Use the
            <code class="command">chmod</code> command, if appropriate.</p></div><a id="idp97687888" class="indexterm"></a><p>When you have finished, it is time to initialize the
            NIS maps!  FreeBSD includes a script named
            <code class="command">ypinit</code> to do this for you (see its
            manual page for more information).  Note that this script
            is available on most <span class="trademark">UNIX</span>(R) Operating Systems, but not on
            all.  On Digital UNIX/Compaq Tru64 UNIX it is called
            <code class="command">ypsetup</code>.  Because we are generating
            maps for an NIS master, we are going to pass the
            <code class="option">-m</code> option to <code class="command">ypinit</code>.
            To generate the NIS maps, assuming you already performed
            the steps above, run:</p><pre class="screen">ellington<code class="prompt">#</code> <strong class="userinput"><code>ypinit -m test-domain</code></strong>
Server Type: MASTER Domain: test-domain
Creating an YP server will require that you answer a few questions.
Questions will all be asked at the beginning of the procedure.
Do you want this procedure to quit on non-fatal errors? [y/n: n] <strong class="userinput"><code>n</code></strong>
Ok, please remember to go back and redo manually whatever fails.
If you don't, something might not work.
At this point, we have to construct a list of this domains YP servers.
rod.darktech.org is already known as master server.
Please continue to add any slave servers, one per line. When you are
done with the list, type a &lt;control D&gt;.
master server   :  ellington
next host to add:  <strong class="userinput"><code>coltrane</code></strong>
next host to add:  <strong class="userinput"><code>^D</code></strong>
The current list of NIS servers looks like this:
ellington
coltrane
Is this correct?  [y/n: y] <strong class="userinput"><code>y</code></strong>

[..output from map generation..]

NIS Map update completed.
ellington has been setup as an YP master server without any errors.</pre><p><code class="command">ypinit</code> should have created
            <code class="filename">/var/yp/Makefile</code> from
            <code class="filename">/var/yp/Makefile.dist</code>.
            When created, this file assumes that you are operating
            in a single server NIS environment with only FreeBSD
            machines.  Since <code class="literal">test-domain</code> has
            a slave server as well, you must edit
            <code class="filename">/var/yp/Makefile</code>:</p><pre class="screen">ellington<code class="prompt">#</code> <strong class="userinput"><code>vi /var/yp/Makefile</code></strong></pre><p>You should comment out the line that says</p><pre class="programlisting">NOPUSH = "True"</pre><p>(if it is not commented out already).</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97698256"></a>29.4.4.2.3. Setting up a NIS Slave Server</h5></div></div></div><a id="idp97698896" class="indexterm"></a><p>Setting up an NIS slave server is even more simple than
	    setting up the master.  Log on to the slave server and edit the
            file <code class="filename">/etc/rc.conf</code> as you did before.
            The only difference is that we now must use the
            <code class="option">-s</code> option when running <code class="command">ypinit</code>.
            The <code class="option">-s</code> option requires the name of the NIS
            master be passed to it as well, so our command line looks
            like:</p><pre class="screen">coltrane<code class="prompt">#</code> <strong class="userinput"><code>ypinit -s ellington test-domain</code></strong>

Server Type: SLAVE Domain: test-domain Master: ellington

Creating an YP server will require that you answer a few questions.
Questions will all be asked at the beginning of the procedure.

Do you want this procedure to quit on non-fatal errors? [y/n: n]  <strong class="userinput"><code>n</code></strong>

Ok, please remember to go back and redo manually whatever fails.
If you don't, something might not work.
There will be no further questions. The remainder of the procedure
should take a few minutes, to copy the databases from ellington.
Transferring netgroup...
ypxfr: Exiting: Map successfully transferred
Transferring netgroup.byuser...
ypxfr: Exiting: Map successfully transferred
Transferring netgroup.byhost...
ypxfr: Exiting: Map successfully transferred
Transferring master.passwd.byuid...
ypxfr: Exiting: Map successfully transferred
Transferring passwd.byuid...
ypxfr: Exiting: Map successfully transferred
Transferring passwd.byname...
ypxfr: Exiting: Map successfully transferred
Transferring group.bygid...
ypxfr: Exiting: Map successfully transferred
Transferring group.byname...
ypxfr: Exiting: Map successfully transferred
Transferring services.byname...
ypxfr: Exiting: Map successfully transferred
Transferring rpc.bynumber...
ypxfr: Exiting: Map successfully transferred
Transferring rpc.byname...
ypxfr: Exiting: Map successfully transferred
Transferring protocols.byname...
ypxfr: Exiting: Map successfully transferred
Transferring master.passwd.byname...
ypxfr: Exiting: Map successfully transferred
Transferring networks.byname...
ypxfr: Exiting: Map successfully transferred
Transferring networks.byaddr...
ypxfr: Exiting: Map successfully transferred
Transferring netid.byname...
ypxfr: Exiting: Map successfully transferred
Transferring hosts.byaddr...
ypxfr: Exiting: Map successfully transferred
Transferring protocols.bynumber...
ypxfr: Exiting: Map successfully transferred
Transferring ypservers...
ypxfr: Exiting: Map successfully transferred
Transferring hosts.byname...
ypxfr: Exiting: Map successfully transferred

coltrane has been setup as an YP slave server without any errors.
Don't forget to update map ypservers on ellington.</pre><p>You should now have a directory called
	    <code class="filename">/var/yp/test-domain</code>.  Copies of the NIS
	    master server's maps should be in this directory.  You will
	    need to make sure that these stay updated.  The following
	    <code class="filename">/etc/crontab</code> entries on your slave
	    servers should do the job:</p><pre class="programlisting">20      *       *       *       *       root   /usr/libexec/ypxfr passwd.byname
21      *       *       *       *       root   /usr/libexec/ypxfr passwd.byuid</pre><p>These two lines force the slave to sync its maps with
	    the maps on the master server.  Although these entries are
	    not mandatory, since the master server attempts to ensure
	    any changes to its NIS maps are communicated to its slaves
	    and because password information is vital to systems
	    depending on the server, it is a good idea to force the
	    updates.  This is more important on busy networks where map
	    updates might not always complete.</p><p>Now, run the command <code class="command">/etc/netstart</code> on the
            slave server as well, which again starts the NIS server.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97710800"></a>29.4.4.3. NIS Clients</h4></div></div></div><p> An NIS client establishes what is called a binding to a
	  particular NIS server using the
	  <code class="command">ypbind</code> daemon.
	  <code class="command">ypbind</code> checks the system's default
	  domain (as set by the <code class="command">domainname</code> command),
	  and begins broadcasting RPC requests on the local network.
	  These requests specify the name of the domain for which
	  <code class="command">ypbind</code> is attempting to establish a binding.
	  If a server that has been configured to serve the requested
	  domain receives one of the broadcasts, it will respond to
	  <code class="command">ypbind</code>,  which will record the server's
	  address.  If there are several servers available (a master and
	  several slaves, for example), <code class="command">ypbind</code> will
	  use the address of the first one to respond.  From that point
	  on, the client system will direct all of its NIS requests to
	  that server.  <code class="command">ypbind</code> will
	  occasionally <span class="quote">«<span class="quote">ping</span>»</span> the server to make sure it is
	  still up and running.  If it fails to receive a reply to one of
	  its pings within a reasonable amount of time,
	  <code class="command">ypbind</code> will mark the domain as unbound and
	  begin broadcasting again in the hopes of locating another
	  server.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97715408"></a>29.4.4.3.1. Setting Up a NIS Client</h5></div></div></div><a id="idp97716048" class="indexterm"></a><p>Setting up a FreeBSD machine to be a NIS client is fairly
	    straightforward.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Edit the file <code class="filename">/etc/rc.conf</code> and
                add the following lines in order to set the NIS domainname
                and start <code class="command">ypbind</code> upon network
                startup:</p><pre class="programlisting">nisdomainname="test-domain"
nis_client_enable="YES"</pre></li><li class="step"><p>To import all possible password entries from the NIS
		server, remove all user accounts from your
		<code class="filename">/etc/master.passwd</code> file and use
		<code class="command">vipw</code> to add the following line to
                the end of the file:</p><pre class="programlisting">+:::::::::</pre><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><p xmlns="http://www.w3.org/1999/xhtml">This line will afford anyone with a valid account in
		  the NIS server's password maps an account.  There are
		  many ways to configure your NIS client by changing this
		  line.  See the <a class="link" href="network-nis.html#network-netgroups" title="29.4.7. Using Netgroups">netgroups
		  section</a> below for more information.
                  For more detailed reading see O'Reilly's book on
		  <code class="literal">Managing NFS and NIS</code>.</p></div><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><p xmlns="http://www.w3.org/1999/xhtml">You should keep at least one local account (i.e.
                  not imported via NIS) in your
                  <code class="filename">/etc/master.passwd</code> and this
                  account should also be a member of the group
                  <code class="systemitem">wheel</code>.  If there is something
                  wrong with NIS, this account can be used to log in
                  remotely, become <code class="systemitem">root</code>, and fix things.</p></div></li><li class="step"><p>To import all possible group entries from the NIS
		server, add this line to your
		<code class="filename">/etc/group</code> file:</p><pre class="programlisting">+:*::</pre></li></ol></div><p>After completing these steps, you should be able to run
	    <code class="command">ypcat passwd</code> and see the NIS server's
	    passwd map.</p></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97732688"></a>29.4.5. NIS Security</h3></div></div></div><p>In general, any remote user can issue an RPC to
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ypserv</span>(8)</span></a> and retrieve the contents of your NIS maps,
	provided the remote user knows your domainname.  To prevent
	such unauthorized transactions, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ypserv</span>(8)</span></a> supports a
	feature called <span class="quote">«<span class="quote">securenets</span>»</span> which can be used to
	restrict access to a given set of hosts.  At startup,
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ypserv</span>(8)</span></a> will attempt to load the securenets information
	from a file called
	<code class="filename">/var/yp/securenets</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><p xmlns="http://www.w3.org/1999/xhtml">This path varies depending on the path specified with the
	  <code class="option">-p</code> option.  This file contains entries that
	  consist of a network specification and a network mask separated
	  by white space.  Lines starting with <span class="quote">«<span class="quote">#</span>»</span> are
	  considered to be comments.  A sample securenets file might look
	  like this:</p></div><pre class="programlisting"># allow connections from local host -- mandatory
127.0.0.1     255.255.255.255
# allow connections from any host
# on the 192.168.128.0 network
192.168.128.0 255.255.255.0
# allow connections from any host
# between 10.0.0.0 to 10.0.15.255
# this includes the machines in the testlab
10.0.0.0      255.255.240.0</pre><p>If <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ypserv</span>(8)</span></a> receives a request from an address that
	matches one of these rules, it will process the request
	normally.  If the address fails to match a rule, the request
	will be ignored and a warning message will be logged.  If the
	<code class="filename">/var/yp/securenets</code> file does not exist,
	<code class="command">ypserv</code> will allow connections from any
	host.</p><p>The <code class="command">ypserv</code> program also has support for
	Wietse Venema's <span class="application">TCP Wrapper</span> package.
	This allows the administrator to use the
	<span class="application">TCP Wrapper</span> configuration files for
	access control instead of
	<code class="filename">/var/yp/securenets</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><p xmlns="http://www.w3.org/1999/xhtml">While both of these access control mechanisms provide some
          security, they, like the privileged port test, are
          vulnerable to <span class="quote">«<span class="quote">IP spoofing</span>»</span> attacks.  All
          NIS-related traffic should be blocked at your firewall.</p><p xmlns="http://www.w3.org/1999/xhtml">Servers using <code class="filename">/var/yp/securenets</code>
          may fail to serve legitimate NIS clients with archaic TCP/IP
          implementations.  Some of these implementations set all
          host bits to zero when doing broadcasts and/or fail to
          observe the subnet mask when calculating the broadcast
          address.  While some of these problems can be fixed by
          changing the client configuration, other problems may force
          the retirement of the client systems in question or the
          abandonment of <code class="filename">/var/yp/securenets</code>.</p><p xmlns="http://www.w3.org/1999/xhtml">Using <code class="filename">/var/yp/securenets</code> on a
          server with such an archaic implementation of TCP/IP is a
          really bad idea and will lead to loss of NIS functionality
          for large parts of your network.</p><a xmlns="http://www.w3.org/1999/xhtml" id="idp97758032" class="indexterm"></a><p xmlns="http://www.w3.org/1999/xhtml">The use of the <span class="application">TCP Wrapper</span>
          package increases the latency of your NIS server.  The
          additional delay may be long enough to cause timeouts in
          client programs, especially in busy networks or with slow
          NIS servers.  If one or more of your client systems
          suffers from these symptoms, you should convert the client
          systems in question into NIS slave servers and force them
          to bind to themselves.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97759568"></a>29.4.6. Barring Some Users from Logging On</h3></div></div></div><p>In our lab, there is a machine <code class="systemitem">basie</code> that
        is supposed to be a faculty only workstation.  We do not want
        to take this machine out of the NIS domain, yet the
        <code class="filename">passwd</code> file on the master NIS server
        contains accounts for both faculty and students.  What can we
        do?</p><p>There is a way to bar specific users from logging on to a
        machine, even if they are present in the NIS database.  To do
        this, all you must do is add
        <code class="literal">-username</code> to the
        end of the <code class="filename">/etc/master.passwd</code> file on the
        client machine, where <em class="replaceable"><code>username</code></em> is
        the username of the user you wish to bar from logging in.
        This should preferably be done using <code class="command">vipw</code>,
        since <code class="command">vipw</code> will sanity check your changes
        to <code class="filename">/etc/master.passwd</code>, as well as
        automatically rebuild the password database when you finish
        editing.  For example, if we wanted to bar user
        <code class="systemitem">bill</code> from logging on to
        <code class="systemitem">basie</code> we would:</p><pre class="screen">basie<code class="prompt">#</code> <strong class="userinput"><code>vipw</code></strong>
<strong class="userinput"><code>[add -bill to the end, exit]</code></strong>
vipw: rebuilding the database...
vipw: done

basie<code class="prompt">#</code> <strong class="userinput"><code>cat /etc/master.passwd</code></strong>

root:[password]:0:0::0:0:The super-user:/root:/bin/csh
toor:[password]:0:0::0:0:The other super-user:/root:/bin/sh
daemon:*:1:1::0:0:Owner of many system processes:/root:/sbin/nologin
operator:*:2:5::0:0:System &amp;:/:/sbin/nologin
bin:*:3:7::0:0:Binaries Commands and Source,,,:/:/sbin/nologin
tty:*:4:65533::0:0:Tty Sandbox:/:/sbin/nologin
kmem:*:5:65533::0:0:KMem Sandbox:/:/sbin/nologin
games:*:7:13::0:0:Games pseudo-user:/usr/games:/sbin/nologin
news:*:8:8::0:0:News Subsystem:/:/sbin/nologin
man:*:9:9::0:0:Mister Man Pages:/usr/share/man:/sbin/nologin
bind:*:53:53::0:0:Bind Sandbox:/:/sbin/nologin
uucp:*:66:66::0:0:UUCP pseudo-user:/var/spool/uucppublic:/usr/libexec/uucp/uucico
xten:*:67:67::0:0:X-10 daemon:/usr/local/xten:/sbin/nologin
pop:*:68:6::0:0:Post Office Owner:/nonexistent:/sbin/nologin
nobody:*:65534:65534::0:0:Unprivileged user:/nonexistent:/sbin/nologin
+:::::::::
-bill

basie<code class="prompt">#</code></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="network-netgroups"></a>29.4.7. Using Netgroups</h3></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Udo</span> <span class="surname">Erdelhoff</span></span>. </span></div></div></div><a id="idp97774672" class="indexterm"></a><p>The method shown in the previous section works reasonably
        well if you need special rules for a very small number of
        users and/or machines.  On larger networks, you
        <span class="emphasis"><em>will</em></span> forget to bar some users from logging
        onto sensitive machines, or you may even have to modify each
        machine separately, thus losing the main benefit of NIS:
        <span class="emphasis"><em>centralized</em></span> administration.</p><p>The NIS developers' solution for this problem is called
        <span class="emphasis"><em>netgroups</em></span>.  Their purpose and semantics
        can be compared to the normal groups used by <span class="trademark">UNIX</span>(R) file
        systems.  The main differences are the lack of a numeric ID
        and the ability to define a netgroup by including both user
        accounts and other netgroups.</p><p>Netgroups were developed to handle large, complex networks
        with hundreds of users and machines.  On one hand, this is
        a Good Thing if you are forced to deal with such a situation.
        On the other hand, this complexity makes it almost impossible to
        explain netgroups with really simple examples.  The example
        used in the remainder of this section demonstrates this
        problem.</p><p>Let us assume that your successful introduction of NIS in
        your laboratory caught your superiors' interest.  Your next
        job is to extend your NIS domain to cover some of the other
        machines on campus.  The two tables contain the names of the
        new users and new machines as well as brief descriptions of
        them.</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><thead><tr><th>User Name(s)</th><th>Description</th></tr></thead><tbody><tr><td><code class="systemitem">alpha</code>, <code class="systemitem">beta</code></td><td>Normal employees of the IT department</td></tr><tr><td><code class="systemitem">charlie</code>, <code class="systemitem">delta</code></td><td>The new apprentices of the IT department</td></tr><tr><td><code class="systemitem">echo</code>, <code class="systemitem">foxtrott</code>, <code class="systemitem">golf</code>, ...</td><td>Ordinary employees</td></tr><tr><td><code class="systemitem">able</code>, <code class="systemitem">baker</code>, ...</td><td>The current interns</td></tr></tbody></table></div><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><thead><tr><th>Machine Name(s)</th><th>Description</th></tr></thead><tbody><tr><td><code class="systemitem">war</code>, <code class="systemitem">death</code>,
              <code class="systemitem">famine</code>,
              <code class="systemitem">pollution</code></td><td>Your most important servers.  Only the IT
                employees are allowed to log onto these
                machines.</td></tr><tr><td><code class="systemitem">pride</code>, <code class="systemitem">greed</code>,
              <code class="systemitem">envy</code>, <code class="systemitem">wrath</code>,
              <code class="systemitem">lust</code>, <code class="systemitem">sloth</code></td><td>Less important servers.  All members of the IT
              department are allowed to login onto these
              machines.</td></tr><tr><td><code class="systemitem">one</code>, <code class="systemitem">two</code>,
                <code class="systemitem">three</code>, <code class="systemitem">four</code>,
                ...</td><td>Ordinary workstations.  Only the
                <span class="emphasis"><em>real</em></span> employees are allowed to use
                these machines.</td></tr><tr><td><code class="systemitem">trashcan</code></td><td>A very old machine without any critical data.
                Even the intern is allowed to use this box.</td></tr></tbody></table></div><p>If you tried to implement these restrictions by separately
        blocking each user, you would have to add one
        <code class="literal">-user</code> line to
        each system's <code class="filename">passwd</code> for each user who is
        not allowed to login onto that system.  If you forget just one
        entry, you could be in trouble.  It may be feasible to do this
        correctly during the initial setup, however you
        <span class="emphasis"><em>will</em></span> eventually forget to add the lines
        for new users during day-to-day operations.  After all, Murphy
        was an optimist.</p><p>Handling this situation with netgroups offers several
        advantages.  Each user need not be handled separately; you
        assign a user to one or more netgroups and allow or forbid
        logins for all members of the netgroup.  If you add a new
        machine, you will only have to define login restrictions for
        netgroups.  If a new user is added, you will only have to add
        the user to one or more netgroups.  Those changes are
        independent of each other: no more <span class="quote">«<span class="quote">for each combination
        of user and machine do...</span>»</span> If your NIS setup is planned
        carefully, you will only have to modify exactly one central
        configuration file to grant or deny access to machines.</p><p>The first step is the initialization of the NIS map
        netgroup.  FreeBSD's <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ypinit&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ypinit</span>(8)</span></a> does not create this map by
        default, but its NIS implementation will support it once it has
        been created.  To create an empty map, simply type</p><pre class="screen">ellington<code class="prompt">#</code> <strong class="userinput"><code>vi /var/yp/netgroup</code></strong></pre><p>and start adding content.  For our example, we need at
         least four netgroups: IT employees, IT apprentices, normal
         employees and interns.</p><pre class="programlisting">IT_EMP  (,alpha,test-domain)    (,beta,test-domain)
IT_APP  (,charlie,test-domain)  (,delta,test-domain)
USERS   (,echo,test-domain)     (,foxtrott,test-domain) \
        (,golf,test-domain)
INTERNS (,able,test-domain)     (,baker,test-domain)</pre><p><code class="literal">IT_EMP</code>, <code class="literal">IT_APP</code> etc.
        are the names of the netgroups.  Each bracketed group adds
        one or more user accounts to it.  The three fields inside a
        group are:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The name of the host(s) where the following items are
            valid.  If you do not specify a hostname, the entry is
            valid on all hosts.  If you do specify a hostname, you
            will enter a realm of darkness, horror and utter confusion.</p></li><li class="listitem"><p>The name of the account that belongs to this
            netgroup.</p></li><li class="listitem"><p>The NIS domain for the account.  You can import
            accounts from other NIS domains into your netgroup if you
            are one of the unlucky fellows with more than one NIS
            domain.</p></li></ol></div><p>Each of these fields can contain wildcards.  See
        <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=netgroup&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">netgroup</span>(5)</span></a> for details.</p><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><a xmlns="http://www.w3.org/1999/xhtml" id="idp97823056" class="indexterm"></a><p xmlns="http://www.w3.org/1999/xhtml">Netgroup names longer than 8 characters should not be
          used, especially if you have machines running other
          operating systems within your NIS domain.  The names are
          case sensitive; using capital letters for your netgroup
          names is an easy way to distinguish between user, machine
          and netgroup names.</p><p xmlns="http://www.w3.org/1999/xhtml">Some NIS clients (other than FreeBSD) cannot handle
          netgroups with a large number of entries.  For example, some
          older versions of <span class="trademark">SunOS</span>TM start to cause trouble if a netgroup
          contains more than 15 <span class="emphasis"><em>entries</em></span>.  You can
          circumvent this limit by creating several sub-netgroups with
          15 users or less and a real netgroup that consists of the
          sub-netgroups:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">BIGGRP1  (,joe1,domain)  (,joe2,domain)  (,joe3,domain) [...]
BIGGRP2  (,joe16,domain)  (,joe17,domain) [...]
BIGGRP3  (,joe31,domain)  (,joe32,domain)
BIGGROUP  BIGGRP1 BIGGRP2 BIGGRP3</pre><p xmlns="http://www.w3.org/1999/xhtml">You can repeat this process if you need more than 225
          users within a single netgroup.</p></div><p>Activating and distributing your new NIS map is
        easy:</p><pre class="screen">ellington<code class="prompt">#</code> <strong class="userinput"><code>cd /var/yp</code></strong>
ellington<code class="prompt">#</code> <strong class="userinput"><code>make</code></strong></pre><p>This will generate the three NIS maps
        <code class="filename">netgroup</code>,
        <code class="filename">netgroup.byhost</code> and
        <code class="filename">netgroup.byuser</code>.  Use <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ypcat&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ypcat</span>(1)</span></a> to
        check if your new NIS maps are available:</p><pre class="screen">ellington<code class="prompt">%</code> <strong class="userinput"><code>ypcat -k netgroup</code></strong>
ellington<code class="prompt">%</code> <strong class="userinput"><code>ypcat -k netgroup.byhost</code></strong>
ellington<code class="prompt">%</code> <strong class="userinput"><code>ypcat -k netgroup.byuser</code></strong></pre><p>The output of the first command should resemble the
        contents of <code class="filename">/var/yp/netgroup</code>.  The second
        command will not produce output if you have not specified
        host-specific netgroups.  The third command can be used to
        get the list of netgroups for a user.</p><p>The client setup is quite simple.  To configure the server
        <code class="systemitem">war</code>, you only have to start
        <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=vipw&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">vipw</span>(8)</span></a> and replace the line</p><pre class="programlisting">+:::::::::</pre><p>with</p><pre class="programlisting">+@IT_EMP:::::::::</pre><p>Now, only the data for the users defined in the netgroup
        <code class="literal">IT_EMP</code> is imported into
        <code class="systemitem">war</code>'s password database and only
        these users are allowed to login.</p><p>Unfortunately, this limitation also applies to the
	<code class="literal">~</code> function of the shell and all routines
	converting between user names and numerical user IDs.  In
	other words, <code class="command">cd
	~user</code> will not work,
	<code class="command">ls -l</code> will show the numerical ID instead of
	the username and <code class="command">find . -user joe -print</code>
	will fail with <span class="errorname">No such user</span>.  To fix
	this, you will have to import all user entries
	<span class="emphasis"><em>without allowing them to login onto your
	servers</em></span>.</p><p>This can be achieved by adding another line to
        <code class="filename">/etc/master.passwd</code>.  This line should
        contain:</p><p><code class="literal">+:::::::::/sbin/nologin</code>, meaning
        <span class="quote">«<span class="quote">Import all entries but replace the shell with
        <code class="filename">/sbin/nologin</code> in the imported
        entries</span>»</span>.  You can replace any field in the
        <code class="literal">passwd</code> entry by placing a default value in
        your <code class="filename">/etc/master.passwd</code>.</p><div xmlns="" class="warning"><h3 class="admontitle">Προειδοποίηση: </h3><p xmlns="http://www.w3.org/1999/xhtml">Make sure that the line
        <code class="literal">+:::::::::/sbin/nologin</code> is placed after
        <code class="literal">+@IT_EMP:::::::::</code>.  Otherwise, all user
        accounts imported from NIS will have <code class="filename">/sbin/nologin</code> as their
        login shell.</p></div><p>After this change, you will only have to change one NIS
        map if a new employee joins the IT department.  You could use
        a similar approach for the less important servers by replacing
        the old <code class="literal">+:::::::::</code> in their local version
        of <code class="filename">/etc/master.passwd</code> with something like
        this:</p><pre class="programlisting">+@IT_EMP:::::::::
+@IT_APP:::::::::
+:::::::::/sbin/nologin</pre><p>The corresponding lines for the normal workstations
        could be:</p><pre class="programlisting">+@IT_EMP:::::::::
+@USERS:::::::::
+:::::::::/sbin/nologin</pre><p>And everything would be fine until there is a policy
        change a few weeks later: The IT department starts hiring
        interns.  The IT interns are allowed to use the normal
        workstations and the less important servers; and the IT
        apprentices are allowed to login onto the main servers.  You
        add a new netgroup <code class="literal">IT_INTERN</code>, add the new
        IT interns to this netgroup and start to change the
        configuration on each and every machine...  As the old saying
        goes: <span class="quote">«<span class="quote">Errors in centralized planning lead to global
        mess</span>»</span>.</p><p>NIS' ability to create netgroups from other netgroups can
        be used to prevent situations like these.  One possibility
        is the creation of role-based netgroups.  For example, you
        could create a netgroup called
        <code class="literal">BIGSRV</code> to define the login
        restrictions for the important servers, another netgroup
        called <code class="literal">SMALLSRV</code> for the less
        important servers and a third netgroup called
        <code class="literal">USERBOX</code> for the normal
        workstations.  Each of these netgroups contains the netgroups
        that are allowed to login onto these machines.  The new
        entries for your NIS map netgroup should look like this:</p><pre class="programlisting">BIGSRV    IT_EMP  IT_APP
SMALLSRV  IT_EMP  IT_APP  ITINTERN
USERBOX   IT_EMP  ITINTERN USERS</pre><p>This method of defining login restrictions works
        reasonably well if you can define groups of machines with
        identical restrictions.  Unfortunately, this is the exception
        and not the rule.  Most of the time, you will need the ability
        to define login restrictions on a per-machine basis.</p><p>Machine-specific netgroup definitions are the other
        possibility to deal with the policy change outlined above.  In
        this scenario, the <code class="filename">/etc/master.passwd</code> of
        each box contains two lines starting with <span class="quote">«<span class="quote">+</span>»</span>.
        The first of them adds a netgroup with the accounts allowed to
        login onto this machine, the second one adds all other
        accounts with <code class="filename">/sbin/nologin</code> as shell.  It
        is a good idea to use the <span class="quote">«<span class="quote">ALL-CAPS</span>»</span> version of
        the machine name as the name of the netgroup.  In other words,
        the lines should look like this:</p><pre class="programlisting">+@<em class="replaceable"><code>BOXNAME</code></em>:::::::::
+:::::::::/sbin/nologin</pre><p>Once you have completed this task for all your machines,
        you will not have to modify the local versions of
        <code class="filename">/etc/master.passwd</code> ever again.  All
        further changes can be handled by modifying the NIS map.  Here
        is an example of a possible netgroup map for this
        scenario with some additional goodies:</p><pre class="programlisting"># Define groups of users first
IT_EMP    (,alpha,test-domain)    (,beta,test-domain)
IT_APP    (,charlie,test-domain)  (,delta,test-domain)
DEPT1     (,echo,test-domain)     (,foxtrott,test-domain)
DEPT2     (,golf,test-domain)     (,hotel,test-domain)
DEPT3     (,india,test-domain)    (,juliet,test-domain)
ITINTERN  (,kilo,test-domain)     (,lima,test-domain)
D_INTERNS (,able,test-domain)     (,baker,test-domain)
#
# Now, define some groups based on roles
USERS     DEPT1   DEPT2     DEPT3
BIGSRV    IT_EMP  IT_APP
SMALLSRV  IT_EMP  IT_APP    ITINTERN
USERBOX   IT_EMP  ITINTERN  USERS
#
# And a groups for a special tasks
# Allow echo and golf to access our anti-virus-machine
SECURITY  IT_EMP  (,echo,test-domain)  (,golf,test-domain)
#
# machine-based netgroups
# Our main servers
WAR       BIGSRV
FAMINE    BIGSRV
# User india needs access to this server
POLLUTION  BIGSRV  (,india,test-domain)
#
# This one is really important and needs more access restrictions
DEATH     IT_EMP
#
# The anti-virus-machine mentioned above
ONE       SECURITY
#
# Restrict a machine to a single user
TWO       (,hotel,test-domain)
# [...more groups to follow]</pre><p>If you are using some kind of database to manage your user
        accounts, you should be able to create the first part of the
        map with your database's report tools.  This way, new users
        will automatically have access to the boxes.</p><p>One last word of caution: It may not always be advisable
        to use machine-based netgroups.  If you are deploying a couple of
        dozen or even hundreds of identical machines for student labs,
        you should use role-based netgroups instead of machine-based
        netgroups to keep the size of the NIS map within reasonable
        limits.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97873232"></a>29.4.8. Important Things to Remember</h3></div></div></div><p>There are still a couple of things that you will need to do
        differently now that you are in an NIS environment.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Every time you wish to add a user to the lab, you
            must add it to the master NIS server <span class="emphasis"><em>only</em></span>,
            and <span class="emphasis"><em>you must remember to rebuild the NIS
            maps</em></span>.  If you forget to do this, the new user will
            not be able to login anywhere except on the NIS master.
            For example, if we needed to add a new user
            <code class="systemitem">jsmith</code> to the lab, we would:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>pw useradd jsmith</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /var/yp</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make test-domain</code></strong></pre><p>You could also run <code class="command">adduser jsmith</code> instead
            of <code class="command">pw useradd jsmith</code>.</p></li><li class="listitem"><p><span class="emphasis"><em>Keep the administration accounts out of the
            NIS maps</em></span>.  You do not want to be propagating
            administrative accounts and passwords to machines that
            will have users that should not have access to those
            accounts.</p></li><li class="listitem"><p><span class="emphasis"><em>Keep the NIS master and slave secure, and
            minimize their downtime</em></span>.  If somebody either
            hacks or simply turns off these machines, they have
            effectively rendered many people without the ability to
            login to the lab.</p><p>This is the chief weakness of any centralized administration
            system.  If you do
            not protect your NIS servers, you will have a lot of angry
            users!</p></li></ul></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97887312"></a>29.4.9. NIS v1 Compatibility</h3></div></div></div><p> FreeBSD's <span class="application">ypserv</span> has some
	support for serving NIS v1 clients.  FreeBSD's NIS
	implementation only uses the NIS v2 protocol, however other
	implementations include support for the v1 protocol for
	backwards compatibility with older systems.  The
	<span class="application">ypbind</span> daemons supplied with these
	systems will try to establish a binding to an NIS v1 server
	even though they may never actually need it (and they may
	persist in broadcasting in search of one even after they
	receive a response from a v2 server).  Note that while support
	for normal client calls is provided, this version of
	<span class="application">ypserv</span> does not handle v1 map
	transfer requests; consequently, it cannot be used as a master
	or slave in conjunction with older NIS servers that only
	support the v1 protocol.  Fortunately, there probably are not
	any such servers still in use today.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="network-nis-server-is-client"></a>29.4.10. NIS Servers That Are Also NIS Clients</h3></div></div></div><p> Care must be taken when running
	<span class="application">ypserv</span> in a multi-server domain
	where the server machines are also NIS clients.  It is
	generally a good idea to force the servers to bind to
	themselves rather than allowing them to broadcast bind
	requests and possibly become bound to each other.  Strange
	failure modes can result if one server goes down and others
	are dependent upon it.  Eventually all the clients will time
	out and attempt to bind to other servers, but the delay
	involved can be considerable and the failure mode is still
	present since the servers might bind to each other all over
	again.</p><p>You can force a host to bind to a particular server by running
	<code class="command">ypbind</code> with the <code class="option">-S</code>
	flag.  If you do not want to do this manually each time you
        reboot your NIS server, you can add the following lines to
        your <code class="filename">/etc/rc.conf</code>:</p><pre class="programlisting">nis_client_enable="YES"	# run client stuff as well
nis_client_flags="-S <em class="replaceable"><code>NIS domain</code></em>,<em class="replaceable"><code>server</code></em>"</pre><p>See <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ypbind&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ypbind</span>(8)</span></a> for further information.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp97895248"></a>29.4.11. Password Formats</h3></div></div></div><a id="idp97895888" class="indexterm"></a><p>One of the most common issues that people run into when trying
	to implement NIS is password format compatibility.  If your NIS
	server is using DES encrypted passwords, it will only support
	clients that are also using DES.  For example, if you have
	<span class="trademark">Solaris</span>TM NIS clients in your network, then you will almost certainly
	need to use DES encrypted passwords.</p><p>To check which format your servers
	and clients are using, look at <code class="filename">/etc/login.conf</code>.
	If the host is configured to use DES encrypted passwords, then the
	<code class="literal">default</code> class will contain an entry like this:</p><pre class="programlisting">default:\
	:passwd_format=des:\
	:copyright=/etc/COPYRIGHT:\
	[Further entries elided]</pre><p>Other possible values for the <code class="literal">passwd_format</code>
	capability include <code class="literal">blf</code> and <code class="literal">md5</code>
	(for Blowfish and MD5 encrypted passwords, respectively).</p><p>If you have made changes to
	<code class="filename">/etc/login.conf</code>, you will also need to
	rebuild the login capability database, which is achieved by
	running the following command as
	<code class="systemitem">root</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cap_mkdb /etc/login.conf</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Σημείωση: </h3><p xmlns="http://www.w3.org/1999/xhtml">The format of passwords already in
	<code class="filename">/etc/master.passwd</code> will not be updated
	until a user changes his password for the first time
	<span class="emphasis"><em>after</em></span> the login capability database is
	rebuilt.</p></div><p>Next, in order to ensure that passwords are encrypted with
	the format that you have chosen, you should also check that
	the <code class="literal">crypt_default</code> in
	<code class="filename">/etc/auth.conf</code> gives precedence to your
	chosen password format.  To do this, place the format that you
	have chosen first in the list.  For example, when using DES
	encrypted passwords, the entry would be:</p><pre class="programlisting">crypt_default	=	des blf md5</pre><p>Having followed the above steps on each of the FreeBSD based
	NIS servers and clients, you can be sure that they all agree
	on which password format is used within your network.  If you
	have trouble authenticating on an NIS client, this is a pretty
	good place to start looking for possible problems.  Remember:
	if you want to deploy an NIS server for a heterogenous
	network, you will probably have to use DES on all systems
	because it is the lowest common standard.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="network-nfs.html">Προηγ</a> </td><td width="20%" align="center"><a accesskey="u" href="network-servers.html">Πάνω</a></td><td width="40%" align="right"> <a accesskey="n" href="network-dhcp.html">Επόμενο</a></td></tr><tr><td width="40%" align="left" valign="top">29.3. Network File System (NFS) </td><td width="20%" align="center"><a accesskey="h" href="index.html">Αρχή</a></td><td width="40%" align="right" valign="top"> 29.5. Automatic Network Configuration (DHCP)</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Αυτό το κείμενο, και άλλα κείμενα, μπορεί να βρεθεί στο
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Για ερωτήσεις σχετικά με το FreeBSD, διαβάστε την
    <a href="http://www.FreeBSD.org/docs.html">τεκμηρίωση</a> πριν να επικοινωνήσετε με την
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    Για ερωτήσεις σχετικά με αυτή την τεκμηρίωση, στείλτε e-mail στην
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.</small></p></body></html>