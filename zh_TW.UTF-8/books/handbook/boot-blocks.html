<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>13.3. The Boot Manager and Boot Stages</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 使用手冊" /><link rel="up" href="boot.html" title="章 13. FreeBSD 開機流程篇" /><link rel="prev" href="boot-introduction.html" title="13.2. Booting 問題" /><link rel="next" href="boot-kernel.html" title="13.4. Kernel Interaction During Boot" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">13.3. The Boot Manager and Boot Stages</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="boot-introduction.html">前一頁</a> </td><th width="60%" align="center">章 13. FreeBSD 開機流程篇</th><td width="20%" align="right"> <a accesskey="n" href="boot-kernel.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="boot-blocks"></a>13.3. The Boot Manager and Boot Stages</h2></div></div></div><a id="idp77403728" class="indexterm"></a><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="boot-boot0"></a>13.3.1. The Boot Manager</h3></div></div></div><a id="idp77405008" class="indexterm"></a><p>The code in the MBR or boot manager is sometimes referred to as
        <span class="emphasis"><em>stage zero</em></span> of the boot process.  This subsection
        discusses two of the boot managers previously mentioned:
        <span class="application">boot0</span> and <span class="application">LILO</span>.</p><p><span class="formalpara-title">The <span class="application">boot0</span> Boot Manager: </span>The MBR installed by FreeBSD's installer or <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=boot0cfg&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">boot0cfg</span>(8)</span></a>, by
          default, is based on <code class="filename">/boot/boot0</code>.
          (The <span class="application">boot0</span> program is very simple, since the
          program in the <abbr class="abbrev">MBR</abbr> can only be 446 bytes long because of the slice
          table and 0x55AA identifier at the end of the MBR.)
          If you have installed <span class="application">boot0</span> and
          multiple operating systems on your hard disks, then you will see a
          display similar to this one at boot time:</p><div class="example"><a id="boot-boot0-example"></a><div class="example-title">範例 13.1. <code class="filename">boot0</code> Screenshot</div><div class="example-contents"><pre class="screen">F1 DOS
F2 FreeBSD
F3 Linux
F4 ??
F5 Drive 1

Default: F2</pre></div></div><br class="example-break" /><p>Other operating systems, in particular <span class="trademark">Windows</span>®, have been known
	to overwrite an existing MBR with their own.  If this happens to you,
	or you want to replace your existing MBR with the FreeBSD MBR then use
	the following command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fdisk -B -b /boot/boot0 device</code></strong></pre><p>where <em class="replaceable"><code>device</code></em> is the device that you
	boot from, such as <code class="filename">ad0</code> for the first IDE
	disk, <code class="filename">ad2</code> for the first IDE disk on a second
	IDE controller, <code class="filename">da0</code> for the first SCSI disk,
	and so on.  Or, if you want a custom configuration of the MBR,
	use <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=boot0cfg&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">boot0cfg</span>(8)</span></a>.</p><p><span class="formalpara-title">The LILO Boot Manager: </span>To install this boot manager so it will also boot FreeBSD, first
	  start Linux and add the following to your existing
	  <code class="filename">/etc/lilo.conf</code> configuration file:</p><pre class="programlisting">other=/dev/hdXY
table=/dev/hdX
loader=/boot/chain.b
label=FreeBSD</pre><p>In the above, specify FreeBSD's primary partition and drive using
	Linux specifiers, replacing <em class="replaceable"><code>X</code></em> with the Linux
	drive letter and <em class="replaceable"><code>Y</code></em> with the Linux primary
	partition number.  If you are using a <acronym class="acronym">SCSI</acronym> drive, you
	will need to change <em class="replaceable"><code>/dev/hd</code></em> to read something
	similar to <em class="replaceable"><code>/dev/sd</code></em>.  The
	<code class="option">loader=/boot/chain.b</code> line can be omitted if you have
	both operating systems on the same drive.  Now run
	<code class="command">/sbin/lilo -v</code> to commit your new changes to the
	system; this should be verified by checking its screen messages.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="boot-boot1"></a>13.3.2. Stage One, <code class="filename">/boot/boot1</code>, and Stage Two,
	<code class="filename">/boot/boot2</code></h3></div></div></div><p>Conceptually the first and second stages are part of the same
	program, on the same area of the disk.  Because of space constraints
	they have been split into two, but you would always install them
	together.  They are copied from the combined file
	<code class="filename">/boot/boot</code> by the installer or
	<span class="application">disklabel</span> (see below).</p><p>They are located outside file systems, in the first track of
	the boot slice, starting with the first sector.  This is where <a class="link" href="boot-blocks.html#boot-boot0" title="13.3.1. The Boot Manager">boot0</a>, or any other boot manager,
	expects to find a program to run which will
	continue the boot process.  The number of sectors used is easily
	determined from the size of <code class="filename">/boot/boot</code>.</p><p><code class="filename">boot1</code> is very simple, since it
	can only be 512 bytes
	in size, and knows just enough about the FreeBSD
	<em class="firstterm">disklabel</em>, which stores information
	about the slice, to find and execute <code class="filename">boot2</code>.</p><p><code class="filename">boot2</code> is slightly more sophisticated, and understands
	the FreeBSD file system enough to find files on it, and can
	provide a simple interface to choose the kernel or loader to
	run.</p><p>Since the <a class="link" href="boot-blocks.html#boot-loader" title="13.3.3. Stage Three, /boot/loader">loader</a> is
	much more sophisticated, and provides a nice easy-to-use
	boot configuration, <code class="filename">boot2</code> usually runs
	it, but previously it
	was tasked to run the kernel directly.</p><div class="example"><a id="boot-boot2-example"></a><div class="example-title">範例 13.2. <code class="filename">boot2</code> Screenshot</div><div class="example-contents"><pre class="screen">&gt;&gt; FreeBSD/i386 BOOT
Default: 0:ad(0,a)/kernel
boot:</pre></div></div><br class="example-break" /><p>If you ever need to replace the installed
	<code class="filename">boot1</code> and <code class="filename">boot2</code> use
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=disklabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">disklabel</span>(8)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>disklabel -B diskslice</code></strong></pre><p>where <em class="replaceable"><code>diskslice</code></em> is the disk and slice
	you boot from, such as <code class="filename">ad0s1</code> for the first
	slice on the first IDE disk.</p><div xmlns="" class="warning"><h3 class="admontitle">Dangerously Dedicated Mode: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you use just the disk name, such as
	  <code class="filename">ad0</code>, in the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=disklabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">disklabel</span>(8)</span></a> command you
	  will create a dangerously dedicated disk, without slices.  This is
	  almost certainly not what you want to do, so make sure you double
	  check the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=disklabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">disklabel</span>(8)</span></a> command before you press
	  <span class="keycap"><strong>Return</strong></span>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="boot-loader"></a>13.3.3. Stage Three, <code class="filename">/boot/loader</code></h3></div></div></div><a id="idp77448016" class="indexterm"></a><p>The loader is the final stage of the three-stage
      bootstrap, and is located on the file system, usually as
      <code class="filename">/boot/loader</code>.</p><p>The loader is intended as a user-friendly method for
      configuration, using an easy-to-use built-in command set,
      backed up by a more powerful interpreter, with a more complex
      command set.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="boot-loader-flow"></a>13.3.3.1. Loader Program Flow</h4></div></div></div><p>During initialization, the loader will probe for a
	console and for disks, and figure out what disk it is
	booting from.  It will set variables accordingly, and an
	interpreter is started where user commands can be passed from
	a script or interactively.</p><a id="idp77450960" class="indexterm"></a><a id="idp77451472" class="indexterm"></a><p>The loader will then read
	<code class="filename">/boot/loader.rc</code>, which by default reads
	in <code class="filename">/boot/defaults/loader.conf</code> which
	sets reasonable defaults for variables and reads
	<code class="filename">/boot/loader.conf</code> for local changes to
	those variables.  <code class="filename">loader.rc</code> then acts
	on these variables, loading whichever modules and kernel are
	selected.</p><p>Finally, by default, the loader issues a 10 second wait
	for key presses, and boots the kernel if it is not interrupted.
	If interrupted, the user is presented with a prompt which
	understands the easy-to-use command set, where the user may
	adjust variables, unload all modules, load modules, and then
	finally boot or reboot.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="boot-loader-commands"></a>13.3.3.2. Loader Built-In Commands</h4></div></div></div><p>These are the most commonly used loader commands.  For a
        complete discussion of all available commands, please see
        <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">autoboot <em class="replaceable"><code>seconds</code></em></span></dt><dd><p>Proceeds to boot the kernel if not interrupted
	      within the time span given, in seconds.  It displays a
	      countdown, and the default time span is 10
	      seconds.</p></dd><dt><span class="term">boot
	    [<span class="optional">-options</span>]
	    [<span class="optional">kernelname</span>]</span></dt><dd><p>Immediately proceeds to boot the kernel, with the
	      given options, if any, and with the kernel name given,
	      if it is.</p></dd><dt><span class="term">boot-conf</span></dt><dd><p>Goes through the same automatic configuration of
	      modules based on variables as what happens at boot.
	      This only makes sense if you use
	      <code class="command">unload</code> first, and change some
	      variables, most commonly <code class="envar">kernel</code>.</p></dd><dt><span class="term">help
	    [<span class="optional">topic</span>]</span></dt><dd><p>Shows help messages read from
	      <code class="filename">/boot/loader.help</code>.  If the topic
	      given is <code class="literal">index</code>, then the list of
	      available topics is given.</p></dd><dt><span class="term">include <em class="replaceable"><code>filename</code></em>
	    …</span></dt><dd><p>Processes the file with the given filename.  The
	      file is read in, and interpreted line by line.  An
	      error immediately stops the include command.</p></dd><dt><span class="term">load [<span class="optional">-t
	    type</span>]
	    <em class="replaceable"><code>filename</code></em></span></dt><dd><p>Loads the kernel, kernel module, or file of the
	      type given, with the filename given.  Any arguments
	      after filename are passed to the file.</p></dd><dt><span class="term">ls [<span class="optional">-l</span>]
	    [<span class="optional">path</span>]</span></dt><dd><p>Displays a listing of files in the given path, or
	      the root directory, if the path is not specified.  If
	      <code class="option">-l</code> is specified, file sizes will be
	      shown too.</p></dd><dt><span class="term">lsdev [<span class="optional">-v</span>]</span></dt><dd><p>Lists all of the devices from which it may be
	      possible to load modules. If <code class="option">-v</code> is
	      specified, more details are printed.</p></dd><dt><span class="term">lsmod [<span class="optional">-v</span>]</span></dt><dd><p>Displays loaded modules. If <code class="option">-v</code> is
	      specified, more details are shown.</p></dd><dt><span class="term">more <em class="replaceable"><code>filename</code></em></span></dt><dd><p>Displays the files specified, with a pause at each
	      <code class="varname">LINES</code> displayed.</p></dd><dt><span class="term">reboot</span></dt><dd><p>Immediately reboots the system.</p></dd><dt><span class="term">set <em class="replaceable"><code>variable</code></em>, </span><span class="term">set
	    <em class="replaceable"><code>variable</code></em>=<em class="replaceable"><code>value</code></em></span></dt><dd><p>Sets the loader's environment variables.</p></dd><dt><span class="term">unload</span></dt><dd><p>Removes all loaded modules.</p></dd></dl></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="boot-loader-examples"></a>13.3.3.3. Loader Examples</h4></div></div></div><p>Here are some practical examples of loader usage:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>To simply boot your usual kernel, but in single-user
	    mode:<a id="idp77503696" class="indexterm"></a></p><pre class="screen"><strong class="userinput"><code>boot -s</code></strong></pre></li><li class="listitem"><p>To unload your usual kernel and modules, and then
	    load just your old (or another) kernel:</p><pre class="screen"><strong class="userinput"><code>unload</code></strong>
<strong class="userinput"><code>load kernel.old</code></strong></pre><p>You can use <code class="filename">kernel.GENERIC</code> to
	    refer to the generic kernel that comes on the install
	    disk, or <code class="filename">kernel.old</code><a id="idp77507408" class="indexterm"></a> to refer to
	    your previously installed kernel (when you have upgraded
	    or configured your own kernel, for example).</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">Use the following to load your usual modules with
	      another kernel:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><strong class="userinput"><code>unload</code></strong>
<strong class="userinput"><code>set kernel="kernel.old"</code></strong>
<strong class="userinput"><code>boot-conf</code></strong></pre></div></li><li class="listitem"><p>To load a kernel configuration script (an automated
	    script which does the things you would normally do in the
	    kernel boot-time configurator):</p><pre class="screen"><strong class="userinput"><code>load -t userconfig_script /boot/kernel.conf</code></strong></pre></li></ul></div></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="boot-introduction.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="boot.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="boot-kernel.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">13.2. Booting 問題 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 13.4. Kernel Interaction During Boot</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>