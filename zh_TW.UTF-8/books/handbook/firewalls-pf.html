<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>30.4. OpenBSD 封包過濾器 (Packet Filter, PF)及 ALTQ</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 使用手冊" /><link rel="up" href="firewalls.html" title="章 30. 防火牆" /><link rel="prev" href="firewalls-apps.html" title="30.3. 防火牆相關軟體" /><link rel="next" href="firewalls-ipf.html" title="30.5. IPFILTER (IPF) 防火牆" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">30.4. OpenBSD 封包過濾器 (Packet Filter, PF)及
      <acronym class="acronym">ALTQ</acronym></th></tr><tr><td width="20%" align="left"><a accesskey="p" href="firewalls-apps.html">前一頁</a> </td><th width="60%" align="center">章 30. 防火牆</th><td width="20%" align="right"> <a accesskey="n" href="firewalls-ipf.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="firewalls-pf"></a>30.4. OpenBSD 封包過濾器 (Packet Filter, PF)及
      <acronym class="acronym">ALTQ</acronym></h2></div></div></div><a id="idp89220688" class="indexterm"></a><p>在 2003 年 6 月份，OpenBSD 的防火牆軟體 <acronym class="acronym">PF</acronym>
     被移植到 FreeBSD 中，並且收錄於 Ports Collection 內。
     而 2004 年 11 月份所發行的 FreeBSD 5.3 版也是第一次將
     <acronym class="acronym">PF</acronym> 整合為基礎系統的一部分。
     <acronym class="acronym">PF</acronym>是個完備、全功能的防火牆，
     並且具有選擇性 <acronym class="acronym">ALTQ</acronym>(交錯佇列，Alternate Queuing)
     
     的功能。
     <acronym class="acronym">ALTQ</acronym>提供了「<acronym class="acronym">QoS</acronym>」
     (Quality of Service)頻寬管制功能，
     它可以用過濾規則的方式來保障各種不同服務的頻寬。
     另外，OpenBSD 計劃中已經對 PF 的使用指南提供了詳盡的解說，
     因此在這本手冊中我們不會作重複的贅述，而只介紹概要。</p><p>更多關於 PF 的資訊可於下列網址查詢：<code class="uri"><a class="uri" href="http://pf4freebsd.love2party.net/" target="_top">http://pf4freebsd.love2party.net/</a></code>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp89230160"></a>30.4.1. 啟用 PF</h3></div></div></div><p>PF 在 FreeBSD 5.3 之後的系統中，就可以輕鬆使用 kernel 動態模組來載入。
       在 rc.conf 中加入 <code class="literal">pf_enable="YES"</code> 後，
       系統就會載入 PF 的 kernel 動態模組。這模組會在建立時也啟用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pflog&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pflog</span>(4)</span></a>
       記錄功能。</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">這個模組會假設 kernel 內已有 <code class="literal">options INET</code> 和
          <code class="literal">device bpf</code>。
	  除非編譯 kernel 時已在像是 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">make.conf</span>(5)</span></a> 設定檔中加入
	  <code class="literal">NOINET6</code>(
	  FreeBSD 6.0 以後的版本則是 <code class="literal">NO_INET6</code>)
	  這樣才會避免不打開 IPv6 支援，
	  否則 pf 模組同時也需要 <code class="literal">options INET6</code>，也就是 IPv6
	  支援。</p></div><p>一旦載入 PF 的 kernel 模組或是靜態編譯入 kernel 內，
	就可以使用 <code class="command">pfctl</code> 來啟動或關閉
	<span class="application">pf</span>。</p><p>下面這個例子示範如何啟動 <span class="application">pf</span>：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>pfctl -e</code></strong></pre><p><code class="command">pfctl</code> 是使用 <span class="application">pf</span>
	防火牆的指令。  若要了解更詳盡的 <code class="command">pfctl</code> 運用，請查閱
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pfctl&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pfctl</span>(8)</span></a> 線上手冊。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp89241040"></a>30.4.2. kernel 選項</h3></div></div></div><a id="idp89241680" class="indexterm"></a><a id="idp89242832" class="indexterm"></a><a id="idp89243984" class="indexterm"></a><p>在編譯 FreeBSD kernel 時，並不必完全加入下列的選項來啟用 PF。
        在這裡只是要列出給你參考的一些資訊而已。
	將 PF 編譯入 kernel 中，會導致無法使用 kernel 的動態載入模組。</p><p>設定 PF 的 kernel 選項範例在 kernel 原始碼中的
        <code class="filename">/usr/src/sys/conf/NOTES</code>，轉貼內容如下：</p><pre class="programlisting">device pf
device pflog
device pfsync</pre><p><code class="literal">device pf</code> 是用來啟動「packet filter(封包過濾)」
	的防火牆支援。</p><p>而 <code class="literal">device pflog</code>，此功能要裝不裝皆可，它會啟動
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pflog&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pflog</span>(4)</span></a>，以 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bpf&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">bpf</span>(4)</span></a> 格式來記錄網路流量。
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pflogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pflogd</span>(8)</span></a> daemon 則是用來紀錄這些訊息，並存在硬碟上。</p><p><code class="literal">device pfsync</code>，此功能要裝不裝皆可，它會啟動
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pfsync&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pfsync</span>(4)</span></a>，可以用來監控「狀態的改變」。   請注意：
	<code class="literal">device pfsync</code>並不是 kernel 動態模組，要使用的話，
	必須要編入自訂的 kernel 中才行。</p><p>這些設定將會在你編譯及安裝好新 kernel 後才會生效。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp89261520"></a>30.4.3. rc.conf 其他相關的選項</h3></div></div></div><p>你需要在 <code class="filename">/etc/rc.conf</code>
        中加入下列的設定，以便在系統啟動時啟用 PF：</p><pre class="programlisting">pf_enable="YES"                 # 啟用 PF (如果需要的話載入模組)
pf_rules="/etc/pf.conf"         # PF 防火牆規則設定檔
pf_flags=""                     # pfctl 啟動時的附加選項
pflog_enable="YES"              # 啟動 pflogd(8)
pflog_logfile="/var/log/pflog"  # pflogd 儲存記錄檔案的地方
pflog_flags=""                  # pflogd 啟動時附加的選項</pre><p>如果您的防火牆後面有個 LAN(區域網路)，並要透過它來轉送封包，
        就必須要設定下列選項：</p><pre class="programlisting">gateway_enable="YES"            # 啟用 LAN Gateway</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp89264208"></a>30.4.4. 啟用 <acronym class="acronym">ALTQ</acronym></h3></div></div></div><p><acronym class="acronym">ALTQ</acronym> 只有在編入 FreeBSD kernel 中才能生效。
	不是所有的網路卡驅動程式都支援 <acronym class="acronym">ALTQ</acronym>。
	請看 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=altq&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">altq</span>(4)</span></a> 線上手冊來了解你使用的 FreeBSD 版本中支援驅動程式的清單。
	下面所列的將會啟用 <acronym class="acronym">ALTQ</acronym> 及其他附加功能：</p><pre class="programlisting">options         ALTQ
options         ALTQ_CBQ        # Class Bases Queuing (CBQ)
options         ALTQ_RED        # Random Early Detection (RED)
options         ALTQ_RIO        # RED In/Out
options         ALTQ_HFSC       # Hierarchical Packet Scheduler (HFSC)
options         ALTQ_PRIQ       # Priority Queuing (PRIQ)
options         ALTQ_NOPCC      # Required for SMP build</pre><p><code class="literal">options ALTQ</code> 是啟用 <acronym class="acronym">ALTQ</acronym> 主架構。</p><p><code class="literal">options ALTQ_CBQ</code> 會啟用「<acronym class="acronym">CBQ</acronym>」
        (Class Based Queuing)支援。
	<acronym class="acronym">CBQ</acronym> 允許你
	divide a connection's bandwidth into different
	classes or queues to prioritize traffic based on filter
	rules.</p><p><code class="literal">options ALTQ_RED</code> enables Random Early
	Detection (<acronym class="acronym">RED</acronym>).  <acronym class="acronym">RED</acronym> is
	used to avoid network congestion.  <acronym class="acronym">RED</acronym> does
	this by measuring the length of the queue and comparing it to
	the minimum and maximum thresholds for the queue.  If the
	queue is over the maximum all new packets will be dropped.
	True to its name, <acronym class="acronym">RED</acronym> drops packets from
	different connections randomly.</p><p><code class="literal">options ALTQ_RIO</code> enables Random Early
	Detection In and Out.</p><p><code class="literal">options ALTQ_HFSC</code> enables the
	Hierarchical Fair Service Curve Packet Scheduler.  For more
	information about <acronym class="acronym">HFSC</acronym> see: <code class="uri"><a class="uri" href="http://www-2.cs.cmu.edu/~hzhang/HFSC/main.html" target="_top">http://www-2.cs.cmu.edu/~hzhang/HFSC/main.html</a></code>.</p><p><code class="literal">options ALTQ_PRIQ</code> enables Priority
	Queuing (<acronym class="acronym">PRIQ</acronym>).  <acronym class="acronym">PRIQ</acronym>
	will always pass traffic that is in a higher queue
	first.</p><p><code class="literal">options ALTQ_NOPCC</code> enables
	<acronym class="acronym">SMP</acronym> support for <acronym class="acronym">ALTQ</acronym>.
	This option is required on <acronym class="acronym">SMP</acronym>
	systems.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp89282128"></a>30.4.5. Creating Filtering Rules</h3></div></div></div><p>The Packet Filter reads its configuration rules from the
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pf.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">pf.conf</span>(5)</span></a> file and it modifies, drops or passes packets
	according to the rules or definitions specified there.  The FreeBSD
	installation comes with a default
	<code class="filename">/etc/pf.conf</code> which contains useful examples
	and explanations.</p><p>Although FreeBSD has its own <code class="filename">/etc/pf.conf</code>
	the syntax is the same as one used in OpenBSD.  A great
	resource for configuring the <span class="application">pf</span>
	firewall has been written by OpenBSD team and is available at
	<code class="uri"><a class="uri" href="http://www.openbsd.org/faq/pf/" target="_top">http://www.openbsd.org/faq/pf/</a></code>.</p><div xmlns="" class="warning"><h3 class="admontitle">警告: </h3><p xmlns="http://www.w3.org/1999/xhtml">When browsing the pf user's guide, please keep in mind that
     different versions of FreeBSD contain different versions of pf.  The
     <span class="application">pf</span> firewall in FreeBSD 5.X is at the level
     of OpenBSD version 3.5 and in FreeBSD 6.X is at the level of OpenBSD
     version 3.7.</p></div><p>The <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pf" target="_top">FreeBSD packet filter 郵遞論壇</a> is a good place to ask questions about
	configuring and running the <span class="application">pf</span>
	firewall.  Do not forget to check the mailing list archives
	before asking questions.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="firewalls-apps.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="firewalls.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="firewalls-ipf.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">30.3. 防火牆相關軟體 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 30.5. IPFILTER (IPF) 防火牆</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>