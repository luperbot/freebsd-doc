<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>9.4. 重新調配、編譯 kernel</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 使用手冊" /><link rel="up" href="kernelconfig.html" title="章 9. 設定 FreeBSD Kernel" /><link rel="prev" href="kernelconfig-devices.html" title="9.3. 探測系統硬體" /><link rel="next" href="kernelconfig-config.html" title="9.5. kernel 設定檔解說" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">9.4. 重新調配、編譯 kernel</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="kernelconfig-devices.html">前一頁</a> </td><th width="60%" align="center">章 9. 設定 FreeBSD Kernel</th><td width="20%" align="right"> <a accesskey="n" href="kernelconfig-config.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kernelconfig-building"></a>9.4. 重新調配、編譯 kernel</h2></div></div></div><a id="idp73084752" class="indexterm"></a><p>首先對 kernel 相關目錄作快速介紹。
      這裡所提到的所有目錄都在 <code class="filename">/usr/src/sys</code> 內，
      也可以用 <code class="filename">/sys</code> 這個 symbolic link 來連到這。
      這裡的許多子目錄分別擺放 kernel 的各組成部分，但對打造 kernel
      影響最重要的目錄是
      <code class="filename">arch/conf</code>，
      這裡是可以針對需求來修改自訂 kernel 相關設定。
      此外，還有在編譯 kernel 過程中會暫時擺放的 <code class="filename">compile</code>
      目錄。
      剛講到的 <em class="replaceable"><code>arch</code></em> 可以是右列架構之一：
      <code class="filename">i386</code>、<code class="filename">alpha</code>、
      <code class="filename">amd64</code>、<code class="filename">ia64</code>、
      <code class="filename">powerpc</code>、<code class="filename">sparc64</code>、
      <code class="filename">pc98</code>(在日本較流行的另一種 PC 硬體架構)。
      在各特定硬體架構目錄的東西，只搭配相對應的硬體架構而已。
      而其餘的原始碼則是與硬體架構無關，可以在所有 FreeBSD 可裝的平台上共用。
      整體目錄架構都是有邏輯可循，像是各項有支援的硬體設備、檔案系統，
      以及相關選項通常都會擺在它們自己的子目錄內。</p><p>本章所用到的例子，都是你使用 i386 架構的機器。
      請依實際情況，對相關目錄作調整即可。</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">若您系統上 <span class="emphasis"><em>沒裝</em></span>
	<code class="filename">/usr/src/sys</code> 目錄，
	也就是說沒裝 kernel source code 的話，那麼最簡單安裝方式就是以
	<code class="systemitem">root</code> 權限來執行 <code class="command">sysinstall</code>，
	接著請選 <span class="guimenuitem">Configure</span>，然後選
	<span class="guimenuitem">Distributions</span> 接著為
	<span class="guimenuitem">src</span> 再選
	<span class="guimenuitem">base</span> 最後選
	<span class="guimenuitem">sys</span>。  若不喜歡用
	<span class="application">sysinstall</span> 而且手邊有
	<span class="quote">“<span class="quote">正式的</span>”</span> FreeBSD 光碟可以用的話，
        那麼也可以用以下指令來安裝：</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount /cdrom</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mkdir -p /usr/src/sys</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>ln -s /usr/src/sys /sys</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cat /cdrom/src/ssys.[a-d]* | tar -xzvf -</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cat /cdrom/src/sbase.[a-d]* | tar -xzvf -</code></strong></pre></div><p>接下來，切換到
      <code class="filename">arch/conf</code> 目錄，
      複製 <code class="filename">GENERIC</code> 設定檔為你想稱呼的新 kernel 名稱。
      例如：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/sys/i386/conf</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cp GENERIC MYKERNEL</code></strong></pre><p>通常，命名方式都是大寫。如果你負責維護許多不同硬體架構的 FreeBSD
      機器的話，那麼照該機器名稱(hostname)來命名會是比較明智。
      上面例子中之所以命名為 <code class="filename">MYKERNEL</code>
      就是因為這緣故。</p><div xmlns="" class="tip"><h3 class="admontitle">提示: </h3><p xmlns="http://www.w3.org/1999/xhtml">建議不要把改過的 kernel 設定檔直接放在
	<code class="filename">/usr/src</code>。  因為若編譯遇到其他問題時，
	直接砍掉 <code class="filename">/usr/src</code> 再重練，
	可能會是比較乾脆的選擇之一。
	一旦真的砍了之後，你可能幾秒之後才會醒悟到：
	你同時也砍掉自己改的 kernel 設定檔。
	此外，也不要直接修改 <code class="filename">GENERIC</code>，因為下次你
	更新 source tree 時，
	它會被新版覆蓋，而相關修改也將隨之而逝。</p><p xmlns="http://www.w3.org/1999/xhtml">你也可考慮把 kernel 設定檔改放到其他地方，然後再到
	<code class="filename">i386</code>
	目錄內建個指向它的 symbolic link。</p><p xmlns="http://www.w3.org/1999/xhtml">舉例：</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/sys/i386/conf</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mkdir /root/kernels</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cp GENERIC /root/kernels/MYKERNEL</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>ln -s /root/kernels/MYKERNEL</code></strong></pre></div><p>現在，就開始用自己喜歡的編輯器來修改 <code class="filename">MYKERNEL</code>。
      若才剛裝好 FreeBSD 而已，唯一可用的編輯器很可能是
      <span class="application">vi</span> 了，由於它的用法很多種，礙於篇幅將不詳細介紹，
      你可在 <a class="link" href="bibliography.html" title="附錄 B. 參考文獻">參考書目</a> 內找到相關書籍。
      不過，FreeBSD 也提供另一個更好用的編輯器，它叫做
      <span class="application">ee</span>，對新手而言，這可能是蠻好的選擇。
      你可以任意修改檔案內的相關註解以說明相關設定為何，
      或者其他想改的 <code class="filename">GENERIC</code> 設定內容。</p><a id="idp73129680" class="indexterm"></a><p>若你有在 <span class="trademark">SunOS</span>™ 或者其他種 BSD 作業系統下進行編譯 kernel 的經驗，
      那麼應該已經很熟悉本篇所介紹的大部分步驟。
      換句話說，若您之前用的是 DOS 這類作業系統，那麼
      <code class="filename">GENERIC</code> 設定檔的內容就可能比較難懂些，沒關係，
      我們將在下面的 <a class="link" href="kernelconfig-config.html" title="9.5. kernel 設定檔解說">kernel 設定</a>
      會循序漸進地介紹。</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">若有從 FreeBSD 計劃去更新你的 source tree 的話，
        則切記在進行任何升級之前，務必要察看
	<code class="filename">/usr/src/UPDATING</code>。
	這檔會介紹在更新過程中的重大議題或要注意的事項。
	由於 <code class="filename">/usr/src/UPDATING</code> 是對應於你機器上目前的
	FreeBSD source code 版本，因此會提供比本手冊更新的內容。</p></div><p>現在開始來編譯 kernel 吧。</p><div class="procedure"><a id="idp73133904"></a><div class="procedure-title">過程 9.1. 編譯 Kernel</div><ol class="procedure" type="1"><li class="step"><p>請切換至 <code class="filename">/usr/src</code> 目錄：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong></pre></li><li class="step"><p>編譯 kernel：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make buildkernel KERNCONF=MYKERNEL</code></strong></pre></li><li class="step"><p>安裝新 kernel：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make installkernel KERNCONF=MYKERNEL</code></strong></pre></li></ol></div><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">要有完整的 FreeBSD source tree 才能編譯 kernel。</p></div><div xmlns="" class="tip"><h3 class="admontitle">提示: </h3><p xmlns="http://www.w3.org/1999/xhtml">預設情況下，在編譯自訂 kernel 時，<span class="emphasis"><em>全部的</em></span>
	kernel modules 也會一起重編。  若要快速升級 kernel，
	或是只想重編所需的 kernel module，那麼在編譯 kernel 前要先改一下
	<code class="filename">/etc/make.conf</code>，比如：</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">MODULES_OVERRIDE = linux acpi sound/sound sound/driver/ds1 ntfs</pre><p xmlns="http://www.w3.org/1999/xhtml">上面該設定值為所希望重編的 kernel module 列表。</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">WITHOUT_MODULES = linux acpi sound/sound sound/driver/ds1 ntfs</pre><p xmlns="http://www.w3.org/1999/xhtml">而上面這設定值則為不要編入的 kernel module 列表。  若想更瞭解其他
	kernel 編譯的相關變數，請參閱 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">make.conf</span>(5)</span></a> 說明。</p></div><a id="idp73149008" class="indexterm"></a><p>新的 kernel 會複製到 <code class="filename">/boot/kernel</code> 目錄內的
      <code class="filename">/boot/kernel/kernel</code>，而舊的則移至
      <code class="filename">/boot/kernel.old/kernel</code>。
      現在呢，先關機，然後就會以新 kernel 重開機
      若有問題的話，本章後面會介紹一些<a class="link" href="kernelconfig-trouble.html" title="9.6. If Something Goes Wrong">疑難雜症</a>來協助你。
      若新 kernel 無法開機的話，請參閱 <a class="link" href="kernelconfig-trouble.html#kernelconfig-noboot">這裡</a> 以恢復系統運作。</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">至於開機過程的其他相關檔案、設定，比如 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a>
	及其設定，則放在 <code class="filename">/boot</code>。
	Third party 或自訂的 kernel modules 則會放在
	<code class="filename">/boot/kernel</code>，不過，
	應注意要保持 kernel module 與 kernel 是否有同步，
	這點很重要，否則會導致不穩或出問題。</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="kernelconfig-devices.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="kernelconfig.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="kernelconfig-config.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">9.3. 探測系統硬體 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 9.5. kernel 設定檔解說</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>