<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>4.4. Patching</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD Porter's Handbook" /><link rel="up" href="slow.html" title="章 4. Slow Porting" /><link rel="prev" href="slow-modifying.html" title="4.3. 量身打造 port" /><link rel="next" href="slow-configure.html" title="4.5. 設定" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4.4. Patching</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="slow-modifying.html">前一頁</a> </td><th width="60%" align="center">章 4. Slow Porting</th><td width="20%" align="right"> <a accesskey="n" href="slow-configure.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="slow-patch"></a>4.4. Patching</h2></div></div></div><p>在 port 的準備過程中，新增或變更過的檔案，
	  可以利用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a> 將這些變動列出，
	  以便後續讓 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=patch&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">patch</span>(1)</span></a> 使用。
	  所有你想套用的 patch 都應該命名為
	  <code class="filename">patch-*</code>，其中
	  <em class="replaceable"><code>*</code></em> 表示要 patch 檔案的路徑及檔名名稱，
	  例如 <code class="filename">patch-Imakefile</code> 或
	  <code class="filename">patch-src-config.h</code>。
	  這些檔案都應該儲存在 <code class="varname">PATCHDIR</code>
	  (通常是 <code class="filename">files/</code>，放在其內的檔案都會自動被套用。
	  所有 patch 檔路徑都是相對於
	  <code class="varname">WRKSRC</code> (通常會將 port 的 tarball 解壓到裡面，
	  port 的建置也會在這裡完成)。
	  為了能讓修正和更新更順利，你應該避免多個 patch 修正同一個檔案
	  (舉例來說，<code class="filename">patch-file</code> 和
	  <code class="filename">patch-file2</code> 同時更動
	  <code class="filename">WRKSRC/foobar.c</code>)。</p><p>請只使用 <code class="literal">[-+._a-zA-Z0-9]</code> 這些字元來命名
	  patch 檔，不要使用這些字元以外的字元。
	  千萬不要將你的 patch 檔命名成 <code class="filename">patch-aa</code> 或是
	  <code class="filename">patch-ab</code> 等名稱，
	  請使用路徑和名稱相關的命名。</p><p>不要將 RCS 字串放進你的 patch 檔。CVS 會在這些檔案送入
	  ports tree 的時候弄亂檔案內容，而且在將它們重新 check out
	  出來後，會因檔案內容的差異造成 patch 失敗。
	  RCS 字串是以錢字號 (<code class="literal">$</code>) 括起來的，
	  通常以 <code class="literal">$Id</code> 或
	  <code class="literal">$RCS</code> 為開頭。</p><p>你可以使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a> 搭配 recurse (<code class="option">-r</code>) 選項
	  來產生 patch 檔，但請再次檢視產生出的 patch 檔，確保你沒有產生
	  任何不必要的垃圾資訊在裡面。特別是對那些經由
	  <code class="command">Imake</code> 或 GNU <code class="command">configure</code>
	  所產生的 <code class="filename">Makefile</code> 檔產生 patch，
	  都是不必要的，這類的 patch 檔都應該被刪除。假如你必須透過修改
	  <code class="command">configure.in</code> 再執行
	  <code class="command">autoconf</code> 來重新產生
	  <code class="command">configure</code>，不要對
	  <code class="command">configure</code> 產生 patch 檔 (這往往會長成數千行！)；
	  請定義 <code class="literal">USE_AUTOTOOLS=autoconf:261</code> 並對
	  <code class="filename">configure.in</code> 產生 patch 檔。</p><p>請儘量不要對無用的 whitespace 作修改，因為在 Open Source 界各個
	  project 都會使用很多相同的 code base，這些可能卻是採用不同的編排方式
	  、coding style。  若要試圖改變這些編排風格的話，請小心：
	  這些只會是徒勞無功的更改。  此外不僅會造成 CVS repository 空間浪費，
	  也會讓人難以找出真正問題癥結所在，以及分辨不出這段 patch 到底在作什麼
	  。</p><p>假如你必須刪除一個檔案，那麼你可以在
	  <code class="buildtarget">post-extract</code> 階段做這件事，
	  而不是在 patch 階段。</p><p>你可以直接在 port 的
	  <code class="filename">Makefile</code> 中完成簡單的置換工作，只需使用
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sed&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">sed</span>(1)</span></a> 的 in-place mode 即可。這在只需 patch 一個變數的值時相當有用。
	  例如：</p><pre class="programlisting">post-patch:
	@${REINPLACE_CMD} -e 's|for Linux|for FreeBSD|g' ${WRKSRC}/README
	@${REINPLACE_CMD} -e 's|-pthread|${PTHREAD_LIBS}|' ${WRKSRC}/configure</pre><p>在移植軟體時，特別是那些在 <span class="trademark">Windows</span>® 平台開發的軟體，
	  時常會遇到一種情況，就是在大部份的 source file 中，
	  使用 CR/LF 做為斷行。這會影響往後的 patching、compiler warnings、以及
	  scripts execution (找不到 <code class="command">/bin/sh^M</code> 的情況) 等。
	  為了快速轉換 CR/LF 為 LF，可以把
	  <code class="literal">USE_DOS2UNIX=yes</code> 加到 port 的
	  <code class="filename">Makefile</code> 檔中。
	  你也可以設定成只針對指定的檔案做轉換：</p><pre class="programlisting">USE_DOS2UNIX=    util.c util.h</pre><p>若想要轉換所有子目錄內的某類別檔案，可以使用
	  <code class="varname">DOS2UNIX_REGEX</code>。  它的參數是
	  <code class="command">find</code> 相容的正規表達式。  相關格式可參閱
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=re_format&amp;sektion=7"><span class="citerefentry"><span class="refentrytitle">re_format</span>(7)</span></a>。  對於所指定副檔名的檔案之轉換而言，這相當好用，
	  舉例來說，只動所有原始碼部分而不改 binary 檔案：</p><pre class="programlisting">USE_DOS2UNIX=    yes
DOS2UNIX_REGEX=  .*\.(c|cpp|h)</pre></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="slow-modifying.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="slow.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="slow-configure.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">4.3. 量身打造 port </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 4.5. 設定</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>