<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>NanoBSD 簡介</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><meta name="description" content="這篇文件提供了關於 NanoBSD 工具的情報介紹， 這工具可用來建立用於嵌入式環境應用程式的 FreeBSD 系統映像檔， 以便存放到 Compact Flash 卡(或隨身碟)。" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div xml:lang="zh_tw" class="article" lang="zh_tw"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61118032"></a>NanoBSD 簡介</h1></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Daniel</span> <span class="surname">Gerzo</span></h3></div></div></div><div>修訂: <a href="https://svnweb.freebsd.org/changeset/doc/"><span class="svnref"></span></a></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">版權 © 2006 The FreeBSD Documentation Project</p></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="trademarks"></a><p>FreeBSD 是 FreeBSD基金會的註冊商標</p><p>許多製造商和經銷商使用一些稱為商標的圖案或文字設計來彰顯自己的產品。
  本文中出現的眾多商標，以及 FreeBSD Project 本身廣所人知的商標，後面將以 '™' 或 '®' 符號來標註。</p></div></div><div>   由 .</div><div><div xmlns="http://www.w3.org/1999/xhtml" class="abstract"><div class="abstract-title">摘要</div><p>這篇文件提供了關於 <span class="application">NanoBSD</span> 工具的情報介紹，
	這工具可用來建立用於嵌入式環境應用程式的 FreeBSD 系統映像檔，
	以便存放到 Compact Flash 卡(或隨身碟)。</p></div></div></div><hr /></div><div class="toc"><div class="toc-title">內容目錄</div><dl class="toc"><dt><span class="sect1"><a href="#intro">1. NanoBSD 簡介</a></span></dt><dt><span class="sect1"><a href="#howto">2. 如何使用 NanoBSD</a></span></dt><dt><span class="index"><a href="#idp61822928">索引</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="intro"></a>1. NanoBSD 簡介</h2></div></div></div><a id="idp61498832" class="indexterm"></a><p><span class="application">NanoBSD</span> 是 Poul-Henning Kamp 目前正在開發的一項工具。
      它可用來建立用於嵌入式環境應用程式的 FreeBSD 系統映像檔，
      以便存放到 Compact Flash 卡(或隨身碟，mass storage medium)。</p><p>這一工具也可以用來自製安裝映像檔，
      以簡化俗稱為 <span class="quote">“<span class="quote">嵌入式系統(computer appliances)</span>”</span> 的系統安裝、維護工作。
      通常，每個嵌入式系統產品都有限定硬體和軟體，
      或者換言之，所有的應用程式都是預先裝好的。
      這些設備可以直接放到現有的網路中，而且(幾乎是)立即使用。</p><p><span class="application">NanoBSD</span> 提供的功能包括：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>可以和 FreeBSD 一樣使用 Ports 和 Packages ——
	  所有的應用程序都可以在 <span class="application">NanoBSD</span> 中直接使用，
	  而方式與 FreeBSD 完全一樣。</p></li><li class="listitem"><p>功能絲毫未損 —— 在 FreeBSD 做的任何工作，都可以在
	  <span class="application">NanoBSD</span> 中使用，
	  除非您在建立 <span class="application">NanoBSD</span> 映像檔時，
	  有指定要拿掉它們。</p></li><li class="listitem"><p>所有東西在運行時都是唯讀的 —— 可以安全地拔掉電源插頭。
	  系統不正常關機的話，不用再跑 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a> 了。</p></li><li class="listitem"><p>可輕鬆編譯、自行打造 —— 只需使用一個 shell script 和一個設定檔，
	  您可以輕鬆依需求來量身訂做適用的映像檔。</p></li></ul></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="howto"></a>2. 如何使用 NanoBSD</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="design"></a>2.1. NanoBSD 的設計</h3></div></div></div><p>一旦將映像檔存入嵌入式硬體，就可以用它來引導 <span class="application">NanoBSD</span>
	了。 預設情況下，隨身碟會劃分為三部分：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>兩個映像檔分割區： <code class="literal">code#1</code>
	    和 <code class="literal">code#2</code>。</p></li><li class="listitem"><p>一個設定檔分割區，在運行環境中，
	    可以將其掛載(mount)到 <code class="filename">/cfg</code> 目錄下。</p></li></ul></div><p>這些分割區，在預設情況下是以唯讀方式掛載。</p><p><code class="filename">/etc</code> 和
	<code class="filename">/var</code> 目錄均為
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=md&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">md</span>(4)</span></a>(malloc)磁碟。</p><p>設定檔的分割區則是在
	<code class="filename">/cfg</code> 目錄。
	它包含了用於 <code class="filename">/etc</code>
	目錄的檔案，在啟動之後暫時以唯讀方式掛載。 因此，若想要重開機保留新的設定，
	那麼要記得從 <code class="filename">/etc</code> 把改過的檔案複製回
	<code class="filename">/cfg</code> 目錄才行。</p><div class="example"><a id="idp61556176"></a><div class="example-title">範例 1. 把修改過 <code class="filename">/etc/resolv.conf</code> 設定保存起來</div><div class="example-contents"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>vi /etc/resolv.conf</code></strong>
[...]
<code class="prompt">#</code> <strong class="userinput"><code>mount /cfg</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cp /etc/resolv.conf /cfg</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>umount /cfg</code></strong></pre></div></div><br class="example-break" /><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">只有在系統啟動過程中，以及需要修改設定檔的時候，才需要掛載含有
	  <code class="filename">/cfg</code> 的那個分割區。</p><p xmlns="http://www.w3.org/1999/xhtml">一直都掛載 <code class="filename">/cfg</code>
	  不是一個好主意，特別是當您把 <span class="application">NanoBSD</span>
	  放在不適合進行大量寫入動作的分割區時
	 (比如：由於檔案系統的同步化會定期在系統碟內寫入資料)。</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61580368"></a>2.2. 打造 NanoBSD 映像檔</h3></div></div></div><p><span class="application">NanoBSD</span> 映像檔是透過使用非常簡單的
	<code class="filename">nanobsd.sh</code> shell  script 來打造的，這個 script 可以在
	<code class="filename">/usr/src/tools/tools/nanobsd</code>
	目錄中找到。 這個 script 建立的映像檔，可以用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dd&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">dd</span>(1)</span></a> 工具來複製到隨身碟上。</p><p>打造
	<span class="application">NanoBSD</span> 映像檔所需的指令是：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/tools/tools/nanobsd</code></strong> <a id="nbsd-cd"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>sh nanobsd.sh</code></strong> <a id="nbsd-sh"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/obj/nanobsd.full</code></strong> <a id="nbsd-cd2"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>dd if=_.disk.full of=/dev/da0 bs=64k</code></strong> <a id="nbsd-dd"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-cd"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>進入 <span class="application">NanoBSD</span> 打造 script 的主目錄。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-sh"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>開始打造過程。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-cd2"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>進入打造好的映像檔所在的目錄。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-dd"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>在隨身碟上安裝 <span class="application">NanoBSD</span>。</p></td></tr></table></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61627984"></a>2.3. 自行打造 NanoBSD 映像檔</h3></div></div></div><p>這可能是 <span class="application">NanoBSD</span> 最為重要，
	同時也是您最感興趣的功能。 同時，在開發
	<span class="application">NanoBSD</span> 應用程式時，這也是相當耗時的過程。</p><p>執行下面的指令將會
	<code class="filename">nanobsd.sh</code> 讀取目前所在目錄的
	<code class="filename">myconf.nano</code> 檔的設定：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh nanobsd.sh -c myconf.nano</code></strong></pre><p>自行打造的流程，只需兩個步驟：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>自訂選項</p></li><li class="listitem"><p>自訂功能</p></li></ul></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61642448"></a>2.3.1. 自訂選項</h4></div></div></div><p>透過修改設定，可以設定用於
          <span class="application">NanoBSD</span> 打造過程中 <code class="literal">buildworld</code>
          和 <code class="literal">installworld</code> 階段的編譯、安裝選項，以及
          <span class="application">NanoBSD</span> 主要打造過程中的選項。
          透過使用這些選項可以削減系統的尺寸，使之能夠放入
          64 MB 的隨身碟。 您還可以進一步透過這些選項來削減 FreeBSD，
          直到它只包含 kernel 以及兩三個 userland 檔案為止。</p><p>設定檔案中包含用以代替預設值的設定選項。簡介最重要的幾項設定如下：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">NANO_NAME</code> —— 本次打造的名稱(所建立工作目錄的名稱)。</p></li><li class="listitem"><p><code class="literal">NANO_SRC</code> —— 用以編譯、打造映像檔的 source tree 的位置。</p></li><li class="listitem"><p><code class="literal">NANO_KERNEL</code> —— 設定用來編譯的 kernel 設定檔檔名。</p></li><li class="listitem"><p><code class="literal">CONF_BUILD</code> —— 用於
	      <code class="literal">buildworld</code> 打造階段的選項。</p></li><li class="listitem"><p><code class="literal">CONF_INSTALL</code> —— 用於
	      <code class="literal">installworld</code> 打造階段的選項。</p></li><li class="listitem"><p><code class="literal">CONF_WORLD</code> —— 用於
	      <code class="literal">buildworld</code> 和
	      <code class="literal">installworld</code> 這兩個打造階段的選項。</p></li><li class="listitem"><p><code class="literal">FlashDevice</code> —— 定義所用的嵌入式硬體類型。
	      詳情請參考 <code class="filename">FlashDevice.sub</code> 檔。</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61682512"></a>2.3.2. 自訂功能</h4></div></div></div><p>透過在設定檔案中使用 shell 函數，可以進一步微調
	  <span class="application">NanoBSD</span>。 舉例說明一下自行打造函數的基本方式：</p><pre class="programlisting">cust_foo()(
	echo "bar=topless" &gt; \
		${NANO_WORLDDIR}/etc/foo
)
customize_cmd cust_foo</pre><p>下面舉更實際點的例子，它會把預設的
          <code class="filename">/etc</code> 目錄大小，從 5MB 調整為 30MB：</p><pre class="programlisting">cust_etc_size()(
	cd ${NANO_WORLDDIR}/conf
	echo 30000 &gt; default/etc/md_size
)
customize_cmd cust_etc_size</pre><p>除此之外，還有幾個預設的功能定義可以用來自訂：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">cust_comconsole</code> —— 在預設 VGA 顯示卡上停用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getty&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">getty</span>(8)</span></a>
	     (<code class="filename">/dev/ttyv*</code>)並啟用 serial port 的 COM1 以作為系統 console。</p></li><li class="listitem"><p><code class="literal">cust_allow_ssh_root</code> —— 允許 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a>
	      可以用 <code class="systemitem">root</code> 帳號登入。</p></li><li class="listitem"><p><code class="literal">cust_install_files</code> ——
	      從 <code class="filename">nanobsd/Files</code>
	      目錄中安裝檔案，這包含一些實用的系統管理 script 。</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61729616"></a>2.3.3. 設定檔案舉例</h4></div></div></div><p>下面是用於自行打造的 <span class="application">NanoBSD</span> 映像檔的完整例子：</p><pre class="programlisting">NANO_NAME=custom
NANO_SRC=/usr/src
NANO_KERNEL=MYKERNEL
NANO_IMAGES=2

CONF_BUILD='
NO_KLDLOAD=YES
NO_NETGRAPH=YES
NO_PAM=YES
'

CONF_INSTALL='
NO_ACPI=YES
NO_BLUETOOTH=YES
NO_CVS=YES
NO_FORTRAN=YES
NO_HTML=YES
NO_LPR=YES
NO_MAN=YES
NO_SENDMAIL=YES
NO_SHAREDOCS=YES
NO_EXAMPLES=YES
NO_INSTALLLIB=YES
NO_CALENDAR=YES
NO_MISC=YES
NO_SHARE=YES
'

CONF_WORLD='
NO_BIND=YES
NO_MODULES=YES
NO_KERBEROS=YES
NO_GAMES=YES
NO_RESCUE=YES
NO_LOCALES=YES
NO_SYSCONS=YES
NO_INFO=YES
'

FlashDevice SanDisk 1G

cust_nobeastie()(
	touch ${NANO_WORLDDIR}/boot/loader.conf
	echo "beastie_disable=\"YES\"" &gt;&gt; ${NANO_WORLDDIR}/boot/loader.conf
)

customize_cmd cust_comconsole
customize_cmd cust_install_files
customize_cmd cust_allow_ssh_root
customize_cmd cust_nobeastie</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61733456"></a>2.4. 更新 NanoBSD</h3></div></div></div><p>更新 <span class="application">NanoBSD</span> 相對 FreeBSD 而言較為簡單：</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>和之前一樣打造新的 <span class="application">NanoBSD</span> 映像檔。</p></li><li class="step"><p>將新的映像檔放入正運行的
	    <span class="application">NanoBSD</span> 中未用的分割區之一。</p><p>與之前最初安裝 <span class="application">NanoBSD</span> 的步驟相比，
	    這一步驟最重要的區別在於：這次不用 <code class="filename">_.disk.full</code> 檔(它包含整個磁碟的映像檔)，
	    而應安裝 <code class="filename">_.disk.image</code> 映像檔(這個檔案中，只包含一個系統分割區)。</p></li><li class="step"><p>重新啟動，並從新安裝的分割區中啟動系統。</p></li><li class="step"><p>如果一切順利的話，升級工作就完成了。</p></li><li class="step"><p>如果發生了任何問題，則可以從先前的分割區啟動
	 (其中包含了舊的、 可用的映像檔)，來盡快恢復系統功能。
	  接下來可以修正新編譯的版本中存在的問題，並重複前述步驟。</p></li></ol></div><p>要在正在運行的
	<span class="application">NanoBSD</span> 系統中安裝新的映像檔，可以使用位於
	<code class="filename">/root</code> 目錄的
	<code class="filename">updatep1</code> 或
	<code class="filename">updatep2</code>  script ，
	實際上要用哪一個 script，則取決於正在運行的系統是位於哪個分割區而定。</p><p>隨時提供新 <span class="application">NanoBSD</span> 映像檔所提供的服務，
	以及採用的傳輸方法的不同，您可以參考並使用下列三種方式之一：</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61773520"></a>2.4.1. 使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ftp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ftp</span>(1)</span></a></h4></div></div></div><p>如果傳輸速度是第一要求的話，請採用下面例子：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ftp myhost
get _.disk.image "| sh updatep1"</code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61782096"></a>2.4.2. 使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a></h4></div></div></div><p>如果想更安全的話，應參考下面例子：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ssh myhost cat _.disk.image.gz | zcat | sh updatep1</code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61792976"></a>2.4.3. 使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=nc&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">nc</span>(1)</span></a></h4></div></div></div><p>如果遠程主機既不提供 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ftp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ftp</span>(1)</span></a> 服務，也不提供 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a> 服務的話：</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>首先，在提供映像檔的主機上開啟 TCP listen，並讓它把映像檔傳給 client：</p><pre class="screen">myhost<code class="prompt">#</code> <strong class="userinput"><code>nc -l 2222 &lt; _.disk.image</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">請確認您所使用的 port 沒有被防火牆阻止來自
		<span class="application">NanoBSD</span> client 的連線請求。</p></div></li><li class="step"><p>連到提供新映像檔服務的主機，並執行 <code class="filename">updatep1</code> 這支 script：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>nc myhost 2222 | sh updatep1</code></strong></pre></li></ol></div></div></div></div><div class="index"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61822928"></a>索引</h2></div></div></div><div class="index"><div class="indexdiv"><h3>N</h3><dl><dt>NanoBSD, <a class="indexterm" href="#intro">NanoBSD 簡介</a></dt></dl></div></div></div></div></body></html>