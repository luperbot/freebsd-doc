<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>20.4. RAID1 - spiegelen</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD handboek" /><link rel="up" href="GEOM.html" title="Hoofdstuk 20. GEOM: Modulair schijftransformatie raamwerk" /><link rel="prev" href="GEOM-striping.html" title="20.3. RAID0 - aaneengeschakeld" /><link rel="next" href="GEOM-raid3.html" title="20.5. RAID3 - Striping op byte-niveau met toegewijde pariteit" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">20.4. RAID1 - spiegelen</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="GEOM-striping.html">Terug</a> </td><th width="60%" align="center">Hoofdstuk 20. GEOM: Modulair schijftransformatie raamwerk</th><td width="20%" align="right"> <a accesskey="n" href="GEOM-raid3.html">Volgende</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="GEOM-mirror"></a>20.4. RAID1 - spiegelen</h2></div></div></div><a id="idp81031888" class="indexterm"></a><a id="idp81032400" class="indexterm"></a><a id="idp81032912" class="indexterm"></a><p><acronym class="acronym">RAID1</acronym>, of <em class="firstterm">spiegelen</em>, is de
      techniek om dezelfde gegevens naar meer dan één schijf te schrijven.
      Spiegels worden normaliter gebruikt om tegen gegevensverlies te beschermen
      indien een schijf kapot gaat.  Elke schijf in een spiegel bevat een
      identieke kopie van de gegevens.  Wanneer een individuele schijf het
      begeeft, blijft de spiegel functioneren, en levert het gegevens van de
      schijven die nog wel functioneren.  De computer blijft draaien en de
      beheerder heeft tijd om de kapotte schijf te vervangen zonder onderbreking
      voor de gebruikers.</p><p>Twee veelvoorkomende situaties worden in deze voorbeelden getoond.
      Het eerste is het maken van een spiegel van twee nieuwe schijven en het
      als vervanging voor een bestaande enkele schijf te gebruiken.  Het tweede
      voorbeeld maakt een spiegel op een enkele nieuwe schijf aan, kopieert de
      gegevens van de oude schijf er naar toe, en plaatst daarna de oude schijf
      in de spiegel.  Hoewel deze procedure iets moeilijker is, is er maar één
      nieuwe schijf nodig.</p><p>Traditioneel zijn de twee schijven in een spiegel van hetzelfde model
      en hebben ze dezelfde capaciteit, maar <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> verplicht dit niet.
      Spiegels die met ongelijke schijven zijn gemaakt zullen de capaciteit van
      de kleinste schijf in de spiegel aannemen.  Extra schijfruimte op grotere
      schijven zal ongebruikt blijven.  Schijven die later in de spiegel worden
      geplaatst moeten tenminste evenveel capaciteit hebben als de kleinste
      schijf die reeds in de spiegel zit.</p><div xmlns="" class="warning"><h3 class="admontitle">Waarschuwing: </h3><p xmlns="http://www.w3.org/1999/xhtml">De procedures voor het spiegelen die hier getoond worden zijn
	niet-destructief, maar maak zoals bij elke grote schijfoperatie eerst
	een volledige back-up.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="GEOM-mirror-metadata"></a>20.4.1. Kwesties met meta-gegevens</h3></div></div></div><p>Veel schijfsystemen slaan meta-gegevens op aan het einde van elke
	schijf.  Oude meta-gegevens dienen gewist te worden voordat de schijf
	herbruikt wordt voor een spiegel.  De meeste problemen worden
	veroorzaakt door twee soorten van achtergebleven meta-gegevens:
	GPT-partitietabellen en oude meta-gegevens van <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> van een
	vorige spiegel.</p><p>GPT-meta-gegevens kunnen gewist worden met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gpart&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gpart</span>(8)</span></a>.  Dit
	voorbeeld wist zowel de primaire als de back-up GPT-partitietabellen van
	schijf <code class="filename">ada8</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart destroy -F ada8</code></strong></pre><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> kan in één stap een schijf uit een actieve spiegel
	halen en de meta-gegevens wissen.  Hier wordt de voorbeeldschijf
	<code class="filename">ada8</code> uit de actieve spiegel
	<code class="filename">gm4</code> gehaald:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror remove gm4 ada8</code></strong></pre><p>Gebruik, als de spiegel niet draait maar er nog oude meta-gegevens
	van de spiegel op de schijf staan, <code class="command">gmirror clear</code> om
	deze te verwijderen:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror clear ada8</code></strong></pre><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> slaat één blok aan meta-gegevens aan het einde van
	de schijf op.  Omdat GPT-partitieschema's ook meta-gegevens aan het
	einde van de schijf opslaan, wordt het spiegelen van volledige
	GPT-schijven met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> niet aangeraden.  Hier wordt
	MBR-partitionering gebruikt omdat het alleen een partitietabel aan het
	begin van de schijf opslaat en niet conflicteert met
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp81052624"></a>20.4.2. Een spiegel met twee nieuwe schijven maken</h3></div></div></div><p>In dit voorbeeld is FreeBSD reeds op een enkele schijf
	<code class="filename">ada0</code> geïnstalleerd.  Twee nieuwe schijven,
	<code class="filename">ada1</code> en <code class="filename">ada2</code> zijn met
	het systeem verbonden.  Er zal een nieuwe spiegel op deze twee schijven
	aangemaakt worden die de oude enkele schijf zal vervangen.</p><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> heeft een kernelmodule
	<code class="filename">geom_mirror.ko</code> nodig, ingebouwd in de kernel of
	geladen tijdens het opstarten of draaien.  Laadt nu handmatig de
	kernelmodule:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror load</code></strong></pre><p>Maak de spiegel aan met de twee nieuwe schijven:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror label -v gm0 /dev/ada1 /dev/ada2</code></strong></pre><p><code class="filename">gm0</code> is een door de gebruiker gekozen
	apparaatnaam die aan de nieuwe spiegel wordt toegekend.  Nadat de
	spiegel is gestart, zal deze apparaatnaam verschijnen in de map
	<code class="filename">/dev/mirror/</code>.</p><p>Nu kunnen er met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gpart&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gpart</span>(8)</span></a> MBR- en bsdlabel-partitietabellen op
	de spiegel worden aangemaakt.  Hier wordt er een traditioneel schema
	van een gesplitst bestandssysteem getoond, met partities voor
	<code class="filename">/</code>, swap, <code class="filename">/var</code>,
	<code class="filename">/tmp</code> en <code class="filename">/usr</code>.  Dit werkt ook
	voor een enkel bestandssysteem met enkel <code class="filename">/</code> en
	een wisselpartitie.</p><p>Partities op de spiegel hoeven niet dezelfde grootte te hebben als
	die op de bestaande schijf, maar moeten groot genoeg zijn om alle
	gegevens die reeds op <code class="filename">ada0</code> staan te kunnen
	bevatten.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart create -s MBR mirror/gm0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart add -t freebsd -a 4k mirror/gm0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart show mirror/gm0</code></strong>
=&gt;       63  156301423  mirror/gm0  MBR  (74G)
         63         63                    - free -  (31k)
        126  156301299                 1  freebsd  (74G)
  156301425         61                    - free -  (30k)</pre><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart create -s BSD mirror/gm0s1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart add -t freebsd-ufs  -a 4k -s 2g mirror/gm0s1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart add -t freebsd-swap -a 4k -s 4g mirror/gm0s1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart add -t freebsd-ufs  -a 4k -s 2g mirror/gm0s1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart add -t freebsd-ufs  -a 4k -s 1g mirror/gm0s1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart add -t freebsd-ufs  -a 4k       mirror/gm0s1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart show mirror/gm0s1</code></strong>
=&gt;        0  156301299  mirror/gm0s1  BSD  (74G)
          0          2                      - free -  (1.0k)
          2    4194304                   1  freebsd-ufs  (2.0G)
    4194306    8388608                   2  freebsd-swap  (4.0G)
   12582914    4194304                   4  freebsd-ufs  (2.0G)
   16777218    2097152                   5  freebsd-ufs  (1.0G)
   18874370  137426928                   6  freebsd-ufs  (65G)
  156301298          1                      - free -  (512B)</pre><p>Maak de spiegel opstartbaar door opstartcode in het MBR en bsdlabel
	te installeren en de actieve slice in te stellen:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart bootcode -b /boot/mbr mirror/gm0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart set -a active -i 1 mirror/gm0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart bootcode -b /boot/boot mirror/gm0s1</code></strong></pre><p>Formatteer de bestandssystemen op de nieuwe spiegel en zet daarbij
	soft-updates aan.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1a</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1d</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1e</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1f</code></strong></pre><p>Bestandssystemen van de originele schijf
	(<code class="filename">ada0</code>) kunnen nu met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> en
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=restore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">restore</span>(8)</span></a> naar de spiegel gekopieerd worden:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1a /mnt</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - / | (cd /mnt &amp;&amp; restore -rf -)</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1d /mnt/var</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1e /mnt/tmp</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1f /mnt/usr</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - /var | (cd /mnt/var &amp;&amp; restore -rf -)</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - /tmp | (cd /mnt/tmp &amp;&amp; restore -rf -)</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - /usr | (cd /mnt/usr &amp;&amp; restore -rf -)</code></strong></pre><p><code class="filename">/mnt/etc/fstab</code> moet bewerkt worden om naar de
	nieuwe bestandssystemen op de spiegel te wijzen:</p><pre class="programlisting"># Device		Mountpoint	FStype	Options	Dump	Pass#
/dev/mirror/gm0s1a	/		ufs	rw	1	1
/dev/mirror/gm0s1b	none		swap	sw	0	0
/dev/mirror/gm0s1d	/var		ufs	rw	2	2
/dev/mirror/gm0s1e	/tmp		ufs	rw	2	2
/dev/mirror/gm0s1f	/usr		ufs	rw	2	2</pre><p>Als de kernelmodule <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> niet in de kernel is ingebouwd,
	wordt <code class="filename">/mnt/boot/loader.conf</code> bewerkt om de module
	tijdens het opstarten te laden:</p><pre class="programlisting">geom_mirror_load="YES"</pre><p>Herstart het systeem om de nieuwe spiegel te testen en te verifiëren
	dat alle gegevens zijn gekopieerd.  Het BIOS zal de spiegel als twee
	individuele schijven zien in plaats van als een spiegel.  Omdat de
	schijven identiek zijn, maakt het niet uit vanaf welke schijf wordt
	opgestart.</p><p>Bekijk de sectie <a class="link" href="GEOM-mirror.html#gmirror-troubleshooting" title="20.4.4. Problemen oplossen">Problemen
	  oplossen</a> als er problemen zijn tijdens het opstarten.  Door de
	originele <code class="filename">ada0</code> uit te schakelen en los te
	koppelen kan het als offline back-up bewaard worden.</p><p>Tijdens het gebruik zal de spiegel zich net zoals de originele
	enkele schijf gedragen.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp81108816"></a>20.4.3. Een spiegel met een bestaande schijf aanmaken</h3></div></div></div><p>In dit voorbeeld is FreeBSD reeds geïnstalleerd op een enkele schijf,
	<code class="filename">ada0</code>.  Een nieuwe schijf,
	<code class="filename">ada1</code>, is met het systeem verbonden.  Er zal
	een spiegel van één schijf worden aangemaakt op de nieuwe schijf, het
	bestaande systeem zal ernaar worden gekopieerd, en daarna zal de oude
	schijf in de spiegel worden geplaatst.  Deze enigszins complexe
	procedure is nodig omdat <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> een blok van 512 bytes aan
	meta-gegevens aan het einde van elke schijf moet plaatsen en de
	bestaande <code class="filename">ada0</code> meestal alle ruimte reeds heeft
	toegewezen.</p><p>Laadt de kernelmodule <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror load</code></strong></pre><p>Controleer de mediagrootte van de originele schijf met
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diskinfo&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">diskinfo</span>(8)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>diskinfo -v ada0 | head -n3</code></strong>
/dev/ada0
	512             # sectorsize
	1000204821504   # mediasize in bytes (931G)</pre><p>Maak een spiegel aan op de nieuwe schijf.  Om er zeker van te zijn
	dat de capaciteit van de spiegel niet groter is dan die van de originele
	schijf, wordt <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gnop&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gnop</span>(8)</span></a> gebruikt om een nepschijf van precies
	dezelfde grootte aan te maken.  Deze schijf slaat geen gegevens op, maar
	wordt alleen gebruikt om de grootte van de spiegel te begrenzen.
	Wanneer <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> de spiegel aanmaakt, zal het de capaciteit
	beperken tot de grootte van <code class="filename">gzero.nop</code> zelfs
	als de nieuwe schijf (<code class="filename">ada1</code>) meer ruimte heeft.
	Merk op dat de <em class="replaceable"><code>1000204821504</code></em> op de tweede
	regel gelijk moet zijn aan de mediagrootte van
	<code class="filename">ada0</code> zoals hierboven door <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diskinfo&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">diskinfo</span>(8)</span></a> is
	getoond.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>geom zero load</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gnop create -s 1000204821504 gzero</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gmirror label -v gm0 gzero.nop ada1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gmirror forget gm0</code></strong></pre><p><code class="filename">gzero.nop</code> slaat geen gegevens op, dus ziet
	de spiegel het niet als verbonden.  De spiegel wordt verteld om
	componenten die niet verbonden zijn te <span class="quote">&#8220;<span class="quote">vergeten</span>&#8221;</span>, waarbij
	referenties naar <code class="filename">gzero.nop</code> worden verwijderd.
	Het resultaat is een spiegelapparaat dat slechts één enkele schijf,
	<code class="filename">ada1</code>, bevat.</p><p>Bekijk de partitietabel van <code class="filename">ada0</code> nadat
	<code class="filename">gm0</code> is aangemaakt.</p><p>Deze uitvoer komt van een schijf van 1 TB.  Als er wat
	niet-toegewezen ruimte aanwezig is aan het einde van de schijf, kan de
	inhoud direct van <code class="filename">ada0</code> naar de nieuwe spiegel
	worden gekopieerd.</p><p>Als de uitvoer echter toont dat alle ruimte op de schijf is
	toegewezen zoals in de volgende lijst, is er geen ruimte over voor de
	512 bytes aan meta-gegevens van <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> aan het einde van de
	schijf.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart show ada0</code></strong>
=&gt;        63  1953525105        ada0  MBR  (931G)
          63  1953525105           1  freebsd  [active]  (931G)</pre><p>In dit geval moet de partitietabel worden bewerkt om de capaciteit
	op <code class="filename">mirror/gm0</code> met één sector te verminderen.
	De procedure hiervoor wordt later uitgelegd.</p><p>In beide gevallen dienen de partitietabellen op de primaire schijf
	eerst gekopieerd te worden.  Dit kan gedaan worden met de subcommando's
	<code class="command">backup</code> en <code class="command">restore</code> van
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gpart&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gpart</span>(8)</span></a>.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart backup ada0 &gt; table.ada0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart backup ada0s1 &gt; table.ada0s1</code></strong></pre><p>Deze subcommando's maken twee bestanden aan,
	<code class="filename">table.ada0</code> en <code class="filename">table.ada0s1</code>.
	Dit voorbeeld komt van een schijf van 1 TB af:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cat table.ada0</code></strong>
MBR 4
1 freebsd         63 1953525105   [active]</pre><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cat table.ada0s1</code></strong>
BSD 8
1  freebsd-ufs          0    4194304
2 freebsd-swap    4194304   33554432
4  freebsd-ufs   37748736   50331648
5  freebsd-ufs   88080384   41943040
6  freebsd-ufs  130023424  838860800
7  freebsd-ufs  968884224  984640881</pre><p>Als de gehele schijf was gebruikt in de uitvoer van <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gpart&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gpart</span>(8)</span></a>
	<code class="command">show</code>, dan moet de capaciteit in deze partitietabellen
	met één sector verminderd worden.  Bewerk de twee bestanden zodat de
	grootte van zowel de slice als de laatste partitie met één verminderd
	wordt.  Dit zijn de laatste getallen in elke lijst.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cat table.ada0</code></strong>
MBR 4
1 freebsd         63 <span class="emphasis"><em>1953525104</em></span>   [active]</pre><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cat table.ada0s1</code></strong>
BSD 8
1  freebsd-ufs          0    4194304
2 freebsd-swap    4194304   33554432
4  freebsd-ufs   37748736   50331648
5  freebsd-ufs   88080384   41943040
6  freebsd-ufs  130023424  838860800
7  freebsd-ufs  968884224  <span class="emphasis"><em>984640880</em></span></pre><p>Als er tenminste één sector aan het einde van de schijf niet was
	toegewezen, kunnen deze twee bestanden ongewijzigd gebruikt worden.</p><p>Herstel nu de partitietabel naar
	<code class="filename">mirror/gm0</code>.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart restore mirror/gm0 &lt; table.ada0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart restore mirror/gm0s1 &lt; table.ada0s1</code></strong></pre><p>Controleer de partitietabel met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gpart&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gpart</span>(8)</span></a>
	<code class="command">show</code>.  Dit voorbeeld heeft
	<code class="filename">gm0s1a</code> voor <code class="filename">/</code>,
	<code class="filename">gm0s1d</code> voor <code class="filename">/var</code>,
	<code class="filename">gm0s1e</code> voor <code class="filename">/usr</code>,
	<code class="filename">gm0s1f</code> voor <code class="filename">/data1</code> en
	<code class="filename">gm0s1g</code> voor <code class="filename">/data2</code>.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart show mirror/gm0</code></strong>
=&gt;        63  1953525104  mirror/gm0  MBR  (931G)
          63  1953525042           1  freebsd  [active]  (931G)
  1953525105          62              - free -  (31k)

<code class="prompt">#</code> <strong class="userinput"><code>gpart show mirror/gm0s1</code></strong>
=&gt;         0  1953525042  mirror/gm0s1  BSD  (931G)
           0     2097152             1  freebsd-ufs  (1.0G)
     2097152    16777216             2  freebsd-swap  (8.0G)
    18874368    41943040             4  freebsd-ufs  (20G)
    60817408    20971520             5  freebsd-ufs  (10G)
    81788928   629145600             6  freebsd-ufs  (300G)
   710934528  1242590514             7  freebsd-ufs  (592G)
  1953525042          63                - free -  (31k)</pre><p>Zowel de slice als de laatste partitie dienen wat vrije ruimte aan
	het einde van elke schijf te hebben.</p><p>Maak bestandssystemen aan op deze nieuwe partities.  Het aantal
	partities zal variëren, overeenkomend met de partities op de originele
	schijf, <code class="filename">ada0</code>.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1a</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1d</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1e</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1f</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1g</code></strong></pre><p>Maak de spiegel opstartbaar door opstartcode in het MBR en bsdlabel
	te installeren en de actieve slice in te stellen:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gpart bootcode -b /boot/mbr mirror/gm0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart set -a active -i 1 mirror/gm0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gpart bootcode -b /boot/boot mirror/gm0s1</code></strong></pre><p>Pas <code class="filename">/etc/fstab</code> aan zodat het de nieuwe
	partities op de spiegel gebruikt.  Maak eerst een kopie van dit bestand
	als <code class="filename">/etc/fstab.orig</code>.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp /etc/fstab /etc/fstab.orig</code></strong></pre><p>Wijzig <code class="filename">/etc/fstab</code> door
	<code class="filename">/dev/ada0</code> door
	<code class="filename">mirror/gm0</code> te vervangen.</p><pre class="programlisting"># Device		Mountpoint	FStype	Options	Dump	Pass#
/dev/mirror/gm0s1a	/		ufs	rw	1	1
/dev/mirror/gm0s1b	none		swap	sw	0	0
/dev/mirror/gm0s1d	/var		ufs	rw	2	2
/dev/mirror/gm0s1e	/usr		ufs	rw	2	2
/dev/mirror/gm0s1f	/data1		ufs	rw	2	2
/dev/mirror/gm0s1g	/data2		ufs	rw	2	2</pre><p>Als de kernelmodule <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> niet in de kernel is gebouwd,
	wijzig dan <code class="filename">/boot/loader.conf</code> om het te
	laden:</p><pre class="programlisting">geom_mirror_load="YES"</pre><p>Bestandssystemen van de originele schijf kunnen nu met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a>
	en <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=restore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">restore</span>(8)</span></a> naar de spiegel gekopieerd worden.  Merk op dat het
	maken van een snapshot voor elk bestandssysteem dat met <code class="command">dump
	  -L</code> gedumpt is even kan duren.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1a /mnt</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - /    | (cd /mnt &amp;&amp; restore -rf -)</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1d /mnt/var</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1e /mnt/usr</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1f /mnt/data1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1g /mnt/data2</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - /usr | (cd /mnt/usr &amp;&amp; restore -rf -)</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - /var | (cd /mnt/var &amp;&amp; restore -rf -)</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - /data1 | (cd /mnt/data1 &amp;&amp; restore -rf -)</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>dump -C16 -b64 -0aL -f - /data2 | (cd /mnt/data2 &amp;&amp; restore -rf -)</code></strong></pre><p>Start het systeem opnieuw op vanaf <code class="filename">ada1</code>.
	Als alles werkt, zal het systeem opstarten vanaf
	<code class="filename">mirror/gm0</code>, wat nu dezelfde gegevens bevat die
	<code class="filename">ada0</code> eerder bevatte.  Zie de sectie <a class="link" href="GEOM-mirror.html#gmirror-troubleshooting" title="20.4.4. Problemen oplossen">Problemen oplossen</a> als er
	problemen zijn met het opstarten.</p><p>Op dit moment bestaat de spiegel nog steeds alleen uit de enkele
	schijf <code class="filename">ada1</code>.</p><p>Nadat er succesvol van <code class="filename">mirror/gm0</code> is
	opgestart, is de laatste stap het plaatsen van
	<code class="filename">ada0</code> in de spiegel.</p><div xmlns="" class="important"><h3 class="admontitle">Belangrijk: </h3><p xmlns="http://www.w3.org/1999/xhtml">Als <code class="filename">ada0</code> in de spiegel wordt geplaatst,
	  zal de vorige inhoud worden overschreven door gegevens in de spiegel.
	  Ben er zeker van dat <code class="filename">mirror/gm0</code> dezelfde
	  gegevens bevat als <code class="filename">ada0</code> voordat
	  <code class="filename">ada0</code> aan de spiegel wordt toegevoegd.  Als
	  er iets mis is met de gegevens die door <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> en
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=restore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">restore</span>(8)</span></a> gekopieerd zijn, draai dan
	  <code class="filename">/etc/fstab</code> terug om de bestandssystemen op
	  <code class="filename">ada0</code> aan te koppelen, start opnieuw op, en
	  probeer de hele procedure nogmaals.</p></div><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror insert gm0 ada0</code></strong>
GEOM_MIRROR: Device gm0: rebuilding provider ada0</pre><p>De synchronisatie tussen de twee schijven zal onmiddellijk beginnen.
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> <code class="command">status</code> toont de voortgang.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror status</code></strong>
      Name    Status  Components
mirror/gm0  DEGRADED  ada1 (ACTIVE)
                      ada0 (SYNCHRONIZING, 64%)</pre><p>Na een tijd zal de synchronisatie voltooid zijn.</p><pre class="screen">GEOM_MIRROR: Device gm0: rebuilding provider ada0 finished.
<code class="prompt">#</code> <strong class="userinput"><code>gmirror status</code></strong>
      Name    Status  Components
mirror/gm0  COMPLETE  ada1 (ACTIVE)
                      ada0 (ACTIVE)</pre><p><code class="filename">mirror/gm0</code> bestaat nu uit de twee schijven
	<code class="filename">ada0</code> en <code class="filename">ada1</code>, en de
	inhoud wordt automatisch met elkaar gesynchroniseerd.  In het gebruik
	zal <code class="filename">mirror/gm0</code> zich net zo gedragen als de
	originele enkele schijf.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="gmirror-troubleshooting"></a>20.4.4. Problemen oplossen</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp81233872"></a>20.4.4.1. Problemen met opstarten</h4></div></div></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp81234512"></a>20.4.4.1.1. BIOS-instellingen</h5></div></div></div><p>Mogelijk is het nodig om de BIOS-instellingen te wijzigen om
	    van één van de nieuwe gespiegelde schijven op te starten.  Beide
	    spiegelschijven kunnen gebruikt worden voor het opstarten.  Als
	    componenten van een spiegel bevatten ze identieke gegevens.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp81235664"></a>20.4.4.1.2. Opstartproblemen</h5></div></div></div><p>Als het opstarten met dit bericht stopt, is er iets mis met het
	    spiegelapparaat:</p><pre class="screen">Mounting from ufs:/dev/mirror/gm0s1a failed with error 19.

Loader variables:
  vfs.root.mountfrom=ufs:/dev/mirror/gm0s1a
  vfs.root.mountfrom.options=rw

Manual root filesystem specification:
  &lt;fstype&gt;:&lt;device&gt; [options]
      Mount &lt;device&gt; using filesystem &lt;fstype&gt;
      and with the specified (optional) option list.

    eg. ufs:/dev/da0s1a
        zfs:tank
        cd9660:/dev/acd0 ro
          (which is equivalent to: mount -t cd9660 -o ro /dev/acd0 /)

  ?               List valid disk boot devices
  .               Yield 1 second (for background tasks)
  &lt;empty line&gt;    Abort manual input

mountroot&gt;</pre><p>Het vergeten om de module <code class="filename">geom_mirror</code> in
	    <code class="filename">/boot/loader.conf</code> te laden kan dit probleem
	    veroorzaken.  Start op vanaf een FreeBSD-9 of nieuwere CD of USB-stick
	    en kies <code class="literal">Shell</code> op de eerste prompt om dit op te
	    lossen.  Laadt daarna de spiegelmodule en en koppel het
	    spiegelapparaat aan:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror load</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1a /mnt</code></strong></pre><p>Voeg een regel om de spiegelmodule te laden toe aan
	    <code class="filename">/mnt/boot/loader.conf</code>:</p><pre class="programlisting">geom_mirror_load="YES"</pre><p>Sla het bestand op en start opnieuw op.</p><p>Andere problemen die <code class="literal">error 19</code> veroorzaken
	    zijn lastiger om op te lossen.  Typ
	    <code class="literal">ufs:/dev/ada0s1a</code> in op de prompt.  Hoewel het
	    systeem van <code class="filename">ada0</code> zou moeten opstarten,
	    verschijnt er een andere prompt om een shell uit te kiezen omdat
	    <code class="filename">/etc/fstab</code> onjuist is.  Druk op de prompt op
	    de Enter-toets.  Draai de wijzigingen tot nu toe terug door
	    <code class="filename">/etc/fstab</code> terug te draaien, waardoor de
	    bestandssystemen vanaf de originele schijf (
	    <code class="filename">ada0</code>) in plaats vanaf de spiegel worden
	    aangekoppeld.  Start het systeem opnieuw op en probeer de procedure
	    nogmaals.</p><pre class="screen">Enter full pathname of shell or RETURN for /bin/sh:
<code class="prompt">#</code> <strong class="userinput"><code>cp /etc/fstab.orig /etc/fstab</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>reboot</code></strong></pre></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp81263696"></a>20.4.5. Herstellen van falende schijven</h3></div></div></div><p>Het mooie aan het spiegelen van schijven is dat een individuele
	schijf kan falen zonder dat de spiegel gegevens verliest.</p><p><code class="filename">ada0</code> is één van de twee schijven die de
	spiegel in het vorige voorbeeld vormen.  Als
	<code class="filename">ada0</code> faalt zal de spiegel blijven werken en
	gegevens leveren van de overgebleven werkende schijf,
	<code class="filename">ada1</code>.</p><p>Om de kapotte schijf te vervangen wordt de computer uitgezet en de
	kapotte schijf fysiek vervangen door een nieuwe schijf van gelijke of
	grotere capaciteit.  Fabrikanten passen enigszins willekeurige waarden
	toe om schijven in gigabytes aan te duiden, de enige manier om er echt
	zeker van te zijn is om de totale hoeveelheid aan sectors aangegeven
	door <code class="command">diskinfo -v</code> te vergelijken.  Een schijf met een
	grotere capaciteit dan in de spiegel zal werken, alhoewel de extra
	ruimte op de nieuwe schijf niet gebruikt zal worden.</p><p>Nadat de computer opnieuw is aangezet, zal de spiegel in een
	<span class="quote">&#8220;<span class="quote">degraded</span>&#8221;</span> toestand met slechts één schijf draaien.  De
	spiegel wordt verteld om schijven die momenteel niet verbonden zijn te
	vergeten:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror forget gm0</code></strong></pre><p>Alle oude meta-gegevens zouden <a class="link" href="GEOM-mirror.html#GEOM-mirror-metadata" title="20.4.1. Kwesties met meta-gegevens">van de vervangende schijf gewist</a>
	moeten zijn.  Daarna wordt de schijf, in dit voorbeeld
	<code class="filename">ada4</code>, in de spiegel geplaatst:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror insert gm0 /dev/ada4</code></strong></pre><p>De hersynchronisatie begint wanneer de nieuwe schijf in de spiegel
	wordt geplaatst.  Het kopiëren van gegevens van de spiegel naar een
	nieuwe schijf kan een tijd duren.  De prestaties van de spiegel zullen
	tijdens het kopiëren sterk verminderd zijn, dus is het het beste om
	nieuwe schijven in te voegen wanneer de vraag op de computer laag
	is.</p><p>De voortgang kan met <code class="command">gmirror status</code> gevolgd
	worden, wat de schijven die gesynchroniseerd en het percentage van de
	voltooiing laat zien.  Tijdens de hersynchronisatie zal de status
	<code class="computeroutput">DEGRADED</code> zijn en veranderen in
	<code class="computeroutput">COMPLETE</code> wanneer het proces is
	voltooid.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="GEOM-striping.html">Terug</a> </td><td width="20%" align="center"><a accesskey="u" href="GEOM.html">Omhoog</a></td><td width="40%" align="right"> <a accesskey="n" href="GEOM-raid3.html">Volgende</a></td></tr><tr><td width="40%" align="left" valign="top">20.3. RAID0 - aaneengeschakeld </td><td width="20%" align="center"><a accesskey="h" href="index.html">Begin</a></td><td width="40%" align="right" valign="top"> 20.5. <acronym class="acronym">RAID</acronym>3 - Striping op byte-niveau met toegewijde
      pariteit</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>