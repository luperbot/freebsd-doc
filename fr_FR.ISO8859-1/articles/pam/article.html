<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>Pluggable Authentication Modules</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><meta name="description" content="Cet article décrit les principes sous-jacent et les mécanismes de la bibliothèque PAM, il explique comment configurer PAM, l'intégrer dans les applications, et écrire ses propres modules PAM. Version française de Clément Mathieu cykl@mAdchAt.org." /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div xml:lang="fr" class="article" lang="fr"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61388880"></a>Pluggable Authentication Modules</h1></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Dag-Erling</span> <span class="surname">Smørgrav</span></h3><span class="contrib">Contributed by </span> </div></div></div><div>Version: <a href="https://svnweb.freebsd.org/changeset/doc/"><span class="svnref"></span></a></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">Copyright © 2001-2003 Networks Associates Technology, Inc.</p></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="pam-legalnotice"></a><p>Cet  article  a  été  écrit  pour le  Projet  FreeBSD  par
      ThinkSec  AS et  les laboratoires  de Networks  Associates,  la
      division de  recherche en  sécurité de Networks  Associates, Inc.
      sous      le      contrat     DARPA/SPAWAR      N66001-01-C-8035
      (<span class="quote">« <span class="quote">CBOSS</span> »</span>),  en  tant  que  partie du  programme  de
      recherche DARPA CHATS.</p></div></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="abstract"><div class="abstract-title">Résumé</div><p>Cet  article  décrit  les  principes sous-jacent  et  les
      mécanismes  de   la  bibliothèque  PAM,   il  explique  comment
      configurer PAM,  l'intégrer dans  les applications, et
      écrire ses propres modules PAM.</p><p><span class="emphasis"><em>Version française de Clément Mathieu
  <code class="email">&lt;<a xmlns="" class="email" href="mailto:cykl@mAdchAt.org">cykl@mAdchAt.org</a>&gt;</code>.</em></span></p></div></div></div><hr /></div><div class="toc"><div class="toc-title">Table des matières</div><dl class="toc"><dt><span class="section"><a href="#pam-intro">1. Introduction</a></span></dt><dt><span class="section"><a href="#pam-terms">2. Termes et conventions</a></span></dt><dt><span class="section"><a href="#pam-essentials">3. Les bases de PAM</a></span></dt><dt><span class="section"><a href="#pam-config">4. Configuration de PAM</a></span></dt><dt><span class="section"><a href="#pam-freebsd-modules">5. Les modules PAM de FreeBSD</a></span></dt><dt><span class="section"><a href="#pam-appl-prog">6. Programmation d'applications PAM </a></span></dt><dt><span class="section"><a href="#pam-module-prog">7. Programmation de modules PAM</a></span></dt><dt><span class="appendix"><a href="#pam-sample-appl">A. Exemples d'application PAM </a></span></dt><dt><span class="appendix"><a href="#pam-sample-module">B. Exemple d'un module PAM</a></span></dt><dt><span class="appendix"><a href="#pam-sample-conv">C. Exemple d'une fonction de conversation PAM</a></span></dt><dt><span class="bibliography"><a href="#pam-further">Lectures complémentaires</a></span></dt></dl></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="pam-intro"></a>1. Introduction</h2></div></div></div><p>La  bibliothèque  PAM  est  une  API  généralisée  pour  les
	 services   relevant  de   l'authentification  permettant   à  un
	 administrateur    système   d'ajouter    une    nouvelle   méthode
	 d'authentification en  ajoutant simplement un  nouveau module PAM,
	 ainsi que de  modifier  les  règles d'authentification  en  éditant  les
	 fichiers de configuration.</p><p>PAM  a été conçu  et développé  en 1995  par Vipin  Samar et
	 Charlie  Lai  de Sun  Microsystems,  et  n'a  pas beaucoup  évolué
	 depuis. En  1997 l'Open Group publie  les premières spécifications
	 XSSO  qui standardisent  l'API  PAM et  ajoute  des extensions  pour
	 un simple (ou plutot intégré) "sign-on".  Lors  de l'écriture de  cet article, la  spécification n'a
	 toujours pas été adoptée comme standard.</p><p>Bien  que  cet  article  se  concentre  principalement  sur
	 FreeBSD  5.x,  qui  utilise  OpenPAM, il  devrait  également  être
	 applicable  à FreeBSD 4.x  qui utilise  Linux-PAM, ainsi qu'à d'autres
	 systèmes d'exploitations tels que Linux ou Solaris.</p><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-trademarks"></a>1.1. Marques déposées</h3></div></div></div><p>Sun, Sun Microsystems, SunOS and Solaris are trademarks or
	registered trademarks of Sun Microsystems, Inc.</p><p>UNIX and The Open Group are trademarks or registered
	trademarks of The Open Group.</p><p>All other brand or product names mentioned in this
	document may be trademarks or registered trademarks of their
	respective owners.</p></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="pam-terms"></a>2. Termes et conventions</h2></div></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-definitions"></a>2.1. Définitions</h3></div></div></div><p>La  terminologie   de  PAM  est  plutôt   confuse.  Ni  la
		publication originale  de Samar et Lai, ni  la spécification XSSO
		n'ont essayé de définir formellement des termes pour les acteurs
		et  les  entités intervenant  dans  PAM, les termes  qu'ils
		utilisent (mais  ne définissent  pas) sont parfois  trompeurs et
		ambigus.   Le   premier   essai  d'établir   une   terminologie
		consistante  et  non ambiguë  fut  un  papier  écrit par  Andrew
		G. Morgan (l'auteur de Linux-PAM) en 1999. Bien que les choix de
		Morgan furent  un énorme  pas en avant,  ils ne sont  pas parfait
		d'après  l'auteur de  ce  document.  Ce qui  suit,
		largement  inspiré par  Morgan, est un  essai de  définir précisément  et sans
		ambiguïté des termes pour  chaque acteur ou entité utilisé dans
		PAM.</p><div class="glosslist"><dl><dt><span class="glossterm">compte</span></dt><dd class="glossdef"><p>L'ensemble  de  permissions  que  le demandeur  demande  a
	 	l'arbitre.</p></dd><dt><span class="glossterm">demandeur</span></dt><dd class="glossdef"><p>L'utilisateur         ou        l'entité        demandant
	    authentification.</p></dd><dt><span class="glossterm">arbitre</span></dt><dd class="glossdef"><p>L'utilisateur ou l'entité possédant les privilèges nécessaires
	    pour   vérifier  la  requête   du  demandeur   ainsi que  l'autorité
	    d'accorder ou de rejeter la requête.</p></dd><dt><span class="glossterm">chaîne</span></dt><dd class="glossdef"><p>Une séquence de modules qui sera invoquée pour répondre à
	    une requête  PAM. La chaîne comprend  les informations concernant
	    l'ordre dans lequel invoquer  les modules, les arguments à leur
	    passer et la façon d'interpréter les résultats.</p></dd><dt><span class="glossterm">client</span></dt><dd class="glossdef"><p>L'application      responsable     de      la     requête
	    d'authentification   au   nom   du   demandeur   et   de recueillir
	    l'information d'authentification nécessaire.</p></dd><dt><span class="glossterm">mécanisme</span></dt><dd class="glossdef"><p>Il  s'agit  de  l'un  des  quatre  groupes  basiques  de
	    fonctionnalités  fournit par PAM  : authentification,  gestion de
	    compte,   gestion   de   session   et   mise à jour   du   jeton
	    d'authentification.</p></dd><dt><span class="glossterm">module</span></dt><dd class="glossdef"><p>Une collection d'une ou plusieurs fonctions implémentant
	    un  service  d'authentification  particulier,  rassemblées  dans  un
	    fichier binaire (normalement chargeable dynamiquement)
	    et identifié par un nom unique.</p></dd><dt><span class="glossterm">règles</span></dt><dd class="glossdef"><p>Le  jeu  complet  de  configuration  des règles  décrivant
	    comment   traiter   les    requêtes   PAM   pour   un   service
	    particulier. Une règle consiste normalement en quatre chaînes,
	    une   pour  chaque   mécanisme,  bien   que   quelques  services
	    n'utilisent pas les quatre mécanismes.</p></dd><dt><span class="glossterm">serveur</span></dt><dd class="glossdef"><p>L'application agissant au nom de l'arbitre pour converser
	    avec le client,  récupérer les informations d'authentification,
	    vérifier les droits du demandeur et autoriser ou rejeter
	    la requête.</p></dd><dt><span class="glossterm">service</span></dt><dd class="glossdef"><p>Un  ensemble de  serveurs  fournissant des  fonctionnalités
	    similaires  ou   liées  et  nécessitant   une  authentification
	    similaire. Les règles  de PAM sont définies sur  un le principe
	    de par-service;  ainsi tous les serveurs qui  demandent le même
	    nom de service seront soumis aux mêmes règles.</p></dd><dt><span class="glossterm">session</span></dt><dd class="glossdef"><p>Le  contexte  dans  lequel  le  service  est  délivré  au
	    demandeur par le serveur. L'un  des quatre mécanismes de PAM, la
	    gestion  de   session,  s'en occupe   exclusivement  par  la
	    mise en place  et le relâchement  de ce contexte.</p></dd><dt><span class="glossterm">jeton</span></dt><dd class="glossdef"><p>Un morceau d'information associé avec un compte tel qu'un
	    mot de passe  ou une passphrase que le  demandeur doit fournir
	    pour prouver son identité.</p></dd><dt><span class="glossterm">transaction</span></dt><dd class="glossdef"><p>Une séquence de requêtes depuis le même demandeur vers la
	    même    instance    du    même   serveur,    commençant    avec
	    l'authentification  et la  mise en  place de  la session  et se
	    terminant avec le démontage de la session.</p></dd></dl></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-usage-examples"></a>2.2.  Exemples d'utilisation</h3></div></div></div><p>Cette section  a pour but d'illustrer
      quelques-uns des termes  définis précédemment  à l'aide
      d'exemples basiques.</p><div class="section"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61852880"></a>2.2.1. Client et serveurs ne font qu'un</h4></div></div></div><p>Cet exemple  simple montre <code class="literal">alice</code> utilisant
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=su&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">su</span>(1)</span></a> pour devenir <code class="literal">root</code>.</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>whoami</code></strong>
alice
<code class="prompt">%</code> <strong class="userinput"><code>ls -l `which su`</code></strong>
-r-sr-xr-x  1 root  wheel  10744 Dec  6 19:06 /usr/bin/su
<code class="prompt">%</code> <strong class="userinput"><code>su -</code></strong>
Password: <strong class="userinput"><code>xi3kiune</code></strong>
<code class="prompt">#</code> whoami
root
</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Le demandeur est <code class="literal">alice</code>.</p></li><li class="listitem"><p>Le compte est <code class="literal">root</code>.</p></li><li class="listitem"><p>Le processus  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=su&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">su</span>(1)</span></a> est à la fois client et serveur.</p></li><li class="listitem"><p>Le jeton d'authentification est
	    <code class="literal">xi3kiune</code>.</p></li><li class="listitem"><p>L'arbitre  est <code class="literal">root</code>,  ce  qui explique
		   pourquoi            <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=su&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">su</span>(1)</span></a>           est           setuid
		   <code class="literal">root</code>.</p></li></ul></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61905872"></a>2.2.2. Client et serveur sont distincts.</h4></div></div></div><p>L'exemple  suivant   montre  <code class="literal">eve</code>  essayant
	d'initier        une       connexion        <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a>       vers
	<code class="literal">login.exemple.com</code>, en demandant  à se logguer en
	tant que <code class="literal">bob</code>. La connexion réussit. Bob aurait du choisir
	un meilleur mot de passe !</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>whoami</code></strong>
eve
<code class="prompt">%</code> <strong class="userinput"><code>ssh bob@login.example.com</code></strong>
bob@login.example.com's password: <strong class="userinput"><code>god</code></strong>
Last login: Thu Oct 11 09:52:57 2001 from 192.168.0.1
Copyright (c) 1980, 1983, 1986, 1988, 1990, 1991, 1993, 1994
	The Regents of the University of California.  All rights reserved.
FreeBSD 4.4-STABLE (LOGIN) #4: Tue Nov 27 18:10:34 PST 2001

Welcome to FreeBSD!
<code class="prompt">%</code></pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Le demandeur est  <code class="literal">eve</code>.</p></li><li class="listitem"><p>Le client d'<code class="literal">eve</code> est représenté par les processus <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a> </p></li><li class="listitem"><p>Le serveur est le processus <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a> sur
	      <code class="literal">login.example.com</code></p></li><li class="listitem"><p>Le compte est <code class="literal">bob</code>.</p></li><li class="listitem"><p>Le jeton d'identification est
	    <code class="literal">god</code>.</p></li><li class="listitem"><p>Bien  que  cela ne  soit  pas  montré  dans cet  exemple,
	     l'arbitre est <code class="literal">root</code>.</p></li></ul></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61948752"></a>2.2.3. Exemple de règles</h4></div></div></div><p>Les  lignes  qui  suivent  sont  les  règles  par  défaut  de
	  <code class="literal">sshd</code>:</p><pre class="programlisting">
sshd	auth		required	pam_nologin.so	no_warn
sshd	auth		required	pam_unix.so	no_warn try_first_pass
sshd	account		required	pam_login_access.so
sshd	account		required	pam_unix.so
sshd	session		required	pam_lastlog.so	no_fail
sshd	password	required	pam_permit.so</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Cette      politique      s'applique      au      service
	  	 <code class="literal">sshd</code> (qui n'est pas nécessairement restreint
	  	 au serveur <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a>)</p></li><li class="listitem"><p><code class="literal">auth</code>, <code class="literal">account</code>,
	      <code class="literal">session</code> et
	      <code class="literal">password</code> sont des mécanismes.</p></li><li class="listitem"><p><code class="filename">pam_nologin.so</code>,
	      <code class="filename">pam_unix.so</code>,
	      <code class="filename">pam_login_access.so</code>,
	      <code class="filename">pam_lastlog.so</code>                         et
	      <code class="filename">pam_permit.so</code> sont  des modules.  Il est
	      clair  dans cet exemple  que <code class="filename">pam_unix.so</code>
	      fournit  au  moins  deux  mécanismes (  authentification  et
	      gestion de compte).</p></li></ul></div></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-conventions"></a>2.3. Conventions</h3></div></div></div><p>Cette section n'a pas encore été écrite.</p></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="pam-essentials"></a>3. Les bases de PAM</h2></div></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-facilities-primitives"></a>3.1. Mécanismes et primitives</h3></div></div></div><p>L'API   PAM  fournit  six   primitives  d'authentification
		différentes  regroupées dans quatre  mécanismes qui  seront décrits
		dans la partie suivante.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">auth</code></span></dt><dd><p><span class="emphasis"><em>Authentification.</em></span>    Ce   mécanisme
	      concerne  l'authentification  du  demandeur  et  établit  les
	      droits du compte. Il fournit deux primitives :</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_authenticate&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_authenticate</span>(3)</span></a>    authentifie    le   demandeur,
		généralement  en demandant  un jeton  d'identification et  en le
		comparant  a une  valeur stockée  dans une  base de  données ou
		obtenue par le biais d'un serveur d'authentification.</p></li><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_setcred&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_setcred</span>(3)</span></a>  établi les  paramètres du  compte tel
		que l'uid, les groupes dont  le compte fait parti ou les limites
		sur l'utilisation des ressources.</p></li></ul></div></dd><dt><span class="term"><code class="literal">account</code></span></dt><dd><p><span class="emphasis"><em>Gestion  de  compte.</em></span>  Ce  mécanisme
	    concerne la  disponibilité du  compte pour des raisons autres que
	    l'authentification.  Par exemple  les  restrictions basées  sur
	    l'heure courante ou la charge  du serveur. Il fournit une seule
	    primitive:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_acct_mgmt</span>(3)</span></a>  vérifie que  le compte  demandé est
		disponible.</p></li></ul></div></dd><dt><span class="term"><code class="literal">session</code></span></dt><dd><p><span class="emphasis"><em>Gestion  de  session.</em></span> Ce  mécanisme
	    concerne la mise en place de la session  et sa terminaison, par
	    exemple l'enregistrement  de la  session dans les  journaux. Il
	    fournit deux primitives:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_open_session&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_open_session</span>(3)</span></a> accomplie  les tâches associées à
		la mise  en place  d'une session :  ajouter une entrée  dans les
		bases  <code class="filename">utmp</code>  et  <code class="filename">wtmp</code>,
		démarrer un agent SSH...</p></li><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_close_session&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_close_session</span>(3)</span></a> accomplie les tâches associées à
		la terminaison d'une session : ajouter une entrée dans les bases
		<code class="filename">utmp</code>  et <code class="filename">wtmp</code>, arrêter
		l'agent SSH...</p></li></ul></div></dd><dt><span class="term"><code class="literal">password</code></span></dt><dd><p><span class="emphasis"><em>Gestion   des  mots  de   passe.</em></span>  Ce
	 mécanisme est  utilisé pour modifier  le jeton d'authentification
	 associé à un  compte, soit parce qu'il a expiré,  soit parce que
	 l'utilisateur   désire   le   changer.   Il  fournit   une   seule
	 primitive:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_chauthtok&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_chauthtok</span>(3)</span></a> modifie le jeton d'authentification,
		et éventuellement vérifie que celui-ci est assez robuste pour ne
		pas  être  deviné  facilement  ou  qu'il  n'a  pas  déjà utilisé.
		</p></li></ul></div></dd></dl></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules"></a>3.2. Modules</h3></div></div></div><p>Les modules  sont le concept  clef de PAM; après  tout ils
      constituent  le  <span class="quote">« <span class="quote">M</span> »</span>  de  PAM. Un  module  PAM  est
      lui-même un  morceau de code qui implémente  les primitives d'un
      ou   plusieurs   mécanismes    pour   une   forme   particulière
      d'authentification; par  exemple, les bases de mots  de passe UNIX
      que sont NIS, LDAP et Radius.</p><div class="section"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-module-naming"></a>3.2.1. Nom des modules</h4></div></div></div><p>FreeBSD implémente chaque  mécanismes dans un module distinct
	  nommé
	  <code class="literal">pam_mécanisme.so</code>
	  (par  exemple  <code class="literal">pam_unix.so</code>  pour le  mécanisme
	  Unix  .)   Les autres  implementations  possèdent  parfois des  modules
	  séparés pour  des mécanismes séparés et incluent aussi  bien le
	  nom du service  que celui du mécanisme dans le  nom du module. Un
	  exemple  est le  module  <code class="literal">pam_dial_auth.so.1</code> de
	  Solaris  qui  est  utilisé  pour  authentifier  les  utilisateurs
	  dialup.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-module-versioning"></a>3.2.2. Gestion des versions de module </h4></div></div></div><p>L'implémentation  originale  de PAM  par  FreeBSD, basée  sur
	Linux-PAM, n'utilisait  pas de numéro  de version pour  les modules
	PAM. Ceci peut poser des  problèmes avec les applications tiers qui
	peuvent être liées avec  d'anciennes bibliothèques systèmes, puisqu'il
	n'y  a pas  possibilité  de charger  la  version correspondante  du
	module désiré.</p><p>Pour  sa part,  OpenPAM cherche  les  modules qui  ont la  même
	version que la bibliothèque PAM (pour le moment 2) et se rabat sur
	un module  sans version si aucun  module avec version  n'a put être
	chargé.  Ainsi les anciens  modules peuvent  être fournis  pour les
	anciennes  applications,   tout  en  permettant   aux  nouvelles applications
	(ou  bien nouvellement  compilées)  de  tirer parti  des
	modules les plus récents.</p><p>Bien que les modules PAM de Solaris possèdent généralement un
	numéro de version, ils ne sont pas réellement versionnés car
	le numéro  correspond à une  partie du nom  du module et  doit être
	inclus dans la configuration.</p></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-chains-policies"></a>3.3. Chaînes et politiques</h3></div></div></div><p>Lorsqu'un   serveur  initie   une   transaction  PAM,   la
      bibliothèque PAM essaie de  charger une politique pour le service
      spécifié  dans  l'appel  a  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_start&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_start</span>(3)</span></a>  .   La  politique
      indique comment la requête d'authentification doit être traitée
      et est définie dans un  fichier de configuration. Il  s'agit de
      l'autre   concept    clef   de   PAM :    la   possibilité   pour
      l'administrateur  de  configurer  la  politique de  sécurité  d'un
      système en éditant simplement une fichier texte.</p><p>Une politique consiste en quatre chaînes, une pour chacune
      des  quatre mécanismes  de PAM. Chaque  chaîne est  une  suite de
      règles  de  configuration,  chacune  spécifiant un  module  à
      invoquer, des paramètres, options,  à passer au module et un
      drapeau de  contrôle qui décrit  comment interpréter le  code de
      retour du module.</p><p>Comprendre  le  drapeau  de  contrôle est  essentiel  pour
      comprendre  les  fichiers de  configuration  de  PAM. Il  existe
      quatre drapeaux de contrôle différents :</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">binding</code></span></dt><dd><p>Si le  module réussit et qu'aucun module  précédent de la
	    chaîne n'a  échoué, la chaîne s'interrompt  immédiatement et la
	    requête  est autorisée.  Si le  module échoue  le reste  de la
	    chaîne   est  exécuté,   mais   la  requête   est  rejetée   au
	    final.</p><p>Ce drapeau  de contrôle a  été introduit par  Sun Solaris
	    dans la  version 9  (SunOS 5.9);  il est aussi  supporté par
	    OpenPAM.</p></dd><dt><span class="term"><code class="literal">required</code></span></dt><dd><p>Si le module réussit, le  reste de la chaîne est exécuté,
	    et  la  requête est  autorisée  si  aucun  des autres  modules
	    n'échoue.  Si le  module  échoue,  le reste  de  la chaîne  est
	    exécuté, mais au final la requête est rejetée.</p></dd><dt><span class="term"><code class="literal">requisite</code></span></dt><dd><p>Si le module  réussit le reste de la  chaîne est exécuté,
	    et  la   requête  est   autorisée  sauf  si   d'autres  modules
	    échoués.  Si  le  module  échoue la  chaîne  est  immédiatement
	    terminée et la requête est rejetée.</p></dd><dt><span class="term"><code class="literal">sufficient</code></span></dt><dd><p>Si le  module réussit  et qu'aucun des  modules précédent
	    n'a échoué  la chaîne est immédiatement terminée  et la requête
	    est allouée. Si  le module échoue il est ignore  et le reste de
	    la chaîne est exécuté.</p><p>Puisque  la sémantique  de  ce drapeau  peut  être un  peu
	    confuse,  spécialement  lorsqu'il s'agit  de  celui du  dernier
	    module de  la chaîne, il  est recommandé d'utiliser  le drapeau
	    <code class="literal">binding</code>   à   la   place  de   celui-ci   sous la condition que
	    l'implémentation le supporte.</p></dd><dt><span class="term"><code class="literal">optional</code></span></dt><dd><p>Le  module est exécuté  mais le  résultat est  ignoré. Si
	    tout    les    modules    de    la    chaîne    sont    marqués
	    <code class="literal">optional</code>,   toutes   les   requêtes   seront
	    toujours acceptées.</p></dd></dl></div><p>Lorsqu'un  serveur invoque l'une  des six  primitives PAM,
       PAM  récupère  la chaîne  du  mécanisme  à  laquelle la  requête
      correspond et  invoque chaque module de la  chaîne dans l'ordre
      indiqué,  jusqu'à  ce que  la  fin  soit  atteinte ou  qu'aucune
      exécution  supplémentaire ne  soit nécessaire  (soit à  cause du
      succès    d'un   module    en    <code class="literal">binding</code>   ou
      <code class="literal">sufficient</code>,  soit  à  cause de  l'échec  d'un
      module <code class="literal">requisite</code>). La requête est acceptée si
      et seulement  si au moins un  module a été invoqué,  et que tout
      les modules non optionnels ont réussi.</p><p>Notez qu'il est possible, bien que peu courant, d'avoir le
      même  module  listé plusieurs  fois  dans  la  même chaîne.  Par
      exemple un module qui détermine  le nom utilisateur et le mot de
      passe  à  l'aide  d'un   serveur  directory  peut  être  invoqué
      plusieurs  fois   avec  des  paramètres   spécifiant  différents
      serveurs a contacter.  PAM considère les différentes occurrences
      d'un  même  module  dans  une  même  chaîne  comme  des  modules
      différents et non liés.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-transactions"></a>3.4. Transactions</h3></div></div></div><p>Le cycle  de vie d'une transaction PAM  typique est décrit
      ci-dessous. Notez que si l'une  de ces étapes échoue, le serveur
      devrait  reporter un message  d'erreur au  client et  arrêter la
      transaction.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Si  nécessaire,  le   serveur  obtient  les  privilèges  de
	  l'arbitre par le biais d'un mécanisme indépendant de PAM &#8212;
	  généralement en ayant  été démarré par <code class="literal">root</code> ou
	  en étant setuid <code class="literal">root</code>.</p></li><li class="listitem"><p>Le  serveur appel  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_start&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_start</span>(3)</span></a> afin  d'initialiser la
	  bibliothèque PAM  et indique  le service et  le compte  cible, et
	  enregistre une fonction de conversation appropriée.</p></li><li class="listitem"><p>Le  serveur  obtient  diverses informations  concernant  la
	  transaction (tel que le nom  d'utilisateur du demandeur et le nom
	  d'hôte de la machine sur  lequel le client tourne) et les soumet
	  à PAM en utilisant la fonction <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_set_item&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_set_item</span>(3)</span></a>.</p></li><li class="listitem"><p>Le serveur appel  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_authenticate&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_authenticate</span>(3)</span></a> pour authentifier le demandeur.</p></li><li class="listitem"><p>Le  serveur  appel  la fonction  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_acct_mgmt</span>(3)</span></a>  qui
	  vérifie  que le compte  est valide  et disponible.  Si le  mot de
	  passe est correct mais a expiré, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_acct_mgmt</span>(3)</span></a> retournera
	  <code class="literal">PAM_NEW_AUTHTOK_REQD</code>    à    la    place    de
	  <code class="literal">PAM_SUCCESS</code>.</p></li><li class="listitem"><p>Si        l'étape        précédente       a        retourné
	  <code class="literal">PAM_NEW_AUTHTOK_REQD</code>,    le    serveur   appel
	  maintenant  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_chauthtok&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_chauthtok</span>(3)</span></a>  pour  obliger l'utilisateur  à
	  changer le jeton d'authentification du compte désiré.</p></li><li class="listitem"><p>Maintenant que le demandeur a été correctement authentifié,
	  le serveur appelle  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_setcred&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_setcred</span>(3)</span></a> pour obtenir les privilèges
	  du compte désiré. Il lui est  possible de faire ceci parce qu'il
	  agit au nom de l'arbitre dont il possède les privilèges.</p></li><li class="listitem"><p>Lorsque les privilèges corrects  ont été établi le serveur
	  appelle   <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_open_session&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_open_session</span>(3)</span></a>   pour   mettre  en   place   la
	  session.</p></li><li class="listitem"><p>Maintenant le serveur effectue les services demandés par le
	  client &#8212; par exemple fournir un shell au demandeur.</p></li><li class="listitem"><p>Lorsque le  serveur a  fini de servir  le client,  il appelle
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_close_session&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_close_session</span>(3)</span></a> afin de  terminer la session.</p></li><li class="listitem"><p>Pour finir, le  serveur appelle <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_end&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_end</span>(3)</span></a> afin signaler
	  à la bibliothèque  PAM que la transaction se termine et qu'elle peut libérer
	  les   ressources    qu'elle   a    alloué   au   cours    de   la
	  transaction.</p></li></ol></div></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="pam-config"></a>4. Configuration de PAM</h2></div></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-config-file-locations"></a>4.1. Emplacement des fichiers de configuration</h3></div></div></div><p>Le fichier de  configuration de PAM est traditionnellement
      <code class="filename">/etc/pam.conf</code>.  Ce fichier  contient toutes
      les  politiques  de PAM  pour  votre  système.  Chaque ligne  du
      fichier décrit une étape dans une chaîne, tel que nous allons le
      voir ci-dessous:</p><pre class="programlisting">login   auth    required        pam_nologin.so  no_warn</pre><p>Les champs  sont respectivement, le service, le nom  du mécanisme, le
      drapeau  de contrôle,  le nom  du  module et  les arguments  du
      module. Tout  champ additionnel est considéré  comme argument du
      module.</p><p>Une   chaîne  différente   est   construite  pour   chaque couple
      service/mécanisme;  ainsi,  alors  que  l'ordre  des  lignes  est
      important  lorsqu'il s'agit  des mêmes  services  ou mécanismes,
      l'ordre  dans  lequel  les  différents  services  et  mécanismes
      apparaissent  ne  l'est pas  &#8212;  excepté  l'entrée pour  le
      service  <code class="literal">other</code>, qui  sert de  référence par défaut  et doit
      être  placé à  la  fin.  L'exemple du  papier  original sur  PAM
      regroupait  les lignes  de configurations  par mécanisme  et le
      fichier   <code class="filename">pam.conf</code>  de   Solaris   le  fait
      toujours, mais  FreeBSD groupe  les lignes de  configuration par
      service. Toutefois il ne s'agit pas de la seule possibilité et les autres possèdent
      aussi un sens.</p><p>OpenPAM et Linux-PAM offrent un mécanisme de configuration
      alternatif  où les  politiques  sont placées  dans des  fichiers
      séparés portant  le nom du service auquel  ils s'appliquent. Ces
      fichiers  sont situés dans  <code class="filename">/etc/pam.d/</code> et
      ne contiennent que  quatre champs à la place  de cinq &#8212; le
      champ contenant  le nom du service  est omis. Il  s'agit du mode
      par  défaut   dans  FreeBSD  4.x.   Notez  que  si   le  fichier
      <code class="filename">/etc/pam.conf</code>   existe   et  contient   des
      informations de configuration pour des services qui n'ont pas de
      politique  spécifiée  dans <code class="filename">/etc/pam.d</code>,  ils
      seront utilisés pour ces services.</p><p>Le  gros avantage de  <code class="filename">/etc/pam.d/</code> sur
      <code class="filename">/etc/pam.conf</code>   est   qu'il  est   possible
      d'utiliser  la même  politique pour  plusieurs services  en liant
      chaque  nom  de service  à  un  fichier  de configuration.  Par
      exemple  pour  utiliser  la  même politique  pour  les  services
      <code class="literal">su</code>  et <code class="literal">sudo</code>,  nous pouvons
      faire comme ceci :</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /etc/pam.d</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>ln -s su sudo</code></strong></pre><p>Ceci  fonctionne car  le nom  de service  est  déterminé a
      partir  du nom  de fichier  plutôt qu'indiqué  à  l'intérieur du
      fichier de configuration, ainsi le même fichier peut être utilisé
      pour des services nommés différemment.</p><p>Un autre avantage est  qu'un logiciel tiers peu facilement
      installer  les politiques  pour ses  services sans  avoir besoin
      d'éditer  <code class="filename">/etc/pam.conf</code>. Pour  continuer la
      tradition     de     FreeBSD,     OpenPAM     regardera     dans
      <code class="filename">/usr/local/etc/pam.d</code>   pour   trouver   les
      fichiers  de  configurations; puis si  aucun n'est  trouvé  pour  le
      service   demandé,   il cherchera dans   <code class="filename">/etc/pam.d/</code>   ou
      <code class="filename">/etc/pam.conf</code>.</p><p>Finalement,   quelque   soit   le   mécanisme   que   vous
      choisissiez,       la      politique      <span class="quote">« <span class="quote">magique</span> »</span>
      <code class="literal">other</code> est  utilisée par défaut  pour tous les
      services qui n'ont pas leur propre politique.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-config-breakdown"></a>4.2. Breakdown of a
	configuration line</h3></div></div></div><p>Comme      expliqué     dans     <a class="xref" href="#pam-config-file-locations" title="4.1. Emplacement des fichiers de configuration">Section 4.1, « Emplacement des fichiers de configuration »</a>, chaque ligne de
	<code class="filename">pam.conf</code> consiste en quatre champs ou plus: le
	nom de service, le nom du mécanisme, le drapeau de contrôle, le nom
	du module et la présence ou non d'arguments pour le module.</p><p>Le nom du service  est généralement, mais pas toujours, le
      nom  de  l'application auquelle  les  règles  s'appliquent. Si  vous
      n'êtes pas sûr, référez vous à la documentation de l'application
      pour déterminer quel nom de service elle utilise.</p><p>Notez         que         si         vous         utilisez
      <code class="filename">/etc/pam.d/</code>      à     la      place     de
      <code class="filename">/etc/pam.conf</code>,   le  nom  du   service  est
      spécifié par  le nom du  fichier de configuration et  n'est pas
      indiqué  dans   les  lignes  de  configuration   qui,  dès  lors,
      commencent par le nom du mécanisme.</p><p>Le mécanisme est  l'un des quatre mots clef  décrit dans
      <a class="xref" href="#pam-facilities-primitives" title="3.1. Mécanismes et primitives">Section 3.1, « Mécanismes et primitives »</a>.</p><p>De même, le  drapeau de contrôle est l'un  des quatre mots
      clef décrits dans <a class="xref" href="#pam-chains-policies" title="3.3. Chaînes et politiques">Section 3.3, « Chaînes et politiques »</a> et  décrit comment
      le   module   doit   interpréter    le   code   de   retour   du
      module.  Linux-PAM  supporte une  syntaxe  alternative qui  vous
      laisse  spécifier l'action à  associer à  chaque code  de retour
      possible;  mais ceci  devrait être  évité puisque  ce  n'est pas
      standard et étroitement lié à la façon dont Linux-PAM appelle les
      services  (qui diffère  grandement  de la  façon  de Solaris  et
      OpenPAM). C'est  sans étonnement que l'on  apprend qu'OpenPAM ne
      supporte pas cette syntaxe.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-policies"></a>4.3. Politiques</h3></div></div></div><p>Pour  configurer  PAM correctement,  il  est essentiel  de
      comprendre comment les politiques sont interprétées.</p><p>Lorsqu'une   application   appelle  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_start&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_start</span>(3)</span></a>   la
      bibliothèque  PAM charge  la  politique du  service spécifié  et
      construit  les  quatre  chaînes   de  module  (une  pour  chaque
      mécanisme). Si  une ou plusieurs chaînes sont  vides, les chaînes
      de  la   politique  du  service   <code class="literal">other</code>  sont
      utilisées.</p><p>Plus  tard,  lorsque  l'application  appelle  l'une  des  six
      primitives  PAM,  la  bibliothèque  PAM récupère  la  chaîne  du
      mécanisme  correspondant et  appelle la  fonction  appropriée avec
      chaque  module listé dans  la chaîne.  Après chaque  appel d'une
      fonction  de service,  le type  du  module et  le code  d'erreur
      sont retournés par  celle-ci pour  déterminer quoi faire.  À quelques
      exceptions  près,  dont  nous  parlerons  plus  tard,  la  table
      suivante s'applique:</p><div class="table"><a id="idp62304848"></a><div class="table-title">Tableau 1. Résumé de la chaîne d'exécution PAM </div><div class="table-contents"><table summary="Résumé de la chaîne d'exécution PAM " border="1"><colgroup><col class="type" /><col class="success" /><col class="ignore" /><col class="other" /></colgroup><thead><tr><th> </th><th><code class="literal">PAM_SUCCESS</code></th><th><code class="literal">PAM_IGNORE</code></th><th><code class="literal">other</code></th></tr></thead><tbody><tr><td>binding</td><td>if (!fail) break;</td><td>-</td><td>fail = true;</td></tr><tr><td>required</td><td>-</td><td>-</td><td>fail = true;</td></tr><tr><td>requisite</td><td>-</td><td>-</td><td>fail = true; break;</td></tr><tr><td>sufficient</td><td>if (!fail) break;</td><td>-</td><td>-</td></tr><tr><td>optional</td><td>-</td><td>-</td><td>-</td></tr></tbody></table></div></div><br class="table-break" /><p>Si <code class="varname">fail</code> est vrai à la fin de la chaîne,
      ou  lorsqu'un <span class="quote">« <span class="quote">break</span> »</span>  est atteint,  le dispatcheur
      retourne le  code d'erreur renvoyé  par le premier module  qui a
      échoué.     Autrement     <code class="literal">PAM_SUCCESS</code>     est
      retourné.</p><p>La   première   exception  est   que   le  code   d'erreur
      <code class="literal">PAM_NEW_AUTHOK_REQD</code>  soit considéré  comme un
      succès, sauf si  aucun module n'échoue et qu'au  moins un module
      retourne  <code class="literal">PAM_NEW_AUTHOK_REQD</code>  le dispatcheur
      retournera <code class="literal">PAM_NEW_AUTHOK_REQD</code>.</p><p>La seconde exception  est que <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_setcred&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_setcred</span>(3)</span></a> considère
     les         modules         <code class="literal">binding</code>         et
     <code class="literal">sufficient</code>       comme      s'ils      étaient
     <code class="literal">required</code>.</p><p>La    troisième   et    dernière    exception   est    que
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_chauthtok&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_chauthtok</span>(3)</span></a> exécute la totalité de la chaîne deux fois
      (la première pour des vérifications préliminaires et la deuxième
      pour mettre le  mot de passe) et lors  de la première exécution
      il    considère   les   modules    <code class="literal">binding</code>   et
      <code class="literal">sufficient</code>      comme      s'ils      étaient
      <code class="literal">required</code>.</p></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="pam-freebsd-modules"></a>5. Les modules PAM de FreeBSD</h2></div></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-deny"></a>5.1. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_deny&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_deny</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_deny&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_deny</span>(8)</span></a> est l'un des modules disponibles
      les  plus simples;  il répond  à n'importe  qu'elle  requête par
      <code class="literal">PAM_AUTH_ERR</code>.  Il est  utile  pour désactiver
      rapidement un service (ajoutez-le au début de chaque chaîne), ou
      pour       terminer      les       chaînes       de      modules
      <code class="literal">sufficient</code>.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-echo"></a>5.2. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_echo&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_echo</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_echo&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_echo</span>(8)</span></a>  passe simplement ses arguments
      à    la   fonction    de   conversation    comme    un   message
      <code class="literal">PAM_TEXT_INFO</code>. Il est principalement utilisé
      pour  le debogage  mais  il  peut aussi  servir  à afficher  un
      message    tel   que    <span class="quote">« <span class="quote">Les    accès   illégaux    seront
      poursuivits</span> »</span>    avant    de    commencer   la    procédure
      d'authentification.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-exec"></a>5.3. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_exec&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_exec</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_exec&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_exec</span>(8)</span></a> prend comme premier argument le
      nom  du programme  à exécuter, les arguments  restant étant
      utilisés   comme  arguments   pour  ce   programme.   L'une  des
      applications possibles est d'utiliser un programme  qui monte le
      répertoire de l'utilisateur lors du login.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-ftp"></a>5.4. pam_ftp(8)</h3></div></div></div><p>Le module pam_ftp(8)</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-ftpusers"></a>5.5. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_ftpusers&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_ftpusers</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_ftpusers&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_ftpusers</span>(8)</span></a></p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-group"></a>5.6. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_group&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_group</span>(8)</span></a></h3></div></div></div><p>Le   module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_group&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_group</span>(8)</span></a>   accepte  ou   rejette  le
      demandeur à  partir de son appartenance à  un groupe particulier
      (généralement  <code class="literal">wheel</code> pour  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=su&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">su</span>(1)</span></a>).  Il a
      pour but  premier de  conserver le comportement  traditionnel de
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=su&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">su</span>(1)</span></a> mais possède  d'autres applications comme par exemple
      exclure   un   certain   groupe   d'utilisateurs   d'un   service
      particulier.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-krb5"></a>5.7. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_krb5&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_krb5</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_krb5&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_krb5</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-ksu"></a>5.8. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_ksu&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_ksu</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_ksu&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_ksu</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-lastlog"></a>5.9. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_lastlog&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_lastlog</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_lastlog&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_lastlog</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-login-access"></a>5.10. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_login_access&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_login_access</span>(8)</span></a></h3></div></div></div><p>Le module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_login_access&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_login_access</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-nologin"></a>5.11. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_nologin&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_nologin</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_nologin&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_nologin</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-opie"></a>5.12. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_opie&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_opie</span>(8)</span></a></h3></div></div></div><p>Le   module   <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_opie&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_opie</span>(8)</span></a>   implémente   la   méthode
      d'authentification <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=opie&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">opie</span>(4)</span></a>. Le  système <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=opie&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">opie</span>(4)</span></a> est un
      mécanisme  de challenge-response où  la réponse  à chaque
      challenge est une fonction directe  du challenge et une phrase de
      passe, ainsi la réponse  peut facilement être calculée <span class="quote">« <span class="quote">en
      temps  voulu</span> »</span> par  n'importe qui  possédant la  phrase de
      passe ce qui élimine le besoin  d'une liste de mots de passe. De
      plus, puisque  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=opie&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">opie</span>(4)</span></a> ne réutilise  jamais un mot  de passe
      qui a  reçu une  réponse correcte, il  n'est pas  vulnérable aux
      attaques basée sur le rejouage.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-opieaccess"></a>5.13. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_opieaccess&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_opieaccess</span>(8)</span></a></h3></div></div></div><p>Le  module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_opieaccess&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_opieaccess</span>(8)</span></a>  est  un  compagnon  du
      module   <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_opie&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_opie</span>(8)</span></a>.  Son   but  est   de   renforcer  les
      restrictions  codifiées  dans  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=opieaccess&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">opieaccess</span>(5)</span></a>, il  régule  les
      conditions  sous  lesquelles   un  utilisateur  qui  normalement
      devrait s'authentifier  par <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=opie&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">opie</span>(4)</span></a> est  amené à utiliser
      d'autres méthodes. Ceci  est généralement utilisé pour interdire
      l'authentification par  mot de passe depuis des  hôtes non digne
      de confiance.</p><p>Pour     être    réellement     effectif,     le    module
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_opieaccess&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_opieaccess</span>(8)</span></a>      doit      être      listé      comme
      <code class="literal">requisite</code>  immédiatement   après  une  entrée
      <code class="literal">sufficient</code>  pour  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_opie&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_opie</span>(8)</span></a> et  avant
      tout       autre        module,       dans       la       chaîne
      <code class="literal">auth</code>.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-passwdqc"></a>5.14. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_passwdqc&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_passwdqc</span>(8)</span></a></h3></div></div></div><p>Le module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_passwdqc&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_passwdqc</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-permit"></a>5.15. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_permit&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_permit</span>(8)</span></a></h3></div></div></div><p>Le   module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_permit&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_permit</span>(8)</span></a>   est  l'un   des  modules
      disponibles  les  plus simples;  il  répond  à n'importe  quelle
      requête  par <code class="literal">PAM_SUCCESS</code>.  Il est  utile pour
      les  services  où   une  ou  plusieurs  chaînes  auraient
      autrement été vides.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-radius"></a>5.16. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_radius&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_radius</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_radius&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_radius</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-rhosts"></a>5.17. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_rhosts&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_rhosts</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_rhosts&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_rhosts</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-rootok"></a>5.18. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_rootok&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_rootok</span>(8)</span></a></h3></div></div></div><p>Le  module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_rootok&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_rootok</span>(8)</span></a> retourne  un  succès si  et
      seulement  si  l'identifiant  d'utilisateur  réel  du  processus
      appelant est 0. Ceci est utile pour les services non basés sur
      le  réseau  tel   que  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=su&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">su</span>(1)</span></a>  ou  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=passwd&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">passwd</span>(1)</span></a>  où
      l'utilisateur   <code class="literal">root</code>  doit  avoir   un  accès
      automatique.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-securetty"></a>5.19. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_securetty&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_securetty</span>(8)</span></a></h3></div></div></div><p>Le module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_securetty&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_securetty</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-self"></a>5.20. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_self&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_self</span>(8)</span></a></h3></div></div></div><p>Le  module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_self&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_self</span>(8)</span></a>  retourne  un  succès  si  et
      seulement si  le nom  du demandeur correspond  au nom  du compte
      désiré. Il est  utile pour les services non  basés sur le réseau
      tel que  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=su&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">su</span>(1)</span></a> où l'identité du  demandeur peut être
      vérifiée facilement .</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-ssh"></a>5.21. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_ssh&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_ssh</span>(8)</span></a></h3></div></div></div><p>Le module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_ssh&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_ssh</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-tacplus"></a>5.22. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_tacplus&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_tacplus</span>(8)</span></a></h3></div></div></div><p>Le module  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_tacplus&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_tacplus</span>(8)</span></a> </p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules-unix"></a>5.23. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_unix&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_unix</span>(8)</span></a></h3></div></div></div><p>Le  module <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_unix&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_unix</span>(8)</span></a>  implémente l'authentification
      Unix   traditionnelle    par   mot   de    passe,   il   utilise
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getpwnam&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getpwnam</span>(3)</span></a> pour obtenir le mot  de passe du compte visé et
      le compare avec celui fournit par le demandeur. Il fournit aussi
      des services  de gestion de  compte (désactivation du  compte et
      date d'expiration) ainsi que  des services pour le changement de
      mot de passe. Il s'agit certainement du module le plus utile car
      la plupart  des administrateurs désirent  garder le comportement
      historique pour quelques services.</p></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="pam-appl-prog"></a>6. Programmation d'applications PAM </h2></div></div></div><p>Cette section n'a pas encore été écrite.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="pam-module-prog"></a>7. Programmation de modules PAM</h2></div></div></div><p>Cette section n'a pas été encore écrite.</p></div><div class="appendix"><h2 class="title" style="clear: both"><a id="pam-sample-appl"></a>A. Exemples d'application PAM </h2><p>Ce qui suit est une implémentation minimale de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=su&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">su</span>(1)</span></a> en
    utilisant PAM.  Notez qu'elle utilise la  fonction de conversation
    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=openpam_ttyconv&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">openpam_ttyconv</span>(3)</span></a>  spécifique à  OpenPAM qui  est prototypée
    dans                                                      <code class="filename">security/openpam.h</code>.  Si vous désirez
    construire  cette   application  sur  un   système  utilisant  une
    bibliothèque  PAM  différente  vous  devrez fournir  votre  propre
    fonction de conversation. Une fonction de conversation robuste est
    étonnamment   difficile  à   implémenter;  celle   présentée  dans
    <a class="xref" href="#pam-sample-conv" title="C. Exemple d'une fonction de conversation PAM">Annexe C, <em>Exemple d'une fonction de conversation PAM</em></a>
    est  un  bon   point  de
    départ, mais  ne devrait pas  être utilisée dans  des applications
    réelles.</p><pre class="programlisting">
/*-
 * Copyright (c) 2002,2003 Networks Associates Technology, Inc.
 * All rights reserved.
 *
 * This software was developed for the FreeBSD Project by ThinkSec AS and
 * Network Associates Laboratories, the Security Research Division of
 * Network Associates, Inc.  under DARPA/SPAWAR contract N66001-01-C-8035
 * ("CBOSS"), as part of the DARPA CHATS research program.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote
 *    products derived from this software without specific prior written
 *    permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * $P4: //depot/projects/openpam/bin/su/su.c#10 $
 * $FreeBSD$
 */

#include &lt;sys/param.h&gt;
#include &lt;sys/wait.h&gt;

#include &lt;err.h&gt;
#include &lt;pwd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;syslog.h&gt;
#include &lt;unistd.h&gt;

#include &lt;security/pam_appl.h&gt;
#include &lt;security/openpam.h&gt;	/* for openpam_ttyconv() */

extern char **environ;

static pam_handle_t *pamh;
static struct pam_conv pamc;

static void
usage(void)
{

	fprintf(stderr, "Usage: su [login [args]]\n");
	exit(1);
}

int
main(int argc, char *argv[])
{
	char hostname[MAXHOSTNAMELEN];
	const char *user, *tty;
	char **args, **pam_envlist, **pam_env;
	struct passwd *pwd;
	int o, pam_err, status;
	pid_t pid;

	while ((o = getopt(argc, argv, "h")) != -1)
		switch (o) {
		case 'h':
		default:
			usage();
		}

	argc -= optind;
	argv += optind;

	if (argc &gt; 0) {
		user = *argv;
		--argc;
		++argv;
	} else {
		user = "root";
	}

	/* initialize PAM */
	pamc.conv = &amp;openpam_ttyconv;
	pam_start("su", user, &amp;pamc, &amp;pamh);

	/* set some items */
	gethostname(hostname, sizeof(hostname));
	if ((pam_err = pam_set_item(pamh, PAM_RHOST, hostname)) != PAM_SUCCESS)
		goto pamerr;
	user = getlogin();
	if ((pam_err = pam_set_item(pamh, PAM_RUSER, user)) != PAM_SUCCESS)
		goto pamerr;
	tty = ttyname(STDERR_FILENO);
	if ((pam_err = pam_set_item(pamh, PAM_TTY, tty)) != PAM_SUCCESS)
		goto pamerr;

	/* authenticate the applicant */
	if ((pam_err = pam_authenticate(pamh, 0)) != PAM_SUCCESS)
		goto pamerr;
	if ((pam_err = pam_acct_mgmt(pamh, 0)) == PAM_NEW_AUTHTOK_REQD)
		pam_err = pam_chauthtok(pamh, PAM_CHANGE_EXPIRED_AUTHTOK);
	if (pam_err != PAM_SUCCESS)
		goto pamerr;

	/* establish the requested credentials */
	if ((pam_err = pam_setcred(pamh, PAM_ESTABLISH_CRED)) != PAM_SUCCESS)
		goto pamerr;

	/* authentication succeeded; open a session */
	if ((pam_err = pam_open_session(pamh, 0)) != PAM_SUCCESS)
		goto pamerr;

	/* get mapped user name; PAM may have changed it */
	pam_err = pam_get_item(pamh, PAM_USER, (const void **)&amp;user);
	if (pam_err != PAM_SUCCESS || (pwd = getpwnam(user)) == NULL)
		goto pamerr;

	/* export PAM environment */
	if ((pam_envlist = pam_getenvlist(pamh)) != NULL) {
		for (pam_env = pam_envlist; *pam_env != NULL; ++pam_env) {
			putenv(*pam_env);
			free(*pam_env);
		}
		free(pam_envlist);
	}

	/* build argument list */
	if ((args = calloc(argc + 2, sizeof *args)) == NULL) {
		warn("calloc()");
		goto err;
	}
	*args = pwd-&gt;pw_shell;
	memcpy(args + 1, argv, argc * sizeof *args);

	/* fork and exec */
	switch ((pid = fork())) {
	case -1:
		warn("fork()");
		goto err;
	case 0:
		/* child: give up privs and start a shell */

		/* set uid and groups */
		if (initgroups(pwd-&gt;pw_name, pwd-&gt;pw_gid) == -1) {
			warn("initgroups()");
			_exit(1);
		}
		if (setgid(pwd-&gt;pw_gid) == -1) {
			warn("setgid()");
			_exit(1);
		}
		if (setuid(pwd-&gt;pw_uid) == -1) {
			warn("setuid()");
			_exit(1);
		}
		execve(*args, args, environ);
		warn("execve()");
		_exit(1);
	default:
		/* parent: wait for child to exit */
		waitpid(pid, &amp;status, 0);

		/* close the session and release PAM resources */
		pam_err = pam_close_session(pamh, 0);
		pam_end(pamh, pam_err);

		exit(WEXITSTATUS(status));
	}

pamerr:
	fprintf(stderr, "Sorry\n");
err:
	pam_end(pamh, pam_err);
	exit(1);
}

</pre></div><div class="appendix"><h2 class="title" style="clear: both"><a id="pam-sample-module"></a>B. Exemple d'un module PAM</h2><p>Ce   qui   suit   est   une   implémentation   minimale   de
    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_unix&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pam_unix</span>(8)</span></a>      offrant     uniquement      les     services
    d'authentification.  Elle  devrait  compiler  et tourner  avec  la
    plupart  des implémentations  PAM, mais  tire parti  des extensions
    d'OpenPAM  si  elles  sont  disponibles :  notez  l'utilisation  de
    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pam_get_authtok&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">pam_get_authtok</span>(3)</span></a>  qui simplifie  énormément  l'affichage de
    l'invite pour demander le mot de passe à l'utilisateur.</p><pre class="programlisting">
/*-
 * Copyright (c) 2002 Networks Associates Technology, Inc.
 * All rights reserved.
 *
 * This software was developed for the FreeBSD Project by ThinkSec AS and
 * Network Associates Laboratories, the Security Research Division of
 * Network Associates, Inc.  under DARPA/SPAWAR contract N66001-01-C-8035
 * ("CBOSS"), as part of the DARPA CHATS research program.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote
 *    products derived from this software without specific prior written
 *    permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * $P4: //depot/projects/openpam/modules/pam_unix/pam_unix.c#3 $
 * $FreeBSD$
 */

#include &lt;sys/param.h&gt;

#include &lt;pwd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;

#include &lt;security/pam_modules.h&gt;
#include &lt;security/pam_appl.h&gt;

#ifndef _OPENPAM
static char password_prompt[] = "Password:";
#endif

#ifndef PAM_EXTERN
#define PAM_EXTERN
#endif

PAM_EXTERN int
pam_sm_authenticate(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{
#ifndef _OPENPAM
	struct pam_conv *conv;
	struct pam_message msg;
	const struct pam_message *msgp;
	struct pam_response *resp;
#endif
	struct passwd *pwd;
	const char *user;
	char *crypt_password, *password;
	int pam_err, retry;

	/* identify user */
	if ((pam_err = pam_get_user(pamh, &amp;user, NULL)) != PAM_SUCCESS)
		return (pam_err);
	if ((pwd = getpwnam(user)) == NULL)
		return (PAM_USER_UNKNOWN);

	/* get password */
#ifndef _OPENPAM
	pam_err = pam_get_item(pamh, PAM_CONV, (const void **)&amp;conv);
	if (pam_err != PAM_SUCCESS)
		return (PAM_SYSTEM_ERR);
	msg.msg_style = PAM_PROMPT_ECHO_OFF;
	msg.msg = password_prompt;
	msgp = &amp;msg;
#endif
	for (retry = 0; retry &lt; 3; ++retry) {
#ifdef _OPENPAM
		pam_err = pam_get_authtok(pamh, PAM_AUTHTOK,
		    (const char **)&amp;password, NULL);
#else
		resp = NULL;
		pam_err = (*conv-&gt;conv)(1, &amp;msgp, &amp;resp, conv-&gt;appdata_ptr);
		if (resp != NULL) {
			if (pam_err == PAM_SUCCESS)
				password = resp-&gt;resp;
			else
				free(resp-&gt;resp);
			free(resp);
		}
#endif
		if (pam_err == PAM_SUCCESS)
			break;
	}
	if (pam_err == PAM_CONV_ERR)
		return (pam_err);
	if (pam_err != PAM_SUCCESS)
		return (PAM_AUTH_ERR);

	/* compare passwords */
	if ((!pwd-&gt;pw_passwd[0] &amp;&amp; (flags &amp; PAM_DISALLOW_NULL_AUTHTOK)) ||
	    (crypt_password = crypt(password, pwd-&gt;pw_passwd)) == NULL ||
	    strcmp(crypt_password, pwd-&gt;pw_passwd) != 0)
		pam_err = PAM_AUTH_ERR;
	else
		pam_err = PAM_SUCCESS;
#ifndef _OPENPAM
	free(password);
#endif
	return (pam_err);
}

PAM_EXTERN int
pam_sm_setcred(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SUCCESS);
}

PAM_EXTERN int
pam_sm_acct_mgmt(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SUCCESS);
}

PAM_EXTERN int
pam_sm_open_session(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SUCCESS);
}

PAM_EXTERN int
pam_sm_close_session(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SUCCESS);
}

PAM_EXTERN int
pam_sm_chauthtok(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SERVICE_ERR);
}

#ifdef PAM_MODULE_ENTRY
PAM_MODULE_ENTRY("pam_unix");
#endif

</pre></div><div class="appendix"><h2 class="title" style="clear: both"><a id="pam-sample-conv"></a>C. Exemple d'une fonction de conversation PAM</h2><p>La  fonction  de conversation  présentée  ci-dessous est  une
    version      grandement     simplifiée     de      la     fonction
    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=openpam_ttyconv&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">openpam_ttyconv</span>(3)</span></a> d'OpenPAM. Elle est pleinement fonctionnelle
    et devrait  donner au  lecteur une bonne  idée de comment  doit se
    comporter une fonction de  conversation, mais elle est trop simple
    pour une utilisation réelle.  Même si vous n'utilisez pas OpenPAM,
    N'hésitez pas à  télécharger le  code  source et  d'adapter
    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=openpam_ttyconv&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">openpam_ttyconv</span>(3)</span></a>  à vos besoins,  nous pensons  qu'elle est
    raisonnablement  aussi  robuste  qu'une fonction  de  conversation
    orientée tty peut l'être.</p><pre class="programlisting">
/*-
 * Copyright (c) 2002 Networks Associates Technology, Inc.
 * All rights reserved.
 *
 * This software was developed for the FreeBSD Project by ThinkSec AS and
 * Network Associates Laboratories, the Security Research Division of
 * Network Associates, Inc.  under DARPA/SPAWAR contract N66001-01-C-8035
 * ("CBOSS"), as part of the DARPA CHATS research program.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote
 *    products derived from this software without specific prior written
 *    permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * $FreeBSD$
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;

#include &lt;security/pam_appl.h&gt;

int
converse(int n, const struct pam_message **msg,
	struct pam_response **resp, void *data)
{
	struct pam_response *aresp;
	char buf[PAM_MAX_RESP_SIZE];
	int i;

	data = data;
	if (n &lt;= 0 || n &gt; PAM_MAX_NUM_MSG)
		return (PAM_CONV_ERR);
	if ((aresp = calloc(n, sizeof *aresp)) == NULL)
		return (PAM_BUF_ERR);
	for (i = 0; i &lt; n; ++i) {
		aresp[i].resp_retcode = 0;
		aresp[i].resp = NULL;
		switch (msg[i]-&gt;msg_style) {
		case PAM_PROMPT_ECHO_OFF:
			aresp[i].resp = strdup(getpass(msg[i]-&gt;msg));
			if (aresp[i].resp == NULL)
				goto fail;
			break;
		case PAM_PROMPT_ECHO_ON:
			fputs(msg[i]-&gt;msg, stderr);
			if (fgets(buf, sizeof buf, stdin) == NULL)
				goto fail;
			aresp[i].resp = strdup(buf);
			if (aresp[i].resp == NULL)
				goto fail;
			break;
		case PAM_ERROR_MSG:
			fputs(msg[i]-&gt;msg, stderr);
			if (strlen(msg[i]-&gt;msg) &gt; 0 &amp;&amp;
			    msg[i]-&gt;msg[strlen(msg[i]-&gt;msg) - 1] != '\n')
				fputc('\n', stderr);
			break;
		case PAM_TEXT_INFO:
			fputs(msg[i]-&gt;msg, stdout);
			if (strlen(msg[i]-&gt;msg) &gt; 0 &amp;&amp;
			    msg[i]-&gt;msg[strlen(msg[i]-&gt;msg) - 1] != '\n')
				fputc('\n', stdout);
			break;
		default:
			goto fail;
		}
	}
	*resp = aresp;
	return (PAM_SUCCESS);
 fail:
        for (i = 0; i &lt; n; ++i) {
                if (aresp[i].resp != NULL) {
                        memset(aresp[i].resp, 0, strlen(aresp[i].resp));
                        free(aresp[i].resp);
                }
        }
        memset(aresp, 0, n * sizeof *aresp);
	*resp = NULL;
	return (PAM_CONV_ERR);
}

</pre></div><div class="bibliography"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-further"></a>Lectures complémentaires</h2></div></div></div><div class="bibliodiv"><h3 class="title"><a id="idp62730576"></a>Publications</h3><div class="biblioentry"><a id="idp62732368"></a><p><span class="citetitle"><em class="citetitle"><a class="link" href="http://www.sun.com/software/solaris/pam/pam.external.pdf" target="_top">
	  Rendre les services de connexion indépendants des technologies d'authentification
	  </a></em>. </span><span class="authorgroup"><span class="firstname">Vipin</span> <span class="surname">Samar</span> et <span class="firstname">Charlie</span> <span class="surname">Lai</span>. </span><span class="orgname">Sun Microsystems. </span></p></div><div class="biblioentry"><a id="idp62753488"></a><p><span class="citetitle"><em class="citetitle"><a class="link" href="http://www.opengroup.org/pubs/catalog/p702.htm" target="_top">X/Open
	  Single Sign-on Preliminary Specification</a></em>. </span><span class="orgname">The Open Group. </span><span class="biblioid">1-85912-144-6. </span><span class="pubdate">June 1997. </span></p></div><div class="biblioentry"><a id="idp62759504"></a><p><span class="citetitle"><em class="citetitle"><a class="link" href="http://www.kernel.org/pub/linux/libs/pam/pre/doc/current-draft.txt" target="_top">
	  Pluggable Authentication Modules</a></em>. </span><span class="author"><span class="firstname">Andrew</span> <span class="othername">G.</span> <span class="surname">Morgan</span>. </span><span class="pubdate">1999-10-06. </span></p></div></div><div class="bibliodiv"><h3 class="title"><a id="idp62766032"></a>Guides utilisateur</h3><div class="biblioentry"><a id="idp62767056"></a><p><span class="citetitle"><em class="citetitle"><a class="link" href="http://www.sun.com/software/solaris/pam/pam.admin.pdf" target="_top">Administration de PAM
	 </a></em>. </span><span class="orgname">Sun Microsystems. </span></p></div></div><div class="bibliodiv"><h3 class="title"><a id="idp62770512"></a>Page internet liées</h3><div class="biblioentry"><a id="idp62772176"></a><p><span class="citetitle"><em class="citetitle"><a class="link" href="http://openpam.sourceforge.net/" target="_top">La page d'OpenPAM</a></em>. </span><span class="author"><span class="firstname">Dag-Erling</span> <span class="surname">Smørgrav</span>. </span><span class="orgname">ThinkSec AS. </span></p></div><div class="biblioentry"><a id="idp62777808"></a><p><span class="citetitle"><em class="citetitle"><a class="link" href="http://www.kernel.org/pub/linux/libs/pam/" target="_top">La page de Linux-PAM</a></em>. </span><span class="author"><span class="firstname">Andrew</span> <span class="othername">G.</span> <span class="surname">Morgan</span>. </span></p></div><div class="biblioentry"><a id="idp62783696"></a><p><span class="citetitle"><em class="citetitle"><a class="link" href="http://wwws.sun.com/software/solaris/pam/" target="_top">La page de Solaris PAM</a></em>. </span><span class="orgname">Sun Microsystems. </span></p></div></div></div></div></body></html>