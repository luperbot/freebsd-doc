<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>2. Comment utiliser NanoBSD</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Introduction à NanoBSD" /><link rel="up" href="index.html" title="Introduction à NanoBSD" /><link rel="prev" href="index.html" title="Introduction à NanoBSD" /><link rel="next" href="ix01.html" title="Index" /><link rel="copyright" href="trademarks.html" title="Note légale" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2. Comment utiliser NanoBSD</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="index.html">Précédent</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ix01.html">Suivant</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="howto"></a>2. Comment utiliser NanoBSD</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="design"></a>2.1. L'organisation de NanoBSD</h3></div></div></div><p>Une fois que l'image est présente sur le support,
	il est possible de démarrer
	<span class="application">NanoBSD</span>.  Le
	périphérique de stockage est divisé en
	trois parties par défaut:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Deux partitions image: <code class="literal">code#1</code>
	    et <code class="literal">code#2</code>.</p></li><li class="listitem"><p>La partition de configuration, qui peut être
	    montée sur le répertoire <code class="filename">/cfg</code> à
	    l'exécution.</p></li></ul></div><p>Ces partitions sont normalement montées en lecture
	seule.</p><p>Les répertoires <code class="filename">/etc</code> et <code class="filename">/var</code> sont des disques <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=md&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">md</span>(4)</span></a>
	(malloc).</p><p>La partition de configuration est montée sur le
	répertoire <code class="filename">/cfg</code>.
	Elle contient les fichiers du répertoire <code class="filename">/etc</code> et est brièvement
	montée en lecture seule juste après le
	démarrage du système, par conséquent il
	est nécessaire de recopier les fichiers modifiés
	de <code class="filename">/etc</code> vers le
	répertoire <code class="filename">/cfg</code>
	si l'on souhaite que les changements soient encore effectifs
	après le redémarrage du système.</p><div class="example"><a id="idp63810256"></a><div class="example-title">Exemple 1. Apporter des changements permanents à
	  <code class="filename">/etc/resolv.conf</code></div><div class="example-contents"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>vi /etc/resolv.conf</code></strong>
[...]
<code class="prompt">#</code> <strong class="userinput"><code>mount /cfg</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cp /etc/resolv.conf /cfg</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>umount /cfg</code></strong></pre></div></div><br class="example-break" /><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">La partition qui abrite <code class="filename">/cfg</code> doit être
	  montée uniquement au démarrage et lors de la
	  copie des fichiers de configuration.</p><p xmlns="http://www.w3.org/1999/xhtml">Garder <code class="filename">/cfg</code>
	  monté en permanence n'est pas une bonne idée,
	  en particulier si le système
	  <span class="application">NanoBSD</span> tourne sur un
	  périphérique de stockage qui peut être
	  endommagé par un grand nombre d'écritures sur
	  la partition (c'est à dire quand le contenu des
	  tampons de données est transféré sur
	  les disques).</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63834192"></a>2.2. Créer une image NanoBSD</h3></div></div></div><p>Une image <span class="application">NanoBSD</span> est
	créée à l'aide d'une simple
	procédure <code class="filename">nanobsd.sh</code>, qui peut
	être trouvée dans le répertoire <code class="filename">/usr/src/tools/tools/nanobsd</code>.
	Ce programme crée une image, qui peut être
	copiée sur le support de stockage à l'aide de
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dd&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">dd</span>(1)</span></a>.</p><p>Les commandes nécessaires à la
	création d'une image <span class="application">NanoBSD</span>
	sont:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/tools/tools/nanobsd</code></strong> <a id="nbsd-cd"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>sh nanobsd.sh</code></strong> <a id="nbsd-sh"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/obj/nanobsd.full</code></strong> <a id="nbsd-cd2"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>dd if=_.disk.full of=/dev/da0 bs=64k</code></strong> <a id="nbsd-dd"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-cd"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Se placer dans le répertoire de base du
	    programme de création de
	    <span class="application">NanoBSD</span>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-sh"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Démarrer le processus de
	    création.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-cd2"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Se placer dans le répertoire où les
	    images ont été créees.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-dd"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Installer <span class="application">NanoBSD</span> sur le
	    support de stockage.</p></td></tr></table></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63882448"></a>2.3. Personnaliser une image NanoBSD</h3></div></div></div><p>C'est probablement la fonctionnalité la plus
	importante et la plus intéressante de
	<span class="application">NanoBSD</span>.  C'est aussi là
	où vous passerez le plus de temps lors de vos
	développements avec
	<span class="application">NanoBSD</span>.</p><p>L'invocation de la commande suivante va obliger
	<code class="filename">nanobsd.sh</code> à lire sa configuration
	dans le fichier <code class="filename">myconf.nano</code> situé
	dans le répertoire courant:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh nanobsd.sh -c myconf.nano</code></strong></pre><p>La personnalisation est effectuée de 2
	façons:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>à l'aide d'options de configuration</p></li><li class="listitem"><p>à l'aide de fonctions de
	    personnalisation</p></li></ul></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63896784"></a>2.3.1. Les options de configuration</h4></div></div></div><p>Grace aux paramètres de configuration, il est
	  possible de configurer des options qui sont passées
	  aux étapes <code class="literal">buildworld</code> et
	  <code class="literal">installworld</code> du processus de compilation
	  de <span class="application">NanoBSD</span>, ainsi que des options
	  internes qui sont passées au processus principal de
	  compilation de <span class="application">NanoBSD</span>.  A l'aide
	  de ces options, il est possible de diminuer la taille du
	  système, de façon à ce qu'il tienne
	  dans 64Mo.  Vous pouvez utiliser les options de
	  configuration pour réduire encore plus FreeBSD,
	  jusqu'à ce qu'il ne consiste plus qu'en un noyau et 2
	  ou 3 fichiers dans le système de base.</p><p>Le fichier de configuration consiste en une série
	  d'options de configuration, qui surchargent les valeurs par
	  défaut.  Les directives les plus importantes
	  sont:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">NANO_NAME</code> &#8212; Nom de
	      compilation (utilisé pour créer le nom des
	      répertoires de travail).</p></li><li class="listitem"><p><code class="literal">NANO_SRC</code> &#8212; Chemin de
	      l'arbre des sources utilisé pour construire
	      l'image.</p></li><li class="listitem"><p><code class="literal">NANO_KERNEL</code> &#8212; Nom du
	      fichier de configuration utilisé pour compiler le
	      noyau.</p></li><li class="listitem"><p><code class="literal">CONF_BUILD</code> &#8212; Options
	      passées à la phase
	      <code class="literal">buildworld</code> de la compilation.</p></li><li class="listitem"><p><code class="literal">CONF_INSTALL</code> &#8212; Options
	      passées à la phase
	      <code class="literal">installworld</code> de la
	      compilation.</p></li><li class="listitem"><p><code class="literal">CONF_WORLD</code> &#8212; Options
	      passées aux étapes
	      <code class="literal">buildworld</code> et
	      <code class="literal">installworld</code>.</p></li><li class="listitem"><p><code class="literal">FlashDevice</code> &#8212;
	      Définit le type de support à utiliser.
	      Consulter le fichier
	      <code class="filename">FlashDevice.sub</code> pour plus de
	      détails.</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63947728"></a>2.3.2. Les fonctions de personnalisation</h4></div></div></div><p>Il est possible d'optimiser
	  <span class="application">NanoBSD</span> en utilisant des
	  fonctions d'interpréteur de commandes dans le fichier
	  de configuration.  L'exemple suivant présente la
	  trame de base des fonctions de personnalisation:</p><pre class="programlisting">cust_foo () (
	echo "bar=topless" &gt; \
		${NANO_WORLDDIR}/etc/foo
)
customize_cmd cust_foo</pre><p>Un exemple plus utile de fonction de personnalisation
	  est le suivant, qui change la taille par défaut du
	  répertoire <code class="filename">/etc</code>
	  de 5Mo à 30Mo:</p><pre class="programlisting">cust_etc_size () (
	cd ${NANO_WORLDDIR}/conf
	echo 30000 &gt; default/etc/md_size
)
customize_cmd cust_etc_size</pre><p>Il existe par défaut quelques fonctions de
	  personnalisation prédéfinies et prêtes
	  à être utilisées:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">cust_comconsole</code> &#8212;
	      Désactive <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getty&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">getty</span>(8)</span></a> sur les consoles VGA (les
	      périphériques
	      <code class="filename">/dev/ttyv*</code>) et paramètre la
	      console système sur le port série
	      COM1.</p></li><li class="listitem"><p><code class="literal">cust_allow_ssh_root</code> &#8212;
	      Autorise l'ouverture de sessions
	      <code class="systemitem">root</code> via <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a>.</p></li><li class="listitem"><p><code class="literal">cust_install_files</code> &#8212;
	      Installe les fichiers du répertoire <code class="filename">nanobsd/Files</code>, qui contient
	      des programmes utiles pour l'administration
	      système.</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63974864"></a>2.3.3. Exemple de fichier de configuration</h4></div></div></div><p>Un exemple complet de fichier de configuration pour
	  créer une image <span class="application">NanoBSD</span>
	  personnalisée peut être:</p><pre class="programlisting">NANO_NAME=custom
NANO_SRC=/usr/src
NANO_KERNEL=MYKERNEL
NANO_IMAGES=2

CONF_BUILD='
NO_KLDLOAD=YES
NO_NETGRAPH=YES
NO_PAM=YES
'

CONF_INSTALL='
NO_ACPI=YES
NO_BLUETOOTH=YES
NO_CVS=YES
NO_FORTRAN=YES
NO_HTML=YES
NO_LPR=YES
NO_MAN=YES
NO_SENDMAIL=YES
NO_SHAREDOCS=YES
NO_EXAMPLES=YES
NO_INSTALLLIB=YES
NO_CALENDAR=YES
NO_MISC=YES
NO_SHARE=YES
'

CONF_WORLD='
NO_BIND=YES
NO_MODULES=YES
NO_KERBEROS=YES
NO_GAMES=YES
NO_RESCUE=YES
NO_LOCALES=YES
NO_SYSCONS=YES
NO_INFO=YES
'

FlashDevice SanDisk 1G

cust_nobeastie() (
	touch ${NANO_WORLDDIR}/boot/loader.conf
	echo "beastie_disable=\"YES\"" &gt;&gt; ${NANO_WORLDDIR}/boot/loader.conf
)

customize_cmd cust_comconsole
customize_cmd cust_install_files
customize_cmd cust_allow_ssh_root
customize_cmd cust_nobeastie</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63988560"></a>2.4. Mettre à jour NanoBSD</h3></div></div></div><p>Le processus de mise à jour de
	<span class="application">NanoBSD</span> est relativement
	simple:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Créer une nouvelle image
	    <span class="application">NanoBSD</span>, comme
	    d'habitude.</p></li><li class="step"><p>Télécharger la nouvelle image dans une
	    partition inutilisée d'une appliance
	    <span class="application">NanoBSD</span>
	    opérationnelle.</p><p>La différence la plus importante de cette
	    étape par rapport à l'installation initiale
	    de <span class="application">NanoBSD</span> est que maintenant
	    au lieu d'utiliser le fichier
	    <code class="filename">_.disk.full</code> (qui contient une image
	    de la totalité du disque), l'image
	    <code class="filename">_.disk.image</code> est installée
	    (qui contient seulement l'image d'une seule partition
	    système).</p></li><li class="step"><p>Redémarrer le système sur la nouvelle
	    partition.</p></li><li class="step"><p>Si tout s'est bien passé, la mise à jour
	    est terminée.</p></li><li class="step"><p>Si quelque chose s'est mal passé,
	    redémarrez de nouveau sur la partition
	    précédente (qui contient l'ancienne image,
	    fonctionnelle celle-ci), pour remettre le système
	    en état de marche le plus rapidement possible.
	    Corriger les problèmes de la nouvelle image, et
	    répéter le processus.</p></li></ol></div><p>Pour installer la nouvelle image sur le système
	<span class="application">NanoBSD</span> opérationnel, il est
	possible d'utiliser la procédure
	<code class="filename">updatep1</code> ou <code class="filename">updatep2</code>
	située dans le répertoire <code class="filename">/root</code>, en fonction de la partition
	qui est en cours d'utilisation sur le système.</p><p>En fonction des services disponibles sur la machine qui
	dispose de la nouvelle image
	<span class="application">NanoBSD</span> et du type de transfert qui
	est préféré, il est possible d'utiliser
	une de ces trois méthodes:</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp64025296"></a>2.4.1. Utiliser <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ftp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ftp</span>(1)</span></a></h4></div></div></div><p>Si la vitesse de transfert est la priorité,
	  utiliser cet exemple:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ftp myhost
get _.disk.image "| sh updatep1"</code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp64036176"></a>2.4.2. Utiliser <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a></h4></div></div></div><p>Si un transfert sécurisé est
	  préférable, considérer l'utilisation de
	  cet exemple:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ssh myhost cat _.disk.image.gz | zcat | sh updatep1</code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp64043728"></a>2.4.3. Utiliser <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=nc&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">nc</span>(1)</span></a></h4></div></div></div><p>Utiliser cet exemple si la machine distante n'utilise ni
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ftp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ftp</span>(1)</span></a> ni <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a>:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Tout d'abord, ouvrez un écouteur TCP sur la
	      machine qui dispose de l'image et faites-lui envoyer
	      l'image au client:</p><pre class="screen">myhost<code class="prompt">#</code> <strong class="userinput"><code>nc -l 2222 &lt; _.disk.image</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Assurez vous que le port utilisé n'est pas
		bloqué par un pare-feu afin de recevoir les
		connexions entrantes de la machine
		<span class="application">NanoBSD</span>.</p></div></li><li class="step"><p>Se connecter à la machine qui dispose de la
	      nouvelle image et exécuter la procédure
	      <code class="filename">updatep1</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>nc myhost 2222 | sh updatep1</code></strong></pre></li></ol></div></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index.html">Précédent</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ix01.html">Suivant</a></td></tr><tr><td width="40%" align="left" valign="top">Introduction à NanoBSD </td><td width="20%" align="center"><a accesskey="h" href="index.html">Sommaire</a></td><td width="40%" align="right" valign="top"> Index</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Ce document, ainsi que d'autres peut être téléchargé sur
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Pour toutes questions à propos de FreeBSD, lisez la
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> avant de contacter
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    Pour les questions sur cette documentation, contactez
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.</small></p></body></html>