<?xml version="1.0" encoding="iso-8859-1"?>
<!--
    The FreeBSD Documentation Project
    The FreeBSD French Documentation Project

    $FreeBSD$
    $Id: article.xml,v 1.7 2007-01-20 13:34:48 blackend Exp $
    Original revision: 1.12
-->
<article xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:lang="fr">
  <info><title xmlns:xlink="http://www.w3.org/1999/xlink">Vérification indépendante du fonctionnement d'IPSec sous
      FreeBSD</title>
    

    <author xmlns:xlink="http://www.w3.org/1999/xlink"><personname xmlns:xlink="http://www.w3.org/1999/xlink"><firstname xmlns:xlink="http://www.w3.org/1999/xlink">David</firstname><surname xmlns:xlink="http://www.w3.org/1999/xlink">Honig</surname></personname><affiliation xmlns:xlink="http://www.w3.org/1999/xlink">
        <address xmlns:xlink="http://www.w3.org/1999/xlink"><email xmlns:xlink="http://www.w3.org/1999/xlink">honig@sprynet.com</email></address>
      </affiliation></author>

    <pubdate xmlns:xlink="http://www.w3.org/1999/xlink">3 Mai 1999</pubdate>
	<legalnotice xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="trademarks" role="trademarks">
	<para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">FreeBSD is a registered trademark of
  the FreeBSD Foundation.</para>
	<para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">Motif, OSF/1, and UNIX are
  registered trademarks and IT DialTone and The Open Group are
  trademarks of The Open Group in the United States and other
  countries.</para>
	<para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">Many of the designations used by
  manufacturers and sellers to distinguish their products are claimed
  as trademarks.  Where those designations appear in this document,
  and the FreeBSD Project was aware of the trademark claim, the
  designations have been followed by the <quote xmlns:xlink="http://www.w3.org/1999/xlink">&#8482;</quote> or the
  <quote xmlns:xlink="http://www.w3.org/1999/xlink">®</quote> symbol.</para>
	</legalnotice>

    <releaseinfo xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</releaseinfo>

    <abstract xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">Vous avez installé IPSec et cela semble fonctionner.
	Comment pouvez-vous en être sûr?  Je décris
	une méthode pour vérifier expérimentalement
	le fonctionnement d'IPSec.</para>

	<para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><emphasis xmlns:xlink="http://www.w3.org/1999/xlink">Version française de Marc Fonvieille
  <email xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">blackend@FreeBSD.org</email>.</emphasis></para>
    </abstract>
  </info>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Le problème</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Tout d'abord, supposons que vous avez <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="ipsec-install">installé
      <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">IPSec</emphasis></link>.
      Comment savez-vous si cela <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="caveat">fonctionne</link>?
      Bien sûr, votre connexion ne fonctionnera pas si elle est mal
      configurée, et fonctionnera quand vous l'aurez enfin
      correctement configurée.  <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">netstat</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> le fera
      apparaître.  Mais pouvez-vous le confirmer
      de façon indépendante?</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">La solution</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Tout d'abord, quelques informations théoriques relatives
      à la cryptographie:</para>

    <orderedlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Les données chiffrées sont
	  uniformément distribuées, i.e., ont une entropie
	  maximale par symbole;</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Les données brutes, non compressées sont en
	  générale redondantes, i.e., n'ont pas une
	  entropie maximale.</para>
      </listitem>
    </orderedlist>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Supposez que vous pourriez mesurer l'entropie des
      données à destination et en provenance de votre
      interface réseau.  Alors vous pourriez voir la
      différence entre données non-chiffées et
      données chiffrées.  Cela serait vrai même si
      certaines des données en &#8220;mode chiffré&#8221;
      n'étaient pas chiffrées --- comme l'en-tête IP
      externe, si le paquet doit être routable.</para>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="MUST">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">MUST</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">L'&#8220;Universal Statistical Test for Random
	Bit Generators&#8221;(<link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.geocities.com/SiliconValley/Code/4704/universal.pdf">
	<acronym xmlns:xlink="http://www.w3.org/1999/xlink">MUST</acronym></link>) d'Ueli Maurer, ou encore le
	&#8220;test statistique universel pour les générateurs
	aléatoires de bits&#8221;, mesure rapidement l'entropie d'un
	échantillon.  Il utilise une sorte d'algorithme de compression.
	<link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="code">Le code est donné ci-dessous</link> pour
	une variante qui mesure les morceaux (environ un quart de
	mégaoctet) successifs d'un fichier.</para>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="tcpdump">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Tcpdump</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Nous avons également besoin d'une manière de
	capturer les données réseau brutes.  Un programme
	appelé <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">tcpdump</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> vous permet de faire cela, si vous
	avez activé l'interface
	<emphasis xmlns:xlink="http://www.w3.org/1999/xlink">Berkeley Packet Filter</emphasis> (Filtre de Paquet de
	Berkeley) dans votre <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="kernel">fichier de
	configuration du noyau</link>.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">La commande</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><userinput xmlns:xlink="http://www.w3.org/1999/xlink">tcpdump -c 4000 -s 10000 -w dumpfile.bin</userinput></screen>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">capturera 4000 paquets bruts dans le fichier
	<replaceable xmlns:xlink="http://www.w3.org/1999/xlink">dumpfile.bin</replaceable>.  Dans cet exemple
	jusqu'à 10000 octets par paquets seront
	capturés.</para>
    </sect2>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">L'expérience</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Voici l'expérience:</para>

    <procedure xmlns:xlink="http://www.w3.org/1999/xlink">
      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Ouvrez une fenêtre sur un hôte IPSec et une
	  autre sur un hôte non sécurisé.</para>
      </step>

      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Maintenant commencez à <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="tcpdump">capturer
	  les paquets</link>.</para>
      </step>

      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Dans la fenêtre &#8220;sécurisée&#8221;,
	  lancez la commande <trademark xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" class="registered">UNIX</trademark> <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">yes</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>, qui fera défiler
	  le caractère <literal xmlns:xlink="http://www.w3.org/1999/xlink">y</literal>.  Au bout d'un moment,
	  arrêtez cela.  Passez à la fenêtre non
	  sécurisée, et faites de même.  Au bout
	  d'un moment, arrêtez.</para>
      </step>

      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Maintenant lancez <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="code">MUST</link> sur les
	  paquets capturés.  Vous devriez voir quelque chose de
	  semblable à ce qui suit.  Ce qui est important de noter est
	  que la connexion non sécurisée a 93% (6,7) de valeurs
	  attendues (7,18), et la connexion &#8220;normale&#8221; a 29%
	  (2,1) de valeurs attendues.</para>

    <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">%</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">tcpdump -c 4000 -s 10000 -w ipsecdemo.bin</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">%</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">uliscan ipsecdemo.bin</userinput>

Uliscan 21 Dec 98
L=8 256 258560
Measuring file ipsecdemo.bin
Init done
Expected value for L=8 is 7.1836656
6.9396 --------------------------------------------------------
6.6177 -----------------------------------------------------
6.4100 ---------------------------------------------------
2.1101 -----------------
2.0838 -----------------
2.0983 -----------------</screen>
      </step>
    </procedure>
  </sect1>

    <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="caveat">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Mise en garde</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Cette expérience montre qu'IPSec <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">semble</emphasis>
      distribuer les données utiles
      <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">uniformément</emphasis> comme un chiffrement
      le devrait.  Cependant, l'expérience décrite
      ici <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">ne peut pas</emphasis> détecter les
      problèmes possibles dans un système.  Ceux-ci
      peuvent être la génération ou l'échange
      d'une clé faible, des données ou clés visibles
      par d'autres, l'utilisation d'algorithmes faibles, code du noyau
      modifié, etc...
      Etudiez les sources, maîtrisez le code.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="IPsec">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">IPSec - Définition</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Extensions de sécurité au protocole internet
      IPv4, requises pour l'IPv6.  Un protocole pour le chiffrement et
      l'authentification au niveau IP (hôte à hôte).
      SSL sécurise uniquement une socket d'application;
      <application xmlns:xlink="http://www.w3.org/1999/xlink">SSH</application> sécurise seulement une session;
      <application xmlns:xlink="http://www.w3.org/1999/xlink">PGP</application> sécurise uniquement un fichier
      spécifique ou un message.  IPSec chiffre tout entre deux
      hôtes.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="ipsec-install">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Installation d'IPSec</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">La plupart des versions récentes de FreeBSD ont le support
      IPSec dans leurs sources de base.  Aussi vous devrez probablement
      ajouter l'option <option xmlns:xlink="http://www.w3.org/1999/xlink">IPSEC</option> dans votre configuration de noyau
      et, après la compilation et l'installation du noyau, configurer
      les connexions IPSec en utilisant la commande
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">setkey</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Un guide complet sur l'utilisation d'IPSec sous FreeBSD est
      fourni dans le <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="../../books/handbook/ipsec.html">Manuel
      de Freebsd</link>.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="kernel">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">src/sys/i386/conf/KERNELNAME</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Ce qui suit doit être présent dans le fichier de
      configuration du noyau afin de pouvoir capturer les données
      réseau avec <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">tcpdump</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>.  Soyez-sûr de lancer
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">config</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> après avoir rajouté la ligne
      ci-dessous, et de recompiler et réinstaller.</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">device	bpf</programlisting>
  </sect1>

    <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="code">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Test statistique universel de Maurer (pour une longueur de
	bloc=8 bits)</title>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">Vous pouvez trouver le même code source <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.geocities.com/SiliconValley/Code/4704/uliscanc.txt">
          ici</link>.</para>

<programlisting xmlns:xlink="http://www.w3.org/1999/xlink">/*
  ULISCAN.c   ---blocksize of 8

  1 Oct 98
  1 Dec 98
  21 Dec 98       uliscan.c derived from ueli8.c

  This version has // comments removed for Sun cc

  This implements Ueli M Maurer's "Universal Statistical Test for Random
  Bit Generators" using L=8

  Accepts a filename on the command line; writes its results, with other
  info, to stdout.

  Handles input file exhaustion gracefully.

  Ref: J. Cryptology v 5 no 2, 1992 pp 89-105
  also on the web somewhere, which is where I found it.

  -David Honig
  honig@sprynet.com

  Usage:
  ULISCAN filename
  outputs to stdout
*/

#define L 8
#define V (1&lt;&lt;L)
#define Q (10*V)
#define K (100   *Q)
#define MAXSAMP (Q + K)

#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

int main(argc, argv)
int argc;
char **argv;
{
  FILE *fptr;
  int i,j;
  int b, c;
  int table[V];
  double sum = 0.0;
  int iproduct = 1;
  int run;

  extern double   log(/* double x */);

  printf("Uliscan 21 Dec 98 \nL=%d %d %d \n", L, V, MAXSAMP);

  if (argc &lt; 2) {
    printf("Usage: Uliscan filename\n");
    exit(-1);
  } else {
    printf("Measuring file %s\n", argv[1]);
  }

  fptr = fopen(argv[1],"rb");

  if (fptr == NULL) {
    printf("Can't find %s\n", argv[1]);
    exit(-1);
  }

  for (i = 0; i &lt; V; i++) {
    table[i] = 0;
  }

  for (i = 0; i &lt; Q; i++) {
    b = fgetc(fptr);
    table[b] = i;
  }

  printf("Init done\n");

  printf("Expected value for L=8 is 7.1836656\n");

  run = 1;

  while (run) {
    sum = 0.0;
    iproduct = 1;

    if (run)
      for (i = Q; run &amp;&amp; i &lt; Q + K; i++) {
        j = i;
        b = fgetc(fptr);

        if (b &lt; 0)
          run = 0;

        if (run) {
          if (table[b] &gt; j)
            j += K;

          sum += log((double)(j-table[b]));

          table[b] = i;
        }
      }

    if (!run)
      printf("Premature end of file; read %d blocks.\n", i - Q);

    sum = (sum/((double)(i - Q))) /  log(2.0);
    printf("%4.4f ", sum);

    for (i = 0; i &lt; (int)(sum*8.0 + 0.50); i++)
      printf("-");

    printf("\n");

    /* refill initial table */
    if (0) {
      for (i = 0; i &lt; Q; i++) {
        b = fgetc(fptr);
        if (b &lt; 0) {
          run = 0;
        } else {
          table[b] = i;
        }
      }
    }
  }
}</programlisting>
  </sect1>
</article>
