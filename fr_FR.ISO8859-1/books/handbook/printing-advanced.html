<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>10.4. Configuration avancée de l'imprimante</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Manuel FreeBSD" /><link rel="up" href="printing.html" title="Chapitre 10. Imprimer" /><link rel="prev" href="printing-intro-setup.html" title="10.3. Configuration de base" /><link rel="next" href="printing-using.html" title="10.5. Using Printers ** Traduction en Cours **" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.4. Configuration avancée de l'imprimante</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="printing-intro-setup.html">Précédent</a> </td><th width="60%" align="center">Chapitre 10. Imprimer</th><td width="20%" align="right"> <a accesskey="n" href="printing-using.html">Suivant</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="printing-advanced"></a>10.4. Configuration avancée de l'imprimante</h2></div></div></div><p>Cette section décrit les filtres à utiliser
      pour imprimer des fichiers au formatage particulier, des pages
      d'en-tête, pour imprimer en réseau, et pour
      restreindre et comptabiliser l'utilisation de
      l'imprimante.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-filter-intro"></a>10.4.1. Les filtres</h3></div></div></div><a id="idp74186192" class="indexterm"></a><p>Bien que <span class="application">LPD</span> gère les
	protocoles réseaux, les files d'attente, le
	contrôle d'accès et d'autres aspects de
	l'impression, la plus grande partie du
	<span class="emphasis"><em>véritable</em></span> travail intervient dans
	les <span class="emphasis"><em>filtres</em></span>.  Les filtres sont des
	programmes qui communiquent avec l'imprimante et gèrent
	ses dépendances matérielles ainsi que ses
	besoins particuliers.  Dans la configuration simple de
	l'imprimante, nous avons installé un filtre texte
	simple&#8212; un filtre particulièrement basique qui
	devrait fonctionner avec la plupart des imprimantes (voir la
	section <a class="link" href="printing-intro-setup.html#printing-textfilter" title="10.3.1.5.6. Installer le filtre texte">Installer le
	filtre texte</a>).</p><p>Toutefois, afin de profiter de la conversion de format, de
	la comptabilisation de l'utilisation de l'imprimante, de
	particularités matérielles, et ainsi de suite,
	il vous faut comprendre le fonctionnement des filtres.  En
	dernier ressort, il incombera au filtre de gérer ces
	aspects.  Et la mauvaise nouvelle, c'est que la plupart du
	temps, c'est <span class="emphasis"><em>vous</em></span> qui devrez produire ces
	filtres vous-même.  La bonne nouvelle, c'est que
	beaucoup existent déjà et que, sinon, ils sont
	en général assez faciles à
	écrire.</p><p>Par ailleurs, il en est un livré avec FreeBSD,
	<code class="filename">/usr/libexec/lpr/lpf</code>, qui fonctionne avec
	beaucoup d'imprimantes capables d'imprimer du texte brut.  (Il
	gère les retours arrière et les tabulations dans
	le fichier, effectue une comptabilisation, mais c'est à
	peu près tout).  Vous trouverez également
	d'autres filtres et composants de filtres dans le catalogue
	des logiciels portés de FreeBSD.</p><p>Voici ce que vous trouverez dans cette section:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>La section
	    <a class="link" href="printing-advanced.html#printing-advanced-filters" title="10.4.1.1. Fonctionnement des filtres">Fonctionnement
	    des filtres</a> tâche de donner une vue
	    générale du rôle des filtres dans le
	    processus d'impression.  Il vous faut lire cette section
	    pour comprendre ce qui se passe <span class="quote">« <span class="quote">sous le
	    capot</span> »</span> lorsque <span class="application">LPD</span>
	    utilise des filtres.  Cette connaissance vous permettra
	    d'anticiper et de résoudre les problèmes que
	    vous pourriez rencontrer quand vous installerez de plus en
	    plus de filtres pour chacune de vos imprimantes.</p></li><li class="listitem"><p><span class="application">LPD</span> s'attend à ce
	    que toutes les imprimantes sachent imprimer du texte brut
	    par défaut.  Cela pose un problème pour les
	    imprimantes <span class="trademark">PostScript</span>® (ou les imprimantes basées
	    sur un autre langage) qui ne peut pas imprimer du texte
	    brut directement.  La section <a class="link" href="printing-advanced.html#printing-advanced-if-conversion" title="10.4.1.2. Gérer les travaux d'impression de texte brut sur des imprimantes PostScript®">Gérer les
	    travaux d'impression de texte brut sur des imprimantes
	    <span class="trademark">PostScript</span>®</a> vous indique la marche à suivre
	    pour résoudre ce problème.  Vous devrez lire
	    cette section si vous avez une imprimante
	    <span class="trademark">PostScript</span>®.</p></li><li class="listitem"><p><span class="trademark">PostScript</span>® est un format de sortie courant pour
	    beaucoup d'applications.  Certaines personnes
	    écrivent même du code <span class="trademark">PostScript</span>®
	    directement.  Malheureusement, les imprimantes
	    <span class="trademark">PostScript</span>® sont onéreuses.  La section <a class="link" href="printing-advanced.html#printing-advanced-ps" title="10.4.1.3. Emuler du PostScript® sur les imprimantes non-PostScript®">Emuler du <span class="trademark">PostScript</span>® sur
	    les imprimantes non-<span class="trademark">PostScript</span>®</a> vous indiquera
	    comment modifier un filtre texte pour qu'une imprimante
	    <span class="emphasis"><em>non-<span class="trademark">PostScript</span>®</em></span> accepte et imprime
	    du <span class="trademark">PostScript</span>®.  Vous devrez lire cette section si vous
	    ne disposez pas d'une imprimante <span class="trademark">PostScript</span>®.</p></li><li class="listitem"><p>La section
	    <a class="link" href="printing-advanced.html#printing-advanced-convfilters" title="10.4.1.4. Filtres de conversion">Filtres de
	    conversion</a> vous apprendra à automatiser la
	    conversion de formats de fichiers spécifiques,
	    comme des graphiques ou des données de composition,
	    en formats compréhensibles par l'imprimante.
	    Après avoir lu cette section, vous serez en mesure
	    de configurer vos imprimantes de telle sorte que vos
	    utilisateurs pourront entrer la commande <code class="command">lpr
	    -t</code> pour imprimer du troff, ou <code class="command">lpr
	    -d</code> pour imprimer le format DVI produit par
	    <span class="application">TeX</span>, ou <code class="command">lpr -v</code> pour imprimer des
	    images en mode point, etc.  Nous recommandons la lecture
	    de cette section.</p></li><li class="listitem"><p>La section <a class="link" href="printing-advanced.html#printing-advanced-of" title="10.4.1.5. Filtres de sortie">Filtres de sortie</a>
	    révèle tout d'une fonctionnalité peu
	    utilisée de <span class="application">LPD</span>: les
	    filtres de sortie.  A moins que vous n'imprimiez des pages
	    d'en-têtes (voir la section <a class="link" href="printing-advanced.html#printing-advanced-header-pages" title="10.4.2. Pages d'en-tête">Pages
	    d'en-tête</a>), vous pouvez probablement
	    complètement ignorer cette section.</p></li><li class="listitem"><p>La section <a class="link" href="printing-advanced.html#printing-advanced-lpf" title="10.4.1.6. lpf: un filtre texte">lpf:
	    un filtre texte</a> détaille
	    <code class="command">lpf</code>, un filtre texte destiné aux
	    imprimantes en ligne (et aux imprimantes laser se
	    comportant comme telles) plutôt complet
	    malgré sa simplicité, et livré avec
	    FreeBSD.  Si vous avez besoin de mettre rapidement en place
	    la comptabilisation de l'utilisation de l'imprimante pour
	    du texte brut, ou si vous avez une imprimante qui fume
	    lorsqu'elle voit passer des caractères de retour
	    arrière, vous devez vraiment penser à
	    <code class="command">lpf</code>.</p></li></ul></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Une copie des différents scripts
	  présentés ci-dessous se trouve dans le
	  répertoire <code class="filename">/usr/share/examples/printing</code>.
	</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-filters"></a>10.4.1.1. Fonctionnement des filtres</h4></div></div></div><p>Comme expliqué précédemment, un
	  filtre est un programme exécutable lancé par
	  <span class="application">LPD</span> pour gérer la partie
	  de la communication avec l'imprimante qui est
	  dépendante du périphérique.</p><p>Lorsque <span class="application">LPD</span> veut imprimer un
	  fichier d'un travail d'impression, il lance un programme de
	  filtre.  Il redirige l'entrée standard du filtre sur
	  le fichier à imprimer, sa sortie standard vers
	  l'imprimante, et l'erreur standard vers le fichier journal
	  des erreurs (spécifié dans le paramètre
	  <code class="literal">lf</code> du fichier
	  <code class="filename">/etc/printcap</code>, ou
	  <code class="filename">/dev/console</code> par défaut).</p><a id="idp74230480" class="indexterm"></a><p>Le filtre lancé par
	  <span class="application">LPD</span> ainsi que les
	  paramètres qui lui sont donnés
	  dépendent de ce qui est placé dans le fichier
	  <code class="filename">/etc/printcap</code> et des paramètres
	  que l'utilisateur a passé sur la ligne de commande
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a> pour ce travail d'impression.  Par exemple, si
	  l'utilisateur a entré <code class="command">lpr -t</code>,
	  <span class="application">LPD</span> aurait lancé le filtre
	  troff, précisé par la paramètre
	  <code class="literal">tf</code> pour l'imprimante de destination.  Si
	  l'utilisateur veut imprimer du texte brut, il lancerait le
	  filtre <code class="literal">if</code> (c'est vrai la plupart du
	  temps: lisez la section <a class="link" href="printing-advanced.html#printing-advanced-of" title="10.4.1.5. Filtres de sortie">Filtres de sortie</a> pour
	  plus de détails).</p><p>Il existe trois types de filtres que vous pouvez
	  spécifier dans
	  <code class="filename">/etc/printcap</code>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Le <span class="emphasis"><em>filtre texte</em></span>,
	      confusément appelé <span class="emphasis"><em>filtre
	      d'entrée</em></span> dans la documentation
	      <span class="application">LPD</span>, gère l'impression
	      de texte classique.  Considérez-le comme le
	      filtre par défaut.
	      <span class="application">LPD</span> s'attend à ce que
	      toutes les imprimantes sachent imprimer du texte brut
	      par défaut, et c'est au filtre texte de s'assurer
	      que les retours arrière, tabulations et autres
	      caractères spéciaux ne trompent pas
	      l'imprimante.  Si vous êtes dans un environnement
	      où il vous faut rendre compte de l'utilisation de
	      l'imprimante, le filtre texte doit également
	      comptabiliser les pages imprimées,
	      généralement en comptant le nombre de
	      lignes imprimées et en le comparant avec le
	      nombre de lignes par page supporté par
	      l'imprimante.  Le filtre texte est exécuté
	      avec la liste de paramètres suivante:</p><div class="cmdsynopsis"><p><code class="command">nom_du_filtre</code> [-c]  -w
		<em class="replaceable"><code>largeur</code></em>   -l
		<em class="replaceable"><code>hauteur</code></em>   -i
		<em class="replaceable"><code>indentation</code></em>   -n
		<em class="replaceable"><code>utilisateur</code></em>   -h
		<em class="replaceable"><code>machine</code></em>   <em class="replaceable"><code>fichier_comptabilité</code></em> </p></div><p>où</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-c</code></span></dt><dd><p>apparaît si le travail d'impression est
		    lancé par la commande <code class="command">lpr
		    -l</code></p></dd><dt><span class="term"><em class="replaceable"><code>largeur</code></em></span></dt><dd><p>est la valeur du paramètre
		    <code class="literal">pw</code> (<span class="quote">« <span class="quote">page width</span> »</span>,
		    pour <span class="quote">« <span class="quote">largeur de page</span> »</span>)
		    spécifié dans
		    <code class="filename">/etc/printcap</code>, et
		    possédant la valeur par défaut
		    132.</p></dd><dt><span class="term"><em class="replaceable"><code>hauteur</code></em></span></dt><dd><p>est la valeur du paramètre
		    <code class="literal">pl</code> (<span class="quote">« <span class="quote">page length</span> »</span>,
		    pour <span class="quote">« <span class="quote">hauteur de page</span> »</span>), par
		    défaut: 66.</p></dd><dt><span class="term"><em class="replaceable"><code>indentation</code></em></span></dt><dd><p>est le nombre d'indentations
		    inséré par <code class="command">lpr
		    -i</code>, par défaut: 0.</p></dd><dt><span class="term"><em class="replaceable"><code>utilisateur</code></em></span></dt><dd><p>est le nom du compte de l'utilisateur
		    imprimant le fichier.</p></dd><dt><span class="term"><em class="replaceable"><code>machine</code></em></span></dt><dd><p>est le nom de la machine depuis
		    laquelle le travail d'impression a
		    été soumis.</p></dd><dt><span class="term"><em class="replaceable"><code>fichier_comptabilité</code></em></span></dt><dd><p>est le nom du fichier de comptabilisation
		    spécifié par le paramètre
		    <code class="literal">af</code>.</p></dd></dl></div></li><li class="listitem"><a id="idp74277584" class="indexterm"></a><p>Un <span class="emphasis"><em>filtre de conversion</em></span>
	      convertit un format de fichier spécifique en un
	      autre que l'imprimante saura imprimer sur papier.  Par
	      exemple, des données de composition ditroff ne
	      peuvent être imprimées directement, mais il
	      vous est possible d'installer un filtre de conversion
	      ditroff afin de convertir ces données ditroff en
	      une forme que l'imprimante sait ingérer et
	      imprimer.  La section <a class="link" href="printing-advanced.html#printing-advanced-convfilters" title="10.4.1.4. Filtres de conversion">Filtres de
	      conversion</a> vous dira tout sur ce sujet.  Les
	      filtres de conversion doivent également tenir des
	      statistiques, si vous avez besoin de comptabiliser les
	      impressions.  Les filtres de conversion sont
	      lancés avec les paramètres
	      suivants:</p><div class="cmdsynopsis"><p><code class="command">nom-du-filtre</code>  -x
		<em class="replaceable"><code>largeur-en-pixels</code></em>   -y
		<em class="replaceable"><code>hauteur-en-pixels</code></em>   -n
		<em class="replaceable"><code>login</code></em>   -h
		<em class="replaceable"><code>hôte</code></em>   <em class="replaceable"><code>fichier_comptabilité</code></em> </p></div><p>où
	      <em class="replaceable"><code>largeur-en-pixels</code></em> est la
	      valeur du paramètre <code class="literal">px</code> (0 par
	      défaut) et
	      <em class="replaceable"><code>hauteur-en-pixels</code></em> est la
	      valeur du paramètre <code class="literal">py</code> (0 par
	      défaut).</p></li><li class="listitem"><p>Le <span class="emphasis"><em>filtre de sortie</em></span> n'est
	      utilisé que s'il n'y a pas de filtre texte, ou si
	      les pages d'en-tête ont été
	      activées.  D'après notre
	      expérience, les filtres de sortie sont rarement
	      employés.  La section <a class="link" href="printing-advanced.html#printing-advanced-of" title="10.4.1.5. Filtres de sortie">Filtres de sortie</a>
	      les détaillera.  Un filtre de sortie ne prend que
	      deux paramètres:</p><div class="cmdsynopsis"><p><code class="command">nom-du-filtre</code>  -w
		<em class="replaceable"><code>largeur</code></em>   -l
		<em class="replaceable"><code>hauteur</code></em> </p></div><p>qui sont identiques aux paramètres
	      <code class="option">-w</code> et <code class="option">-l</code> des filtres
	      textes.</p></li></ul></div><p>Les filtres doivent également
	  <span class="emphasis"><em>retourner</em></span> avec le code de retour
	  suivant:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">exit 0</span></dt><dd><p>Si le filtre a imprimé avec succès
		le fichier.</p></dd><dt><span class="term">exit 1</span></dt><dd><p>Si le filtre n'a pu imprimer le fichier, mais
		désire que <span class="application">LPD</span>
		essaie de l'imprimer à nouveau.
		<span class="application">LPD</span> relancera un filtre
		s'il retourne avec ce code.</p></dd><dt><span class="term">exit 2</span></dt><dd><p>Si le filtre n'a pu imprimer le fichier et ne veut
		pas que <span class="application">LPD</span> retente
		l'impression.  <span class="application">LPD</span>
		rejettera le fichier.</p></dd></dl></div><p>Le filtre texte livré avec FreeBSD,
	  <code class="filename">/usr/libexec/lpr/lpf</code>, tire parti des
	  paramètres de largeur et hauteur de page pour savoir
	  quand envoyer une instruction de saut de page et comment
	  comptabiliser l'utilisation de l'imprimante.  Il utilise les
	  paramètres nom d'utilisateur, nom de machine, et
	  fichier de comptabilisation pour enregistrer les
	  entrées concernant la consommation.</p><p>Si vous recherchez des filtres, prenez garde à ce
	  qu'ils soient compatibles avec LPD.  Si c'est le cas, ils
	  doivent se conformer à la liste de paramètres
	  décrite ci-dessus.  Si vous songez à
	  écrire des filtres à usage
	  général, alors faites en sorte qu'ils se
	  conforment à ces mêmes listes de
	  paramètres et de codes de retour.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-if-conversion"></a>10.4.1.2. Gérer les travaux d'impression de texte brut sur
	  des imprimantes <span class="trademark">PostScript</span>®</h4></div></div></div><a id="idp74310224" class="indexterm"></a><p>Si vous êtes l'unique utilisateur de votre
	  ordinateur et de votre imprimante <span class="trademark">PostScript</span>® (ou
	  basée sur un autre langage), et que vous promettez de
	  ne jamais envoyer de texte brut à votre imprimante et
	  de ne jamais utiliser les fonctionnalités des divers
	  programmes qui voudraient lui en envoyer, alors vous pouvez
	  tout à fait passer cette section l'esprit
	  tranquille.</p><p>Toutefois, si vous désirez envoyer du
	  <span class="trademark">PostScript</span>® et du texte brut à l'imprimante, alors
	  vous êtes instamment priés de compléter
	  la configuration de votre imprimante.  Pour ce faire, nous
	  chargerons le filtre texte de détecter si le travail
	  d'impression est du texte brut ou du <span class="trademark">PostScript</span>®.  Tous les
	  travaux d'impression <span class="trademark">PostScript</span>® doivent débuter par
	  <code class="literal">%!</code> (en ce qui concerne les autres
	  langages, référez-vous à la
	  documentation de l'imprimante).  Si ces deux
	  caractères sont les deux premiers du travail
	  d'impression, il s'agit de <span class="trademark">PostScript</span>® et le reste du
	  travail d'impression peut être passé
	  directement à l'imprimante.  Dans le cas contraire,
	  alors le filtre convertit le texte en <span class="trademark">PostScript</span>® et
	  imprime le résultat.</p><p>Comment procéder?</p><a id="idp74315472" class="indexterm"></a><p>Si vous disposez d'une imprimante série, une
	  bonne façon de faire est d'installer
	  <code class="command">lprps</code>.  Il s'agit d'un filtre
	  d'impression <span class="trademark">PostScript</span>® qui assure une communication en
	  duplex avec l'imprimante.  Il met à jour le fichier
	  d'état de l'imprimante avec des informations
	  détaillées que cette dernière lui
	  fournit, de sorte que les utilisateurs et les
	  administrateurs puissent connaître
	  précisément l'état de l'imprimante (par
	  exemple <span class="errorname">niveau de toner bas</span> ou
	  <span class="errorname">bourrage papier</span>).  Mais plus
	  important encore, il inclut un programme nommé
	  <code class="command">psif</code> qui détecte si le travail
	  d'impression qui vient d'arriver est du texte brut et lance
	  <code class="command">textps</code> (un autre programme fourni avec
	  <code class="command">lprps</code>) pour le convertir en <span class="trademark">PostScript</span>®.
	  Il utilise alors <code class="command">lprps</code> pour envoyer le
	  travail d'impression à l'imprimante.</p><p><code class="command">lprps</code> fait partie du catalogue des
	  logiciels portés FreeBSD (lisez la section <a class="link" href="ports.html" title="Chapitre 5. Installer des applications: les logiciels pré-compilés et les logiciels portés">Le catalogue des logiciels
	  portés</a>).  Vous pouvez installer un des deux
	  logiciels portés <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/print/lprps-a4/pkg-descr">print/lprps-a4</a> et <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/print/lprps-letter/pkg-descr">print/lprps-letter</a> en fonction du
	  format de papier utilisé.  Après avoir
	  installé <code class="command">lprps</code>, précisez
	  simplement le chemin vers le programme
	  <code class="command">psif</code> qui fait partie de
	  <code class="command">lprps</code>.  Si vous avez installé
	  <code class="command">lprps</code> en recourant au catalogue des
	  logiciels portés, placez les valeurs suivantes pour
	  l'entrée de l'imprimante série <span class="trademark">PostScript</span>®
	  dans <code class="filename">/etc/printcap</code>:</p><pre class="programlisting">:if=/usr/local/libexec/psif:</pre><p>Vous devrez également renseigner le
	  paramètre <code class="literal">rw</code> qui indique à
	  <span class="application">LPD</span> de requérir
	  l'imprimante en mode lecture/écriture.</p><p>Si vous disposez d'une imprimante <span class="trademark">PostScript</span>®
	  parallèle (et ne pouvez donc pas utiliser la
	  communication en duplex avec l'imprimante dont a besoin
	  <code class="command">lprps</code>), vous pouvez recourir à la
	  procédure suivante en tant que filtre texte:</p><pre class="programlisting">#!/bin/sh
#
#  psif - Imprime du PostScript ou du texte brut sur une imprimante PostScript
#  Version script; CECI N'EST PAS la version fournie avec lprps
#  Fichier /usr/local/libexec/psif
#

IFS="" read -r first_line
first_two_chars=`expr "$first_line" : '\(..\)'`

if [ "$first_two_chars" = "%!" ]; then
    #
    #  Travail PostScript, l'imprimer.
    #
    echo "$first_line" &amp;&amp; cat &amp;&amp; printf "\004" &amp;&amp; exit 0
    exit 2
else
    #
    #  Texte brut, le convertir, puis l'imprimer.
    #
    ( echo "$first_line"; cat ) | /usr/local/bin/textps &amp;&amp; printf "\004" &amp;&amp; exit 0
    exit 2
fi</pre><p>Dans la procédure ci-dessus,
	  <code class="command">textps</code> est un programme que nous avons
	  installé séparément pour convertir du
	  texte en <span class="trademark">PostScript</span>®.  Vous pouvez recourir à
	  n'importe quel programme texte-vers-<span class="trademark">PostScript</span>®, selon
	  votre désir.  Le catalogue des logiciels
	  portés de FreeBSD (voir la section <a class="link" href="ports.html" title="Chapitre 5. Installer des applications: les logiciels pré-compilés et les logiciels portés">Le catalogue des logiciels
	  portés</a>) comprend un programme de conversion
	  texte-vers-<span class="trademark">PostScript</span>® complet nommée
	  <code class="literal">a2ps</code>, qui pourrait vous
	  intéresser.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-ps"></a>10.4.1.3. Emuler du <span class="trademark">PostScript</span>® sur les imprimantes
	  non-<span class="trademark">PostScript</span>®</h4></div></div></div><a id="idp74342224" class="indexterm"></a><a id="idp74343376" class="indexterm"></a><p><span class="trademark">PostScript</span>® est le standard <span class="emphasis"><em>de
	  fait</em></span> pour l'impression et la composition de haute
	  qualité.  Cependant, <span class="trademark">PostScript</span>® est un standard
	  <span class="emphasis"><em>onéreux</em></span>.  Heureusement, Aladdin
	  Enterprises propose un succédané gratuit de
	  <span class="trademark">PostScript</span>® nommé
	  <span class="application">Ghostscript</span> qui fonctionne sous
	  FreeBSD.  <span class="application">Ghostscript</span> peut lire la
	  majorité des fichiers <span class="trademark">PostScript</span>® et peut produire
	  leurs pages sur une diversité de
	  périphériques, incluant beaucoup de marques
	  d'imprimantes non-<span class="trademark">PostScript</span>®.  En installant
	  <span class="application">Ghostscript</span> et en recourant
	  à un filtre texte spécial, vous pouvez obtenir
	  de votre imprimante non-<span class="trademark">PostScript</span>® qu'elle se comporte
	  comme une véritable imprimante <span class="trademark">PostScript</span>®.</p><p><span class="application">Ghostscript</span> fait partie du
	  catalogue des logiciels portés, de nombreuses
	  versions sont disponibles, la version la plus couramment
	  utilisée est <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/print/ghostscript-gpl/pkg-descr">print/ghostscript-gpl</a>.</p><p>Pour émuler du <span class="trademark">PostScript</span>®, il nous faut faire
	  en sorte que le filtre texte détecte s'il imprime un
	  fichier <span class="trademark">PostScript</span>®.  Si ce n'est pas le cas, alors le
	  filtre doit passer le fichier directement à
	  l'imprimante; sinon il recourra à
	  <span class="application">Ghostscript</span> pour tout d'abord le
	  convertir dans un format que l'imprimante saura
	  interpréter.</p><p>Voici un exemple: la procédure suivante est un
	  filtre texte pour les imprimantes Hewlett Packard Deskjet
	  500.  Pour d'autres modèles, changez le
	  paramètre <code class="option">-sDEVICE</code> de la commande
	  <code class="command">gs</code>
	  (<span class="application">Ghostscript</span>).  (Entrez
	  <code class="command">gs -h</code> pour obtenir une liste des
	  périphériques reconnus par l'installation
	  actuelle de <span class="application">Ghostscript</span>).</p><pre class="programlisting">#!/bin/sh
#
#  ifhp - Imprime du PostScript émulé par Ghostscript sur une DeskJet 500
#  Fichier /usr/local/libexec/ifhp

#
#  Traite LF comme CR+LF (pour éviter l'"effet d'escalier" sur les
#  imprimantes HP/PCL):
#
printf "\033&amp;k2G" || exit 2

#
#  Lit les deux premiers caractères du fichier
#
IFS="" read -r first_line
first_two_chars=`expr "$first_line" : '\(..\)'`

if [ "$first_two_chars" = "%!" ]; then
    #
    #  Si c'est du PostScript; utiliser Ghostscript pour le convertir et l'imprimer
    #
    /usr/local/bin/gs -dSAFER -dNOPAUSE -q -sDEVICE=djet500 \
      -sOutputFile=- - &amp;&amp; exit 0
else
    #
    #  Texte brut ou HP/PCL, donc impression directe; effectuer un
    #  saut de page à la fin pour éjecter la dernière page.
    #
    echo "$first_line" &amp;&amp; cat &amp;&amp; printf "\033&amp;l0H" &amp;&amp;
exit 0
fi

exit 2</pre><p>Pour finir, vous devez communiquer à
	  <span class="application">LPD</span> le filtre utilisé en
	  positionnant le paramètre
	  <code class="literal">if</code>:</p><pre class="programlisting">:if=/usr/local/libexec/ifhp:</pre><p>Voilà.  Vous pouvez entrer <code class="command">lpr
	  texte.simple</code> et
	  <code class="filename">lpr
	  peuimporte.ps</code>, et
	  chacune des deux commandes devrait imprimer avec
	  succès.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-convfilters"></a>10.4.1.4. Filtres de conversion</h4></div></div></div><p>Après avoir mené à bien la
	  configuration basique décrite à la section
	  <a class="link" href="printing-intro-setup.html#printing-simple" title="10.3.1. Configuration simple de l'imprimante">Configuration simple de
	  l'imprimante</a>, la première chose que vous
	  souhaiterez probablement faire sera d'installer des filtres
	  de conversion pour vos formats de fichiers favoris (le
	  simple texte ASCII mis à part).</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp74364496"></a>10.4.1.4.1. Pourquoi installer des filtres de conversion?</h5></div></div></div><a id="idp74365136" class="indexterm"></a><p>Les filtres de conversion facilitent l'impression de
	    différentes sortes de fichiers.  Par exemple,
	    supposons que nous travaillions énormément
	    avec le système de composition <span class="application">TeX</span>, et que nous
	    ayons une imprimante <span class="trademark">PostScript</span>®.  Chaque fois que nous
	    générerons un fichier DVI à partir de
	    <span class="application">TeX</span>, nous ne pouvons l'imprimer directement avant
	    d'avoir converti ce fichier DVI en <span class="trademark">PostScript</span>®.  La
	    séquence de commandes serait la suivante:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>dvips seaweed-analysis.dvi</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>lpr seaweed-analysis.ps</code></strong></pre><p>En installant un filtre de conversion pour fichiers
	    DVI, nous pouvons à chaque fois nous passer de
	    l'étape de conversion manuelle en chargeant
	    <span class="application">LPD</span> de le faire à notre
	    place.  Maintenant, à chaque fois que nous avons un
	    fichier DVI, nous ne sommes plus qu'à un pas de
	    l'impression:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lpr -d seaweed-analysis.dvi</code></strong></pre><p>Nous faisons en sorte que
	    <span class="application">LPD</span> se charge de la conversion
	    du fichier DVI à notre place en positionnant
	    l'option <code class="option">-d</code>.  La section <a class="link" href="printing-using.html#printing-lpr-options-format" title="10.5.4.1. Formatting and Conversion Options">Options de
	    conversion et de formatage</a> donne la liste des
	    options de conversion.</p><p>Pour chacune des options de conversion que vous voulez
	    faire accepter par une imprimante, installez un
	    <span class="emphasis"><em>filtre de conversion</em></span> et indiquez son
	    chemin d'accès dans
	    <code class="filename">/etc/printcap</code>.  Un filtre de
	    conversion ressemble au filtre texte de notre
	    configuration de base (voir la section <a class="link" href="printing-intro-setup.html#printing-textfilter" title="10.3.1.5.6. Installer le filtre texte">Installer le filtre
	    texte</a>), à ceci près qu'au lieu
	    d'imprimer du texte brut, le filtre convertit le fichier
	    en un format compréhensible par
	    l'imprimante.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp74379856"></a>10.4.1.4.2. Quels filtres de conversion dois-je
	    installer?</h5></div></div></div><p>Vous devez installer les filtres de conversion que
	    vous vous attendez à utiliser.  Si vous imprimez
	    beaucoup de données DVI, alors un filtre de
	    conversion DVI est dans la logique des choses.  Si vous
	    devez imprimer beaucoup de troff, alors vous aurez
	    sûrement besoin d'un filtre troff.</p><p>Le tableau suivant récapitule les filtres avec
	    lesquels <span class="application">LPD</span> fonctionne, leurs
	    paramètres <code class="filename">/etc/printcap</code>, et
	    comment les invoquer avec la
	    <code class="command">lpr</code>:</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Type de fichier</th><th>paramètre <code class="filename">/etc/printcap</code>
		  </th><th>option <code class="command">lpr</code></th></tr></thead><tbody><tr><td>cifplot</td><td><code class="literal">cf</code></td><td><code class="option">-c</code></td></tr><tr><td>DVI</td><td><code class="literal">df</code></td><td><code class="option">-d</code></td></tr><tr><td>plot</td><td><code class="literal">gf</code></td><td><code class="option">-g</code></td></tr><tr><td>ditroff</td><td><code class="literal">nf</code></td><td><code class="option">-n</code></td></tr><tr><td>code FORTRAN</td><td><code class="literal">rf</code></td><td><code class="option">-f</code></td></tr><tr><td>troff</td><td><code class="literal">tf</code></td><td><code class="option">-f</code></td></tr><tr><td>image en mode point</td><td><code class="literal">vf</code></td><td><code class="option">-v</code></td></tr><tr><td>texte brut</td><td><code class="literal">if</code></td><td>aucune, <code class="option">-p</code>, or
		    <code class="option">-l</code></td></tr></tbody></table></div><p>Dans notre exemple, utiliser <code class="command">lpr -d</code>
	    veut dire que l'imprimante a besoin du paramètre
	    <code class="literal">df</code> dans l'entrée
	    <code class="filename">/etc/printcap</code> la concernant.</p><a id="idp74407504" class="indexterm"></a><p>Aussi fortement que certains puissent s'en émouvoir,
	  des formats comme le code FORTRAN ou le plot sont probablement
	  obsolètes.  Sur votre site, vous pouvez attribuer de
	  nouvelles significations à ces options ou à toute
	  autre option de formatage en installant simplement des filtres personnalisés.  Par exemple,
	  supposons que vous aimeriez imprimer des fichiers Printerleaf
	  directement (fichiers issus du programme de publication assistée par ordinateur Interleaf),
	  mais jamais de fichiers plot.  Vous pourriez alors installer un
	  filtre de conversion Printerleaf sous le paramètre
	  <code class="literal">gf</code> et ensuite informer vos
	  utilisateurs que <code class="command">lpr -g</code> veut dire
	  <span class="quote">« <span class="quote">imprimer des fichiers Printerleaf</span> »</span>.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp74409808"></a>10.4.1.4.3. Installer des filtres de conversion</h5></div></div></div><p>Etant donné que les filtres de conversion sont des
	    applications qui ne font pas partie du système FreeBSD
	    de base, vous devriez les installer dans
	    <code class="filename">/usr/local</code>.  Le répertoire
	    <code class="filename">/usr/local/libexec</code> est une destination
	    de choix, car ce sont des programmes spécialisés
	    que seul <span class="application">LPD</span> lancera; les
	    utilisateurs ordinaires ne devraient jamais avoir à
	    les lancer.</p><p>Pour activer un filtre de conversion, précisez son
	    chemin d'accès dans le paramètre relatif à
	    l'imprimante de destination dans
	    <code class="filename">/etc/printcap</code>.</p><p>Dans notre exemple, nous allons ajouter le filtre de
	    conversion DVI pour l'imprimante nommée
	    <code class="literal">bamboo</code>.  Revoici le fichier
	    <code class="filename">/etc/printcap</code> d'exemple, avec le nouveau
	    paramètre <code class="literal">df</code> pour l'imprimante
	    <code class="literal">bamboo</code>:</p><pre class="programlisting">#
#  /etc/printcap pour la machine rose - ajout du filtre df pour bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Le filtre DVI est une procédure nommée
	    <code class="filename">/usr/local/libexec/psdf</code>.  En voici le
	    contenu:</p><pre class="programlisting">#!/bin/sh
#
#  psdf - filtre DVI vers imprimante PostScript
#  Fichier /usr/local/libexec/psdf
#
# Appelé par lpd quand l'utilisateur lance lpr -d
#
exec /usr/local/bin/dvips -f | /usr/local/libexec/lprps "$@"</pre><p>Cette procédure lance <code class="command">dvips</code> en mode filtre (cela
	    correspond au paramètre <code class="option">-f</code>) sur
	    l'entrée standard, qui est le travail d'impression
	    à exécuter.  Ensuite, elle lance le filtre pour imprimante
	    <span class="trademark">PostScript</span>® <code class="command">lprps</code> (voir la section
	    <a class="link" href="printing-advanced.html#printing-advanced-if-conversion" title="10.4.1.2. Gérer les travaux d'impression de texte brut sur des imprimantes PostScript®">Gérer les
	    travaux d'impression de texte brut sur des imprimantes
	    <span class="trademark">PostScript</span>®</a>) avec les paramètres que
	    <span class="application">LPD</span> lui a passés.
	    Le programme <code class="command">lprps</code> utilisera ces paramètres pour
	    comptabiliser les pages imprimées.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp74444752"></a>10.4.1.4.4. Exemples de filtre de conversion
	    supplémentaires</h5></div></div></div><p>Il n'existe pas de procédure figée pour l'installation
	    des filtres de conversion, des exemples fonctionnels sont
	    présentés dans cette section.  Inspirez-vous de ces
	    exemples pour créer vos propres filtres.  Utilisez les
	    tels quels s'il s'avèrent adéquats.</p><p>Cet exemple présente un filtre de conversion d'image
	    en mode point (en fait un fichier GIF) pour une imprimante
	    Hewlett-Packard LaserJet III-Si:</p><pre class="programlisting">#!/bin/sh
#
#  hpvf - Convertit des fichiers GIF en HP/PCL, puis les imprime
#  Fichier /usr/local/libexec/hpvf

PATH=/usr/X11R6/bin:$PATH; export PATH
giftopnm | ppmtopgm | pgmtopbm | pbmtolj -resolution 300 \
    &amp;&amp; exit 0 \
    || exit 2</pre><p>Son fonctionnement est le suivant: il convertit le fichier
	    GIF en un format portable universel, puis en format
	    portable en niveau de gris, et ensuite
	    en bitmap portable, qu'il convertit enfin
	    en données compatibles LaserJet/PCL.</p><p>Voici le <code class="filename">/etc/printcap</code> comportant une
	    entrée pour une imprimante recourant au filtre
	    ci-dessus:</p><pre class="programlisting">#
#  /etc/printcap pour la machine orchid
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sh:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/hpif:\
        :vf=/usr/local/libexec/hpvf:</pre><p>La procédure suivante est un filtre de conversion de
	    données troff du système de composition groff pour
	    l'imprimante <span class="trademark">PostScript</span>® <code class="literal">bamboo</code>:</p><pre class="programlisting">#!/bin/sh
#
#  pstf - Convertit des données troff de groff en PS, puis imprime.
#  Fichier /usr/local/libexec/pstf
#
exec grops | /usr/local/libexec/lprps "$@"</pre><p>La procédure ci-dessus emploie de nouveau
	    <code class="command">lprps</code> pour gérer la communication
	    avec l'imprimante.  S'il s'agissait d'une imprimante sur port
	    parallèle, nous utiliserions plutôt la procédure
	    suivante:</p><pre class="programlisting">#!/bin/sh
#
#  pstf - Convertit des données troff de groff en PS, puis imprime.
#  Fichier /usr/local/libexec/pstf
#
exec grops</pre><p>C'est tout.  Voici l'entrée qu'il faut ajouter dans
	    <code class="filename">/etc/printcap</code> pour activer le filtre:</p><pre class="programlisting">:tf=/usr/local/libexec/pstf:</pre><p>Voici un exemple qui pourrait faire rougir les vieux briscards
	    de FORTRAN.  C'est un filtre de code FORTRAN pour toute
	    imprimante sachant imprimer du texte brut.  Nous l'installerons
	    pour l'imprimante <code class="literal">teak</code>:</p><pre class="programlisting">#!/bin/sh
#
# hprf - filtre texte FORTRAN pour LaserJet 3si:
# Fichier /usr/local/libexec/hprf
#

printf "\033&amp;k2G" &amp;&amp; fpr &amp;&amp; printf "\033&amp;l0H" &amp;&amp;
 exit 0
exit 2</pre><p>Et nous ajouterons cette ligne dans
	    <code class="filename">/etc/printcap</code> pour l'imprimante
	    <code class="literal">teak</code> afin d'activer le filtre:</p><pre class="programlisting">:rf=/usr/local/libexec/hprf:</pre><p>Voici un dernier exemple, quelque peu complexe.  Nous allons
	    ajouter un filtre DVI pour l'imprimante LaserJet
	    <code class="literal">teak</code> présentée ci-dessus.  Tout
	    d'abord, la partie facile: mettre à jour
	    <code class="filename">/etc/printcap</code> avec l'emplacement du
	    filtre DVI:</p><pre class="programlisting">:df=/usr/local/libexec/hpdf:</pre><p>Et maintenant, la partie difficile: écrire le filtre.
	    Pour cela, nous avons besoin d'un programme de conversion
	    DVI-vers-LaserJet/PCL.  Le catalogue des logiciels portés
	    (voyez la section <a class="link" href="ports.html" title="Chapitre 5. Installer des applications: les logiciels pré-compilés et les logiciels portés">Le catalogue des logiciels
	    portés</a>) en possède un: <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/print/dvi2xx/pkg-descr">print/dvi2xx</a>.
	    Installer ce logiciel porté nous fournira le programme
	    dont nous avons besoin, <code class="command">dvilj2p</code>, qui
	    convertit le DVI en code compatible LaserJet IIp, LaserJet III et
	    LaserJet 2000.</p><p>L'utilitaire <code class="command">dvilj2p</code> rend le filtre
	    <code class="command">hpdf</code> assez complexe, parce que
	    <code class="command">dvilj2p</code> ne sait pas lire l'entrée
	    standard.  Il lui faut un nom de fichier.  Pire encore, le nom du fichier doit se terminer par
	    <code class="filename">.dvi</code>, ce qui rend l'utilisation de
	    <code class="filename">/dev/fd/0</code> pour l'entrée standard
	    problématique.  Nous pouvons contourner cette
	    difficulté en créant un lien symbolique temporaire
	    (se terminant par <code class="filename">.dvi</code>) pointant vers
	    <code class="filename">/dev/fd/0</code>, obligeant ainsi
	    <code class="command">dvilj2p</code> à lire l'entrée
	    standard.</p><p>Le seul petit accroc restant est que nous ne pouvons pas
	    utiliser <code class="filename">/tmp</code> pour le lien temporaire.  Les
	    liens symboliques ont pour propriétaire l'utilisateur et le
	    group <code class="systemitem">bin</code>.  Le filtre est lancé sous
	    l'utilisateur <code class="systemitem">daemon</code>.  Et le bit <span class="quote">« <span class="quote">sticky</span> »</span> est
	    positionné sur le répertoire
	    <code class="filename">/tmp</code>.  Le filtre peut créer le lien,
	    mais il ne pourra pas nettoyer lorsqu'il aura fini et supprimer
	    ce lien puisqu'il appartient à un utilisateur
	    différent.</p><p>Au lieu de ça, le filtre créera le lien dans
	    le répertoire courant, qui est le répertoire
	    de la file d'attente des travaux d'impression (précisé par le paramètre
	    <code class="literal">sd</code> dans <code class="filename">/etc/printcap</code>).
	    C'est l'endroit idéal pour faire travailler les filtres,
	    particulièrement parce qu'il y a (parfois) plus d'espace
	    disque libre dans ce répertoire que
	    sous <code class="filename">/tmp</code>.</p><p>Voici, enfin, le filtre:</p><pre class="programlisting">#!/bin/sh
#
#  hpdf - Imprime des données DVI sur une imprimante HP/PCL
#  Fichier /usr/local/libexec/hpdf

PATH=/usr/local/bin:$PATH; export PATH

#
#  Définit une fonction de nettoyage de nos fichiers temporaires.  Ils prennent place
#  dans le répertoire courant, qui sera le répertoire
#  de file d'attente
#  de l'imprimante.
#
cleanup() {
   rm -f hpdf$$.dvi
}

#
#  Définit une fonction de gestion des erreurs fatales: affiche le message
#  d'erreur et retourne 2.  Ce code d'erreur de 2 indique à LPD
#  de ne pas essayer de réimprimer le travail d'impression
#
fatal() {
    echo "$@" 1&gt;&amp;2
    cleanup
    exit 2
}

#
#  Si l'utilisateur enlève le travail d'impression, LPD envoie SIGINT, donc
#  il faut capturer le signal SIGINT
#  (et quelques autres signaux) pour nettoyer après notre passage.
#
trap cleanup 1 2 15

#
#  Assurons-nous qu'il n'y ait pas conflit ce nom avec des fichiers existants.
#
cleanup

#
#  Lien du fichier DVI vers l'entrée standard (fichier à imprimer).
#
ln -s /dev/fd/0 hpdf$$.dvi || fatal "Cannot symlink /dev/fd/0"

#
#  Conversion LF = CR+LF
#
printf "\033&amp;k2G" || fatal "Cannot initialize printer"

#
#  Conversion et impression.  Le code de retour de dvilj2p ne semble
#  pas fiable: ignorons-le.
#
dvilj2p -M1 -q -e- dfhp$$.dvi

#
#  Nettoyage et sortie de la procédure
#
cleanup
exit 0</pre></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-autoconv"></a>10.4.1.4.5. Conversion automatique: une alternative aux filtres de
	    conversion</h5></div></div></div><p>Tous ces filtres de conversion apportent beaucoup à
	  votre environnement d'impression, mais nécessitent que
	  l'utilisateur précise (dans la ligne de commande
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a>) lequel utiliser.  Si vos utilisateurs ne sont pas
	  particulièrement versés en informatique,
	  préciser une option de filtre sera problématique.  Mais ce
	  qui s'avère pire encore est qu'une option de filtre mal
	  choisie peut lancer un filtre sur un type de fichier erroné
	  et causer l'impression de centaines de pages.</p><p>Plutôt que d'installer quelque filtre de conversion
	  que ce soit, vous préférerez sans doute laisser
	  le filtre texte (puisque c'est le filtre par défaut)
	  déterminer le type de fichier qu'on lui a demandé
	  d'imprimer et lancer automatiquement le filtre de conversion
	  approprié.  Des outils comme <code class="command">file</code>
	  peuvent s'avérer utiles dans ce cas.  Bien entendu, il sera
	  difficile d'établir les différences entre
	  <span class="emphasis"><em>certains</em></span> types de fichiers&#8212;et vous
	  pouvez toujours, bien sûr, fournir des filtres de conversion
	  uniquement pour eux.</p><a id="idp74486480" class="indexterm"></a><a id="idp74486992" class="indexterm"></a><p>Le catalogue des logiciels portés FreeBSD contient un
	    filtre texte, nommé <code class="command">apsfilter</code>
	    (<a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/print/apsfilter/pkg-descr">print/apsfilter</a>), qui
	    sait effectuer la conversion automatique.  Il peut
	    reconnaître le texte brut, le <span class="trademark">PostScript</span>® les
	    fichiers DVI et quasiment n'importe quelle sorte de
	    fichier, effectuer les conversions appropriées et
	    imprimer.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-of"></a>10.4.1.5. Filtres de sortie</h4></div></div></div><p>Le gestionnaire d'impression
	  <span class="application">LPD</span> reconnaît un autre
	  type de filtre dont nous n'avons pas
	  encore discuté: le filtre de sortie.  Un filtre de
	  sortie est destiné à l'impression de texte brut
	  seulement, comme le filtre texte, mais avec de nombreuses
	  simplifications.  Si vous utilisez un filtre de sortie mais pas
	  de filtre texte, alors:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="application">LPD</span> lance un filtre de sortie
	      une seule fois par travail d'impression, au lieu d'une fois
	      pour chacun des fichiers du travail d'impression.</p></li><li class="listitem"><p><span class="application">LPD</span> ne fournit rien pour
	      permettre au filtre de sortie de
	      repérer le début ou la fin des fichiers du
	      travail d'impression.</p></li><li class="listitem"><p><span class="application">LPD</span> ne passe pas le nom de
	      l'utilisateur ou le nom de la machine au filtre, qui n'est
	      donc pas prévu pour effectuer la
	      comptabilisation de l'impression.  En fait, il ne
	      reçoit que deux paramètres:</p><div class="cmdsynopsis"><p><code class="command">nom-du-filtre</code>  -w<em class="replaceable"><code>largeur</code></em>   -l<em class="replaceable"><code>hauteur</code></em> </p></div><p>Où <em class="replaceable"><code>largeur</code></em> provient du
	      paramètre <code class="literal">pw</code> et
	      <em class="replaceable"><code>hauteur</code></em> du paramètre
	      <code class="literal">pl</code> de l'entrée
	      <code class="filename">/etc/printcap</code> pour l'imprimante en
	      question.</p></li></ul></div><p>Ne vous laissez pas séduire par la simplicité
	  d'un filtre de sortie.  Si vous désirez que chaque fichier
	  d'un travail d'impression commence sur une page différente,
	  un filtre de sortie <span class="emphasis"><em>ne conviendra pas</em></span>.
	  Utilisez un filtre texte (également appelé filtre
	  d'entrée); voir la section <a class="link" href="printing-intro-setup.html#printing-textfilter" title="10.3.1.5.6. Installer le filtre texte">Installer le filtre texte</a>.  De
	  plus, le filtre de sortie se révèle en fait
	  <span class="emphasis"><em>plus complexe</em></span> en ce sens qu'il doit examiner
	  le flux d'octets qui lui est envoyé pour y rechercher
	  des caractères spéciaux et qu'il
	  doit s'envoyer à lui-même des signaux comme s'ils
	  provenaient de <span class="application">LPD</span>.</p><p>Toutefois, un filtre de sortie s'avère
	  <span class="emphasis"><em>nécessaire</em></span> si vous désirez des
	  pages d'en-tête et avez besoin d'envoyer des séquences
	  d'échappement ou d'autres chaînes d'initialisation
	  afin de pouvoir imprimer la page d'en-tête.  (Mais il est
	  également <span class="emphasis"><em>futile</em></span> si vous voulez imputer
	  les pages d'en-tête au compte de l'utilisateur, puisque
	  <span class="application">LPD</span> ne livre pas d'information
	  sur l'utilisateur ou la machine au filtre de sortie).</p><p>Sur une seule imprimante, <span class="application">LPD</span>
	  permet à la fois un filtre de sortie et des filtres texte ou
	  autres.  Dans de tels cas, <span class="application">LPD</span> ne lancera
	  le filtre de sortie que pour imprimer la page d'en-tête
	  (consultez la section <a class="link" href="printing-advanced.html#printing-advanced-header-pages" title="10.4.2. Pages d'en-tête">Pages
	  d'en-tête</a>).  <span class="application">LPD</span> attend
	  alors que le filtre de sortie <span class="emphasis"><em>s'arrête
	  par lui-même</em></span> en envoyant deux octets au filtre: ASCII 031 suivi
	  d'ASCII 001.  Lorsqu'un filtre de sortie lit ces deux octets
	  (031,001), il devrait s'arrêter en s'envoyant à
	  lui-même un <code class="literal">SIGSTOP</code>.  Lorsque
	  <span class="application">LPD</span> a fini d'exécuter les
	  autres filtres, il relance le filtre de sortie en lui envoyant
	  un <code class="literal">SIGCONT</code>.</p><p>S'il y a un filtre de sortie mais <span class="emphasis"><em>aucun</em></span>
	  filtre texte et que <span class="application">LPD</span> s'occupe
	  d'un travail d'impression concernant du texte brut, alors
	  <span class="application">LPD</span> utilise le filtre de sortie pour
	  réaliser ce travail d'impression.  Comme exposé
	  plus haut, le filtre de sortie imprimera chacun des travaux
	  d'impression séquentiellement sans que des sauts de page
	  ou autres formes d'avancement du
	  papier ne surviennent, et ce n'est vraisemblablement
	  <span class="emphasis"><em>pas</em></span> ce que vous désirez.  Dans
	  presque tous les cas, il vous faut un filtre texte.</p><p>Le programme <code class="command">lpf</code>, que nous avons
	  présenté précédemment comme un filtre texte, peut
	  également fonctionner en tant que filtre de sortie.  Si
	  vous avez besoin d'un filtre de sortie vite-fait-bien-fait mais
	  ne voulez pas écrire le code d'examen d'octets et d'envoi
	  de signal, essayez <code class="command">lpf</code>.  Vous pouvez
	  également inclure <code class="command">lpf</code> dans une procédure
	  pour prendre en charge tout code d'initialisation qui pourrait
	  être requis par l'imprimante.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-lpf"></a>10.4.1.6. <code class="command">lpf</code>: un filtre texte</h4></div></div></div><p>Le programme <code class="filename">/usr/libexec/lpr/lpf</code> qui
	  est fourni avec la distribution binaire FreeBSD est un filtre texte
	  (un filtre d'entrée) qui sait indenter la sortie (un
	  travail d'impression soumis avec <code class="command">lpr -i</code>),
	  laisse passer les caractères littéraux (travail
	  d'impression soumis avec <code class="command">lpr -l</code>), ajuste la
	  position d'impression des retours arrière et des
	  tabulations dans le travail d'impression, et comptabilise les
	  pages imprimées.  Il peut également servir
	  de filtre de sortie.</p><p>Le filtre <code class="command">lpf</code> convient à de nombreux
	  environnements d'impression.  Et bien qu'il ne puisse pas envoyer de
	  séquences d'initialisation à une imprimante, il est
	  aisé d'écrire une procédure pour effectuer
	  l'initialisation nécessaire et ensuite exécuter
	  <code class="command">lpf</code>.</p><a id="idp74556112" class="indexterm"></a><a id="idp74556624" class="indexterm"></a><p>Afin que <code class="command">lpf</code> mène à bien la
	  comptabilisation des pages, il faut que des valeurs correctes
	  soient indiquées pour les paramètres
	  <code class="literal">pw</code> et <code class="literal">pl</code> dans le fichier
	  <code class="filename">/etc/printcap</code>.  Il utilise ces valeurs pour
	  déterminer combien de texte peut être imprimé
	  sur une page et combien de pages ont été
	  imprimées dans le travail d'impression d'un utilisateur.
	  Pour plus d'informations sur la comptabilisation de l'impression,
	  lisez la section
	  <a class="link" href="printing-advanced.html#printing-advanced-acct" title="10.4.5. Comptabiliser l'utilisation de l'imprimante">Comptabiliser l'utilisation
	    de l'imprimante</a>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages"></a>10.4.2. Pages d'en-tête</h3></div></div></div><p>Si vous avez <span class="emphasis"><em>beaucoup</em></span> d'utilisateurs, et
        que tous utilisent des imprimantes diverses, alors vous allez
	certainement envisager les <span class="emphasis"><em>pages
	d'en-tête</em></span> comme un mal nécessaire.</p><a id="idp74562512" class="indexterm"></a><a id="idp74563664" class="indexterm"></a><p>Les pages d'en-tête, également appelées
        <span class="emphasis"><em>bannières</em></span> ou
	<span class="emphasis"><em>burst page</em></span>, identifient à qui
	appartiennent les travaux d'impression après qu'ils
	aient été imprimés.  Elles sont en
	général imprimées en caractères de
	grande taille et en gras, peuvent comporter des bordures
	décorées, de sorte qu'elles contrastent dans
	une pile d'impressions avec les véritables documents formant
	les travaux d'impression des utilisateurs.  Elles leur permettent
	de retrouver facilement leurs travaux d'impression.
	L'inconvénient majeur d'une page d'en-tête est qu'elle
	représente une page supplémentaire à
	imprimer pour chacun des travaux d'impression, son utilité
	éphémère ne dépasse pas quelques
	minutes, et elle termine au recyclage du papier ou dans une corbeille.
	(Notez que une page d'en-tête est liée à chaque
	travail d'impression et non à chaque fichier dans un travail
	d'impression: il se pourrait donc que le gâchis de papier ne
	soit pas si grand.)</p><p>Le système <span class="application">LPD</span> peut fournir
        des pages d'en-tête automatiquement pour vos impressions
	<span class="emphasis"><em>si</em></span> votre imprimante sait imprimer directement du texte
	brut.  Si vous disposez d'une imprimante <span class="trademark">PostScript</span>®,
	il vous faudra un programme externe pour générer la
	page d'en-tête; lisez la section <a class="link" href="printing-advanced.html#printing-advanced-header-pages-ps" title="10.4.2.4. Les pages d'en-tête sur les imprimantes PostScript®">Les pages d'en-tête
	sur les imprimantes <span class="trademark">PostScript</span>®</a>.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages-enabling"></a>10.4.2.1. Activer les pages d'en-tête</h4></div></div></div><p>Dans la section <a class="link" href="printing-intro-setup.html#printing-simple" title="10.3.1. Configuration simple de l'imprimante">Configuration
	    simple de l'imprimante</a>, nous avons désactivé
	    les pages d'en-tête en positionnant le paramètre
	    <code class="literal">sh</code> (ce qui signifie <span class="quote">« <span class="quote">suppress
	    header</span> »</span>, soit <span class="quote">« <span class="quote">suppression des
	    en-têtes</span> »</span>) dans <code class="filename">/etc/printcap</code>.
	    Pour activer les pages d'en-tête sur une imprimante, il
	    suffit d'enlever ce paramètre
	    <code class="literal">sh</code>.</p><p>Cela semble trop facile, n'est-ce pas?</p><p>C'est vrai.  Il se <span class="emphasis"><em>pourrait</em></span> que vous
	    ayez à fournir un filtre de sortie pour envoyer des
	    chaînes d'initialisation à l'imprimante.  Voici
	    un exemple de filtre sortie pour les imprimantes Hewlett-Packard
	    compatibles-PCL:</p><pre class="programlisting">#!/bin/sh
#
#  hpof - filtre de sortie pour les imprimantes Hewlett Packard compatibles PCL
#  Fichier /usr/local/libexec/hpof

printf "\033&amp;k2G" || exit 2
exec /usr/libexec/lpr/lpf</pre><p>Spécifiez le chemin d'accès au filtre de
	    sortie avec le paramètre <code class="literal">of</code>.  Lisez
	    la section <a class="link" href="printing-advanced.html#printing-advanced-of" title="10.4.1.5. Filtres de sortie">Filtres de
	    sortie</a> pour plus de détails.</p><p>Voici un fichier <code class="filename">/etc/printcap</code>
	    d'exemple pour l'imprimante <code class="literal">teak</code> que nous
	    avons présentée plus haut; nous avons activé
	    les pages d'en-tête et ajouté le fichier de sortie
	    ci-dessus:</p><pre class="programlisting">#
#  /etc/printcap pour la machine orchid
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/hpif:\
        :vf=/usr/local/libexec/hpvf:\
        :of=/usr/local/libexec/hpof:</pre><p>Désormais, lorsque les utilisateurs lancent des
	    travaux d'impression avec <code class="literal">teak</code>, ils obtiennent
	    une page d'en-tête avec chaque travail d'impression.  Si
	    vos utilisateurs désirent perdre du temps à
	    rechercher leurs impressions, ils peuvent omettre la page
	    d'en-tête en soumettant le travail d'impression avec la
	    commande <code class="command">lpr -h</code>; lisez la section
	    <a class="link" href="printing-using.html#printing-lpr-options-misc" title="10.5.4.3. Header Page Options">Options des pages
	    d'en-tête</a> pour connaître plus d'options
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml"><span class="application">LPD</span> imprime un
	      caractère de saut de page après une
	      page d'en-tête.  Si votre imprimante utilise un
	      autre caractère ou séquence de
	      caractères différente pour éjecter une page,
	      précisez-le avec le paramètre
	      <code class="literal">ff</code> dans
	      <code class="filename">/etc/printcap</code>.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages-controlling"></a>10.4.2.2. Contrôle des pages d'en-tête</h4></div></div></div><p>Une fois les pages d'en-tête activées,
	    <span class="application">LPD</span> produira un <span class="emphasis"><em>en-tête
	    long</em></span>, c'est à dire une page entière de
	    grands caractères identifiant l'utilisateur, le nom
	    de la machine et le travail d'impression.  Voici un exemple
	    (<code class="systemitem">kelly</code> a lancé le travail d'impression nommé
	    <span class="quote">« <span class="quote">outline</span> »</span> depuis la machine <code class="systemitem">rose</code>):</p><pre class="programlisting">      k                   ll       ll
      k                    l        l
      k                    l        l
      k   k     eeee       l        l     y    y
      k  k     e    e      l        l     y    y
      k k      eeeeee      l        l     y    y
      kk k     e           l        l     y    y
      k   k    e    e      l        l     y   yy
      k    k    eeee      lll      lll     yyy y
                                               y
                                          y    y
                                           yyyy


                                   ll
                          t         l        i
                          t         l
       oooo    u    u   ttttt       l       ii     n nnn     eeee
      o    o   u    u     t         l        i     nn   n   e    e
      o    o   u    u     t         l        i     n    n   eeeeee
      o    o   u    u     t         l        i     n    n   e
      o    o   u   uu     t  t      l        i     n    n   e    e
       oooo     uuu u      tt      lll      iii    n    n    eeee









      r rrr     oooo     ssss     eeee
      rr   r   o    o   s    s   e    e
      r        o    o    ss      eeeeee
      r        o    o      ss    e
      r        o    o   s    s   e    e
      r         oooo     ssss     eeee







                                              Job:  outline
                                              Date: Sun Sep 17 11:04:58 1995</pre><p><span class="application">LPD</span> ajoute un saut de page
	    à ce texte de sorte que le travail d'impression commence
	    sur une nouvelle page (à moins que <code class="literal">sf</code>
	    (supprimer les sauts de page) ne soit dans l'entrée correspondant
	    à l'imprimante dans <code class="filename">/etc/printcap</code>).</p><p>Si vous préférez, <span class="application">LPD</span> peut
	    générer des <span class="emphasis"><em>en-tête courts</em></span>; ajoutez
	    le paramètre <code class="literal">sb</code> (en-tête court) dans le
	    fichier <code class="filename">/etc/printcap</code>. La
	    page d'en-tête ressemblera à ceci:</p><pre class="programlisting">rose:kelly  Job: outline  Date: Sun Sep 17 11:07:51 1995</pre><p>Par défaut également,
	    <span class="application">LPD</span> imprime d'abord la page
	    d'en-tête, puis le travail d'impression.  Pour inverser ce
	    comportement, placez le paramètre <code class="literal">hl</code>
	    (en-tête à la fin) dans <code class="filename">/etc/printcap</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages-accounting"></a>10.4.2.3. Comptabiliser les pages d'en-tête</h4></div></div></div><p>Utiliser les pages d'en-tête fournies par
	    <span class="application">LPD</span> provoque un comportement
	    particulier lorsqu'il s'agit de comptabiliser l'utilisation de
	    l'imprimante: les pages d'en-tête doivent être
	    <span class="emphasis"><em>gratuites</em></span>.</p><p>Pourquoi?</p><p>Parce que le filtre de sortie est le seul programme externe
	    pouvant tenir les comptes qui aura le contrôle lors de
	    l'impression de la page d'en-tête, et qu'aucune
	    information sur <span class="emphasis"><em>l'utilisateur ou le nom
	    de la machine</em></span> ne lui est donnée ni aucun
	    fichier de comptabilisation, par conséquent il ne sait
	    pas à qui attribuer le coût de l'utilisation
	    de l'imprimante.  Il ne suffit pas non plus de
	    simplement <span class="quote">« <span class="quote">ajouter une page</span> »</span> au filtre
	    texte ou un quelconque filtre de conversion (qui, eux,
	    possèdent des informations sur l'utilisateur et la
	    machine) puisque les utilisateurs peuvent supprimer les
	    pages d'en-tête avec <code class="command">lpr -h</code>.  Ils
	    pourraient toujours se voir imputer des pages d'en-tête
	    qu'ils n'auraient pas imprimées.  En somme,
	    <code class="command">lpr -h</code> demeurera l'option favorite des
	    utilisateurs soucieux de l'environnement, mais vous ne pouvez
	    aucunement les inciter à l'utiliser.</p><p>Il ne <span class="emphasis"><em>suffit pas non plus</em></span> de
	    laisser chacun des filtres générer ses propres
	    pages d'en-tête (ce qui permettrait de savoir à
	    qui imputer les coûts).  Si les utilisateurs
	    désiraient omettre les pages d'en-tête avec
	    <code class="command">lpr -h</code>, ils les obtiendraient quand
	    même et le coût leur serait attribué puisque
	    <span class="application">LPD</span> ne donne aucun renseignement sur
	    l'emploi de l'option <code class="option">-h</code> à aucun des
	    filtres.</p><p>Alors, quelles sont les options à votre disposition?</p><p>Vous pouvez:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Accepter le comportement de
	        <span class="application">LPD</span> et la gratuité des pages
		d'en-tête.</p></li><li class="listitem"><p>Installer une alternative à
	        <span class="application">LPD</span>, comme
		<span class="application">LPRng</span>.  La section
		<a class="link" href="printing-lpd-alternatives.html" title="10.6. Alternatives to the Standard Spooler ** Traduction en Cours **">Alternatives au
		gestionnaire d'impression standard</a> en
		dit plus au sujet des autres gestionnaires
		d'impression qui peuvent être
		substitués à
		<span class="application">LPD</span>.</p></li><li class="listitem"><p>Ecrire un filtre de sortie
	        <span class="emphasis"><em>intelligent</em></span>.  Normalement, un filtre de
		sortie n'est pas censé faire plus que d'initialiser
		une imprimante ou exécuter une conversion simple de
		caractères.  Il convient aux pages d'en-tête
		et aux travaux d'impression de texte brut (lorsqu'il n'y
		a aucun filtre (d'entrée) texte).  Mais, s'il
		existe un filtre texte pour les travaux d'impression de texte, alors <span class="application">LPD</span> ne lancera
		le filtre de sortie que pour les pages d'en-tête.  Le
		filtre de sortie peut également analyser le texte
		de la page d'en-tête généré par
		<span class="application">LPD</span> pour déterminer quels
		sont l'utilisateur et la machine à qui il faut
		attribuer le coût de cette page d'en-tête.  Le
		seul autre problème avec cette méthode est
		que le filtre de sortie ne sait toujours pas quel fichier
		de comptabilisation utiliser (le nom du fichier
		spécifié par le paramètre
		<code class="literal">af</code> ne lui est pas fourni), mais si vous
		disposez d'un fichier de comptabilisation bien
		identifié, vous pouvez le coder en dur dans le
		filtre de sortie.  Afin de faciliter l'étape d'analyse,
		utilisez le paramètre <code class="literal">sh</code>
		(en-tête courte) dans <code class="filename">/etc/printcap</code>.  D'un
		autre côté, tout cela pourrait bien
		représenter beaucoup de dérangement, et les
		utilisateurs apprécieront certainement davantage
		l'administrateur généreux qui propose la
		gratuité des pages d'en-tête.</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages-ps"></a>10.4.2.4. Les pages d'en-tête sur les imprimantes
	    <span class="trademark">PostScript</span>®</h4></div></div></div><p>Comme décrit précédemment,
	    <span class="application">LPD</span> est en mesure de
	    générer des pages d'en-tête texte convenant
	    pour de nombreuses d'imprimantes.  Bien entendu, <span class="trademark">PostScript</span>®
	    ne peut pas imprimer du texte directement, donc la
	    fonctionnalité de page d'en-tête offerte par
	    <span class="application">LPD</span> est inutilisable ou presque.</p><p>Une solution manifeste est de faire générer
	    la page d'en-tête par tous les filtres de conversion et
	    le filtre texte.  Les filtres devraient employer les
	    paramètres utilisateur et nom de machine pour
	    générer une page d'en-tête convenable.
	    L'inconvénient de cette méthode est que les
	    utilisateurs obtiendront toujours une page d'en-tête,
	    même s'ils soumettent leurs travaux d'impression avec
	    <code class="command">lpr -h</code>.</p><p>Examinons cette méthode.  La procédure ci-dessous prend
	    trois paramètres (le nom de l'utilisateur, le nom
	    de la machine et celui du travail d'impression) et
	    réalise une page d'en-tête simple en <span class="trademark">PostScript</span>®:</p><pre class="programlisting">#!/bin/sh
#
#  make-ps-header - génére une page d'en-tête PostScript sur la sortie standard
#  Fichier /usr/local/libexec/make-ps-header
#

#
#  Ce sont des unités PostScript (72 par pouce).  A modifier pour A4 ou
#  tout autre format papier employé:
#
page_width=612
page_height=792
border=72

#
#  Vérification des paramètres
#
if [ $# -ne 3 ]; then
    echo "Usage: `basename $0` &lt;user&gt; &lt;host&gt; &lt;job&gt;" 1&gt;&amp;2
    exit 1
fi

#
#  Mémorisation des paramètres, pour la lisibilité du PostScript, plus bas.
#
user=$1
host=$2
job=$3
date=`date`

#
#  Envoi du code PostScript sur stdout.
#
exec cat &lt;&lt;EOF
%!PS

%
%  Assurons-nous qu'il n'y a pas d'interférence avec le travail
%  utilisateur qui suivra
%
save

%
%  Applique une grosse bordure désagréable autour
%  du bord de la page.
%
$border $border moveto
$page_width $border 2 mul sub 0 rlineto
0 $page_height $border 2 mul sub rlineto
currentscreen 3 -1 roll pop 100 3 1 roll setscreen
$border 2 mul $page_width sub 0 rlineto closepath
0.8 setgray 10 setlinewidth stroke 0 setgray

%
%  Affiche le nom de l'utilisateur, de façon jolie, grande et proéminente
%
/Helvetica-Bold findfont 64 scalefont setfont
$page_width ($user) stringwidth pop sub 2 div $page_height 200 sub moveto
($user) show

%
%  Maintenant, les détails ennuyant:
%
/Helvetica findfont 14 scalefont setfont
/y 200 def
[ (Job:) (Host:) (Date:) ] {
200 y moveto show /y y 18 sub def }
forall

/Helvetica-Bold findfont 14 scalefont setfont
/y 200 def
[ ($job) ($host) ($date) ] {
        270 y moveto show /y y 18 sub def
} forall

%
% C'est tout
%
restore
showpage
EOF</pre><p>Désormais, chacun des filtres de conversion et le
	    filtre texte peuvent appeler cette procédure pour d'abord
	    générer la page d'en-tête, et ensuite imprimer
	    le travail d'impression de l'utilisateur.  Voici le filtre
	    de conversion DVI déjà mentionné plus
	    haut dans ce document, modifié afin de
	    générer une page d'en-tête:</p><pre class="programlisting">#!/bin/sh
#
#  psdf - filtre DVI vers imprimante PostScript
#  Fichier /usr/local/libexec/psdf
#
#  Appelé par lpd quand l'utilisateur lance lpr -d
#

orig_args="$@"

fail() {
    echo "$@" 1&gt;&amp;2
    exit 2
}

while getopts "x:y:n:h:" option; do
    case $option in
        x|y)  ;; # Ignore
        n)    login=$OPTARG ;;
        h)    host=$OPTARG ;;
        *)    echo "LPD started `basename $0` wrong." 1&gt;&amp;2
              exit 2
              ;;
    esac
done

[ "$login" ] || fail "Pas de nom d'utilisateur"
[ "$host" ] || fail "PAs de nom de machine"

( /usr/local/libexec/make-ps-header $login $host "DVI File"
  /usr/local/bin/dvips -f ) | eval /usr/local/libexec/lprps $orig_args</pre><p>Observez que le filtre doit analyser la liste des
	    paramètres pour déterminer le nom de l'utilisateur et
	    celui de la machine.  L'analyse menée par les autres
	    filtres de conversion est identique.  Toutefois, le filtre
	    texte réclame un ensemble de paramètres
	    légèrement différent (voyez la section
	    <a class="link" href="printing-advanced.html#printing-advanced-filters" title="10.4.1.1. Fonctionnement des filtres">Fonctionnement
	    des filtres</a>).</p><p>Comme précédemment exposé, cette solution,
	    quoique relativement simple, invalide l'option de
	    <span class="quote">« <span class="quote">suppression de page d'en-tête</span> »</span> (l'option
	    <code class="option">-h</code>) de <code class="command">lpr</code>.  Si les
	    utilisateurs désiraient épargner la vie d'un
	    arbre (ou économiser quelques centimes, si vous faites
	    payer les pages d'en-tête), ils ne seraient pas en
	    mesure de le faire, puisque chaque filtre va imprimer une page
	    d'en-tête avec chaque travail d'impression.</p><p>Pour permettre aux utilisateurs de désactiver les
	    pages d'en-tête en fonction du travail d'impression,
	    il vous faudra recourir à l'une
	    des astuces de la section <a class="link" href="printing-advanced.html#printing-advanced-header-pages-accounting" title="10.4.2.3. Comptabiliser les pages d'en-tête">Comptabiliser
	      les pages d'en-tête</a>: écrire un filtre de
	    sortie qui analyse la page d'en-tête
	    générée par LPD et produit une version
	    <span class="trademark">PostScript</span>®.  Si l'utilisateur soumet le travail d'impression
	    avec <code class="command">lpr -h</code> alors ni
	    <span class="application">LPD</span> ni votre filtre de sortie ne
	    généreront de page d'en-tête.  Sinon, votre
	    filtre de sortie lira le texte en provenance de <span class="application">LPD</span>
	    et enverra la page d'en-tête <span class="trademark">PostScript</span>® appropriée
	    à l'imprimante.</p><p>Si vous disposez d'une imprimante <span class="trademark">PostScript</span>® sur une
	    interface série, vous pouvez utiliser
	    <code class="command">lprps</code>, qui est livré avec un filtre
	    de sortie, <code class="command">psof</code>, qui réalise ce que
	    nous venons d'exposer ci-dessus.  Notez que
	    <code class="command">psof</code> n'assume pas la tenue de comptes pour
	    les pages d'en-tête.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-network-printers"></a>10.4.3. Imprimer via un réseau</h3></div></div></div><a id="idp74667600" class="indexterm"></a><a id="idp74668752" class="indexterm"></a><p>FreeBSD gère l'impression via un réseau: c'est
        à dire en envoyant les travaux d'impression à des
	imprimantes distantes.  L'impression via un réseau
	désigne deux choses différentes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Accéder à une imprimante connectée
	    à une machine distante.  Vous installez une imprimante
	    disposant d'une interface conventionnelle, série ou
	    parallèle, sur une machine.  Puis vous configurez
	    <span class="application">LPD</span> pour permettre l'accès
	    à l'imprimante depuis d'autres machines du
	    réseau.  La section <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Imprimantes installées sur des machines distantes">Imprimantes
	      installées sur des machines distantes</a> en
	    détaillera la mise en &#339;uvre.</p></li><li class="listitem"><p>Accéder à une imprimante directement
	    connectée au réseau.  L'imprimante dispose d'une
	    interface réseau en plus (ou à la place)
	    d'interfaces plus conventionnelles, série ou
	    parallèle.  Une imprimante de ce genre peut fonctionner
	    ainsi:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Elle peut comprendre le protocole <span class="application">LPD</span>
	        et sait même gérer une file d'attente de travaux
		d'impression provenant de machines distantes.  En ce cas,
		elle se comporte comme une machine normale qui
		exécuterait <span class="application">LPD</span>.  Suivez
		la même procédure que celle exposée
		à la section <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Imprimantes installées sur des machines distantes">Imprimantes
		  installées sur des machines distantes</a> afin
		de configurer une imprimante de ce genre.</p></li><li class="listitem"><p>Elle peut savoir gérer un flux de données au
	        travers d'une connexion réseau.  Dans ce cas, vous
		pouvez <span class="quote">« <span class="quote">attacher</span> »</span> l'imprimante à l'une
		des machines du réseau en la rendant responsable
		de la gestion de la file d'impression et de l'envoi des
		travaux d'impression à l'imprimante.  La section
		<a class="link" href="printing-advanced.html#printing-advanced-network-net-if" title="10.4.3.2. Imprimantes avec des interfaces utilisant des flux réseau">Imprimantes
		  avec des interfaces utilisant des flux réseau</a>
		donne quelque indications sur l'installation d'imprimantes de ce
		type.</p></li></ul></div></li></ul></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-network-rm"></a>10.4.3.1. Imprimantes installées sur des machines
	  distantes</h4></div></div></div><p>Le gestionnaire d'impression <span class="application">LPD</span>
	  dispose des fonctions pour gérer l'envoi des travaux d'impression à
	  d'autres machines exécutant également
	  <span class="application">LPD</span> (ou un système qui lui
	  est compatible).  Cette fonctionnalité vous permet
	  d'installer une imprimante sur une machine, puis de
	  la rendre accessible depuis les autres
	  machines.  Cela fonctionne également avec les imprimantes
	  disposant d'interfaces réseau comprenant le protocole
	  <span class="application">LPD</span>.</p><p>Pour activer ce type d'impression à distance, installez
	  d'abord une imprimante sur une machine, qui sera
	  <span class="emphasis"><em>la machine d'impression</em></span>, en suivant les
	  instructions de configuration basique décrites à la
	  section <a class="link" href="printing-intro-setup.html#printing-simple" title="10.3.1. Configuration simple de l'imprimante">Configuration simple de
	    l'imprimante</a>.  Réalisez toute étape de
	  la <a class="link" href="printing-advanced.html" title="10.4. Configuration avancée de l'imprimante">configuration avancée
	    de l'imprimante</a> dont vous pourriez avoir besoin.  Veillez à
	  tester
	  l'imprimante et vérifiez qu'elle fonctionne avec les
	  paramètres de <span class="application">LPD</span> que vous avez
	  activés.  Assurez-vous également que
	  <span class="emphasis"><em>la machine locale</em></span> est autorisée à
	  utiliser le service <span class="application">LPD</span> sur
	  <span class="emphasis"><em>la machine distante</em></span> (lisez la section
	  <a class="link" href="printing-advanced.html#printing-advanced-restricting-remote" title="10.4.4.4. Restreindre les impressions à distance">Restreindre
	    les impressions à distance</a>).</p><a id="idp74712016" class="indexterm"></a><a id="idp74713168" class="indexterm"></a><p>Si vous utilisez une imprimante avec une interface
	  réseau qui est compatible avec
	  <span class="application">LPD</span>, alors <span class="emphasis"><em>la machine
	    d'impression</em></span> dans le texte ci-dessous est
	  l'imprimante elle-même, et le <span class="emphasis"><em>nom de
	    l'imprimante</em></span> est le nom que vous avez
	  paramétré pour l'imprimante.  Lisez la documentation
	  livrée avec votre imprimante ou l'interface
	  réseau-imprimante.</p><div xmlns="" class="tip"><h3 class="admontitle">Astuce: </h3><p xmlns="http://www.w3.org/1999/xhtml">Si vous utilisez une Hewlett Packard Laserjet, alors le
	    nom d'imprimante <code class="literal">text</code> réalisera
	    la conversion LF en CRLF automatiquement, de sorte que vous
	    n'aurez pas besoin de la procédure <code class="filename">hpif</code>.</p></div><p>Ensuite, sur les autres machines pour lesquelles vous
	  désirez autoriser l'accès à l'imprimante,
	  créez une ligne dans leur
	  <code class="filename">/etc/printcap</code> avec les paramètres
	  suivants:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Nommez cette entrée comme vous le voulez.  Par
	      souci de simplicité, cependant, vous
	      préférerez certainement employer les
	      mêmes nom et alias que ceux utilisés sur
	      la machine de d'impression.</p></li><li class="listitem"><p>Laissez le paramètre <code class="literal">lp</code>
	    non-renseigné,
	      de manière explicite (<code class="literal">:lp=:</code>).</p></li><li class="listitem"><p>Créez un répertoire de file d'impression et
	      indiquez son chemin d'accès dans le paramètre
	      <code class="literal">sd</code>.  C'est là où
	      <span class="application">LPD</span> entreposera les travaux
	      d'impression avant leur envoi vers la machine
	      d'impression.</p></li><li class="listitem"><p>Indiquez le nom de la machine d'impression avec le paramètre
	      <code class="literal">rm</code>.</p></li><li class="listitem"><p>Placez le nom de l'imprimante sur <span class="emphasis"><em>la
	      machine d'impression</em></span> dans le paramètre
	      <code class="literal">rp</code>.</p></li></ol></div><p>C'est tout.  Il n'est pas nécessaire de préciser
	  la liste des filtres de conversion, les dimensions de la page,
	  ou quoique ce soit d'autre dans le fichier
	  <code class="filename">/etc/printcap</code>.</p><p>Voici un exemple.  La machine <code class="systemitem">rose</code> dispose
	  de deux imprimantes, <code class="literal">bamboo</code> et
	  <code class="literal">rattan</code>.  Nous allons permettre aux utilisateurs
	  de la machine <code class="systemitem">orchid</code> d'imprimer avec ces
	  imprimantes.
	  Voici le fichier <code class="filename">/etc/printcap</code> pour
	  <code class="systemitem">orchid</code> (apparu dans la section
	  <a class="link" href="printing-advanced.html#printing-advanced-header-pages-enabling" title="10.4.2.1. Activer les pages d'en-tête">Activer
	    les pages d'en-tête</a>).  Il contenait
	  déjà une entrée pour l'imprimante
	  <code class="literal">teak</code>; nous avons ajouté celles pour
	  les deux imprimantes sur la machine <code class="systemitem">rose</code>:</p><pre class="programlisting">#
#  /etc/printcap pour la machine orchid - ajout d'imprimantes (distantes)
#    sur rose
#

#
#  teak est locale; connectée directement à orchid:
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/ifhp:\
        :vf=/usr/local/libexec/vfhp:\
        :of=/usr/local/libexec/ofhp:

#
#  rattan est connectée à rose; envoie les travaux pour rattan
#    à rose:
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :lp=:rm=rose:rp=rattan:sd=/var/spool/lpd/rattan:

#
#  bamboo est également connectée à rose:
#
bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :lp=:rm=rose:rp=bamboo:sd=/var/spool/lpd/bamboo:</pre><p>Ensuite, nous n'avons qu'à créer les
	  répertoires de file d'impression sur
	  <code class="systemitem">orchid</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir -p /var/spool/lpd/rattan /var/spool/lpd/bamboo</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chmod 770 /var/spool/lpd/rattan /var/spool/lpd/bamboo</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chown daemon:daemon /var/spool/lpd/rattan /var/spool/lpd/bamboo</code></strong></pre><p>Maintenant les utilisateurs d'<code class="systemitem">orchid</code>
	  peuvent imprimer sur <code class="literal">rattan</code> et
	  <code class="literal">bamboo</code>.  Par exemple, si un utilisateur sur
	  <code class="systemitem">orchid</code> entrait:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lpr -P bamboo -d sushi-review.dvi</code></strong></pre><p>le système <span class="application">LPD</span> sur
	  <code class="systemitem">orchid</code> copierait le travail d'impression dans le
	  répertoire de file d'impression
	  <code class="filename">/var/spool/lpd/bamboo</code> et relèverait qu'il
	  s'agit d'un travail d'impression DVI.  Dès que la machine
	  <code class="systemitem">rose</code> dispose d'assez de place dans son
	  répertoire de file d'impression, les
	  deux <span class="application">LPD</span>
	  transfèrent le fichier à <code class="systemitem">rose</code>.  Le
	  fichier reste en attente dans la file de <code class="systemitem">rose</code>
	  jusqu'à son impression.  Il sera converti de DVI en
	  <span class="trademark">PostScript</span>® (puisque <code class="literal">bamboo</code> est une imprimante
	  <span class="trademark">PostScript</span>®) sur <code class="systemitem">rose</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-network-net-if"></a>10.4.3.2. Imprimantes avec des interfaces utilisant des flux
	  réseau</h4></div></div></div><p>Bien souvent, lorsque vous achetez une carte d'interface
	  réseau pour une imprimante, vous avez le choix entre
	  deux versions: l'une qui émule un
	  gestionnaire d'impression (la version la plus onéreuse), ou
	  une autre qui ne vous permet que de lui envoyer des
	  données comme s'il s'agissait d'un port série ou
	  parallèle (c'est la version la moins chère).  Cette
	  section vous indique comment utiliser cette seconde version moins
	  onéreuse.  Pour la plus chère, lisez la section
	  précédente <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Imprimantes installées sur des machines distantes">Imprimantes
	    installées sur des machines distantes</a>.</p><p>Le format du fichier <code class="filename">/etc/printcap</code> vous
	  permet de préciser quelle interface série ou
	  parallèle vous souhaitez utiliser, et (si vous employez
	  une interface série) à quelle vitesse de
	  transmission, s'il faut employer le contrôle de flux, les
	  temporisations pour les tabulations, la conversion des sauts de
	  lignes, et plus encore.  Mais il n'existe aucun moyen de
	  préciser une connexion à une imprimante qui
	  écoute sur un port TCP/IP ou un autre port réseau.</p><p>Pour envoyer des données à une imprimante mise
	  en réseau, il vous faut développer un programme
	  de communication qui puisse être appelé par les
	  filtres textes et de conversion.  Voici un exemple: la procédure
	  <code class="command">netprint</code> récupère toutes les données sur
	  l'entrée standard et les envoie à une imprimante
	  connectée au réseau.  Nous précisons le nom de machine
	  de l'imprimante dans le premier paramètre et le
	  numéro de port auquel se connecter dans le
	  deuxième paramètre de <code class="command">netprint</code>.
	  Notez qu'il ne gère que la communication unidirectionnelle
	  (dans le sens FreeBSD vers imprimante); de nombreuses imprimantes
	  réseau supporte la communication bidirectionnelle, et
	  vous désirerez certainement en tirer parti (afin de
	  connaître le statut de l'imprimante, de comptabiliser
	  l'utilisation, etc.).</p><pre class="programlisting">#!/usr/bin/perl
#
#  netprint - Filtre texte pour imprimante connectée au réseau
#  Fichier /usr/local/libexec/netprint
#
$#ARGV eq 1 || die "Usage: $0 &lt;printer-hostname&gt; &lt;port-number&gt;";

$printer_host = $ARGV[0];
$printer_port = $ARGV[1];

require 'sys/socket.ph';

($ignore, $ignore, $protocol) = getprotobyname('tcp');
($ignore, $ignore, $ignore, $ignore, $address)
    = gethostbyname($printer_host);

$sockaddr = pack('S n a4 x8', &amp;AF_INET, $printer_port, $address);

socket(PRINTER, &amp;PF_INET, &amp;SOCK_STREAM, $protocol)
    || die "Can't create TCP/IP stream socket: $!";
connect(PRINTER, $sockaddr) || die "Can't contact $printer_host: $!";
while (&lt;STDIN&gt;) { print PRINTER; }
exit 0;</pre><p>Nous pouvons maintenant utiliser cette procédure avec
	  différents filtres.  Supposons que nous ayons une
	  imprimante Diablo 750-N connectée au réseau.  Elle
	  reçoit les données à imprimer sur le port
	  5100.  Le nom de machine de l'imprimante est
	  <code class="systemitem">scrivener</code>.  Voici le filtre texte
	  pour cette imprimante:</p><pre class="programlisting">#!/bin/sh
#
#  diablo-if-net - Filtre texte pour l'imprimante  Diablo `scrivener' écoutant
#  le port 5100.  Fichier /usr/local/libexec/diablo-if-net
#
exec /usr/libexec/lpr/lpf "$@" | /usr/local/libexec/netprint scrivener 5100</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting"></a>10.4.4. Restreindre l'utilisation de l'imprimante</h3></div></div></div><a id="idp74755792" class="indexterm"></a><p>Cette section fournit des informations sur la restriction
        de l'utilisation de l'imprimante.  Le système <span class="application">LPD</span>
	vous permet de contrôler quels utilisateurs peuvent
	accéder à une imprimante, tant localement
	qu'à distance, s'il leur est autorisé d'imprimer
	en plusieurs exemplaires, quelles sont les tailles maximales de leurs
	travaux d'impression et des files d'impression.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting-copies"></a>10.4.4.1. Restreindre l'impression en plusieurs exemplaires</h4></div></div></div><p>Le système <span class="application">LPD</span> facilite l'impression de
	  plusieurs copies d'un même fichier par les
	  utilisateurs.  Ils peuvent imprimer leur travail
	  avec <code class="command">lpr -#5</code> (par exemple)
	  et obtenir cinq exemplaires de chaque fichier du travail
	  d'impression.  Le fait de savoir s'il s'agit là d'une
	  bonne idée vous appartient.</p><p>Si vous estimez que les copies multiples provoquent
	  charge et usure inutiles pour vos imprimantes, vous
	  pouvez désactiver l'option <code class="option">-#</code> de
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a> en ajoutant le paramètre <code class="literal">sc</code>
	  au fichier <code class="filename">/etc/printcap</code>.  Lorsque des
	  utilisateurs soumettront un travail d'impression avec l'option
	  <code class="option">-#</code>, ils obtiendront cet affichage:</p><pre class="screen">lpr: multiple copies are not allowed</pre><p>Notez que si vous avez mis en &#339;uvre l'accès
	  à une imprimante distante (voir la section
	  <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Imprimantes installées sur des machines distantes">Imprimantes
	    installées sur des machines distantes</a>), il
	  faut que le paramètre <code class="literal">sc</code> soit
	  positionné sur les <code class="filename">/etc/printcap</code>
	  distants également, sinon vos utilisateurs auront
	  toujours la possibilité d'imprimer des copies multiples
	  en passant par une autre machine.</p><p>Voici un exemple.  C'est le <code class="filename">/etc/printcap</code>
	  pour la machine <code class="systemitem">rose</code>.  L'imprimante
	  <code class="literal">rattan</code> est plutôt robuste, et
	  autorisera donc les copies multiples, par contre l'imprimante
	  laser <code class="literal">bamboo</code> est quant à elle plus
	  délicate, nous interdiront donc les impressions multiples en ajoutant le
	  paramètre <code class="literal">sc</code>:</p><pre class="programlisting">#
#  /etc/printcap pour la machine rose - restreint les impressions en plusieurs exemplaires sur bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Maintenant, il nous faut également ajouter le
	  paramètre <code class="literal">sc</code> dans le fichier
	  <code class="filename">/etc/printcap</code> de <code class="systemitem">orchid</code>
	  (et tant que nous y sommes, désactivons les copies multiples
	  pour l'imprimante <code class="literal">teak</code>):</p><pre class="programlisting">#
#  /etc/printcap pour la machine orchid - pas d'impression en
#  plusieurs exemplaires pour
#  l'imprimante locale teak ou l'imprimante distante bamboo
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:sc:\
        :if=/usr/local/libexec/ifhp:\
        :vf=/usr/local/libexec/vfhp:\
        :of=/usr/local/libexec/ofhp:

rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :lp=:rm=rose:rp=rattan:sd=/var/spool/lpd/rattan:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :lp=:rm=rose:rp=bamboo:sd=/var/spool/lpd/bamboo:sc:</pre><p>En recourant au paramètre <code class="literal">sc</code>,
	  nous empêchons l'utilisation de <code class="command">lpr -#</code>,
	  mais cela n'empêche toujours pas les utilisateurs de
	  lancer <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a> à plusieurs reprises, ou de soumettre
	  le même fichier plusieurs fois en un seul travail, de
	  cette façon:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lpr forsale.sign forsale.sign forsale.sign forsale.sign forsale.sign</code></strong></pre><p>Il existe plusieurs moyens de prévenir ces abus (y
	  compris les ignorer) que vous êtes libres d'essayer.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting-access"></a>10.4.4.2. Restreindre l'accès aux imprimantes</h4></div></div></div><p>Vous pouvez contrôler qui a le droit d'imprimer sur
	  quelles imprimantes en utilisant le mécanisme des
	  groupes <span class="trademark">UNIX</span>® et le paramètre <code class="literal">rg</code> dans
	  <code class="filename">/etc/printcap</code>.  Placez simplement les
	  utilisateurs à qui vous voulez donner l'accès
	  à une imprimante dans un groupe, et précisez ce
	  groupe avec le paramètre <code class="literal">rg</code>.</p><p>Les utilisateurs n'appartenant pas au groupe
	  (<code class="systemitem">root</code> inclus) se verront gratifiés d'un

          <span class="errorname">lpr: Not a member of the restricted group</span>

	  s'ils essaient d'imprimer avec l'imprimante
	  contrôlée.</p><p>De même que pour le paramètre <code class="literal">sc</code>
	  (supprimer les exemplaires multiples), il vous faut activer <code class="literal">rg</code>
	  sur les machines distantes qui eux aussi ont
	  accès à vos imprimantes, si vous estimez que
	  c'est approprié (voir la section <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Imprimantes installées sur des machines distantes">Imprimantes
	    installées sur des machines distantes</a>).</p><p>Dans notre exemple, nous allons permettre l'accès
	  à <code class="literal">rattan</code> à quiconque, mais
	  seuls les membres du groupe <code class="systemitem">artists</code>
	  pourront utiliser <code class="literal">bamboo</code>.  Voici l'habituel
	  <code class="filename">/etc/printcap</code> pour la machine
	  <code class="systemitem">rose</code>:</p><pre class="programlisting">#
#  /etc/printcap pour la machine rose - restreint au groupe pour bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Ne nous préoccupons pas de l'autre fichier
	  <code class="filename">/etc/printcap</code> (pour la machine
	  <code class="systemitem">orchid</code>).  Bien entendu, n'importe qui sur
	  <code class="systemitem">orchid</code> peut imprimer avec
	  <code class="literal">bamboo</code>.  Selon le cas, nous pourrons autoriser
	  que certains utilisateurs sur <code class="systemitem">orchid</code>, et
	  leur donner accès à
	  l'imprimante.  Ou non.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Il ne peut exister qu'un seul groupe de restriction par
	    imprimante.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting-sizes"></a>10.4.4.3. Contrôler la taille des travaux d'impression</h4></div></div></div><a id="idp74794192" class="indexterm"></a><p>Si beaucoup de vos utilisateurs accèdent aux
	  imprimantes, vous aurez sans doute besoin de fixer une
	  limite supérieure à la taille des fichiers qu'ils
	  peuvent soumettre à l'impression.  Après
	  tout, le système de fichiers hébergeant les
	  répertoires de file d'impression ne peut offrir
	  que l'espace libre dont il dispose, et vous devez
	  également vous assurer que de la place existe pour
	  les travaux d'impression des autres utilisateurs.</p><a id="idp74795088" class="indexterm"></a><p><span class="application">LPD</span> vous permet de fixer la
	  taille maximale en octets qu'un fichier d'un travail
	  d'impression peut atteindre avec le paramètre
	  <code class="literal">mx</code>.  Les unités sont exprimées
	  en blocs de <code class="literal">BUFSIZ</code>, valant 1024 octets.  Si
	  vous donnez la valeur 0 à ce paramètre, la
	  taille ne sera pas du tout limitée; en revanche, si
	  aucun paramètre <code class="literal">mx</code> n'est
	  défini, alors une limite par défaut de
	  1000 blocs sera utilisée.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">La limite s'applique aux <span class="emphasis"><em>fichiers</em></span> dans
	    un travail d'impression, et <span class="emphasis"><em>non pas</em></span> à
	    la taille totale du travail d'impression.</p></div><p><span class="application">LPD</span> ne refusera pas un fichier
	  dont la taille excède la limite que vous fixez pour
	  une imprimante.  Au lieu de cela, il placera les octets
	  du fichier dans la file jusqu'à ce que la limite soit
	  atteinte, puis imprimera.  Les octets supplémentaires
	  seront ignorés.  S'il s'agit là d'un comportement
	  approprié est un choix qui vous appartient.</p><p>Ajoutons des limites pour nos imprimantes d'exemple,
	  <code class="literal">rattan</code> et <code class="literal">bamboo</code>.  Puisque
	  les fichiers <span class="trademark">PostScript</span>® des utilisateurs du groupe <code class="systemitem">artists</code> ont tendance à
	  être volumineux, nous allons les limiter à cinq
	  mégaoctets.  Nous ne fixerons aucune limite pour l'imprimante
	  texte:</p><pre class="programlisting">#
#  /etc/printcap pour la machine rose
#

#
#  Pas de limite sur la taille des travaux:
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:mx#0:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

#
#  Limite de cinq mégaoctets:
#
bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:mx#5000:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Là encore, les limites ne s'appliquent qu'aux
	  utilisateurs locaux.  Si vous avez mis en place un accès
	  distant à vos imprimantes, les utilisateurs distants ne
	  seront pas contraints par ces limites.  Il vous faudra
	  positionner le paramètre <code class="literal">mx</code> dans les
	  fichiers
	  <code class="filename">/etc/printcap</code> distants également.  Lisez
	  la section <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Imprimantes installées sur des machines distantes">Imprimantes
	    installées sur des machines distantes</a> pour
	  obtenir plus d'informations sur l'impression à
	  distance.</p><p>Il existe une autre manière spécifique pour
	  limiter la taille des travaux d'impression sur les imprimantes
	  à distance; lisez la section <a class="link" href="printing-advanced.html#printing-advanced-restricting-remote" title="10.4.4.4. Restreindre les impressions à distance">Restreindre les
	    impressions à distance</a>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting-remote"></a>10.4.4.4. Restreindre les impressions à distance</h4></div></div></div><p>Le gestionnaire d'impression
	  <span class="application">LPD</span> propose plusieurs moyens de
	  restreindre les travaux d'impression soumis depuis des
	  machines distants:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Restrictions en fonction des machines</span></dt><dd><p>Vous pouvez contrôler de quelles machines
	        distantes les requêtes seront acceptées par
		un <span class="application">LPD</span> local avec les fichiers
		<code class="filename">/etc/hosts.equiv</code> et
		<code class="filename">/etc/hosts.lpd</code>.
		<span class="application">LPD</span> vérifie qu'une
		requête entrante provient d'une machine listée
		dans l'un de ces deux fichiers.  Si ce n'est pas le cas,
		<span class="application">LPD</span> refuse la requête.</p><p>Le format de ces fichiers est simple: un nom de machine
	        par ligne.  Notez que <code class="filename">/etc/hosts.equiv</code>
		est également utilisé par le protocole
		<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ruserok&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">ruserok</span>(3)</span></a>, et qu'il a un impact sur des programmes
		comme <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rsh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rsh</span>(1)</span></a> et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rcp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rcp</span>(1)</span></a>, aussi soyez prudent.</p><p>Par exemple, voici le fichier
	        <code class="filename">/etc/hosts.lpd</code> présent sur la
		machine
		<code class="systemitem">rose</code>:</p><pre class="programlisting">orchid
violet
madrigal.fishbaum.de</pre><p>Cela signifie que <code class="systemitem">rose</code> accepte les
	        requêtes provenant des machines
		 <code class="systemitem">orchid</code>, <code class="systemitem">violet</code> et
		 <code class="systemitem">madrigal.fishbaum.de</code>.  Si une
		 quelconque autre machine tente d'accéder au
		 <span class="application">LPD</span> de <code class="systemitem">rose</code>,
		 le travail d'impression sera refusé.</p></dd><dt><span class="term">Restrictions sur la taille</span></dt><dd><p>Vous pouvez contrôler combien d'espace doit
	        demeurer libre sur le système de fichiers où
		se trouve un répertoire de file d'impression.
		Créez un fichier nommé
		<code class="filename">minfree</code> dans le répertoire de
		file d'impression pour l'imprimante locale.
		Placez dans ce fichier un nombre représentant combien
		de blocs disques (de 512 octets) d'espace libre il
		doit rester pour qu'un travail d'impression soit
		accepté.</p><p>Cela vous permet de vous assurer que des utilisateurs
	        distants ne rempliront pas votre système de
		fichiers.  Vous pouvez également vous en servir pour
		accorder une certaine priorité aux utilisateurs
		locaux: ils pourront placer des travaux d'impression dans
		la file bien après que l'espace libre soit tombé
		sous le seuil indiqué dans le fichier
		<code class="filename">minfree</code>.</p><p>Par exemple, ajoutons un fichier
	        <code class="filename">minfree</code> pour l'imprimante
		<code class="literal">bamboo</code>.  Nous examinons
		<code class="filename">/etc/printcap</code> pour trouver le
		répertoire de file d'impression pour cette
		imprimante; voici l'entrée concernant
		<code class="literal">bamboo</code>:</p><pre class="programlisting">bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:mx#5000:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:mx#5000:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Le répertoire de file d'impression est
	        précisé par le paramètre
		<code class="literal">sd</code>.  Nous placerons à trois
		méga-octets (soit 6144 blocs disque) la limite
		d'espace libre devant exister sur le système de
		fichiers pour que <span class="application">LPD</span> accepte
		les travaux d'impression distants:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>echo 6144 &gt; /var/spool/lpd/bamboo/minfree
              </code></strong></pre></dd><dt><span class="term">Restrictions sur l'utilisateur</span></dt><dd><p>Vous pouvez contrôler quels utilisateurs distants
	        ont le droit d'imprimer sur les imprimantes locales en
		positionnant le paramètre <code class="literal">rs</code>
		dans <code class="filename">/etc/printcap</code>.  Lorsque
		<code class="literal">rs</code> est présent dans
		l'entrée d'une imprimante connectée
		localement, <span class="application">LPD</span> acceptera les
		travaux d'impressions de machines distantes
		<span class="emphasis"><em>si</em></span> l'utilisateur soumettant le travail
		possède également un compte sous le
		même nom sur la machine locale.  Sinon,
		<span class="application">LPD</span> refusera le travail
		d'impression.</p><p>Ce paramètre se révèle
	        particulièrement utile dans un environnement
		où (par exemple) existent plusieurs services
		qui partagent un réseau, et que des utilisateurs
		débordent les frontières de ces services.  En
		leur donnant des comptes sur vos systèmes, vous
		leur permettez d'utiliser vos imprimantes depuis les
		systèmes de leur propre service.  Si vous
		préférez les autoriser à n'utiliser
		<span class="emphasis"><em>que</em></span> vos imprimantes et pas les
		autres ressources de l'ordinateur, alors vous pouvez leur
		attribuer des comptes <span class="quote">« <span class="quote">bloqués</span> »</span>, sans
		répertoire de connexion et avec un interpréteur de
		commandes
		inutilisable comme <code class="filename">/usr/bin/false</code>.</p></dd></dl></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-acct"></a>10.4.5. Comptabiliser l'utilisation de l'imprimante</h3></div></div></div><a id="idp74845008" class="indexterm"></a><p>Donc vous voulez faire payer vos impressions.  Et pourquoi pas?
        Le papier et l'encre coûtent de l'argent.  Et puis, il y a les
	coûts de maintenance&#8212;les imprimantes sont constituées
	de pièces mobiles et ont tendance à tomber en panne.
	Vous avez étudié vos imprimantes, vos modes
	d'utilisation et factures de maintenance, et avez abouti à
	un coût par page (ou par pied, par mètre, ou
	par ce que vous voulez).  Maintenant, comment commencer à
	comptabiliser les impressions, dans les faits?</p><p>Eh bien, la mauvaise nouvelle est que le
        gestionnaire d'impression <span class="application">LPD</span> ne vous aide
	pas beaucoup dans ce domaine.  La comptabilisation dépend
	fortement du type d'imprimante que vous employez, des formats
	que vous imprimez et de <span class="emphasis"><em>vos</em></span> besoins pour ce
	qui est de faire payer l'utilisation de l'imprimante.</p><p>Pour mettre en &#339;uvre la comptabilisation, il vous faut
        modifier le filtre texte de l'imprimante (pour faire payer les
	travaux d'impression de texte brut) et ses filtres de conversion
	(pour faire payer les autres formats de fichiers), pour compter les
	pages ou demander à l'imprimante combien elle en a
	imprimées.  Vous ne pouvez pas vous en tirer en
	utilisant le filtre de sortie simple, puisqu'il ne peut pas
	gérer la comptabilisation.  Voir la section <a class="link" href="printing-advanced.html#printing-advanced-filter-intro" title="10.4.1. Les filtres">Les filtres</a>.</p><p>En général, il existe deux façons de
        procéder à la comptabilisation:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>La comptabilisation <span class="emphasis"><em>périodique</em></span>
	    est la plus habituelle, probablement parce que la plus
	    facile.  Chaque fois que quelqu'un imprime un travail, le
	    filtre enregistre l'utilisateur, la machine et le nombre de
	    pages dans un fichier de comptabilisation.  Tous les mois,
	    semestres, années ou toute autre échéance que vous
	    désirez, vous récupérez les fichiers de
	    comptabilisation des diverses imprimantes, établissez
	    les pages imprimées par les utilisateurs, et faites
	    payer l'utilisation.  Purgez ensuite tous les fichiers de
	    comptabilisation, pour commencer à zéro la nouvelle
	    période.</p></li><li class="listitem"><p>La comptabilisation <span class="emphasis"><em>à la volée</em></span>
	    est moins répandue, peut-être parce qu'elle
	    s'avère plus difficile.  Cette méthode laisse
	    les filtres s'occuper de taxer les utilisateurs pour les
	    impressions dès qu'ils utilisent les imprimantes.  Tout
	    comme les quotas disques, la comptabilisation est
	    immédiate.  Vous pouvez empêcher les utilisateurs
	    d'imprimer quand leur compte est dans le rouge, et pourriez
	    leur fournir un moyen de vérifier et ajuster leurs
	    <span class="quote">« <span class="quote">quotas d'impression</span> »</span>.  Cependant, cette
	    méthode nécessite la mise en oeuvre d'une base de
	    données afin de tracer les utilisateurs et leurs
	    quotas.</p></li></ul></div><p>Le gestionnaire d'impression
        <span class="application">LPD</span> gère les deux méthodes
	facilement: puisque vous devez fournir les filtres (enfin, la
	plupart du temps), vous devez également fournir le code
	de comptabilisation.  Mais il y a un bon côté: vous
	disposez d'une énorme flexibilité dans vos
	méthodes de comptabilisation.  Par exemple, vous avez le
	choix entre les comptabilisations périodique et à la
	volée.  Vous avez le choix des informations à tracer: noms
	d'utilisateurs, noms de machines, types des travaux
	d'impression, pages imprimées, surface de papier
	utilisée, durée d'impression du travail, etc.  Et
	vous le faites en modifiant les filtres afin d'enregistrer
	ces informations.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp74869328"></a>10.4.5.1. Comptabilisation rapide et simplifiée des impressions</h4></div></div></div><p>Deux programmes sont livrés avec FreeBSD qui vous
	  permettent de mettre en place une comptabilisation
	  périodique simple immédiatement.  Il s'agit du
	  filtre texte <code class="command">lpf</code>, détaillé dans
	  la section <a class="link" href="printing-advanced.html#printing-advanced-lpf" title="10.4.1.6. lpf: un filtre texte">lpf: un
	  filtre texte</a>, et de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>, un programme qui
	  rassemble et fait le total des entrées contenues dans des
	  fichiers de comptabilisation d'impressions.</p><p>Comme indiqué dans la section sur les filtres (<a class="link" href="printing-advanced.html#printing-advanced-filters" title="10.4.1.1. Fonctionnement des filtres">Fonctionnement des filtres</a>),
	  <span class="application">LPD</span> lance les filtres texte et de
	  conversion avec le nom du fichier de comptabilisation à
	  employer fourni en argument.  Les filtres peuvent
	  utiliser ce paramètre pour savoir où écrire
	  un enregistrement de comptabilisation.  Le nom de ce fichier provient du
	  paramètre <code class="literal">af</code> dans
	  <code class="filename">/etc/printcap</code>, et si le chemin donné
	  n'est pas absolu, alors c'est un chemin d'accès relatif
	  au répertoire de file d'impression.</p><p><span class="application">LPD</span> lance <code class="command">lpf</code>
	  avec les paramètres de largeur et hauteur de page (qui
	  correspondent aux paramètres <code class="literal">pw</code> et
	  <code class="literal">pl</code>).  Le filtre <code class="command">lpf</code> les utilise
	  pour déterminer combien de papier sera consommé.
	  Après avoir envoyé le fichier à
	  l'imprimante, il enregistre ensuite une entrée dans le
	  fichier de comptabilisation.  Les entrées ressemblent
	  à ceci:</p><pre class="programlisting">2.00 rose:andy
3.00 rose:kelly
3.00 orchid:mary
5.00 orchid:mary
2.00 orchid:zhang</pre><p>Vous devriez utiliser un fichier de comptabilisation
	  séparé pour chaque imprimante, <code class="command">lpf</code>
	  ne disposant pas de mécanisme de verrouillage
	  des fichiers, deux <code class="command">lpf</code> pourraient
	  corrompre leurs entrées respectives s'ils essayaient
	  d'écrire dans le même fichier en même temps.
	  Une manière aisée de s'assurer d'un fichier de
	  comptabilisation séparé pour chaque imprimante est de
	  recourir au paramètre <code class="literal">af=acct</code> dans
	  <code class="filename">/etc/printcap</code>.  Dès lors, un
	  fichier de comptabilisation, nommé
	  <code class="filename">acct</code>, sera placé dans le
	  répertoire de file d'impression de chaque imprimante.</p><p>Lorsque vous serez prêts à faire payer les
	  utilisateurs pour leurs impressions, lancez le programme
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>.  Placez-vous simplement dans le répertoire
	  de file d'impression de l'imprimante pour laquelle vous
	  voulez collecter les informations, et tapez
	  <code class="command">pac</code>.  Vous obtiendrez un récapitulatif
	  en dollars ressemblant à ceci:</p><pre class="screen">  Login               pages/feet   runs    price
orchid:kelly                5.00    1   $  0.10
orchid:mary                31.00    3   $  0.62
orchid:zhang                9.00    1   $  0.18
rose:andy                   2.00    1   $  0.04
rose:kelly                177.00  104   $  3.54
rose:mary                  87.00   32   $  1.74
rose:root                  26.00   12   $  0.52

total                     337.00  154   $  6.74</pre><p>Voici les arguments attendus par <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-P<em class="replaceable"><code>imprimante</code></em>
	      </code></span></dt><dd><p>Pour quelle <em class="replaceable"><code>imprimante</code></em>
	        effectuer un récapitulatif.  Cette option ne
		fonctionne que si un chemin d'accès absolu est donné
		dans le paramètre <code class="literal">af</code> de
		<code class="filename">/etc/printcap</code>.</p></dd><dt><span class="term"><code class="option">-c</code></span></dt><dd><p>Trier selon le coût plutôt
	        qu'alphabétiquement par nom d'utilisateur.</p></dd><dt><span class="term"><code class="option">-m</code></span></dt><dd><p>Ignorer le nom de la machine dans les fichiers de
	        comptabilisation.  Avec cette option, l'utilisateur
		<code class="systemitem">smith</code> sur la machine
		<code class="systemitem">alpha</code> est le même que l'utilisateur
		<code class="systemitem">smith</code> sur la machine
		<code class="systemitem">gamma</code>.  Sans elle, ils représentent
		des utilisateurs distincts.</p></dd><dt><span class="term"><code class="option">-p<em class="replaceable"><code>prix</code></em></code></span></dt><dd><p>Calculer le coût en comptant un
	        <em class="replaceable"><code>prix</code></em> en dollars par page ou par pied
		au lieu du prix indiqué par le paramètre
		<code class="literal">pc</code> dans <code class="filename">/etc/printcap</code>,
		ou deux cents (la valeur par défaut).  Vous pouvez
		préciser le <em class="replaceable"><code>prix</code></em> en nombre
		à virgule flottante.</p></dd><dt><span class="term"><code class="option">-r</code></span></dt><dd><p>Inverser l'ordre du tri.</p></dd><dt><span class="term"><code class="option">-s</code></span></dt><dd><p>Créer un fichier de rapport et
	        tronquer le fichier de comptabilisation.</p></dd><dt><span class="term"><em class="replaceable"><code>nom</code></em>
	      <em class="replaceable"><code>&#8230;</code></em></span></dt><dd><p>N'imprimer des statistiques que pour les utilisateurs
	        dont les <em class="replaceable"><code>nom</code></em>s sont
		donnés.</p></dd></dl></div><p>Dans le récapitulatif produit par défaut par
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>, vous pouvez lire le nombre de pages imprimées
	  par chaque utilisateur depuis les différentes machines.  Si, sur votre
	  site, la machine n'a pas d'importance (parce que les utilisateurs
	  peuvent utiliser n'importe quelle machine), lancez
	  <code class="command">pac -m</code>, afin de produire le récapitulatif
	  ci-dessous:</p><pre class="screen">  Login               pages/feet   runs    price
andy                        2.00    1   $  0.04
kelly                     182.00  105   $  3.64
mary                      118.00   35   $  2.36
root                       26.00   12   $  0.52
zhang                       9.00    1   $  0.18

total                     337.00  154   $  6.74</pre><p>Afin de calculer le montant dû en dollars, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>
	  utilise le paramètre <code class="literal">pc</code> de
	  <code class="filename">/etc/printcap</code> (200 par défaut,
	  c'est à dire 2 cents par page).  Précisez avec
	  ce paramètre le prix par page ou par pied, exprimé
	  en centièmes de cents, que vous voulez imputer aux
	  impressions.  Vous pouvez spécifier cette valeur lorsque vous
	  lancez <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a> avec l'option <code class="option">-p</code>.  Cependant,
	  avec cette option, les unités sont exprimées en
	  dollars, et non en centièmes de cents.  Par exemple,</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>pac -p1.50</code></strong></pre><p>fait en sorte que chaque page coûte un dollar et cinquante
	  cents.  Vous pouvez vraiment faire des bénéfices
	  en utilisant cette option.</p><p>Enfin, lancer <code class="command">pac -s</code> enregistrera les
	  informations du récapitulatif dans un fichier, dont le
	  nom sera le même que le fichier de comptabilisation de
	  l'imprimante mais avec le suffixe <code class="literal">_sum</code>.  Il
	  procède alors à la troncature du fichier de
	  comptabilisation.  Lorsque vous exécutez <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>
	  à nouveau, il relit le fichier récapitulatif pour
	  établir les totaux de départ, puis ajoute les
	  informations du fichier de comptabilisation normal.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp74917456"></a>10.4.5.2. Comment compter les pages imprimées?</h4></div></div></div><p>Afin de réaliser une comptabilisation précise et cela
	  même à distance, vous devez pouvoir déterminer
	  combien un travail d'impression consomme de papier.  C'est le
	  problème principal de la comptabilisation des
	  impressions.</p><p>Pour du texte brut, ce problème n'est pas
	  compliqué à résoudre: vous comptez combien
	  un travail d'impression comporte de lignes et comparez avec
	  le nombre de lignes par page que gère votre imprimante.
	  N'oubliez pas de tenir compte des retours arrière
	  dans le fichier, qui superposent les lignes, ou des longues
	  lignes qui s'étendent sur une ou plusieurs lignes
	  physiques supplémentaires.</p><p>Le filtre texte <code class="command">lpf</code> (présenté
	  à la section <a class="link" href="printing-advanced.html#printing-advanced-lpf" title="10.4.1.6. lpf: un filtre texte">lpf: un
	    filtre texte</a>) prend ces éléments en
	  considération lorsqu'il effectue la comptabilisation.  Si
	  vous écrivez un filtre texte qui doit effectuer une
	  comptabilisation, vous pouvez vous inspirer du code source de
	  <code class="command">lpf</code>.</p><p>Mais comment gérer les autres formats?</p><p>Eh bien, pour la conversion DVI-vers-LaserJet ou
	  DVI-vers-<span class="trademark">PostScript</span>®, vous pouvez faire analyser les messages de sortie
	  de <code class="command">dvilj</code> ou <code class="command">dvips</code> par
	  votre filtre et regarder combien de pages ont été
	  converties.  Vous devriez pouvoir procéder de
	  manière identique avec d'autres formats de
	  fichiers et programmes de conversion.</p><p>Mais ces méthodes connaissent un défaut: il se
	  peut que l'imprimante n'imprime pas toutes ces pages.  Par exemple,
	  un bourrage peut se produire, l'imprimante peut arriver à cours d'encre, ou
	  exploser &#8212; et l'utilisateur serait tout de même
	  débité.</p><p>Alors, que pouvez-vous faire?</p><p>Il n'existe qu'une seule méthode
	  <span class="emphasis"><em>sûre</em></span> pour procéder à une
	  comptabilisation <span class="emphasis"><em>précise</em></span>.  Prenez
	  une imprimante qui sache dire combien de papier elle utilise, et
	  reliez-la par un câble série ou une connection
	  réseau.  Presque toutes les imprimantes <span class="trademark">PostScript</span>®
	  gèrent cela.  D'autres types et modèles
	  également (les imprimantes laser réseau Imagen,
	  par exemple).  Modifiez les filtres pour ces imprimantes afin
	  d'obtenir la consommation de pages après chaque travail
	  d'impression et faites en sorte qu'elles enregistrent des
	  informations de comptabilisation basées sur cette
	  <span class="emphasis"><em>seule</em></span> valeur.  Nul besoin de compter
	  les lignes ou d'une analyse de fichier susceptible d'être
	  erronée.</p><p>Bien entendu, vous pouvez toujours être
	  généreux et rendre toutes les impressions
	  gratuites.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="printing-intro-setup.html">Précédent</a> </td><td width="20%" align="center"><a accesskey="u" href="printing.html">Niveau supérieur</a></td><td width="40%" align="right"> <a accesskey="n" href="printing-using.html">Suivant</a></td></tr><tr><td width="40%" align="left" valign="top">10.3. Configuration de base </td><td width="20%" align="center"><a accesskey="h" href="index.html">Sommaire</a></td><td width="40%" align="right" valign="top"> 10.5. Using Printers ** Traduction en Cours **</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Ce document, ainsi que d'autres peut être téléchargé sur
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Pour toutes questions à propos de FreeBSD, lisez la
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> avant de contacter
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    Pour les questions sur cette documentation, contactez
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.</small></p></body></html>