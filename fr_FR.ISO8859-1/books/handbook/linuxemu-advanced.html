<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>11.8. Sujets avancés</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Manuel FreeBSD" /><link rel="up" href="linuxemu.html" title="Chapitre 11. Compatibilité binaire avec Linux" /><link rel="prev" href="sapr3.html" title="11.7. Installer SAP® R/3®" /><link rel="next" href="system-administration.html" title="Partie III. Administration Système" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">11.8. Sujets avancés</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="sapr3.html">Précédent</a> </td><th width="60%" align="center">Chapitre 11. Compatibilité binaire avec Linux</th><td width="20%" align="right"> <a accesskey="n" href="system-administration.html">Suivant</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="linuxemu-advanced"></a>11.8. Sujets avancés</h2></div></div></div><p>Si vous êtes curieux de savoir comment la
      compatibilité binaire avec Linux fonctionne, cette
      section est faite pour vous.  La plupart de ce qui suit est
      principalement basé sur un courrier électronique
      de Terry Lambert <code class="email">&lt;<a xmlns="" class="email" href="mailto:tlambert@primenet.com">tlambert@primenet.com</a>&gt;</code>
      envoyé à la <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-chat" target="_top">liste de diffusion pour la discussion de sujets non-techniques en rapport avec FreeBSD</a> (Message ID:
      <code class="literal">&lt;199906020108.SAA07001@usr09.primenet.com&gt;</code>).</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp76356176"></a>11.8.1. Comme ça marche?</h3></div></div></div><a id="idp76356816" class="indexterm"></a><p>FreeBSD possède une abstraction appelée
	&#8220;chargeur de classe d'exécution&#8221;.  C'est
	une portion de l'appel système <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=execve&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">execve</span>(2)</span></a>.</p><p>Ce qui se passe est que FreeBSD dispose d'une liste de
	chargeurs, à la place d'un simple chargeur avec retour
	(&#8220;fallback&#8221;) vers le chargeur
	<code class="literal">#!</code> pour exécuter n'importe quel
	interpréteur de commandes ou procédure.</p><p>Historiquement, l'unique chargeur sur les plate-formes
	<span class="trademark">UNIX</span>® examinait le nombre magique (généralement
	les 4 ou 8 premiers octets du fichier) pour voir si
	c'était un binaire connu par le système, et si
	c'était le cas, invoquait le chargeur binaire.</p><p>Si ce n'était pas le type de binaire du
	système, l'appel <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=execve&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">execve</span>(2)</span></a> retournait un
	échec, et l'interpréteur de commandes tentait de
	l'exécuter comme une commande
	d'interpréteur.</p><p>Cette hypothèse est celle par défaut quelque
	soit l'interpréteur de commandes actuel.</p><p>Plus tard, une modification a été faite sur
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> pour examiner les deux premiers caractères,
	et s'ils étaient <code class="literal">:\n</code>, alors elle
	invoquait l'interpréteur de commandes <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=csh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">csh</span>(1)</span></a>
	à la place (nous pensons que l'entreprise SCO fut la
	première à faire cette modification).</p><p>Ce que fait maintenant FreeBSD est de parcourir une liste de
	chargeurs, avec un chargeur <code class="literal">#!</code>
	générique qui reconnaît les noms des
	interpréteurs qui se trouvent après le
	caractère espace suivant, puis avec un retour possible
	vers <code class="filename">/bin/sh</code>.</p><a id="idp76398160" class="indexterm"></a><p>Pour le support de l'ABI Linux, FreeBSD voit le nombre
	magique comme un binaire ELF (il ne fait pas la
	différence à ce niveau entre FreeBSD, <span class="trademark">Solaris</span>&#8482;,
	Linux, ou tout autre système d'exploitation qui dispose
	d'un type d'image ELF).</p><a id="idp76407760" class="indexterm"></a><p>Le chargeur ELF recherche une <span class="emphasis"><em>marque</em></span>
	spécifique, qui se trouve dans une section de commentaire
	dans l'image ELF, et qui n'est pas présente dans les
	binaires SVR4/<span class="trademark">Solaris</span>&#8482; ELF.</p><p>Pour que les binaires Linux puissent fonctionner, ils
	doivent être <span class="emphasis"><em>marqués</em></span> sous le
	type <code class="literal">Linux</code> avec <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=brandelf&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">brandelf</span>(1)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>brandelf -t Linux file</code></strong></pre><p>Quand cela est fait, le chargeur ELF verra le marquage
	<code class="literal">Linux</code> sur le fichier.</p><a id="idp76413008" class="indexterm"></a><p>Lorsque le chargeur ELF voit le marquage
	<code class="literal">Linux</code>, le chargeur remplace un pointeur
	dans la structure <code class="literal">proc</code>.  Tous les appels
	système sont indéxés par
	l'intermédiaire de ce pointeur (dans un système
	<span class="trademark">UNIX</span>® traditionnel, cela serait la structure
	<code class="literal">sysent[]</code>, contenant les appels
	système).  De plus, le processus est marqué pour
	une gestion spéciale du vecteur d'interruption
	(&#8220;trap&#8221;) pour le signal de code
	&#8220;trampoline&#8221;, et plusieurs autres corrections
	(mineures) qui sont gérées par le noyau
	Linux.</p><p>Le vecteur d'appel système Linux contient, entre
	autres, une liste des entrées
	<code class="literal">sysent[]</code> dont les adresses résident
	dans le noyau.</p><p>Quand un appel système est effectué par le
	binaire Linux, le code &#8220;trap&#8221;
	déréférence de la structure
	<code class="literal">proc</code> le pointeur de la fonction de l'appel
	système, et utilise les points d'entrée Linux,
	et non pas FreeBSD, de d'appel système.</p><p>De plus, le mode Linux redéfinit dynamiquement
	l'origine des requêtes; c'est, en effet, ce qu'effectue
	l'option <code class="option">union</code> (<span class="emphasis"><em>pas</em></span> le
	type de système de fichiers
	<code class="literal">unionfs</code>!) de montage des systèmes de
	fichiers.  Tout d'abord, une tentative est faite pour
	rechercher le fichier dans le répertoire <code class="filename">/compat/linux/chemin-origine</code>,
	<span class="emphasis"><em>puis</em></span> uniquement si cela échoue, la
	recherche est effectuée dans le répertoire
	<code class="filename">/chemin-origine</code>.
	Cela permet de s'assurer que les binaires nécessitant
	d'autres binaires puissent s'exécuter (par exemple,
	l'ensemble des outils Linux peuvent tourner sous l'ABI Linux).
	Cela signifie également que les binaires Linux peuvent
	charger et exécuter les binaires FreeBSD, s'il n'y a pas
	de binaires Linux correspondant présents, et vous
	pourriez placer une commande <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=uname&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">uname</span>(1)</span></a> dans l'arborescence
	<code class="filename">/compat/linux</code> pour vous
	assurer que les binaires Linux ne puissent pas dire qu'ils ne
	tournent pas sous Linux.</p><p>En effet, il y a un noyau Linux dans le noyau FreeBSD; les
	diverses fonctions sous-jacentes qui implémentent tous
	les services fournis par le noyau sont identiques entre les
	deux tables d'entrées des appels systèmes FreeBSD
	et Linux: les opérations sur les systèmes de
	fichiers, les opérations sur la mémoire
	virtuelle, la gestion des signaux, l'IPC System V, etc.  La
	seule différence est que les binaires FreeBSD utilisent
	les fonctions <span class="emphasis"><em>glue</em></span> de FreeBSD, et les
	binaires Linux celles de Linux (les plus anciens
	systèmes d'exploitation avaient uniquement leurs
	propres fonctions de <span class="emphasis"><em>glue</em></span>: les adresses
	des fonctions dans une structure <code class="literal">sysent[]</code>
	statique globale, au lieu des adresses des fonctions
	déréférencées d'un pointeur
	initialisé dynamiquement pointant vers la structure
	<code class="literal">proc</code> du processus faisant l'appel).</p><p>Laquelle est l'ABI native FreeBSD?  Cela n'a pas
	d'importance.  Basiquement, la seule différence est que
	(actuellement, cela pourrait facilement changer dans les
	versions futures, et probablement après cela) les
	fonctions <span class="emphasis"><em>glue</em></span> de FreeBSD sont liées
	en statique dans le noyau, les fonctions
	<span class="emphasis"><em>glue</em></span> Linux peuvent être
	liées statiquement, ou l'on peut y accéder via
	un module du noyau.</p><p>Oui, mais est-ce vraiment de l'émulation?  Non.
	C'est l'implémentation d'une interface binaire pour les
	applications (ABI).  Il n'y a pas d'émulateur (ou de
	simulateur, pour couper court aux prochaines questions)
	impliqué.</p><p>Mais pourquoi appelle-t-on parfois cela
	&#8220;émulation Linux&#8221;?  Pour rendre difficile
	la vente des versions de FreeBSD!  Sérieusement, c'est
	dû au fait que l'implémentation historique a
	été faite à une époque où
	il n'y avait pas vraiment d'autres mots pour décrire ce
	qui était en développement; dire que FreeBSD
	exécutait les binaires Linux n'était pas vrai si
	vous n'aviez pas compilé le code ou chargé un
	module, aussi un terme était nécessaire pour
	qualifier ce qui était chargé &#8212; donc
	l'&#8220;émulateur Linux&#8221;.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sapr3.html">Précédent</a> </td><td width="20%" align="center"><a accesskey="u" href="linuxemu.html">Niveau supérieur</a></td><td width="40%" align="right"> <a accesskey="n" href="system-administration.html">Suivant</a></td></tr><tr><td width="40%" align="left" valign="top">11.7. Installer <span class="trademark">SAP</span>® <span class="trademark">R/3</span>® </td><td width="20%" align="center"><a accesskey="h" href="index.html">Sommaire</a></td><td width="40%" align="right" valign="top"> Partie III. Administration Système</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Ce document, ainsi que d'autres peut être téléchargé sur
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Pour toutes questions à propos de FreeBSD, lisez la
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> avant de contacter
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    Pour les questions sur cette documentation, contactez
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.</small></p></body></html>