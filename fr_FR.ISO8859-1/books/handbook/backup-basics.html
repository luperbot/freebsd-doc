<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>19.12. Sauvegardes</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Manuel FreeBSD" /><link rel="up" href="disks.html" title="Chapitre 19. Stockage des données" /><link rel="prev" href="backup-strategies.html" title="19.11. Stratégies de sauvegarde" /><link rel="next" href="disks-virtual.html" title="19.13. Systèmes de fichiers réseaux, en mémoire et sauvegardés sur fichier" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">19.12. Sauvegardes</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="backup-strategies.html">Précédent</a> </td><th width="60%" align="center">Chapitre 19. Stockage des données</th><td width="20%" align="right"> <a accesskey="n" href="disks-virtual.html">Suivant</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="backup-basics"></a>19.12. Sauvegardes</h2></div></div></div><p>Les trois principaux programmes de sauvegarde sont:
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a>, et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80542800"></a>19.12.1. Dump et Restore</h3></div></div></div><a id="idp80543440" class="indexterm"></a><a id="idp80548816" class="indexterm"></a><a id="idp80549456" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=restore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">restore</span>(8)</span></a> sont les programmes de
	sauvegarde traditionnels d'<span class="trademark">UNIX</span>®.  Ils opèrent sur le disque
	comme sur une suite de blocs disque, en dessous du niveau
	d'abstraction que constituent les fichiers, liens et
	répertoires créés par les systèmes de
	fichiers.  Le programme <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> sauvegarde
	l'intégralité d'un système de
	fichiers d'un périphérique.  Il est incapable
	de sauvegarder seulement une partie d'un système
	de fichiers ou une arborescence de répertoires
	s'étalant sur plus d'un système de fichiers.
	Le programme <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> n'écrit pas de fichiers ou
	des répertoires sur la bande, mais écrit
	plutôt les blocs de données brutes dont sont
	constitués les fichiers et les répertoires.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Si vous utilisez <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> sur votre répertoire
	  racine, vous ne sauvegarderez pas
	  <code class="filename">/home</code>, <code class="filename">/usr</code> ou
	  beaucoup d'autres répertoires puisque que ces derniers
	  sont généralement des points de montages pour
	  d'autres systèmes de fichiers ou des liens symboliques
	  vers ces systèmes de fichiers.</p></div><p>L'utilitaire <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> a quelques particularités
	datant de ses débuts sous la version 6 d'AT&amp;T UNIX (circa
	1975).  Les paramètres par défaut conviennent aux bandes
	9 pistes (6250 bpi), et non aux supports à haute
	densité d'aujourd'hui (jusqu'à 62182 ftpi).
	Il faut surcharger ces valeurs par défaut sur la ligne
	de commande pour utiliser la capacité des bandes
	actuelles.</p><a id="idp80561744" class="indexterm"></a><p>Il est également possible de sauvegarder les
	données par l'intermédiaire d'un réseau sur un
	lecteur de bande se trouvant sur une autre ordinateur
	à l'aide des commandes <code class="command">rdump</code> et
	<code class="command">rrestore</code>.
	Ces deux programmes utilisent <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rcmd&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">rcmd</span>(3)</span></a> et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ruserok&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">ruserok</span>(3)</span></a>
	pour accéder à l'unité de bandes distante.
        Cependant, l'utilisateur effectuant une sauvegarde doit
	être présent dans le fichier <code class="filename">.rhosts</code>
	sur la machine distante.  Les arguments de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rdump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rdump</span>(8)</span></a> et
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rrestore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rrestore</span>(8)</span></a> doivent être compatibles avec une
	utilisation sur la machine distante.  Quand on sauvegarde
	une machine FreeBSD sur un lecteur Exabyte installé sur
	un ordinateur Sun appelé <code class="systemitem">komodo</code>,
	utilisez:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/sbin/rdump 0dsbfu 54000 13000 126 komodo:/dev/nsa8 /dev/da0a 2&gt;&amp;1</code></strong></pre><p>Attention: il y a des conséquences pour la
	sécurité à utiliser l'authentification
	<code class="filename">.rhosts</code>.  Evaluez soigneusement votre
	situation.</p><p>Il est également possible d'utiliser <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> et
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=restore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">restore</span>(8)</span></a> d'une façon plus sécurisée sur
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a>.</p><div class="example"><a id="idp80584144"></a><div class="example-title">Exemple 19.1. Utiliser <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> sur <span class="application">ssh</span></div><div class="example-contents"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/sbin/dump -0uan -f - /usr | gzip -2 | ssh -c blowfish \
          targetuser@targetmachine.example.com dd of=/mybigfiles/dump-usr-l0.gz</code></strong></pre></div></div><br class="example-break" /><p>Ou en utilisant une fonction interne de
	<code class="command">dump</code>, positionner la variable
	d'environnement <code class="envar">RSH</code>:</p><div class="example"><a id="idp80587984"></a><div class="example-title">Exemple 19.2. Utiliser <code class="command">dump</code> sur <span class="application">ssh</span>
	avec la variable <code class="envar">RSH</code> positionnée</div><div class="example-contents"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>RSH=/usr/bin/ssh /sbin/dump -0uan -f targetuser@targetmachine.example.com:/dev/sa0 /usr</code></strong></pre></div></div><br class="example-break" /></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80595152"></a>19.12.2. <code class="command">tar</code></h3></div></div></div><a id="idp80595920" class="indexterm"></a><p>Le programme <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> date aussi de la Version 6
	d'AT&amp;T UNIX (circa 1975).  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> travaille en
	coopération avec le système de fichiers; il
	permet d'écrire
	des fichiers et des répertoires sur bandes.
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> ne supporte pas toutes les options permises
	par <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a>, mais ne demande pas
	l'inhabituelle concaténation de commandes qu'utilise
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a></p><a id="idp80601296" class="indexterm"></a><p>Sous FreeBSD 5.3 et versions suivantes, GNU
	<code class="command">tar</code> et la version par défaut
	<code class="command">bsdtar</code> sont disponibles.  La version GNU
	peut être invoquée avec la commande
	<code class="command">gtar</code>.  Elle supporte les sauvegardes sur
	des périphériques distants et cela
	avec la même syntaxe que <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rdump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rdump</span>(8)</span></a>.  Pour sauvegarder avec
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> sur une unité Exabyte connectée sur une machine
	Sun appelée <code class="systemitem">komodo</code>, utilisez:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/usr/bin/gtar cf komodo:/dev/nsa8 . 2&gt;&amp;1</code></strong></pre><p>La même opération peut être
	effectuée avec <code class="command">bsdtar</code> en utilisant
	un tuyau et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rsh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rsh</span>(1)</span></a> pour
	envoyer les données sur un lecteur de bande distant:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>tar cf - . | rsh hostname dd of=tape-device obs=20b</code></strong></pre><p>Si vous êtes inquiet au sujet de la sécurité
	de sauvegardes par réseau, vous devriez utiliser la
	commande <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a> à la place de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rsh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rsh</span>(1)</span></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80615248"></a>19.12.3. <code class="command">cpio</code></h3></div></div></div><a id="idp80616016" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a> est le programme <span class="trademark">UNIX</span>® original pour l'échange
	de fichiers par bandes magnétiques.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a> dispose
	d'options (parmi beaucoup d'autres) pour intervertir les
	octets, utiliser de nombreux différents formats, et envoyer
	les données à d'autres programmes.  Cette dernière
	caractéristique fait de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a> un excellent choix pour
	les supports d'installation.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a> ne sait pas
	parcourir une arborescence de répertoires et il faut lui
	passer la liste des fichiers via
	<code class="filename">stdin</code>.</p><a id="idp80621520" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a> ne supporte pas les sauvegardes par le
	réseau.  Vous pouvez utiliser un tuyau et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rsh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rsh</span>(1)</span></a> pour
	envoyer les données sur un lecteur de bande distant:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>for f in directory_list; do</code></strong>
<strong class="userinput"><code>find $f &gt;&gt; backup.list</code></strong>
<strong class="userinput"><code>done</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cpio -v -o --format=newc &lt; backup.list | ssh user@host "cat &gt; backup_device"</code></strong></pre><p>Où <em class="replaceable"><code>directory_list</code></em> est la liste
	des répertoires que vous désirez sauvegarder,
	<em class="replaceable"><code>user</code></em>@<em class="replaceable"><code>host</code></em>
	est l'ensemble utilisateur/nom de machine qui effectuera les
	sauvegardes, et <em class="replaceable"><code>backup_device</code></em>
	représente l'unité où seront écrites les sauvegardes
	(e.g., <code class="filename">/dev/nsa0</code>).</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80661840"></a>19.12.4. <code class="command">pax</code></h3></div></div></div><a id="idp80662608" class="indexterm"></a><a id="idp80664016" class="indexterm"></a><a id="idp80664656" class="indexterm"></a><a id="idp80665168" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pax&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">pax</span>(1)</span></a> est la réponse IEEE/<span class="trademark">POSIX</span>® à
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a>.  Au fil des ans
	les différentes versions de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a>
	sont devenues légèrement incompatibles.  Aussi,
	plutôt que de batailler pour les standardiser entièrement,
	<span class="trademark">POSIX</span>® a défini un nouvel utilitaire d'archivage.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pax&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">pax</span>(1)</span></a>
	tente de lire et d'écrire nombre des divers formats
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> et <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a>, en plus de ses propres nouveaux
	formats.  Son ensemble de commandes ressemble plus à celui
	de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a> qu'à celui de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="backups-programs-amanda"></a>19.12.5. <span class="application">Amanda</span></h3></div></div></div><a id="idp80684112" class="indexterm"></a><a id="idp80685392" class="indexterm"></a><p><span class="application">Amanda</span> (Advanced Maryland
	Network Disk Archiver&#8212;Système Avancé d'Archivage
	de Disques en Réseau du Maryland) est un système
	d'archivage
	client/serveur plutôt qu'un simple programme.  Un serveur
	<span class="application">Amanda</span> archivera sur une seule
	unité de bandes un nombre quelconque d'ordinateurs disposant
	de clients <span class="application">Amanda</span> et un accès
	réseau au serveur <span class="application">Amanda</span>.
	Un problème classique sur les sites qui ont de nombreux
	disques volumineux est que le temps nécessaire pour
	sauvegarder directement les données sur la bande dépasse
	le temps alloué à cette tâche.
	<span class="application">Amanda</span> résout ce problème.
	<span class="application">Amanda</span> peut utiliser un
	&#8220;disque intermédiaire&#8221; pour sauvegarder plusieurs
	systèmes de fichiers à la fois.
	<span class="application">Amanda</span> des &#8220;jeux
	d'archive&#8221;: un ensemble de bandes utilisé pour une
	période donnée pour créer une sauvegarde
	complète de tous les systèmes de fichiers listé
	dans le fichier de configuration d'<span class="application">Amanda</span>.
	Le &#8220;jeu d'archive&#8221; contient également les
	sauvegardes nocturnes incrémentales (ou
	différentielles) de tous les systèmes de fichiers.
	Pour restaurer une système de fichiers endommagé,
	il faut la sauvegarde complète la plus récente et
	les sauvegardes incrémentales.</p><p>Le fichier de configuration permet un contrôle en finesse
	des sauvegardes et du trafic réseau
	qu'<span class="application">Amanda</span> génère.
	<span class="application">Amanda</span> utilisera n'importe quel des
	programmes de sauvegarde décrits plus haut pour écrire les
	données sur bande.  <span class="application">Amanda</span> est
	disponible sous forme de logiciel porté ou de logiciel
	pré-compilé, il n'est pas installé
	par défaut.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80691408"></a>19.12.6. Ne rien faire</h3></div></div></div><p>&#8220;Ne rien faire&#8221; n'est pas un logiciel, mais
	c'est la stratégie de sauvegarde la plus utilisée.
	Il n'y a aucun investissement initial.  Il n'y a pas de de
	planification des sauvegardes à suivre.  Juste dire non.  Si
	quelque chose arrive à vos données, souriez et
	débrouillez-vous!</p><p>Si votre temps et vos données ne valent pas grand chose,
	alors &#8220;Ne rien faire&#8221; est le programme de
	sauvegarde le mieux adapté à votre ordinateur.
	Mais prenez garde, <span class="trademark">UNIX</span>® est un outil utile, et vous pouvez vous rendre
	compte au bout de six mois que vous disposez d'une collection
	de fichiers qui vous sont utiles.</p><p>&#8220;Ne rien faire&#8221; est la bonne méthode de
	sauvegarde pour <code class="filename">/usr/obj</code> et les autres
	répertoires qui peuvent facilement être
	recréés par votre ordinateur.  Un exemple est les
	fichiers qui constituent la version HTML ou <span class="trademark">PostScript</span>® de ce manuel.
	Ces fichiers ont été générés
	à partir de fichiers SGML.
	Faire des sauvegardes des fichiers HTML ou <span class="trademark">PostScript</span>® n'est
	pas nécessaire.  Les fichiers source SGML sont
	sauvegardés régulièrement.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80695248"></a>19.12.7. Quel est le meilleur programme de sauvegarde?</h3></div></div></div><a id="idp80712400" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> <span class="emphasis"><em>Point.</em></span> Elizabeth D. Zwicky
	a soumis à rude épreuve tous les programmes de
	sauvegarde dont nous avons parlé.  Le choix de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a>
	s'impose pour préserver toutes vos données et les
	particularités des systèmes de fichiers <span class="trademark">UNIX</span>®.  Elizabeth
	a créé des systèmes de fichiers avec une grande
	variété de particularités inhabituelles (et
	quelques unes pas tellement inhabituelles) et a testé chacun des
	programmes en faisant une sauvegarde et une restauration de ces
	systèmes de fichiers.  Parmi les spécificités
	testées: fichiers avec des trous, fichiers avec des trous
	et des blocs de caractères &#8220;null&#8221;, fichiers
	dont les noms comportent des caractères inhabituels,
	les fichiers illisibles ou impossible à modifier, les
	périphériques, fichiers dont la taille change pendant
	la sauvegarde, fichiers créés ou détruits en cours
	de sauvegarde et bien plus.  Elle a présenté les
	résultats de ces tests au LISA V en Octobre 1991.
	Voir les <a class="link" href="http://berdmann.dyndns.org/zwicky/testdump.doc.html" target="_top">tests
	d'endurance des programmes de sauvegarde et
	d'archivage</a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80716496"></a>19.12.8. Procédure de restauration d'urgence</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80717136"></a>19.12.8.1. Avant le désastre</h4></div></div></div><p>Il y a quatre étapes à mettre en oeuvre en
	  prévision d'un désastre éventuel.</p><a id="idp80718160" class="indexterm"></a><p>Tout d'abord, imprimez le label de chacun de vos disques
	  (par exemple <code class="command">bsdlabel da0 | lpr</code>), votre table
	  des systèmes de fichiers (<code class="filename">/etc/fstab</code>)
	  et tous les messages de démarrage, en deux
	  exemplaires.</p><a id="idp80720208" class="indexterm"></a><p>Deuxièmement, vérifiez que vos disquettes de
	  démarrage et de reprise d'urgence
	  (<code class="filename">boot.flp</code> et <code class="filename">fixit.flp</code>)
	  incluent tous vos périphériques.  La méthode
	  la plus simple pour vérifier est de redémarrer avec la
	  disquette de démarrage dans le lecteur et contrôler
	  les messages de démarrage.  Si tous vos
	  périphériques
	  sont listés et opérationnels, passez à la
	  troisième étape.</p><p>Sinon, vous devez créer deux disquettes de démarrage
	  sur-mesure avec un noyau qui puisse monter tous vos disques et
	  accéder à votre unité de bandes.  Ces disquettes
	  doivent contenir: <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fdisk&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fdisk</span>(8)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a>,
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a>, et le programme de sauvegarde
	  que vous utilisez.  L'édition de liens de ces programmes
	  doit être statique.  Si vous utilisez <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a>, la
	  disquette doit contenir <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=restore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">restore</span>(8)</span></a>.</p><p>Troisièmement, faites régulièrement des
	  sauvegardes sur bandes.  Toutes les modifications
	  effectuées après votre dernière sauvegarde
	  peuvent irrémédiablement perdues.  Protégez
	  vos bandes de sauvegarde en écriture.</p><p>Quatrièmement, testez les disquettes (soit
	  <code class="filename">boot.flp</code> et <code class="filename">fixit.flp</code>
	  soit les deux disquettes sur-mesure que vous avez
	  créées à la seconde étape) et vos
	  bandes de sauvegarde.  Prenez note de la procédure.
	  Conservez ces notes avec la disquette de démarrage, les
	  impressions et les bandes de sauvegarde.  Vous serez si
	  préoccupé quand vous devrez restaurer que ces notes
	  peuvent vous éviter de détruire vos bandes de sauvegarde
	  (Comment?  Au lieu de <code class="command">tar xvf /dev/sa0</code>,
	  vous pourriez taper accidentellement
	  <code class="command">tar cvf /dev/sa0</code>, ce qui écraserait votre
	  bande de sauvegarde).</p><p>Par mesure de sécurité, créez une
	  disquette de démarrage et deux bandes de sauvegarde
	  à chaque fois.  Conservez-les dans un lieu
	  éloigné.  Un endroit éloigné n'est
	  PAS le sous-sol du
	  même bâtiment.  Un certain nombre de compagnies du World
	  Trade Center l'ont appris à leurs dépends.  Un endroit
	  éloigné doit être physiquement
	  séparé de vos ordinateurs
	  et de vos disques par une distance significative.</p><div class="example"><a id="idp80733904"></a><div class="example-title">Exemple 19.3. Procédure de création d'une disquette
	    de démarrage</div><div class="example-contents"><pre class="programlisting">#!/bin/sh
#
# create a restore floppy
#
# format the floppy
#
PATH=/bin:/sbin:/usr/sbin:/usr/bin

fdformat -q fd0
if [ $? -ne 0 ]
then
	 echo "Bad floppy, please use a new one"
	 exit 1
fi

# place boot blocks on the floppy
#
bsdlabel -w -B /dev/fd0c fd1440

#
# newfs the one and only partition
#
newfs -t 2 -u 18 -l 1 -c 40 -i 5120 -m 5 -o space /dev/fd0a

#
# mount the new floppy
#
mount /dev/fd0a /mnt

#
# create required directories
#
mkdir /mnt/dev
mkdir /mnt/bin
mkdir /mnt/sbin
mkdir /mnt/etc
mkdir /mnt/root
mkdir /mnt/mnt			# for the root partition
mkdir /mnt/tmp
mkdir /mnt/var

#
# populate the directories
#
if [ ! -x /sys/compile/MINI/kernel ]
then
	 cat &amp;lt;&amp;lt; EOM
The MINI kernel does not exist, please create one.
Here is an example config file:
#
# MINI - A kernel to get FreeBSD onto a disk.
#
machine         "i386"
cpu             "I486_CPU"
ident           MINI
maxusers        5

options         INET                    # needed for _tcp _icmpstat _ipstat
                                        #            _udpstat _tcpstat _udb
options         FFS                     #Berkeley Fast File System
options         FAT_CURSOR              #block cursor in syscons or pccons
options         SCSI_DELAY=15           #Be pessimistic about Joe SCSI device
options         NCONS=2                 #1 virtual consoles
options         USERCONFIG              #Allow user configuration with -c XXX

config          kernel	root on da0 swap on da0 and da1 dumps on da0

device          isa0
device          pci0

device          fdc0	at isa? port "IO_FD1" bio irq 6 drq 2 vector fdintr
device          fd0	at fdc0 drive 0

device          ncr0

device          scbus0

device          sc0	at isa? port "IO_KBD" tty irq 1 vector scintr
device          npx0	at isa? port "IO_NPX" irq 13 vector npxintr

device          da0
device          da1
device          da2

device          sa0

pseudo-device   loop            # required by INET
pseudo-device   gzip            # Exec gzipped a.out's
EOM
	 exit 1
fi

cp -f /sys/compile/MINI/kernel /mnt

gzip -c -best /sbin/init &gt; /mnt/sbin/init
gzip -c -best /sbin/fsck &gt; /mnt/sbin/fsck
gzip -c -best /sbin/mount &gt; /mnt/sbin/mount
gzip -c -best /sbin/halt &gt; /mnt/sbin/halt
gzip -c -best /sbin/restore &gt; /mnt/sbin/restore

gzip -c -best /bin/sh &gt; /mnt/bin/sh
gzip -c -best /bin/sync &gt; /mnt/bin/sync

cp /root/.profile /mnt/root

cp -f /dev/MAKEDEV /mnt/dev
chmod 755 /mnt/dev/MAKEDEV

chmod 500 /mnt/sbin/init
chmod 555 /mnt/sbin/fsck /mnt/sbin/mount /mnt/sbin/halt
chmod 555 /mnt/bin/sh /mnt/bin/sync
chmod 6555 /mnt/sbin/restore

#
# create the devices nodes
#
cd /mnt/dev
./MAKEDEV std
./MAKEDEV da0
./MAKEDEV da1
./MAKEDEV da2
./MAKEDEV sa0
./MAKEDEV pty0
cd /

#
# create minimum file system table
#
cat &amp;lt; /mnt/etc/fstab &amp;lt;&amp;lt;EOM
/dev/fd0a    /    ufs    rw  1  1
EOM

#
# create minimum passwd file
#
cat &amp;lt; /mnt/etc/passwd &amp;lt;&amp;lt;EOM
root:*:0:0:Charlie &amp;amp;:/root:/bin/sh
EOM

cat &amp;lt; /mnt/etc/master.passwd &amp;lt;&amp;lt;EOM
root::0:0::0:0:Charlie &amp;amp;:/root:/bin/sh
EOM

chmod 600 /mnt/etc/master.passwd
chmod 644 /mnt/etc/passwd
/usr/sbin/pwd_mkdb -d/mnt/etc /mnt/etc/master.passwd

#
# umount the floppy and inform the user
#
/sbin/umount /mnt
echo "The floppy has been unmounted and is now ready."</pre></div></div><br class="example-break" /></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp80735312"></a>19.12.8.2. Après le désastre</h4></div></div></div><p>La question cruciale est: votre matériel a-t-il
	  survécu?  Vous avez régulièrement fait des
	  sauvegardes, vous n'avez donc pas besoin de vous
	  inquiéter pour les fichiers et les programmes.</p><p>Si le matériel a subi des dégâts, remplacez
	  tout d'abord ce qui a été endommagé
	  avant de tenter d'utiliser l'ordinateur.</p><p>Si votre matériel est en état, contrôlez
	  vos disquettes.  Si vous utilisez une disquette de démarrage
	  personnalisée, démarrez en mode mono-utilisateur (tapez
	  <code class="literal">-s</code> à l'invite <code class="prompt">boot:</code>).
	  Sautez le paragraphe suivant.</p><p>Si vous utilisez les disquettes <code class="filename">boot.flp</code>
	  et <code class="filename">fixit.flp</code>, continuez à lire.
	  Mettre la disquette <code class="filename">boot.flp</code> dans le
	  premier lecteur et démarrez l'ordinateur.  Le menu
	  d'installation d'origine s'affiche à l'écran.
	  Choisissez
	  l'option <span class="guimenuitem">Fixit--Repair mode with CDROM or
	  floppy.</span>.  Insérez la disquette
	  <code class="filename">fixit.flp</code> quand on vous la demande.
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=restore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">restore</span>(8)</span></a> et les autres programmes dont vous avez
	  besoin sont situés dans le répertoire
	  <code class="filename">/mnt2/rescue</code>
	  (<code class="filename">/mnt2/stand</code> pour les
	  versions de FreeBSD antérieures à la 5.2).</p><p>Restaurez chaque système de fichiers
	  séparément.</p><a id="idp80746448" class="indexterm"></a><a id="idp80747344" class="indexterm"></a><a id="idp80747856" class="indexterm"></a><a id="idp80748752" class="indexterm"></a><p>Essayez <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> (e.g. <code class="command">mount /dev/da0a
	  /mnt</code>) sur la partition racine de votre premier
	  disque.  Si le label du disque est endommagé, utilisez
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a> pour repartitionner et libeller le disque
	  conformément au label que vous avez imprimé et mis
	  de côté.  Utilisez <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a> pour recréer
	  les systèmes de fichiers.  Remontez la partition racine
	  de la disquette en lecture/écriture (<code class="command">mount -u -o rw
	  /mnt</code>).  Utilisez votre programme de restauration
	  et vos bandes de sauvegardes pour restaurer les données
	  de ce système de fichiers (e.g. <code class="command">restore vrf
	  /dev/sa0</code>).  Démontez le système de fichiers
	  (e.g. <code class="command">umount /mnt</code>).  Répétez
	  l'opération pour chacun des systèmes de fichiers
	  endommagés.</p><p>Une fois que le système fonctionne à nouveau,
	  faites une sauvegarde sur de nouvelles bandes.  Ce qui
	  a causé la panne ou la perte de données peut se
	  reproduire.  Une heure de perdue maintenant peut vous
	  épargner d'autres ennuis plus tard.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="backup-strategies.html">Précédent</a> </td><td width="20%" align="center"><a accesskey="u" href="disks.html">Niveau supérieur</a></td><td width="40%" align="right"> <a accesskey="n" href="disks-virtual.html">Suivant</a></td></tr><tr><td width="40%" align="left" valign="top">19.11. Stratégies de sauvegarde </td><td width="20%" align="center"><a accesskey="h" href="index.html">Sommaire</a></td><td width="40%" align="right" valign="top"> 19.13. Systèmes de fichiers réseaux, en mémoire
      et sauvegardés sur fichier</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Ce document, ainsi que d'autres peut être téléchargé sur
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Pour toutes questions à propos de FreeBSD, lisez la
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> avant de contacter
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    Pour les questions sur cette documentation, contactez
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.</small></p></body></html>