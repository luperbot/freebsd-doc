<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>10.4. Расширенная настройка принтера</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="printing.html" title="Глава 10. Печать" /><link rel="prev" href="printing-intro-setup.html" title="10.3. Основная настройка" /><link rel="next" href="printing-using.html" title="10.5. Использование принтеров" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.4. Расширенная настройка принтера</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="printing-intro-setup.html">Пред.</a> </td><th width="60%" align="center">Глава 10. Печать</th><td width="20%" align="right"> <a accesskey="n" href="printing-using.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="printing-advanced"></a>10.4. Расширенная настройка принтера</h2></div></div></div><p>В этом разделе описаны фильтры для печати специально сформатированных
      файлов, начальных страниц, печати по сети, ограничения и учета использования
      принтера.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-filter-intro"></a>10.4.1. Фильтры</h3></div></div></div><a id="idp83574480" class="indexterm"></a><p>Хотя система <span class="application">LPD</span> поддерживает сетевые
	протоколы, очереди, контроль доступа и другие аспекты печати, большая
	часть <span class="emphasis"><em>реальной</em></span> работы происходит в
	<span class="emphasis"><em>фильтрах</em></span>. Фильтры - это программы,
	взаимодействующие с принтером и обеспечивающие учет особенностей
	устройства и специальных требований. При простой настройке принтера
	мы установили фильтр для обычного текста - крайне простой, который
	должен работать с большинством принтеров (см. раздел
	<a class="link" href="printing-intro-setup.html#printing-textfilter" title="10.3.1.5.6. Установка текстового фильтра">Установка текстового
	фильтра</a>).</p><p>Однако, чтобы обеспечить преобразования формата, учет использования
	принтера и индивидуальных особенностей отдельных принтеров и т.п.,
	надо разобраться, как работают фильтры. В конечном итоге, всеми этими
	аспектами печати должен заниматься фильтр. А плохая новость состоит
	в том, что, в большинстве случаев, вы <span class="emphasis"><em>сами</em></span>
	должны предоставить соответствующие фильтры. Хорошая новость состоит
	в том, что многие фильтры общедоступны; а если подходящих нет,
	их обычно легко написать.</p><p>Кроме того, в составе ОС FreeBSD поставляется один фильтр,
	<code class="filename">/usr/libexec/lpr/lpf</code>, работающий со многими
	принтерами, которые могут печатать обычный текст. (Он обрабатывает
	символы забоя и табуляции в файле, выполняет учет использования, но
	и не более того.) Есть также ряд фильтров и компонентов фильтров
	в наборе портов FreeBSD.</p><p>Вот что вы найдете в этом разделе:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>В разделе <a class="link" href="printing-advanced.html#printing-advanced-filters" title="10.4.1.1. Как работают фильтры">Как работают
	    фильтры</a> сделана попытка дать обзор роли фильтра в процессе
	    печати. Прочтите этот раздел, чтобы понять, что происходит
	    <span class="quote"><<<span class="quote">за кадром</span>>></span>, когда система <span class="application">LPD</span>
	    использует фильтры. Это понимание поможет предвидеть и решать
	    проблемы, с которыми вы можете столкнуться при добавлении дополнительных
	    фильтров для каждого из принтеров.</p></li><li class="listitem"><p>Система <span class="application">LPD</span> предполагает, что
	    каждый принтер, по умолчанию, может печатать обычный текст. Это
	    проблематично для <span class="trademark">PostScript</span>(R)-принтеров (или принтеров на базе
	    другого языка), поскольку они не могут печатать обычный текст
	    непосредственно. В разделе
	    <a class="link" href="printing-advanced.html#printing-advanced-if-conversion" title="10.4.1.2. Прием заданий с обычным текстом на PostScript(R)-принтеры">Прием заданий с
	    обычным текстом на <span class="trademark">PostScript</span>(R)-принтеры</a> описано, что
	    нужно сделать, чтобы решить эту проблему. Прочтите этот раздел,
	    если используете <span class="trademark">PostScript</span>(R)-принтер.</p></li><li class="listitem"><p><span class="trademark">PostScript</span>(R) - популярный формат выдачи для многих программ.
	    Некоторые люди даже пишут <span class="trademark">PostScript</span>(R)-код непосредственно. К
	    сожалению, <span class="trademark">PostScript</span>(R)-принтеры дороги. В разделе <a class="link" href="printing-advanced.html#printing-advanced-ps" title="10.4.1.3. Имитация PostScript(R) на не-PostScript(R) принтерах">Имитация <span class="trademark">PostScript</span>(R) на
	    не-<span class="trademark">PostScript</span>(R) принтерах</a> описано, как можно дополнительно
	    изменить текстовый фильтр принтера для приема и печати данных
	    <span class="trademark">PostScript</span>(R) не <span class="emphasis"><em>не-<span class="trademark">PostScript</span>(R)</em></span> принтере.
	    Прочтите этот раздел, если ваш принтер не поддерживает
	    <span class="trademark">PostScript</span>(R).</p></li><li class="listitem"><p>В разделе <a class="link" href="printing-advanced.html#printing-advanced-convfilters" title="10.4.1.4. Фильтры преобразования">Фильтры преобразования</a>
	      описан способ автоматизации преобразования определенных форматов
	      файлов, например, графики или данных для печатного станка, в форматы,
	      которые может обработать ваш принтер. После чтения этого раздела
	      вы сможете настроить свои принтеры так, что пользователи смогут
	      выполнять команду <code class="command">lpr -t</code> для печати данных troff,
	      или <code class="command">lpr -d</code> для печати данных <span class="application">TeX</span> DVI, или
	      <code class="command">lpr -v</code> - для печати растровых изображений, и
	      так далее. Я рекомендую прочитать этот раздел.</p></li><li class="listitem"><p>В разделе <a class="link" href="printing-advanced.html#printing-advanced-of" title="10.4.1.5. Выходные фильтры">Выходные фильтры</a>
	    описана не часто используемая возможность задавать выходные
	    фильтры в системе <span class="application">LPD</span>. Если только вы
	    не печатаете начальные страницы (см. <a class="link" href="printing-advanced.html#printing-advanced-header-pages" title="10.4.2. Начальные страницы">Начальные страницы</a>),
	    можно, пожалуй, вообще пропустить этот раздел.</p></li><li class="listitem"><p>В разделе <a class="link" href="printing-advanced.html#printing-advanced-lpf" title="10.4.1.6. lpf: текстовый фильтр">lpf: текстовый
	    фильтр</a> описана команда <code class="command">lpf</code>, - достаточно
	    полный, хотя и простой текстовый фильтр для строчных принтеров
	    (и лазерных принтеров, работающих как строчные), поставляемый в
	    составе ОС FreeBSD. Если надо быстро настроить учет использования
	    принтера для обычного текста или если используется принтер,
	    из которого при получении символов забоя идет дым, несомненно,
	    стоит подумать об использовании <code class="command">lpf</code>.</p></li></ul></div><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Различные скрипты, описанные далее, можно найти в каталоге
	  <code class="filename">/usr/share/examples/printing</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-filters"></a>10.4.1.1. Как работают фильтры</h4></div></div></div><p>Как уже упоминалось, фильтр - это выполняемая программа, запускаемая
	  системой <span class="application">LPD</span> для поддержки специфических
	  особенностей устройства при взаимодействии с принтером.</p><p>Когда системе <span class="application">LPD</span> надо напечатать
	  входящий в задание файл, она запускает программу-фильтр. Стандартный
	  входной поток фильтра связывается с файлом, который надо распечатать,
	  его стандартный выходной поток - с принтером, а стандартный поток
	  ошибок перенаправляется в файл регистрации ошибок (задается
	  характеристикой <code class="literal">lf</code> в файле
	  <code class="filename">/etc/printcap</code>, или используется стандартное
	  устройство <code class="filename">/dev/console</code>).</p><a id="idp83647952" class="indexterm"></a><p>Запускаемый системой <span class="application">LPD</span> фильтр и его
	  аргументы зависят от того, что указано в файле
	  <code class="filename">/etc/printcap</code>, и какие аргументы указал
	  пользователь для задания в команде <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a>. Например,
	  если пользователь ввел команду <code class="command">lpr -t</code>,
	  система <span class="application">LPD</span> должна запустить фильтр troff,
	  заданный характеристикой <code class="literal">tf</code> для соответствующего
	  принтера. Если пользователь хочет печатать обычный текст, система
	  должна запустить фильтр <code class="literal">if</code> (это верно в большинстве
	  случаев: подробнее см. в разделе
	  <a class="link" href="printing-advanced.html#printing-advanced-of" title="10.4.1.5. Выходные фильтры">Выходные фильтры</a>).</p><p>В файле <code class="filename">/etc/printcap</code> можно задавать
	  три вида фильтров:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="emphasis"><em>Текстовый фильтр</em></span>, который в документации
	      <span class="application">LPD</span> двусмысленно называют
	      <span class="emphasis"><em>входным фильтром</em></span>, обеспечивает печать
	      обычного текста. Рассматривайте его как стандартный фильтр.
	      Система <span class="application">LPD</span> предполагает, что любой
	      принтер может по умолчанию печатать обычный текст, а на текстовый
	      фильтр возлагается задача обеспечить, чтобы символы забоя,
	      табуляции или другие специальные символы не сбивали принтер с
	      толку. Если вы работаете в среде, где надо учитывать
	      использование принтера, текстовый фильтр должен также
	      учитывать количество напечатанных страниц, обычно, подсчитывая
	      количество напечатанных строк и сравнивая их с количеством строк на
	      страницу, поддерживаемых принтером. Текстовый фильтр запускается со
	      следующим списком аргументов:

	      </p><div class="cmdsynopsis"><p><code class="command">имя-фильтра</code> [-c]  -w<em class="replaceable"><code>ширина</code></em>   -l<em class="replaceable"><code>длина</code></em>   -i<em class="replaceable"><code>сдвиг</code></em>   -n <em class="replaceable"><code>имя-пользователя</code></em>   -h <em class="replaceable"><code>хост</code></em>   <em class="replaceable"><code>учетный-файл</code></em> </p></div><p>

	      где

	      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-c</code></span></dt><dd><p>указывается, если задание послано командой
		      <code class="command">lpr -l</code></p></dd><dt><span class="term"><em class="replaceable"><code>ширина</code></em></span></dt><dd><p>значение из характеристики <code class="literal">pw</code> (page
		      width - ширина страницы), указанной в файле
		      <code class="filename">/etc/printcap</code>, по умолчанию - 132</p></dd><dt><span class="term"><em class="replaceable"><code>длина</code></em></span></dt><dd><p>значение из характеристики <code class="literal">pl</code> (page
		      length - длина страницы), по умолчанию - 66</p></dd><dt><span class="term"><em class="replaceable"><code>сдвиг</code></em></span></dt><dd><p>сдвиг, заданный командой <code class="command">lpr -i</code>,
		    по умолчанию - 0</p></dd><dt><span class="term"><em class="replaceable"><code>имя-пользователя</code></em></span></dt><dd><p>регистрационное имя пользователя, печатающего файл</p></dd><dt><span class="term"><em class="replaceable"><code>хост</code></em></span></dt><dd><p>имя хоста, с которого было послано задание</p></dd><dt><span class="term"><em class="replaceable"><code>учетный-файл</code></em></span></dt><dd><p>имя учетного файла, задаваемое характеристикой
		      <code class="literal">af</code>.</p></dd></dl></div><p>
	    </p></li><li class="listitem"><a id="idp83684688" class="indexterm"></a><p><span class="emphasis"><em>Фильтр преобразования</em></span> преобразует
	      специфичный формат файла в то, что принтер может воспроизвести
	      на бумаге. Например, данные системы набора ditroff нельзя печатать
	      непосредственно, но можно установить фильтр преобразования
	      для файлов ditroff, чтобы преобразовывать данные ditroff
	      в тот вид, который принтер может воспринять и напечатать. В разделе
	      <a class="link" href="printing-advanced.html#printing-advanced-convfilters" title="10.4.1.4. Фильтры преобразования">Фильтры
	      преобразования</a> написано всё об этих фильтрах. Фильтры
	      преобразования также необходимы для учета, если предполагается
	      учет использования принтера. Фильтры преобразования
	      запускаются со следующими аргументами:

	      </p><div class="cmdsynopsis"><p><code class="command">имя-фильтра</code>  -x<em class="replaceable"><code>ширина-пиксела</code></em>   -y<em class="replaceable"><code>высота-пиксела</code></em>   -n <em class="replaceable"><code>имя-пользователя</code></em>   -h <em class="replaceable"><code>хост</code></em>   <em class="replaceable"><code>учетный-файл</code></em> </p></div><p>

	      где <em class="replaceable"><code>ширина-пиксела</code></em> - значение
	      характеристики px (по умолчанию - 0),
	      а <em class="replaceable"><code>высота-пиксела</code></em> - значение характеристики
	      py (по умолчанию - 0).</p></li><li class="listitem"><p><span class="emphasis"><em>Выходной фильтр</em></span> используется только
	      если нет текстового фильтра или если включена выдача начальных
	      страниц. Судя по моему опыту, выходные фильтры используются редко.
	      Они описаны в разделе <a class="link" href="printing-advanced.html#printing-advanced-of" title="10.4.1.5. Выходные фильтры">Выходные
	      фильтры</a>. У выходного фильтра есть всего два аргумента:

	      </p><div class="cmdsynopsis"><p><code class="command">имя-фильтра</code>  -w<em class="replaceable"><code>ширина</code></em>   -l<em class="replaceable"><code>длина</code></em> </p></div><p>

	      которые идентичны аргументам <code class="option">-w</code> и
	      <code class="option">-l</code> текстового фильтра.</p></li></ul></div><p>Фильтры также должны <span class="emphasis"><em>завершать работу</em></span> со
	  следующим статусом выхода:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">exit 0</span></dt><dd><p>Если фильтр успешно напечатал файл.</p></dd><dt><span class="term">exit 1</span></dt><dd><p>Если фильтр не смог напечатать файл, но хочет, чтобы
		система <span class="application">LPD</span> попыталась
		распечатать файл ещё раз. Система <span class="application">LPD</span>
		перезапустит фильтр, если его работа завершена с этим статусом.</p></dd><dt><span class="term">exit 2</span></dt><dd><p>Если фильтр не смог напечатать файл и не хочет, чтобы
		система <span class="application">LPD</span> пыталась его печатать
		еще раз. Система <span class="application">LPD</span> удалит файл.</p></dd></dl></div><p>Поставляемый в составе FreeBSD текстовый фильтр
	  <code class="filename">/usr/libexec/lpr/lpf</code> использует аргументы, задающие
	  ширину и длину страницы для определения того, когда посылать символ
	  прогона страницы (form feed) и как учитывать использование принтера.
	  Он использует переданные в качестве аргументов имя пользователя,
	  хост и учетный файл для внесения учетных записей.</p><p>При поиске фильтров убедитесь, что они совместимы с системой LPD.
	  Если да, они должны поддерживать описанные выше списки аргументов.
	  Если вы планируете создавать фильтры для общего использования,
	  позаботьтесь о поддержке этих списков аргументов и кодов выхода.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-if-conversion"></a>10.4.1.2. Прием заданий с обычным текстом на <span class="trademark">PostScript</span>(R)-принтеры</h4></div></div></div><a id="idp83720016" class="indexterm"></a><p>Если вы - единственный пользователь компьютера и <span class="trademark">PostScript</span>(R)-принтера
	  (или принтера на основе другого языка), и вы обещаете никогда не
	  посылать на принтер обычный текст и никогда не использовать возможностей
	  различных программ, требующих посылки на принтер обычного текста,
	  вам можно не заботиться о том, что описано в этом разделе.</p><p>Но, если вы хотите посылать на принтер как задания <span class="trademark">PostScript</span>(R),
	  так и обычный текст, рекомендуется дополнить настройку принтера. Для
	  этого надо, чтобы текстовый фильтр определял, является ли поступающее
	  задание обычным текстом или программой на языке <span class="trademark">PostScript</span>(R). Все
	  <span class="trademark">PostScript</span>(R)-задания должны начинаться с <code class="literal">%!</code> (для
	  других языков принтеров обратитесь к соответствующей документации).
	  Если первые два символа в задании - именно эти, речь идет о <span class="trademark">PostScript</span>(R),
	  и мы можем остальную часть задания передавать непосредственно. Если же
	  первые два символа в файле - другие, фильтр будет преобразовывать
	  текст в <span class="trademark">PostScript</span>(R) и печатать результат.</p><p>Как нам это сделать?</p><a id="idp83725264" class="indexterm"></a><p>Если вы используете последовательный принтер, хороший способ
	  достичь поставленной цели состоит в установке <code class="command">lprps</code>.
	  <code class="command">lprps</code> - это фильтр для <span class="trademark">PostScript</span>(R)-принтера,
	  выполняющий двустороннее взаимодействие с принтером. Он обновляет файл
	  состояния принтера, помещая в него подробную информацию, выданную
	  принтером, так что пользователи и администраторы могут узнать,
	  в каком именно состоянии (например, <span class="errorname">toner low</span>
	  или <span class="errorname">paper jam</span>) находится принтер. Но еще
	  важнее, что он включает программу <code class="command">psif</code>, которая
	  определяет, является ли входящее задание обычным текстом, и вызывает
	  <code class="command">textps</code> (еще одну программу, поставляемую вместе
	  с <code class="command">lprps</code>) для преобразования его в <span class="trademark">PostScript</span>(R).
	  Затем <code class="command">lprps</code> посылает преобразованное задание
	  на принтер.</p><p><code class="command">lprps</code> входит в набор портов FreeBSD
	  (см. <a class="link" href="ports.html" title="Глава 5. Установка приложений: порты и пакеты">Набор портов</a>). Вы, конечно, можете
	  загрузить, собрать и установить его самостоятельно. После установки
	  <code class="command">lprps</code> просто укажите путь к программе
	  <code class="command">psif</code>, входящей в состав пакета
	  <code class="command">lprps</code>. Если вы установили <code class="command">lprps</code>
	  из Коллекции Портов, используйте следующий текст в записи для
	  последовательного <span class="trademark">PostScript</span>(R)-принтера в файле
	  <code class="filename">/etc/printcap</code>:</p><pre class="programlisting">:if=/usr/local/libexec/psif:</pre><p>Надо также задать характеристику <code class="literal">rw</code>;
	  она требует от системы <span class="application">LPD</span> открывать принтер
	  в режиме чтения и записи.</p><p>При использовании параллельного <span class="trademark">PostScript</span>(R)-принтера (что не
	  позволяет обеспечить двустороннее взаимодействие с принтером,
	  необходимое для системы <code class="command">lprps</code>), можно
	  использовать в качестве текстового фильтра следующий скрипт командного
	  интерпретатора:</p><pre class="programlisting">#!/bin/sh
#
#  psif - Печать PostScript или обычного текста на PostScript-принтере
#  Скрипт, а НЕ версия, входящая в состав lprps
#  Установлен в /usr/local/libexec/psif
#

IFS="" read -r first_line
first_two_chars=`expr "$first_line" : '\(..\)'`

if [ "$first_two_chars" = "%!" ]; then
    #
    #  Задание PostScript, печатать его.
    #
    echo "$first_line" &amp;&amp; cat &amp;&amp; printf "\004" &amp;&amp; exit 0
    exit 2
else
    #
    #  Обычный текст, преобразовать его, а затем напечатать.
    #
    ( echo "$first_line"; cat ) | /usr/local/bin/textps &amp;&amp; printf "\004" &amp;&amp; exit 0
    exit 2
fi</pre><p>В представленном выше скрипте, <code class="command">textps</code> -
          отдельно установленная программа для преобразования обычного текста в
	  <span class="trademark">PostScript</span>(R). Можно использовать любую программу преобразования
          текста в <span class="trademark">PostScript</span>(R).  Коллекция Портов FreeBSD (см. материал о
          <a class="link" href="ports.html" title="Глава 5. Установка приложений: порты и пакеты">Коллекции Портов</a>) включает
          полнофункциональную программу преобразования текста в <span class="trademark">PostScript</span>(R)
          под названием <code class="literal">a2ps</code>, которую
	  тоже можно попробовать использовать.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-ps"></a>10.4.1.3. Имитация <span class="trademark">PostScript</span>(R) на не-<span class="trademark">PostScript</span>(R) принтерах</h4></div></div></div><a id="idp83755600" class="indexterm"></a><a id="idp83756752" class="indexterm"></a><p><span class="trademark">PostScript</span>(R) является <span class="emphasis"><em>фактическим</em></span> стандартом для
	  высококачественного набора и печати. <span class="trademark">PostScript</span>(R), однако, -
	  <span class="emphasis"><em>дорогой</em></span> стандарт. К счастью, благодаря компании
	  Aladdin Enterprises есть свободный аналог <span class="trademark">PostScript</span>(R) под названием
	  <span class="application">Ghostscript</span>, который работает с FreeBSD.
	  Ghostscript может читать большинство <span class="trademark">PostScript</span>(R)-файлов и выдавать
	  соответствующие страницы на множество устройств, включая многие
	  моделей не-PostScript принтеров. Установив Ghostscript и используя
	  специальный текстовый фильтр для принтера, можно заставить ваш
	  не-<span class="trademark">PostScript</span>(R) принтер работать фактически как <span class="trademark">PostScript</span>(R)-принтер.</p><p>Ghostscript входит в набор портов FreeBSD, если вы хотите
	  устанавливать его оттуда. Вы можете также легко загрузить, собрать и
	  установить его самостоятельно.</p><p>Для имитации <span class="trademark">PostScript</span>(R) надо, чтобы текстовый фильтр
	  определял, печатается ли <span class="trademark">PostScript</span>(R)-файл. Если нет, фильтр будет
	  передавать файл на принтер непосредственно; в противном случае, он
	  будет использовать Ghostscript, чтобы сначала преобразовать файл в
	  формат, который поймет принтер.</p><p>Рассмотрим пример: следующий сценарий представляет собой
	  текстовый фильтр для принтеров Hewlett Packard DeskJet 500.
	  Для других принтеров замените аргумент <code class="option">-sDEVICE</code>
	  в команде <code class="command">gs</code> (Ghostscript). (Введите
	  команду <code class="command">gs -h</code> для получения списка устройств,
	  поддерживаемых установленной версией Ghostscript.)</p><pre class="programlisting">#!/bin/sh
#
#  ifhp - Печать Ghostscript-эмулированного PostScript на DeskJet 500
#  Установлен в /usr/local/libexec/ifhp

#
#  Обрабатывать LF как CR+LF (чтобы избежать "эффекта ступенек"
#  на принтерах HP/PCL:
#
printf "\033&amp;k2G" || exit 2

#
#  Прочитать первые два символа файла
#
IFS="" read -r first_line
first_two_chars=`expr "$first_line" : '\(..\)'`

if [ "$first_two_chars" = "%!" ]; then
    #
    #  Это PostScript; используем Ghostscript для чтения, преобразования и печати.
    #
    /usr/local/bin/gs -dSAFER -dNOPAUSE -q -sDEVICE=djet500 \
        -sOutputFile=- - &amp;&amp; exit 0
else
    #
    #  Обычный текст или HP/PCL, поэтому просто печатаем его напрямую; печатаем в
    #  конце символ прогона страницы, чтобы была выдана последняя страница.
    #
    echo "$first_line" &amp;&amp; cat &amp;&amp; printf "\033&amp;l0H" &amp;&amp;
exit 0
fi

exit 2</pre><p>Наконец, надо указать системе <span class="application">LPD</span>,
	  какой фильтр использовать, задав характеристику <code class="literal">if</code>:</p><pre class="programlisting">:if=/usr/local/libexec/ifhp:</pre><p>Вот и все. Теперь можно выполнять <code class="command">lpr plain.text</code>
	  и <code class="filename">lpr whatever.ps</code>, и обе команды должны успешно
	  печатать.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-convfilters"></a>10.4.1.4. Фильтры преобразования</h4></div></div></div><p>После завершения простой настройки, описанной в разделе
	  <a class="link" href="printing-intro-setup.html#printing-simple" title="10.3.1. Простая настройка принтера">Простая настройка принтера</a>,
	  прежде всего, вам может потребоваться установить фильтры
	  преобразования для любимых форматов файлов (кроме обычных
	  текстов ASCII).</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83774544"></a>10.4.1.4.1. Зачем устанавливать фильтры преобразования?</h5></div></div></div><a id="idp83775184" class="indexterm"></a><p>Фильтры преобразования упрощают печать различного рода файлов.
	    В качестве примера, предположим, что активно используется
	    издательская система <span class="application">TeX</span> и имеется <span class="trademark">PostScript</span>(R)-принтер.
	    При каждой генерации DVI-файла из <span class="application">TeX</span>, мы не можем печатать его
	    непосредственно, пока не преобразуем в <span class="trademark">PostScript</span>(R). Для этого
	    используется такая последовательность команд:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>dvips seaweed-analysis.dvi</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>lpr seaweed-analysis.ps</code></strong></pre><p>Установив фильтр преобразования для файлов DVI, мы можем не
	    конвертировать файл каждый раз вручную, возложив эту задачу на
	    систему <span class="application">LPD</span>. Теперь при каждом получении
	    DVI-файла нас от его распечатки отделяет только один шаг:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lpr -d seaweed-analysis.dvi</code></strong></pre><p>Мы заставили систему <span class="application">LPD</span> автоматически
	    преобразовывать DVI-файл, указав опцию <code class="option">-d</code>. Все
	    опции преобразования представлены в разделе
	    <a class="link" href="printing-using.html#printing-lpr-options-format" title="10.5.4.1. Опции форматирования и преобразования">Опции форматирования
	    и преобразования</a>.</p><p>Для каждой из опций преобразования, которая должна поддерживаться
	    принтером, установите <span class="emphasis"><em>фильтр преобразования</em></span> и
	    укажите его полное имя в файле <code class="filename">/etc/printcap</code>.
	    Фильтр преобразования аналогичен текстовому фильтру для простой
	    настройки принтера (см. раздел
	    <a class="link" href="printing-intro-setup.html#printing-textfilter" title="10.3.1.5.6. Установка текстового фильтра">Установка текстового фильтра</a>),
	    но вместо печати обычного текста он преобразует файл в формат,
	    который может понять принтер.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83789648"></a>10.4.1.4.2. Какие фильтры преобразования следует устанавливать?</h5></div></div></div><p>Устанавливать надо те фильтры преобразования, которые
	    предполагается использовать. Если вы часто печатаете файлы DVI,
	    значит, фильтр преобразования DVI необходим. Если вам часто
	    приходится печатать результаты работы troff, может потребоваться
	    фильтр troff.</p><p>В следующей таблице представлены фильтры, с которыми
	    работает система <span class="application">LPD</span>, их
	    соответствующие характеристики для файла
	    <code class="filename">/etc/printcap</code>, а также способ их вызова
	    в команде <code class="command">lpr</code>:</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Тип файла</th><th>Характеристика <code class="filename">/etc/printcap</code></th><th>Опция <code class="command">lpr</code></th></tr></thead><tbody><tr><td>cifplot</td><td><code class="literal">cf</code></td><td><code class="option">-c</code></td></tr><tr><td>DVI</td><td><code class="literal">df</code></td><td><code class="option">-d</code></td></tr><tr><td>plot</td><td><code class="literal">gf</code></td><td><code class="option">-g</code></td></tr><tr><td>ditroff</td><td><code class="literal">nf</code></td><td><code class="option">-n</code></td></tr><tr><td>Текст на языке FORTRAN</td><td><code class="literal">rf</code></td><td><code class="option">-f</code></td></tr><tr><td>troff</td><td><code class="literal">tf</code></td><td><code class="option">-f</code></td></tr><tr><td>растровое изображение</td><td><code class="literal">vf</code></td><td><code class="option">-v</code></td></tr><tr><td>обычный текст</td><td><code class="literal">if</code></td><td>никакой, <code class="option">-p</code> или
		    <code class="option">-l</code></td></tr></tbody></table></div><p>В нашем примере использование <code class="command">lpr -d</code> означает,
	    что для принтера должна быть задана характеристика
	    <code class="literal">df</code> в записи в файле
	    <code class="filename">/etc/printcap</code>.</p><a id="idp83821136" class="indexterm"></a><p>Вопреки мнению многих, форматы вроде текста на языке FORTRAN
	    и plot, вероятно, устарели. У себя на машине вы можете дать
	    новые значения этим или любым другим опциям форматирования,
	    установив соответствующие специализированные фильтры. Например,
	    пусть необходимо напрямую печатать файлы Printerleaf (файлы
	    настольной издательской системы Interleaf), но вообще вы не собираетесь
	    печатать файлы типа plot. Можно установить фильтр преобразования
	    Printerleaf в качестве значения характеристики <code class="literal">gf</code>
	    и научить своих пользователей, что команда <code class="command">lpr -g</code>
	    означает <span class="quote"><<<span class="quote">печатать файлы Printerleaf</span>>></span>.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83823312"></a>10.4.1.4.3. Установка фильтров преобразования</h5></div></div></div><p>Поскольку фильтры преобразования представляют собой программы,
	    не входящие в базовую поставку FreeBSD, их, видимо, надо помещать
	    в каталоге <code class="filename">/usr/local</code>. Популярное
	    местонахождение - каталог <code class="filename">/usr/local/libexec</code>,
	    поскольку эти фильтры являются специализированными программами для
	    выполнения системой <span class="application">LPD</span>; обычным
	    пользователям никогда не понадобится их выполнять.</p><p>Для включения фильтра преобразования, укажите его полное
	    имя в качестве значения соответствующей характеристики для принтера
	    в файле <code class="filename">/etc/printcap</code>.</p><p>В качестве примера, давайте добавим фильтр преобразования DVI
	    в запись для принтера <code class="literal">bamboo</code>. Вот опять пример
	    файла <code class="filename">/etc/printcap</code>, с новой характеристикой
	    <code class="literal">df</code> для принтера <code class="literal">bamboo</code>.</p><pre class="programlisting">#
#  /etc/printcap для хоста rose - добавлен фильтр df для bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Фильтр DVI - скрипт командного интерпретатора по имени
            <code class="filename">/usr/local/libexec/psdf</code>. Вот его текст:</p><pre class="programlisting">#!/bin/sh
#
#  psdf - фильтр принтера, преобразующий DVI в PostScript
#  Установлен в /usr/local/libexec/psdf
#
# Вызывается системой lpd при выполнении пользователем команды lpr -d
#
exec /usr/local/bin/dvips -f | /usr/local/libexec/lprps "$@"</pre><p>Это скрипт выполняет команду <code class="command">dvips</code> в режиме
	    фильтрования (аргумент <code class="option">-f</code>) входного потока,
	    представляющего собой задание для печати. Затем запускается
	    фильтр <span class="trademark">PostScript</span>(R)-принтера <code class="command">lprps</code> (см. раздел
	    <a class="link" href="printing-advanced.html#printing-advanced-if-conversion" title="10.4.1.2. Прием заданий с обычным текстом на PostScript(R)-принтеры">Прием заданий с
	    обычным текстом на <span class="trademark">PostScript</span>(R)-принтеры</a>) с аргументами,
	    переданными системой <span class="application">LPD</span> этому скрипту.
	    Команда <code class="command">lprps</code> будет использовать эти аргументы
	    для учета распечатанных страниц.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp83833936"></a>10.4.1.4.4. Дополнительные примеры фильтров преобразования</h5></div></div></div><p>Поскольку нет фиксированного набора шагов для установки
	    фильтров преобразования, я просто представлю дополнительные
	    примеры. Используйте их в качестве руководства при создании
	    собственных фильтров. Используйте их непосредственно, если
	    нужно.</p><p>Следующий пример фильтра преобразует растровый файл (точнее,
	    GIF-файл) для печати на принтере Hewlett Packard LaserJet III-Si:</p><pre class="programlisting">#!/bin/sh
#
#  hpvf - Преобразовать GIF-файлы в HP/PCL и напечатать
#  Установлен в /usr/local/libexec/hpvf

PATH=/usr/X11R6/bin:$PATH; export PATH
giftopnm | ppmtopgm | pgmtopbm | pbmtolj -resolution 300 \
    &amp;&amp; exit 0 \
    || exit 2</pre><p>Он работает путем преобразования GIF-файла в переносимый формат anymap,
	    его - в переносимый формат graymap, затем - в переносимый bitmap,
	    а уже его - в данные, подходящие для LaserJet/PCL.</p><p>Вот файл <code class="filename">/etc/printcap</code> с записью для
	    принтера, в которой используется представленный выше фильтр:</p><pre class="programlisting">#
#  /etc/printcap для хоста orchid
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sh:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/hpif:\
        :vf=/usr/local/libexec/hpvf:</pre><p>Следующий скрипт является фильтром преобразования для печати
            данных troff, получаемых из системы набора groff, на
            <span class="trademark">PostScript</span>(R)-принтере <code class="literal">bamboo</code>:</p><pre class="programlisting">#!/bin/sh
#
#  pstf - Преобразует выдаваемые groff данные troff в PS и печатает.
#  Установлен в /usr/local/libexec/pstf
#
exec grops | /usr/local/libexec/lprps "$@"</pre><p>Представленный выше скрипт снова использует команду
	    <code class="command">lprps</code> для взаимодействия с принтером.
	    Если принтер подключен к параллельному порту, придется
	    использовать следующий скрипт:</p><pre class="programlisting">#!/bin/sh
#
#  pstf - Преобразует выдаваемые groff данные troff в PS и печатает.
#  Установлен в /usr/local/libexec/pstf
#
exec grops</pre><p>Вот и все. Вот какую запись надо добавить в файл
	    <code class="filename">/etc/printcap</code>, чтобы включить этот фильтр:</p><pre class="programlisting">:tf=/usr/local/libexec/pstf:</pre><p>Вот пример, который пригодится старым специалистам по языку FORTRAN.
	    Это фильтр для печати текста программы на языке FORTRAN на любом принтере,
	    который может непосредственно печатать обычный текст. Мы установим его
	    для принтера <code class="literal">teak</code>:</p><pre class="programlisting">#!/bin/sh
#
# hprf - Фильтр текста на языке FORTRAN для LaserJet 3si:
# Установлен в /usr/local/libexec/hprf
#

printf "\033&amp;k2G" &amp;&amp; fpr &amp;&amp; printf "\033&amp;l0H" &amp;&amp;
 exit 0
exit 2</pre><p>Надо добавить следующую строку к записи в файле
	    <code class="filename">/etc/printcap</code> для принтера
	    <code class="literal">teak</code>, чтобы включить этот фильтр:</p><pre class="programlisting">:rf=/usr/local/libexec/hprf:</pre><p>Перейдем к последнему, более сложному примеру. Мы добавим фильтр
	    DVI для уже использовавшегося принтера LaserJet по имени
	    <code class="literal">teak</code>. Сначала простая часть: изменить файл
	    <code class="filename">/etc/printcap</code>, указав местонахождение
	    фильтра DVI:</p><pre class="programlisting">:df=/usr/local/libexec/hpdf:</pre><p>А теперь - часть посложнее: создать фильтр. Для этого нам
	    понадобится программа преобразования DVI в LaserJet/PCL. Набор
	    портов FreeBSD (см. <a class="link" href="ports.html" title="Глава 5. Установка приложений: порты и пакеты">Набор портов</a>)
	    содержит одну: соответствующий пакет называется
	    <code class="command">dvi2xx</code>. Установка этого пакета дает нам
	    необходимую программу, <code class="command">dvilj2p</code>, которая
	    преобразует DVI в коды, подходящие для LaserJet IIp,
	    LaserJet III и LaserJet 2000.</p><p>Команда <code class="command">dvilj2p</code> требует создания
	    достаточно сложного фильтра <code class="command">hpdf</code>, поскольку
	    она не может читать стандартный входной поток. Она хочет работать
	    с именем файла. Что еще хуже, имя файла должно завершаться
	    расширением <code class="filename">.dvi</code>, так что использование
	    стандартного входного потока <code class="filename">/dev/fd/0</code>
	    тоже проблематично. Мы можем обойти эту проблему, создав (символическую)
	    связь (с именем, завершающимся суффиксом <code class="filename">.dvi</code>) с
	    устройством <code class="filename">/dev/fd/0</code>, тем самым, заставив
	    команду <code class="command">dvilj2p</code> читать из стандартного входного
	    потока.</p><p>Единственная оставшаяся проблема состоит в том, что мы не можем
	    создавать временную связь в каталоге <code class="filename">/tmp</code>.
	    Символьные связи принадлежат пользователю и группе <code class="systemitem">bin</code>.
	    Фильтр же работает от имени пользователя <code class="systemitem">daemon</code>. А у
	    каталога <code class="filename">/tmp</code> установлен sticky bit. Фильтр сможет
	    создать связь, но не сможет почистить за собой и удалить ее, поскольку
	    связь будет принадлежать другому пользователю.</p><p>Вместо этого, фильтр будет создавать символическую связь в текущем
	    рабочем каталоге, которым является каталог спулинга (задаваемый
	    характеристикой <code class="literal">sd</code> в файле
	    <code class="filename">/etc/printcap</code>). Это отличное место для выполнения
	    фильтрами своих действий, особенно потому, что (иногда)
	    в каталоге спулинга места больше, чем в <code class="filename">/tmp</code>.</p><p>Вот, наконец, и сам фильтр:</p><pre class="programlisting">#!/bin/sh
#
#  hpdf - Печать данных DVI на принтере HP/PCL
#  Установлен в /usr/local/libexec/hpdf

PATH=/usr/local/bin:$PATH; export PATH

#
#  Определяем функцию для удаления временных файлов. Они существуют
#  в текущем каталоге - в каталоге спулинга для принтера.
#
cleanup() {
   rm -f hpdf$$.dvi
}

#
#  Определяем функцию для обработки критических ошибок: напечатать заданное
#  сообщение и выйти с кодом 2. Код выхода 2 сообщает системе LPD, что не
#  надо повторно пытаться печатать задание.
#
fatal() {
    echo "$@" 1&gt;&amp;2
    cleanup
    exit 2
}

#
#  Если пользователь удаляет задание, система LPD будет посылать сигнал SIGINT,
#  поэтому перехватываем SIGINT (и пару других сигналов), чтобы убрать за собой.
#
trap cleanup 1 2 15

#
#  Гарантируем, что не конфликтуем с существующими файлами.
#
cleanup

#
#  Связываем входной файл DVI со стандартным входным потоком (файлом для печати).
#
ln -s /dev/fd/0 hpdf$$.dvi || fatal "Cannot symlink /dev/fd/0"

#
#  Заменяем LF = CR+LF
#
printf "\033&amp;k2G" || fatal "Cannot initialize printer"

#
#  Преобразуем и печатаем. Значение, возвращаемое программой dvilj2p, не надежно,
#  так что мы его игнорируем.
#
dvilj2p -M1 -q -e- dfhp$$.dvi

#
#  Убираем за собой и завершаем работу
#
cleanup
exit 0</pre></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-autoconv"></a>10.4.1.4.5. Автоматизированное преобразование: альтернатива фильтрам преобразования</h5></div></div></div><p>Все эти фильтры преобразования многое дают для среды печати,
	    но требуют от пользователя указывать (в командной строке
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a>), какой именно фильтр использовать. Если пользователи
	    не особенно разбираются в компьютерах, необходимость указывать
	    опцию фильтра будет их раздражать. Что еще хуже, однако,
	    при неправильном указании опции фильтрования может быть применен
	    фильтр, не соответствующий типу файла, и принтер испортит несколько
	    сотен страниц бумаги.</p><p>Вместо установки фильтров преобразования, можно попытаться
	    заставить текстовый фильтр (поскольку он применяется по умолчанию)
	    определять тип файла, который его попросили напечатать, и затем
	    автоматически вызывать соответствующий фильтр преобразования.
	    В этом могут помочь утилиты вроде <code class="command">file</code>. Конечно,
	    будет сложно различать <span class="emphasis"><em>некоторые</em></span> типы
	    файлов - и, конечно же, можно задавать фильтры преобразования
	    только для них.</p><a id="idp83882960" class="indexterm"></a><a id="idp83883472" class="indexterm"></a><p>В наборе портов FreeBSD есть текстовый фильтр, выполняющий
	    автоматическое преобразование; это <code class="command">apsfilter</code>.
	    Он может выявлять обычный текст, <span class="trademark">PostScript</span>(R) и файлы DVI,
	    выполнять соответствующие преобразования и печатать
	    результат.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-of"></a>10.4.1.5. Выходные фильтры</h4></div></div></div><p>Система спулинга <span class="application">LPD</span> поддерживает еще
	  один тип фильтров, который мы еще не рассматривали: выходные фильтры.
	  Выходной фильтр предназначен только для печати обычного текста,
	  как текстовый фильтр, но с множеством упрощений. Если вы используете
	  выходной фильтр, а текстовый фильтр не задан, то:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Система <span class="application">LPD</span> запускает выходной
	      фильтр один раз для всего задания, а не для каждого файла задания.</p></li><li class="listitem"><p>Система <span class="application">LPD</span> не пытается определить начало
	      или конец файлов в задании для выходного фильтра.</p></li><li class="listitem"><p>Система <span class="application">LPD</span> не передает выходному
	      фильтру имя пользователя или хоста, так что этот фильтр не предназначен
	      для учета использования принтера. Фактически, он получает всего два
	      аргумента:</p><div class="cmdsynopsis"><p><code class="command">имя-фильтра</code>  -w<em class="replaceable"><code>ширина</code></em>   -l<em class="replaceable"><code>длина</code></em> </p></div><p>Где <em class="replaceable"><code>ширина</code></em> берется из характеристики
	      <code class="literal">pw</code>, а <em class="replaceable"><code>длина</code></em> - из
	      характеристики <code class="literal">pl</code> для соответствующего
	      принтера.</p></li></ul></div><p>Не соблазняйтесь простотой выходного фильтра. Если вы хотите,
	  чтобы каждый файл в задании начинал печататься с новой страницы,
	  выходной фильтр <span class="emphasis"><em>не поможет</em></span>. Используйте текстовый
	  фильтр (также известный как входной); см. раздел
	  <a class="link" href="printing-intro-setup.html#printing-textfilter" title="10.3.1.5.6. Установка текстового фильтра">Установка текстового фильтра</a>.
	  Более того, выходной фильтр, фактически, - <span class="emphasis"><em>более
	  сложный</em></span>, поскольку он должен проверять посылаемый ему
	  поток байтов в поисках специальных символов-флагов и посылать себе
	  сигналы от имени системы <span class="application">LPD</span>.</p><p>Однако выходной фильтр <span class="emphasis"><em>необходим</em></span>, если
	  надо выдавать начальные страницы и требуется посылать управляющие
	  последовательности или другие строки инициализации, чтобы можно было
	  напечатать начальную страницу. (Но он <span class="emphasis"><em>не поможет</em></span>,
	  если необходимо учитывать начальные страницы для пользователя,
	  поскольку система <span class="application">LPD</span> не передает
	  выходному фильтру никакой информации о пользователе или хосте.)</p><p>На одном принтере система <span class="application">LPD</span>
	  позволяет совместно с выходным использовать текстовый или другие
	  фильтры. В таких случаях, система <span class="application">LPD</span> будет
	  запускать выходной фильтр только для печати начальной страницы (см.
	  раздел <a class="link" href="printing-advanced.html#printing-advanced-header-pages" title="10.4.2. Начальные страницы">Начальные
	  страницы</a>). Система <span class="application">LPD</span> затем
	  предполагает, что выходной фильтр <span class="emphasis"><em>остановится</em></span>,
	  посылая ему два байта: ASCII 031 и ASCII 001. Когда выходной фильтр
	  видит эти два байта (031, 001), он должен остановиться, посылая
	  себе сигнал <code class="literal">SIGSTOP</code>. Когда система
	  <span class="application">LPD</span> закончит выполнение остальных фильтров,
	  она перезапускает выходной фильтр, посылая ему сигнал
	  <code class="literal">SIGCONT</code>.</p><p>Если есть выходной фильтр, но <span class="emphasis"><em>нет</em></span> текстового,
	  и система <span class="application">LPD</span> обрабатывает задания с обычным
	  текстом, <span class="application">LPD</span> использует для выполнения
	  задания выходной фильтр. Как уже было сказано, выходной фильтр
	  будет печатать все файлы задания последовательно, без прогонов
	  страниц или других настроек бумаги, а это <span class="emphasis"><em>вряд ли</em></span>
	  вас устроит. Почти во всех случаях необходим текстовый фильтр.</p><p>Программа <code class="command">lpf</code>, которую мы представили ранее
	  как текстовый фильтр, может также работать как выходной фильтр. Если
	  срочно необходим простой выходной фильтр, но вы не хотите писать
	  код для выявления байтов и посылки сигнала, попробуйте использовать
	  <code class="command">lpf</code>. Можно также поместить <code class="command">lpf</code>
	  в скрипт командного интерпретатора для обработки любых
	  кодов инициализации, которые может потребовать принтер.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-lpf"></a>10.4.1.6. <code class="command">lpf</code>: текстовый фильтр</h4></div></div></div><p>Программа <code class="filename">/usr/libexec/lpr/lpf</code>,
	  поставляемая в составе двоичного дистрибутива FreeBSD,
	  представляет собой текстовый (входной) фильтр, который может
	  печатать с отступом (если задание послано командой
	  <code class="command">lpr -i</code>), пропускать все символы на печать
	  (если задание послано командой <code class="command">lpr -l</code>),
	  настраивать позицию печати при получении в задании символов
	  забоя и табуляции, а также учитывать количество напечатанных страниц.
	  Она может также использоваться как выходной фильтр.</p><p>Программа <code class="command">lpf</code> подходит для многих сред печати.
	  И хотя она не позволяет посылать на принтер инициализационные
	  последовательности, легко написать скрипт командного интерпретатора,
	  который будет выполнять необходимую инициализацию, а затем вызывать
	  <code class="command">lpf</code>.</p><a id="idp83943888" class="indexterm"></a><a id="idp83944400" class="indexterm"></a><p>Чтобы программа <code class="command">lpf</code> корректно выполняла учет
	  страниц, ей необходимо указать корректные значения характеристик
	  <code class="literal">pw</code> и <code class="literal">pl</code> в файле
	  <code class="filename">/etc/printcap</code>. Она использует эти значения для
	  определения того, сколько текста может поместиться на странице и сколько
	  страниц было в задании пользователя. Подробнее об учете использования
	  принтера см. в разделе <a class="link" href="printing-advanced.html#printing-advanced-acct" title="10.4.5. Учет использования принтера">Учет
	  использования принтера</a>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages"></a>10.4.2. Начальные страницы</h3></div></div></div><p>При наличии <span class="emphasis"><em>множества</em></span> пользователей, использующих
	различные принтеры, вероятно, можно считать <span class="emphasis"><em>начальные
	страницы</em></span> неизбежным злом.</p><a id="idp83950288" class="indexterm"></a><a id="idp83951440" class="indexterm"></a><p>Начальные страницы, которые также называют <span class="emphasis"><em>баннерными</em></span>
	или <span class="emphasis"><em>разделительными страницами</em></span>, идентифицируют,
	кому принадлежат задания после их печати. Обычно информация на них
	выдается большими, жирными буквами, возможно, с декоративными рамочками,
	чтобы в пачке распечаток они отличались от реальных документов,
	образующих задания пользователей. Они позволяют пользователям быстро
	находить свои задания. Очевидный недостаток выдачи начальных страниц
	состоит в том, что для каждого задания надо печатать на одну страницу
	больше, причем, страница эта хоть сколько-нибудь нужна несколько минут, а
	затем она оказывается в мусорной корзине или сдается в макулатуру.
	(Учтите, что начальная страница выдается в начале задания, а не перед каждым
	файлом, так что бумаги может теряться не так уж и много.)</p><p>Система <span class="application">LPD</span> может выдавать заголовочные
	страницы для ваших распечаток автоматически, <span class="emphasis"><em>если</em></span>
	ваш принтер может непосредственно печатать обычный текст. Если используется
	<span class="trademark">PostScript</span>(R)-принтер, потребуется внешняя программа для генерации начальной
	страницы; см. <a class="link" href="printing-advanced.html#printing-advanced-header-pages-ps" title="10.4.2.4. Начальные страницы на PostScript(R)-принтерах">Начальные
	страницы на <span class="trademark">PostScript</span>(R)-принтерах</a>.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages-enabling"></a>10.4.2.1. Включение выдачи начальных страниц</h4></div></div></div><p>В разделе <a class="link" href="printing-intro-setup.html#printing-simple" title="10.3.1. Простая настройка принтера">Простая настройка
	  принтера</a> мы отключили выдачу начальных страниц, задав характеристику
	  <code class="literal">sh</code> (что означает <span class="quote"><<<span class="quote">suppress header</span>>></span>) в
	  файле <code class="filename">/etc/printcap</code>. Для включения
	  выдачи начальных страниц на принтер, просто удалите характеристику
	  <code class="literal">sh</code>.</p><p>Кажется слишком просто, правда?</p><p>Вы правы. <span class="emphasis"><em>Может</em></span> потребоваться задать выходной
	  фильтр для посылки строк инициализации на принтер. Вот пример выходного
	  фильтра для Hewlett Packard PCL-совместимых принтеров:</p><pre class="programlisting">#!/bin/sh
#
#  hpof - Выходной фильтр для Hewlett Packard PCL-совместимых принтеров
#  Установлен в /usr/local/libexec/hpof

printf "\033&amp;k2G" || exit 2
exec /usr/libexec/lpr/lpf</pre><p>Задайте полное имя выходного фильтра в качестве значения
	  характеристики <code class="literal">of</code>. Подробнее об этом см.
	  в разделе <a class="link" href="printing-advanced.html#printing-advanced-of" title="10.4.1.5. Выходные фильтры">Выходные фильтры</a>.</p><p>Вот пример файла <code class="filename">/etc/printcap</code> для принтера
	  <code class="literal">teak</code>, который мы представили ранее; мы включили
	  выдачу начальных страниц и добавили показанный выше выходной фильтр:</p><pre class="programlisting">#
#  /etc/printcap для хоста orchid
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/hpif:\
        :vf=/usr/local/libexec/hpvf:\
        :of=/usr/local/libexec/hpof:</pre><p>Теперь, когда пользователи выдают задания на принтер
	  <code class="literal">teak</code>, они получают начальную страницу с каждым
	  заданием. Если пользователи хотят тратить время на поиск своих
	  распечаток, они могут подавить вывод начальных страниц,
	  посылая задание с опцией <code class="command">lpr -h</code>;
	  другие опции <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a> см. в разделе
	  <a class="link" href="printing-using.html#printing-lpr-options-misc" title="10.5.4.3. Опции начальных страниц">Опции начальных
	  страниц</a>.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Система <span class="application">LPD</span> выдает символ прогона
	    страницы (form feed) после начальной страницы. Если ваш принтер
	    использует другой символ или последовательность символов
	    для выброса напечатанной страницы, укажите их в
	    качестве значения характеристики <code class="literal">ff</code>
	    в файле <code class="filename">/etc/printcap</code>.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages-controlling"></a>10.4.2.2. Управление начальными страницами</h4></div></div></div><p>Включая выдачу начальных страниц, система <span class="application">LPD</span>
	  будет выдавать длинный <span class="emphasis"><em>длинный заголовок</em></span>, целую страницу
	  с большими буквами, идентифицирующими пользователя, хост и задание. Ниже
	  представлен пример (kelly напечатала задание по имени outline с хоста <code class="systemitem">rose</code>):</p><pre class="programlisting">      k                   ll       ll
      k                    l        l
      k                    l        l
      k   k     eeee       l        l     y    y
      k  k     e    e      l        l     y    y
      k k      eeeeee      l        l     y    y
      kk k     e           l        l     y    y
      k   k    e    e      l        l     y   yy
      k    k    eeee      lll      lll     yyy y
                                               y
                                          y    y
                                           yyyy


                                   ll
                          t         l        i
                          t         l
       oooo    u    u   ttttt       l       ii     n nnn     eeee
      o    o   u    u     t         l        i     nn   n   e    e
      o    o   u    u     t         l        i     n    n   eeeeee
      o    o   u    u     t         l        i     n    n   e
      o    o   u   uu     t  t      l        i     n    n   e    e
       oooo     uuu u      tt      lll      iii    n    n    eeee









      r rrr     oooo     ssss     eeee
      rr   r   o    o   s    s   e    e
      r        o    o    ss      eeeeee
      r        o    o      ss    e
      r        o    o   s    s   e    e
      r         oooo     ssss     eeee







                                              Job:  outline
                                              Date: Sun Sep 17 11:04:58 1995</pre><p>Система <span class="application">LPD</span> добавляет прогон страницы
	  после этого текста, чтобы задание начиналось с новой страницы
	  (если только вы не указали характеристику <code class="literal">sf</code> (suppress
	  form feeds) в записи соответствующего принтера в файле
	  <code class="filename">/etc/printcap</code>).</p><p>Если вы предпочитаете, чтобы система <span class="application">LPD</span>
	  создавала <span class="emphasis"><em>короткий заголовок</em></span>, укажите
	  характеристику <code class="literal">sb</code> (short banner) в файле
	  <code class="filename">/etc/printcap</code>. Начальная страница будет
	  иметь следующий вид:</p><pre class="programlisting">rose:kelly  Job: outline  Date: Sun Sep 17 11:07:51 1995</pre><p>Также по умолчанию система <span class="application">LPD</span> печатает
	  начальную страницу перед заданием. Для изменения порядка на обратный,
	  укажите характеристику <code class="literal">hl</code> (header last) в файле
	  <code class="filename">/etc/printcap</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages-accounting"></a>10.4.2.3. Учет начальных страниц</h4></div></div></div><p>Использование встроенных начальных страниц системы
	  <span class="application">LPD</span> порождает определенную парадигму
	  учета использования принтера: начальные страницы пользователи
	  <span class="emphasis"><em>не должны оплачивать</em></span>.</p><p>Почему?</p><p>Поскольку выходной фильтр - единственная внешняя программа,
	  управляющая выдачей начальных страниц, которая может выполнять учет,
	  а ей не передают информацию о <span class="emphasis"><em>пользователе или хосте</em></span>
	  и учётный файл, так что, она не имеет никакого представления о том,
	  на чей счет отнести использование принтера. Также недостаточно
	  просто <span class="quote"><<<span class="quote">добавлять одну страницу</span>>></span> в текстовом фильтре
	  или в любом из фильтров преобразований (которые имеют информацию
	  о пользователе и хосте), поскольку пользователи могут подавлять
	  выдачу начальных страниц с помощью опции <code class="command">lpr -h</code>.
	  И их заставят оплачивать начальные страницы, которые они не печатали.
	  Понятно, что опцию <code class="command">lpr -h</code> будут использовать в большинстве
	  случаев те, кто озабочен проблемами окружающей среды, но вы никак не
	  можете стимулировать ее использование.</p><p>Также <span class="emphasis"><em>недостаточно</em></span>, чтобы каждый из фильтров
	  генерировал собственные начальные страницы (и, тем самым,
	  мог их учитывать). Если пользователи захотят отказаться от выдачи
	  начальных страниц и укажут опцию <code class="command">lpr -h</code>, они все
	  равно их получат, и будут вынуждены оплатить, поскольку система
	  <span class="application">LPD</span> не передает информации о наличии опции
	  <code class="option">-h</code> ни одному из этих фильтров.</p><p>Итак, что же вы можете сделать?</p><p>Вы можете:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Принять парадигму системы <span class="application">LPD</span> и
	      сделать начальные страницы бесплатными.</p></li><li class="listitem"><p>Установить альтернативную систему вместо <span class="application">LPD</span>,
	      такую как <span class="application">LPRng</span>. В разделе
	      <a class="link" href="printing-lpd-alternatives.html" title="10.6. Альтернативы стандартному спулеру">Альтернативы стандартному
		спулеру</a> представлена дополнительная информация о других
		системах спулинга, которые можно использовать вместо
		<span class="application">LPD</span>.
	</p></li><li class="listitem"><p>Написать <span class="emphasis"><em>умный</em></span> выходной фильтр. Обычно
	      выходной фильтр не предназначен для выполнения чего-то кроме
	      инициализации принтера и простых преобразований символов. Он
	      подходит для начальных страниц и заданий с обычным текстом
	      (когда нет текстового (входного) фильтра). Но, если есть текстовый
	      фильтр для заданий с обычным текстом, то система
	      <span class="application">LPD</span> будет запускать выходной фильтр только
	      для начальных страниц. И выходной фильтр может анализировать
	      текст начальной страницы, которую генерирует система
	      <span class="application">LPD</span>, чтобы определить, на счет какого
	      пользователя и хоста отнести начальную страницу. Единственная
	      проблема этого метода в том, что выходной фильтр все равно не
	      знает, какой учетный файл использовать (ему не передают
	      имя файла, заданное в качестве значения характеристики
	      <code class="literal">af</code>), но при наличии хорошо известного учетного
	      файла, его имя можно явно указать в выходном фильтре. Для
	      упрощения этапа анализа задайте характеристику
	      <code class="literal">sh</code> (short header) в файле
	      <code class="filename">/etc/printcap</code>. Повторимся, что это может
	      оказаться слишком сложным, и пользователи, несомненно, больше оценят
	      великодушного системного администратора, который сделает начальные
	      страницы бесплатными.</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-header-pages-ps"></a>10.4.2.4. Начальные страницы на <span class="trademark">PostScript</span>(R)-принтерах</h4></div></div></div><p>Как было описано выше, система <span class="application">LPD</span> может
	  генерировать начальную страницу в виде обычного текста, что подходит для
	  многих принтеров. Конечно, <span class="trademark">PostScript</span>(R)-принтеры не могут непосредственно
	  печатать обычный текст, так что, для них возможность выдачи начальных
	  страниц системы <span class="application">LPD</span> бесполезна - или почти
	  бесполезна.</p><p>Один очевидный способ получить начальные страницы - заставить
	  каждый фильтр преобразования и текстовый фильтр генерировать начальную
	  страницу. Эти фильтры должны использовать аргументы имя пользователя и хост
	  для генерации соответствующей начальной страницы. Недостаток этого
	  метода состоит в том, что пользователи будут всегда получать начальные
	  страницы, даже если будут посылать задания с помощью команды
	  <code class="command">lpr -h</code>.</p><p>Давайте рассмотрим этот метод детально. Следующий сценарий
	  принимает три аргумента (регистрационное имя пользователя,
	  имя хоста и имя задания) и создает простую
	  начальную страницу на языке <span class="trademark">PostScript</span>(R):</p><pre class="programlisting">#!/bin/sh
#
#  make-ps-header - выдать начальную страницу на языке PostScript в stdout
#  Установлен в /usr/local/libexec/make-ps-header
#

#
#  Это единицы измерения PostScript (72 на дюйм). Измените значения для A4 или
#  другого используемого формата бумаги:
#
page_width=612
page_height=792
border=72

#
#  Проверяем аргументы
#
if [ $# -ne 3 ]; then
    echo "Usage: `basename $0` &lt;user&gt; &lt;host&gt; &lt;job&gt;" 1&gt;&amp;2
    exit 1
fi

#
#  Сохраняем значения в переменных, в основном, для упрощения понимания
#  последующего PostScript-кода.
#
user=$1
host=$2
job=$3
date=`date`

#
#  Посылаем PostScript-код в stdout.
#
exec cat &lt;&lt;EOF
%!PS

%
%  Гарантируем, что не будем влиять на следующее далее задание пользователя
%
save

%
%  Делаем тонкую некрасивую рамку по краям бумаги.
%
$border $border moveto
$page_width $border 2 mul sub 0 rlineto
0 $page_height $border 2 mul sub rlineto
currentscreen 3 -1 roll pop 100 3 1 roll setscreen
$border 2 mul $page_width sub 0 rlineto closepath
0.8 setgray 10 setlinewidth stroke 0 setgray

%
%  Выдаем регистрационное имя пользователя, красивыми, большими и рельефными буквами
%
/Helvetica-Bold findfont 64 scalefont setfont
$page_width ($user) stringwidth pop sub 2 div $page_height 200 sub moveto
($user) show

%
%  Теперь выдаем всякие детали
%
/Helvetica findfont 14 scalefont setfont
/y 200 def
[ (Job:) (Host:) (Date:) ] {
200 y moveto show /y y 18 sub def }
forall

/Helvetica-Bold findfont 14 scalefont setfont
/y 200 def
[ ($job) ($host) ($date) ] {
        270 y moveto show /y y 18 sub def
} forall

%
% Вот и все
%
restore
showpage
EOF</pre><p>Теперь, каждый из фильтров преобразования и текстовый фильтр
	  может вызвать этот сценарий, чтобы сначала сгенерировать
	  начальную страницу, а затем напечатать задание пользователя.
	  Вот фильтр преобразования DVI, представленный ранее в этом
	  документе, измененный для выдачи начальной страницы:</p><pre class="programlisting">#!/bin/sh
#
#  psdf - фильтр преобразования DVI в PostScript
#  Установлен в /usr/local/libexec/psdf
#
#  Вызывается системой lpd при выполнении пользователем команды lpr -d
#

orig_args="$@"

fail() {
    echo "$@" 1&gt;&amp;2
    exit 2
}

while getopts "x:y:n:h:" option; do
    case $option in
        x|y)  ;; # Ignore
        n)    login=$OPTARG ;;
        h)    host=$OPTARG ;;
        *)    echo "LPD started `basename $0` wrong." 1&gt;&amp;2
              exit 2
              ;;
    esac
done

[ "$login" ] || fail "No login name"
[ "$host" ] || fail "No host name"

( /usr/local/libexec/make-ps-header $login $host "DVI File"
  /usr/local/bin/dvips -f ) | eval /usr/local/libexec/lprps $orig_args</pre><p>Обратите внимание, как фильтр должен анализировать список
	  аргументов, чтобы определить имя пользователя и имя хоста.
	  Анализ аргументов в других фильтрах аргументов выполняется точно так же.
	  Текстовый фильтр принимает, однако, немного другой набор аргументов
	  (см. раздел <a class="link" href="printing-advanced.html#printing-advanced-filters" title="10.4.1.1. Как работают фильтры">Как работают
	  фильтры</a>).</p><p>Как уже упоминалось, представленная выше схема хотя и достаточно
	  проста, но не позволяет учесть опцию <span class="quote"><<<span class="quote">подавить вывод
	  начальной страницы</span>>></span> (опция <code class="option">-h</code>) команды
	  <code class="command">lpr</code>. Если пользователи хотят сберечь деревья
	  (или несколько копеек, если вы берете деньги и за начальные страницы),
	  они не смогут этого сделать, поскольку каждый фильтр будет
	  выдавать начальную страницу для каждого задания.</p><p>Чтобы позволить пользователям отключать выдачу начальной страницы для
	  отдельного задания, надо будет использовать прием, представленный в
	  разделе <a class="link" href="printing-advanced.html#printing-advanced-header-pages-accounting" title="10.4.2.3. Учет начальных страниц">Учет
	  начальных страниц</a>: написать выходной фильтр, который анализирует
	  сгенерированную системой LPD начальную страницу и выдает ее
	  <span class="trademark">PostScript</span>(R)-версию. Если пользователь посылает задание командой
	  <code class="command">lpr -h</code>, система <span class="application">LPD</span>
	  не будет генерировать начальную страницу, как и ваш выходной
	  фильтр. В противном случае, ваш выходной фильтр будет читать текст,
	  полученный от системы <span class="application">LPD</span>, и
	  посылать на принтер соответствующий <span class="trademark">PostScript</span>(R)-код для начальной
	  страницы.</p><p>Если вы используете <span class="trademark">PostScript</span>(R)-принтер с последовательным
	  интерфейсом, можно использовать систему <code class="command">lprps</code>,
	  которая включает выходной фильтр, <code class="command">psof</code>,
	  делающий то, что описано выше. Помните, что программа
	  <code class="command">psof</code> не учитывает напечатанные пользователями
	  начальные страницы.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-network-printers"></a>10.4.3. Печать по сети</h3></div></div></div><a id="idp84070992" class="indexterm"></a><a id="idp84072144" class="indexterm"></a><p>FreeBSD поддерживает печать по сети: посылку заданий на
	удаленные принтеры. Печатью по сети обычно называют две разные
	ситуации:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Работа с принтером, подключенным к удаленному хосту. Вы
	    устанавливаете принтер с обычным последовательным или параллельным
	    интерфейсом на одном хосте. Затем, вы настраиваете систему
	    <span class="application">LPD</span> для обеспечения доступа к принтеру
	    с других хостов в сети. В разделе
	    <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Принтеры, установленные на удаленных хостах">Принтеры, установленные
	    на удаленных хостах</a> описано, как это сделать.</p></li><li class="listitem"><p>Работа с принтером, подключенным непосредственно к сети.
	    Принтер имеет сетевой интерфейс, кроме (или вместо) более
	    традиционного последовательного или параллельного. Такой принтер
	    может работать следующим образом:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Он может понимать протокол <span class="application">LPD</span> и
		даже поддерживать очереди заданий с удаленных хостов. В этом
		случае, он работает просто как обычный хост с системой
		<span class="application">LPD</span>. Для настройки такого принтера
		следуйте той же процедуре, которая описана в разделе
		<a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Принтеры, установленные на удаленных хостах">Принтеры,
		установленные на удаленных хостах</a>.</p></li><li class="listitem"><p>Он может поддерживать получение потока данных по сети. В
		этом случае, вы <span class="quote"><<<span class="quote">подключаете</span>>></span> принтер к одному
		из хостов в сети, делая этот хост ответственным за поддержку
		очередей заданий и их посылку на принтер. В разделе
		<a class="link" href="printing-advanced.html#printing-advanced-network-net-if" title="10.4.3.2. Принтеры с сетевыми интерфейсами">Принтеры с
		сетевыми интерфейсами</a> представлен
		ряд советов по установке таких принтеров.</p></li></ul></div></li></ul></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-network-rm"></a>10.4.3.1. Принтеры, установленные на удаленных хостах</h4></div></div></div><p>Система спулинга <span class="application">LPD</span> имеет встроенную
	  поддержку посылки заданий на другие хосты, на которых тоже работает
	  система <span class="application">LPD</span> (или совместимая с
	  <span class="application">LPD</span>). Это позволяет установить принтер
	  на одном хосте и сделать его доступным с других хостов. Она также
	  работает с принтерами, имеющими сетевые интерфейсы и понимающими
	  протокол <span class="application">LPD</span>.</p><p>Для обеспечения такого рода удаленной печати, сначала установите
	  принтер на одном хосте, <span class="emphasis"><em>хосте принтера</em></span>, с помощью
	  процедуры, описанной в разделе <a class="link" href="printing-intro-setup.html#printing-simple" title="10.3.1. Простая настройка принтера">Простая
	  настройка принтера</a>. Выполните любые необходимые дополнительные
	  настройки, как описано в разделе <a class="link" href="printing-advanced.html" title="10.4. Расширенная настройка принтера">Расширенная
	  настройка принтера</a>. Не забудьте протестировать принтер и убедиться,
	  обеспечивает ли он заданные возможности системы <span class="application">LPD</span>.
	  Также проверьте, что <span class="emphasis"><em>локальный хост</em></span> имеет право
	  использовать службу <span class="application">LPD</span> на
	  <span class="emphasis"><em>удаленном хосте</em></span> (см. раздел
	  <a class="link" href="printing-advanced.html#printing-advanced-restricting-remote" title="10.4.4.4. Ограничение печати заданий с удаленных хостов">Ограничение приема
	  заданий с удаленных хостов</a>).</p><a id="idp84127568" class="indexterm"></a><a id="idp84128848" class="indexterm"></a><p>Если вы используете принтер с сетевым интерфейсом,
	  совместимый с системой <span class="application">LPD</span>, упомянутым
	  в обсуждении выше <span class="emphasis"><em>хостом принтера</em></span> будет сам
	  принтер, а в качестве <span class="emphasis"><em>имени принтера</em></span> будет
	  выступать имя, которое вы сконфигурировали для принтера. См.
	  документацию, поставляемую с принтером и/или сетевым интерфейсом
	  принтера.</p><div xmlns="" class="tip"><h3 class="admontitle">Подсказка: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если вы используете Hewlett Packard Laserjet, то при задании
	    принтеру имени <code class="literal">text</code> будет автоматически
	    выполняться преобразование символа LF в последовательность
	    CRLF, так что, сценарий <code class="filename">hpif</code> не понадобится.</p></div><p>Затем, на других хостах, для которых вы хотите обеспечить доступ
	  к принтеру, создайте запись в их файлах <code class="filename">/etc/printcap</code>
	  со следующими компонентами:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Дайте записи любое подходящее имя. Для простоты, однако,
	      имеет смысл задавать такое же имя и псевдонимы, как и на хосте
	      принтера.</p></li><li class="listitem"><p>Характеристику <code class="literal">lp</code> оставьте пустой, указав
	      это явно (<code class="literal">:lp=:</code>).</p></li><li class="listitem"><p>Создайте каталог спулинга и укажите его местонахождение в
	      характеристике <code class="literal">sd</code>. Система
	      <span class="application">LPD</span> будет сохранять задания в нем,
	      прежде чем они будут посланы на хост принтера.</p></li><li class="listitem"><p>Укажите имя хоста принтера в качестве значения характеристики
	      <code class="literal">rm</code>.</p></li><li class="listitem"><p>Укажите имя принтера на <span class="emphasis"><em>хосте принтера</em></span>
	      в качестве значения характеристики <code class="literal">rp</code>.</p></li></ol></div><p>Вот и все. Не нужно перечислять фильтры преобразования, размеры
	  страницы и вообще ничего больше в файле
	  <code class="filename">/etc/printcap</code>.</p><p>Рассмотрим пример. На хосте <code class="systemitem">rose</code> есть два принтера,
	  <code class="literal">bamboo</code> и <code class="literal">rattan</code>.
	  Мы позволим пользователям хоста <code class="systemitem">orchid</code> печатать на эти
	  принтеры. Вот файл <code class="filename">/etc/printcap</code> для хоста
	  <code class="systemitem">orchid</code> (из раздела
	  <a class="link" href="printing-advanced.html#printing-advanced-header-pages-enabling" title="10.4.2.1. Включение выдачи начальных страниц">Включение
	  выдачи начальных страниц</a>). В нем уже есть запись для принтера
	  <code class="literal">teak</code>; мы добавили две записи для принтеров на
	  хосте <code class="systemitem">rose</code>:</p><pre class="programlisting">#
#  /etc/printcap для хоста orchid - добавлены (удаленные) принтеры на rose
#

#
#  teak - локальный принтер; он подключен непосредственно к orchid:
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/ifhp:\
        :vf=/usr/local/libexec/vfhp:\
        :of=/usr/local/libexec/ofhp:

#
#  rattan подключен к rose; посылать задания для rattan на хост rose:
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :lp=:rm=rose:rp=rattan:sd=/var/spool/lpd/rattan:

#
#  bamboo тоже подключен к rose:
#
bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :lp=:rm=rose:rp=bamboo:sd=/var/spool/lpd/bamboo:</pre><p>Затем достаточно только создать каталоги спулинга на
	  <code class="systemitem">orchid</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir -p /var/spool/lpd/rattan /var/spool/lpd/bamboo</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chmod 770 /var/spool/lpd/rattan /var/spool/lpd/bamboo</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chown daemon:daemon /var/spool/lpd/rattan /var/spool/lpd/bamboo</code></strong></pre><p>Теперь пользователи хоста <code class="systemitem">orchid</code> могут печатать на
	  принтеры <code class="literal">rattan</code> и <code class="literal">bamboo</code>. Если,
	  например, пользователь на <code class="systemitem">orchid</code> выполнит команду

	  </p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lpr -P bamboo -d sushi-review.dvi</code></strong></pre><p>

	  система <span class="application">LPD</span> на <code class="systemitem">orchid</code>
	  будет копировать задание в каталог спулинга
	  <code class="filename">/var/spool/lpd/bamboo</code> и учтет, что печатается
	  задание DVI. Как только на хосте <code class="systemitem">rose</code> появится место
	  в каталоге спулинга принтера <code class="literal">bamboo</code>, две системы
	  <span class="application">LPD</span> передадут файл на хост <code class="systemitem">rose</code>.
	  Файл будет ждать в очереди на <code class="systemitem">rose</code> пока, наконец, не будет
	  напечатан. Он будет преобразован из формата DVI в <span class="trademark">PostScript</span>(R) (поскольку
	  <code class="literal">bamboo</code> является <span class="trademark">PostScript</span>(R)-принтером) на хосте
	  <code class="systemitem">rose</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-network-net-if"></a>10.4.3.2. Принтеры с сетевыми интерфейсами</h4></div></div></div><p>Часто при покупке сетевой карты для принтера можно приобрести
	  две версии: эмулирующую спулер (более дорогая версия) или просто
	  позволяющую принимать на принтер данные так, как если бы
	  использовался последовательный или параллельный порт (более
	  дешевая версия). В этом разделе описано, как использовать
	  более дешёвую версию. Использование более дорогой версии
	  описано в предыдущем разделе
	  <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Принтеры, установленные на удаленных хостах">Принтеры, установленные
	  на удаленных хостах</a>.</p><p>Формат файла <code class="filename">/etc/printcap</code> позволяет
	  указывать, какой последовательный или параллельный интерфейс
	  использовать, и (при использовании последовательного интерфейса),
	  какую установить скорость, использовать ли управление потоком,
	  размер отступов для табуляций, преобразование символов новой строки
	  и другие параметры. Но нет способа указать подключение к принтеру,
	  прослушивающему TCP/IP или другой сетевой порт.</p><p>Для посылки данных на подключенный к сети принтер, надо разработать
	  программу взаимодействия, которую могут вызывать текстовый фильтр и
	  фильтры преобразований. Вот один из примеров: скрипт
	  <code class="command">netprint</code> принимает все данные со стандартного
	  входного потока и посылает их на принтер, подключенный к сети.
	  Мы указываем имя хоста принтера в качестве первого аргумента, а
	  номер порта, к которому надо подключаться - в качестве второго
	  аргумента команды <code class="command">netprint</code>. Учтите, что
	  поддерживается только одностороннее взаимодействие (с ОС FreeBSD
	  на принтер); многие сетевые принтеры поддерживают двустороннее
	  взаимодействие, и вы можете захотеть его использовать (для
	  получения состояния принтера, учета и т.п.).</p><pre class="programlisting">#!/usr/bin/perl
#
#  netprint - Текстовый фильтр для принтера, подключенного к сети
#  Установлен в /usr/local/libexec/netprint
#
$#ARGV eq 1 || die "Usage: $0 &lt;printer-hostname&gt; &lt;port-number&gt;";

$printer_host = $ARGV[0];
$printer_port = $ARGV[1];

require 'sys/socket.ph';

($ignore, $ignore, $protocol) = getprotobyname('tcp');
($ignore, $ignore, $ignore, $ignore, $address)
    = gethostbyname($printer_host);

$sockaddr = pack('S n a4 x8', &amp;AF_INET, $printer_port, $address);

socket(PRINTER, &amp;PF_INET, &amp;SOCK_STREAM, $protocol)
    || die "Can't create TCP/IP stream socket: $!";
connect(PRINTER, $sockaddr) || die "Can't contact $printer_host: $!";
while (&lt;STDIN&gt;) { print PRINTER; }
exit 0;</pre><p>Затем можно использовать этот сценарий в различных фильтрах. Пусть
	  у нас есть строчный принтер Diablo 750-N, подключенный к сети. Принтер
	  принимает данные на печать через порт 5100. Имя хоста для принтера -
	  scrivener. Вот текстовый фильтр для этого принтера:</p><pre class="programlisting">#!/bin/sh
#
#  diablo-if-net - Текстовый фильтр для принтера Diablo `scrivener',
#  прослушивающего порт 5100. Установлен в /usr/local/libexec/diablo-if-net
#
exec /usr/libexec/lpr/lpf "$@" | /usr/local/libexec/netprint scrivener 5100</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting"></a>10.4.4. Ограничение использования принтера</h3></div></div></div><a id="idp84171472" class="indexterm"></a><p>В этом разделе представлена информация об ограничении доступа к
	принтеру. Система <span class="application">LPD</span> позволяет управлять
	тем, кто может обращаться к принтеру, как локально, так и удаленно,
	смогут ли они печатать несколько копий, насколько большими могут
	быть их задания и насколько могут разрастаться очереди печати.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting-copies"></a>10.4.4.1. Ограничение количества копий</h4></div></div></div><p>Система <span class="application">LPD</span> позволяет пользователям
	  легко печатать несколько копий файла. Пользователи могут печатать
	  задания с помощью команды <code class="command">lpr -#5</code>
	  (например) и получать пять копий каждого файла в задании. Хорошо это
	  или нет - решать вам.</p><p>Если вы считаете, что многочисленные копии только изнашивают ваши
	  принтеры, можете отключить опцию <code class="option">-#</code> команды
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a>, добавив характеристику <code class="literal">sc</code> в файл
	  <code class="filename">/etc/printcap</code>. Когда пользователи пошлют
	  задания с опцией <code class="option">-#</code>, они увидят:</p><pre class="screen">lpr: multiple copies are not allowed</pre><p>Учтите, что если вы настроили удаленный доступ к принтеру (см.
	  раздел <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Принтеры, установленные на удаленных хостах">Принтеры,
	  установленные на удаленных хостах</a>), необходимо задать
	  характеристику <code class="literal">sc</code> также и в файлах
	  <code class="filename">/etc/printcap</code> удаленных хостов, иначе
	  пользователи все равно смогут посылать задания с несколькими
	  копиями с других хостов.</p><p>Рассмотрим пример. Вот файл <code class="filename">/etc/printcap</code>
	  для хоста <code class="systemitem">rose</code>. Принтер <code class="literal">rattan</code>
	  вполне надежен, поэтому мы разрешим печатать на него несколько
	  копий, но лазерный принтер <code class="literal">bamboo</code> несколько
	  более изношен, поэтому мы отключим для него печать нескольких
	  копий, добавив характеристику <code class="literal">sc</code>:</p><pre class="programlisting">#
#  /etc/printcap для хоста rose - запрещает печать нескольких копий на bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Теперь нам также нужно добавить характеристику <code class="literal">sc</code>
	  в файле <code class="filename">/etc/printcap</code> на хосте <code class="systemitem">orchid</code>
	  (и раз уж мы его меняем, давайте отключим печать нескольких копий для
	  принтера <code class="literal">teak</code>):</p><pre class="programlisting">#
#  /etc/printcap для хоста orchid - отключена печать нескольких копий на
#  локальном принтере teak и на удаленном принтере bamboo
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:sc:\
        :if=/usr/local/libexec/ifhp:\
        :vf=/usr/local/libexec/vfhp:\
        :of=/usr/local/libexec/ofhp:

rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :lp=:rm=rose:rp=rattan:sd=/var/spool/lpd/rattan:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :lp=:rm=rose:rp=bamboo:sd=/var/spool/lpd/bamboo:sc:</pre><p>С помощью характеристики <code class="literal">sc</code> мы предотвращаем
	  использование команды <code class="command">lpr -#</code>, но это не мешает
	  пользователям просто выполнить команду <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lpr&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lpr</span>(1)</span></a> несколько раз
	  или просто послать один и тот же файл несколько раз в одном задании
	  следующим образом:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lpr forsale.sign forsale.sign forsale.sign forsale.sign forsale.sign</code></strong></pre><p>Есть много способов предотвратить такое некорректное использование
	  (включая его игнорирование), которые вы можете разработать самостоятельно.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting-access"></a>10.4.4.2. Ограничение доступа к принтерам</h4></div></div></div><p>Вы можете управлять тем, кто и на какие принтеры может печатать,
	  с помощью механизма групп <span class="trademark">UNIX</span>(R) и характеристики
	  <code class="literal">rg</code> в файле <code class="filename">/etc/printcap</code>.
	  Просто поместите пользователей, которым необходимо предоставить
	  доступ к принтеру, в определенную группу, a затем укажите эту
	  группу в качестве значения характеристики <code class="literal">rg</code>.</p><p>Пользователи, не входящие в эту группу (включая <code class="systemitem">root</code>)
	  будут получать уведомление

	  <span class="errorname">lpr: Not a member of the restricted group</span>

	  при попытке печатать на контролируемый принтер.</p><p>Как и в случае с характеристикой <code class="literal">sc</code> (подавить
	  выдачу нескольких копий), при необходимости, надо указывать
	  характеристику <code class="literal">rg</code> и на удаленных хостах, имеющих
	  доступ к вашим принтерам (см. раздел
	  <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Принтеры, установленные на удаленных хостах">Принтеры, установленные
	  на удаленных хостах</a>).</p><p>Например, давайте разрешим всем обращаться к принтеру
	  <code class="literal">rattan</code>, но только пользователи группы
	  <code class="literal">artists</code> смогут использовать принтер
	  <code class="literal">bamboo</code>. Вот знакомый уже файл
	  <code class="filename">/etc/printcap</code> для хоста <code class="systemitem">rose</code>:</p><pre class="programlisting">#
#  /etc/printcap для хоста rose - ограничение группы для bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Давайте не будем менять другой рассматриваемый файл
	  <code class="filename">/etc/printcap</code> (для хоста
	  <code class="systemitem">orchid</code>). Конечно, в результате, любой пользователь
	  <code class="systemitem">orchid</code> может печатать на <code class="literal">bamboo</code>.
	  Возможно, на хосте <code class="systemitem">orchid</code> учетных записей и так
	  немного, и вы хотите, чтобы все они имели доступ к принтеру. Или нет.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Для принтера может быть только одна ограниченная группа.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting-sizes"></a>10.4.4.3. Контроль размеров посылаемых заданий</h4></div></div></div><a id="idp84250704" class="indexterm"></a><p>Если к принтеру обращается несколько пользователей, вам,
	  возможно, понадобиться установить ограничение на максимальный
	  размер файлов, которые пользователи могут посылать на печать.
	  В конечном итоге, размер файловой системы, в которой находятся
	  каталоги спулинга, ограничен, и надо гарантировать, что
	  в нем останется место для заданий других пользователей.</p><a id="idp84255824" class="indexterm"></a><p>Система <span class="application">LPD</span> ограничить максимально
	  допустимый размер файла в задании с помощью характеристики
	  <code class="literal">mx</code>. Размер задается в блоках, размер которых,
	  <code class="literal">BUFSIZ</code>, составляет 1024 байта.
	  Если задать этой характеристике значение ноль, размер файла
	  ограничиваться не будет; однако, если характеристика
	  <code class="literal">mx</code> вообще не задана, то будет использоваться
	  стандартное ограничение - 1000 блоков.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Ограничение применяется к <span class="emphasis"><em>файлам в задании</em></span>,
	    а <span class="emphasis"><em>не</em></span> к общему размеру задания.</p></div><p>Система <span class="application">LPD</span> не откажется печатать
	  файл больше максимально допустимого для принтера размера. Вместо
	  этого, она поставит в очередь часть файла до заданного
	  предела, и она будет напечатана. Остальное не будет напечатано.
	  Правильность такого поведения не бесспорна.</p><p>Давайте установим ограничения для принтеров из наших примеров,
	  <code class="literal">rattan</code> и <code class="literal">bamboo</code>. Поскольку
	  <span class="trademark">PostScript</span>(R)-файлы этих художников обычно бывают весьма
	  большими, мы ограничим их размер пятью мегабайтами. Мы не
	  будем ограничивать использование обычного текстового строчного
	  принтера:</p><pre class="programlisting">#
#  /etc/printcap для хоста rose
#

#
#  Без ограничения на размер задания:
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:mx#0:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

#
#  Размер файла - не более пяти мегабайт:
#
bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:mx#5000:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Опять таки, ограничения применяются только для локальных
	  пользователей. Если вы настроили удаленный доступ к принтерам,
	  для удаленных пользователей эти ограничения не действуют.
	  Надо задать характеристику <code class="literal">mx</code> и в файлах
	  <code class="filename">/etc/printcap</code> удаленных хостов. Более
	  детальную информацию по удаленной печати см. в разделе
	  <a class="link" href="printing-advanced.html#printing-advanced-network-rm" title="10.4.3.1. Принтеры, установленные на удаленных хостах">Принтеры,
	  установленные на удаленных хостах</a>.</p><p>Есть еще один специализированный способ ограничить
	  размер заданий печати с удаленных принтеров; см. раздел
	  <a class="link" href="printing-advanced.html#printing-advanced-restricting-remote" title="10.4.4.4. Ограничение печати заданий с удаленных хостов">Ограничение
	  печати заданий с удаленных хостов</a>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-restricting-remote"></a>10.4.4.4. Ограничение печати заданий с удаленных хостов</h4></div></div></div><p>Система спулинга <span class="application">LPD</span> обеспечивает
	  несколько способов ограничить посылку заданий с удаленных
	  хостов:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Ограничения хостов</span></dt><dd><p>Вы можете управлять тем, с каких удаленных хостов
		локальная система <span class="application">LPD</span> принимает
		запросы, с помощью файлов <code class="filename">/etc/hosts.equiv</code> и
		<code class="filename">/etc/hosts.lpd</code>. Система
		<span class="application">LPD</span> проверяет, поступает ли
		входящий запрос с хоста, указанного в одном из этих файлов.
		Если нет, система <span class="application">LPD</span> отвергает
		запрос.</p><p>Формат этих файлов простой: по одному имени хоста в строке.
		Учтите, что файл <code class="filename">/etc/hosts.equiv</code> также
		используется протоколом <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ruserok&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">ruserok</span>(3)</span></a> и влияет на
		программы <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rsh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rsh</span>(1)</span></a> и <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rcp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rcp</span>(1)</span></a>, так что, будьте
		внимательны.</p><p>Например, вот файл <code class="filename">/etc/hosts.lpd</code>
		для хоста <code class="systemitem">rose</code>:</p><pre class="programlisting">orchid
violet
madrigal.fishbaum.de</pre><p>Это означает, что хост <code class="systemitem">rose</code> будет
		принимать запросы с хостов <code class="systemitem">orchid</code>,
		<code class="systemitem">violet</code> и
		<code class="systemitem">madrigal.fishbaum.de</code>. Если любой
		другой хост попытается обратиться к системе
		<span class="application">LPD</span> хоста <code class="systemitem">rose</code>,
		его задание будет отвергнуто.</p></dd><dt><span class="term">Ограничения размера</span></dt><dd><p>Вы можете управлять тем, сколько свободного места должно
		оставаться в файловой системе, в которой находится каталог
		спулинга. Создайте файл с именем <code class="filename">minfree</code>
		в каталоге спулинга для локального принтера. Вставьте в этот
		файл число, задающее, сколько блоков диска (по 512 байтов)
		должно быть свободными, чтобы удаленное задание было принято.</p><p>Это позволяет гарантировать, что удаленные пользователи не
		заполнят вашу файловую систему. Можно также использовать этот
		механизм для предоставления определенного преимущества
		локальным пользователям: они смогут ставить задания в очередь
		еще долго после того, как свободного места на диске станет
		меньше, чем указано в файле <code class="filename">minfree</code>.</p><p>Например, давайте добавим файл <code class="filename">minfree</code>
		для принтера <code class="literal">bamboo</code>. Найдем в файле
		<code class="filename">/etc/printcap</code> каталог спулинга для этого
		принтера; вот запись для принтера <code class="literal">bamboo</code>:</p><pre class="programlisting">bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:mx#5000:\
        :lp=/dev/ttyd5:ms#-parenb cs8 clocal crtscts:rw:mx#5000:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</pre><p>Каталог спулинга задается характеристикой
		<code class="literal">sd</code>. Укажем, что в файловой системе
		должно быть три мегабайта (что составляет 6144 блоков диска)
		свободного места, чтобы система <span class="application">LPD</span>
		принимала удаленные задания:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>echo 6144 &gt; /var/spool/lpd/bamboo/minfree
	      </code></strong></pre></dd><dt><span class="term">Ограничения пользователей</span></dt><dd><p>Вы можете управлять тем, какие удаленные пользователи
		смогут печатать на локальные принтеры, задавая характеристику
		<code class="literal">rs</code> в файле <code class="filename">/etc/printcap</code>.
		Когда характеристика <code class="literal">rs</code> указана в записи
		для локально подключенного принтера, система
		<span class="application">LPD</span> будет принимать задания с
		удаленных хостов, <span class="emphasis"><em>если</em></span> пользователь,
		посылающий задание, также имеет учетную запись с тем же
		именем на локальном хосте. В противном случае,
		система <span class="application">LPD</span> отвергает задание.</p><p>Эта возможность особенно полезна в среде, где есть,
		например, несколько отделов, совместно использующих сеть,
		и некоторые пользователи могут переходить из отдела в отдел.
		Если дать им учетные записи в системах, они смогут использовать
		принтеры из систем в своих отделах. Если вы хотели бы
		позволить им использовать <span class="emphasis"><em>только</em></span>
		принтеры, но не остальные ресурсы вашего компьютера,
		можно дать им <span class="quote"><<<span class="quote">формальные</span>>></span> учетные записи,
		без начального каталога и с бесполезным начальным
		командным интерпретатором вроде <code class="filename">/usr/bin/false</code>.</p></dd></dl></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="printing-advanced-acct"></a>10.4.5. Учет использования принтера</h3></div></div></div><a id="idp84301648" class="indexterm"></a><p>Итак, вам надо брать деньги за распечатки. А почему нет?
	Бумага и чернила стоят денег. А есть еще и затраты на
	поддержку в работоспособном состоянии - принтеры имеют
	множество движущихся частей и склонны к поломкам. Вы проанализировали
	состояние принтеров, объемы использования и затраты на их эксплуатацию,
	и получили определенную стоимость страницы (или фута, метра или
	чего угодно). Теперь, как же начать реально учитывать распечатки?</p><p>Итак, плохая новость состоит в том, что система спулинга
	<span class="application">LPD</span> в этом не сильно поможет. Учет сильно
	зависит от типа используемого принтера, форматов распечаток и
	<span class="emphasis"><em>ваших</em></span> требований к оплате использования
	принтеров.</p><p>Для реализации учета надо изменить текстовый фильтр принтера
	(чтобы учитывать обычные текстовые задания) и фильтры преобразования
	(чтобы учитывать другие форматы файлов), для подсчета страниц или
	запроса количества напечатанных страниц у принтера. Не получится
	обойтись использованием простого выходного фильтра, поскольку
	он не может выполнять учет. См. раздел
	<a class="link" href="printing-advanced.html#printing-advanced-filter-intro" title="10.4.1. Фильтры">Фильтры</a>.</p><p>Обычно есть два способа выполнения учета:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="emphasis"><em>Периодический учет</em></span> - более распространенный
	    способ, возможно, потому, что он проще. Когда кто-то печатает
	    задание, фильтр регистрирует пользователя, хост и количество
	    страниц в учетном файле. Каждый месяц, семестр, год или раз в
	    любой желаемый период времени, вы собираете учетные файлы для
	    различных принтеров, суммируете напечатанные каждым пользователем
	    страницы и выставляете суммы за использование. Затем вы
	    очищаете все регистрационные файлы, начиная с чистого листа новый
	    отчетный период.</p></li><li class="listitem"><p><span class="emphasis"><em>Постоянный учет</em></span> используется реже,
	    вероятно, потому, что сложнее в реализации. Этот метод требует от
	    фильтров выставлять пользователям суммы за распечатки сразу после
	    использования принтеров. Как и проверка дисковых квот, этот учет
	    выполняется немедленно. Вы можете не давать пользователям печатать,
	    если баланс на их счету стал отрицательным, а также предоставить
	    им способ проверить и изменить свои <span class="quote"><<<span class="quote">квоты печати</span>>></span>.
	    Но этот метод требует поддержки базы данных для отслеживания
	    пользователей и квот.</p></li></ul></div><p>Система спулинга <span class="application">LPD</span> легко поддерживает
	оба метода: поскольку вы (в большинстве случаев) должны предоставить
	фильтры, вам придется предоставить и код для учета. Но есть и
	положительный момент: методы учета могут быть сколько угодно гибкими.
	Например, можно выбрать периодический или постоянный учет. Можно
	выбрать, какую именно информацию регистрировать: имена пользователей,
	имена хостов, типы заданий, количество напечатанных страниц,
	квадратные метры использованной бумаги, продолжительность печати
	заданий, и т.д. Это делается путем изменения фильтров так, чтобы
	они сохраняли соответствующую информацию.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp84309328"></a>10.4.5.1. Простая система учета использования принтера</h4></div></div></div><p>В составе FreeBSD поставляется две программы, которые можно сразу
	  использовать для организации простой системы периодического учета.
	  Речь идет о текстовом фильтре <code class="command">lpf</code>, описанном в
	  разделе <a class="link" href="printing-advanced.html#printing-advanced-lpf" title="10.4.1.6. lpf: текстовый фильтр">lpf: текстовый фильтр</a>,
	  и о программе <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>, обеспечивающей сбор и суммирование
	  записей из учетных файлов принтеров.</p><p>Как уже упоминалось в разделе, посвященном фильтрам
	  (<a class="link" href="printing-advanced.html#printing-advanced-filters" title="10.4.1.1. Как работают фильтры">Фильтры</a>), система
	  <span class="application">LPD</span> при запуске текстового фильтра и
	  фильтров преобразований передает им имя учетного файла в командной
	  строке. Фильтры могут использовать соответствующий аргумент, чтобы
	  определить, куда записывать учетную информацию. Имя этого файла
	  берется из значения характеристики <code class="literal">af</code> в файле
	  <code class="filename">/etc/printcap</code> и, если не заданно как абсолютное,
	  интерпретируется относительно каталога спулинга.</p><p>Система <span class="application">LPD</span> запускает <code class="command">lpf</code>
	  с аргументами ширины и длины страницы (которые берутся из
	  характеристик <code class="literal">pw</code> и <code class="literal">pl</code>).
	  Программа <code class="command">lpf</code> использует эти аргументы для
	  определения количества бумаги, которая будет использована. После
	  посылки файла на принтер она вносит запись в учетный файл. Эти
	  записи имеют следующий вид:</p><pre class="programlisting">2.00 rose:andy
3.00 rose:kelly
3.00 orchid:mary
5.00 orchid:mary
2.00 orchid:zhang</pre><p>Следует использовать отдельный учетный файл для каждого принтера,
	  поскольку программа <code class="command">lpf</code> не реализует механизм
	  блокирования файлов, и два экземпляра <code class="command">lpf</code> могут
	  повредить записи друг друга, если записывают одновременно в один
	  и тот же файл. Простой способ выделить отдельный учетный файл для
	  каждого принтера - использовать характеристику
	  <code class="literal">af=acct</code> в файле <code class="filename">/etc/printcap</code>.
	  Тогда каждый учетный файл окажется в каталоге спулинга соответствующего
	  принтера и будет назван <code class="filename">acct</code>.</p><p>Когда вы будете готовы выставить пользователям счет за
	  распечатки, запустите программу <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>. Просто перейдите в
	  каталог спулинга принтера, учетную информацию которого вы хотите
	  обработать, и введите команду <code class="literal">pac</code>. Вы
	  получите итоговые суммы в долларах, как показано ниже:</p><pre class="screen">  Login	       pages/feet   runs    price
orchid:kelly                5.00    1   $  0.10
orchid:mary                31.00    3   $  0.62
orchid:zhang                9.00    1   $  0.18
rose:andy                   2.00    1   $  0.04
rose:kelly                177.00  104   $  3.54
rose:mary                  87.00   32   $  1.74
rose:root                  26.00   12   $  0.52

total                     337.00  154   $  6.74</pre><p>Команда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a> принимает следующие аргументы:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-P<em class="replaceable"><code>принтер</code></em></code></span></dt><dd><p>По какому <em class="replaceable"><code>принтеру</code></em> подсчитывать
		итоговые суммы. Эта опция работает, только если в качестве
		значения характеристики <code class="literal">af</code> в файле
		<code class="filename">/etc/printcap</code> указано абсолютное имя.</p></dd><dt><span class="term"><code class="option">-c</code></span></dt><dd><p>Сортировать отчет по сумме, а не по имени пользователя в
		алфавитном порядке.</p></dd><dt><span class="term"><code class="option">-m</code></span></dt><dd><p>Игнорировать имя хоста в учетных файлах. При указании этой
		опции, пользователь <code class="systemitem">smith</code> на хосте
		<code class="systemitem">alpha</code> считается тем же, что и пользователь
		<code class="systemitem">smith</code> на хосте <code class="systemitem">gamma</code>.
		Обычно эти пользователи считаются разными.</p></dd><dt><span class="term"><code class="option">-p<em class="replaceable"><code>стоимость</code></em></code></span></dt><dd><p>Вычислять суммы из расчета <em class="replaceable"><code>стоимость</code></em>
		долларов за страницу или за фут, вместо использования
		значения характеристики <code class="literal">pc</code> в файле
		<code class="filename">/etc/printcap</code>, или двух центов (как принято по
		умолчанию). Можно задавать <em class="replaceable"><code>стоимость</code></em>
		как число с плавающей запятой.</p></dd><dt><span class="term"><code class="option">-r</code></span></dt><dd><p>Изменить порядок сортировки.</p></dd><dt><span class="term"><code class="option">-s</code></span></dt><dd><p>Создать итоговый учетный файл и очистить учетный файл.</p></dd><dt><span class="term"><em class="replaceable"><code>имя</code></em>
	      <em class="replaceable"><code>...</code></em></span></dt><dd><p>Выдать учетную информацию только для пользователей с
		заданными <em class="replaceable"><code>именами</code></em>.</p></dd></dl></div><p>В стандартном отчете, который создает команда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a>,
	  выдается количество страниц, напечатанное каждым из пользователей с
	  различных хостов. Если для вас хосты не имеют значения (поскольку
	  пользователи могут работать на любом хосте), выполните команду
	  <code class="command">pac -m</code> для получения следующих итогов:</p><pre class="screen">  Login	       pages/feet   runs    price
andy                        2.00    1   $  0.04
kelly                     182.00  105   $  3.64
mary                      118.00   35   $  2.36
root                       26.00   12   $  0.52
zhang                       9.00    1   $  0.18

total                     337.00  154   $  6.74</pre><p>Для получения сумм в долларах программа <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a> использует
	  значение характеристики <code class="literal">pc</code> в файле
	  <code class="filename">/etc/printcap</code> (по умолчанию - 200, или 2 цента
	  за страницу). Укажите в качестве значения этой характеристики, в
	  сотых долях цента, стоимость страницы или фута, исходя из которой
	  вы хотите брать деньги за распечатки. Это значение можно
	  переопределить при вызове команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a> с помощью опции
	  <code class="option">-p</code>. Но при использовании опции <code class="option">-p</code>
	  стоимость надо указывать в долларах, а не в сотых долях цента.
	  Например, команда

	  </p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>pac -p1.50</code></strong></pre><p>

	  приводит к тому, что страница будет стоить один доллар пятьдесят
	  центов. Используя эту опцию, можно фактически начинать грести деньги
	  лопатой.</p><p>Наконец, при выполнении команды <code class="command">pac -s</code> итоговая
	  информация будет сохранена в итоговом учетном файле, имя которого
	  строится как имя учетного файла принтера с суффиксом
	  <code class="literal">_sum</code>. Затем учетный файл принтера очищается.
	  Когда команда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pac&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pac</span>(8)</span></a> выполняется повторно, она перечитывает
	  итоговый файл для получения начальных сумм, а затем добавляет
	  информацию из обычного учетного файла.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp84373968"></a>10.4.5.2. Как можно подсчитать количество напечатанных страниц?</h4></div></div></div><p>Для выполнения хоть отдаленно точного учета надо уметь определять,
	  сколько бумаги использовано для печати задания. Это - основная
	  проблема учета использования принтеров.</p><p>Для обычных текстовых заданий решить эту проблему не сложно: надо
	  считать, сколько строк входит в задание, и сравнивать с количеством
	  строк на страницу, которые поддерживает принтер. Не забывайте
	  учитывать символы забоя в файлах, которые приводят к перепечатке
	  строк поверх, а также длинные логические строки, которые переносятся
	  на несколько физических.</p><p>Текстовый фильтр <code class="command">lpf</code> (представленный в разделе
	  <a class="link" href="printing-advanced.html#printing-advanced-lpf" title="10.4.1.6. lpf: текстовый фильтр">lpf: текстовый фильтр</a>)
	  учитывает эти вещи при выполнении учета. Если вы пишете текстовый
	  фильтр, который должен осуществлять учет, может иметь смысл
	  просмотреть исходный код программы <code class="command">lpf</code>.</p><p>Но как обрабатывать файлы других форматов?</p><p>Ну, для преобразования из DVI в формат LaserJet или из DVI в
	  <span class="trademark">PostScript</span>(R), можно в фильтре анализировать диагностические
	  результаты команды <code class="command">dvilj</code> или <code class="command">dvips</code>,
	  чтобы определить, сколько страниц было преобразовано. Может оказаться
	  возможным применить этот прием и для других форматов файлов и
	  программ преобразования.</p><p>Но эти методы несовершенны из-за того, что принтер мог
	  фактически и не напечатать все эти страницы. Например, он мог
	  замять бумагу, в нем мог закончиться тонер или он мог вообще
	  взорваться - и пользователю все равно пришлось бы платить.</p><p>Так что же делать?</p><p>Есть только один <span class="emphasis"><em>надежный</em></span> способ
	  <span class="emphasis"><em>точного</em></span> учета. Купите принтер, который может
	  сообщать, сколько бумаги он использовал, и подключите его
	  через последовательный порт или по сети. Практически все
	  <span class="trademark">PostScript</span>(R)-принтеры поддерживают такую возможность. Другие
	  модели - тоже (сетевые лазерные принтеры Imagen, например).
	  Измените фильтры для этих принтеров так, чтобы получать количество
	  использованных страниц после печати каждого задания, и пусть они
	  записывают учетную информацию <span class="emphasis"><em>только</em></span> на основе
	  этого значения. Не надо ни считать строки, ни выполнять
	  чреватую ошибками обработку файла.</p><p>Конечно, всегда можно поступить великодушно и не брать денег
	  за распечатки.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="printing-intro-setup.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="printing.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="printing-using.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">10.3. Основная настройка </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 10.5. Использование принтеров</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>