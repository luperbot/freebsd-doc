<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>26.5. * IPFILTER (IPF)</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="firewalls.html" title="Глава 26. Межсетевые экраны" /><link rel="prev" href="firewalls-pf.html" title="26.4. Packet Filter (PF, межсетевой экран OpenBSD) и ALTQ" /><link rel="next" href="firewalls-ipfw.html" title="26.6. IPFW" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">26.5. * IPFILTER (IPF)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="firewalls-pf.html">Пред.</a> </td><th width="60%" align="center">Глава 26. Межсетевые экраны</th><td width="20%" align="right"> <a accesskey="n" href="firewalls-ipfw.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="firewalls-ipf"></a>26.5. * IPFILTER (IPF)</h2></div></div></div><a id="idp99040080" class="indexterm"></a><div xmlns="" class="warning"><h3 class="admontitle">Предупреждение: </h3><p xmlns="http://www.w3.org/1999/xhtml">Перевод раздела не завершен.</p></div><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Этот раздел находится в процессе написания; содержание
	может не вполне соответствовать действительности.</p></div><p>Автором IPFILTER является Darren Reed.  IPFILTER не
      зависит от операционной системы:  это приложение с открытыми
      исходными текстами, которое было портировано на операционные
      системы FreeBSD, NetBSD, OpenBSD, <span class="trademark">SunOS</span>TM, HP/UX, и <span class="trademark">Solaris</span>TM.
      IPFILTER активно разрабатывается и поддерживается, регулярно
      выпускаются обновленные версии.</p><p>IPFILTER основан на межсетевом экране и механизме
      <acronym class="acronym">NAT</acronym> уровня ядра, которые управляются и контролируются
      утилитами уровня пользовательских процессов.  Правила межсетевого экрана
      могут устанавливаться или удаляться утилитой <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a>.
      Правила <acronym class="acronym">NAT</acronym> могут устанавливаться или
      удаляться утилитой <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipnat&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ipnat</span>(1)</span></a>.  Утилита <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a>
      выводит статистику IPFILTER для ядра.  Программа
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipmon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipmon</span>(8)</span></a> может заносить действия IPFILTER в файлы системных
      протоколов.</p><p>IPF был первоначально написан с использованием правила
      <span class="quote"><<<span class="quote">последнее совпадение применяется</span>>></span> и только
      с правилами без сохранения состояния. Со временем IPF
      был расширен и включает параметры <span class="quote"><<<span class="quote">quick</span>>></span> и
      <span class="quote"><<<span class="quote">keep state</span>>></span> (сохранение состояния), которые
      кардинальным образом изменяют логику обработки пакетов.
      Официальная документация IPF включает традиционные параметры
      правил с традиционной последовательностью обработки пакетов.
      Измененные функции включены в виде дополнительных параметров,
      они необходимы для создания эффективного межсетевого экрана.</p><p>Инструкции этого раздела подразумевают использование
      параметра <span class="quote"><<<span class="quote">quick</span>>></span> и параметра сохранения
      состояния <span class="quote"><<<span class="quote">keep state</span>>></span>.  Это основа для создания
      включающего межсетевого экрана.</p><p>Детальное описание традиционных методов обработки правил:
      <code class="uri"><a class="uri" href="http://www.obfuscation.org/ipf/ipf-howto.html#TOC_1" target="_top">http://www.obfuscation.org/ipf/ipf-howto.html#TOC_1</a></code>
      и
      <code class="uri"><a class="uri" href="http://coombs.anu.edu.au/~avalon/ip-filter.html" target="_top">http://coombs.anu.edu.au/~avalon/ip-filter.html</a></code>.</p><p>IPF FAQ находится по адресу
      <code class="uri"><a class="uri" href="http://www.phildev.net/ipf/index.html" target="_top">http://www.phildev.net/ipf/index.html</a></code>.</p><p>Архив списка рассылки по IPFilter с возможностью поиска доступен
      по адресу <code class="uri"><a class="uri" href="http://marc.theaimsgroup.com/?l=ipfilter" target="_top">http://marc.theaimsgroup.com/?l=ipfilter</a></code>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99074768"></a>26.5.1. Включение IPF</h3></div></div></div><a id="idp99075408" class="indexterm"></a><p>IPF включен в базовую систему FreeBSD в качестве отдельного
	загружаемого модуля.  Система динамически загрузит модуль IPF,
	если в <code class="filename">rc.conf</code> указана переменная
	<code class="literal">ipfilter_enable="YES"</code>.  Модуль создается
	с включенным протоколированием и правилом по умолчанию
	<code class="literal">pass all</code> (пропускать все).  Для изменения
	правила по умолчанию не обязательно собирать ядро с новыми
	параметрами.  Просто добавьте в конец набора правило,
	блокирующее все пакеты.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99078224"></a>26.5.2. Параметры ядра</h3></div></div></div><a id="idp99078864" class="indexterm"></a><a id="idp99080016" class="indexterm"></a><a id="idp99081168" class="indexterm"></a><a id="idp99082320" class="indexterm"></a><p>Включение IPF в ядро FreeBSD не является обязательным требованием.
	Эта процедура представлена здесь в качестве дополнительной
	информации.  При включении IPF в ядро загружаемый модуль
	не используется.</p><p>Пример параметров настройки ядра для IPF находится в
	<code class="filename">/usr/src/sys/conf/NOTES</code>
	и воспроизведен здесь:</p><pre class="programlisting">options IPFILTER
options IPFILTER_LOG
options IPFILTER_DEFAULT_BLOCK</pre><p><code class="literal">options IPFILTER</code> включает поддержку
	межсетевого экрана <span class="quote"><<<span class="quote">IPFILTER</span>>></span>.</p><p><code class="literal">options IPFILTER_LOG</code> включает
	протоколирование трафика через IPF путем записи его в
	псевдо-устройство протоколирования пакетов
	<code class="filename">ipl</code> для каждого
	правила, содержащего ключевое слово
	<code class="literal">log</code>.</p><p><code class="literal">options IPFILTER_DEFAULT_BLOCK</code>
	изменяет поведение по умолчанию так, что блокируется каждый
	пакет, не соответствующий правилу
	<code class="literal">pass</code>.</p><p>Эти настройки будут работать только после сборки и установки
	нового ядра.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99093200"></a>26.5.3. Доступные параметры rc.conf</h3></div></div></div><p>Для активации IPF во время загрузки в
	<code class="filename">/etc/rc.conf</code> потребуется добавить
	следующие переменные:</p><pre class="programlisting">ipfilter_enable="YES"             # Запуск межсетевого экрана ipf
ipfilter_rules="/etc/ipf.rules"   # Загрузка файла с правилами
ipmon_enable="YES"                # Включение протоколирования IP monitor
ipmon_flags="-Ds"                 # D = запуск в виде даемона
                                  # s = протоколирование в syslog
                                  # v = протоколирование tcp window, ack, seq
                                  # n = отображение имен IP и портов</pre><p>Если за межсетевым экраном находится локальная сеть, использующая
	приватные IP адреса, для включения <acronym class="acronym">NAT</acronym>
	потребуется добавить следующие переменные:</p><pre class="programlisting">gateway_enable="YES"              # Включение шлюза для локальной сети
ipnat_enable="YES"                # Запуск функции ipnat
ipnat_rules="/etc/ipnat.rules"    # Определение файла правил для ipnat</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99100496"></a>26.5.4. IPF</h3></div></div></div><a id="idp99101136" class="indexterm"></a><p>Команда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a> используется для загрузки файла с правилами.
	Обычно создается файл, содержащий подготовленный набор
	правил, который полностью замещает набор, используемый
	на данный момент:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ipf -Fa -f /etc/ipf.rules</code></strong></pre><p><code class="option">-Fa</code> означает сброс всех внутренних таблиц правил.</p><p><code class="option">-f</code> указывает файл с правилами, который необходимо загрузить.</p><p>Это дает вам возможность отредактировать файл с правилами,
	запустить вышеприведенную команду IPF, тем самым обновить набор правил
	работающего межсетевого экрана без перезагрузки системы.  Для
	обновления правил
	такой подход очень удобен, поскольку команду можно выполнять
	столько раз, сколько нужно.</p><p>На странице справочной системы <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a> находится
	подробная информация по всем флагам этой команды.</p><p>Набор правил для команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a> должен быть в виде
	стандартного текстового файла.  Правила, написанные в виде
	скрипта с символами подстановки, не принимаются.</p><p>Есть способ составления правил IPF, использующих
	символы подстановки.  Обратитесь к <a class="xref" href="firewalls-ipf.html#firewalls-ipf-rules-script" title="26.5.9. Создание набора правил с использованием символьной подстановки">Раздел 26.5.9, <<Создание набора правил с использованием символьной подстановки>></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99113168"></a>26.5.5. IPFSTAT</h3></div></div></div><a id="idp99113808" class="indexterm"></a><a id="idp99114704" class="indexterm"></a><p>По умолчанию <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a> получает и отображает суммарную
	статистику, полученную в результате применения действующих правил
	к пакетам, проходящим через межсетевой экран с момента его последнего
	запуска, или с того момента, когда статистика была последний раз
	обнулена командой <code class="command">ipf -Z</code>.</p><p>Детальная информация приводится на странице справочника
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a>.</p><p>Вывод команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a> по умолчанию выглядит
	примерно так:</p><pre class="screen">input packets: blocked 99286 passed 1255609 nomatch 14686 counted 0
 output packets: blocked 4200 passed 1284345 nomatch 14687 counted 0
 input packets logged: blocked 99286 passed 0
 output packets logged: blocked 0 passed 0
 packets logged: input 0 output 0
 log failures: input 3898 output 0
 fragment state(in): kept 0 lost 0
 fragment state(out): kept 0 lost 0
 packet state(in): kept 169364 lost 0
 packet state(out): kept 431395 lost 0
 ICMP replies: 0 <acronym class="acronym">TCP</acronym> RSTs sent: 0
 Result cache hits(in): 1215208 (out): 1098963
 IN Pullups succeeded: 2 failed: 0
 OUT Pullups succeeded: 0 failed: 0
 Fastroute successes: 0 failures: 0
 <acronym class="acronym">TCP</acronym> cksum fails(in): 0 (out): 0
 Packet log flags set: (0)</pre><p>При задании флага <code class="option">-i</code> или <code class="option">-o</code>
	соответственно для входящих или
	исходящих пакетов, команда извлечет и отобразит соответствующий
	список правил, установленных и
	используемых на данный момент.</p><p><code class="command">ipfstat -in</code> отображает правила, применяемые
	к входящим пакетам, вместе с номерами этих правил.</p><p><code class="command">ipfstat -on</code> отображает правила, применяемые
	к исходящим пакетам, вместе с номерами этих правил.</p><p>Вывод команды будет выглядеть примерно так:</p><pre class="screen">@1 pass out on xl0 from any to any
@2 block out on dc0 from any to any
@3 pass out quick on dc0 proto tcp/udp from any to any keep state</pre><p><code class="command">ipfstat -ih</code> отображает правила, применяемые
	к входящим пакетам, со счетчиком количества совпадений для
	каждого правила.</p><p><code class="command">ipfstat -oh</code> отображает правила, применяемые
	к исходящим пакетам, со счетчиком количества совпадений для
	каждого правила.</p><p>Вывод команды будет выглядеть примерно так:</p><pre class="screen">2451423 pass out on xl0 from any to any
354727 block out on dc0 from any to any
430918 pass out quick on dc0 proto tcp/udp from any to any keep state</pre><p>Одна из наиболее важных функций команды
	<code class="command">ipfstat</code> активируется флагом <code class="option">-t</code>,
	правила отображаются подобно тому, как <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=top&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">top</span>(1)</span></a>
	показывает таблицу запущенных процессов FreeBSD.  Когда межсетевой экран
	подвергается атаке, эта функция позволяет обнаружить соответствующие
	пакеты.  Дополнительные флаги дают возможность выбирать IP
	адрес назначения или источника, порт или протокол, которые
	будут отслеживаться в реальном времени.  Подробная информация
	приведена на странице <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99133264"></a>26.5.6. IPMON</h3></div></div></div><a id="idp99133904" class="indexterm"></a><a id="idp99134800" class="indexterm"></a><p>Для того, чтобы стало возможно использование команды
	<code class="command">ipmon</code>, необходимо включить параметр ядра
	<code class="literal">IPFILTER_LOG</code>.  Эта команда может использоваться в двух различных
	режимах.  В основном режиме, который используется по умолчанию,
	она используется без флага <code class="option">-D</code>.</p><p>В режиме даемона создается непрерывный протокол, и возможен
	просмотр предыдущих событий.  В этом режиме IPFILTER работает
	в FreeBSD.  Поскольку в FreeBSD встроена функция ротации файлов
	протокола, лучше использовать <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a>, чем используемый по
	умолчанию вывод в обычный файл.  В <code class="filename">rc.conf</code>
	по умолчанию <code class="literal">ipmon_flags</code> имеет значение <code class="option">-Ds</code>:</p><pre class="programlisting">ipmon_flags="-Ds" # D = start as daemon
                  # s = log to syslog
                  # v = log tcp window, ack, seq
                  # n = map IP &amp; port to names</pre><p>Описывать преимущества протоколирования излишне.  Например,
	оно дает возможность отложенного просмотра информации об отброшенных
	пакетах, откуда они пришли и куда направлялись.
	Эта информация существенно помогает при отслеживании атак.</p><p>Даже с включенным протоколированием, IPF не ведет протокол
	для каждого правила.  Администратор межсетевого экран должен решить,
	по каким правилам набора нужно вести протокол и добавить ключевое
	слово log к этим правилам.  Обычно протоколируются только правила,
	отбрасывающие пакеты.</p><p>Включение в набор последнего правила, запрещающего прохождение
	пакетов, в сочетании с ключевым словом <code class="literal">log</code> является
	довольно распространённой практикой.  Так вы можете увидеть все пакеты,
	не
	попадающие ни под одно правило набора.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99150160"></a>26.5.7. Протоколирование IPMON</h3></div></div></div><p>Для разделения собираемых данных
	<span class="application">syslogd</span> использует свой собственный
	специальный метод.  Он использует группировку по категории
	(<span class="quote"><<<span class="quote">facility</span>>></span>) и уровню (<span class="quote"><<<span class="quote">level</span>>></span>).
	IPMON в режиме <code class="option">-Ds</code> использует
	<code class="literal">local0</code>
	в качестве имени <span class="quote"><<<span class="quote">категории</span>>></span>.
	Для дальнейшего разделения
	протоколируемых данных, если такое необходимо, могут быть использованы следующие
	уровни:</p><pre class="screen">LOG_INFO - packets logged using the "log" keyword as the action rather than pass or block.
LOG_NOTICE - packets logged which are also passed
LOG_WARNING - packets logged which are also blocked
LOG_ERR - packets which have been logged and which can be considered short</pre><p>Для указания IPFILTER протоколировать все данные в
	<code class="filename">/var/log/ipfilter.log</code>, создайте этот
	файл заранее, выполнив следующую команду:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>touch /var/log/ipfilter.log</code></strong></pre><p>Функционирование <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a> управляется настройками в файле
	<code class="filename">/etc/syslog.conf</code>.  Файл
	<code class="filename">syslog.conf</code> позволяет достаточно гибко
	настроить обработку системных сообщений, выдаваемых программами,
	такими как IPF.</p><p>Добавьте в <code class="filename">/etc/syslog.conf</code>
	следующую запись:</p><pre class="programlisting">local0.* /var/log/ipfilter.log</pre><p><code class="literal">local0.*</code> означает запись всех
	протоколируемых сообщений в указанный файл.</p><p>Для применения внесенных в
	<code class="filename">/etc/syslog.conf</code> изменений вы можете
	перезагрузиться или заставить <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a> перечитать
	<code class="filename">/etc/syslog.conf</code>, выполнив команду
	<code class="command">/etc/rc.d/syslogd reload</code>.</p><p>Не забудьте отредактировать
	<code class="filename">/etc/newsyslog.conf</code> для ротации только
	что созданного лог файла.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99162960"></a>26.5.8. Формат протоколируемых сообщений</h3></div></div></div><p>Сообщения, генерируемые <code class="command">ipmon</code>, состоят
	из полей данных, разделенных пробелами. Поля, общие для всех
	сообщений:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Дата получения пакета.</p></li><li class="listitem"><p>Время получения пакета.  Формат времени
	    HH:MM:SS.F для часов, минут, секунд и долей секунд
	    (последнее поле может состоять из нескольких цифр).</p></li><li class="listitem"><p>Имя интерфейса, через который прошел пакет,
	    например <code class="filename">dc0</code>.</p></li><li class="listitem"><p>Группа и номер правила, например
	    <code class="literal">@0:17</code>.</p></li></ol></div><p>Эти сообщения могут быть просмотрены командой
	<code class="command">ipfstat -in</code>.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Действие: p для пропущенных, b для заблокированных, S
	    для пакетов с неполным заголовком (short packet),
	    n для пакетов, не соответствующих какому-либо правилу,
	    L для соответствующих правилу протоколирования.
	    Порядок следования по флагам: S, p, b, n, L.  Знаки
	    P или B в верхнем регистре означают, что пакет был
	    протоколирован в соответствии с общими настройками,
	    а не каким-то конкретным правилом.</p></li><li class="listitem"><p>Адреса.  Всего три поля: адрес и порт источника
	    (разделенные запятой), -&gt;, адрес и порт
	    назначения.
	    209.53.17.22,80 -&gt; 198.73.220.17,1722.</p></li><li class="listitem"><p><code class="literal">PR</code>, с последующим именем или
	    номером протокола, например <code class="literal">PR tcp</code>.</p></li><li class="listitem"><p><code class="literal">len</code>, с последующей длиной заголовка
	    и общей длиной пакета, например <code class="literal">len 20 40</code>.</p></li></ol></div><p>Для <acronym class="acronym">TCP</acronym> пакетов добавляется дополнительное
	поле, начинающееся с дефиса, за которым следуют буквы,
	соответствующие установленным флагам.  На странице справочника
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">ipf</span>(5)</span></a> находится список букв и флагов.</p><p>Для пакетов ICMP, в конце находятся два поля,
	одно всегда <span class="quote"><<<span class="quote">ICMP</span>>></span>, а второе содержит тип и подтип
	ICMP сообщения (message и sub-message), разделенные символом косой черты,
	например ICMP 3/3 для сообщения <span class="quote"><<<span class="quote">port
	unreachable</span>>></span>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="firewalls-ipf-rules-script"></a>26.5.9. Создание набора правил с использованием символьной подстановки</h3></div></div></div><p>Некоторые опытные пользователи IPF создают файл правил,
	поддерживающий использование символьной подстановки.  Основное
	преимущество использования такого подхода заключается в
	возможности изменения значения, присваиваемого символьному
	имени, в результате чего во всех правилах, содержащих эту
	символьную подстановку, будет использоваться новое значение.
	В начале скрипта вы можете поместить часто используемые
	переменные, а затем использовать их сразу в нескольких
	правилах.  Ниже дан пример такого использования.</p><p>Синтаксис скрипта совместим с <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=csh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">csh</span>(1)</span></a>, и
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tcsh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tcsh</span>(1)</span></a>.</p><p>Символьная подстановка предваряется знаком доллара:
	<code class="literal">$</code>.</p><p>Для присвоения значения символьным переменным знак
	$ не используется.</p><p>Присваиваемое символической переменной значение должно
	быть заключено в двойные кавычки (<code class="literal">"</code>).</p><p>Начните файл правил примерно так:</p><pre class="programlisting">############# Start of IPF rules script ########################

oif="dc0"            # name of the outbound interface
odns="192.0.2.11"    # ISP's DNS server IP address
myip="192.0.2.7"     # my static IP address from ISP
ks="keep state"
fks="flags S keep state"

# You can choose between building /etc/ipf.rules file
# from this script or running this script "as is".
#
# Uncomment only one line and comment out another.
#
# 1) This can be used for building /etc/ipf.rules:
#cat &gt; /etc/ipf.rules &lt;&lt; EOF
#
# 2) This can be used to run script "as is":
/sbin/ipf -Fa -f - &lt;&lt; EOF

# Allow out access to my ISP's Domain name server.
pass out quick on $oif proto tcp from any to $odns port = 53 $fks
pass out quick on $oif proto udp from any to $odns port = 53 $ks

# Allow out non-secure standard www function
pass out quick on $oif proto tcp from $myip to any port = 80 $fks

# Allow out secure www function https over TLS SSL
pass out quick on $oif proto tcp from $myip to any port = 443 $fks
EOF
################## End of IPF rules script ########################</pre><p>Это все, что требовалось сделать.  В данном примере сами
	правила не важны; важно то, как используется символьная подстановка.
	Если вышеприведенный пример помещен в файл
	<code class="filename">/etc/ipf.rules.script</code>, то набор правил можно
	перезагрузить, введя следующую команду:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh /etc/ipf.rules.script</code></strong></pre><p>С использованием в правилах символьной подстановки связана одна
	проблема: IPF не понимает символьную подстановку и не может обработать
	такой скрипт непосредственно.</p><p>Скрипт может использоваться одним из следующих двух
	способов:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Уберите комментарий перед строкой, начинающейся с
	    <code class="literal">cat</code>, и закомментируйте строку,
	    начинающуюся с <code class="literal">/sbin/ipf</code>.  Поместите
	    строку <code class="literal">ipfilter_enable="YES"</code> в файл
	    <code class="filename">/etc/rc.conf</code> как обычно, и запускайте
	    скрипт после каждого его обновления для создания или обновления
	    файла <code class="filename">/etc/ipf.rules</code>.</p></li><li class="listitem"><p>Отключите IPFILTER в стартовых скриптах системы, поместив
	    строку <code class="literal">ipfilter_enable="NO"</code> (это значение
	    по умолчанию) в файл <code class="filename">/etc/rc.conf</code>.</p><p>Поместите скрипт, подобный нижеприведенному, в каталог
	    <code class="filename">/usr/local/etc/rc.d/</code>.  У него должно
	    быть однозначно говорящее о его назначении имя, например
	    <code class="filename">ipf.loadrules.sh</code>.  Расширение
	    <code class="filename">.sh</code> обязательно.</p><pre class="programlisting">#!/bin/sh
sh /etc/ipf.rules.script</pre><p>Права, установленные на этот файл, должны разрешать чтение, запись и
	    выполнение владельцу <code class="systemitem">root</code>.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chmod 700 /usr/local/etc/rc.d/ipf.loadrules.sh</code></strong></pre></li></ul></div><p>Теперь, правила IPF будут загружаться при загрузке
	  системы.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99203920"></a>26.5.10. Наборы правил IPF</h3></div></div></div><p>Набор правил ipf это группа правил, составленных для
	пропускания или блокирования пакетов на основе их содержимого.
	Двусторонний обмен пакетами между хостами составляет сессию.
	Межсетевой экран обрабатывает как входящие из Интернет пакеты,
	так и исходящие пакеты, которые сгенерированы самой системой в ответ
	на входящий трафик.  Для каждой службы <acronym class="acronym">TCP/IP</acronym>
	(например, telnet, www, mail, и т.п.) назначен протокол и номер
	привилегированного (прослушиваемого) порта.  Пакеты, предназначенные
	для определенного сервиса, порождаются с некоторым исходящим адресом
	и портом из непривилегированного диапазона и направляются
	на определенный адрес и определенный порт назначения.  Все
	упомянутые параметры (номера портов и адреса) могут использоваться
	как критерии выбора в правилах, пропускающих или блокирующих доступ
	к службам <acronym class="acronym">TCP/IP</acronym>.</p><a id="idp99209936" class="indexterm"></a><p>IPF был первоначально написан с использованием логики
	<span class="quote"><<<span class="quote">последнее совпадающее правило побеждает</span>>></span> и
	только с правилами без сохранения состояния.  Со временем
	в IPF был включен параметр <span class="quote"><<<span class="quote">quick</span>>></span> и параметр
	сохранения состояния <span class="quote"><<<span class="quote">keep state</span>>></span>, что
	существенно улучшило логику обработки правил.</p><p>Инструкции, помещенные в эту главу, созданы с использованием
	параметров <span class="quote"><<<span class="quote">quick</span>>></span> и <span class="quote"><<<span class="quote">keep state</span>>></span>.
	Это основа для создания набора правил включающего межсетевого
	экрана.</p><div xmlns="" class="warning"><h3 class="admontitle">Предупреждение: </h3><p xmlns="http://www.w3.org/1999/xhtml">При работе с правилами межсетевого экрана, будьте
	  <span class="emphasis"><em>очень осторожны</em></span>.  Некоторые
	  конфигурации <span class="emphasis"><em>могут заблокировать вам
	  доступ</em></span> к серверу.  В целях предосторожности,
	  первоначальную настройку межсетевого экрана вы можете
	  выполнить с локальной консоли, а не через удаленное
	  подключение, такое как
	  <span class="application">ssh</span>.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="firewalls-pf.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="firewalls.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="firewalls-ipfw.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">26.4. Packet Filter (PF, межсетевой экран OpenBSD) и
      <acronym class="acronym">ALTQ</acronym> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 26.6. IPFW</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>