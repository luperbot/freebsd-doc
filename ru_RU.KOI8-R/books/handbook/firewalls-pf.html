<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>26.4. Packet Filter (PF, межсетевой экран OpenBSD) и ALTQ</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="firewalls.html" title="Глава 26. Межсетевые экраны" /><link rel="prev" href="firewalls-apps.html" title="26.3. Пакеты межсетевых экранов" /><link rel="next" href="firewalls-ipf.html" title="26.5. * IPFILTER (IPF)" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">26.4. Packet Filter (PF, межсетевой экран OpenBSD) и
      <acronym class="acronym">ALTQ</acronym></th></tr><tr><td width="20%" align="left"><a accesskey="p" href="firewalls-apps.html">Пред.</a> </td><th width="60%" align="center">Глава 26. Межсетевые экраны</th><td width="20%" align="right"> <a accesskey="n" href="firewalls-ipf.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="firewalls-pf"></a>26.4. Packet Filter (PF, межсетевой экран OpenBSD) и
      <acronym class="acronym">ALTQ</acronym></h2></div><div><span class="authorgroup">Пересмотрел и обновил <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">John</span> <span class="surname">Ferrell</span></span>. </span></div></div></div><a id="idp98904912" class="indexterm"></a><p>В июле 2003 программный межсетевой экран OpenBSD, известный как
      <acronym class="acronym">PF</acronym>, был портирован в FreeBSD и стал доступен
      из коллекции портов FreeBSD; первым релизом, где
      <acronym class="acronym">PF</acronym> был интегрирован в основную систему,
      стала FreeBSD 5.3 в ноябре 2004.
      <acronym class="acronym">PF</acronym> это полноценный межсетевой экран с широким набором
      возможностей, в котором есть опциональная поддержка
      <acronym class="acronym">ALTQ</acronym> (Alternate Queuing).
      <acronym class="acronym">ALTQ</acronym> предоставляет управление пропускной способностью
      Quality of Service (<acronym class="acronym">QoS</acronym>).</p><p>Проект OpenBSD осуществляет замечательную работу по поддержке
      <a class="link" href="http://www.openbsd.org/faq/pf/" target="_top">PF FAQ</a>.  Этот раздел
      руководства фокусируется на взаимосвязи <acronym class="acronym">PF</acronym> и
      FreeBSD, предоставляя лишь общую информацию по его использованию.
      За более подробной информацией по использованию <acronym class="acronym">PF</acronym>
      обратитесь к <a class="link" href="http://www.openbsd.org/faq/pf/" target="_top">PF FAQ</a>.</p><p>Дополнительные сведения о PF для FreeBSD можно получить с веб сайта:
      <code class="uri"><a class="uri" href="http://pf4freebsd.love2party.net/" target="_top">http://pf4freebsd.love2party.net/</a></code>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98912336"></a>26.4.1. Использование модуля ядра PF</h3></div></div></div><p>Чтобы загрузить PF как модуль ядра, добавьте следующую строку
	в <code class="filename">/etc/rc.conf</code>:</p><pre class="programlisting">pf_enable="YES"</pre><p>Далее, выполните стартовый скрипт:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/pf start</code></strong></pre><p>Учтите, модуль PF не загрузится, если он не сможет найти
	конфигурационный файл с набором правил.  По умолчанию размещение
	файла с правилами следующее: <code class="filename">/etc/pf.conf</code>.
	Если путь к файлу отличается от вышеприведённого, то внесите в
	<code class="filename">/etc/rc.conf</code> строку вида:</p><pre class="programlisting">pf_rules="<em class="replaceable"><code>/path/to/pf.conf</code></em>"</pre><p>Файл с примерами конфигураций <code class="filename">pf.conf</code>
	находится в каталоге <code class="filename">/usr/share/examples/pf/</code>.</p><p>Модуль <acronym class="acronym">PF</acronym> можно также загрузить вручную:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kldload pf.ko</code></strong></pre><p>Поддержка ведения логов для <acronym class="acronym">PF</acronym> обеспечивается
	модулем <code class="literal">pflog.ko</code>, для загрузки которого добавьте
	следующую строку в <code class="filename">/etc/rc.conf</code>:</p><pre class="programlisting">pflog_enable="YES"</pre><p>и запустите на выполнение скрипт:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/pflog start</code></strong></pre><p>Если вам необходимы другие функциональные возможности
	<acronym class="acronym">PF</acronym>, то придется добавить поддержку
	<acronym class="acronym">PF</acronym> в ядро.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98929360"></a>26.4.2. Параметры ядра</h3></div></div></div><a id="idp98930000" class="indexterm"></a><a id="idp98931152" class="indexterm"></a><a id="idp98932304" class="indexterm"></a><p>Включение <acronym class="acronym">PF</acronym> путем компиляции с ядром FreeBSD не является обязательным
	требованием,
	однако вам может понадобиться
	одна из функциональных возможностей, которая не включена в загружаемый
	модуль.  Например, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pfsync&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pfsync</span>(4)</span></a> являет собой псевдоустройство,
	которое вносит определенные изменения в таблицу состояний, используемую
	<acronym class="acronym">PF</acronym>.  В дальнейшем, это псевдоустройство может быть
	скомпоновано с <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=carp&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">carp</span>(4)</span></a> чтобы создать отказоустойчивую систему
	межсетевых экранов на основе <acronym class="acronym">PF</acronym>.
</p><p>Пример параметров конфигурации ядра для включения PF находится в
	<code class="filename">/usr/src/sys/conf/NOTES</code> и показан здесь:</p><pre class="programlisting">device pf
device pflog
device pfsync</pre><p><code class="literal">device pf</code> включает поддержку межсетевого экрана
	<span class="quote"><<<span class="quote">Packet Filter</span>>></span> (<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pf&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pf</span>(4)</span></a>).</p><p><code class="literal">device pflog</code> включает необязательное сетевое
	псевдоустройство <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pflog&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pflog</span>(4)</span></a>, которое может использоваться для
	протоколирования трафика через <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bpf&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">bpf</span>(4)</span></a>.  Даемон <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pflogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pflogd</span>(8)</span></a>
	может использоваться для сохранения протоколируемой информации
	на диск.</p><p><code class="literal">device pfsync</code> включает необязательное
	сетевое псевдоустройство <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pfsync&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pfsync</span>(4)</span></a>, используемое для
	отслеживания <span class="quote"><<<span class="quote">изменений состояния</span>>></span>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98953168"></a>26.4.3. Доступные параметры rc.conf</h3></div></div></div><p>Для активации <acronym class="acronym">PF</acronym> и <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pflog&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pflog</span>(4)</span></a> во время
	загрузки в <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> должны быть включены следующие
	переменные:</p><pre class="programlisting">pf_enable="YES"                 # Включить PF (загрузить модуль если необходимо)
pf_rules="/etc/pf.conf"         # определение правил для pf
pf_flags=""                     # дополнительные флаги для запуска pfctl
pflog_enable="YES"              # запустить pflogd(8)
pflog_logfile="/var/log/pflog"  # где pflogd должен сохранять протокол
pflog_flags=""                  # дополнительные флаги для запуска pflogd</pre><p>Если за межсетевым экраном находится локальная сеть и необходимо передавать
	пакеты для компьютеров этой сети, или использовать NAT, включите также
	следующий параметр:</p><pre class="programlisting">gateway_enable="YES"            # Включить сетевой шлюз</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98957392"></a>26.4.4. Создание правил фильтрации</h3></div></div></div><p>Пакет <acronym class="acronym">PF</acronym> читает конфигурацию из файла
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pf.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">pf.conf</span>(5)</span></a> (полный путь: <code class="filename">/etc/pf.conf</code>);
	пакеты отвергаются, пропускаются или модифицируются в соответствии с
	правилами и определениями из этого файла.  В стандартную поставку
	FreeBSD входят несколько файлов с примерами конфигураций, которые
	находятся в каталоге <code class="filename">/usr/share/examples/pf/</code>.
	За исчерпывающим описанием правил <acronym class="acronym">PF</acronym> обратитесь
	к <a class="link" href="http://www.openbsd.org/faq/pf/" target="_top">PF FAQ</a>.</p><div xmlns="" class="warning"><h3 class="admontitle">Предупреждение: </h3><p xmlns="http://www.w3.org/1999/xhtml">Изучая <a class="link" href="http://www.openbsd.org/faq/pf/" target="_top">PF
	    FAQ</a>, имейте в виду, что различные версии FreeBSD могут
	  содержать разные версии pf.  В настоящий момент FreeBSD
	  использует ту же версию <acronym class="acronym">PF</acronym>, которая включена
	  в OpenBSD 4.1.</p></div><p><a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pf" target="_top">Список рассылки, посвящённый FreeBSD packet filter</a> является хорошим местом, чтобы задавать вопросы по
	конфигурации и использованию пакета <acronym class="acronym">PF</acronym>.
	Не забудьте проверить архивы списка рассылки перед тем, как
	задавать вопрос.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99001296"></a>26.4.5. Работа с PF</h3></div></div></div><p>Для управления <acronym class="acronym">PF</acronym> используйте утилиту
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pfctl&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pfctl</span>(8)</span></a>.  Ниже приведено несколько полезных команд (все
	возможные команды и опции приведены на странице справочника
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pfctl&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pfctl</span>(8)</span></a>):</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><thead><tr><th>Команда</th><th>Действие</th></tr></thead><tbody><tr><td><code class="command">pfctl -e</code></td><td>Включить PF</td></tr><tr><td><code class="command">pfctl -d</code></td><td>Выключить PF</td></tr><tr><td><code class="command">pfctl -F all -f /etc/pf.conf</code></td><td>Сбросить все правила (NAT, правила фильтрации, состояния
		соединений, таблицы и т.д.) и загрузить новые с файла
		<code class="filename">/etc/pf.conf</code></td></tr><tr><td><code class="command">pfctl -s [ rules | nat | state ]</code></td><td>Отобразить правила фильтрации, правила NAT или
		таблицу состояний соединений</td></tr><tr><td><code class="command">pfctl -vnf /etc/pf.conf</code></td><td>Проверить <code class="filename">/etc/pf.conf</code> на наличие
		ошибок, но сами наборы правил не загружать</td></tr></tbody></table></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp99018832"></a>26.4.6. Включение <acronym class="acronym">ALTQ</acronym></h3></div></div></div><p><acronym class="acronym">ALTQ</acronym> может быть включен только путем
	компилирования ядра FreeBSD с соответствующими параметрами.
	<acronym class="acronym">ALTQ</acronym> поддерживается не всеми существующими
	драйверами сетевых карт.  Для просмотра списка поддерживаемых
	устройств в вашем релизе FreeBSD обратитесь к странице справочника
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=altq&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">altq</span>(4)</span></a>.</p><p>Следующие параметры включат <acronym class="acronym">ALTQ</acronym>
	и добавят дополнительную функциональность.</p><pre class="programlisting">options         ALTQ
options         ALTQ_CBQ        # Class Bases Queuing (CBQ)
options         ALTQ_RED        # Random Early Detection (RED)
options         ALTQ_RIO        # RED In/Out
options         ALTQ_HFSC       # Hierarchical Packet Scheduler (HFSC)
options         ALTQ_PRIQ       # Priority Queuing (PRIQ)
options         ALTQ_NOPCC      # Required for SMP build</pre><p><code class="literal">options ALTQ</code> включает подсистему
	<acronym class="acronym">ALTQ</acronym>.</p><p><code class="literal">options ALTQ_CBQ</code> включает <span class="emphasis"><em>Class Based
	Queuing</em></span> (<acronym class="acronym">CBQ</acronym>).  <acronym class="acronym">CBQ</acronym>
	позволяет распределять пропускную способность соединений
	по классам или очередям для выставления приоритетов трафика
	на основе правил фильтрации.</p><p><code class="literal">options ALTQ_RED</code> включает <span class="emphasis"><em>Random Early
	Detection</em></span> (<acronym class="acronym">RED</acronym>).  <acronym class="acronym">RED</acronym>
	используется для предотвращения перегрузки сети.
	<acronym class="acronym">RED</acronym> вычисляет длину очереди и сравнивает ее
	с минимальным и максимальным значением длины очереди.  Если
	очередь превышает максимум, все новые пакеты будут отброшены.
	В соответствии со своим названием, <acronym class="acronym">RED</acronym>
	отбрасывает пакеты из различных соединений в произвольном
	порядке.</p><p><code class="literal">options ALTQ_RIO</code> включает <span class="emphasis"><em>Random Early
	Detection In and Out</em></span>.</p><p><code class="literal">options ALTQ_HFSC</code> включает
	<span class="emphasis"><em>Hierarchical Fair Service Curve Packet Scheduler</em></span>.
	Дополнительная
	информация о <acronym class="acronym">HFSC</acronym> находится по адресу: <code class="uri"><a class="uri" href="http://www-2.cs.cmu.edu/~hzhang/HFSC/main.html" target="_top">http://www-2.cs.cmu.edu/~hzhang/HFSC/main.html</a></code>.
	</p><p><code class="literal">options ALTQ_PRIQ</code> включает <span class="emphasis"><em>Priority
	Queuing</em></span> (<acronym class="acronym">PRIQ</acronym>).  <acronym class="acronym">PRIQ</acronym>
	всегда первым пропускает трафик из очереди c более высоким
	приоритетом.</p><p><code class="literal">options ALTQ_NOPCC</code> включает
	поддержку <acronym class="acronym">SMP</acronym> для <acronym class="acronym">ALTQ</acronym>.
	Эта опция необходима для <acronym class="acronym">SMP</acronym>
	систем.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="firewalls-apps.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="firewalls.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="firewalls-ipf.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">26.3. Пакеты межсетевых экранов </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 26.5. * IPFILTER (IPF)</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>