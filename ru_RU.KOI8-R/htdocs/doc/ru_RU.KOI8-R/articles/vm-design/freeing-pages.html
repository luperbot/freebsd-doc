<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>4. Когда освобождать страницу</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Элементы архитектуры системы виртуальной памяти во FreeBSD" /><link rel="up" href="index.html" title="Элементы архитектуры системы виртуальной памяти во FreeBSD" /><link rel="prev" href="swap-layers.html" title="3. Уровни области подкачки" /><link rel="next" href="prefault-optimizations.html" title="5. Оптимизация ошибок доступа к страницам и их обнуления" /><link rel="copyright" href="trademarks.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4. Когда освобождать страницу</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="swap-layers.html">Пред.</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="prefault-optimizations.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="freeing-pages"></a>4. Когда освобождать страницу</h2></div></div></div><p>Так как система VM использует всю доступную память для кэширования
      диска, то обычно действительно незанятых страниц очень мало.  Система VM
      зависит от того, как она точно выбирает незанятые страницы для повторного
      использования для новых распределений.  Оптимальный выбор страниц для
      высвобождения, возможно, является самой важной функцией любой VM-системы,
      из тех, что она может выполнять, потому что при неправильном выборе
      система VM вынуждена будет запрашивать страницы с диска, значительно
      снижая производительность всей системы.</p><p>Какую дополнительную нагрузку мы может выделить в критическом пути
      для избежания высвобождения не той страницы?  Каждый неправильный выбор
      будет стоить нам сотни тысяч тактов работы центрального процессора и
      заметное замедление работы затронутых процессов, так что мы должны
      смириться со значительными издержками для того, чтобы была заведомо
      выбрана правильная страница.  Вот почему FreeBSD превосходит другие
      системы в производительности при нехватке ресурсов памяти.</p><p>Алгоритм определения свободной страницы написан на основе истории
      использования страниц памяти.  Для получения этой истории система
      использует возможности бита использования памяти, которые имеются в
      большинстве аппаратных таблицах страниц памяти.</p><p>В любом случае, бит использования страницы очищается, и в некоторый
      более поздний момент VM-система обращается к странице снова и
      обнаруживает, что этот бит установлен.  Это указывает на то, что страница
      активно используется.  Периодически проверяя этот бит, накапливается
      история использования (в виде счетчика) физической страницы.  Когда позже
      VM-системе требуется высвободить некоторые страницы, проверка истории
      выступает указателем при определении наиболее вероятной кандидатуры для
      повторного использования.</p><div class="sidebar"><div xmlns="" class="titlepage"><div><div><div xmlns="http://www.w3.org/1999/xhtml" class="-title"></div></div></div></div><p>Для тех платформ, что не имеют этой возможности, система эмулирует
        этот бит.  Она снимает отображение или защищает страницу, что приводит
        к ошибке доступа к странице, если к странице выполняется повторное
        обращение.  При возникновении этой ошибки система просто помечает
        страницу как используемую и снимает защиту со страницы, так что она
        может использоваться.  Хотя использование такого приема только для
        определения использования страницы весьма накладно, это выгоднее, чем
        повторно использовать страницу для других целей и обнаружить, что
        она снова нужна процессу и подгружать ее с диска.</p></div><p>FreeBSD использует несколько очередей страниц для обновления выбора
      страниц для повторного использования, а также для определения того, когда
      же грязные страницы должны быть сброшены в хранилище.  Так как таблицы
      страниц во FreeBSD являются динамическими объектами, практически ничего
      не стоит вырезать страницу из адресного пространства любого использующего
      ее процесса.  После того, как подходящая страница, на основе счетчика
      использования, выбрана, именно это и выполняется.  Система должна
      отличать между чистыми страницами, которые теоретически могут быть
      высвобождены в любое время, и грязными страницами, которые сначала должны
      быть переписаны в хранилище перед тем, как их можно будет использовать
      повторно.  После нахождения подходящей страницы она перемещается в
      неактивную очередь, если она является грязной, или в очередь кэша, если
      она чистая.  Отдельный алгоритм, основывающийся на отношении количества
      грязных страниц к чистым, определяет, когда грязные страницы в неактивной
      очереди должны быть сброшены на диск.  Когда это выполнится, сброшенные
      страницы перемещаются из неактивной очереди в очередь кэша.  В этот
      момент страницы в очереди кэша могут быть повторно активизированы VM со
      сравнительно малыми накладными расходами.  Однако страницы в очереди кэша
      предполагается <span class="quote"><<<span class="quote">высвобождать немедленно</span>>></span> и повторно
      использовать в LRU-порядке (меньше всего используемый), когда системе
      потребуется выделение дополнительной памяти.</p><p>Стоит отметить, что во FreeBSD VM-система пытается разделить чистые и
      грязные страницы во избежание срочной необходимости в ненужных сбросах
      грязных страниц (что отражается на пропускной способности ввода/вывода) и
      не перемещает беспричинно страницы между разными очередями, когда
      подсистема управления памятью не испытывает нехватку ресурсов.  Вот
      почему вы можете видеть, что при выполнении команды
      <code class="command">systat -vm</code> в некоторых системах значение счетчика
      очереди кэша мало, а счетчик активной очереди большой.  При повышении
      нагрузки на VM-систему она прилагает большие усилия на поддержку
      различных очередей страниц в соотношениях, которые являются наиболее
      эффективными.</p><p>Годами ходили современные легенды, что Linux выполняет
      работу по предотвращению выгрузки на диск лучше, чем FreeBSD, но это не
      так.  На самом деле FreeBSD старается сбросить на диск неиспользуемые
      страницы для освобождения места под дисковый кэш, когда как Linux хранит
      неиспользуемые страницы в памяти и оставляет под кэш и страницы процессов
      меньше памяти.  Я не знаю, остается ли это правдой на сегодняшний
      день.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="swap-layers.html">Пред.</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="prefault-optimizations.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">3. Уровни области подкачки </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 5. Оптимизация ошибок доступа к страницам и их обнуления</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>