<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>12.13. Изменение ограничений, накладываемых ядром</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="config-tuning.html" title="Глава 12. Настройка и оптимизация" /><link rel="prev" href="configtuning-disk.html" title="12.12. Оптимизация дисков" /><link rel="next" href="adding-swap-space.html" title="12.14. Увеличение объема подкачки" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">12.13. Изменение ограничений, накладываемых ядром</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="configtuning-disk.html">Пред.</a> </td><th width="60%" align="center">Глава 12. Настройка и оптимизация</th><td width="20%" align="right"> <a accesskey="n" href="adding-swap-space.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="configtuning-kernel-limits"></a>12.13. Изменение ограничений, накладываемых ядром</h2></div></div></div><a id="idp87109584" class="indexterm"></a><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="file-process-limits"></a>12.13.1. Ограничения на Файлы/Процессы</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kern-maxfiles"></a>12.13.1.1. <code class="varname">kern.maxfiles</code></h4></div></div></div><a id="idp87112400" class="indexterm"></a><p>Значение <code class="varname">kern.maxfiles</code> может быть увеличено
	  или уменьшено в зависимости от потребностей вашей системы.  Эта
	  переменная определяет максимальное число дескрипторов файлов.  Когда
	  таблица дескрипторов файлов полна, в очереди системных сообщений
	  появится сообщение <span class="errorname">file: table is full</span>. Это
	  сообщение может быть прочитано с помощью команды
	  <code class="command">dmesg</code>.</p><p>Каждый открытый файл, сокет или буфер использует дескриптор
	  файла.  Широкомасштабному серверу может понадобиться много
	  тысяч дескрипторов файлов, в зависимости от количества программ,
	  одновременно выполняемых на сервере.</p><p>Стандартное значение <code class="varname">kern.maxfile</code> определяется
	  переменной <code class="option">maxusers</code> в вашем файле конфигурации
	  ядра.  Значение <code class="varname">kern.maxfiles</code> увеличивается
	  пропорционально значению <code class="option">maxusers</code>.  При
	  компилировании ядра, нужно установить эту переменную согласно
	  потребностям вашей системы.  Исходя из значения этой переменной,
	  ядро устанавливает значения большинства предопределённых
	  переменных.  Даже если предполагается, что к компьютеру не будут
	  одновременно подсоединяться 256 пользователей, требуемые ресурсы
	  могут быть такими же, как у крупномасштабного сервера.</p><p>Система автоматически настроит
	 <code class="literal">maxusers</code>, если вы явно установите его в
	 <code class="literal">0</code><a href="#ftn.idp87126480" class="footnote" id="idp87126480"><sup class="footnote">[5]</sup></a>.
	 Если вы желаете выставить
	 значение самостоятельно, то задайте <code class="literal">maxusers</code> по
	 меньшей мере равным 4, особенно если вы используйте X Window System или
	 компилируйте программное обеспечение.  Причина в том, что самая
	 значимая таблица, устанавливаемая <code class="literal">maxusers</code> -
	 это максимальное количество процессов, которая устанавливается
	 равным <code class="literal">20 + 16 * maxusers</code>, и поэтому, если
	 вы установите <code class="literal">maxusers</code> в 1, то вы сможете
	 иметь только 36 одновременных процессов, включая 18 или около того,
	 что система запустит во время загрузки и 15 или около того, что
	 вы создадите при запуске X Window System.  Даже простая задача, как
	 чтение страницы справочника породит 9 процессов для фильтрации,
	 декомпрессии и её просмотра.  Установка <code class="literal">maxusers</code>
	 в 64 позволит иметь вам до 1044 одновременных процессов, чего
	 должно быть достаточно примерно для всех использований.  Если,
	 тем не менее, вы увидите пугающую ошибку <span class="errortype">proc table
	 full</span> при попытке запуска другой программы, или
	 вы используйте сервер с большим количеством одновременных пользователей
	 (как <code class="systemitem">ftp.FreeBSD.org</code>), то вы всегда
	 можете увеличить значение и пересобрать систему.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml"><code class="literal">maxusers</code> <span class="emphasis"><em>не</em></span>
	   ограничивает количество пользователей, которые могут заходить на
	   вашу машину.  Оно просто устанавливает различные размеры таблиц
	   в разумные значения, учитывая максимальное количество пользователей,
	   вы вероятно будете иметь на вашей системе и как много процессов
	   каждый из них сможет запускать.  Ключевое слово, которое ограничивает
	   количество одновременных удаленных входов и терминальных X окон -
	   это <a class="link" href="kernelconfig-config.html#kernelconfig-ptys"><code class="literal">pseudo-device pty
	   16</code></a>.  С FreeBSD 5.X вам не надо беспокоиться
	   об этом значении, так как <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pty&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pty</span>(4)</span></a> драйвер является
	   <span class="quote"><<<span class="quote">автоматически клонирующим</span>>></span>; вы просто используйте
	   <code class="literal">device pty</code> в вашем конфигурационном файле.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp87134672"></a>12.13.1.2. <code class="varname">kern.ipc.somaxconn</code></h4></div></div></div><a id="idp87135440" class="indexterm"></a><p>Переменная sysctl <code class="varname">kern.ipc.somaxconn</code>
	  ограничивает размер очереди для приема новых TCP соединений.
	  Значение по умолчанию <code class="literal">128</code> слишком мало для
	  надежной обработки новых соединений для нагруженного web
	  сервера.  Для такого сервера рекомендуется увеличить это значение
	  до <code class="literal">1024</code> или выше.  Даемон сервиса может
	  сам ограничивать очередь приема новых соединений (например,
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendmail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sendmail</span>(8)</span></a>, или <span class="application">Apache</span>), но
	  обычно в файле настройки даемона есть директива для настройки
	  длины очереди.  Более длинная очередь также помогает избежать
	  атак Denial of Service (<abbr class="abbrev">DoS</abbr>).</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nmbclusters"></a>12.13.2. Сетевые Ограничения</h3></div></div></div><p>Опция ядра <code class="literal">NMBCLUSTERS</code> обуславливает
	количество Mbuf, доступных на машине.  На сервере с большим трафиком
	и маленьким Mbuf производительность будет пониженной.  Каждый кластер
	представлен двумя килобайтами памяти, поэтому значение 1024 означает
	2 мегабайта памяти ядра, зарезервированной для сетевых буферов.
	Для определения оптимального значения необходимо провести простые
	вычисления.  Если у вас веб сервер, который может обслуживать 1000
	одновременных соединений, и каждое соединение <span class="quote"><<<span class="quote">съедает</span>>></span> 16 K буфера
	приема и 16 K буфера отправки, вам потребуется 32 MB памяти
	под буферы.  Хорошее правило - умножение этого значения на 2,
	2x32 MB / 2 KB = 64 MB / 2 kB = 32768.
	Мы рекомендуем значения между 4096 и 32768 для машин с большим объемом
	памяти.  Не указывайте произвольно большое значение параметра, это
	может привести к падению системы при загрузке.  Используйте
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=netstat&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">netstat</span>(1)</span></a> с опцией <code class="option">-m</code> для определения количества
	используемых сетевых кластеров.</p><p>Для настройки в процессе загрузки используйте в loader переменную
	<code class="varname">kern.ipc.nmbclusters</code>.  Только в старых версиях
	FreeBSD потребуется пересобрать ядро (<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=config&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">config</span>(8)</span></a>) с измененным
	параметром <code class="literal">NMBCLUSTERS</code>.</p><p>Для нагруженных серверов, интенсивно использующих системный
	вызов <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendfile&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">sendfile</span>(2)</span></a>, может потребоваться увеличения буферов
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendfile&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">sendfile</span>(2)</span></a> с помощью параметра конфигурации ядра
	<code class="literal">NSFBUFS</code>, или изменения значения путем установки
	переменной в <code class="filename">/boot/loader.conf</code>
	(обратитесь к <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a> за подробностями).  Общий
	признак того, что параметр требуется изменить -
	состояние процессов <code class="literal">sfbufa</code>.
	Переменная sysctl <code class="varname">kern.ipc.nsfbufs</code>
	установлена только для чтения.  Этот параметр увеличивается
	вместе с <code class="varname">kern.maxusers</code>, хотя может
	потребоваться увеличить его отдельно.</p><div xmlns="" class="important"><h3 class="admontitle">Важно: </h3><p xmlns="http://www.w3.org/1999/xhtml">Даже если сокет помечен как неблокирующий, вызов
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendfile&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">sendfile</span>(2)</span></a> на неблокирующем сокете может вызвать блокирование
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendfile&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">sendfile</span>(2)</span></a>, пока не станет доступным достаточное количество
	  <code class="literal">struct sf_buf</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp87234384"></a>12.13.2.1. <code class="varname">net.inet.ip.portrange.*</code></h4></div></div></div><a id="idp87235152" class="indexterm"></a><p>Переменные sysctl <code class="varname">net.inet.ip.portrange.*</code>
	  контролируют диапазоны номеров портов, автоматически привязываемых
	  к TCP и UDP сокетам.  Есть три диапазона: нижний диапазон,
	  диапазон по умолчанию и верхний диапазон.  Большинство сетевых
	  программ используют диапазон по умолчанию, контролируемый
	  <code class="varname">net.inet.ip.portrange.first</code> и
	  <code class="varname">net.inet.ip.portrange.last</code>, установленными
	  соответственно в 1024 и 5000.  Диапазоны портов привязки
	  используются для исходящих соединений и при некоторых условиях
	  портов может не хватить.  Это чаще всего происходит на
	  сильно загруженном прокси сервере.  Диапазон портов не
	  становится проблемой при работе серверов, которые обрабатывают
	  в основном входящие соединения, или с небольшим количеством
	  исходящих соединений, например mail relay.  Для ситуаций,
	  когда возможен недостаток портов, рекомендуется немного
	  увеличить <code class="varname">net.inet.ip.portrange.last</code>.
	  Может подойти значение <code class="literal">10000</code>,
	  <code class="literal">20000</code>, или <code class="literal">30000</code>.
	  Учтите также возможное влияние брандмауэра при
	  изменении диапазона портов.  Некоторые могут блокировать
	  большие диапазоны портов (обычно с небольшими номерами)
	  и вынуждают использовать более высокие диапазоны для
	  исходящих соединений.  По этой причине не рекомендуется
	  уменьшать значение
	  <code class="varname">net.inet.ip.portrange.first</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp87247824"></a>12.13.2.2. TCP Bandwidth Delay Product</h4></div></div></div><a id="idp87248464" class="indexterm"></a><p>TCP Bandwidth Delay Product Limiting похоже на
	  TCP/Vegas в NetBSD.  Оно может быть
	  включено установкой переменной sysctl
	  <code class="varname">net.inet.tcp.inflight.enable</code> в
	  <code class="literal">1</code>.  Система попытается вычислить задержку
	  пакетов для каждого соединения и ограничить объем данных в
	  очереди сети до значения, требуемого для поддержания оптимальной
	  пропускной способности.</p><p>Эта возможность полезна при передаче данных через модемы,
	  Gigabit Ethernet, или даже через высокоскоростные WAN соединения
	  (или любые другие соединения с большой задержкой передачи),
	  особенно если вы также используете изменение размера окна или
	  настроили большое окно передачи.  Если вы включили этот параметр,
	  убедитесь также, что переменная
	  <code class="varname">net.inet.tcp.inflight.debug</code> установлена в
	  <code class="literal">0</code> (отладка выключена), а для использования в
	  реальных задачах может понадобиться установка переменной
	  <code class="varname">net.inet.tcp.inflight.min</code> к значению
	  как минимум <code class="literal">6144</code>.  Но учтите, что установка
	  большого значения этой переменной может фактически отключить
	  ограничение в зависимости от вида соединения.  Ограничение
	  уменьшает количество данных на определенном маршруте и
	  управляет очередью пакетов, как и уменьшает общее количество
	  данных в очереди локального интерфейса хоста.  С меньшим
	  количеством пакетов в очереди двусторонние интерактивные
	  соединения, особенно на медленных линиях, могут проходить
	  быстрее.  Но имейте ввиду, что эта функция работает только
	  при передаче данных (передача данных / сторона сервера).
	  Она не работает при получении данных (загрузке).</p><p>Изменение значения переменной
	  <code class="varname">net.inet.tcp.inflight.stab</code>
	  <span class="emphasis"><em>не</em></span> рекомендуется.  Этот параметр по умолчанию
	  равен 20, что означает добавление 2 пакетов к вычислению задержки
	  передачи.  Дополнительное окно требуется для стабилизации
	  алгоритма и улучшения ответной реакции на изменение условий,
	  но также приводит к большему времени ping на медленных соединениях
	  (задержка все же гораздо меньше, чем без алгоритма inflight).
	  Вы можете попробовать уменьшить этот параметр до 15, 10 или 5;
	  а также уменьшить <code class="varname">net.inet.tcp.inflight.min</code>
	  (например, до 3500) для получения желаемого эффекта.  Уменьшение
	  значений этих параметров может использоваться только как
	  крайняя мера.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp87258832"></a>12.13.3. Виртуальная память</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp87259472"></a>12.13.3.1. <code class="varname">kern.maxvnodes</code></h4></div></div></div><p>Файлы и каталоги в ядре представлены при помощи vnode
	  (виртуальных узлов).  Увеличение их числа может помочь уменьшить
	  нагрузку на дисковую подсистему.  Как правило, специальной настройки
	  это значение не требует, однако, в некоторых случаях дисковая
	  активность является узким местом, и система исчерпывает таблицу
	  vnode, значение этой переменной следует увеличить.  При этом
	  необходимо оценить объем неактивной и свободной памяти.</p><p>Текущее количество использованных vnode можно посмотреть при
	  помощи команды:</p><pre class="programlisting"><code class="prompt">#</code> sysctl vfs.numvnodes
vfs.numvnodes: 91349</pre><p>Максимальное количество vnode, доступных системе:</p><pre class="programlisting"><code class="prompt">#</code> sysctl kern.maxvnodes
kern.maxvnodes: 100000</pre><p>Если количество использованных vnode близко к максимуму,
	  значение переменной <code class="varname">kern.maxvnodes</code> следует
	  увеличить на 1000.  Следите за динамикой изменения
	  <code class="varname">vfs.numvnodes</code>.  Если оно увеличивается,
	  приближаясь к вновь установленному максимуму, процесс следует
	  повторить.  Изменение в распределении памяти должно быть видно в
	  выводе утилиты <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=top&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">top</span>(1)</span></a>: больше памяти перейдет в разряд
	  активной.</p></div></div><div class="footnotes"><br /><hr class="footnote-hr" /><div id="ftn.idp87126480" class="footnote"><p><a href="#idp87126480" class="para"><sup class="para">[5] </sup></a>Алгоритм автоматической настройки установит
	     <code class="literal">maxusers</code> равным количеству памяти в системе,
	     где минимум 32, а максимум 384.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="configtuning-disk.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="config-tuning.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="adding-swap-space.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">12.12. Оптимизация дисков </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 12.14. Увеличение объема подкачки</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>