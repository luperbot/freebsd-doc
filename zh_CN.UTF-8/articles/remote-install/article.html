<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>FreeBSD 操作系统在无远程控制台下的远程安装</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><meta name="description" content="本文归档了当远程控制台不可用的情况下 FreeBSD 操作系统的远程安装。 文章背后的主要灵感归功于和 Martin Matuska 还有由 Pawel Jakub Dawidek 提供的宝贵输入合作的结果。" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div xml:lang="zh_cn" class="article" lang="zh_cn"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61167440"></a>FreeBSD 操作系统在无远程控制台下的远程安装</h1></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="author"><h3 class="author"><span class="firstname">Daniel</span> <span class="surname">Gerzo</span></h3><div class="affiliation"><div class="address"><p><code class="email">&lt;<a xmlns="" class="email" href="mailto:danger@FreeBSD.org">danger@FreeBSD.org</a>&gt;</code></p></div></div></div></div><div>修订: <a href="https://svnweb.freebsd.org/changeset/doc/"><span class="svnref"></span></a></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">版权 © 2008 The FreeBSD Documentation Project</p></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="trademarks"></a><p>FreeBSD 是 FreeBSD 基金会的注册商标</p><p>许多制造商和经销商使用一些称为商标的图案或文字设计来彰显自己的产品。
  本文档中出现的， 为 FreeBSD Project 所知晓的商标，后面将以 <span class="quote">“<span class="quote">™</span>”</span> 或
  <span class="quote">“<span class="quote">®</span>”</span> 符号来标注。</p></div></div><div>   由 .</div><div><div xmlns="http://www.w3.org/1999/xhtml" class="abstract"><div class="abstract-title">摘要</div><p>本文归档了当远程控制台不可用的情况下 FreeBSD 操作系统的远程安装。
        文章背后的主要灵感归功于和 Martin Matuska 还有由 Pawel Jakub Dawidek
        提供的宝贵输入合作的结果。</p></div></div></div><hr /></div><div class="toc"><div class="toc-title">目录</div><dl class="toc"><dt><span class="sect1"><a href="#background">1. 背景</a></span></dt><dt><span class="sect1"><a href="#intro">2. 简介</a></span></dt><dt><span class="sect1"><a href="#preparation">3. 准备工作 - <span class="application">mfsBSD</span></a></span></dt><dt><span class="sect1"><a href="#installation">4. FreeBSD 操作系统的安装</a></span></dt><dt><span class="sect1"><a href="#zfs">5. ZFS</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="background"></a>1. 背景</h2></div></div></div><p>世界上有很多的服务器主机供应商，
      但是他们中只有很少的一部分正式支持 FreeBSD，
      他们通常为他们提供的服务器上安装 <span class="trademark">Linux</span>®
      发行版提供支持。</p><p>在某些情况下，如果你请求这些公司他们会安装一个你首选的 <span class="trademark">Linux</span>®
      发行版。有了这个选择，我们将试图安装 FreeBSD。
      在其他情况下，他们可能提供一个急救系统用于紧急情况。
      使用这个可能将有利于我们的目的更好的实现。</p><p>本文涵盖了引导一个包含 RAID-1 及 <span class="application">ZFS</span>
      性能的 FreeBSD 系统的远程安装的基本安装配置所必须的步骤。</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="intro"></a>2. 简介</h2></div></div></div><p>这一节会摘要本文的目的以及更好阐述这里所概括的东西。
      本文中的这些指令将有益于那些使用不支持 FreeBSD
      的托管设施提供的服务的人。</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>如我们提到过的 <a class="link" href="#background" title="1. 背景">背景</a>
          的那一节，许多的有声望的服务器主机托管公司提供了各种的急救系统。
          可以从他们自己的 <acronym class="acronym">局域网</acronym> 启动并可以通过
          <span class="application">SSH</span> 访问。
          他们通常提供这种支持目的用于帮助他们的顾客修正损坏的操作系统。
          如文章将说明的，我们将能够通过这些急救系统的帮助来安装 FreeBSD。</p></li><li class="step"><p>文章的下一小节会描述如何配置，并在本地机器上构建最小限度的
          FreeBSD。该版本最终会从随机存储盘运行到远程机器上面去。
          这将允许我们使用 <span class="application">sysinstall</span>
          实用程序从一个 <acronym class="acronym">FTP</acronym>
          镜像安装一套完整的 FreeBSD 操作系统。</p></li><li class="step"><p>文章的剩余内容除了描述 <span class="application">ZFS</span>
          文件系统的配置还将描述系统本身的安装步骤。</p></li></ol></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="requirements"></a>2.1. 需求</h3></div></div></div><p>想要成功地做下去，你必须：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>拥有一个可通过 <span class="application">SSH</span>
            网络访问的操作系统。</p></li><li class="listitem"><p>理解 FreeBSD 的安装过程</p></li><li class="listitem"><p>熟悉 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sysinstall&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sysinstall</span>(8)</span></a> 实用程序</p></li><li class="listitem"><p>拥有 FreeBSD 安张的 <acronym class="acronym">ISO</acronym>
            镜像文件或者易于使用的 <acronym class="acronym">CD</acronym></p></li></ul></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="preparation"></a>3. 准备工作 - <span class="application">mfsBSD</span></h2></div></div></div><p>在 FreeBSD 可能安装到目标系统上之前，
      需要先构建一个最小化的从磁盘启动的 FreeBSD 操作系统映像文件。
      此方法中新系统必须能够从网络访问，
      并且安装的其他过程能够在没有远程访问到系统控制台的情况下完成。</p><p><span class="application">mfsBSD</span> 设置工具能够被用来构建一个微小的
      FreeBSD 映像。如 <span class="application">mfsBSD</span> 名字的含义
      (<span class="quote">“<span class="quote">mfs</span>”</span> 的意思是 <span class="quote">“<span class="quote">memory file system</span>”</span> 内存文件系统)，
      最后的映像全部从随机存储器运行。多亏了这个特性，
      磁盘的操作将不会有任何限制，因此它能够被用来安装一个完整的 FreeBSD 操作系统。
      <span class="application">mfsBSD</span> 的主页在
      <code class="uri"><a class="uri" href="http://people.freebsd.org/~mm/mfsbsd/" target="_top">http://people.freebsd.org/~mm/mfsbsd/</a></code>，
      包含了指向最新释出的设置工具。</p><p>请注意关于 <span class="application">mfsBSD</span>
      内幕以及它所有的适用都超出了本文的内容，
      感兴趣的读者应该去查阅 <span class="application">mfs</span>
      的原始文档得到更多详细内容。</p><p>下载并解压出最新的 <span class="application">mfsBSD</span>
      版本，并改变自己的当前工作目录到存在 <span class="application">mfsBSD</span>
      脚本文件的目录：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fetch http://people.freebsd.org/~mm/mfsbsd/mfsbsd-latest.tar.gz</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>tar xvzf mfsbsd-1.0-beta1.tar.gz</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd mfsbsd-1.0-beta1/</code></strong></pre><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="mfsbsd-config"></a>3.1. <span class="application">mfsBSD</span> 的配置</h3></div></div></div><p>引导 <span class="application">mfsBSD</span> 之前，
        必须设置一些重要的配置选项。
        最重要的是我们必须有正确地，自然地，网络配置。
        最适合的方法配置网络选项取决于我们是否事先知道我们会用到的网络接口，
        而且网络接口驱动程序应被系统为我们的硬件载入。
        我们将看到 <span class="application">mfsBSD</span>
        如何能够在任一种情况下被配置。</p><p>另外一件重要的事情是设置 <code class="systemitem">root</code> 的密码。
        这将通过编辑 <code class="filename">conf/rootpw.conf</code> 文件来完成。
        请记住该文件将把你的密码保存在简单的文本中，
        所以在此我们不推荐你使用真实的密码。然而，
        这只是一个临时使用一次的密码，你可以在随后安装好的系统中更改它。</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61641552"></a>3.1.1. 编辑 <code class="filename">conf/interfaces.conf</code> 的方法</h4></div></div></div><p>如果我们安装好的网卡是未知类型的，
          我们可以使用 <span class="application">mfsBSD</span> 的自动探测功能。
          <span class="application">mfsBSD</span> 启动脚本能够探测到正确的驱动来使用，
          基于网络接口的 MAC 地址，我们假设在
          <code class="filename">conf/interfaces.conf</code> 文件中设置如下选项：</p><pre class="programlisting">initconf_interfaces="ext1"
initconf_mac_ext1="00:00:00:00:00:00"
initconf_ip_ext1="192.168.0.2"
initconf_netmask_ext1="255.255.255.0"</pre><p>别忘了添加 <code class="literal">defaultrouter</code>
          信息到 <code class="filename">conf/rc.conf</code> 文件中：</p><pre class="programlisting">defaultrouter="192.168.0.1"</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61654608"></a>3.1.2. 编辑 <code class="filename">conf/rc.conf</code> 的方法</h4></div></div></div><p>当网络接口的驱动是已知类型的，使用
          <code class="filename">conf/rc.conf</code> 文件添加联网选项会更加方便。
          该文件的语法跟 FreeBSD 中标准的 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> 文件的语法相同。</p><p>例如，当你知道被使用的将是一个 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=re&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">re</span>(4)</span></a> 网络接口设备，
          你可以在 <code class="filename">conf/rc.conf</code> 文件中设置如下选项：</p><pre class="programlisting">defaultrouter="192.168.0.1"
ifconfig_re0="inet 192.168.0.2 netmask 255.255.255.0"</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="mfsbsd-build"></a>3.2. 构建一个 <span class="application">mfsBSD</span> 映像</h3></div></div></div><p>构建一个 <span class="application">mfsBSD</span>
        映像文件的过程是非常简单明了的。</p><p>第一步是挂载 FreeBSD 的安装 <acronym class="acronym">CD</acronym>，
        或者挂载安装 <acronym class="acronym">ISO</acronym> 文件到
        <code class="filename">/cdrom</code>。
        因为例子的缘故，在文章中我们将假定你下载的是 FreeBSD 7.0-RELEASE
        <acronym class="acronym">ISO</acronym> 文件。使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mdconfig</span>(8)</span></a>
        实用程序挂载 <acronym class="acronym">ISO</acronym> 映像文件到
        <code class="filename">/cdrom</code> 目录非常简单：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mdconfig -a -t vnode -u 10 -f 7.0-RELEASE-amd64-disc1.iso</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount_cd9660 /dev/md10 /cdrom</code></strong></pre><p>紧接着，构建可启动的 <span class="application">mfsBSD</span>
        映像：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make BASE=/cdrom/7.0-RELEASE</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">上面的 <code class="command">make</code> 命令必须在
          <span class="application">mfsBSD</span> 目录树的最高一层运行，也就是：
          <code class="filename">~/mfsbsd-1.0-beta1/</code>。</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61718352"></a>3.3. 启动 <span class="application">mfsBSD </span></h3></div></div></div><p>现在 <span class="application">mfsBSD</span> 映像已经准备好了，
        必须把它上传到远程的一个正在运行的急救系统上或者一个预安装了
        <span class="trademark">Linux</span>® 发行版的系统上。最适合做这个工作的工具是
        <span class="application">scp</span>：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>scp disk.img root@192.168.0.2:.</code></strong></pre><p>想要正确的引导 <span class="application">mfsBSD</span> 映像，
        必须把它安放在机器的第一块（可启动）设备上。
        这可能会和使用的例子我们假定的一样，第一块可启动磁盘设备是
        <code class="filename">sda</code>：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dd if=/root/disk.img of=/dev/sda bs=1m</code></strong></pre><p>如果一切正常，该映像现在应该存在于第一块设备的
        <acronym class="acronym">MBR</acronym>（主引导区）而机器也应该能够被启动了。
        使用工具 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ping&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ping</span>(8)</span></a> 来查看机器是否被正确启动。
        一旦它回复在线状态，就应该能够使用 <code class="systemitem">root</code>
        用户和配置好的密码通过 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a> 来访问它了。</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="installation"></a>4. FreeBSD 操作系统的安装</h2></div></div></div><p><span class="application">mfsBSD</span> 成功被引导后它就应该能够通过
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a> 登入了。这一节会描述如何创建 slices 并标记 slices 的 label，
      为 RAID-1 配置 <span class="application">gmirror</span>，
      还有如何使用 <span class="application">sysinstall</span>
      来安装一个最小的FreeBSD操作系统版本。</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61762256"></a>4.1. 准备磁盘</h3></div></div></div><p>首要的任务是为 FreeBSD 分配磁盘空间，也就是，
        创建 slices 和 partitions。很显然，
        当前运行的系统是全部被载入到系统内存中的因此操作磁盘将没有任何问题。
        要完成这个任务，可以是使用 <span class="application">sysinstall</span>
        或者 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fdisk&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fdisk</span>(8)</span></a> 中的二者任一并结合工具 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a>。</p><p>在开始时，将所有磁盘都标记成空的，
        在每个磁盘上重复如下命令：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dd if=/dev/zero of=/dev/ad0 count=2</code></strong></pre><p>下面，使用你喜欢的工具创建 slices 并标记磁盘 label。
        比较简单的方法是使用 <span class="application">sysinstall</span>，
        强大也可能几乎没有漏洞方法是使用标准的基于文本的 <span class="trademark">UNIX</span>® 工具，
        类似于 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fdisk&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fdisk</span>(8)</span></a> 和 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a>
        这些工具的使用也会在这一节中包括。前者已经被包括在 FreeBSD 手册的
        <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/install-steps.html" target="_top">安装FreeBSD</a>
        一章中了。如本节中刚提到的，这篇文章会展示如何设置一个带有 RAID-1
        和 <span class="application">ZFS</span> 性能的系统。我们的设置由一个小工具
        <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a> 镜像为 <code class="filename">/</code> (root)，
        <code class="filename">/usr</code> 和
        <code class="filename">/var</code> 文件系统，
        并把剩余的磁盘空间被分配为 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=zpool&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">zpool</span>(8)</span></a> 镜像出的
        <span class="application">ZFS</span> 文件系统。请注意，
        <span class="application">ZFS</span> 文件系统将在 FreeBSD
        操作系统成功安装并启动后才会被配置。</p><p>下面的例子会描述如何去创建 slices 和 labels，
        在每个 partition 上初始化 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a>
        并如何在每个被镜像过的 partition 上创建
        <span class="application">UFS2</span> 文件系统：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fdisk -BI /dev/ad0</code></strong> <a id="fdisk"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>fdisk -BI /dev/ad1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>bsdlabel -wB /dev/ad0s1</code></strong> <a id="bsdlabel-writing"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>bsdlabel -wB /dev/ad1s1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>bsdlabel -e /dev/ad0s1</code></strong> <a id="bsdlabel-editing"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>bsdlabel /dev/ad0s1 &gt; /tmp/bsdlabel.txt &amp;&amp; bsdlabel -R /dev/ad1s1 /tmp/bsdlabel.txt</code></strong> <a id="bsdlabel-restore"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>gmirror label root /dev/ad[01]s1a</code></strong> <a id="gmirror1"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>gmirror label var /dev/ad[01]s1d</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gmirror label usr /dev/ad[01]s1e</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gmirror label -F swap /dev/ad[01]s1b</code></strong> <a id="gmirror2"></a><span><img src="./imagelib/callouts/6.png" alt="6" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>newfs /dev/mirror/root</code></strong> <a id="newfs"></a><span><img src="./imagelib/callouts/7.png" alt="7" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>newfs /dev/mirror/var</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs /dev/mirror/usr</code></strong></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#fdisk"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>在整个磁盘上创建一个 slice
            并初始化包含在磁盘第一个扇区启动代码。
            重复在系统上全部的磁盘上执行此命令。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#bsdlabel-writing"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>为每块磁盘写入一个包括启动代码的内容的标准
            label。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#bsdlabel-editing"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>现在，手动去编辑磁盘的 label。可以查阅 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a>
            的联机手册来找到如何建立 partitions 的方法。创建如下
            partions，<code class="literal">a</code> 为
            <code class="filename">/</code> (root) 文件系统，
            <code class="literal">b</code> 为 swap 交换空间，
            <code class="literal">d</code> 为
            <code class="filename">/usr</code>
            还有最后 <code class="literal">f</code> 被用于
            <span class="application">ZFS</span>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#bsdlabel-restore"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>引入你刚才创建的 label 到第二块磁盘，
            所以两块磁盘会使用同样的 label。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#gmirror1"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> </p></td><td valign="top" align="left"><p>在每个 partition 上初始化 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#gmirror2"><span><img src="./imagelib/callouts/6.png" alt="6" border="0" /></span></a> </p></td><td valign="top" align="left"><p>注意 <code class="option">-F</code> 选项被用在 swap
            交换分区的 partition。 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a>
            这个指令认为设备处于可靠的状态除非电源系统故障。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#newfs"><span><img src="./imagelib/callouts/7.png" alt="7" border="0" /></span></a> </p></td><td valign="top" align="left"><p>在每个被镜像的分区上创建一个
            <span class="application">UFS2</span> 的文件系统。</p></td></tr></table></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61904464"></a>4.2. 系统安装</h3></div></div></div><p>这是最重要的一部分。
        此节将描述如何在我们上一小节已经准备好的磁盘上安装一个最小的
        FreeBSD 版本。要达成这个目的，所有的文件安系统需要被挂载乃至于
        <span class="application">sysinstall</span> 可以把 FreeBSD
        系统的内容写到磁盘上：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/root /mnt</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mkdir /mnt/var /mnt/usr</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/var /mnt/var</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/usr /mnt/usr</code></strong></pre><p>当你做完这些时，打开 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sysinstall&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sysinstall</span>(8)</span></a>。
        从主菜单选择自定义 <span class="guimenuitem">Custom</span> 安装。
        选中 <span class="guimenuitem">Options</span> 选项然后按回车确认。
        使用方向键获取帮助，移动鼠标指针到 <code class="literal">Install Root</code>
        选项，按 <span class="keycap"><strong>空格</strong></span> 更改为
        <code class="filename">/mnt</code>。
        按 <span class="keycap"><strong>回车</strong></span> 提交你的更改并使用
        <span class="keycap"><strong>q</strong></span> 退出 <span class="guimenuitem">Options</span>
        （选项）菜单。</p><div xmlns="" class="warning"><h3 class="admontitle">警告: </h3><p xmlns="http://www.w3.org/1999/xhtml">注意这一步骤非常重要，如果被跳过了，
          <span class="application">sysinstall</span>
          将不能安装 FreeBSD。</p></div><p>到 <span class="guimenuitem">Distributions</span>（发行版）菜单选项，
            使用方向键移动鼠标指针到 <code class="option">Minimal</code>（最小化）选项，
            并使用 <span class="keycap"><strong>空格键</strong></span> 选中该选项。
            本文使用了最小版本来保存网络联通信息，因为系统本身会通过
            <span class="application">ftp</span> 来安装。使用
            <code class="option">Exit</code>（退出）选项退出这个菜单。</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml"><span class="guimenuitem">Partition</span> 和
          <span class="guimenuitem">Label</span> 菜单将被跳过，
          这些没有多少价值了。</p></div><p><span class="guimenuitem">Media</span>（媒介）菜单，
        选择 <code class="option">FTP</code> 选项。
        选择一个距离你最近的镜像站点并交给
        <span class="application">sysinstall</span>
        假定网络已经配置完好。你将再回到
        <span class="guimenuitem">Custom</span>
        （自定义）菜单。</p><p>最后，选择最后的选项来执行系统的安装过程，
        <span class="guimenuitem">Commit</span>，
        当安装完成后退出 <span class="application">sysinstall</span>
        即可。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61953232"></a>4.3. 后期安装步骤</h3></div></div></div><p>FreeBSD 操作系统现在应该安装完毕了；通常情况下，
        安装过程还没有结束。还需要进行一些安装后期的步骤使得容许
        FreeBSD 在将来启动并能够登入系统。</p><p>你现在必须 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=chroot&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">chroot</span>(8)</span></a>
        到刚安装的全新的系统中来完成安装。
        使用如下命令： </p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chroot /mnt</code></strong></pre><p>要达到我们的目的，进行如下步骤：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>拷贝 <code class="literal">GENERIC</code>（通用）内核到
            <code class="filename">/boot/kernel</code>
            目录：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp -Rp /boot/GENERIC/* /boot/kernel</code></strong></pre></li><li class="listitem"><p>创建 <code class="filename">/etc/rc.conf</code>，
            <code class="filename">/etc/resolv.conf</code> 还有
            <code class="filename">/etc/fstab</code> 文件。
            不要忘记正确地设置网络信息并在
            <code class="filename">/etc/rc.conf</code>
            文件中启用 <span class="application">sshd</span>。
            <code class="filename">/etc/fstab</code>
            文件内容类似于下面的内容：</p><pre class="programlisting"># Device                Mountpoint      FStype  Options         Dump    Pass#
/dev/mirror/swap        none            swap    sw              0       0
/dev/mirror/root        /               ufs     rw              1       1
/dev/mirror/usr         /usr            ufs     rw              2       2
/dev/mirror/var         /var            ufs     rw              2       2
/dev/cd0                /cdrom          cd9660  ro,noauto       0       0</pre></li><li class="listitem"><p>创建 <code class="filename">/boot/loader.conf</code>
            文件，并写入如下内容：</p><pre class="programlisting">geom_mirror_load="YES"
zfs_load="YES"</pre></li><li class="listitem"><p>执行下面的命令，使得
            <span class="application">ZFS</span> 在下次启动后可用：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>echo 'zfs_enable="YES"' &gt;&gt; /etc/rc.conf </code></strong></pre></li><li class="listitem"><p>可以用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=adduser&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">adduser</span>(8)</span></a> 工具来添加额外的用户。
            不要忘记添加一个用户到 <code class="systemitem">wheel</code>
            组，这样你可以在重新启动后获得 root 权限。</p></li><li class="listitem"><p>反复检验你的设置是否正确。</p></li></ul></div><p>现在你的系统在下次启动后应该可用了。使用
        <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=reboot&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">reboot</span>(8)</span></a> 命令重新启动你的系统。</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="zfs"></a>5. ZFS</h2></div></div></div><p>如果你的系统重新启动后还完好，现在应该能够登入了。
      欢迎来到崭新的 FreeBSD 安装，进行远程的不使用远程控制台的安装。</p><p>最后还剩下的步骤是配置 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=zpool&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">zpool</span>(8)</span></a> 并创建一些
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=zfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">zfs</span>(8)</span></a> 文件系统。建立并管理
      <span class="application">ZFS</span> 非常简单。
      首先，创建一个镜像的pool：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>zpool create tank mirror /dev/ad[01]s1f</code></strong></pre><p>再接着,创建一些文件系统：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>zfs create tank/ports</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>zfs create tank/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>zfs set compression=gzip tank/ports</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>zfs set compression=on tank/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>zfs set mountpoint=/usr/ports tank/ports</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>zfs set mountpoint=/usr/src tank/src</code></strong></pre><p>这就是全部步骤了。如果你对 FreeBSD 上的
      <span class="application">ZFS</span> 感兴趣，请查阅 FreeBSD  WIKI 中的
      <a class="link" href="http://wiki.freebsd.org/ZFS" target="_top">ZFS</a> 一节。</p></div></div></body></html>