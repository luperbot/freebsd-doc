<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>31.8. Met PXE en een NFS-root-bestandssysteem opstarten</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD handboek" /><link rel="up" href="advanced-networking.html" title="Hoofdstuk 31. Geavanceerde netwerken" /><link rel="prev" href="network-diskless.html" title="31.7. Schijfloos werken" /><link rel="next" href="network-isdn.html" title="31.9. ISDN" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">31.8. Met PXE en een NFS-root-bestandssysteem opstarten</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="network-diskless.html">Terug</a> </td><th width="60%" align="center">Hoofdstuk 31. Geavanceerde netwerken</th><td width="20%" align="right"> <a accesskey="n" href="network-isdn.html">Volgende</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="network-pxe-nfs"></a>31.8. Met PXE en een NFS-root-bestandssysteem opstarten</h2></div><div><span class="authorgroup">Geschreven door <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Craig</span> <span class="surname">Rodrigues</span></span>. </span></div></div></div><p>Het Preboot eXecution Environment (<acronym class="acronym">PXE</acronym>) van <span class="trademark">Intel</span>®
      maakt het mogelijk om het besturingssysteem over het netwerk op te
      starten.  Ondersteuning voor <acronym class="acronym">PXE</acronym> wordt normaliter
      aangeboden in het <acronym class="acronym">BIOS</acronym> van moderne moederborden, waar
      het kan worden aangezet in de instellingen van het <acronym class="acronym">BIOS</acronym>
      wat opstarten over het netwerk mogelijk maakt.  Een volledig werkende
      <acronym class="acronym">PXE</acronym>-opstelling vereist ook correct geconfigureerde
      <acronym class="acronym">DHCP</acronym>- en <acronym class="acronym">TFTP</acronym>-servers.</p><p>Wanneer de gastheercomputer opstart, krijgt het informatie over
      <acronym class="acronym">DHCP</acronym> over waar de intiële bootloader staat via
      TFTP.  Nadat de gastheercomputer deze informatie heeft ontvangen,
      downloadt het de bootloader via <acronym class="acronym">TFTP</acronym> en voert
      het vervolgens de bootloader uit.  Dit is gedocumenteerd in sectie 2.2.1
      van de <a class="link" href="http://download.intel.com/design/archives/wfm/downloads/pxespec.pdf" target="_top">Preboot
	Execution Environment (PXE) Specification</a>.  In FreeBSD is de
      bootloader die tijdens het <acronym class="acronym">PXE</acronym>-proces wordt opgehaald
      <code class="filename">/boot/pxeboot</code>.  Terwijl
      <code class="filename">/boot/pxeboot</code> wordt uitgevoerd, wordt de kernel van
      FreeBSD geladen en wordt er verder gegaan met de rest van de opstartprocedure
      van FreeBSD.  Kijk voor meer informatie over het opstartproces van FreeBSD in
      <a class="xref" href="boot.html" title="Hoofdstuk 13. Het FreeBSD opstartproces">Hoofdstuk 13, <em>Het FreeBSD opstartproces</em></a>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90215888"></a>31.8.1. De <code class="command">chroot</code>-omgeving voor het
	NFS-root-bestandssysteem instellen</h3></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Kies een map uit voor een installatie van FreeBSD die over NFS
	    aangekoppeld kan worden.  Bijvoorbeeld een map als <code class="filename">/b/tftpboot/FreeBSD/install</code>.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>export NFSROOTDIR=/b/tftpboot/FreeBSD/install</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mkdir -p ${NFSROOTDIR}</code></strong></pre></li><li class="step"><p>Stel de NFS-server in door de instructies in <a class="xref" href="network-nfs.html#network-configuring-nfs" title="29.3.2. NFS instellen">Paragraaf 29.3.2, &#8220;<acronym class="acronym">NFS</acronym> instellen&#8221;</a> op te volgen.</p></li><li class="step"><p>Exporteer de map via NFS door het volgende aan
	    <code class="filename">/etc/exports</code> toe te voegen:</p><pre class="programlisting">/b -ro -alldirs</pre></li><li class="step"><p>Herstart de NFS-server:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>service nfsd restart</code></strong></pre></li><li class="step"><p>Stel <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=inetd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">inetd</span>(8)</span></a> in door de stappen zoals in <a class="xref" href="network-inetd.html#network-inetd-settings" title="29.2.2. Instellingen">Paragraaf 29.2.2, &#8220;Instellingen&#8221;</a> beschreven op te volgen.</p></li><li class="step"><p>Voeg de volgende regel toe aan
	    <code class="filename">/etc/inetd.conf</code>:</p><pre class="programlisting">tftp dgram udp wait root /usr/libexec/tftpd tftpd -l -s /b/tftpboot</pre></li><li class="step"><p>Herstart inetd:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>service inetd restart</code></strong></pre></li><li class="step"><p><a class="link" href="makeworld.html" title="24.7. De &#8220;wereld&#8221; opnieuw bouwen">Herbouw de kernel en userland van
	      FreeBSD</a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make buildworld</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make buildkernel</code></strong></pre></li><li class="step"><p>Installeer FreeBSD in de map die over <acronym class="acronym">NFS</acronym> is
	    aangekoppeld:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make installworld DESTDIR=${NFSROOTDIR}</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make installkernel DESTDIR=${NFSROOTDIR}</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make distribution DESTDIR=${NFSROOTDIR}</code></strong></pre></li><li class="step"><p>Test dat de <acronym class="acronym">TFTP</acronym>-server werkt en dat het de
	    bootloader dat via PXE verkregen zal worden kan downloaden:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>tftp localhost</code></strong>
tftp&gt; <strong class="userinput"><code>get FreeBSD/install/boot/pxeboot</code></strong>
Received 264951 bytes in 0.1 seconds</pre></li><li class="step"><p>Voeg een regel aan <code class="filename">${NFSROOTDIR}/etc/fstab</code>
	    toe om het root-bestandssysteem over NFS aan te koppelen:</p><pre class="programlisting"># Device                                            Mountpoint    FSType   Options  Dump Pass
mijnhost.example.com:/b/tftpboot/FreeBSD/install      /         nfs      ro        0    0</pre><p>Vervang <em class="replaceable"><code>mijnhost.example.com</code></em> door
	    de hostnaam of het IP-adres van uw <acronym class="acronym">NFS</acronym>-server.
	    In dit voorbeeld wordt het root-bestandssysteem als alleen-lezen
	    aangekoppeld om te voorkomen dat
	    <acronym class="acronym">NFS</acronym>-cliënten per ongeluk de inhoud van het
	    root-bestandssysteem wissen.</p></li><li class="step"><p>Stel het root-wachtwoord in voor de
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=chroot&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">chroot</span>(8)</span></a>-omgeving.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chroot ${NFSROOTDIR}</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>passwd</code></strong></pre><p>Dit stelt het root-wachtwoord in voor cliëntmachines die
	    over <acronym class="acronym">PXE</acronym> opstarten.</p></li><li class="step"><p>Maak root-logins over SSH mogelijk voor cliëntmachines die
	    met <acronym class="acronym">PXE</acronym> opstarten door
	    <code class="filename">${NFSROOTDIR}/etc/ssh/sshd_config</code> te bewerken
	    en de optie <code class="literal">PermitRootLogin</code> aan te zetten.  Dit
	    is gedocumenteerd in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd_config&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">sshd_config</span>(5)</span></a>.</p></li><li class="step"><p>Pas andere wijzigingen toe aan de <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=chroot&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">chroot</span>(8)</span></a>-omgeving in
	    ${NFSROOTDIR}.  Deze wijzigingen zouden het toevoegen van pakketten
	    met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pkg_add&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">pkg_add</span>(1)</span></a>, het bewerken van het wachtwoordbestand met
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=vipw&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">vipw</span>(8)</span></a> of het bewerken van <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=amd.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">amd.conf</span>(5)</span></a>-projecties voor
	    automatisch aankoppelen kunnen zijn.  Bijvoorbeeld:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chroot ${NFSROOTDIR}</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>pkg_add -r bash</code></strong></pre></li></ol></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90267728"></a>31.8.2. Geheugenbestandssystemen die gebruikt worden door
	<code class="filename">/etc/rc.initdiskless</code> configureren</h3></div></div></div><p>Als u vanaf een NFS-rootvolume opstart, detecteert
	<code class="filename">/etc/rc</code> dat u over NFS opstartte en draait het het
	script <code class="filename">/etc/rc.initdiskless</code>.  Lees het commentaar
	in dit script om te begrijpen wat er gebeurt.  Het is nodig om
	<code class="filename">/etc</code> en <code class="filename">/var</code> geheugen-backed
	te maken omdat deze mappen schrijfbaar moeten zijn, maar de NFS-rootmap
	is alleen-lezen.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chroot ${NFSROOTDIR}</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mkdir -p conf/base</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>tar -c -v -f conf/base/etc.cpio.gz --format cpio --gzip etc</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>tar -c -v -f conf/base/var.cpio.gz --format cpio --gzip var</code></strong></pre><p>Wanneer het systeem opstart, zullen er geheugen-bestandssystemen
	voor <code class="filename">/etc</code> en <code class="filename">/var</code> worden aangemaakt en aangekoppeld,
	en zal de inhoud van de <code class="filename">cpio.gz</code>-bestanden er
	naartoe worden gekopieerd.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="network-pxe-setting-up-dhcp"></a>31.8.3. Een DHCP-server prepareren</h3></div></div></div><p>PXE heeft een geprepareerde <acronym class="acronym">TFTP</acronym>-server en
	<acronym class="acronym">DHCP</acronym>-server nodig.  De <acronym class="acronym">DHCP</acronym>-server
	hoeft niet per së dezelfde machine te zijn als de
	<acronym class="acronym">TFTP</acronym>-server, maar het dient bereikbaar te zijn in uw
	netwerk.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Installeer de <acronym class="acronym">DHCP</acronym>-server door de instructies
	    op te volgen zoals beschreven in <a class="xref" href="network-dhcp.html#network-dhcp-server" title="29.5.7. Een DHCP-server installeren en instellen">Paragraaf 29.5.7, &#8220;Een DHCP-server installeren en instellen&#8221;</a>.  Zorg ervoor dat
	    <code class="filename">/etc/rc.conf</code> en
	    <code class="filename">/usr/local/etc/dhcpd.conf</code> correct zijn
	    geconfigureerd.</p></li><li class="step"><p>Stel in <code class="filename">/usr/local/etc/dhcpd.conf</code>
	    <code class="literal">next-server</code>, <code class="literal">filename</code> en
	    <code class="literal">option root-path</code> in om het IP-adres van uw
	    <acronym class="acronym">TFTP</acronym>-server, het pad naar
	    <code class="filename">/boot/pxeboot</code> en het pad naar het
	    <acronym class="acronym">NFS</acronym>-root-bestandssysteem op te geven.  Hier is
	    een voorbeeld van de instellingen voor
	    <code class="filename">dhcpd.conf</code>:</p><pre class="programlisting">subnet 192.168.0.0 netmask 255.255.255.0 {
   range 192.168.0.2 192.168.0.3 ;
   option subnet-mask 255.255.255.0 ;
   option routers 192.168.0.1 ;
   option broadcast-address 192.168.0.255 ;
   option domain-name-server 192.168.35.35, 192.168.35.36 ;
   option domain-name "example.com";

   # IP-adres van TFTP server
   next-server 192.168.0.1 ;

   # pad van bootloader verkregen via TFTP
   filename "FreeBSD/install/boot/pxeboot" ;

   # pxeboot bootloader zal proberen om deze map te NFS-mounten voor root-FS
   option root-path "192.168.0.1:/b/tftpboot/FreeBSD/install/" ;
}</pre></li></ol></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90298064"></a>31.8.4. De PXE-cliënt configureren en verbindingsproblemen
	opsporen</h3></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Ga naar het <acronym class="acronym">BIOS</acronym>-configuratiemenu wanneer de
	    cliëntmachine opstart.  Stel het <acronym class="acronym">BIOS</acronym> zo in
	    dat het van het netwerk opstart.  Indien alle vorige
	    configuratiestappen correct zijn, zou alles "gewoon"
	    moeten werken.</p></li><li class="step"><p>Gebruik de poort <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/net/wireshark/pkg-descr">net/wireshark</a> om netwerkverkeer met
	    betrekking tot het <acronym class="acronym">PXE</acronym>-opstartproces te
	    debuggen, wat geïllustreerd is in onderstaand diagram.  In
	    <a class="xref" href="network-pxe-nfs.html#network-pxe-setting-up-dhcp" title="31.8.3. Een DHCP-server prepareren">Paragraaf 31.8.3, &#8220;Een DHCP-server prepareren&#8221;</a> is een
	    voorbeeldconfiguratie gegeven waarbij de <acronym class="acronym">DHCP</acronym>-,
	    <acronym class="acronym">TFTP</acronym>- en <acronym class="acronym">NFS</acronym>-servers op
	    dezelfde machine staan.  Deze servers kunnen echter op verschillende
	    machines staan.</p><div class="figure"><a id="idp90303568"></a><div class="figure-title">Afbeelding 31.1. PXE-opstartproces met NFS-root-mount</div><div class="figure-contents"><div class="mediaobject"><img border="0" usemap="#idp90304720" src="advanced-networking/pxe-nfs.png" alt="PXE-opstartproces met NFS-root-mount" /><map name="idp90304720" id="idp90304720"><area shape="rect" coords="NaN,NaN,NaN,NaN" /><area shape="rect" coords="NaN,NaN,NaN,NaN" /><area shape="rect" coords="NaN,NaN,NaN,NaN" /><area shape="rect" coords="NaN,NaN,NaN,NaN" /><area shape="rect" coords="NaN,NaN,NaN,NaN" /></map><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></p></td><td valign="top" align="left"><p>Cliënt zendt DHCPDISCOVER uit.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></p></td><td valign="top" align="left"><p>DHCP-server antwoordt met IP-adres,
		      <code class="literal">next-server</code>,
		      <code class="literal">filename</code> en
		      <code class="literal">root-path</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></p></td><td valign="top" align="left"><p>Cliënt verstuurt <acronym class="acronym">TFTP</acronym>-verzoek
		      naar <code class="literal">next-server</code> om
		      <code class="literal">filename</code> op te vragen.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></p></td><td valign="top" align="left"><p>TFTP-server antwoordt en verstuurt
		      <code class="literal">filename</code> naar cliënt.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></p></td><td valign="top" align="left"><p>Cliënt voert <code class="literal">filename</code> uit
		      welke <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pxeboot&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pxeboot</span>(8)</span></a> is.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pxeboot&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pxeboot</span>(8)</span></a> laadt de
		      kernel.  Wanneer de kernel draait, wordt het
		      root-bestandssysteem gespecificeerd door
		      <code class="literal">root-path</code> over
		      <acronym class="acronym">NFS</acronym> aangekoppeld.</p></td></tr></table></div></div></div></div><br class="figure-break" /></li><li class="step"><p>Controleer dat het bestand <code class="filename">pxeboot</code> via
	    <acronym class="acronym">TFTP</acronym> kan worden verkregen.  Kijk op uw
	    <acronym class="acronym">TFTP</acronym>-server in
	    <code class="filename">/var/log/xferlog</code> om er zeker van de zijn dat
	    het bestand <code class="filename">pxeboot</code> van de juiste locatie is
	    opgehaald.  Om de configuratie met bovenstaande
	    <code class="filename">dhcpd.conf</code> te testen:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>tftp 192.168.0.1</code></strong>
tftp&gt; <strong class="userinput"><code>get FreeBSD/install/boot/pxeboot</code></strong>
Received 264951 bytes in 0.1 seconds</pre><p>Lees <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tftpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">tftpd</span>(8)</span></a> en <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tftp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tftp</span>(1)</span></a>.  De <code class="literal">BUGS</code>
	    secties in deze pagina's documenteren enkele beperkingen van
	    <acronym class="acronym">TFTP</acronym>.</p></li><li class="step"><p>Controleer dat het root-bestandssysteem via
	    <acronym class="acronym">NFS</acronym> kan worden aangekoppeld.  Om de configuratie
	    met bovenstaande <code class="filename">dhcpd.conf</code> te testen:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -t nfs 192.168.0.1:/b/tftpboot/FreeBSD/install /mnt</code></strong></pre></li><li class="step"><p>Lees de code in
	    <code class="filename">src/sys/boot/i386/libi386/pxe.c</code>
	    om te begrijpen hoe de <code class="filename">pxeboot</code>-lader variabelen
	    als <code class="literal">boot.nfsroot.server</code> en
	    <code class="literal">boot.nfsroot.path</code> instelt.  Deze variabelen
	    worden vervolgens gebruikt in de root-aankoppelcode voor diskvrij
	    NFS in <code class="filename">src/sys/nfsclient/nfs_diskless.c</code>.</p></li><li class="step"><p>Lees <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pxeboot&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pxeboot</span>(8)</span></a> en <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a>.</p></li></ol></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="network-diskless.html">Terug</a> </td><td width="20%" align="center"><a accesskey="u" href="advanced-networking.html">Omhoog</a></td><td width="40%" align="right"> <a accesskey="n" href="network-isdn.html">Volgende</a></td></tr><tr><td width="40%" align="left" valign="top">31.7. Schijfloos werken </td><td width="20%" align="center"><a accesskey="h" href="index.html">Begin</a></td><td width="40%" align="right" valign="top"> 31.9. ISDN</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>