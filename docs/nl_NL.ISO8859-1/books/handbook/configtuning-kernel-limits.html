<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>12.14. Fijnafstemming van kernellimieten</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD handboek" /><link rel="up" href="config-tuning.html" title="Hoofdstuk 12. Instellingen en optimalisatie" /><link rel="prev" href="configtuning-disk.html" title="12.13. Harde schijven optimaliseren" /><link rel="next" href="adding-swap-space.html" title="12.15. Wisselbestandruimte toevoegen" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">12.14. Fijnafstemming van kernellimieten</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="configtuning-disk.html">Terug</a> </td><th width="60%" align="center">Hoofdstuk 12. Instellingen en optimalisatie</th><td width="20%" align="right"> <a accesskey="n" href="adding-swap-space.html">Volgende</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="configtuning-kernel-limits"></a>12.14. Fijnafstemming van kernellimieten</h2></div></div></div><a id="idp75654864" class="indexterm"></a><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="file-process-limits"></a>12.14.1. Bestandsproceslimieten</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kern-maxfiles"></a>12.14.1.1. <code class="varname">kern.maxfiles</code></h4></div></div></div><a id="idp75657808" class="indexterm"></a><p><code class="varname">kern.maxfiles</code> kan worden verhoogd of
	  verlaagd, afhankelijk van de systeembehoeften.  Deze variabele
	  geeft het maximale aantal bestandsdescriptors op een systeem.
	  Als de bestandsdescriptortabel vol is, toont de systeembuffer
	  meerdere malen <span class="errorname">file: table is full</span>, hetgeen
	  achteraf te zien is met <code class="command">dmesg</code>.</p><p>Elk geopend bestand, socket of fifo heeft een
	  bestandsdescriptor.  Een grote produktieserver kan makkelijk
	  enige duizenden bestandsdescriptors nodig hebben, afhankelijk
	  van het soort en aantal diensten die tegelijk draaien.</p><p>In oudere versies van FreeBSD werd de standaard waarde van
	  <code class="varname">kern.maxfiles</code> afgeleid van de optie
	  <code class="option">maxusers</code> in het kernelconfiguratiebestand.
	  <code class="varname">kern.maxfiles</code> groeit evenredig met de
	  waarde van <code class="literal">maxusers</code>.  Als een aangepaste
	  kernel wordt gebouwd, is het een goed idee om deze kerneloptie
	  in te stellen afhankelijk van het gebruikt van een systeem
	  (maar niet te laag).  Hoewel een produktieserver misschien
	  niet 256 gelijktijdige gebruikers heeft, kunnen de benodigde
	  systeembronnen het beste vergeleken worden met een
	  grootschalige webserver.</p><p>De optie <code class="literal">maxusers</code> stelt de grootte van
	  een aantal belangrijke systeemtabellen in.  Dit aantal moet
	  ruwweg gelijk zijn aan het aantal gebruikers dat verwacht
	  wordt gelijktijdig van de machine gebruik te maken.</p><p>Vanaf FreeBSD 4.5 wordt <code class="varname">kern.maxusers</code>
	  automatisch ingesteld tijdens het opstarten gebaseerd op de
	  hoeveelheid beschikbare geheugen in het systeem en kan worden
	  vastgesteld tijdens het draaien door te kijken naar de
	  alleen-lezen sysctl <code class="varname">kern.maxusers</code>.  Sommige
	  configuraties hebben grotere of kleinere waarden nodig van
	  <code class="varname">kern.maxusers</code>, deze kunnen worden gezet
	  als een opstartvariabele.  Waardes van 64, 128 en 256 zijn
	  daarin niet ongewoon.  We raden aan om niet boven de 256 te
	  gaan tenzij er heel veel bestandsdescriptors benodigd zijn;
	  veel van de aanpasbaare waarden die standaard worden bepaald
	  door <code class="varname">kern.maxusers</code> kunnen individueel
	  worden overschreven tijdens het opstarten en/of tijdens het
	  draaien van het systeem in
	  <code class="filename">/boot/loader.conf</code> (zie de handleiding
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=loader.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">loader.conf</span>(5)</span></a> of
	  <code class="filename">/boot/defaults/loader.conf</code> voor een paar
	  aanwijzingen) of zoals elders beschreven in dit document.</p><p>Voor oudere versies stelt het systeem deze waarde zelf in
	  als deze uitdrukkelijk op <code class="literal">0</code> is gezet.

	  <a href="#ftn.idp75667280" class="footnote" id="idp75667280"><sup class="footnote">[5]</sup></a>

	  Als het gewenst is om deze waarde zelf aan te geven, wordt
	  aangeraden om <code class="literal">maxusers</code> minstens op 4 te
	  zetten, met name als het X Window systeem in gebruik is of als
	  er software gecompileerd wordt.  De reden hiervoor is dat de
	  belangrijkste tabel die door <code class="literal">maxusers</code>
	  ingesteld wordt, het maximum aantal processen is, dat
	  ingesteld wordt op <code class="literal">20 + 16 * maxusers</code>, dus
	  als <code class="literal">maxusers</code> op 1 ingesteld wordt, zijn er
	  maar 36 gelijktijdige processen mogelijk, inclusief de
	  ongeveer achttien processen die door het systeem tijdens het
	  opstarten start en de ongeveer vijftien processen die
	  waarschijnlijk aangemaakt worden door het opstarten van het X
	  Window systeem.  Zelfs een eenvoudige taak als het afbeelden
	  van een hulppagina start negen processen op om de pagina te
	  filteren, te decomprimeren en af te beelden.  Als
	  <code class="literal">maxusers</code> op 64 ingesteld wordt, zijn er
	  1044 gelijktijdige processen mogelijk, wat genoeg moet zijn
	  voor bijna alle soorten gebruik.  Als echter de gevreesde
	  fout <span class="errortype">proc table full</span> verschijnt als er
	  geprobeerd wordt om een programma op te starten of als er een
	  server gedraaid wordt met een groot aantal gelijktijdige
	  gebruikers, zoals <code class="systemitem">ftp.FreeBSD.org</code>, kan het getal altijd
	  verhoogd worden en kan de kernel opnieuw gebouwd
	  worden.</p><div xmlns="" class="note"><h3 class="admontitle">Opmerking: </h3><p xmlns="http://www.w3.org/1999/xhtml"><code class="literal">maxusers</code> stelt
	    <span class="emphasis"><em>geen</em></span> grens aan het aantal gebruikers
	    dat zich op de machine kan aanmelden.  Het stelt gewoon
	    verschillende tabelgroottes in op redelijke waardes,
	    uitgaande van het maximum aantal gebruikers dat
	    waarschijnlijk de machine gebruikt en van het aantal
	    processen dat elk van deze gebruikers zal draaien.  Een
	    sleutelwoord dat <span class="emphasis"><em>wel</em></span> het aantal
	    gelijktijdige aanmeldingen op afstand en X-terminalvensters
	    begrensd is <a class="link" href="kernelconfig-config.html#kernelconfig-ptys"><code class="literal">pseudo-device pty
		16</code></a>.  In FreeBSD 5.X kan dit getal
	    genegeerd worden omdat daar het stuurprogramma <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pty&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">pty</span>(4)</span></a>
	    <span class="quote">&#8220;<span class="quote">auto-cloning</span>&#8221;</span> is.  Er kan eenvoudig gebruik
	    worden gemaakt van de regel <code class="literal">device pty</code>
	    in het instellingenbestand.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp75675600"></a>12.14.1.2. <code class="varname">kern.ipc.somaxconn</code></h4></div></div></div><a id="idp75676368" class="indexterm"></a><p>De sysctl-variabele <code class="varname">kern.ipc.somaxconn</code>
	  beparkt de grootte van de luisterwachtrij voor het accepteren
	  van nieuwe TCP-verbindingen.  De standaardwaarde van
	  <code class="literal">128</code> is meestal te laag voor robuuste
	  behandeling van nieuwe verbindingen in een zwaarbeladen
	  webserveromgeving.  Voor zulke omgevingen wordt aangeraden
	  deze waarde te verhogen tot <code class="literal">1024</code> of hoger.
	  De dienstdaemon beperkt misschien zelf de luisterwachtrij
	  (bijvoorbeeld <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendmail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sendmail</span>(8)</span></a> of
	  <span class="application">Apache</span>), maar heeft vaak een
	  mogelijkheid in een configuratiebestand de wachtrijgrootte
	  aan te passen.  Grote luisterwachtrijen zijn ook beter in het
	  ontwijken van Ontzegging van Dienst (<abbr class="abbrev">DoS</abbr>)
	  aanvallen.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nmbclusters"></a>12.14.2. Netwerkbeperkingen</h3></div></div></div><p>De kerneloptie <code class="literal">NMBCLUSTERS</code> bepaalt het
	aantal netwerk-Mbufs dat beschikbaar is voor een systeem.  Een
	veel bezochte server met een laag aantal Mbufs beperkt de
	mogelijkheden van FreeBSD.  Elk cluster staat voor ongeveer
	2 K geheugen, dus een waarde van 1024 stelt 2 megabyte
	aan kernelgeheugen voor, dat is gereserveerd voor
	netwerkbuffers.  Een simpele berekening geeft aan hoeveel er
	nodig is.  Stel dat een webserver met een maximum van 1000
	simultane verbindingen voor elke verbinding 16 K aan
	ontvangstnetwerkbuffers en 16 K aan zendbuffers kost, dan
	is ongeveer 32 MB aan netbuffers nodig voor de webserver.
	Een goede vuistregel is te vermeniguldigen met twee, dus
	2x32 MB / 2 KB = 64 MB /
	2 kB = 32768.  Voor machines met veel geheugen wordt
	4096 tot 32768 aangeraden.  Er moet in geen geval een arbitrair
	hoge waarde voor deze sysctl opgegeven worden, want dat kan
	leiden tot een crash tijdens het opstarten.  Met de optie
	<code class="option">-m</code> van <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=netstat&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">netstat</span>(1)</span></a> kan het clustergebruik
	van het netwerk bekeken worden.</p><p>De loaderparameter <code class="varname">kern.ipc.nmbclusters</code>
	moet gebruikt worden om dit tijdens het opstarten toe te passen.
	Alleen voor oudere versies van FreeBSD is het nodig om de
	kerneloptie <code class="literal">NMBCLUSTERS</code> te gebruiken.</p><p>Voor drukke servers die extensief gebruik maken van de
	systeemaanroep <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendfile&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">sendfile</span>(2)</span></a>, kan het nodig zijn het aantal
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendfile&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">sendfile</span>(2)</span></a>-buffers te verhogen via de kerneloptie
	<code class="literal">NSFBUFS</code> of door de waarde in te stellen in
	<code class="filename">/boot/loader.conf</code> (in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a> staan
	details).  Als er in de procestabel processen staan met een
	status <code class="literal">sfbufa</code> is dat een algemene indicator
	dat deze parameter aangepast moet worden.  De sysctl-variabele
	<code class="varname">kern.ipc.nsfbufs</code> is alleen-lezen en laat zien
	op welke waarde deze kernelvariabele is ingesteld.  Deze
	parameter schaalt engiszins met de variabele
	<code class="varname">kern.maxusers</code>, maar het kan nodig zijn om
	deze bij te stellen.</p><div xmlns="" class="important"><h3 class="admontitle">Belangrijk: </h3><p xmlns="http://www.w3.org/1999/xhtml">Zelfs als een socket als non-blocking gemarkeerd is, dan
	  nog kan het aanroepen van <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sendfile&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">sendfile</span>(2)</span></a> op de non-blocking
	  socket ertoe leiden dat er toch blokkade optreedt totdat er
	  voldoende <code class="literal">struct sf_buf</code>'s vrijgemaakt
	  zijn.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp75699280"></a>12.14.2.1. <code class="varname">net.inet.ip.portrange.*</code></h4></div></div></div><a id="idp75700048" class="indexterm"></a><p>De sysctl-variabelen
	  <code class="varname">net.inet.ip.portrange.*</code> bepalen welke reeks
	  poortnummers automatisch gebonden wordt aan TCP- en
	  UDP-sockets.  Er zijn drie gebieden: een laag gebied, een
	  (standaard) middengebied en een hoog gebied.  De meeste
	  netwerkprogramma's gebruiken het standaardbereik, wat
	  begrensd wordt door
	  <code class="varname">net.inet.ip.portrange.first</code> en
	  <code class="varname">net.inet.ip.portrange.last</code> met
	  standaardwaarden van respectievelijk 1024 en 5000.  Gebonden
	  poortreeksen worden gebruikt voor uitgaande verbindingen en
	  het is onder bepaalde omstandigheden mogelijk dat poorten op
	  raken.  Dit gebeurt meestal in het geval van een zwaar belaste
	  webproxy.  Poortbereik is niet van belang als vooral diensten
	  draaien die zich bezighouden met inkomende verbindingen, zoals
	  een normale webserver, of als het aantal uitgaande
	  verbindingen beperkt is, zoals bij een mailrelay.  Voor
	  situaties waarin een tekort aan poorten dreigt, wordt
	  aangeraden om <code class="varname">net.inet.ip.portrange.last</code>
	  bescheiden op te hogen.  Een waarde van
	  <code class="literal">10000</code>, <code class="literal">20000</code> of
	  <code class="literal">30000</code> is redelijk.  Er moet ook rekening
	  met effecten op firewalls gehouden worden als de poortreeks
	  gewijzigd wordt.  Sommige firewalls kunnen grote poortreeksen
	  blokkeren, meestal de lagere poorten, en verwachten dat andere
	  systemen hogere poorten gebruiken voor uitgaande verbindingen.
	  Om deze reden wordt het niet aanbevolen om
	  <code class="varname">net.inet.ip.portrange.first</code> te
	  verlagen.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp75704144"></a>12.14.2.2. TCP Bandbreedtevertragingsproduct (TCP Bandwidth Delay
	  Product)</h4></div></div></div><a id="idp75704784" class="indexterm"></a><p>De TCP-bandbreedtevertragingsproductlimitatie lijkt op
	  TCP/Vegas in NetBSD.  Het kan aangezet worden door de
	  sysctl-variabele
	  <code class="varname">net.inet.tcp.inflight.enable</code> de waarde
	  <code class="literal">1</code> te geven.  Het systeem tracht dan het
	  bandbreedtevertragingssprodukt te berekenen voor elke
	  verbinding en beperkt dan de hoeveelheid gegevens in de
	  wachtrij naar het netwerk tot de hoeveelheid die vereist is om
	  maximale doorvoer te kunnen handhaven.</p><p>Dit is nuttig bij gebruik van modems, Gigabit Ethernet of
	  zelfs bij WAN-verbindingen met hoge snelheid (of elke andere
	  verbinding met een groot bandbreedtevertragingsprodukt), in
	  het bijzonder als ook windowschaling of een groot
	  verzendwindow gebruikt wordt.  Als deze optie aangezet wordt,
	  dient ook <code class="varname">net.inet.tcp.inflight.debug</code> de
	  waarde <code class="literal">0</code> te krijgen (geen debugging) en
	  voor produktiegebruik kan het instellen van
	  <code class="varname">net.inet.tcp.inflight.min</code> naar minstens
	  <code class="literal">6144</code> voordeel opleveren.  Het instellen van
	  hoge minima kan effectief het beperken van bandbreedte
	  ondermijnen, afhankelijk van de verbinding.  De mogelijkheid
	  tot limitering zorgt ervoor dat de hoeveelheid gegevens die
	  opgebouwd wordt, in tussentijdse route- en switchwachtrijen
	  verlaagd kan worden en tevens kan de hoeveelheid gegevens die
	  opgebouwd wordt in de interfacewachtrij van de lokale host
	  verlaagd worden.  Met minder pakketten in wachtrijen kunnen
	  interactieve verbindingen opereren met lagere
	  <span class="emphasis"><em>Round Trip</em></span> tijden, met name over langzame
	  modems.  Deze optie gaat alleen over datatransmissie (upload /
	  serverkant) en heeft geen effect gegevensontvangst (download /
	  cliëntkant).</p><p>Aanpassen van
	  <code class="varname">net.inet.tcp.inflight.stab</code> wordt
	  <span class="emphasis"><em>niet</em></span> aangeraden.  Deze parameter krijgt
	  standaard een waarde van 20, wat 2 maximale pakketten opgeteld
	  bij de bandbreedtevensterberekening representeert.  Het extra
	  venster is nodig om het algoritme stabiel te houden en om de
	  reactietijd bij veranderende omstandigheden te verbeteren,
	  maar het kan ook leiden tot langere pingtijden over langzame
	  verbindingen (zonder het inflight-algoritme kan dit echter nog
	  erger zijn).  In dergelijke gevallen kan deze parameter
	  misschien verlaagd worden naar 15, 10 of 5 en misschien moet
	  voor het gewenste effect ook
	  <code class="varname">net.inet.tcp.inflight.min</code> verlaagd worden
	  (bijvoorbeeld naar 3500).  Het verlagen van deze parameters
	  moet pas in laatste instantie overwogen worden.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp75711440"></a>12.14.3. Virtueel Geheugen</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp75712080"></a>12.14.3.1. <code class="varname">kern.maxvnodes</code></h4></div></div></div><p>Een vnode is de interne representatie van een bestand of
	  een map.  Het verlagen van het aantal beschikbare vnodes voor
	  het besturingssysteem leidt dus tot een daling van schijf-I/O.
	  Normaliter wordt dit door het besturingssysteem afgehandeld en
	  hoeft de instelling niet gewijzigd te worden.  Im sommige
	  gevallen kan schijf-I/O de beperkende factor zijn en kan het
	  systeem alle beschikbare vnodes in gebruik hebben.  Dan dient
	  deze instelling gewijzigd te worden.  De hoeveelheid inactief
	  en beschikbaar RAM dient meegenomen te worden in de
	  beslissing.</p><p>Het huidige aantal gebruikte vnodes kan als volgt bekeken
	  worden:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sysctl vfs.numvnodes</code></strong>
vfs.numvnodes: 91349</pre><p>Om het maximale aantal vnodes weer te geven:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sysctl kern.maxvnodes</code></strong>
kern.maxvnodes: 100000</pre><p>Als het huidige aantal gebruikte vnodes dicht bij het
	  maximale aantal ligt, is het verstandig om
	  <code class="varname">kern.maxvnodes</code> op te hogen met 1.000.
	  Ook <code class="varname">vfs.numvnodes</code> dient in de gaten
	  gehouden te worden.  Als de waarde weer tot aan het maximum
	  stijgt, dan moet <code class="varname">kern.maxvnodes</code> verder
	  opgehoogd worden.  Er dient een verschuiving op te treden in
	  het door <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=top&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">top</span>(1)</span></a> gerapporteerde geheugengebruik.  Er hoort
	  meer geheugen actief te zijn.</p></div></div><div class="footnotes"><br /><hr class="footnote-hr" /><div id="ftn.idp75667280" class="footnote"><p><a href="#idp75667280" class="para"><sup class="para">[5] </sup></a>Het auto-tuning-algoritme stelt
	      <code class="literal">maxusers</code> in afhankelijk van de
	      hoeveelheid geheugen in het systeem, met een minimum van
	      32 en een maximum van 384.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="configtuning-disk.html">Terug</a> </td><td width="20%" align="center"><a accesskey="u" href="config-tuning.html">Omhoog</a></td><td width="40%" align="right"> <a accesskey="n" href="adding-swap-space.html">Volgende</a></td></tr><tr><td width="40%" align="left" valign="top">12.13. Harde schijven optimaliseren </td><td width="20%" align="center"><a accesskey="h" href="index.html">Begin</a></td><td width="40%" align="right" valign="top"> 12.15. Wisselbestandruimte toevoegen</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>