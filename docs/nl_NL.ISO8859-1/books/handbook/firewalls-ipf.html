<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>30.5. De IPFILTER (IPF) firewall</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD handboek" /><link rel="up" href="firewalls.html" title="Hoofdstuk 30. Firewalls" /><link rel="prev" href="firewalls-pf.html" title="30.4. De OpenBSD Packet Filter (PF) en ALTQ" /><link rel="next" href="firewalls-ipfw.html" title="30.6. IPFW" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">30.5. De IPFILTER (IPF) firewall</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="firewalls-pf.html">Terug</a> </td><th width="60%" align="center">Hoofdstuk 30. Firewalls</th><td width="20%" align="right"> <a accesskey="n" href="firewalls-ipfw.html">Volgende</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="firewalls-ipf"></a>30.5. De IPFILTER (IPF) firewall</h2></div></div></div><a id="idp88100176" class="indexterm"></a><p>Darren Reed is de auteur van IPFILTER, dat niet afhankelijk
      is van één besturingssysteem.  Het is een open
      source applicatie die is geporteerd naar FreeBSD, NetBSD, OpenBSD,
      SunOS, HP/UX en Solaris besturingssystemen.  IPFILTER wordt
      actief ondersteund en onderhouden en er worden regelmatig nieuwe
      versies uigebracht.</p><p>IPFILTER is gebaseerd op een firewall aan de kernelkant en
      een <acronym class="acronym">NAT</acronym> mechanisme dat gecontroleerd en
      gemonitord kan worden door programma's in userland.  De
      firewallregels kunnen ingesteld of verwijderd worden met het
      hulpprogramma <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a>.  De <acronym class="acronym">NAT</acronym> regels
      kunnen ingesteld of verwijderd worden met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipnat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipnat</span>(8)</span></a>.  Het
      programma <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a> kan actuele statistieken leveren voor
      de kernelonderdelen van IPFILTER.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipmon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipmon</span>(8)</span></a> kan acties van
      IPFILTER wegschrijven naar logboekbestanden van het
      systeem.</p><p>IPF is oorspronkelijk geschreven met logica die regels
      verwerkte volgens het principe <span class="quote">&#8220;<span class="quote">de laatst passende regel
	wint</span>&#8221;</span> en gebruikte toen alleen staatloze regels.  In de
      loop der tijd is IPF verbeterd en zijn de opties
      <code class="literal">quick</code> en <code class="literal">keep state</code>
      toegevoegd waarmee de logica van het verwerken van regels
      drastisch is gemoderniseerd.  In de officiële documentatie
      van IPF worden alleen de regels en verwerkingslogica
      behandeld.  De moderne functies worden alleen behandeld als
      opties, waardoor hun nut dat er een veel betere en veiligere firewall mee
      te maken volledig onderbelicht blijft.</p><p>De instructies in dit hoofdstuk zijn gebaseerd op regels die
      gebruik maken van de optie <code class="literal">quick</code> en de
      stateful optie <code class="literal">keep state</code>.  Dit is het
      raamwerk waarmee een set van inclusieve firewallregels wordt
      samengesteld.</p><p>Voor een gedetailleerde uitleg over de verwerking van de
      verouderde regels zie <code class="uri"><a class="uri" href="http://www.munk.me.uk/ipf/ipf-howto.html" target="_top">http://www.munk.me.uk/ipf/ipf-howto.html</a></code>
      en <code class="uri"><a class="uri" href="http://coombs.anu.edu.au/~avalon/ip-filter.html" target="_top">http://coombs.anu.edu.au/~avalon/ip-filter.html</a></code>.</p><p>De IPF FAQ is te vinden op <code class="uri"><a class="uri" href="http://www.phildev.net/ipf/index.html" target="_top">http://www.phildev.net/ipf/index.html</a></code>.</p><p>Een doorzoekbaar archief van de open-source IPFilter mailing
      lijst is beschikbaar op <code class="uri"><a class="uri" href="http://marc.theaimsgroup.com/?l=ipfilter" target="_top">http://marc.theaimsgroup.com/?l=ipfilter</a></code>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88112208"></a>30.5.1. IPF inschakelen</h3></div></div></div><a id="idp88112848" class="indexterm"></a><p>IPF zit in de basisinstallatie van FreeBSD als een aparte
	<span class="quote">&#8220;<span class="quote">run time</span>&#8221;</span> laadbare module.  Een systeem laadt de
	IPF kernel laadbare module dynamisch als
	<code class="literal">ipfilter_enable="YES"</code> in
	<code class="filename">rc.conf</code> staat.  Voor de laadbare module
	zijn de opties <code class="literal">logging</code> en <code class="literal">default
	  pass all</code> ingeschakeld.  IPF hoeft niet in de
	kernel gecompileerd te worden om het standaardgedrag te
	wijzigen naar <code class="literal">block all</code>.  Dat is mogelijk
	door op het einde van de regelverzameling een regel <code class="literal">block
	  all</code> toe te voegen die al het verkeer blokkeert.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88117200"></a>30.5.2. Kernelopties</h3></div></div></div><a id="idp88126160" class="indexterm"></a><a id="idp88127312" class="indexterm"></a><a id="idp88128464" class="indexterm"></a><a id="idp88129616" class="indexterm"></a><p>Het is niet verplicht om IPF in te schakelen door de
	volgende opties in de FreeBSD kernel te compileren.  Dit wordt
	alleen beschreven als achtergrondinformatie.  Door IPF in de
	kernel te compileren wordt de laadbare module niet
	gebruikt.</p><p>Voorbeeld kernelinstellingen voor IPF staan beschreven in
	de <code class="filename">/usr/src/sys/i386/conf/LINT</code>in de
	kernelbroncode en worden hier beschreven:</p><pre class="programlisting">options IPFILTER
options IPFILTER_LOG
options IPFILTER_DEFAULT_BLOCK</pre><p><code class="literal">options IPFILTER</code> schakelt ondersteuning
	voor de <span class="quote">&#8220;<span class="quote">IPFILTER</span>&#8221;</span> firewall in.</p><p><code class="literal">options IPFILTER_LOG</code> schakelt de
	optie in waarmee IPF verkeer kan loggen door het naar het
	<code class="filename">ipl</code> pakketloggende
	pseudo-apparaat te schrijven voor iedere regel met het
	sleutelwoord <code class="literal">log</code> erin.</p><p><code class="literal">options IPFILTER_DEFAULT_BLOCK</code>
	wijzigt het standaardgedrag zodat ieder pakket waarop geen
	enkele <code class="literal">pass</code> regel van toepassing is
	wordt geblokkeerd.</p><p>Deze instelling worden pas actief nadat een kernel
	waarvoor deze instellingen zijn gemaakt is gebouwd en
	geïnstalleerd.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88136400"></a>30.5.3. Beschikbare opties voor <code class="filename">rc.conf</code></h3></div></div></div><p>De volgende instellingen moeten in <code class="filename">/etc/rc.conf</code>
	staan om IPF bij het opstarten te activeren:</p><pre class="programlisting">ipfilter_enable="YES"             # Start ipf firewall
ipfilter_rules="/etc/ipf.rules"   # laad regels uit het doelbestand
ipmon_enable="YES"                # Start IP monitor log
ipmon_flags="-Ds"                 # D = start als daemon
                                  # s = log naar syslog
                                  # v = log tcp window, ack, seq
                                  # n = vertaal IP &amp; poort naar namen</pre><p>Als er een LAN achter de firewall staat dat gebruik maakt
	van <acronym class="acronym">IP</acronym>-adressen uit de private reeks, dan
	moet de volgende optie ook ingesteld worden om
	<acronym class="acronym">NAT</acronym>-functionaliteit in te schakelen:</p><pre class="programlisting">gateway_enable="YES"              # Schakel in als LAN gateway
ipnat_enable="YES"                # Start ipnat functie
ipnat_rules="/etc/ipnat.rules"    # bestand met regels voor ipnat</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88140112"></a>30.5.4. IPF</h3></div></div></div><a id="idp88140752" class="indexterm"></a><p>Het commando <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a> wordt gebruikt om het bestand met
	firewallregels te laden.  Gewoonlijk wordt er een bestand
	aangemaakt waarin de situatieafhankelijke regels staan
	waarmee in één keer de bestaande regels kunnen
	worden vervangen:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ipf -Fa -f /etc/ipf.rules</code></strong></pre><p><code class="option">-Fa</code>: verwijder alle interne tabellen
	met regels.</p><p><code class="option">-f</code>: laad het aangegeven
	bestand met regels.</p><p>Hiermee wordt het mogelijk wijzigingen te maken aan het
	bestand met eigen regels en met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a> de firewall aan
	te passen met verse regels zonder het systeem te booten.
	Deze methode is erg handig om nieuwe regels te testen omdat
	dit zo vaak als nodig gedaan kan worden.</p><p>In <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a> worden alle opties die beschikbaar zijn
	toegelicht.</p><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a> verwacht dat het bestand met regels een
	standaard tekstbestand is.  Het accepteert geen bestand met
	regels dat is opgesteld als een script dat gebruik maakt van
	substitutie.</p><p>Er is wel een mogelijkheid om IPF regels op te stellen
	en gebruik te maken van substitutie.  Meer informatie staat
	in <a class="xref" href="firewalls-ipf.html#firewalls-ipf-rules-script" title="30.5.9. Script met regels met substitutie bouwen">Paragraaf 30.5.9, &#8220;Script met regels met substitutie bouwen&#8221;</a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88149200"></a>30.5.5. IPFSTAT</h3></div></div></div><a id="idp88149840" class="indexterm"></a><a id="idp88154704" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a> haalt de totalen van de statistieken op
	die horen bij de firewall sinds die is gestart en toont deze.
	Het kan ook zijn dat de tellers in tussentijd op nul zijn
	gesteld met <code class="command">ipf -Z</code>.</p><p>In <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a> worden alle details behandeld.</p><p>Standaard ziet <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a> uitvoer er ongeveer als
	volgt uit:</p><pre class="screen">input packets: blocked 99286 passed 1255609 nomatch 14686 counted 0
output packets: blocked 4200 passed 1284345 nomatch 14687 counted 0
input packets logged: blocked 99286 passed 0
output packets logged: blocked 0 passed 0
packets logged: input 0 output 0
log failures: input 3898 output 0
fragment state(in): kept 0 lost 0
fragment state(out): kept 0 lost 0
packet state(in): kept 169364 lost 0
packet state(out): kept 431395 lost 0
ICMP replies: 0 <acronym class="acronym">TCP</acronym> RSTs sent: 0
Result cache hits(in): 1215208 (out): 1098963
IN Pullups succeeded: 2 failed: 0
OUT Pullups succeeded: 0 failed: 0
Fastroute successes: 0 failures: 0
<acronym class="acronym">TCP</acronym> cksum fails(in): 0 (out): 0
Packet log flags set: (0)</pre><p>Als er als optie <code class="option">-i</code> voor inkomend of
	<code class="option">-o</code> voor uitgaand wordt meegegeven, dan zal het
	commando de juiste lijst met regels die de kernel op dat moment gebruikt
	wordt weergeven.</p><p><code class="command">ipfstat -in</code> toont de tabel met
	regels voor inkomend verkeer met regelnummers</p><p><code class="command">ipfstat -on</code> toont de tabel met
	regels voor uitgaand verkeer met regelnummers</p><p>De uitvoer ziet er ongeveer als volgt uit:</p><pre class="screen">@1 pass out on xl0 from any to any
@2 block out on dc0 from any to any
@3 pass out quick on dc0 proto tcp/udp from any to any keep state</pre><p><code class="command">ipfstat -ih</code> toont de tabel met
	regels voor inkomend verkeer, waarbij voor iedere regel staat
	hoe vaak die van toepassing was.</p><p><code class="command">ipfstat -oh</code> toont de tabel met
	regels voor uitgaand verkeer, waarbij voor iedere regel staat
	hoe vaak die van toepassing was.</p><p>De uitvoer ziet er ongeveer als volgt uit:</p><pre class="screen">2451423 pass out on xl0 from any to any
354727 block out on dc0 from any to any
430918 pass out quick on dc0 proto tcp/udp from any to any keep state</pre><p>Een van de belangrijkste functies van
	<code class="command">ipfstat</code> is de vlag <code class="option">-t</code>
	waarmee de staat-tabel wordt getoond op een wijze die
	vergelijkbaar is met de wijze waarop <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=top&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">top</span>(1)</span></a> de draaiende
	FreeBSD procestabel toont.  Als een firewall wordt aangevallen, dan
	geeft deze functie de mogelijkheid om de pakketten van de
	aanvaller te identificeren en nader te onderzoeken.  De
	optionele subvlaggen bieden de mogelijkheid om een bron of
	bestemmings <acronym class="acronym">IP</acronym> adres, poort of protocol aan
	te geven dat gemonitord moet worden.  Details zijn na te lezen
	in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipfstat</span>(8)</span></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88173648"></a>30.5.6. IPMON</h3></div></div></div><a id="idp88174288" class="indexterm"></a><a id="idp88174928" class="indexterm"></a><p>Om <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipmon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipmon</span>(8)</span></a> te laten werken zoals bedoeld, moet de
	kerneloptie <code class="literal">IPFILTER_LOG</code> aan staan.  Dit
	commando kan op twee verschillende wijzen gebruikt worden.
	De standaard is van toepassing als het commando op de
	commandoregel wordt ingegeven zonder de optie
	<code class="option">-D</code>.</p><p>De daemon wordt gebruikt als continu een systeemlogboek
	bijgewerkt moet worden zodat het mogelijk is om
	gebeurtenissen in het verleden te bekijken.  Zo zijn FreeBSD en
	IPFILTER ingesteld om samen te werken.  FreeBSD heeft ingebouwde
	mogelijkheden om automatisch syslogs te roteren.  Daarom is
	het beter om de uitvoer naar <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a> te schrijven
	dan naar een gewoon bestand.  In de standaardversie van
	<code class="filename">rc.conf</code> is te zien dat de instelling
	<code class="literal">ipmon_flags</code> de waarde <code class="option">-Ds</code>
	heeft:</p><pre class="programlisting">ipmon_flags="-Ds" # D = start als daemon
                  # s = log naar syslog
                  # v = log tcp window, ack, seq
                  # n = vertaal IP &amp; poort naar namen</pre><p>De voordelen van loggen zijn duidelijk.  Het biedt de
	mogelijkheid om na het feit informatie na te zien als: welke
	pakketten heeft de firewall laten vallen, waar kwamen ze
	vandaan en waar gingen ze heen?  Dit zijn allemaal voordelen
	als het gaat om uitvinden waar een aanvaller vandaan komt en
	wat deze heeft geprobeerd.</p><p>Zelfs als loggen is ingeschakeld, logt IPF nog niets uit
	zichzelf.  De beheerder van de firewall beslist welke regels in de
	regelverzameling iets weg moeten schrijven door het sleutelwoord
	<code class="literal">log</code> aan die regels toe te voegen.
	Gewoonlijk worden alleen <code class="literal">deny</code> regels
	gelogd.</p><p>Het is heel normaal om als laatste regel een
	<code class="literal">deny</code> regel aan de set met regels toe te
	voegen waar het sleutelwoord <code class="literal">log</code> in staat.
	Zo krijgt een beheerder alle pakketten te zien waarop geen
	enkele regel van toepassing was.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88191952"></a>30.5.7. Loggen met IPMON</h3></div></div></div><p><span class="application">Syslogd</span> heeft een eigen methode
	om logboekgegevens te scheiden.  Het maakt gebruik van speciale
	groepen die <span class="quote">&#8220;<span class="quote">facility</span>&#8221;</span> en <span class="quote">&#8220;<span class="quote">level</span>&#8221;</span>
	heten.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipmon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipmon</span>(8)</span></a> in <code class="option">-Ds</code> mode gebruikt
	<code class="literal">local0</code>
	als <span class="quote">&#8220;<span class="quote">facility</span>&#8221;</span>naam.  Alle door <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipmon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipmon</span>(8)</span></a> gelogde
	gegevens gaan standaard naar de naam <code class="literal">security</code>.
	De nu volgende levels
	kunnen gebruikt worden om de gelogde gegevens nog verder uit
	elkaar te trekken als dat gewenst is.</p><pre class="screen">LOG_INFO &#8211; pakketten gelogd met het sleutelwoord "log" als actie in plaats van pass of block.
LOG_NOTICE &#8211; gelogde pakketten die ook zijn doorgelaten
LOG_WARNING &#8211; gelogde pakketten die ook geblokkeerd zijn
LOG_ERR &#8211; gelogde pakketten die een verkeerde opbouw hebben, "short"</pre><p>Om IPFILTER alle gelogde gegevens naar
	<code class="filename">/var/log/ipfilter.log</code> te laten schrijven,
	dient dat bestand vooraf te bestaan.  Dat kan met het volgende
	commando:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>touch /var/log/ipfilter.log</code></strong></pre><p>De functionaliteit van <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a> wordt beheerd met
	instellingen in <code class="filename">/etc/syslog.conf</code>.
	Dit bestand biedt aanzienlijke
	flexibiliteit in hoe <span class="application">syslog</span> omgaat met
	systeemberichten die door softwaretoepassingen als IPF worden
	gegeven.</p><p>Zo kan de volgende instelling toegevoegd worden aan
	<code class="filename">/etc/syslog.conf</code>:</p><pre class="programlisting">local0.* /var/log/ipfilter.log</pre><p>Het deel <code class="literal">local0.*</code>
	betekent dat alle logberichten naar de aangegeven plaats
	geschreven moeten worden.</p><p>Om de wijzigingen in
	<code class="filename">/etc/syslog.conf</code> actief te maken kan er opnieuw
	opgestart worden of is het mogelijk de daemon <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a> een schop
	te geven zodat <code class="filename">/etc/syslog.conf</code> opnieuw
	wordt ingelezen met <code class="command">/etc/rc.d/syslogd
	  reload</code>.  Het PID (procesnummer) is te achterhalen
	door een overzicht van taken te tonen met
	<code class="command">ps -ax</code>.  Het PID is het nummer in de
	linker kolom voor de regel waarop <span class="quote">&#8220;<span class="quote">syslog</span>&#8221;</span>
	staat.</p><p>Vaak wordt vergeten
	<code class="filename">/etc/newsyslog.conf</code> te wijzigen om het
	nieuw aangemaakte logboekbestand te laten roteren.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88207440"></a>30.5.8. De opmaak van gelogde berichten</h3></div></div></div><p>Berichten die door <code class="command">ipmon</code> wordt gezonden
	bestaan uit velden die gescheiden worden door een spatie.
	Velden die in alle berichten zitten zijn:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>De datum waarop het pakket is ontvangen.</p></li><li class="listitem"><p>De tijd waarop het pakket is ontvangen weergegeven
	    als HH:MM:SS.F voor uren, minuten, seconden en fracties
	    van een seconde.  De fractie kan meerdere cijfers lang
	    zijn.</p></li><li class="listitem"><p>De naam van de interface waarop het pakket is
	    ontvangen, bijvoorbeeld
	    <code class="filename">dc0</code>.</p></li><li class="listitem"><p>De groep en regelnummer van de regel, bijvoorbeeld
	    <code class="literal">@0:17</code>.</p></li></ol></div><p>Deze kunnen ingezien worden met
	<code class="command">ipfstat -in</code>.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>De acties: <code class="literal">p</code> voor doorgelaten
	    (<span class="quote">&#8220;<span class="quote">passed</span>&#8221;</span>), <code class="literal">b</code> voor
	    geblokkeerd (<span class="quote">&#8220;<span class="quote">blocked</span>&#8221;</span>),
	    <code class="literal">S</code> voor een verkeerd pakket
	    (<span class="quote">&#8220;<span class="quote">short packet</span>&#8221;</span>), <code class="literal">n</code> voor
	    dat er geen enkele regel van toepassing was,
	    <code class="literal">L</code> voor een logboekregel.  De volgorde
	    waarin deze acties getoond worden is: S, p, b, n, L.  Een
	    hoofdletter <code class="literal">P</code> of <code class="literal">B</code>
	    betekent dat het pakket gelogd is vanwege een globale
	    instelling, niet vanwege één regel in het
	    bijzonder.</p></li><li class="listitem"><p>De adressen.  Dit zijn eigenlijk drie velden: het
	    bronadres en poort gescheiden door een komma, het symbool
	    -&gt; en het bestemmingsadres en poort, bijvoorbeeld:
	    <code class="literal">209.53.17.22,80 -&gt; 198.73.220.17,1722</code>.</p></li><li class="listitem"><p>Achter <code class="literal">PR</code> staat de naam van het
	    protocol of het nummer, bijvoorbeeld <code class="literal">PR
	      tcp</code>.</p></li><li class="listitem"><p>Achter <code class="literal">len</code> staan de lengte van de
	    pakketkop en de totale lengte van het pakket,
	    bijvoorbeeld <code class="literal">len 20 40</code>.</p></li></ol></div><p>Als het pakket een <acronym class="acronym">TCP</acronym> pakket is, dan
	is er nog een veld dat begint met een verbindingsstreepje
	met daarachter letters die overeenkomen met vlaggen die
	ingeschakeld waren.  In <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">ipf</span>(5)</span></a> is een lijst met
	letters en bijbehorende vlaggen te vinden.</p><p>Als het pakket een ICMP pakket is, dan worden aan het
	einde twee velden toegevoegd.  Het eerste is altijd
	<code class="literal">ICMP</code> en het volgende het ICMP bericht en
	subbericht type, gescheiden door een slash, bijvoorbeeld
	<code class="literal">ICMP 3/3</code> voor <span class="quote">&#8220;<span class="quote">een poort niet
	  bereikbaar</span>&#8221;</span> bericht.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="firewalls-ipf-rules-script"></a>30.5.9. Script met regels met substitutie bouwen</h3></div></div></div><p>Geoefende gebruikers van IPF maken een bestand dat de
	regels bevat en stellen dat op zo'n manier op dat het
	uitgevoerd kan worden als een script met substitutie.  Het
	grote voordeel van deze werkwijze is dat er dan alleen de
	waarde geassocieerd met een symbolische naam gewijzigd hoeft te worden
	en dat als het script opnieuw wordt uitgevoerd, op alle plaatsen
	waar de variabele wordt gebruikt, de nieuwe waarde in de
	regels wordt opgenomen.  Omdat het een script is, kan
	substitutie gebruik worden om vaak voorkomende waarden
	de definiëren zodat ze in meerdere regels vervangen
	kunnen worden.  Dit wordt geïllustreerd in het
	onderstaande voorbeeld.</p><p>De syntaxis die in het script wordt gebruikt is
	compatibel met de shells <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=csh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">csh</span>(1)</span></a> en <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tcsh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tcsh</span>(1)</span></a>.</p><p>Velden waarvoor substitutie van toepassing is worden
	vooraf gegaan door het dollarteken
	<code class="literal">$</code>.</p><p>Definities worden niet vooraf gegaan door het voorvoegsel
	$.</p><p>De waarden van een definitie moet omsloten worden door
	dubbele aanhalingstekens (<code class="literal">"</code>).</p><p>Een set regels begint wellicht als volgt:</p><pre class="programlisting">############## Begin IPF regels script #########################
oif="dc0"            # naam van de uitgaande interface
odns="192.0.2.11"    # IP adres van DNS server ISP
myip="192.0.2.7"     # statische IP adres gekregen van ISP
ks="keep state"
fks="flags S keep state"

# Er kan gekozen worden om dit script te gebruiken om een eigen
# /etc/ipf.rules script te maken of dit script kan gebruikt worden
# "as is"
#
# Haal bij één van deze regels het commentaarteken weg
# en plaats hem bij de ander.
#
# 1) Deze kan gebruikt worden om /etc/ipf.rules te maken:
#cat &gt; /etc/ipf.rules &lt;&lt; EOF
# 2) Deze kan gebruikt worden om het script "as is" te starten:
# Let op: er moet een lege regel zijn na het EOF teken.
/sbin/ipf -Fa -f - &lt;&lt; EOF

# Verleen toegang tot de DNS van de ISP.
pass out quick on $oif proto tcp from any to $odns port = 53 $fks
pass out quick on $oif proto udp from any to $odns port = 53 $ks

# Sta uitgaand verkeer voor niet beveiligd www verkeer toe
pass out quick on $oif proto tcp from $myip to any port = 80 $fks

# Sta uitgaand verkeer voor beveiligd www verkeer toe (https over TLS SSL)
pass out quick on $oif proto tcp from $myip to any port = 443 $fks
EOF
################## Einde IPF regels script ########################</pre><p>Dat is alles.  De regels zijn niet van belang in dit
	voorbeeld, maar tonen hoe substitutievelden worden
	gedefinieerd en hoe ze worden gebruikt.  Als het bovenstaande
	voorbeeld de inhoud van
	<code class="filename">/etc/ipf.rules.script</code> was, dan konden deze regels
	herladen worden door het vanaf de commandoregel aan te roepen:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh /etc/ipf.rules.script</code></strong></pre><p>Er is wel een probleem met het gebruik van regels in
	combinatie met substitutie.  IPF snapt het niet en kan deze
	scripts niet direct lezen.</p><p>Dit script kan gebruikt worden op één van de
	volgende twee manieren:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Haal het commentaarteken weg bij de regel die begint met
	    <code class="literal">cat</code> en zet het commentaarteken bij de
	    regel die begint met <code class="literal">/sbin/ipf</code>.  Plaats
	    <code class="literal">ipfilter_enable="YES"</code> in
	    <code class="filename">/etc/rc.conf</code> zoals gewoonlijk en start
	    het script eenmalig na elke wijziging om
	    <code class="filename">/etc/ipf.rules</code> te maken of bij te
	    werken.</p></li><li class="listitem"><p>Schakel IPFILTER uit in de systeem opstart scripts door
	    <code class="literal">ipfilter_enable="NO"</code> toe te voegen aan
	    <code class="filename">/etc/rc.conf</code> (dit is de
	    standaardwaarde).</p><p>Voeg een script zoals de volgende toe aan de opstartmap
	    <code class="filename">/usr/local/etc/rc.d</code>.  Het
	    script zou een duidelijke naam moeten hebben zoals
	    <code class="filename">ipf.loadrules.sh</code>.  De uitbreiding
	    <code class="filename">.sh</code> is noodzakelijk.</p><pre class="programlisting">#!/bin/sh
sh /etc/ipf.rules.script</pre><p>De permissies op dit script moeten zijn: lezen,schrijven
	    en uitvoeren voor de gebruiker <code class="systemitem">root</code>.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chmod 700 /usr/local/etc/rc.d/ipf.loadrules.sh</code></strong></pre></li></ul></div><p>Als het systeem nu herstart, worden de regels via het
	script gestart.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88257232"></a>30.5.10. Sets van IPF regels</h3></div></div></div><p>Een set regels is een groep IPF-regels
	die is gemaakt om pakketten toe te staan of te blokkeren op
	basis van de eigenschappen van dat pakket.  De
	bi-directionele uitwisseling van pakketten tussen hosts
	bestaat uit een gesprek dat een sessie heet.  De set van
	firewallregels verwerkt zowel de pakketten die arriveren van het
	publieke Internet, als de pakketten die door het systeem zijn
	geproduceerd als een antwoord erop.  Elke
	<acronym class="acronym">TCP/IP</acronym>-dienst (telnet, www, mail, enzovoorts) is
	vooraf gedefinieerd door een protocol en bevoorrechte (luister)poort.
	Pakketten bedoeld voor een speciale dienst beginnen bij het bronadres
	gebruik makend van een onbevoorrechte (hogere orde) poort en komen aan
	bij de specifieke dienstpoort op het bestemmingsadres.  Alle
	bovengenoemde parameters (poorten en adressen) kunnen gebruikt worden
	als selectiecriteria om regels aan te maken die diensten zullen toestaan
	of blokkeren.</p><a id="idp88258640" class="indexterm"></a><p>IPF is oorspronkelijk geschreven met logica die regels
	verwerkte volgens het principe <span class="quote">&#8220;<span class="quote">de laatst passende
	regel wint</span>&#8221;</span> en gebruikte toen alleen staatloze regels.
	In de loop der tijd is IPF verbeterd en zijn de opties
	<span class="quote">&#8220;<span class="quote">quick</span>&#8221;</span> en <span class="quote">&#8220;<span class="quote">keep state</span>&#8221;</span> toegevoegd
	waarmee de logica van het verwerken van regels drastisch is
	gemoderniseerd.</p><p>De instructies in dit hoofdstuk zijn gebaseerd op regels
	die gebruik maken van de optie <span class="quote">&#8220;<span class="quote">quick</span>&#8221;</span>
	en de stateful optie <span class="quote">&#8220;<span class="quote">keep state</span>&#8221;</span>.  Dit
	is het raamwerk waarmee een set van inclusieve firewallregels
	wordt samengesteld.</p><div xmlns="" class="warning"><h3 class="admontitle">Waarschuwing: </h3><p xmlns="http://www.w3.org/1999/xhtml">Werk bij het wijzigen van firewallregels <span class="emphasis"><em>zeer
	    voorzichtig</em></span>.  Met sommige instellingen is een
	  server <span class="emphasis"><em>niet meer bereikbaar</em></span>.  Om het
	  veilig te spelen is het aan te raden de eerste instellingen
	  vanaf het console te maken, in plaats van via
	  <span class="application">ssh</span>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88272976"></a>30.5.11. Regelsyntaxis</h3></div></div></div><a id="idp88273616" class="indexterm"></a><p>De regelsyntaxis die hier wordt besproken is versimpeld
	door alleen de moderne stateful regels en de <span class="quote">&#8220;<span class="quote">eerste
	  van toepassing zijnde regel wint</span>&#8221;</span> te belichten.  De
	complete regelsyntaxis is na te lezen in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipf&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipf</span>(8)</span></a>.</p><p>Het karakter <code class="literal">#</code> wordt gebruikt om het
	begin van een opmerking te markeren en zowel op een eigen
	regel als achter een firewallregel staan.  Lege regels worden
	genegeerd.</p><p>Regels bevatten sleutelwoorden die in een bepaalde
	volgorde van links naar rechts op een regel horen te staan.
	Sleutelwoorden worden vet weergegeven.  Sommige
	sleutelwoorden hebben subopties die zelf ook weer
	sleutelwoorden hebben die ook weer subopties kunnen hebben.
	Alle opties die hier direct onder staan, worden daaronder
	uitgebreid weergegeven en verderop in dit hoofdstuk in een
	aparte paragraaf behandeld.</p><p><em class="replaceable"><code>ACTIE IN/UIT OPTIES SELECTIE STATEFUL
	  PROTO BRON_ADR,BEST_ADR OBJECT POORT_NUM TCP_VLAG
	  STATEFUL</code></em></p><p><em class="replaceable"><code>ACTIE</code></em> = block | pass</p><p><em class="replaceable"><code>IN/UIT</code></em> = in | out</p><p><em class="replaceable"><code>OPTIES</code></em> = log | quick | on
	interfacenaam</p><p><em class="replaceable"><code>SELECTIE</code></em> = protowaarde |
	bron/bestemming IP | poort = nummer | flags
	flag-value</p><p><em class="replaceable"><code>PROTO</code></em> = tcp/udp | udp | tcp |
	icmp</p><p><em class="replaceable"><code>BRON_ADR,BEST_ADR</code></em> = all | from
	object to object</p><p><em class="replaceable"><code>OBJECT</code></em> = IP adres | any</p><p><em class="replaceable"><code>POORT_NUM</code></em> = poortnummer</p><p><em class="replaceable"><code>TCP_VLAG</code></em> = S</p><p><em class="replaceable"><code>STATEFUL</code></em> = keep state</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88285008"></a>30.5.11.1. ACTIE</h4></div></div></div><p>De actie geeft aan wat er met het pakket gedaan moet
	  worden als het van toepassing is op de rest van de
	  filterregel.  Iedere regel <span class="emphasis"><em>moet</em></span> een
	  actie hebben.  De volgende acties zijn mogelijk:</p><p><code class="literal">block</code> geeft aan dat het pakket
	  moet verdwijnen als de parameters van toepassing zijn op
	  het pakket.</p><p><code class="literal">pass</code> geeft aan dat het pakket
	  doorgelaten moet worden als de parameters van toepassing
	  zijn op het pakket.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88287952"></a>30.5.11.2. IN/UIT</h4></div></div></div><p>Een verplicht onderdeel voor iedere filterregel waarin
	  expliciet wordt aangegeven op welke zijde van de in/uit
	  deze van toepassing is.  Het volgende sleutelwoord moet
	  <code class="literal">in</code> of <code class="literal">out</code>
	  zijn en één van de twee moet gecodeerd worden, anders
	  is de regel syntactisch onjuist.</p><p><code class="literal">in</code> betekent dat de regel van
	  toepassing is op inkomende pakketten.</p><p><code class="literal">out</code> betekent dat de regel van
	  toepassing is op inkomende pakketten.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88291152"></a>30.5.11.3. OPTIES</h4></div></div></div><div xmlns="" class="note"><h3 class="admontitle">Opmerking: </h3><p xmlns="http://www.w3.org/1999/xhtml">Deze opties moeten in de volgorde waarin ze hier
	    beschreven staan gebruikt worden.</p></div><p><code class="literal">log</code> geeft aan dat het pakket naar het
	  <code class="filename">ipl</code> logboekbestand geschreven moeten
	  worden (zoals verderop beschreven staat in de paragraaf
	  <span class="quote">&#8220;<span class="quote">Loggen</span>&#8221;</span>) als de regel van toepassing is op
	  het pakket.</p><p><code class="literal">quick</code> geeft aan dat als een regel van
	  toepassing is, dat de laatste regel moet zijn die wordt
	  gecontroleerd, waardoor er een pad wordt
	  <span class="quote">&#8220;<span class="quote">kortgesloten</span>&#8221;</span> waardoor de volgende regels voor
	  dat pakket niet meer gecontroleerd worden.  Deze optie is
	  voor de moderne regels eigenlijk verplicht.</p><p><code class="literal">on</code> geeft de interface aan die in de
	  parameters meegenomen moet worden.  De namen van interfaces
	  kunnen getoond worden met <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ifconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ifconfig</span>(8)</span></a>.  Als deze optie
	  wordt gebruikt, kan een regel alleen van toepassing zijn als
	  het pakket door de aangegeven interface gaat in de richting
	  die is aangegeven
	  (<code class="literal">in</code>/<code class="literal">out</code>).  Ook deze
	  optie is verplicht voor de moderne regels.</p><p>Als een pakket wordt gelogd, dan worden de koppen van het
	  pakket weggeschreven naar het <acronym class="acronym">ipl</acronym>
	  pakketloggende pseudo-apparaat.  Direct na het
	  sleutelwoord <code class="literal">log</code> mogen de volgende opties
	  gebruikt worden (in de aangegeven volgorde):</p><p><code class="literal">body</code> geeft aan dat de eerste 128 bytes
	  van de inhoud van het pakket worden opgeslagen na de
	  kop.</p><p><code class="literal">first</code>; als het sleutelwoord
	  <code class="literal">log</code> samen met een optie <code class="literal">keep
	    state</code> wordt gebruikt, wordt het aangeraden om
	  deze optie ook te gebruiken zodat alleen het pakket dat als
	  eerste in de sessie van toepassing was en niet ook alle
	  pakketten die daarna in de sessie volgens
	  <code class="literal">keep state</code> van toepassing
	  zijn.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88313424"></a>30.5.11.4. SELECTIE</h4></div></div></div><p>De sleutelwoorden in deze paragraaf worden gebruikt om
	  attributen van het pakket dat wordt geïnspecteerd te
	  beschrijven om te bepalen of een regel wel of niet van
	  toepassing is.  Er is een sleutelwoord
	  <code class="option">subject</code> en er zijn subopties waarvan er
	  één of meer gekozen moeten worden.  De
	  volgende attributen zijn beschikbaar voor het proces en
	  moeten in de aangegeven volgorde worden gebruikt:</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88315088"></a>30.5.11.5. PROTO</h4></div></div></div><p><code class="literal">proto</code> is het <code class="option">subject</code>
	  sleutelwoord dat moet worden aangegeven samen met een van de
	  sleutelwoorden uit de subopties.  De waarde geeft een bepaald
	  protocol aan dat van toepassing moet zijn.  Ook deze optie is
	  verplicht voor de moderne regels.</p><p><code class="literal">tcp/udp</code>, <code class="literal">tcp</code>,
	  <code class="literal">udp</code>, <code class="literal">icmp</code> of ieder
	  ander protocol dat in <code class="filename">/etc/protocols</code>
	  staat wordt herkend en kan gebruikt worden.  Het bijzondere
	  protocolsleutelwoord <code class="literal">tcp/udp</code> kan gebruikt
	  worden om zowel voor <acronym class="acronym">TCP</acronym>- als
	  <acronym class="acronym">UDP</acronym>-pakketten van toepassing te laten zijn.  Het is
	  toegevoegd voor het gemak om vrijwel gelijke regels te
	  voorkomen.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88320336"></a>30.5.11.6. BRON_ADR/BEST_ADR</h4></div></div></div><p>Het sleutelwoord <code class="literal">all</code> is in feite
	  hetzelfde als <code class="literal">from any to any</code> zonder
	  overige parameters.</p><p><code class="literal">from bron to bestemming</code>; de
	  sleutelwoorden <code class="literal">from</code> en
	  <code class="literal">to</code> worden gebruikt om te testen op
	  <acronym class="acronym">IP</acronym>-adressen.  In regels moet
	  <span class="emphasis"><em>zowel</em></span> een bron- <span class="emphasis"><em>als</em></span>
	  bestemmings-<acronym class="acronym">IP</acronym>-adres
	  aangegeven worden.  <code class="literal">any</code> is een
	  bijzonder sleutelwoord dat van toepassing is op ieder
	  <acronym class="acronym">IP</acronym>-adres.  Voorbeelden van gebruik: <code class="literal">from
	    any to any</code> of <code class="literal">from 0.0.0.0/0 to any</code> of
	  <code class="literal">from any to 0.0.0.0/0</code> of <code class="literal">from 0.0.0.0 to
	    any</code> of <code class="literal">from any to 0.0.0.0</code>.</p><p>Het is vaak lastig om te komen tot een reeks IP-adressen die zich
	  niet gemakkelijk laten uitdrukken met de gepunte numerieke vorm/
	  maskerlengte notatie.  De port <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/net-mgmt/ipcalc/pkg-descr">net-mgmt/ipcalc</a> kan gebruikt worden om de
	  berekeningen te vereenvoudigen.  Aanvullende informatie is beschikbaar
	  op de webpagina van het gereedschap: <code class="uri"><a class="uri" href="http://jodies.de/ipcalc" target="_top">http://jodies.de/ipcalc</a></code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88333392"></a>30.5.11.7. POORT</h4></div></div></div><p>Als in een regel op een poort wordt gecontroleerd, voor
	  bron- of bestemmingspoort of beiden, dan is dat alleen van
	  toepassing op <acronym class="acronym">TCP</acronym>- en
	  <acronym class="acronym">UDP</acronym>-pakketten.  Bij het maken van
	  poortvergelijkingen kunnen zowel de dienstnamen uit
	  <code class="filename">/etc/services</code> als een uit een
	  natuurlijk getal bestaand poortnummer ingesteld worden.  Als
	  de poort onderdeel is van het <code class="literal">from</code> object
	  dan wordt het vergeleken met het poortnummer van de bron en
	  als het onderdeel is van het <code class="literal">to</code> object,
	  dan wordt het vergeleken met het poortnummer van de
	  bestemming.  Het gebruik van het <code class="literal">to</code> object
	  is in de moderne regels verplicht en neemt de vorm aan van
	  <code class="literal">from any to any port = 80</code>.</p><p>Enkelvoudige poortvergelijkingen kunnen op verschillende manieren
	  gedaan worden met een aantal verschillende operatoren.
	  Er kunnen ook reeksen van poorten ingesteld worden.</p><p>poort "=" | "!=" | "&lt;" | "&gt;" | "&lt;=" | "&gt;=" |
	  "eq" | "ne" | "lt" | "gt" | "le" | "ge"</p><p>Reeksen van poorten worden met de volgende optie
	  aangegeven: poort &lt;&gt; | &gt;&lt;</p><div xmlns="" class="warning"><h3 class="admontitle">Waarschuwing: </h3><p xmlns="http://www.w3.org/1999/xhtml">De volgende twee parameters die betrekking hebben op
	    bron en bestemming, zijn verplicht in de moderne
	    regels.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88339536"></a>30.5.11.8. <acronym class="acronym">TCP</acronym>_VLAG</h4></div></div></div><p>Vlaggen zijn alleen beschikbaar voor het filteren
	  van <acronym class="acronym">TCP</acronym>.  De letters staan voor
	  de mogelijke vlaggen die bekeken kunnen worden in de
	  kop van een <acronym class="acronym">TCP</acronym>-pakket.</p><p>In de moderne regels wordt de optie <code class="literal">flags
	    S</code> gebruikt om het verzoek tot het starten van
	  een <acronym class="acronym">TCP</acronym> sessie.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88342864"></a>30.5.11.9. STATEFUL</h4></div></div></div><p><code class="literal">keep state</code> geeft aan dat in een regel
	  met <code class="literal">pass</code> voor alle pakketten die van
	  toepassing zijn stateful gefilterd moet worden.</p><div xmlns="" class="note"><h3 class="admontitle">Opmerking: </h3><p xmlns="http://www.w3.org/1999/xhtml">Deze optie is voor moderne regels verplicht.</p></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88349776"></a>30.5.12. Stateful filteren</h3></div></div></div><a id="idp88350416" class="indexterm"></a><p>Met stateful filteren wordt verkeer benaderd als een
	uitwisseling van pakketten tussen twee kanten die een sessie
	zijn.  Als het is ingeschakeld, dan maakt het
	<code class="option">keep state</code> mechanisme dynamisch interne
	regels voor pakketten die in de sessie horen te volgen.  Het
	kan bekijken of de karakteristieken van de sessie tussen
	verzender en ontvanger de juiste procedure volgen.  Alle
	pakketten die niet passen in de sessie, worden automatisch
	geblokkeerd.</p><p><code class="literal">keep state</code> staat ook
	<acronym class="acronym">ICMP</acronym>-pakketten toe die gerelateerd zijn aan een
	<acronym class="acronym">TCP</acronym>- of <acronym class="acronym">UDP</acronym>-sessie.  Dus als er
	een <acronym class="acronym">ICMP</acronym>-type 3 code 4 komt in antwoord op
	websurfen, dat wordt toegestaan van binnen naar buiten door een
	<code class="literal">keep state</code> regel, dan wordt dat toegelaten.
	Pakketten waarvan IPF zeker is dat ze onderdeel zijn van de
	sessie worden toegelaten, zelfs als ze van een ander protocol
	zijn.</p><p>Wat er gebeurt: pakketten die naar buiten gaan op de
	interface die met Internet is verbonden worden eerst
	vergeleken met de dynamische staattabel.  Als een pakket
	voldoet aan de verwachting van het volgende pakket in de
	sessie, dan mag het de firewall verlaten en wordt de
	toestand van de sessie in de dynamische toestandstabel bijgewerkt.
	Pakketten die niet bij een reeds actieve sessie horen, worden tegen de
	uitgaande regelverzameling gecontroleerd.</p><p>Pakketten die binnenkomen op de interface die met
	Internet is verbonden worden eerst vergeleken met de
	dynamische staattabel.  Als een pakket voldoet aan de
	verwachting van het volgende pakket in de sessie, dan mag het
	de firewall verlaten en wordt de toestand van de sessie in de dynamische
	toestandstabel bijgewerkt.  Pakketten die niet bij een reeds actieve
	sessie horen, worden vergeleken met de regelverzameling voor
	binnenkomend verkeer.</p><p>Als de sessie wordt beëindigd wordt het uit de
	dynamische staattabel verwijderd.</p><p>Met stateful filteren is het mogelijk om de focus te
	leggen op het blokkeren of toestaan van nieuwe sessies.
	Als een nieuwe sessie tot stand mag komen, dan worden alle
	volgende pakketten automatisch doorgelaten en al het
	vervalste verkeer wordt automatisch tegengehouden.  Als een
	nieuwe sessie wordt geweigerd, dan wordt geen enkel pakket
	doorgelaten.  Met stateful filteren zijn er uitgebreide
	mogelijkheden voor onderzoek om bescherming te bieden tegen
	de veelheid aan aanvallen die tegenwoordig door aanvallers
	worden uitgevoerd.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88356688"></a>30.5.13. Voorbeeld van inclusieve regels</h3></div></div></div><p>De onderstaande regels zijn een voorbeeld van hoe een
	erg veilige inclusieve firewall opgezet kan worden.  Een
	inclusieve firewall staat alleen diensten toe die passen bij
	de <code class="literal">pass</code>-regels en blokkeert al het
	overige verkeer.  Firewalls die bedoeld zijn om andere machines te
	beschermen, ook wel <span class="quote">&#8220;<span class="quote">netwerk-firewalls</span>&#8221;</span> genoemd, dienen
	tenminste twee interfaces te hebben, die over het algemeen zijn
	ingesteld om de ene kant te vertrouwen (het <acronym class="acronym">LAN</acronym>) maar
	niet de andere (het publieke Internet).  Ook kan een firewall worden
	ingesteld om alleen het systeem te beschermen waarop het
	draait&#8212;dit wordt een <span class="quote">&#8220;<span class="quote">host-gebaseerde firewall</span>&#8221;</span>
	genoemd, en is in het bijzonder geschikt voor servers op een onvertrouwd
	netwerk.</p><p>Alle <span class="trademark">UNIX</span>® systemen en dus ook FreeBSD zijn zo ontworpen
	dat ze voor interne communicatie de interface
	<code class="filename">lo0</code> en <acronym class="acronym">IP</acronym> adres
	<code class="systemitem">127.0.0.1</code> gebruiken.  De
	firewall moet dit interne verkeer gewoon doorgang laten
	vinden.</p><p>Voor de interface die is verbonden met het publieke
	Internet worden regels gemaakt waarmee de toegang voor uitgaande en
	binnenkomende verbindingen worden geautoriseerd en beheerst.
	Dit kan de PPP-interface <code class="filename">tun0</code> zijn of de
	netwerkkaart die is verbonden met een xDSL- of kabelmodem.</p><p>In gevallen dat er één of meer netwerkkaarten
	zijn aangesloten op private netwerksegmenten kunnen er regels
	op de firewall nodig zijn om pakketten die van die LAN-interfaces
	afkomen vrije doorgang te geven naar elkaar en/of naar buiten
	(het Internet).</p><p>De regels worden opgedeeld in drie onderdelen: eerst de vertrouwde
	interfaces, dan het publieke uitgaande interface en als laatste het
	onvertrouwde publieke binnenkomende interfaces.</p><p>In iedere sectie moeten zo staan dat de regels die het
	meest gebruikt worden vóór de regels die minder
	vaak gebruikt worden staan.  De laatste regel van een onderdeel
	geeft aan dat al het overige verkeer op die interface in die
	richting geblokkeerd en gelogd moet worden.</p><p>In het onderdeel Uitgaand staan alleen regels met
	<code class="literal">pass</code> die parameters bevatten om
	uniek individuele diensten identificeren die het publieke Internet mogen
	benaderen.  Bij al die regels staan de opties
	<code class="literal">quick</code>, <code class="literal">on</code>,
	<code class="literal">proto</code>, <code class="literal">port</code> en
	<code class="literal">keep state</code> aan.  De regels met
	<code class="literal">proto tcp</code> maken ook gebruik van de optie
	<code class="literal">flag</code> om te bekijken of het een pakket
	betreft voor het opzetten van een sessie om de stateful
	functionaliteit aan te sturen.</p><p>In het onderdeel Inkomend staan eerst alle regels voor het
	blokkeren van ongewenste pakketten, om twee redenen.
	Als eerste kan het zo zijn dat kwaadaardige pakketten gedeeltelijk
	overeenkomen met legitiem verkeer.  Deze pakketten moeten worden
	weggegooid in plaats van binnengelaten te worden, gebaseerd op hun
	gedeeltelijke match met de <code class="literal">allow</code>-regels.  De tweede
	reden is dat bekende en oninteressante verwerpingen stil geblokkeerd
	kunnen worden in plaats van gevangen en gelogd te worden door de
	laatste regels in de sectie.  De laatste regel in elke sectie blokkeert
	en logt alle pakketten en kan worden gebruikt voor het wettelijke bewijs
	nodig om degenen die uw systeem aanvallen aan te klagen.</p><p>Waar ook gezorgd voor moet worden is dat al het verkeer dat wordt
	geweigerd geen antwoord verstuurd.  Ongeldige pakketten dienen gewoon te
	verdwijnen.  Zo weet een aanvaller niet of een pakket het doelsysteem
	wel heeft bereikt.  Zo kan een aanvaller geen informatie verzamelen
	over een systeem: hoe minder informatie er over een systeem
	beschikbaar is, hoe meer tijd iemand erin moet steken voordat
	er iets slechts gedaan kan worden.  Regels die een optie <code class="literal">log
	  first</code> bevatten, zullen alleen de eerste keer dat de
	gebeurtenis voorkomt de gebeurtenis loggen.  Deze optie is opgenomen in
	de voorbeeldregel <code class="literal">nmap OS fingerpint</code>.  Het
	gereedschap <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/security/nmap/pkg-descr">security/nmap</a> wordt vaak
	door aanvallers gebruikt om het besturingssysteem van uw server
	proberen te achterhalen.</p><p>We raden aan om telkens als er logmeldingen van een regel
	met de optie <code class="literal">log first</code> komen,
	<code class="command">ipfstat -hio</code> uit te voeren om te
	bekijken hoe vaak de regel van toepassing is geweest.  Een groot aantal
	overeenkomsten geeft gewoonlijk aan dat de firewall overspoeld wordt,
	met andere woorden aangevallen wordt.</p><p>Het bestand <code class="filename">/etc/services</code> kan gebruikt worden
	om onbekende poortnummers op te zoeken.  Ook kan <code class="uri"><a class="uri" href="http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers" target="_top">http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers</a></code>
	worden bezocht en het poortnummer worden opgezocht om het doel van een
	bepaalde poort uit te vinden.</p><p>Op de volgende link worden poortnummers van Trojans
	beschreven: <code class="uri"><a class="uri" href="http://www.sans.org/security-resources/idfaq/oddports.php" target="_top">http://www.sans.org/security-resources/idfaq/oddports.php</a></code>.</p><p>De onderstaande set regels is een complete en erg veilige
	<code class="literal">inclusieve</code> set met regels voor een firewall die is
	getest op productiesystemen.  Deze set met regels is eenvoudig aan te
	passen voor uw eigen systeem.  Maak gewoon commentaar van elke
	<code class="literal">pass</code>-regel voor een dienst die niet gewenst
	is.</p><p>Logberichten die niet gewenst zijn, zijn uit te sluiten door een
	<code class="literal">block</code>-regel toe te voegen in het begin van het
	onderdeel Inkomend.</p><p>Voor de onderstaande regels dient de
	<code class="filename">dc0</code> interfacenaam in iedere regel
	vervangen te worden door de echte interfacenaam van de netwerkkaart
	in het systeem die met het publieke Internet is verbonden.
	Voor gebruikers van PPP zou dat <code class="filename">tun0</code>
	zijn.</p><p>Dit zou de inhoud van <code class="filename">/etc/ipf.rules</code>
	kunnen zijn:</p><pre class="programlisting">#################################################################
# Geen beperkingen op de interface aan de LAN kant.
# Niet nodig als er geen LAN is.
################################################################

#pass out quick on xl0 all
#pass in quick on xl0 all

#################################################################
# Geen beperkingen op de loopback interface
#################################################################
pass in quick on lo0 all
pass out quick on lo0 all

#################################################################
# Interface aan het publieke Internet (onderdeel Uitgaand).
# Inspecteer verzoeken om een sessie te starten van achter de
# firewall op het private netwerk of vanaf deze gateway-server
# naar het publieke Internet.
#################################################################

# Geef toegang tot de DNS server van de ISP.
# xxx moet het IP adres van de DNS van de ISP zijn.
# Dupliceer deze regels als een ISP meerdere DNS servers heeft.
# Haal het IP adres evt. uit /etc/resolv.conf.
pass out quick on dc0 proto tcp from any to xxx port = 53 flags S keep state
pass out quick on dc0 proto udp from any to xxx port = 53 keep state

# Geef toegang tot de DHCP server van de ISP voor kabel- en
# xDSL-netwerken. Deze regel is niet nodig als gebruik gemaakt worden
# van PPP naar het publieke Internet. In dat geval kan de hele groep
# verwijderd worden. Gebruik de volgende regel en controleer het
# logboek voor het IP adres. Wijzig dan het IP adres in de regel
# commentaar hieronder en verwijder de eerste regel.
pass out log quick on dc0 proto udp from any to any port = 67 keep state
#pass out quick on dc0 proto udp from any to z.z.z.z port = 67 keep state

# Sta niet beveiligd www verkeer toe.
pass out quick on dc0 proto tcp from any to any port = 80 flags S keep state

# Sta beveiligd www verkeer over TLS SSL toe.
pass out quick on dc0 proto tcp from any to any port = 443 flags S keep state

# Sta het verzenden en ontvangen van e-mail toe.
pass out quick on dc0 proto tcp from any to any port = 110 flags S keep state
pass out quick on dc0 proto tcp from any to any port = 25 flags S keep state

# Sta Time toe.
pass out quick on dc0 proto tcp from any to any port = 37 flags S keep state

# Sta uitgaand NNTP nieuws toe.
pass out quick on dc0 proto tcp from any to any port = 119 flags S keep state

# Sta uitgaande lokale niet beveiligde FTP (ook van LAN-gebruikers) toe
# (zowel passieve als actieve modes).  Deze functie maakt gebruik van
# de in IP-NAT ingebouwde FTP-proxy die in het bestand met NAT-regels
# staat om dit in één regel te laten werken. Als er met
# pkg_add pakketten toegevoegd moeten kunnen worden op een systeem, dan
# is deze regel nodig.
pass out quick on dc0 proto tcp from any to any port = 21 flags S keep state

# Sta uitgaande SSH/SFTP/SCP toe (vervangingen van telnet/rlogin/FTP)
# Deze functie maakt gebruik van SSH (secure shell)
pass out quick on dc0 proto tcp from any to any port = 22 flags S keep state

# Sta uitgaande niet beveiligde telnet toe.
pass out quick on dc0 proto tcp from any to any port = 23 flags S keep state

# Sta de FreeBSD CVSUP-functie toe.
pass out quick on dc0 proto tcp from any to any port = 5999 flags S keep state

# Sta ping toe naar het publieke Internet.
pass out quick on dc0 proto icmp from any to any icmp-type 8 keep state

# Sta whois toe vanaf het LAN naar het publieke Internet.
pass out quick on dc0 proto tcp from any to any port = 43 flags S keep state

# Blokkeer en log het eerste voorkomen van al het andere dat probeert
# buiten te komen. Deze regel implementeert de standaard-blokkade.
block out log first quick on dc0 all

#################################################################
# Interface aan het publieke Internet (onderdeel Inkomend).
# Inspecteert pakketten die van het publieke Internet komen
# met als bestemming deze gateway-server of het private netwerk.
#################################################################

# Blokkeer al het verkeer voor niet-routeerbare of gereserveerde
# adresreeksen.
block in quick on dc0 from 192.168.0.0/16 to any    #RFC 1918 privaat IP
block in quick on dc0 from 172.16.0.0/12 to any     #RFC 1918 privaat IP
block in quick on dc0 from 10.0.0.0/8 to any        #RFC 1918 privaat IP
block in quick on dc0 from 127.0.0.0/8 to any       #loopback
block in quick on dc0 from 0.0.0.0/8 to any         #loopback
block in quick on dc0 from 169.254.0.0/16 to any    #DHCP auto-config
block in quick on dc0 from 192.0.2.0/24 to any      #gereserveerd voor documentatie
block in quick on dc0 from 204.152.64.0/23 to any   #Sun cluster interconnect
block in quick on dc0 from 224.0.0.0/3 to any       #Klasse D &amp; E multicast

##### Blokkeer wat vervelende dingen ############
# die niet in de logboeken moeten komen.

# Blokkeer fragmenten.
block in quick on dc0 all with frags

# Block korte TCP pakketten.
block in quick on dc0 proto tcp all with short

# Blokkeer source gerouteerde pakketten.
block in quick on dc0 all with opt lsrr
block in quick on dc0 all with opt ssrr

# Blokkeer pogingen voor nmap OS fingerprint.
# Blokkeer het eerste voorkomen ervan voor de IP-adressen
block in log first quick on dc0 proto tcp from any to any flags FUP

# Blokkeer alles met speciale opties.
block in quick on dc0 all with ipopts

# Blokkeer publieke pings.
block in quick on dc0 proto icmp all icmp-type 8

# Blokkeer ident.
block in quick on dc0 proto tcp from any to any port = 113

# Blokkeer alle Netbios diensten. 137=naam, 138=datagram, 139=sessie.
# Netbios is de <span class="trademark">Windows</span>® bestandsdeeldienst.
# Blokkeer <span class="trademark">Windows</span>® hosts2 name server verzoeken 81.
block in log first quick on dc0 proto tcp/udp from any to any port = 137
block in log first quick on dc0 proto tcp/udp from any to any port = 138
block in log first quick on dc0 proto tcp/udp from any to any port = 139
block in log first quick on dc0 proto tcp/udp from any to any port = 81

# Sta inkomend verkeer toe van de DHCP server van de ISP. Deze regel
# moet het IP adres van de DHCP server van de ISP bevatten omdat die
# de enige toegestane bron van dit type pakketten moet zijn. Alleen
# van belang voor kabel en xDSL instellingen. Deze regel is niet nodig
# voor PPP verbindingen naar het publieke Internet.  Dit is hetzelfde
# IP adres dat in het Uitgaande onderdeel is opgezocht.
pass in quick on dc0 proto udp from z.z.z.z to any port = 68 keep state

# Sta inkomend webverkeer toe omdat er een Apache server draait.
pass in quick on dc0 proto tcp from any to any port = 80 flags S keep state

# Sta niet beveiligde telnet sessie toe vanaf het publieke Internet.
# Dit heeft het label <span class="quote">&#8220;<span class="quote">niet veilig</span>&#8221;</span> omdat gebruikersnaam en
# wachtwoord als platte tekst over Internet gaan. Als er geen telnet
# server draait, hoeft deze regel niet actief te zijn.
#pass in quick on dc0 proto tcp from any to any port = 23 flags S keep state

# Sta beveiligde FTP, telnet en SCP toe vanaf Internet.
# Deze functie gebruikt SSH (secure shell).
pass in quick on dc0 proto tcp from any to any port = 22 flags S keep state

# Blokkeer en log het eerste voorkomen van al het andere dat probeert
# binnen te komen. Het loggen van alleen het eerste voorkomen stopt
# een ontzegging van dienst aanval die gericht is op het laten
# vollopen van de partitie waarop de logboeken staan. Deze regel implementeert
# de standaard blokkade.
block in log first quick on dc0 all
################### Einde van de regels ###################################</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88387024"></a>30.5.14. <acronym class="acronym">NAT</acronym></h3></div></div></div><a id="idp88387792" class="indexterm"></a><a id="idp88404816" class="indexterm"></a><a id="idp88405968" class="indexterm"></a><a id="idp88407120" class="indexterm"></a><p><acronym class="acronym">NAT</acronym> staat voor <span class="emphasis"><em>Network Address
	  Translation</em></span> (netwerkadres vertaling).  In <span class="trademark">Linux</span>® heet dit
	IP Masquerading.  Een van de vele mogelijkheden die IPF
	<acronym class="acronym">NAT</acronym> kan bieden is het delen van
	één <acronym class="acronym">IP</acronym> adres op het publieke
	Internet met een LAN achter een firewall.</p><p>De vraag zou kunnen rijzen waarom iemand dat zou willen.
	ISP's wijzen normaliter namelijk dynamisch een
	<acronym class="acronym">IP</acronym> adres toe aan hun niet-commerciële
	gebruikers.  Dynamisch betekent hier dat het
	<acronym class="acronym">IP</acronym>-adres iedere dat er wordt ingebeld of
	dat het kabel- of xDSL-modem uit- en aangeschakeld wordt
	anders kan zijn.  Dit dynamische <acronym class="acronym">IP</acronym>-adres wordt
	gebruikt om uw systeem op het publieke Internet te identificeren.</p><p>Stel dat er vijf PC's in een huis staan en iedere
	computer in dat huis heeft toegang tot Internet nodig.  Dan
	zouden er bij een ISP vijf individuele accounts moeten zijn
	en vijf telefoonlijnen om dat te realiseren.</p><p>Met <acronym class="acronym">NAT</acronym> is er maar één
	account bij een ISP nodig.  De andere vier PC's moeten met kabels
	op een switch worden aangesloten waarop ook een FreeBSD systeem is
	aangesloten dat binnen uw LAN als gateway gaat opereren.
	<acronym class="acronym">NAT</acronym> zal automatisch de private LAN
	<acronym class="acronym">IP</acronym> adressen van alle PC's vertalen naar
	een enkel publiek <acronym class="acronym">IP</acronym>-adres als de
	pakketten de firewall naar het Internet verlaten.</p><p>Er is een speciale reeks van <acronym class="acronym">IP</acronym>-adressen
	gereserveerd voor <acronym class="acronym">NAT</acronym> op private LANs.
	Volgens RFC 1918 kunnen de volgende reeksen
	<acronym class="acronym">IP</acronym>-adressen gebruikt worden op private
	netwerken die nooit direct op het publieke Internet
	gerouteerd worden.</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /><col /></colgroup><tbody><tr><td>Eerste IP</td><td>&#8211;</td><td>Laatste IP</td></tr><tr><td><code class="systemitem">10.0.0.0</code></td><td>&#8211;</td><td><code class="systemitem">10.255.255.255</code></td></tr><tr><td><code class="systemitem">172.16.0.0</code></td><td>&#8211;</td><td><code class="systemitem">172.31.255.255</code></td></tr><tr><td><code class="systemitem">192.168.0.0</code></td><td>&#8211;</td><td><code class="systemitem">192.168.255.255</code></td></tr></tbody></table></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88426704"></a>30.5.15. IP<acronym class="acronym">NAT</acronym></h3></div></div></div><a id="idp88427600" class="indexterm"></a><a id="idp88428752" class="indexterm"></a><p><acronym class="acronym">NAT</acronym> regels worden geladen met
	<code class="command">ipnat</code>.  De <acronym class="acronym">NAT</acronym> regels worden vaak
	opgeslagen in <code class="filename">/etc/ipnat.rules</code>.  Meer details
	staan in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipnat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ipnat</span>(8)</span></a>.</p><p>Bij het maken van wijzigingen aan de
	<acronym class="acronym">NAT</acronym>-regels nadat <acronym class="acronym">NAT</acronym>
	gestart is, wordt aangeraden de wijziging aan het bestand met
	regels te maken en daarna <code class="command">ipnat</code>
	<code class="option">-CF</code> te gebruiken om alle actieve
	<acronym class="acronym">NAT</acronym>-regels te wissen.  Daarna kunnen de regels uit
	het bestand weer als volgt geladen worden:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ipnat -CF -f /etc/ipnat.rules</code></strong></pre><p>Gebruiksgegevens over <acronym class="acronym">NAT</acronym> kunnen
	getoond worden met:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ipnat -s</code></strong></pre><p>De huidige inhoud van de <acronym class="acronym">NAT</acronym> tabellen
	kan getoond worden met:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ipnat -l</code></strong></pre><p>Met het volgende commando kan de uitgebreide rapportage
	worden ingeschakeld en dan wordt informatie over het
	verwerken van verkeer en de actieve regels getoond:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ipnat -v</code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88448336"></a>30.5.16. IP<acronym class="acronym">NAT</acronym> regels</h3></div></div></div><p><acronym class="acronym">NAT</acronym> regels zijn erg flexibel en er
	kunnen veel dingen mee gedaan worden om behoeften van
	bedrijven en thuisgebruikers in te vullen.</p><p>De syntaxis van de regels die hier wordt toegelicht is
	vereenvoudigd om te passen bij een niet-commerciële
	omgeving.  De complete syntaxis is na te lezen in
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipnat&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">ipnat</span>(5)</span></a>.</p><p>De syntaxis voor een <acronym class="acronym">NAT</acronym> regel ziet er
	ongeveer als volgt uit:</p><pre class="programlisting">map <em class="replaceable"><code>IF</code></em> <em class="replaceable"><code>LAN_IP_REEKS</code></em> -&gt; <em class="replaceable"><code>PUBLIEK_ADRES</code></em></pre><p>De regel begint met het sleutelwoord
	<code class="literal">map</code>.</p><p><em class="replaceable"><code>IF</code></em> dient vervangen te worden
	door de aanduiding van de externe interface.</p><p><em class="replaceable"><code>LAN_IP_REEKS</code></em> is de reeks die
	clients op een LAN gebruiken, meestal iets van <code class="systemitem">192.168.1.0/24</code>.</p><p><em class="replaceable"><code>PUBLIEK_ADRES</code></em> kan het publieke
	<acronym class="acronym">IP</acronym> adres zijn of een speciaal sleutelwoord
	<code class="literal">0.32</code>, wat betekent dat het
	<acronym class="acronym">IP</acronym> adres van <em class="replaceable"><code>IF</code></em>
	gebruikt moet worden.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88458320"></a>30.5.17. Hoe <acronym class="acronym">NAT</acronym> werkt</h3></div></div></div><p>Een pakket komt vanaf het LAN aan bij de firewall en
	heeft een publieke bestemming.  Het wordt verwerkt door de
	filterregels voor inkomend verkeer en daarna krijgt
	<acronym class="acronym">NAT</acronym> de kans zijn regels op het pakket toe
	te passen.  De regels worden van boven naar beneden toegepast
	en de eerste regel die van toepassing is wint.
	<acronym class="acronym">NAT</acronym> controleert voor alle regels het
	pakket op interfacenaam en bron <acronym class="acronym">IP</acronym> adres.
	Als de interfacenaam van een pakket past bij een
	<acronym class="acronym">NAT</acronym> regel dan wordt het bron
	<acronym class="acronym">IP</acronym> adres van dat pakket gecontroleerd, dat
	is dus een <acronym class="acronym">IP</acronym> adres op het private LAN,
	om te bekijken of het valt in de reeks die is opgegeven aan
	de linkerkant van een <acronym class="acronym">NAT</acronym> regel.  Als ook
	dat klopt, dan wordt het bron <acronym class="acronym">IP</acronym> adres van
	het pakket vervangen (<span class="quote">&#8220;<span class="quote">rewritten</span>&#8221;</span>) door een
	publiek <acronym class="acronym">IP</acronym> adres dat verkregen kan zijn
	met het sleutelwoord <code class="literal">0.32</code>.
	<acronym class="acronym">NAT</acronym> werkt dan zijn interne
	<acronym class="acronym">NAT</acronym> tabel bij, zodat als er een pakket uit
	die sessie terugkomt van het publieke Internet, dat pakket
	weer gepast kan worden bij het originele private
	<acronym class="acronym">IP</acronym> adres en door de firewallregels
	gefilterd kan worden om daarna, als dat mag, naar een client
	gestuurd te worden.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88469584"></a>30.5.18. IP<acronym class="acronym">NAT</acronym> inschakelen</h3></div></div></div><p>Voor IP<acronym class="acronym">NAT</acronym> zijn de onderstaande
	instellingen in <code class="filename">/etc/rc.conf</code>
	beschikbaar.</p><p>Om verkeer tussen interfaces te kunnen routeren:</p><pre class="programlisting">gateway_enable="YES"</pre><p>Om IP<acronym class="acronym">NAT</acronym> automatisch te starten:</p><pre class="programlisting">ipnat_enable="YES"</pre><p>Om aan te geven waar de IP<acronym class="acronym">NAT</acronym> regels
	staan:</p><pre class="programlisting">ipnat_rules="/etc/ipnat.rules"</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88475088"></a>30.5.19. <acronym class="acronym">NAT</acronym> voor een groot LAN</h3></div></div></div><p>Voor netwerken met grote aantallen PC's of netwerken
	met meerdere LAN's kan het een probleem worden om al die
	private <acronym class="acronym">IP</acronym> adressen met één
	enkel publiek <acronym class="acronym">IP</acronym> adres te vervangen,
	omdat vaak dezelfde poortnummers gebruikt worden.  Er zijn
	twee manieren om dit probleem op te lossen.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88477392"></a>30.5.19.1. Aangeven welke poorten te gebruiken</h4></div></div></div><p>Een normale regel voor NAT ziet er als volgt uit:</p><pre class="programlisting">map dc0 192.168.1.0/24 -&gt; 0.32</pre><p>Met de bovenstaande regel blijft de bronpoort
	  ongewijzigd als het pakket door IP<acronym class="acronym">NAT</acronym>
	  gaat.  Door gebruik te maken van het sleutelwoord
	  <code class="literal">portmap</code> kan IP<acronym class="acronym">NAT</acronym>
	  ingesteld worden om alleen bronpoorten in de aangegeven reeks
	  te gebruiken.  Zo stelt de onderstaande regel in dat
	  IP<acronym class="acronym">NAT</acronym> de bronpoort aanpast naar een
	  poortnummer dat in de aangegeven reeks valt:</p><pre class="programlisting">map dc0 192.168.1.0/24 -&gt; 0.32 portmap tcp/udp 20000:60000</pre><p>Het kan nog eenvoudiger door gebruik te maken van het
	  sleutelwoord <code class="literal">auto</code> zodat
	  IP<acronym class="acronym">NAT</acronym> zelf bepaalt welke poorten gebruikt
	  kunnen worden:</p><pre class="programlisting">map dc0 192.168.1.0/24 -&gt; 0.32 portmap tcp/udp auto</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88487120"></a>30.5.19.2. Meerdere publieke adressen gebruiken</h4></div></div></div><p>In grote netwerken komt er een moment waarop er gewoon
	  te veel adressen zijn om te bedienen met één
	  <acronym class="acronym">IP</acronym> adres.  Als er een blok van publiekelijke
	  IP adressen beschikbaar is, dan kunnen deze adressen
	  gebruikt worden in een <span class="quote">&#8220;<span class="quote">poel</span>&#8221;</span>, welke door
	  IP<acronym class="acronym">NAT</acronym> gebruikt kan worden om
	  één van de adressen te gebruiken als uitgaand
	  adres.</p><p>Bijvoorbeeld om alle pakketten te verstoppen achter
	  één een enkel IP adres:</p><pre class="programlisting">map dc0 192.168.1.0/24 -&gt; 204.134.75.1</pre><p>Een reeks van publiekelijke IP adressen kan gespecificeerd
	  worden met een netwerkmasker:</p><pre class="programlisting">map dc0 192.168.1.0/24 -&gt; 204.134.75.1-10</pre><p>of door gebruik van de CIDR notatie:</p><pre class="programlisting">map dc0 192.168.1.0/24 -&gt; 204.134.75.0/24</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88491984"></a>30.5.20. Poorten omleiden</h3></div></div></div><p>Het is erg gebruikelijk om een webserver, mailserver,
	database server en DNS server op verschillende computers
	op een LAN te draaien.  Het uitgaande verkeer van die
	servers kan dan met <acronym class="acronym">NAT</acronym>  afgehandeld
	worden, maar er moet ook ingesteld worden dat inkomend
	verkeer bij de juiste computer terecht komt.
	IP<acronym class="acronym">NAT</acronym> gebruikt daarvoor de opties in
	<acronym class="acronym">NAT</acronym> waarmee verkeer omgeleid kan worden.
	Als bijvoorbeeld een webserver op het LAN-adres <code class="systemitem">10.0.10.25</code> draait en het enkele publieke
	<acronym class="acronym">IP</acronym> adres zou <code class="systemitem">20.20.20.5</code> zijn, dan zou de regel er als volgt
	uit zien:</p><pre class="programlisting">rdr dc0 20.20.20.5/32 port 80 -&gt; 10.0.10.25 port 80</pre><p>of:</p><pre class="programlisting">rdr dc0 0.0.0.0/32 port 80 -&gt; 10.0.10.25 port 80</pre><p>Voor een DNS server op een LAN die ook vanuit Internet
	bereikbaar met zijn en die draait op <code class="systemitem">10.0.10.33</code> zou de regel er als
	volgt uit zien:</p><pre class="programlisting">rdr dc0 20.20.20.5/32 port 53 -&gt; 10.0.10.33 port 53 udp</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88498384"></a>30.5.21. FTP en <acronym class="acronym">NAT</acronym></h3></div></div></div><p>FTP is dinosaurus uit het tijdperk van voor Internet was
	zoals het nu is, toen onderzoeksinstellingen met elkaar
	verbonden waren via huurlijnen en FTP de aangewezen methode
	was om bestanden met elkaar uit te wisselen.  Maar bij het
	gebruik van FTP worden gebruikersnaam en wachtwoord als
	platte tekst verzonden en het protocol is nooit aangepast.
	FTP is er in twee smaken: actief en passief.  Het verschil
	zit 'm in hoe het datakanaal wordt opgezet.  De passieve
	variant is veiliger voor een gebruiker omdat bij deze variant
	beide communicatiekanalen door de cliënt zelf worden opgezet.
	Op de volgende pagina zijn details over FTP na te lezen: <code class="uri"><a class="uri" href="http://www.slacksite.com/other/ftp.html" target="_top">http://www.slacksite.com/other/ftp.html</a></code>.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88500176"></a>30.5.21.1. IP<acronym class="acronym">NAT</acronym>-regels</h4></div></div></div><p>IP<acronym class="acronym">NAT</acronym> heeft een speciale FTP-proxy
	  ingebouwd die kan worden ingeschakeld met een
	  <acronym class="acronym">NAT</acronym>-<code class="literal">map</code>-regel.  Die kan
	  al het uitgaande verkeer monitoren wat betreft
	  opstartverzoeken voor sessies voor actieve en passieve FTP en
	  dynamisch tijdelijke filterregels maken die alleen het
	  poortnummer dat echt in gebruik is voor het datakanaal
	  doorlaten.  Hiermee wordt een veiligheidsrisico dat normaal
	  gepaard gaat met FTP, namelijk het toestaan van grote reeksen
	  hoge poortnummers, weggenomen.</p><p>De volgende regel handelt al het FTP verkeer van het
	  LAN af:</p><pre class="programlisting">map dc0 10.0.10.0/29 -&gt; 0/32 proxy port 21 ftp/tcp</pre><p>De regel hieronder handelt het FTP verkeer van de
	  gateway zelf af:</p><pre class="programlisting">map dc0 0.0.0.0/0 -&gt; 0/32 proxy port 21 ftp/tcp</pre><p>Deze laatste regel handelt al het niet-FTP
	  verkeer voor het LAN af:</p><pre class="programlisting">map dc0 10.0.10.0/29 -&gt; 0/32</pre><p>De FTP-afbeeldregel hoort voor de
	  normale regels te staan.  Alle pakketten worden als eerste
	  vergeleken met de eerste regel en zo verder.  Eerst wordt
	  gekeken over de interfacenaam overeenkomt, daarna het
	  bron <acronym class="acronym">IP</acronym> adres van het LAN en dan of het
	  een FTP pakket is.  Als dat allemaal klopt, dan maakt de
	  speciale FTP proxy een tijdelijke filterregel die de
	  pakketten uit de FTP sessie naar binnen en buiten doorlaat
	  en ook NAT toepast op de FTP pakketten.  Alle pakketten
	  van het LAN die niet van het protocoltype FTP zijn en dus
	  niet bij de eerste regel passen, worden tegen de derde
	  regel gehouden die van toepassing is vanwege de interface
	  en bron <acronym class="acronym">IP</acronym> adres, zodat er dan
	  <acronym class="acronym">NAT</acronym> op toegepast wordt.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88510928"></a>30.5.21.2. IP<acronym class="acronym">NAT</acronym> FTP filterregels</h4></div></div></div><p>Als de <acronym class="acronym">NAT</acronym>-FTP-proxy wordt gebruikt
	  is er maar één filterregel voor FTP
	  nodig.  Zonder de FTP-proxy zouden er drie regels nodig
	  zijn:</p><pre class="programlisting"># Sta LAN client toe te FTP-en naar Internet
# Actieve en passieve modes
pass out quick on rl0 proto tcp from any to any port = 21 flags S keep state

# Sta opzetten van het datakanaal voor passieve mode toe voor hoge poorten
pass out quick on rl0 proto tcp from any to any port &gt; 1024 flags S keep state

# Laat het datakanaal van de FTP server binnen voor actieve mode
pass in quick on rl0 proto tcp from any to any port = 20 flags S keep state</pre></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="firewalls-pf.html">Terug</a> </td><td width="20%" align="center"><a accesskey="u" href="firewalls.html">Omhoog</a></td><td width="40%" align="right"> <a accesskey="n" href="firewalls-ipfw.html">Volgende</a></td></tr><tr><td width="40%" align="left" valign="top">30.4. De OpenBSD Packet Filter (PF) en <acronym class="acronym">ALTQ</acronym> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Begin</a></td><td width="40%" align="right" valign="top"> 30.6. IPFW</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>