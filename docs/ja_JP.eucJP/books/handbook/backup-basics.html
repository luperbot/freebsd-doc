<?xml version="1.0" encoding="euc-jp" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=euc-jp" /><title>16.9. バックアップの基本</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD ハンドブック" /><link rel="up" href="disks.html" title="第16章 ストレージ" /><link rel="prev" href="backups-floppybackups.html" title="16.8. フロッピーディスクへのバックアップ" /><link rel="next" href="disks-virtual.html" title="16.10. ネットワーク、メモリ、そしてファイルベースのファイルシステム" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">16.9. バックアップの基本</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="backups-floppybackups.html">戻る</a>〓</td><th width="60%" align="center">第16章 ストレージ</th><td width="20%" align="right">〓<a accesskey="n" href="disks-virtual.html">次へ</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="backup-basics"></a>16.9. バックアップの基本</h2></div></div></div><p>主なバックアッププログラムは
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a> の三つです。</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91427024"></a>16.9.1. ダンプとリストア</h3></div></div></div><a id="idp91427664" class="indexterm"></a><a id="idp91428816" class="indexterm"></a><a id="idp91429456" class="indexterm"></a><p>伝統的な <span class="trademark">UNIX</span>® のバックアッププログラムは
	<code class="command">dump</code> と <code class="command">restore</code> です。
	これらはファイルシステムによって作成されるファイル、リンク、
	ディレクトリといった抽象の下位にある、
	ディスクブロックの集合としてドライブを操作します。
	<code class="command">dump</code>
	はデバイス上のファイルシステム全体をバックアップします。
	ファイルシステムの一部分だけ、
	または二つ以上のファイルシステムにわたるディレクトリツリーをバックアップすることはできません。
	<code class="command">dump</code>
	はファイルおよびディレクトリをテープに書き込まずに、
	ファイルおよびディレクトリを含んだ raw データブロックを書き込みます。</p><div xmlns="" class="note"><h3 class="admontitle">注記: </h3><p xmlns="http://www.w3.org/1999/xhtml">ルートディレクトリで <code class="command">dump</code>
	を使った場合、
	<code class="filename">/home</code>, <code class="filename">/usr</code>
	など、他の多くのディレクトリはバックアップされません。
	これらのディレクトリは通常、
	他のファイルシステムへのマウントポイントであったり、
	シンボリックリンクとなっているためです。</p></div><p><code class="command">dump</code> には AT&amp;T UNIX のバージョン 6
	(およそ 1975 年) の初期から残っている癖があります。
	デフォルトのパラメタは、現在利用可能な高密度メディア
	(最大 62,182 ftpi) ではなく、9 トラックテープ (6250 bpi)
	に最適な値となっています。
	現在のテープドライブの容量を利用するために、
	これらのデフォルト値をコマンドラインで上書きしなければなりません。</p><a id="idp91434960" class="indexterm"></a><p><code class="command">rdump</code> と <code class="command">rrestore</code>
	を用いて他のコンピュータに接続されているテープドライブにネットワーク経由でデータをバックアップすることも可能です。
	どちらのプログラムもリモートのテープドライブにアクセスするために
	<code class="command">rcmd</code> および <code class="command">ruserok</code>
	に依存しています。
	したがって、バックアップを実行するユーザがリモートコンピュータの
	<code class="filename">.rhosts</code> ファイルに書かれていなければなりません。
	<code class="command">rdump</code> および <code class="command">rrestore</code>
	の引数はリモートコンピュータに適切なものを用いなければなりません。
	FreeBSD コンピュータから <code class="systemitem">komodo</code> と呼ばれる Sun
	に接続されている Exabyte テープへ <code class="command">rdump</code>
	するには以下のようにします。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/sbin/rdump 0dsbfu 54000 13000 126 komodo:/dev/nsa8 /dev/da0a 2&gt;&amp;1</code></strong></pre><p>注意: <code class="filename">.rhosts</code>
	認証を許可することには、セキュリティに関する暗黙の仮定があります。
	あなたの置かれている状況を注意深く調べてください。</p><p><code class="command">ssh</code> 越しに
	<code class="command">dump</code> と <code class="command">restore</code>
	をより安全な形で使うこともできます。</p><div class="example"><a id="idp91450960"></a><div class="example-title">例16.1 <span class="application">ssh</span> 越しの
	  <code class="command">dump</code> の利用</div><div class="example-contents"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/sbin/dump -0uan -f - /usr | gzip -2 | ssh1 -c blowfish \
          targetuser@targetmachine.example.com dd of=/mybigfiles/dump-usr-l0.gz</code></strong></pre></div></div><br class="example-break" /><p>または、環境変数 <code class="envar">RSH</code> を設定して、
	<code class="command">dump</code> の組み込み機能を利用する。</p><div class="example"><a id="idp91454416"></a><div class="example-title">例16.2 <code class="envar">RSH</code> を設定した <span class="application">ssh</span> 越しの <code class="command">dump</code> を利用</div><div class="example-contents"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>RSH=/usr/bin/ssh /sbin/dump -0uan -f targetuser@targetmachine.example.com:/dev/sa0</code></strong></pre></div></div><br class="example-break" /></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91457360"></a>16.9.2. <code class="command">tar</code></h3></div></div></div><a id="idp91458128" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> は AT&amp;T UNIX の バージョン 6 (1975 年ごろ)
	にまで遡ることができます。<code class="command">tar</code>
	はファイルシステムと協調して動作し、
	ファイルとディレクトリをテープに書き込みます。<code class="command">tar</code>
	は <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a>
	で使用可能なフルレンジのオプションには対応していませんが、
	<code class="command">tar</code> には <code class="command">cpio</code>
	が使用するような奇妙なコマンドパイプラインは必要ありません。</p><a id="idp91462736" class="indexterm"></a><p><code class="command">tar</code>
	の多くの版はネットワーク経由のバックアップには対応していません。
	FreeBSD が使用している GNU 版の <code class="command">tar</code> は、
	<code class="command">rdump</code>
	と同じ構文でリモートデバイスに対応しています。
	<code class="systemitem">komodo</code> と呼ばれる Sun に接続された Exabyte
	テープドライブに対して <code class="command">tar</code>
	を実行するには以下のようにします。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/usr/bin/tar cf komodo:/dev/nsa8 . 2&gt;&amp;1</code></strong></pre><p>リモートデバイスに対応していない版に対しては、パイプラインと
	<code class="command">rsh</code>
	を使用してリモートテープドライブにデータを送ることができます。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>tar cf - . | rsh hostname dd of=tape-device obs=20b</code></strong></pre><p>ネットワークを越えたバックアップのセキュリティを懸念しているなら、
	<code class="command">rsh</code> の代わりに <code class="command">ssh</code>
	を使うべきです。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91473616"></a>16.9.3. <code class="command">cpio</code></h3></div></div></div><a id="idp91474384" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cpio&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">cpio</span>(1)</span></a> は本来 <span class="trademark">UNIX</span>®
	ファイルを磁気メディアで交換するためのプログラムです。
	<code class="command">cpio</code> はバイトスワッピング、
	多くの異なるアーカイブフォーマットの書き込みオプションがあり
	(それ以外にも多数のオプションがあります)、
	パイプで他のプログラムにデータを渡すこともできます。
	この最後にあげた特徴が、<code class="command">cpio</code>
	をインストールメディアとしては優れた選択肢にしています。
	<code class="command">cpio</code>
	はディレクトリツリーの探索の機能はなく、ファイルリストは
	<code class="filename">stdin</code> からの入力でなくてはなりません。</p><a id="idp91482960" class="indexterm"></a><p><code class="command">cpio</code>
	はネットワーク経由のバックアップには対応していません。
	以下のようにパイプラインと <code class="command">rsh</code>
	を用いてリモートテープドライブにデータを送ることができます。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>for f in directory_list; do</code></strong>
<strong class="userinput"><code>find $f &gt;&gt; backup.list</code></strong>
<strong class="userinput"><code>done</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cpio -v -o --format=newc &lt; backup.list | ssh user@host "cat &gt; backup_device"</code></strong></pre><p><em class="replaceable"><code>directory_list</code></em>
	はバックアップしたいディレクトリのリストで、
	<em class="replaceable"><code>user</code></em>@<em class="replaceable"><code>host</code></em>
	はバックアップを実行したいユーザとホスト名の組であり、
	<em class="replaceable"><code>backup_device</code></em>
	はバックアップを書き込みたいデバイスです
	(たとえば <code class="filename">/dev/nsa0</code>)。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91489488"></a>16.9.4. <code class="command">pax</code></h3></div></div></div><a id="idp91490256" class="indexterm"></a><a id="idp91491536" class="indexterm"></a><a id="idp91492176" class="indexterm"></a><a id="idp91492688" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pax&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">pax</span>(1)</span></a> は <code class="command">tar</code> と
	<code class="command">cpio</code>	に対する IEEE/<span class="trademark">POSIX</span>®
	の回答です。長年の間、さまざまな版の
	<code class="command">tar</code> と <code class="command">cpio</code>
	は互いにわずかに非互換になってきていました。
	それらをしらみ潰しに標準化する代わりに、<span class="trademark">POSIX</span>®
	は新しいアーカイブユーティリティを作りました。
	<code class="command">pax</code>
	は、いくつもの <code class="command">cpio</code> や
	<code class="command">tar</code>
	のフォーマットの読み書きに対応しようと試みているほか、
	専用に新しいフォーマットを開発しました。
	コマンド群は <code class="command">tar</code> よりも
	<code class="command">cpio</code> の方にいくぶん似ています。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="backups-programs-amanda"></a>16.9.5. <span class="application">Amanda</span></h3></div></div></div><a id="idp91499984" class="indexterm"></a><a id="idp91501264" class="indexterm"></a><p><span class="application">Amanda</span> (Advanced Maryland
	Network Disk Archiver) は単一のプログラムではなく、
	クライアント/サーバ型のバックアップシステムです。
	<span class="application">Amanda</span> サーバは、
	<span class="application">Amanda</span> クライアントを有する
	ネットワークに接続されたコンピュータからデータを受け取り、
	備え付けられたテープドライブにバックアップします。
	いくつもの大容量ディスクを備えたサイトでの共通の問題は、
	データディレクトリをテープにバックアップするのに時間がかかりすぎることです。
	<span class="application">Amanda</span> はこの問題を解決します。
	<span class="application">Amanda</span> は
	<span class="quote">「<span class="quote">ホールディングディスク</span>」</span> を使用して、
	同時に複数のファイルシステムのバックアップを行うことができます。
	<span class="application">Amanda</span> の設定ファイルにかかれたすべてのファイルシステムのフルバックアップを特定の間隔でとるために
	<span class="quote">「<span class="quote">アーカイブセット</span>」</span> と呼ばれるテープグループを作成します。
	<span class="quote">「<span class="quote">アーカイブセット</span>」</span> には
	夜間に作成されるすべてのファイルシステムの増分 (または差分)
	のバックアップも含まれます。
	障害が起きたファイルシステムのリストアには、
	最も新しいフルバックアップと増分のバックアップが必要です。</p><p>設定ファイルでは、バックアップの制御と
	<span class="application">Amanda</span>
	によるネットワークトラフィック量を設定します。
	<span class="application">Amanda</span>
	は上記のバックアッププログラムのいずれかを使ってデータをテープに書き込みます。
	<span class="application">Amanda</span> は port または package
	として利用可能です。デフォルトではインストールされていません。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91515984"></a>16.9.6. 何もしない</h3></div></div></div><p><span class="quote">「<span class="quote">何もしない</span>」</span>
	というのはコンピュータのプログラムではありませんが、
	バックアップの戦略として最も広く採用されています。
	これには初期投資が必要ありません。
	従わなければならないバックアップスケジュールもありません。
	ただ何もしないだけです。データに何か起きたら苦笑いして耐えてください!</p><p>あなたにとって時間やデータの価値が少ないか、
	あるいはまったくないのであれば <span class="quote">「<span class="quote">何もしない</span>」</span>
	のはあなたのコンピュータに最も適したバックアッププログラムでしょう。
	しかし注意してください。<span class="trademark">UNIX</span>® は便利なツールです。
	6 ヶ月も使用していれば、
	あなたにとって価値のあるファイルの山が出来上がっているでしょう。</p><p><span class="quote">「<span class="quote">何もしない</span>」</span>
	ことはコンピュータが同じものをもう一度作り直すことのできる
	<code class="filename">/usr/obj</code>
	やその他のディレクトリツリーについては適切なバックアップ方法です。
	一例として、このハンドブックの HTML 版 または <span class="trademark">PostScript</span>®
	版を構成するファイルがあります。
	これらの文書形式は SGML ファイルから作成されたものです。
	HTML または <span class="trademark">PostScript</span>® ファイルのバックアップは必要ありません。
	SGML ファイルは定期的にバックアップされています。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91520848"></a>16.9.7. どのバックアッププログラムが最適ですか?</h3></div></div></div><a id="idp91542096" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> です。<span class="emphasis"><em>以上。</em></span>
	Elizabeth D. Zwicky
	はここで検討したプログラムすべてについて拷問的なテストを行いました。
	すべてのデータと <span class="trademark">UNIX</span>®
	ファイルシステムの状態すべてを保存するのに最適なのは、明らかに
	<code class="command">dump</code> です。
	Elizabeth は多種多様の特異な状態
	(いくつかはあまり珍しくないものもあります)
	を含むファイルシステムを作成し、
	それらのファイルシステムのバックアップとリストアを行って、
	それぞれのプログラムのテストを行いました。特異な状態とは、
	ホールがあるファイル、ホールとヌルブロックがあるファイル、
	奇妙な文字をファイル名に持つファイル、読み取り不可、
	書き込み不可のファイル、デバイスファイル、
	バックアップ中のファイルのサイズ変更、
	バックアップ中のファイルの作成および削除、などです。
	彼女は 1991 年 10 月の LISA V で結果を発表しています。
	<a class="link" href="http://berdmann.dyndns.org/zwicky/testdump.doc.html" target="_top">torture-testing Backup and Archive Programs</a>
	を参照してください。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91545808"></a>16.9.8. 緊急時のリストア手順</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91546448"></a>16.9.8.1. 惨事が起きる前に</h4></div></div></div><p>発生する可能性があるどのような惨事に対しても、
	  備えるのに必要な手順は以下の 4 ステップだけです。</p><a id="idp91547472" class="indexterm"></a><p>最初に、
	  各ディスクのディスクラベルとファイルシステムテーブル
	  (<code class="filename">/etc/fstab</code>)、
	  ブートメッセージ全体をそれぞれ 2 枚ずつ印刷します
	  (たとえば <code class="command">disklabel da0 | lpr</code>)。</p><a id="idp91549520" class="indexterm"></a><p>2 番目に、ブートフロッピーと fix-it フロッピー
	  (<code class="filename">boot.flp</code> および <code class="filename">fixit.flp</code>)
	  にそのシステムのデバイスがすべて含まれているか確認します。
	  最も簡単に確認する方法は、フロッピーをドライブに入れてマシンをリブートしてブートメッセージを確認することです。
	  あなたのシステムのデバイスのすべてが含まれ、
	  機能していれば 3 番目の手順に進んでください。</p><p>さもなければ、
	  そのシステムのすべてのディスクをマウントでき、
	  テープドライブにもアクセスできるカーネルを備えた
	  カスタムブートフロッピーを 2 枚作成する必要があります。
	  これらのフロッピーディスクには <code class="command">fdisk</code>,
	  <code class="command">disklabel</code>, <code class="command">newfs</code>,
	  <code class="command">mount</code>
	  と、利用するバックアッププログラムが入っていなければなりません。
	  これらのプログラムはスタティックリンクされていなければなりません。
	  <code class="command">dump</code> を使用するのなら、このフロッピーには
	  <code class="command">restore</code> も含まれていなければなりません。</p><p>3 番目に、定期的にバックアップテープを作成します。
	  最後のバックアップの後で行われた変更は、回復できずに失われます。
	  バックアップテープにライトプロテクトを施してください。</p><p>4 番目に、フロッピーディスク
	  (<code class="filename">boot.flp</code> と
	  <code class="filename">fixit.flp</code>、
	  か、第 2 段階で作成した
	  2 枚のカスタムブートフロッピーディスクのどちらか)
	  およびバックアップテープのテストをします。
	  手順のメモを作りましょう。
	  このメモはブートフロッピー、印刷した紙、
	  バックアップテープと一緒に保存しておきます。
	  リストアを行うときには、
	  このメモがバックアップテープを壊すのを防ぐくらい取り乱しているかもしれません
	  (どのように?
	  <code class="command">tar xvf /dev/sa0</code> の代わりに、うっかり
	  <code class="command">tar cvf /dev/sa0</code>
	  と入力してバックアップテープを上書きしてしまうかもしれません)。</p><div xmlns="" class="note"><h3 class="admontitle">訳注: </h3><p xmlns="http://www.w3.org/1999/xhtml">上書きはライトプロテクトをしておけば防げますが、
	    何らかの原因でプロテクトがはずれているかもしれません。
	    ちなみに訳者の経験から言えば、
	    上のようなミスタイプは結構起きます。</p></div><p>安全性を増すために、毎回、
	  ブートフロッピーを作成し、
	  2 巻のバックアップテープを取ります。
	  一方を離れた場所に保管します。
	  離れた場所は同じ事務所の建物の地下室ではいけません。
	  世界貿易センタービルにあった数多くの会社は、
	  苦い経験によりこの教訓を得ました。離れた場所とは、
	  コンピュータやディスクドライブから十分な距離を取って
	  物理的に分離されていなければなりません。</p><div class="example"><a id="idp91557968"></a><div class="example-title">例16.3 ブートフロッピーを作成するスクリプト</div><div class="example-contents"><pre class="programlisting">#!/bin/sh
#
# create a restore floppy
#
# format the floppy
#
PATH=/bin:/sbin:/usr/sbin:/usr/bin

fdformat -q fd0
if [ $? -ne 0 ]
then
	 echo "Bad floppy, please use a new one"
	 exit 1
fi

# place boot blocks on the floppy
#
disklabel -w -B /dev/fd0c fd1440

#
# newfs the one and only partition
#
newfs -t 2 -u 18 -l 1 -c 40 -i 5120 -m 5 -o space /dev/fd0a

#
# mount the new floppy
#
mount /dev/fd0a /mnt

#
# create required directories
#
mkdir /mnt/dev
mkdir /mnt/bin
mkdir /mnt/sbin
mkdir /mnt/etc
mkdir /mnt/root
mkdir /mnt/mnt			# for the root partition
mkdir /mnt/tmp
mkdir /mnt/var

#
# populate the directories
#
if [ ! -x /sys/compile/MINI/kernel ]
then
	 cat &lt;&lt; EOM
The MINI kernel does not exist, please create one.
Here is an example config file:
#
# MINI - A kernel to get FreeBSD onto a disk.
#
machine         "i386"
cpu             "I486_CPU"
ident           MINI
maxusers        5

options         INET                    # needed for _tcp _icmpstat _ipstat
                                        #            _udpstat _tcpstat _udb
options         FFS                     #Berkeley Fast File System
options         FAT_CURSOR              #block cursor in syscons or pccons
options         SCSI_DELAY=15           #Be pessimistic about Joe SCSI device
options         NCONS=2                 #1 virtual consoles
options         USERCONFIG              #Allow user configuration with -c XXX

config          kernel	root on da0 swap on da0 and da1 dumps on da0

device          isa0
device          pci0

device          fdc0	at isa? port "IO_FD1" bio irq 6 drq 2 vector fdintr
device          fd0	at fdc0 drive 0

device          ncr0

device          scbus0

device          sc0	at isa? port "IO_KBD" tty irq 1 vector scintr
device          npx0	at isa? port "IO_NPX" irq 13 vector npxintr

device          da0
device          da1
device          da2

device          sa0

pseudo-device   loop            # required by INET
pseudo-device   gzip            # Exec gzipped a.out's
EOM
	 exit 1
fi

cp -f /sys/compile/MINI/kernel /mnt

gzip -c -best /sbin/init &gt; /mnt/sbin/init
gzip -c -best /sbin/fsck &gt; /mnt/sbin/fsck
gzip -c -best /sbin/mount &gt; /mnt/sbin/mount
gzip -c -best /sbin/halt &gt; /mnt/sbin/halt
gzip -c -best /sbin/restore &gt; /mnt/sbin/restore

gzip -c -best /bin/sh &gt; /mnt/bin/sh
gzip -c -best /bin/sync &gt; /mnt/bin/sync

cp /root/.profile /mnt/root

cp -f /dev/MAKEDEV /mnt/dev
chmod 755 /mnt/dev/MAKEDEV

chmod 500 /mnt/sbin/init
chmod 555 /mnt/sbin/fsck /mnt/sbin/mount /mnt/sbin/halt
chmod 555 /mnt/bin/sh /mnt/bin/sync
chmod 6555 /mnt/sbin/restore

#
# create the devices nodes
#
cd /mnt/dev
./MAKEDEV std
./MAKEDEV da0
./MAKEDEV da1
./MAKEDEV da2
./MAKEDEV sa0
./MAKEDEV pty0
cd /

#
# create minimum file system table
#
cat &amp;gt; /mnt/etc/fstab &amp;lt;&amp;lt;EOM
/dev/fd0a    /    ufs    rw  1  1
EOM

#
# create minimum passwd file
#
cat &gt; /mnt/etc/passwd &lt;&lt;EOM
root:*:0:0:Charlie &amp;:/root:/bin/sh
EOM

cat &gt; /mnt/etc/master.passwd &lt;&lt;EOM
root::0:0::0:0:Charlie &amp;:/root:/bin/sh
EOM

chmod 600 /mnt/etc/master.passwd
chmod 644 /mnt/etc/passwd
/usr/sbin/pwd_mkdb -d/mnt/etc /mnt/etc/master.passwd

#
# umount the floppy and inform the user
#
/sbin/umount /mnt
echo "The floppy has been unmounted and is now ready."</pre></div></div><br class="example-break" /></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91563472"></a>16.9.8.2. 惨事の後は</h4></div></div></div><p>重要な問題は、ハードウェアが生き残ったかどうかです。
	  定期的にバックアップを取っていれば、
	  ソフトウェアについて心配する必要はありません。</p><p>ハードウェアに障害があれば、
	  コンピュータを使用する前にその部品を交換してください。</p><p>ハードウェアに問題が無ければ、フロッピーを確認してください。
	  カスタムブートフロッピーディスクを使用しているのであれば、
	  シングルユーザモードでブートして (<code class="prompt">boot:</code>
	  プロンプトで <code class="literal">-s</code> を入力します)、
	  次の段落は飛ばしてください。</p><p><code class="filename">boot.flp</code> と <code class="filename">fixit.flp</code>
	  を使用しているのであればこのまま読み進めてください。
	  <code class="filename">boot.flp</code>
	  フロッピーをフロッピードライブに入れて、
	  コンピュータを起動してください。
	  本来のインストールメニューが画面に表示されます。
	  <code class="literal">Fixit--Repair mode with CDROM or floppy.</code>
	  オプションを選択します。指示された通り
	  <code class="filename">fixit.flp</code> をいれてください。
	  <code class="command">restore</code> とその他必要となるプログラムは
	  <code class="filename">/mnt2/stand</code> にあります。</p><p>そして、ファイルシステムを一つずつ回復します。</p><a id="idp91569488" class="indexterm"></a><a id="idp91570384" class="indexterm"></a><a id="idp91579216" class="indexterm"></a><a id="idp91580112" class="indexterm"></a><p>最初のディスクのルートパーティションを <code class="command">mount</code>
	  してみてください (たとえば <code class="command">mount /dev/da0a /mnt</code>)。
	  ディスクラベルが破壊されている場合は、<code class="command">disklabel</code>
	  を用いてあらかじめ印刷して保存しておいた通りにパーティションを作り直し、ディスクラベルを作成してください。
	  <code class="command">newfs</code> を使用してファイルシステムを作り直します。
	  ルートパーティションを読み書き可能にマウントし直します
	  (<code class="command">mount -u -o rw /mnt</code>)。
	  バックアッププログラムとバックアップテープを使用して、
	  このファイルシステムのデータを回復します
	  (たとえば <code class="command">restore vrf /dev/sa0</code>)。
	  ファイルシステムをアンマウントします
	  (たとえば <code class="command">umount /mnt</code>)。
	  障害を受けたファイルシステムそれぞれについて繰り返してください。</p><p>システムが動き出したら、
	  新しいテープにデータをバックアップしてください。
	  どのような理由で再び事故が起きたり、データが失われるかわかりません。
	  これに数時間を費すことで、後々の災難から救われます。</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="backups-floppybackups.html">戻る</a>〓</td><td width="20%" align="center"><a accesskey="u" href="disks.html">上に戻る</a></td><td width="40%" align="right">〓<a accesskey="n" href="disks-virtual.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">16.8. フロッピーディスクへのバックアップ〓</td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top">〓16.10. ネットワーク、メモリ、そしてファイルベースのファイルシステム</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文書、および他の文書は
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>
    からダウンロードできます。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>FreeBSD に関する質問がある場合には、
    <a href="http://www.FreeBSD.org/ja/docs.html">ドキュメント</a> を読んだ上で
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt; まで (英語で) 連絡してください。<br></br>
    本文書に関する質問については、
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt; まで電子メールを (英語で) 送ってください。</small></p></body></html>