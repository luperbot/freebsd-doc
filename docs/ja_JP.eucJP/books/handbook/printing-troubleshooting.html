<?xml version="1.0" encoding="euc-jp" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=euc-jp" /><title>10.7. トラブルシューティング</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD ハンドブック" /><link rel="up" href="printing.html" title="第10章 プリンタの利用" /><link rel="prev" href="printing-lpd-alternatives.html" title="10.6. 標準スプーラの代替品" /><link rel="next" href="linuxemu.html" title="第11章 Linux バイナリ互換機能" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.7. トラブルシューティング</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="printing-lpd-alternatives.html">戻る</a>〓</td><th width="60%" align="center">第10章 プリンタの利用</th><td width="20%" align="right">〓<a accesskey="n" href="linuxemu.html">次へ</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="printing-troubleshooting"></a>10.7. トラブルシューティング</h2></div></div></div><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lptest&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">lptest</span>(1)</span></a> を使った簡単なテストをおこなった結果、
	    正しい出
	    力を得られずに、以下に示すような出力が得られるかもしれません。</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">しばらくしたら出力される、または、
		紙の全体が出てこない</span></dt><dd><p>プリンタは上で示されたような印字を
		  おこなったのですが、しばらくして止まってしまい、
		  動かなくなってしまいました。
		  印字された結果をプリンタから取り出すためには、
		  プリンタにある PRINT REMAINING ボタン、または、FORM
		  FEED ボタンを押す必要があるようです。</p><p>この場合は、
		  おそらくジョブはプリントをする前に
		  更にデータが送られてこないか待ち続けているのでしょう。
		  この問題を解決するためには、プリンタに FORM FEED
		  文字 (あるいは特定の必要な文字コード) を
		  送るテキストフィルタを使ってください。
		  プリンタ内部に残ったデータをプリンタにすぐに印字させるには、
		  普通はこれで十分です。
		  次のジョブが前のジョブの最終ページの中央の
		  どこかから印字を開始させないためにも、
		  紙の途中で印字のジョブが終了したかどうかを確認するのは有益です。</p><p>シェルスクリプト
		  <code class="filename">/usr/local/libexec/if-simple</code>
		  を次のように変更して、プリンタへジョブを送信した後に
		  FORM FEED 文字を印字させるようにします。</p><pre class="programlisting">#!/bin/sh
#
# if-simple - Simple text input filter for lpd
# Installed in /usr/local/libexec/if-simple
#
# Simply copies stdin to stdout.  Ignores all filter arguments.
# Writes a form feed character (\f) after printing job.

/bin/cat &amp;&amp; printf "\f" &amp;&amp; exit 0
exit 2</pre></dd><dt><span class="term"><span class="quote">「<span class="quote">階段効果</span>」</span> が現れた</span></dt><dd><p>出力された紙には次のように印字されていました。</p><pre class="screen">!"#$%&amp;'()*+,-./01234
                 "#$%&amp;'()*+,-./012345
                                 #$%&amp;'()*+,-./0123456</pre><p>あなたは<span class="emphasis"><em>「階段効果」</em></span>
		  の新たなる犠牲者になってしまいました。この原因は、
		  改行を表わすべき文字がなんであるか
                  の解釈が混乱していることにあります。<span class="trademark">UNIX</span>®
		  スタイルのオペレーティングシステムでは、改行文字は
		  ASCII<a id="idp87590864" class="indexterm"></a> コード 10 の line feed (LF)
		  の 1 文字が使われています。<span class="trademark">MS-DOS</span>®<a id="idp87591760" class="indexterm"></a>
		  や <span class="trademark">OS/2</span>®<a id="idp87592656" class="indexterm"></a> などは ASCII
		  コード 10の LF <span class="emphasis"><em>と</em></span>、ASCII コード
		  13 の文字 (carriage return または CR)
		  をペアで使います (訳注: Macintosh では CR
		  のみで表現されています)。大抵のプリンタでは、
		  改行を表わすために <span class="trademark">MS-DOS</span>® の慣習にしたがいます。</p><p>FreeBSD で印字する場合、印字したテキストは LF
		  文字だけ が使われていました。プリンタでは LF
		  文字を見つけると、紙を 1 行分送り出しました。しかし、
		  次の文字を印字するた
		  めの紙の水平方向の位置は維持されました。すなわち、CR
		  文字が意味することは、
		  次の文字を印字する位置を紙の左端に動かすことです。</p><p>FreeBSD
		  がプリンタに動作をして欲しいと思っている動作を以下に示します。
		</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><tbody><tr><td>プリンタが CR を受け取ったとき</td><td>CR 動作 (復帰) をおこなう</td></tr><tr><td>プリンタが LF を受け取ったとき</td><td>CR + LF 動作 (復帰、改行) をおこなう</td></tr></tbody></table></div><p>このように動作させるための方法がいくつかあります。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>これらの文字の解釈を変えるために、
		      プリンタの設定スイッチかコントロールパネルを操作する方法。
		      どのようにして設定をするかはプリンタのマニュアルを参照してください。</p><div xmlns="" class="note"><h3 class="admontitle">注記: </h3><p xmlns="http://www.w3.org/1999/xhtml">FreeBSD
			以外のオペレーティングシステムを切り替えて使う場合、
			CR と LF 文字の解釈をそのオペレーティングシステムで使われているようにプリンタを
			<span class="emphasis"><em>再設定</em></span>する必要があるかもしれません。
			以下に示す解決方法のいずれかを
			選ぶのがよいかもしれませんね。</p></div></li><li class="listitem"><p>自動的に LF を CR+LF に変換してくれる
		      FreeBSD 用のシリアルドライバを入手する方法。
		      もちろん、このドライバはプリンタ専用に接続される
		      シリアルポート
		      <span class="emphasis"><em>のみ</em></span>で動作します。
		      この機能を許可するためには、
		      <code class="literal">ms#</code> 項目を使い、
		      対象プリンタの <code class="filename">/etc/printcap</code>
		      ファイルで<code class="literal">onlcr</code> モードを設定します。</p></li><li class="listitem"><p>LF
		      文字の扱いを一時的に変更するための
		      <span class="emphasis"><em>エスケープコード</em></span>
		      をプリンタに送る方法。
		      プリンタがサポートしているかもしれないエスケープコード
		      については、
		      プリンタのマニュアルを参照してください。
		      適切なエスケープコードが見つかったら、
		      最初にそのコードを送り、次にプリントジョブを送信
		      するようにテキストフィルタを変更してください。
		    </p><a id="idp87621200" class="indexterm"></a><p>次に、Hewlett Packard 社の PCL
		      エスケープコードに対応しているプリンタのための
		      テキストフィルタの例を示します。
		      このフィルタでは、プリンタ に
		      LF 文字を LF と CR の2文字として扱わせます。
		      その後に、プリンタにジョブを送ります。最後に、
		      ジョブの最終ページの紙を排出するため、FROM FEED
		      文字を送ります。このフィルタは Hewlett Packard
		      社のほとんどすべてのプリンタで機能するはずです。</p><pre class="programlisting">#!/bin/sh
#
# hpif - Simple text input filter for lpd for HP-PCL based printers
# Installed in /usr/local/libexec/hpif
#
# Simply copies stdin to stdout.  Ignores all filter arguments.
# Tells printer to treat LF as CR+LF.  Ejects the page when done.

printf "\033&amp;k2G" &amp;&amp; cat &amp;&amp; printf "\f" &amp;&amp; exit 0
exit 2</pre><p>ホスト <code class="systemitem">orchid</code> の
		      <code class="filename">/etc/printcap</code>
		      の例を以下に示します。ここには、
		      一番目のパラレルポートにプリンタ
		      (Hewlett Packard LaserJet 3Si)
		      が一台接続されており、そのプリンタ名は
		      <code class="literal">teak</code> です。</p><pre class="programlisting">#
#  /etc/printcap for host orchid
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=<code class="filename">/dev/lpt0</code>:sh:sd=<code class="filename">/var/spool/lpd/teak</code>:mx#0:\
        :if=<code class="filename">/usr/local/libexec/hpif</code>:</pre></li><li class="listitem"><div xmlns="" class="note"><h3 class="admontitle">訳注: </h3><p xmlns="http://www.w3.org/1999/xhtml">
		         LF を CR+LF
			に置き換える cat コマンドを作る方法も当然考えられます。
			そして、このコマンドと、<span class="emphasis"><em>if-simple</em></span> の cat
			の部分を置き換えればよいわけです。
			具体的にどのようにするかは、
			読者への練習問題としましょう。</p></div></li></ul></div></dd><dt><span class="term">各行が重ね書きされてしまった</span></dt><dd><p>プリンタは紙送りをまったくしませんでした。
		  テキストすべての行がある行の上で重ねて印字されてしまいました。
		</p><p>この問題は、
		  階段現象とは <span class="quote">「<span class="quote">正反対</span>」</span> な問題で、
		  ほとんどまれにしか起こりません。FreeBSD では行末として扱われる
		  LF  文字が、紙の左端に印字位置を復帰しますが、
		  紙送りはしない CR 文字として扱われています。</p><p>プリンタの設定スイッチかコントロールパネルを使って、
		  LF と CR
		  の文字を次のような解釈をするようにしてください。
		</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><thead><tr><th>プリンタが受け取ったとき</th><th>プリンタがおこなう</th></tr></thead><tbody><tr><td>CR</td><td>CR 動作 (復帰)</td></tr><tr><td>LF</td><td>CR + LF (復帰、改行)</td></tr></tbody></table></div><div xmlns="" class="note"><h3 class="admontitle">訳注: </h3><p xmlns="http://www.w3.org/1999/xhtml">
		    LF を CR+LF
		    に置き換える cat コマンドを作る方法も当然考えられます。
		    そして、このコマンドと、
		    <code class="filename">if-simple</code> の cat
		    の部分を置き換えればよいわけです。
		    具体的にどのようにするかは、
		    読者への練習問題としましょう。</p></div></dd><dt><span class="term">プリンタが文字を紛失してしまう</span></dt><dd><p>印字しているのですが、
		  各行の 2 〜 3 文字が印字されません。
		  プリンタを動かせば動かすほど、
		  もっとたくさんの文字が紛失されていき、
		  この問題は更に悪くなっていくかもしれませんでした。</p><p>この問題は、
		  シリアルポートを通してコンピュータから送られてくるデータの速度に、
		  プリンタがついていけないことに起因します
		  (この問題は、パラレルポートに接続された
		  プリンタでは発生することはありません)。
		  この問題を克服する方法が2つあります。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>プリンタが XON/XOFF のフロー制御をサポート
		      している場合は、項目 <code class="literal">ms#</code> で
		      <code class="literal">ixon</code> モードをセットして、FreeBSD
		      にこの機能を使用させてください。</p></li><li class="listitem"><p>プリンタが Request to Send / Clear to Send
		      ハードウェアハンドシェイク
		      (通称 <code class="literal">RTS/CTS</code>) をサポートして
		      いる場合は、項目 <code class="literal">ms#</code> で
		      <code class="literal">crtscts</code>
		      モードをセットして下さい。それから、
		      プリンタとコンピュータを接続しているシリアルケーブルが
		      ハードウェアフロー制御用に正しく配線されたものかどうかを確認してください。</p></li></ul></div></dd><dt><span class="term">プリンタは意味不明な文字列を印字した</span></dt><dd><p>プリンタはランダムなゴミのように
		  見えるものを印字しましたが、
		  意図したテキストは印字してくれませんでした。</p><p>この問題は、通常、
		  シリアルポートに接続したプリンタでの
		  通信パラメータの誤りからくる前項とは別の症状です。
		  <code class="literal">br</code> 項目の通信速度と
		  <code class="literal">ms#</code> 項目を再確認してください。
		  また、プリンタでの設定が
		  <code class="filename">/etc/printcap</code>
		  ファイルで設定した
		  内容と一致しているかどうかも確認してください。</p><div xmlns="" class="note"><h3 class="admontitle">訳注: </h3><p xmlns="http://www.w3.org/1999/xhtml">
		    simple-if
		    のような単純なフィルタだけの状態で、
		    日本語を含むテキストを印字しようとした場合にも、
		    シリアルポート、パラレルポートの使用に関係なく、
		    このような症状は見られます。日本語プリンタの場合、
		    漢字コードそのもの
		    を送信しただけでその漢字を印字してくれるものは、
		    少なくとも訳者は見たことがありません。
		    漢字を印字するための制御
		    コードを別途送信するフィルタが必要となります。
		    また、そのようなフィルタを使用していても、
		    そのフィルタが想定してる漢字コードと異なった文書を
		    プリントしようとしたときもこのような症状は出ます。
		    もちろん、これはプリンタ用の
		    言語を持たないプリンタの話で、<span class="trademark">PostScript</span>® プリンタ
		    などにプレインテキストを送信しても、日本語対応、
		    非対応に関らず、意味不明な文字列が印字される
		    (もしくは、何も印字されない) ことでしょう。</p></div></dd><dt><span class="term">何も起きない</span></dt><dd><p>もしプリンタが何の動作もしないのであれば、
		  ハード的な問題ではなく、多分 FreeBSD
		  の中に問題があります。
		  <code class="filename">/etc/printcap</code> ファイルで、
		  デバッグしているプリンタのエントリに
		  (<code class="literal">lf</code> 項目で) ログファイルを取るように
		  設定を追加してください。たとえば、プリンタ
		  <code class="literal">rattan</code> 用のエントリの項目
		  <code class="literal">lf</code> は次のようになります。</p><pre class="programlisting">rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=<code class="filename">/var/spool/lpd/rattan</code>:\
        :lp=<code class="filename">/dev/lpt0</code>:\
        :if=<code class="filename">/usr/local/libexec/if-simple</code>:\
        :lf=<code class="filename">/var/log/rattan.log</code></pre><p>次に、もう一度印字をおこなってみます。そして、
		  発生したと思われるエラーメッセージを見るためにログファイル
		  (上記の例では、
		  <code class="filename">/var/log/rattan.log</code>)
		  を調べます。そこで見られたメッセージを元に、
		  問題を解決してみてください。</p><p>項目 <code class="literal">lf</code>
		  が指定されていない場合、<span class="application">LPD</span>
		  はデフォルトのログファイルとして
		  <code class="filename">/dev/console</code> を使います。</p></dd></dl></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="printing-lpd-alternatives.html">戻る</a>〓</td><td width="20%" align="center"><a accesskey="u" href="printing.html">上に戻る</a></td><td width="40%" align="right">〓<a accesskey="n" href="linuxemu.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">10.6. 標準スプーラの代替品〓</td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top">〓第11章 Linux バイナリ互換機能</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文書、および他の文書は
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>
    からダウンロードできます。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>FreeBSD に関する質問がある場合には、
    <a href="http://www.FreeBSD.org/ja/docs.html">ドキュメント</a> を読んだ上で
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt; まで (英語で) 連絡してください。<br></br>
    本文書に関する質問については、
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt; まで電子メールを (英語で) 送ってください。</small></p></body></html>