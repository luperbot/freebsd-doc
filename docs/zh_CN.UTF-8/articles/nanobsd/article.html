<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>NanoBSD 简介</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><meta name="description" content="这篇文档提供了关于 NanoBSD 工具的介绍信息， 这一工具可以用来创建用于嵌入式应用的 FreeBSD 系统映像， 以适应存放到袖珍闪存 (Compact Flash) 卡 (或其它大容量存储介质) 上的需要。" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div xml:lang="zh_cn" class="article" lang="zh_cn"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61089872"></a>NanoBSD 简介</h1></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Daniel</span> <span class="surname">Gerzo</span></h3></div></div></div><div>修订: <a href="https://svnweb.freebsd.org/changeset/doc/"><span class="svnref"></span></a></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">版权 © 2006 The FreeBSD Documentation Project</p></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="trademarks"></a><p>FreeBSD 是 FreeBSD 基金会的注册商标</p><p>许多制造商和经销商使用一些称为商标的图案或文字设计来彰显自己的产品。
  本文档中出现的， 为 FreeBSD Project 所知晓的商标，后面将以 <span class="quote">“<span class="quote">™</span>”</span> 或
  <span class="quote">“<span class="quote">®</span>”</span> 符号来标注。</p></div></div><div>   由 .</div><div><div xmlns="http://www.w3.org/1999/xhtml" class="abstract"><div class="abstract-title">摘要</div><p>这篇文档提供了关于 <span class="application">NanoBSD</span> 工具的介绍信息，
	这一工具可以用来创建用于嵌入式应用的 FreeBSD 系统映像，
	以适应存放到袖珍闪存 (Compact Flash) 卡 (或其它大容量存储介质) 上的需要。</p></div></div></div><hr /></div><div class="toc"><div class="toc-title">目录</div><dl class="toc"><dt><span class="sect1"><a href="#intro">1. NanoBSD 简介</a></span></dt><dt><span class="sect1"><a href="#howto">2. 如何使用 NanoBSD</a></span></dt><dt><span class="index"><a href="#idp61809616">索引</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="intro"></a>1. NanoBSD 简介</h2></div></div></div><a id="idp61464144" class="indexterm"></a><p><span class="application">NanoBSD</span> 是 Poul-Henning Kamp 目前正在开发的一项工具。
      它可以用来创建用于嵌入式应用的 FreeBSD 系统映像，
      以便配合袖珍闪存 (Compact Flash) 卡 (或其他大容量存储介质) 使用。</p><p>这一工具也可以用来构建定制的安装映像，
      以简化通常称为 <span class="quote">“<span class="quote">计算设备 (computer appliances)</span>”</span>
      的系统的安装和维护工作。 计算设备通常在产品中将捆绑硬件和软件，
      或者换言之， 所有的应用程序都是预先装好的。
      这些设备可以直接插到暨存的网络中，
      并 (几乎是) 立即投入使用。</p><p><span class="application">NanoBSD</span> 提供的功能包括：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>可以和 FreeBSD 一样使用 Ports 和预编译包──
	  所有的应用程序都可以在 <span class="application">NanoBSD</span> 映像中直接使用，
	  而方式与 FreeBSD 完全一样。</p></li><li class="listitem"><p>不减少功能 ── 能够使用 FreeBSD 做的任何工作， 都可以在
	  <span class="application">NanoBSD</span> 中使用，
	  除非您在创建 <span class="application">NanoBSD</span> 映像时，
	  明确地删去它们。</p></li><li class="listitem"><p>所有对象在运行时均是只读的 ── 可以安全地拔掉电源插销。
	  在系统非正常关闭之后， 无需运行
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a>。</p></li><li class="listitem"><p>便于联编和定制 ── 只需使用一个 shell 脚本和一个配置文件，
	  您可以很容易地裁减和定制适于任意需求的映像。</p></li></ul></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="howto"></a>2. 如何使用 NanoBSD</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="design"></a>2.1. NanoBSD 的设计</h3></div></div></div><p>一旦将映像存入介质， 就可以用它来引导 <span class="application">NanoBSD</span>
	了。 默认情况下， 大容量存储器会划分为三个区：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>两个映像区： <code class="literal">code#1</code>
	    和 <code class="literal">code#2</code>。</p></li><li class="listitem"><p>一个配置文件区， 运行环境中，
	    可以将其挂接到 <code class="filename">/cfg</code> 目录下。</p></li></ul></div><p>这些分区默认情况下以只读方式挂接。</p><p><code class="filename">/etc</code> 和
	<code class="filename">/var</code> 目录均为
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=md&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">md</span>(4)</span></a> (malloc) 盘。</p><p>配置文件分区保存在
	<code class="filename">/cfg</code> 目录。
	它包含了用于 <code class="filename">/etc</code>
	目录的文件， 在启动之后暂时以只读方式挂接。 因此，
	在需要从 <code class="filename">/etc</code> 向
	<code class="filename">/cfg</code> 目录复制所进行的、
	希望在重启时保持不变的配置时， 需要进行一些额外的操作。</p><div class="example"><a id="idp61529168"></a><div class="example-title">例 1. 在 <code class="filename">/etc/resolv.conf</code> 中进行需要保持的修改</div><div class="example-contents"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>vi /etc/resolv.conf</code></strong>
[...]
<code class="prompt">#</code> <strong class="userinput"><code>mount /cfg</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cp /etc/resolv.conf /cfg</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>umount /cfg</code></strong></pre></div></div><br class="example-break" /><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">只有在系统启动过程中， 以及需要修改配置文件的场合， 才需要挂接包含
	  <code class="filename">/cfg</code> 的那个分区。</p><p xmlns="http://www.w3.org/1999/xhtml">在任何时候都保持挂接 <code class="filename">/cfg</code>
	  不是一个好主意， 特别是当您把 <span class="application">NanoBSD</span>
	  放在不适合进行大量写操作的分区时
	  (由于文件系统的同步进程会定期向系统盘写一些数据)。</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61553616"></a>2.2. 构建 NanoBSD 映像</h3></div></div></div><p><span class="application">NanoBSD</span> 映像是通过使用非常简单的
	<code class="filename">nanobsd.sh</code> shell 脚本来构建的， 这个脚本可以在
	<code class="filename">/usr/src/tools/tools/nanobsd</code>
	目录中找到。 这个脚本建立的映像文件， 可以用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dd&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">dd</span>(1)</span></a> 工具复制到存储介质上。</p><p>构建
	<span class="application">NanoBSD</span> 映像所需的命令是：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/tools/tools/nanobsd</code></strong> <a id="nbsd-cd"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>sh nanobsd.sh</code></strong> <a id="nbsd-sh"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/obj/nanobsd.full</code></strong> <a id="nbsd-cd2"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>dd if=_.disk.full of=/dev/da0 bs=64k</code></strong> <a id="nbsd-dd"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-cd"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>进入 <span class="application">NanoBSD</span> 构建脚本的主目录。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-sh"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>开始构建过程。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-cd2"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>进入构建好的映像文件所在的目录。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#nbsd-dd"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>在存储介质上安装 <span class="application">NanoBSD</span>。</p></td></tr></table></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61600848"></a>2.3. 定制 NanoBSD 映像</h3></div></div></div><p>这可能是 <span class="application">NanoBSD</span> 最为重要，
	同时也是您最感兴趣的功能。 同时， 您在开发
	<span class="application">NanoBSD</span> 应用时，
	这也是相当耗时的过程。</p><p>执行下面的命令将使
	<code class="filename">nanobsd.sh</code> 从当前目录中的
	<code class="filename">myconf.nano</code> 文件读取配置：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh nanobsd.sh -c myconf.nano</code></strong></pre><p>定制过程包含两步：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>配置选项</p></li><li class="listitem"><p>定制函数</p></li></ul></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61619664"></a>2.3.1. 配置选项</h4></div></div></div><p>通过对配置进行设置， 可以配置用以传递给
          <span class="application">NanoBSD</span> 构建过程中
	  <code class="buildtarget">buildworld</code>
          和 <code class="buildtarget">installworld</code> 阶段的联编和安装选项， 以及
          <span class="application">NanoBSD</span> 的主构建过程中的选项。
          通过使用这些选项可以削减系统的尺寸， 使之能够放入
          64MB 的存储。 您还可以进一步通过这些选项来削减 FreeBSD，
          直到它只包含内核以及两三个用户环境文件为止。</p><p>配置文件中包含用以代替默认值的配置选项。
	  最重要的语句包括：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">NANO_NAME</code> ── 本次构建的名称
	      (用于创建工作目录的名字)。</p></li><li class="listitem"><p><code class="literal">NANO_SRC</code> ── 用以联编和构建映像的源码树的位置。</p></li><li class="listitem"><p><code class="literal">NANO_KERNEL</code> ── 用以联编内核的配置文件的名字。</p></li><li class="listitem"><p><code class="literal">CONF_BUILD</code> ── 用于传递给
	      <code class="buildtarget">buildworld</code> 构建阶段的选项。</p></li><li class="listitem"><p><code class="literal">CONF_INSTALL</code> ── 用于传递给
	      <code class="buildtarget">installworld</code> 构建阶段的选项。</p></li><li class="listitem"><p><code class="literal">CONF_WORLD</code> ── 用以传递给
	      <code class="buildtarget">buildworld</code> 和
	      <code class="buildtarget">installworld</code> 这两个构建阶段的选项。</p></li><li class="listitem"><p><code class="literal">FlashDevice</code> ── 定义所用的介质类型。
	      要了解进一步的细节， 请参考 <code class="filename">FlashDevice.sub</code>
	      文件。</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61668432"></a>2.3.2. 定制函数</h4></div></div></div><p>通过在配置文件中使用 shell 函数可以进一步微调
	  <span class="application">NanoBSD</span>。 下面的例子展示了定制函数的基本模式：</p><pre class="programlisting">cust_foo () (
	echo "bar=baz" &gt; \
		${NANO_WORLDDIR}/etc/foo
)
customize_cmd cust_foo</pre><p>下面是一个更贴近实际的例子， 它将默认的
          <code class="filename">/etc</code> 目录尺寸，
          从 5MB 调整为 30MB：</p><pre class="programlisting">cust_etc_size () (
	cd ${NANO_WORLDDIR}/conf
	echo 30000 &gt; default/etc/md_size
)
customize_cmd cust_etc_size</pre><p>除此之外， 还有几个默认的预定义定制函数：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">cust_comconsole</code> ── 在 VGA 设备上禁止
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getty&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">getty</span>(8)</span></a>
	      (<code class="filename">/dev/ttyv*</code> 设备节点) 并启用串口 COM1
	      作为系统控制台。</p></li><li class="listitem"><p><code class="literal">cust_allow_ssh_root</code> ── 允许
	      <code class="systemitem">root</code> 通过 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a> 登录。</p></li><li class="listitem"><p><code class="literal">cust_install_files</code> ──
	      从 <code class="filename">nanobsd/Files</code>
	      目录中安装文件， 这包含一些实用的系统管理脚本。</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61706576"></a>2.3.3. 安装预编译软件包</h4></div></div></div><p>通过增加自定义的函数， 可以在 <span class="application">NanoBSD</span>
	  增加预编译的软件包。 下面的函数会添加位于
	  <code class="filename">/usr/src/tools/tools/nanobsd/packages</code>
	  的全部预编译软件包：</p><pre class="programlisting">install_packages () (
mkdir -p ${NANO_WORLDDIR}/packages
cp /usr/src/tools/tools/nanobsd/packages/* ${NANO_WORLDDIR}/packages
chroot ${NANO_WORLDDIR} sh -c 'cd packages; pkg_add -v *;cd ..;'
rm -rf ${NANO_WORLDDIR}/packages
)
customize_cmd install_packages</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61711184"></a>2.3.4. 配置文件举例</h4></div></div></div><p>下面是一个用于构建定制的 <span class="application">NanoBSD</span> 映像的完整例子：</p><pre class="programlisting">NANO_NAME=custom
NANO_SRC=/usr/src
NANO_KERNEL=MYKERNEL
NANO_IMAGES=2

CONF_BUILD='
NO_KLDLOAD=YES
NO_NETGRAPH=YES
NO_PAM=YES
'

CONF_INSTALL='
NO_ACPI=YES
NO_BLUETOOTH=YES
NO_CVS=YES
NO_FORTRAN=YES
NO_HTML=YES
NO_LPR=YES
NO_MAN=YES
NO_SENDMAIL=YES
NO_SHAREDOCS=YES
NO_EXAMPLES=YES
NO_INSTALLLIB=YES
NO_CALENDAR=YES
NO_MISC=YES
NO_SHARE=YES
'

CONF_WORLD='
NO_BIND=YES
NO_MODULES=YES
NO_KERBEROS=YES
NO_GAMES=YES
NO_RESCUE=YES
NO_LOCALES=YES
NO_SYSCONS=YES
NO_INFO=YES
'

FlashDevice SanDisk 1G

cust_nobeastie() (
	touch ${NANO_WORLDDIR}/boot/loader.conf
	echo "beastie_disable=\"YES\"" &gt;&gt; ${NANO_WORLDDIR}/boot/loader.conf
)

customize_cmd cust_comconsole
customize_cmd cust_install_files
customize_cmd cust_allow_ssh_root
customize_cmd cust_nobeastie</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61716816"></a>2.4. 更新 NanoBSD</h3></div></div></div><p>更新 <span class="application">NanoBSD</span> 相对而言较为简单：</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>和之前一样构建新的 <span class="application">NanoBSD</span> 映像文件。</p></li><li class="step"><p>将新的映像放入正运行的
	    <span class="application">NanoBSD</span> 设备中的一个未用的分区。</p><p>与之前最初安装 <span class="application">NanoBSD</span> 的步骤相比，
	    这一步骤最重要的区别在于这次不应使用 <code class="filename">_.disk.full</code> 文件
	    (它包含整个盘的映像)，
	    而应安装 <code class="filename">_.disk.image</code> 映像 (这个文件中，
	    只包含一个系统分区)。</p></li><li class="step"><p>重新启动， 并从新安装的分区中启动系统。</p></li><li class="step"><p>如果一切顺利的话， 升级工作就完成了。</p></li><li class="step"><p>如果发生了任何问题， 则可以从先前的分区启动
	  (其中包含了旧的、 可用的映像)， 来尽可能快地恢复系统功能。
	  接下来可以修正新联编的版本中存在的问题， 并重复前述步骤。</p></li></ol></div><p>要在正在运行的
	<span class="application">NanoBSD</span> 系统中安装新的映像， 可以使用位于
	<code class="filename">/root</code> 目录的
	<code class="filename">updatep1</code> 或
	<code class="filename">updatep2</code> 脚本，
	具体使用哪一个脚本， 取决于正在运行的系统位于那个分区。</p><p>随时提供新 <span class="application">NanoBSD</span> 映像所提供的服务，
	以及采用的传输方法的不同， 您可以参考并使用下列三种方式之一：</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61761488"></a>2.4.1. 使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ftp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ftp</span>(1)</span></a></h4></div></div></div><p>如果传输速度是第一要务，
	  采用下面的例子：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ftp myhost
get _.disk.image "| sh updatep1"</code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61780688"></a>2.4.2. 使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a></h4></div></div></div><p>如果更倾向于安全传输， 应参考下面的例子：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ssh myhost cat _.disk.image.gz | zcat | sh updatep1</code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61787728"></a>2.4.3. 使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=nc&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">nc</span>(1)</span></a></h4></div></div></div><p>如果远程主机既不提供
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ftp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ftp</span>(1)</span></a> 服务， 也不提供 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a> 服务：</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>开始时， 在提供映像的主机上开启 TCP 监听，
	      并令其将映像文件发给客户机：</p><pre class="screen">myhost<code class="prompt">#</code> <strong class="userinput"><code>nc -l 2222 &lt; _.disk.image</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">请确认您所使用的端口没有通过防火墙阻止来自
		<span class="application">NanoBSD</span> 客户机的联接请求。</p></div></li><li class="step"><p>连接到提供新映像服务的主机， 并执行
	      <code class="filename">updatep1</code> 脚本：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>nc myhost 2222 | sh updatep1</code></strong></pre></li></ol></div></div></div></div><div class="index"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61809616"></a>索引</h2></div></div></div><div class="index"><div class="indexdiv"><h3>N</h3><dl><dt>NanoBSD，<a class="indexterm" href="#intro">NanoBSD 简介</a></dt></dl></div></div></div></div></body></html>