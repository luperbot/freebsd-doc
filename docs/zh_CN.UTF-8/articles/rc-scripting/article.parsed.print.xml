<?xml version="1.0" encoding="utf-8"?>
<!--
     The FreeBSD Documentation Project
     The FreeBSD Chinese (Simplified) Documentation Project

     Original Revision: 1.14
-->
<article xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:lang="zh_cn">
  <info><title xmlns:xlink="http://www.w3.org/1999/xlink">BSD rc.d脚本编程实战</title>
    

    <author xmlns:xlink="http://www.w3.org/1999/xlink"><personname xmlns:xlink="http://www.w3.org/1999/xlink"><firstname xmlns:xlink="http://www.w3.org/1999/xlink">Yar</firstname><surname xmlns:xlink="http://www.w3.org/1999/xlink">Tikhiy</surname></personname><affiliation xmlns:xlink="http://www.w3.org/1999/xlink">
	<address xmlns:xlink="http://www.w3.org/1999/xlink"><email xmlns:xlink="http://www.w3.org/1999/xlink">yar@FreeBSD.org</email></address>
      </affiliation></author>

    <copyright xmlns:xlink="http://www.w3.org/1999/xlink">
      <year xmlns:xlink="http://www.w3.org/1999/xlink">2005</year>
      <year xmlns:xlink="http://www.w3.org/1999/xlink">2006</year>
      <year xmlns:xlink="http://www.w3.org/1999/xlink">2012</year>

      <holder xmlns:xlink="http://www.w3.org/1999/xlink">The FreeBSD Project</holder>
    </copyright>

    <pubdate xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</pubdate>

    <releaseinfo xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</releaseinfo>

    <legalnotice xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="trademarks" role="trademarks">
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">FreeBSD 是 FreeBSD 基金会的注册商标</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">NetBSD是 NetBSD Foundation的注册商标。</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">许多制造商和经销商使用一些称为商标的图案或文字设计来彰显自己的产品。
  本文档中出现的， 为 FreeBSD Project 所知晓的商标，后面将以 <quote xmlns:xlink="http://www.w3.org/1999/xlink">™</quote> 或
  <quote xmlns:xlink="http://www.w3.org/1999/xlink">®</quote> 符号来标注。</para>
    </legalnotice>

    <abstract xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">初学者可能会发现，难以通过正式的文档，
        基于 BSD 的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
        框架，编写一些实际任务的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本。
        本文中，我们采用了一些复杂性不断增加的典型案例，
        来展示适合每个案例的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 特性，
        并探讨其中的工作原理。
        这样的实验为大家进一步研究设计有效的
        <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 应用程序提供了一些参考点。</para>
    </abstract>
  </info>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-intro">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">简介</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">历史上 BSD 曾有过一个单一的启动脚本，
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename>。 该脚本在系统启动的时候被
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">init</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 程序所引导，并执行所有多用户操作所需求的用户级任务：
      检查并挂载文件系统，设置网络，启动守护进程，等等。
      在每个系统中实际的任务清单也并不相同；
      管理员需要根据需求自定义这样的任务清单。在一些特殊的情况中，
      还不得不去修改 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename> 文件，
      一些真正的黑客乐此不疲。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">单一脚本启动方法的真正问题是它没有提供对从
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename> 启动的单个组件的控制。
      拿一个例子来说吧，<filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename>
      不能够重新启动某个单独的守护进程。
      系统管理员不得不手动找出守护进程，并杀掉它，
      等待它真正退出后，再通过浏览 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename>
      得到该守护进程的标识，最终输入全部命令来再次启动守护进程。
      如果重新启动的服务包括不止一个守护进程或需要更多动作的话，
      该任务将变得更加困难以及容易出错。简而言之，
      单一脚本在实现我们这样的目的上是不成功的：
      让系统管理员的生活更轻松。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">再后来，为了将最重要的一些子系统独立出来，
      便尝试将部分的内容从 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename> 分离出来了。
      最广为人知的例子就是用来启动联网的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/netstart</filename>
      文件。它容许从单用户模式访问网络，
      但由于它的部分代码需要和一些与联网完全无关的动作交互，
      所以它并没有完美地结合到自启动的进程中。那便是为何
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/netstart</filename> 被演变成
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.network</filename> 的原因了。
      后者不再是一个普通的脚本；它包括了庞大的，由
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename> 在不同的系统启动级别中调用的凌乱的
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 函数。然而，当启动任务变得多样化以及久经更改，
      <quote xmlns:xlink="http://www.w3.org/1999/xlink">类模块化</quote> 方法变得比曾经的整体
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename> 更缓慢费事。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">由于没有一个干净和易于设计的框架，
      启动脚本不得不全力更改以满足飞速开发中基于 BSD 的操作系统的需求。
      它逐渐变得明朗并经过许多必要的步骤最终变成一个具有细密性和扩展性的
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc</filename> 系统。BSD <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
      就这样诞生了。Luke Mewburn 和 NetBSD 社区是公认的
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 之父。再之后它被引入到了 FreeBSD 中。
      它的名字引用为系统单独的服务脚本的位置，也就是
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d</filename>下面的那些脚本。
      之后我们将学习到更多的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
      系统的组件并看看单个脚本是如何被调用的。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">BSD <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
      背后的基本理念是 <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">良好</emphasis> 的模块化和代码重用性。
      <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">良好</emphasis> 的模块化意味着每个基本
      <quote xmlns:xlink="http://www.w3.org/1999/xlink">服务</quote> 就象系统守护进程或原始启动任务那样，
      通过属于它们的可启动该服务的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 脚本，来停止服务，
      重载服务，检查服务的状态。具体动作由脚本的命令行参数所决定。
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename> 脚本仍然掌管着系统的启动，
      但现在它仅仅是使用 <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option> 参数来一个个调用那些小的脚本。
      这便于用 <option xmlns:xlink="http://www.w3.org/1999/xlink">stop</option> 来对运行中的同样的脚本很好地执行停止任务，
      这是被 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.shutdown</filename>
      脚本所完成的。看，这是多么好地体现了 Unix 的哲学：
      拥有一组小的专用的工具，每个工具尽可能好地完成自己的任务。
      <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">代码重用</emphasis> 意味着所有的通用操作由
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.subr</filename> 中的一些 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 函数所实现。
      现在一个典型的脚本只需要寥寥几行的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 代码。最终，
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 成为了 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 框架中重要的一部分，
      它用来帮助 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename>
      处理小脚本之间的依赖关系并有次序地运行它们。它同样帮助
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.shutdown</filename> 做类似的事情，
      因为正确的关闭次序是相对于启动的次序的。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">BSD <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 的设计在
      <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="lukem"> Luke Mewburn 的原文 </link> 中有记录，
      以及 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 组件也被充分详细地记录在各自的
      <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="manpages">联机手册</link> 中。然而，
      它可能没能清晰展现给一个 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
      新手，如何将无数的块和片进行关联来为具体的任务创建一个好风格的脚本。
      因此本文将试着以不同的方式来讲述 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>。
      它将展示在某些典型情况中应该使用哪些特性，并阐述了为何如此。
      注意这并不是一篇 how-to 文档，我们的目的不是给出现成的配方，
      而是在展示一些简单的进入 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 的范围的门路。
      本文也不是相关联机手册的替代品。
      阅读本文时记得同时参考联机手册以获取更完整正规的文档。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">理解本文需要一些先决条件。首先，你需要熟悉
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 脚本编程语言以掌握 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>，
      还有，你需要知道系统是如何执行用户级的启动和停止任务，这些在
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 中都有说明。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">本文关注的是 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 的 FreeBSD 分支。
      不过，它可能对 NetBSD 的开发者也同样有用，因为 BSD
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 的两个分支不只是共享了同样的设计，
      还保留了对脚本编写者都可见的类似观点。</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-task">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">任务描述</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">在开始打开 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$EDITOR</envar>（编辑器）
      之前进行小小的思考不是坏事。为了给一个系统服务写一个
      <quote xmlns:xlink="http://www.w3.org/1999/xlink">听话的</quote> <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本，
      我们首先应该能回答以下问题：</para>

    <itemizedlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">该服务是必须性的还是可选性的？</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">脚本将为单个程序服务，如一个守护进程，还是执行更复杂的动作？</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">我们的服务依赖哪些服务？反过来哪些服务依赖我们的服务？</para>
      </listitem>
    </itemizedlist>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">从下面的例子中我们将看到，为什么说知道这些问题的答案是很重要的。</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-dummy">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">虚拟的脚本</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">下面的脚本是用来在每次系统启动时发出一个信息：</para>

    <informalexample xmlns:xlink="http://www.w3.org/1999/xlink">
      <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">#!/bin/sh<co xml:id="rcng-dummy-shebang"/>

. /etc/rc.subr<co xml:id="rcng-dummy-include"/>

name="dummy"<co xml:id="rcng-dummy-name"/>
start_cmd="${name}_start"<co xml:id="rcng-dummy-startcmd"/>
stop_cmd=":"<co xml:id="rcng-dummy-stopcmd"/>

dummy_start()<co xml:id="rcng-dummy-startfn"/>
{
	echo "Nothing started."
}

load_rc_config $name<co xml:id="rcng-dummy-loadconfig"/>
run_rc_command "$1"<co xml:id="rcng-dummy-runcommand"/></programlisting>
    </informalexample>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">需要注意的是：</para>

    <calloutlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <callout arearefs="rcng-dummy-shebang">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">一个解释性的脚本应该以一行魔幻的
          <quote xmlns:xlink="http://www.w3.org/1999/xlink">shebang</quote> 行开头。
          该行指定了脚本的解析程序。由于 shebang 行的作用，
          假如再有可执行位的设置，
          脚本就能象一个二进制程序一样被精确地调用执行。
          （请参考 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">chmod</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>。） 例如，
          一个系统管理员可以从命令行手动运行我们的脚本：</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/dummy start</userinput></screen>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">为了使 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 框架正确地管理脚本，
            它的脚本需要用 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 语言编写。
            如果你的某个服务或 port 套件使用了二进制控制程序或是用其它语言编写的例程，
            请将其组件安装到 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/usr/sbin</filename>（相对于系统）
            或 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/usr/local/sbin</filename>（相对于ports），
            然后从合适的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 目录的某个
            <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 脚本调用它。</para>
	</note>

	<tip xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">如果你想知道为什么 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
            脚本必须用 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 语言编写的细节，先看下
            <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename> 是如何依靠
            <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_script</function> 调用它们，
            然后再去学习 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.subr</filename>
            下 <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_script</function>
            的相关实现。</para>
	</tip>
      </callout>

      <callout arearefs="rcng-dummy-include">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">在 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.subr</filename> 下，
          有许多定义过的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 函数可供每个
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本使用。这些函数在
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 中都有说明。尽管理论上可以完全不使用
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 来编写一个 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
          脚本，但它的函数已经证明了它真的很方便，
          并且能使任务更加的简单。所以所有人在编写
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本时都会求助于
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 也不足为奇了。当然我们也不例外。</para>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">一个 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本在其调用
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 函数之前必须先 <quote xmlns:xlink="http://www.w3.org/1999/xlink">source</quote>
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.subr</filename>（用
          <quote xmlns:xlink="http://www.w3.org/1999/xlink"><command xmlns:xlink="http://www.w3.org/1999/xlink">.</command></quote>将其包含进去），
          而使 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 程序有机会来获悉那些函数。
          首选风格是在脚本的最开始 source
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.subr</filename> 文件。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">某些有用的与联网有关的函数由另一个被包含进来的文件提供，
            <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/network.subr</filename> 文件。</para>
	</note>
      </callout>

      <callout arearefs="rcng-dummy-name">
        <para xmlns:xlink="http://www.w3.org/1999/xlink"><anchor xml:id="name-var"/>强制的变量
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">name</envar> 指定我们脚本的名字。
            这是 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 所强调的。也就是，
            每个 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本在调用
            <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 的函数之前必须设置
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">name</envar> 变量。</para>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">现在是时候来为我们的脚本一次性选择一个独一无二的名字了。
          在编写这个脚本的时我们将在许多地方用到它。在开始之前，
          我们来给脚本文件也取个相同的名字。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">当前的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
            脚本风格是把值放在双引号中来给变量赋值。
            请记住这只是个风格问题，可能并不总是这样。
            你可以在只是简单的并不包括 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>
            元字符的词句中放心地省略掉引号，
            而在某些情况下你将需要使用单引号以防止
            <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 对任何的变量的解释。
            程序员是可以灵巧地由风格惯例获悉其语法以及使用的。
          </para>
	</note>
      </callout>

      <callout arearefs="rcng-dummy-startcmd">
        <para xmlns:xlink="http://www.w3.org/1999/xlink"><citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 背后主要的构思是
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本提供处理程序，或者方法，来让
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 调用。特别是，<option xmlns:xlink="http://www.w3.org/1999/xlink">start</option>，
          <option xmlns:xlink="http://www.w3.org/1999/xlink">stop</option>，以及其它的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
          脚本参数都是这样被处理的。方法是存储在一个以
          <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument_cmd</replaceable></envar>
          形式命名的变量中的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 表达式，该
          <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>
          对应着脚本命令行中所特别指定的参数。我们稍后将看到
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 是如何为标准参数提供默认方法的。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">为了让 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 中的代码更加统一，
            常见的是在任何适合的地方都使用 <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}</envar> 形式。
            这样一来，可以轻松地将一些代码从一个脚本拷贝到另一个中使用。</para>
	</note>
      </callout>

      <callout arearefs="rcng-dummy-stopcmd">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">我们应谨记 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 为标准参数提供了默认的方法。
          因此，如果希望它什么都不做的话，我们必须使用无操作的
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 表达式来改写标准的方法。</para>
      </callout>

      <callout arearefs="rcng-dummy-startfn">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">比较复杂的方法主体可以用函数来实现。
          在能够保证函数名有意义的情况下，这是个很不错的想法。</para>

	<important xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">强烈推荐给我们脚本中所定义的所有函数名都添加类似
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}</envar> 这样的前缀，以使它们永远不会和
            <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 或其它公用包含文件中的函数冲突。</para>
	</important>
      </callout>

      <callout arearefs="rcng-dummy-loadconfig">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">这是在请求 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 载入 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 变量。
          尽管我们这个脚本中使用的变量并没有被其它地方使用，但由于
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 自身所控制着的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry>
          变量存在的原因，仍然推荐脚本去装载 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry>。</para>
      </callout>

      <callout arearefs="rcng-dummy-runcommand">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">通常这是 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本的最后一个命令。
          它调用 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
          体系使用我们脚本所提供的变量和方法来执行相应的请求动作。</para>
      </callout>
    </calloutlist>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-confdummy">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">可配置的虚拟脚本</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">现在我们来给我们的虚拟脚本增加一些控制参数吧。正如你所知，
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本是由 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 所控制的。
      幸运的是，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 隐藏了所有复杂化的东西。
      下面这个脚本使用 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 通过 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
      来查看它是否在第一个地方被启用，并获取一条信息在启动时显示。
      事实上这两个任务是相互独立的。一方面，<filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
      脚本要能够支持启动和禁用它的服务。另一方面，
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本必须能具备配置信息变量。
      我们将通过下面同一脚本来演示这两方面的内容：</para>

    <informalexample xmlns:xlink="http://www.w3.org/1999/xlink">
      <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">#!/bin/sh

. /etc/rc.subr

name=dummy
rcvar=dummy_enable<co xml:id="rcng-confdummy-rcvar"/>

start_cmd="${name}_start"
stop_cmd=":"

load_rc_config $name<co xml:id="rcng-confdummy-loadconfig"/>
eval "${rcvar}=\${${rcvar}:-'NO'}"<co xml:id="rcng-confdummy-enable"/>
dummy_msg=${dummy_msg:-"Nothing started."}<co xml:id="rcng-confdummy-opt"/>

dummy_start()
{
	echo "$dummy_msg"<co xml:id="rcng-confdummy-msg"/>
}

run_rc_command "$1"</programlisting>
    </informalexample>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">在这个样例中改变了什么？</para>

    <calloutlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <callout arearefs="rcng-confdummy-rcvar">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">变量 <envar xmlns:xlink="http://www.w3.org/1999/xlink">rcvar</envar> 指定了 ON/OFF
          开关变量的名字。</para>
      </callout>

      <callout arearefs="rcng-confdummy-loadconfig">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">现在 <function xmlns:xlink="http://www.w3.org/1999/xlink">load_rc_config</function> 在任何
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 变量被访问之前就在脚本中被预先调用。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">检查 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本时，切记 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>
            会把函数延迟到其被调用时才对其中的表达式进行求值运算。
            因此尽可能晚地在 <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_command</function>
            之前调用 <function xmlns:xlink="http://www.w3.org/1999/xlink">load_rc_config</function>，
            以及仍然访问从方法函数输出到
            <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_command</function> 的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry>
            变量并不是一个错误。这是因为方法函数将在
            <function xmlns:xlink="http://www.w3.org/1999/xlink">load_rc_config</function> <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">之后</emphasis>，
            被调用的 <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_command</function> 调用。</para>
	</note>
      </callout>

      <callout arearefs="rcng-confdummy-enable">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">如果自身设置了 <envar xmlns:xlink="http://www.w3.org/1999/xlink">rcvar</envar>，
          但指示开关变量却未被设置，那么 <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_command</function>
          将发出一个警告。如果你的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
          脚本是为基本系统所用的，你应当在
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/defaults/rc.conf</filename>
          中给开关变量添加一个默认的设置并将其标注在 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 中。
          否则的话你的脚本应该给开关变量提供一个默认设置。
          范例中演示了一个可移植接近于后者情况的案例。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">你可以通过将开关变量设置为 ON 来使 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 有效，
            使用 <literal xmlns:xlink="http://www.w3.org/1999/xlink">one</literal> 或 <literal xmlns:xlink="http://www.w3.org/1999/xlink">force</literal>
            为脚本的参数加前缀，如 <literal xmlns:xlink="http://www.w3.org/1999/xlink">onestart</literal> 或
            <literal xmlns:xlink="http://www.w3.org/1999/xlink">forcestop</literal> 这样，会忽略其当前的设置。
            切记 <literal xmlns:xlink="http://www.w3.org/1999/xlink">force</literal>
            在我们下面要提到的情况下有额外的危险后果，那就是当用
            <literal xmlns:xlink="http://www.w3.org/1999/xlink">one</literal> 改写了 ON/OFF 开关变量。例如，
            假定 <envar xmlns:xlink="http://www.w3.org/1999/xlink">dummy_enable</envar> 是 <literal xmlns:xlink="http://www.w3.org/1999/xlink">OFF</literal>
            的，而下面的命令将忽略系统设置而强行运行
            <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option>方法：</para>

	  <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/dummy onestart</userinput></screen>
	</note>
      </callout>

      <callout arearefs="rcng-confdummy-opt">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">现在启动时显示的信息不再是硬编码在脚本中的了。
          它是由一个命名为 <envar xmlns:xlink="http://www.w3.org/1999/xlink">dummy_msg</envar> 的
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 变量所指定的。这就是 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry>
          变量如何来控制 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
          脚本的一个小例子。</para>

	<important xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">我们的脚本所独占使用的所有 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 变量名，
            都必须具有同样的前缀：<envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}</envar>。
            例如：<envar xmlns:xlink="http://www.w3.org/1999/xlink">dummy_mode</envar>，
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">dummy_state_file</envar>，等等。</para>
	</important>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">当可以内部使用一个简短的名字时，如 <envar xmlns:xlink="http://www.w3.org/1999/xlink">msg</envar>
            这样，为我们的脚本所引进的全部的共用名添加唯一的前缀
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}</envar>，能够避免我们与 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
            命名空间冲突的可能。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">只要一个 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 变量与其内部等同值是相同的，
            我们就能够使用一个更加兼容的表达式来设置默认值：</para>

	  <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">: ${dummy_msg:="Nothing started."}</programlisting>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">尽管目前的风格是使用了更详细的形式。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">通常，基本系统的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
            脚本不需要为它们的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 变量提供默认值，
            因为默认值应该是在 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/defaults/rc.conf</filename>
            设置过了。但另一方面，为 ports 所用的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
            脚本应提供如范例所示的默认设置。</para>
	</note>
      </callout>

      <callout arearefs="rcng-confdummy-msg">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">这里我们使用 <envar xmlns:xlink="http://www.w3.org/1999/xlink">dummy_msg</envar>
          来实际地控制我们的脚本，即，发一个变量信息。</para>
      </callout>
    </calloutlist>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-daemon">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">启动并停止简单守护进程</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">我们早先说过 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 是能够提供默认方法的。
      显然，这些默认方法并不是太通用的。
      它们都是适用于大多数情况下来启动和停止一个简单的守护进程况。
      我们来假设现在需要为一个叫做 <command xmlns:xlink="http://www.w3.org/1999/xlink">mumbled</command>
      的守护进程编写一个 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>脚本，
      在这里：</para>

    <informalexample xmlns:xlink="http://www.w3.org/1999/xlink">
      <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">#!/bin/sh

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command="/usr/sbin/${name}"<co xml:id="rcng-daemon-basic-cmd"/>

load_rc_config $name
run_rc_command "$1"</programlisting>
    </informalexample>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">感到很简单吧，不是么？我们来检查下我们这个小脚本。
      只需要注意下面的这些新知识点：</para>

    <calloutlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <callout arearefs="rcng-daemon-basic-cmd">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">这个 <envar xmlns:xlink="http://www.w3.org/1999/xlink">command</envar> 变量对于
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 来说是有意义的。当它被设置时，
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 将根据提供传统守护进程的情形而生效。
          特别是，将为这些参数提供默认的方法：
          <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option>，<option xmlns:xlink="http://www.w3.org/1999/xlink">stop</option>，
          <option xmlns:xlink="http://www.w3.org/1999/xlink">restart</option>，<option xmlns:xlink="http://www.w3.org/1999/xlink">poll</option>，
          以及 <option xmlns:xlink="http://www.w3.org/1999/xlink">status</option>。</para>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">该守护进程将会由运行中的 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$command</envar>
          配合由 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$mumbled_flags</envar> 所指定的命令行标帜来启动。
          因此，对默认的 <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option> 方法来说，
          所有的输入数据在我们脚本变量集合中都可用。与
          <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option> 不同的是，
          其他方法可能需要与进程启动相关的额外信息。举个例子，
          <option xmlns:xlink="http://www.w3.org/1999/xlink">stop</option> 必须知道进程的 PID 号来终结进程。
          在目前的情况中，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 将扫描全部进程的清单，
          查找一个名字等同于 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$procname</envar> 的进程。
          后者是另一个对 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 有意义的变量，
          并且默认它的值跟 <envar xmlns:xlink="http://www.w3.org/1999/xlink">command</envar> 一样。
          换而言之，当我们给 <envar xmlns:xlink="http://www.w3.org/1999/xlink">command</envar> 设置值后，
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">procname</envar> 实际上也设置了同样的值。
          这启动我们的脚本来杀死守护进程并检查它是否正在第一个位置运行。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">某些程序实际上是可执行的脚本。
            系统启动脚本的解释器以传递脚本名为命令行参数的形式来运行脚本。
            然后被映射到进程列表中，这会使 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 迷惑。因此，当
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">$command</envar> 是一个脚本的时，你应该额外地设置
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">command_interpreter</envar> 来让 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
            知晓进程的实际名字。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">对每个 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本而言，
            有一个可选的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 变量给
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">command</envar> 指示其优先级。
            它的名字是下面这样的形式：<envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}_program</envar>，
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">name</envar> 是我们 <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="name-var">之前</link>
            讨论过的必须性变量。如，在这个案例中它应该命名为
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">emumbled_program</envar>。这其实是 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
            分配 <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}_program</envar> 来改写
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">command</envar> 的。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">当然，即使 <envar xmlns:xlink="http://www.w3.org/1999/xlink">command</envar> 未被设置，
            <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 也将允许你从 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 或自身来设置
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}_program</envar>。在那种情况下，
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}_program</envar> 的特定属性丢失了，
            并且它成为了一个能供你的脚本用于其自身目的的普通变量。
            然而，单独使用 <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}_program</envar>
            是并不是我们所寄望的，因为同时使用它和 <envar xmlns:xlink="http://www.w3.org/1999/xlink">command</envar>
            已成为了 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本编程的一个惯用的约定。</para>
	</note>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">关于默认方法的更详细的信息，请参考
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>。</para>
      </callout>
    </calloutlist>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-daemon-adv">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">启动并停止高级守护进程</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">我们来给之前的 <quote xmlns:xlink="http://www.w3.org/1999/xlink">骨架</quote>
      脚本加点 <quote xmlns:xlink="http://www.w3.org/1999/xlink">血肉</quote>，并让它更复杂更富有特性吧。
      默认的方法已能够为我们做很好的工作了，
      但是我们可能会需要它们一些方面的调整。
      现在我们将学习如何调整默认方法来符合我们的需要。</para>

    <informalexample xmlns:xlink="http://www.w3.org/1999/xlink">
      <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">#!/bin/sh

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command="/usr/sbin/${name}"
command_args="mock arguments &gt; /dev/null 2&gt;&amp;1"<co xml:id="rcng-daemon-adv-args"/>

pidfile="/var/run/${name}.pid"<co xml:id="rcng-daemon-adv-pid"/>

required_files="/etc/${name}.conf /usr/share/misc/${name}.rules"<co xml:id="rcng-daemon-adv-reqfiles"/>

sig_reload="USR1"<co xml:id="rcng-daemon-adv-sig"/>

start_precmd="${name}_prestart"<co xml:id="rcng-daemon-adv-precmd"/>
stop_postcmd="echo Bye-bye"<co xml:id="rcng-daemon-adv-postcmd"/>

extra_commands="reload plugh xyzzy"<co xml:id="rcng-daemon-adv-extra"/>

plugh_cmd="mumbled_plugh"<co xml:id="rcng-daemon-adv-methods"/>
xyzzy_cmd="echo 'Nothing happens.'"

mumbled_prestart()
{
	if checkyesno mumbled_smart; then<co xml:id="rcng-daemon-adv-yn"/>
		rc_flags="-o smart ${rc_flags}"<co xml:id="rcng-daemon-adv-rcflags"/>
	fi
	case "$mumbled_mode" in
	foo)
		rc_flags="-frotz ${rc_flags}"
		;;
	bar)
		rc_flags="-baz ${rc_flags}"
		;;
	*)
		warn "Invalid value for mumbled_mode"<co xml:id="rcng-daemon-adv-warn"/>
		return 1<co xml:id="rcng-daemon-adv-preret"/>
		;;
	esac
	run_rc_command xyzzy<co xml:id="rcng-daemon-adv-run"/>
	return 0
}

mumbled_plugh()<co xml:id="rcng-daemon-adv-plugh"/>
{
	echo 'A hollow voice says "plugh".'
}

load_rc_config $name
run_rc_command "$1"</programlisting>
    </informalexample>

    <calloutlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <callout arearefs="rcng-daemon-adv-args">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">附加给 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$command</envar> 的参数在
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">command_args</envar> 中进行传递。它们在
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">$mumbled_flags</envar> 之后将被添加到命令行。
          其实际的执行便是此后最终的命令行传递给
          <command xmlns:xlink="http://www.w3.org/1999/xlink">eval</command> 运算，输入和输出以及重定向都可以在
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">command_args</envar> 中指定。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink"><emphasis xmlns:xlink="http://www.w3.org/1999/xlink">永远不要</emphasis> 在
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">command_args</envar> 包含破折号选项，
            类似 <option xmlns:xlink="http://www.w3.org/1999/xlink">-X</option> 或 <option xmlns:xlink="http://www.w3.org/1999/xlink">--foo</option>
            这样的。<envar xmlns:xlink="http://www.w3.org/1999/xlink">command_args</envar>
            的内容将出现在最终命令行的末尾，因此它们可能是紧接在
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}_flags</envar> 中所列出的参数后面；
            但大多的命令将不能识别出普通参数后的破折号选项。
            更好的传递附加给 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$command</envar>
            的选项的方式是添加它们到 <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}_flags</envar>
            的起始处。另一种方法是像后文所示的那样来修改
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">rc_flags</envar>。</para>
	</note>
      </callout>

      <callout arearefs="rcng-daemon-adv-pid">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">一个得体的守护进程会创建一个
          <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">pidfile</emphasis> 进程文件，
          以使其进程能够更容易更可靠地被找到。如果设置了
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">pidfile</envar> 变量，告诉 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
          哪里能找到供其默认方法所使用的
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">pidfile</envar> 进程文件。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">事实上，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
            在启动一个守护进程前还会使用 pidfile
            进程文件来查看它是否已经在运行。使用了
            <option xmlns:xlink="http://www.w3.org/1999/xlink">faststart</option> 参数可以跳过这个检查步骤。</para>
	</note>
      </callout>

      <callout arearefs="rcng-daemon-adv-reqfiles">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">如果守护进程只有在确定的文件存在的情况下才可以运行，
          那就将它们列到 <envar xmlns:xlink="http://www.w3.org/1999/xlink">required_files</envar> 中，而
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 将在启动守护进程之前检查那些文件是否存在。
          还有相关的分别用来检查目录和环境变量的
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">required_dirs</envar> 和 <envar xmlns:xlink="http://www.w3.org/1999/xlink">required_vars</envar>
          可供使用。它们都在 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 中有详细的说明。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">来自 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 的默认方法，通过使用
            <option xmlns:xlink="http://www.w3.org/1999/xlink">forcestart</option> 作为脚本的参数，
            可以强制性地跳过预先需要的检查。</para>
	</note>
      </callout>

      <callout arearefs="rcng-daemon-adv-sig">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">我们可以在守护进程有异常的时候，自定义发送给守护进程的信号。
          特别是，<envar xmlns:xlink="http://www.w3.org/1999/xlink">sig_reload</envar>
          指定了使守护进程重新装载其配置的信号；默认情况也就是
          <symbol xmlns:xlink="http://www.w3.org/1999/xlink">SIGHUP</symbol> 信号。
          另一个信号是发送给守护进程以停止该进程；默认情况下是
          <symbol xmlns:xlink="http://www.w3.org/1999/xlink">SIGTERM</symbol> 信号，但这是可以通过设置
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">sig_stop</envar> 来进行适当更改的。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">信号名称应当以不包含 <literal xmlns:xlink="http://www.w3.org/1999/xlink">SIG</literal>
            前缀的形式指定给 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>，就如范例中所示的那样。
            FreeBSD 版本的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">kill</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 程序能够识别出
            <literal xmlns:xlink="http://www.w3.org/1999/xlink">SIG</literal> 前缀，不过其它系统版本的就不一定了。</para>
	</note>
      </callout>

      <callout arearefs="rcng-daemon-adv-precmd rcng-daemon-adv-postcmd">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">在默认的方法前面或后面执行附加任务是很容易的。
          对于我们脚本所支持的每条命令参数而言，我们可以定义
          <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_precmd</envar> 和
          <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_postcmd</envar>
          来完成。这些 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 命令分别在它们各自的方法前后被调用，
          显然，从它们各自的名字就能看出来。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">如果我们需要的话，用自定义的
            <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_cmd</envar>
            改写默认的方法，并不妨碍我们仍然使用
            <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_precmd</envar> 和
            <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_postcmd</envar>。
            特别是，前者便于检查自定义的方法，
            以及执行自身命令之前所遇到更严密的条件。于是，将
            <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_precmd</envar> 和
            <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_cmd</envar>
            一起使用，使我们合理地将检查从动作中独立了出来。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">别忘了你可以将任意的有效的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>
            表达式插入到方法和你定义的 pre- 与 post-commands 命令中。
            在大部分情况下，调用函数使实际任务有好的风格，
            但千万不要让风格限制了你对其幕后到底是怎么回事的思考。</para>
	</note>
      </callout>

      <callout arearefs="rcng-daemon-adv-extra">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">如果我们愿意实现一些自定义参数，
          这些参数也可被认作为我们脚本的 <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">命令</emphasis>，我们需要在
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">extra_commands</envar> 中将它们列出并提供方法以处理它们。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink"><option xmlns:xlink="http://www.w3.org/1999/xlink">reload</option> 是个特别的命令。一方面，
            它有一个在 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 中预置的方法。另一方面，
            <option xmlns:xlink="http://www.w3.org/1999/xlink">reload</option> 命令默认是不被提供的。
            理由是并非所有的守护进程都使用同样的重载方法，
            并且有些守护进程根本没有任何东西可重载的。所以显而易见，
            我们需要去询问都提供了哪些的内建功能。我们可以通过
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">extra_commands</envar> 来这样做。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">我们从 <option xmlns:xlink="http://www.w3.org/1999/xlink">reload</option> 的默认方法得到了什么呢？
            守护进程常常在收到一个信号后重新载入它们的配置 ──
            一般来说，也就是 <symbol xmlns:xlink="http://www.w3.org/1999/xlink">SIGHUP</symbol> 信号。因此
            <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 尝试发送一个信号给守护进程来重载它。
            该信号一般预设为 <symbol xmlns:xlink="http://www.w3.org/1999/xlink">SIGHUP</symbol>，
            但是如果必要的话可以通过 <envar xmlns:xlink="http://www.w3.org/1999/xlink">sig_reload</envar>
            变量来自定义它。</para>
	</note>
      </callout>

      <callout arearefs="rcng-daemon-adv-methods rcng-daemon-adv-plugh">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">我们的脚本提供了两个非标准的命令，
          <option xmlns:xlink="http://www.w3.org/1999/xlink">plugh</option> 和 <option xmlns:xlink="http://www.w3.org/1999/xlink">xyzzy</option>。
          我们看到它们在 <envar xmlns:xlink="http://www.w3.org/1999/xlink">extra_commands</envar> 中被列出来了，
          并且现在是时候给它们提供方法了。<option xmlns:xlink="http://www.w3.org/1999/xlink">xyzzy</option>
          的方法是内联的而 <option xmlns:xlink="http://www.w3.org/1999/xlink">plugh</option> 的是以
          <function xmlns:xlink="http://www.w3.org/1999/xlink">mumbled_plugh</function> 形式完成的函数。</para>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">非标准命令在启动或停止的时候不被调用。
          通常它们是为了系统管理员的方便。它们还能被其它的子系统所使用，
          例如，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">devd</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>，前提是 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">devd.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 中已经指定了。</para>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">全部可用命令的列表，当脚本不加参数地调用时，在
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 打印出的使用方法中能够找到。例如，
          这就是供学习的脚本用法的内容：</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/mumbled</userinput>
Usage: /etc/rc.d/mumbled [fast|force|one](start|stop|restart|rcvar|reload|plugh|xyzzy|status|poll)</screen>
      </callout>

      <callout arearefs="rcng-daemon-adv-run">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">如果脚本需要的话，它可以调用自己的标准或非标准的命令。
          这可能看起来有点像函数的调用，但我们知道，命令和 shell
          函数并非一直都是同样的东西。举个例子，<command xmlns:xlink="http://www.w3.org/1999/xlink">xyzzy</command>
          在这里不是以函数来实现的。另外，还有应该被有序调用的
          pre-command 预置命令和 post-command 后置命令。
          所以脚本运行自己命令的合适方式就是利用 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>，
          就像范例中展示的那样。</para>
      </callout>

      <callout arearefs="rcng-daemon-adv-yn">
        <para xmlns:xlink="http://www.w3.org/1999/xlink"><citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 提供了一个方便的函数叫做
          <function xmlns:xlink="http://www.w3.org/1999/xlink">checkyesno</function>。
          它以一个变量名作为参数并返回一个为零的退出值，
          当且仅当该变量设置为 <literal xmlns:xlink="http://www.w3.org/1999/xlink">YES</literal>，或
          <literal xmlns:xlink="http://www.w3.org/1999/xlink">TRUE</literal>，或 <literal xmlns:xlink="http://www.w3.org/1999/xlink">ON</literal>，或
          <literal xmlns:xlink="http://www.w3.org/1999/xlink">1</literal>，区分大小写；否则返回一个非零的退出值。
          在第二种情况中，函数测试变量的设置为 <literal xmlns:xlink="http://www.w3.org/1999/xlink">NO</literal>，
          <literal xmlns:xlink="http://www.w3.org/1999/xlink">FALSE</literal>，<literal xmlns:xlink="http://www.w3.org/1999/xlink">OFF</literal>，或
          <literal xmlns:xlink="http://www.w3.org/1999/xlink">0</literal>，区分大小写；
          如果变量包含别的内容的话它打印一条警告信息，例如，垃圾。</para>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">切记对 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 而言零值意味着真而非零值意味着假。</para>

	<important xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink"><function xmlns:xlink="http://www.w3.org/1999/xlink">checkyesno</function> 函数使用一个
            <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">变量名</emphasis>。不要扩大含义将变量的
            <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">值</emphasis> 传递给它；
            否则它不会如你预期那样的工作。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">下面是 <function xmlns:xlink="http://www.w3.org/1999/xlink">checkyesno</function>
            的合理使用范围：</para>

	  <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">if checkyesno mumbled_enable; then
        foo
fi</programlisting>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">相反地，以下面的方式调用 <function xmlns:xlink="http://www.w3.org/1999/xlink">checkyesno</function>
            是不会工作的 -- 至少是不会如你预期的那样：</para>

	  <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">if checkyesno "${mumbled_enable}"; then
        foo
fi</programlisting>
	</important>
      </callout>

      <callout arearefs="rcng-daemon-adv-rcflags">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">我们可以通过修改 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$start_precmd</envar> 中的
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">rc_flags</envar> 来影响传递到
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">$command</envar> 的标帜。</para>
      </callout>

      <callout arearefs="rcng-daemon-adv-warn">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">某种情况下我们可能需要发出一条重要的信息，那样的话
          <application xmlns:xlink="http://www.w3.org/1999/xlink">syslog</application> 可以很好地记录日志。
          这可以使用下列 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 函数来轻松完成：
          <function xmlns:xlink="http://www.w3.org/1999/xlink">debug</function>，<function xmlns:xlink="http://www.w3.org/1999/xlink">info</function>，
          <function xmlns:xlink="http://www.w3.org/1999/xlink">warn</function>，以及 <function xmlns:xlink="http://www.w3.org/1999/xlink">err</function>。
          后者以指定的代码值退出脚本。</para>
      </callout>

      <callout arearefs="rcng-daemon-adv-preret">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">方法的退出值和它们的 pre-commands 预命令不只是默认被忽略掉。如果
          <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_precmd</envar>
          返回了一个非零退出值，主方法将不会被执行。依次地是，
          <envar xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">argument</replaceable>_postcmd</envar>
          将不会被调用，除非主方法返回的是一个为零的退出值。</para>

	  <note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">然而，当给一个参数使用 <literal xmlns:xlink="http://www.w3.org/1999/xlink">force</literal>
            前缀的时候，如 <option xmlns:xlink="http://www.w3.org/1999/xlink">forcestart</option>，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
            会听从命令行指示而忽略那些退出值最后仍然调用所有的命令。</para>
	</note>
      </callout>
    </calloutlist>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-hookup">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">链接脚本到 rc.d 框架</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">当编写好了一个脚本，它需要被整合到 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 中去。
      一个重要的步骤就是安装脚本到 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d</filename>
      （对基本系统而言）或 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/usr/local/etc/rc.d</filename>
      （对ports而言）中去。在 &lt;<filename xmlns:xlink="http://www.w3.org/1999/xlink">bsd.prog.mk</filename>&gt; 和
      &lt;<filename xmlns:xlink="http://www.w3.org/1999/xlink">bsd.port.mk</filename>&gt; 中都为此提供了方便的接口，
      通常你不必担心适当的所有权限和模式。系统脚本应当是通过可以在
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">src/etc/rc.d</filename> 找到的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">Makefile</filename>
      安装的。Port 脚本可以像
      <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.FreeBSD.org/doc/en_US.ISO8859-1/books/porters-handbook/rc-scripts.html">Porter's Handbook</link>
      中描述那样通过使用 <varname xmlns:xlink="http://www.w3.org/1999/xlink">USE_RC_SUBR</varname> 来被安装。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">不过，我们应该预先考虑到我们脚本在系统启动顺序中的位置。
      我们的脚本所处理的服务可能依赖于其它的服务。举个例子，
      没有网络接口和路由选择的启用运行的话，一个网络守护进程是不起作用的。
      即使一个服务看似什么都不需要，在基本文件系统检查挂载完毕之前也很难启动。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">之前我们曾提到过 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>。现在是时候来密切地关注下它了。
      笼统地说，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 处理一组文件，检验它们的内容，
      并从文件集合打印一个文件列表的依赖顺序到 <varname xmlns:xlink="http://www.w3.org/1999/xlink">stdout</varname>
      标准输出。这点是用于保持文件内部的依赖信息，
      而每个文件只能说明自己的依赖。一个文件可以指定如下信息：</para>

    <itemizedlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">它 <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">提供</emphasis> 的 <quote xmlns:xlink="http://www.w3.org/1999/xlink">条件</quote>
          的名字（意味着我们服务的名字）；</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">它 <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">需求</emphasis> 的
          <quote xmlns:xlink="http://www.w3.org/1999/xlink">条件</quote> 的名字；</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">应该 <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">先</emphasis> 运行的文件的
          <quote xmlns:xlink="http://www.w3.org/1999/xlink">条件</quote>的名字；</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">能用于从全部文件集合中选择一个子集的额外
          <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">关键字</emphasis>（ <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
          可通过选项而被指定来包括或省去由特殊关键字所列出的文件。）</para>
      </listitem>
    </itemizedlist>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">并不奇怪的是，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 只能处理接近 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>
      语法的文本文件。<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 所解读的特殊行看起来类似
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 的注释。这种特殊文本行的语法相当严格地简化了其处理。
      请查阅 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 以获取更详细的信息。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">除使用 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 的特殊行以外，
      脚本可以坚持将其依赖的其它服务强制性启动。当其它服务是可选的，
      并因系统管理员错误地在 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry>
      中禁用掉该服务而使其不能自行启动时，会需要这一点。</para>

     <para xmlns:xlink="http://www.w3.org/1999/xlink">将这些谨记在心，我们来考虑下简单结合了依赖信息增强的守护进程脚本：</para>

    <informalexample xmlns:xlink="http://www.w3.org/1999/xlink">
      <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">#!/bin/sh

# PROVIDE: mumbled oldmumble <co xml:id="rcng-hookup-provide"/>
# REQUIRE: DAEMON cleanvar frotz<co xml:id="rcng-hookup-require"/>
# BEFORE:  LOGIN<co xml:id="rcng-hookup-before"/>
# KEYWORD: nojail shutdown<co xml:id="rcng-hookup-keyword"/>

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command="/usr/sbin/${name}"
start_precmd="${name}_prestart"

mumbled_prestart()
{
	if ! checkyesno frotz_enable &amp;&amp; \
	    ! /etc/rc.d/frotz forcestatus 1&gt;/dev/null 2&gt;&amp;1; then
		force_depend frotz || return 1<co xml:id="rcng-hookup-force"/>
	fi
	return 0
}

load_rc_config $name
run_rc_command "$1"</programlisting>
    </informalexample>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">跟前面一样，做如下详细分析：</para>

    <calloutlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <callout arearefs="rcng-hookup-provide">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">该行声明了我们脚本所提供的 <quote xmlns:xlink="http://www.w3.org/1999/xlink">条件</quote> 的名字。
          现在其它脚本可以用那些名字来标明我们脚本的依赖。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">通常脚本指定一个单独的已提供的条件。然而，
            并没有什么妨碍我们从列出的那些条件中指定，例如，
            为了兼容性的目的。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">在其它情况，主要的名称，或者说唯一的，
            <literal xmlns:xlink="http://www.w3.org/1999/xlink">PROVIDE:</literal> 条件应该与
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">${name}</envar> 相同。</para>
	</note>
      </callout>

      <callout arearefs="rcng-hookup-require rcng-hookup-before">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">因此我们的脚本指示了其依赖于别的脚本所提供的
          <quote xmlns:xlink="http://www.w3.org/1999/xlink">条件</quote>。根据这些行的信息，脚本请示
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 以将其放在一个或多个提供
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">DAEMON</filename> 和 <filename xmlns:xlink="http://www.w3.org/1999/xlink">cleanvar</filename>
          的脚本后面，但在提供 <filename xmlns:xlink="http://www.w3.org/1999/xlink">LOGIN</filename> 的脚本前面。</para>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">BEFORE:</literal>
            这一行不可以在其它脚本不完整的依赖关系列表中滥用。
            适合使用 <literal xmlns:xlink="http://www.w3.org/1999/xlink">BEFORE:</literal>
            的情况是当其它脚本不关心我们的脚本，
            但是我们的脚本如果在另一个之前运行的话能够更好地执行任务。
            一个典型的实例是网络接口和防火墙：
            虽然接口不依赖防火墙来完成自己的工作，
            但是系统安全将因一切网络流量之前启动的防火墙而受益。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">除了条件相对应的每个单独服务，脚本使用元条件和它们的
            <quote xmlns:xlink="http://www.w3.org/1999/xlink">占位符</quote> 来保证某个操作组在其它之前被执行。
            这些是由 <filename xmlns:xlink="http://www.w3.org/1999/xlink">UPPERCASE</filename>
            大写名字所表示的。它们的列表和用法可以在 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 中找到。</para>

          <para xmlns:xlink="http://www.w3.org/1999/xlink">切记将一个服务名称放进 <literal xmlns:xlink="http://www.w3.org/1999/xlink">REQUIRE:</literal>
            行不能保证实际的服务会在我们的脚本启动的时候运行。
            所需求的服务可能会启动失败或在 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 中被禁掉了。
            显然，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 是无法追踪这些细节的，并且
            <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 也不会去追踪。所以，
            脚本启动的应用程序应当能够应付任何所需求的服务的不可用情况。
            某些情况下，我们可以用 <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="forcedep">下面</link>
            所讨论的方式来协助脚本。</para>
	</note>
      </callout>

      <callout arearefs="rcng-hookup-keyword">
        <para xmlns:xlink="http://www.w3.org/1999/xlink"><anchor xml:id="keywords"/>如我们从上述文字所记起的，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
            关键字可以用来选择或省略某些脚本。即任何 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
            用户可以通过指定 <option xmlns:xlink="http://www.w3.org/1999/xlink">-k</option> 和 <option xmlns:xlink="http://www.w3.org/1999/xlink">-s</option>
            选项来分别指定 <quote xmlns:xlink="http://www.w3.org/1999/xlink">保留清单（keep list）</quote> 和
            <quote xmlns:xlink="http://www.w3.org/1999/xlink">跳过清单（skip list）</quote>。
            从全部文件到按依赖关系排列的清单，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
            将只是挑出保留清单（除非是空的）
            中那些带关键字的以及从跳过清单中挑出不带关键字的文件。</para>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">在 FreeBSD 中，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 被
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc</filename> 和
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.shutdown</filename> 所使用。
          这两个脚本定义了 FreeBSD 中 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
          关键字以及它们的意义的标准列表如下：</para>

	<variablelist xmlns:xlink="http://www.w3.org/1999/xlink">
	  <varlistentry xmlns:xlink="http://www.w3.org/1999/xlink">
	    <term xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">nojail</literal></term>

	    <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
              <para xmlns:xlink="http://www.w3.org/1999/xlink">该服务不适用于 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">jail</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 环境。
                如果是在 jail 的内部的话，自动启动和关闭程序将忽略该脚本。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry xmlns:xlink="http://www.w3.org/1999/xlink">
	    <term xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">nostart</literal></term>

	    <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
              <para xmlns:xlink="http://www.w3.org/1999/xlink">该服务只能手动启动否则将不会启动。
                自动启动程序将忽略此脚本。结合 <literal xmlns:xlink="http://www.w3.org/1999/xlink">shutdown</literal>
                关键字的话，这可以用来编写只在系统关闭时执行一些任务的脚本。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry xmlns:xlink="http://www.w3.org/1999/xlink">
	    <term xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">shutdown</literal></term>

	    <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
              <para xmlns:xlink="http://www.w3.org/1999/xlink">这个关键字 <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">明确</emphasis>
                地列出了需要在系统关闭前停止的服务。</para>

	      <note xmlns:xlink="http://www.w3.org/1999/xlink">
                <para xmlns:xlink="http://www.w3.org/1999/xlink">当系统即将关闭的时候，
                  <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.shutdown</filename> 在运行。
                  它假定认为大部分的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
                  脚本在那刻什么都不做。因此，
                  <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.shutdown</filename>
                  选择性地调用带有 <literal xmlns:xlink="http://www.w3.org/1999/xlink">shutdown</literal>
                  关键字的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本，
                  有效地忽略其余的脚本。为了更快的关闭，
                  <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.shutdown</filename> 传递
                  <option xmlns:xlink="http://www.w3.org/1999/xlink">faststop</option> 命令给其运行的脚本，
                  以跳过预置的检查，例如，进程文件 pidfile 的检查。
                  正如依赖性服务应该在其所依赖的服务之前停止，
                  <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.shutdown</filename>
                  以相反的依赖次序来运行这些脚本。</para>

                <para xmlns:xlink="http://www.w3.org/1999/xlink">如果写一个真正的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本的话，
                  你应当考虑到其是否与系统关闭时有关系。例如，
                  如果你的脚本只通过响应 <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option>
                  命令来运行任务，那么你不需要包含这个关键字。然而，
                  如果你的脚本管理着一个服务，那么，在系统进入 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">halt</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
                  中所描述的其本身关闭顺序的最终阶段之前停止该脚本，
                  可能是个不错的主意。特别是，
                  你显然是应该关闭一个需要相当长时间，
                  或需要特定的动作才能干净地关闭的服务。
                  数据库引擎就是这样一个典型的例子。</para>
	      </note>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </callout>

      <callout arearefs="rcng-hookup-force">
        <para xmlns:xlink="http://www.w3.org/1999/xlink"><anchor xml:id="forcedep"/>以
            <function xmlns:xlink="http://www.w3.org/1999/xlink">force_depend</function>
            起始的行应被用于更谨慎的情况。通常，用于修正相互关联的
            <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
            脚本分层结构的配置文件时会更加稳妥。</para>

        <para xmlns:xlink="http://www.w3.org/1999/xlink">如果你仍不能完成不含 <function xmlns:xlink="http://www.w3.org/1999/xlink">force_depend</function> 的脚本，
          范例提供了一个如何有条件地调用它的习惯用法。在范例中，我们的
          <command xmlns:xlink="http://www.w3.org/1999/xlink">mumbled</command> 守护进程需求另一个以高级方式启动的进程，
          <command xmlns:xlink="http://www.w3.org/1999/xlink">frotz</command>。但 <command xmlns:xlink="http://www.w3.org/1999/xlink">frotz</command> 也是可选的；
          而且 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 对这些信息是一无所知的。幸运的是，
          我们的脚本已访问到全部的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 变量。如果
          <envar xmlns:xlink="http://www.w3.org/1999/xlink">frotz_enable</envar> 为真，我们希望的最好结果是依靠
          <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 已经启动了 <command xmlns:xlink="http://www.w3.org/1999/xlink">frotz</command>。
          否则我们强制检查 <command xmlns:xlink="http://www.w3.org/1999/xlink">frotz</command> 的状态。最终，
          如果 <command xmlns:xlink="http://www.w3.org/1999/xlink">frotz</command> 依赖的服务没有找到或运行的话，
          我们将强制其运行。这时 <function xmlns:xlink="http://www.w3.org/1999/xlink">force_depend</function>
          将发出一条警告信息，因为它只应该在检查到配置信息丢失的情况下被调用。</para>
      </callout>
    </calloutlist>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-args">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">给予 rc.d 脚本更多的灵活性</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">当进行启动或停止的调用时，<filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
      脚本应该作用于其所负责的整个子系统。例如，
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/netif</filename> 应该启动或停止
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 中所描述的全部网络接口。每个任务都唯一地听从一个如
      <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option> 或 <option xmlns:xlink="http://www.w3.org/1999/xlink">stop</option>
      这样的单独命令参数的指示。在启动和停止之间的时间，
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本帮助管理员控制运行中的系统，
      并其在需要的时候它将产生更多的灵活性和精确性。举个例子，
      管理员可能想在 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">5</manvolnum></citerefentry> 中添加一个新网络接口的配置信息，
      然后在不妨碍其它已存在接口的情况下将其启动。
      在下次管理员可能需要关闭一个单独的网络接口。在魔幻的命令行中，
      对应的 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 脚本调用一个额外的参数，
      网络接口名即可。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">幸运的是，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 允许传递任意多（取决于系统限制）的参数给脚本的方法。
      由于这个原因，脚本自身的改变可以说是微乎其微。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink"><citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 如何访问到附加的命令行参数呢？直接获取么？
      并非是无所不用其极的。首先，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>
      函数没有访问到调用者的定位参数，而 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>
      只是这些函数的容器。其次，<filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename>
      指令的一个好的风格是由主函数来决定将哪些参数传递给它的方法。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">所以 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 提供了如下的方法：
      <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_command</function>
      传递其所有参数但将第一个参数逐字传递到各自的方法。首先，
      发出以方法自身为名字的参数：<option xmlns:xlink="http://www.w3.org/1999/xlink">start</option>，
      <option xmlns:xlink="http://www.w3.org/1999/xlink">stop</option>，等等。这会被
      <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_command</function> 移出，
      这样命令行中原本 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$2</envar> 的内容将作为
      <envar xmlns:xlink="http://www.w3.org/1999/xlink">$1</envar> 来提供给方法，等等。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">为了说明这点，我们来修改原来的虚拟脚本，
      这样它的信息将取决于所提供的附加参数。从这里出发：</para>

    <informalexample xmlns:xlink="http://www.w3.org/1999/xlink">
      <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">#!/bin/sh

. /etc/rc.subr

name="dummy"
start_cmd="${name}_start"
stop_cmd=":"
kiss_cmd="${name}_kiss"
extra_commands="kiss"

dummy_start()
{
        if [ $# -gt 0 ]; then<co xml:id="rcng-args-start"/>
                echo "Greeting message: $*"
        else
                echo "Nothing started."
        fi
}

dummy_kiss()
{
        echo -n "A ghost gives you a kiss"
        if [ $# -gt 0 ]; then<co xml:id="rcng-args-kiss"/>
                echo -n " and whispers: $*"
        fi
        case "$*" in
        *[.!?])
                echo
                ;;
        *)
                echo .
                ;;
        esac
}

load_rc_config $name
run_rc_command "$@"<co xml:id="rcng-args-all"/></programlisting>
    </informalexample>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">能注意到脚本里发生了那些实质性改变么？</para>

    <calloutlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <callout arearefs="rcng-args-start">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">你输入的所有在 <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option>
          之后的参数可以被当作各自方法的定位参数一样被终结。
          我们可以根据我们的任务、技巧和想法来以任何方式使用他们。
          在当前的例子中，我们只是以下行中字符串的形式传递参数给
          <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">echo</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 程序 ── 注意 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$*</envar>
          是有双引号的。这里是脚本如何被调用的：</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/dummy start</userinput>
Nothing started.
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/dummy start Hello world!</userinput>
Greeting message: Hello world!</screen>
      </callout>

      <callout arearefs="rcng-args-kiss">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">同样用于我们脚本提供的任何方法，并不仅限于标准的方法。
          我们已经添加了一个自定义的叫做 <option xmlns:xlink="http://www.w3.org/1999/xlink">kiss</option> 的方法，
          并且它给附加参数带来的戏耍决不亚于 <option xmlns:xlink="http://www.w3.org/1999/xlink">start</option>。
          例如：</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/dummy kiss</userinput>
A ghost gives you a kiss.
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/dummy kiss Once I was Etaoin Shrdlu...</userinput>
A ghost gives you a kiss and whispers: Once I was Etaoin Shrdlu...</screen>
      </callout>

      <callout arearefs="rcng-args-all">
        <para xmlns:xlink="http://www.w3.org/1999/xlink">如果我们只是传递所有附加参数给任意的方法，
          我们只需要在脚本的最后一行我们调用
          <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_command</function> 的地方，
          用 <literal xmlns:xlink="http://www.w3.org/1999/xlink">"$@</literal> 代替 <literal xmlns:xlink="http://www.w3.org/1999/xlink">"$1"</literal> 即可。</para>

	<important xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">一个 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> 程序员应该是可以理解
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">$*</envar> 和 <envar xmlns:xlink="http://www.w3.org/1999/xlink">$@</envar>
            的微妙区别只是指定全部定位参数的不同方法。
            关于此更深入的探讨，可以参考这个很好的 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>
            脚本编程手册。在你完全理解这些表达式的意义之前请不要使用它们，
            因为误用它们将给脚本引入缺陷和不安全的弊端。</para>
	</important>

	<note xmlns:xlink="http://www.w3.org/1999/xlink">
          <para xmlns:xlink="http://www.w3.org/1999/xlink">现在 <function xmlns:xlink="http://www.w3.org/1999/xlink">run_rc_command</function> 可能有个缺陷，
            它将影响保持参数之间的原本边界。也就是，
            带有嵌入空白的参数可能不会被正确处理。该缺陷是由于对
            <envar xmlns:xlink="http://www.w3.org/1999/xlink">$*</envar> 的误用。</para>
	</note>
      </callout>
    </calloutlist>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="rcng-furthur">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">进一步阅读</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink"><anchor xml:id="lukem"/><link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.mewburn.net/luke/papers/rc.d.pdf">
          Luke Mewburn 的原始文章</link> 中讲述了
        <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 的基本概要，
        并详细阐述了其设计方案的原理。该文章提供了深入了解整个
        <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 框架以及其所在的现代 BSD
        操作系统的内容。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink"><anchor xml:id="manpages"/>在 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>，<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>，
        还有 <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rcorder</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 的联机手册中，对
        <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 组件做了非常详细的记载。
        在你写脚本时，如果不去学习和参考这些联机手册的话，
        你是无法完全发挥出 <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.d</filename> 的能量的。</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">工作中实际范例的主要来源就是运行的系统中的
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d</filename> 目录。
      它的内容可读性非常好，因为大部分的枯燥的内容都深藏在
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">rc.subr</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> 中了。切记 <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d</filename>
      的脚本也不是神仙写出来的，
      所以它们可能也存在着代码缺陷以及低级的设计方案。
      但现在你可以来改进它们了！</para>
  </sect1>
</article>
