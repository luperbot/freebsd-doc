<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>5.3. 使用SYSINIT</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 系统结构手册" /><link rel="up" href="sysinit.html" title="第 5 章 SYSINIT框架" /><link rel="prev" href="sysinit-operation.html" title="5.2. SYSINIT操作" /><link rel="next" href="mac.html" title="第 6 章 TrustedBSD MAC 框架" /><link rel="copyright" href="trademarks.html" title="法律声明" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5.3. 使用SYSINIT</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="sysinit-operation.html">上一页</a> </td><th width="60%" align="center">第 5 章 SYSINIT框架</th><td width="20%" align="right"> <a accesskey="n" href="mac.html">下一页</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sysinit-using"></a>5.3. 使用SYSINIT</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp67377360"></a>5.3.1. 接口</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp67378000"></a>5.3.1.1. 头文件</h4></div></div></div><pre class="programlisting">&lt;sys/kernel.h&gt;</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp67379152"></a>5.3.1.2. 宏</h4></div></div></div><pre class="programlisting">SYSINIT(uniquifier, subsystem, order, func, ident)
SYSUNINIT(uniquifier, subsystem, order, func, ident)</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp67380560"></a>5.3.2. 启动</h3></div></div></div><p>宏<code class="literal">SYSINIT()</code>在SYSINIT启动数据集合中
        建立一个SYSINIT数据项，以便SYSINIT在系统启动或模块加载时排序
        并执行其中的函数。<code class="literal">SYSINIT()</code>有一个参数uniquifier，
        SYSINIT用它来标识数据项，随后是子系统顺序号、子系统元素顺序号、
        待调用函数、传递给函数的数据。所有的函数必须有一个恒量指针参数。</p><div class="example"><a id="idp67382352"></a><div class="example-title">例 5.1. <code class="literal">SYSINIT()</code>的例子</div><div class="example-contents"><pre class="programlisting">#include &lt;sys/kernel.h&gt;

void foo_null(void *unused)
{
        foo_doo();
}
SYSINIT(foo, SI_SUB_FOO, SI_ORDER_FOO, foo_null, NULL);

struct foo foo_voodoo = {
        FOO_VOODOO;
}

void foo_arg(void *vdata)
{
        struct foo *foo = (struct foo *)vdata;
        foo_data(foo);
}
SYSINIT(bar, SI_SUB_FOO, SI_ORDER_FOO, foo_arg, &amp;foo_voodoo);
	</pre></div></div><br class="example-break" /><p>注意，<code class="literal">SI_SUB_FOO</code>和<code class="literal">SI_ORDER_FOO</code>
         应当分别在上面提到的枚举<code class="literal">sysinit_sub_id</code>和
         <code class="literal">sysinit_elem_order</code>之中。既可以使用已有的枚举项，
         也可以将自己的枚举项添加到这两个枚举的定义之中。
         你可以使用数学表达式微调SYSINIT的执行顺序。
         以下的例子示例了一个需要刚好要在内核参数调整的SYSINIT之前执行的SYSINIT。</p><div class="example"><a id="idp67385680"></a><div class="example-title">例 5.2. 调整<code class="literal">SYSINIT()</code>顺序的例子</div><div class="example-contents"><pre class="programlisting">static void
mptable_register(void *dummy __unused)
{

	apic_register_enumerator(&amp;mptable_enumerator);
}

SYSINIT(mptable_register, SI_SUB_TUNABLES - 1, SI_ORDER_FIRST,
    mptable_register, NULL);</pre></div></div><br class="example-break" /></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp67387344"></a>5.3.3. 析构</h3></div></div></div><p>宏<code class="literal">SYSUNINIT()</code>的行为与<code class="literal">SYSINIT()</code>的相当，
        只是它将数据项填加至SYSINIT的析构数据集合。</p><div class="example"><a id="idp67389264"></a><div class="example-title">例 5.3. <code class="literal">SYSUNINIT()</code>的例子</div><div class="example-contents"><pre class="programlisting">#include &lt;sys/kernel.h&gt;

void foo_cleanup(void *unused)
{
        foo_kill();
}
SYSUNINIT(foobar, SI_SUB_FOO, SI_ORDER_FOO, foo_cleanup, NULL);

struct foo_stack foo_stack = {
        FOO_STACK_VOODOO;
}

void foo_flush(void *vdata)
{
}
SYSUNINIT(barfoo, SI_SUB_FOO, SI_ORDER_FOO, foo_flush, &amp;foo_stack);
	</pre></div></div><br class="example-break" /></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sysinit-operation.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="sysinit.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="mac.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">5.2. SYSINIT操作 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 第 6 章 TrustedBSD MAC 框架</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文档和其它文档可从这里下载：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>如果对于FreeBSD有问题，请先阅读
    <a href="http://www.FreeBSD.org/docs.html">文档</a>，如不能解决再联系
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    关于本文档的问题请发信联系
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.</small></p></body></html>