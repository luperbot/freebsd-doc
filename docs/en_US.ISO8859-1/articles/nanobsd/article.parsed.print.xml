<?xml version="1.0" encoding="iso-8859-1"?>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:lang="en"> <info>
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Introduction to NanoBSD</title>

    <authorgroup xmlns:xlink="http://www.w3.org/1999/xlink">
      <author xmlns:xlink="http://www.w3.org/1999/xlink"><personname xmlns:xlink="http://www.w3.org/1999/xlink"><firstname xmlns:xlink="http://www.w3.org/1999/xlink">Daniel</firstname><surname xmlns:xlink="http://www.w3.org/1999/xlink">Gerzo</surname></personname></author>
    </authorgroup>

    <copyright xmlns:xlink="http://www.w3.org/1999/xlink">
      <year xmlns:xlink="http://www.w3.org/1999/xlink">2006</year>
      <holder xmlns:xlink="http://www.w3.org/1999/xlink">The FreeBSD Documentation Project</holder>
    </copyright>

    <legalnotice xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="trademarks" role="trademarks">
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">FreeBSD is a registered trademark of
  the FreeBSD Foundation.</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">Many of the designations used by
  manufacturers and sellers to distinguish their products are claimed
  as trademarks.  Where those designations appear in this document,
  and the FreeBSD Project was aware of the trademark claim, the
  designations have been followed by the <quote xmlns:xlink="http://www.w3.org/1999/xlink">&#8482;</quote> or the
  <quote xmlns:xlink="http://www.w3.org/1999/xlink">®</quote> symbol.</para>
    </legalnotice>

    <pubdate xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</pubdate>

    <releaseinfo xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</releaseinfo>

    <abstract xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">This document provides information about the
	<application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> tools, which can be used to
	create FreeBSD system images for embedded applications, suitable
	for use on a Compact Flash card (or other mass storage
	medium).</para>
    </abstract>
  </info>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="intro">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Introduction to NanoBSD</title>

    <indexterm xmlns:xlink="http://www.w3.org/1999/xlink"><primary xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</primary></indexterm>

    <para xmlns:xlink="http://www.w3.org/1999/xlink"><application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> is a tool currently
      developed by Poul-Henning Kamp <email xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">phk@FreeBSD.org</email>.  It creates a FreeBSD system image for
      embedded applications, suitable for use on a Compact Flash card
      (or other mass storage medium).</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">It can be used to build specialized install images, designed
      for easy installation and maintenance of systems commonly called
      <quote xmlns:xlink="http://www.w3.org/1999/xlink">computer appliances</quote>.  Computer appliances have
      their hardware and software bundled in the product, which means
      all applications are pre-installed.  The appliance is plugged
      into an existing network and can begin working (almost)
      immediately.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">The features of <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application>
      include:</para>

    <itemizedlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Ports and packages work as in FreeBSD &#8212; Every single
	  application can be installed and used in a
	  <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> image, the same way as in
	  FreeBSD.</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">No missing functionality &#8212; If it is possible to do
	  something with FreeBSD, it is possible to do the same thing
	  with <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application>, unless the specific
	  feature or features were explicitly removed from the
	  <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> image when it was
	  created.</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Everything is read-only at run-time &#8212; It is safe
	  to pull the power-plug.  There is no necessity to run
	  <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">fsck</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> after a non-graceful shutdown of the
	  system.</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Easy to build and customize &#8212; Making use of just
	  one shell script and one configuration file it is possible
	  to build reduced and customized images satisfying any
	  arbitrary set of requirements.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="howto">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD Howto</title>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="design">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">The Design of NanoBSD</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Once the image is present on the medium, it is possible to
	boot <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application>.  The mass storage
	medium is divided into three parts by default:</para>

      <itemizedlist xmlns:xlink="http://www.w3.org/1999/xlink">
	<listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Two image partitions: <literal xmlns:xlink="http://www.w3.org/1999/xlink">code#1</literal>
	    and <literal xmlns:xlink="http://www.w3.org/1999/xlink">code#2</literal>.</para>
	</listitem>

	<listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">The configuration file partition, which can be mounted
	    under the <filename xmlns:xlink="http://www.w3.org/1999/xlink">/cfg</filename> directory
	    at run time.</para>
	</listitem>
      </itemizedlist>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">These partitions are normally mounted read-only.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">The <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc</filename> and
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename> directories are
	<citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">md</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">4</manvolnum></citerefentry> (malloc) disks.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">The configuration file partition persists under the
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/cfg</filename> directory.  It
	contains files for <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc</filename>
	directory and is briefly mounted read-only right after the
	system boot, therefore it is required to copy modified files
	from <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc</filename> back to the
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/cfg</filename> directory if changes
	are expected to persist after the system restarts.</para>

      <example xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Making Persistent Changes to
	  <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/resolv.conf</filename></title>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">vi /etc/resolv.conf</userinput>
[...]
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">mount /cfg</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">cp /etc/resolv.conf /cfg</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">umount /cfg</userinput></screen>
      </example>

      <note xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">The partition containing
	  <filename xmlns:xlink="http://www.w3.org/1999/xlink">/cfg</filename> should be mounted
	  only at boot time and while overriding the configuration
	  files.</para>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Keeping <filename xmlns:xlink="http://www.w3.org/1999/xlink">/cfg</filename> mounted at all times
	  is not a good idea, especially if the
	  <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> system runs off a mass
	  storage medium that may be adversely affected by a large
	  number of writes to the partition (like when the filesystem
	  syncer flushes data to the system disks).</para>
      </note>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Building a NanoBSD Image</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">A <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> image is built using
	a simple <filename xmlns:xlink="http://www.w3.org/1999/xlink">nanobsd.sh</filename> shell script, which
	can be found in the
	<filename xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">/usr</replaceable>/src/tools/tools/nanobsd</filename>
	directory.  This script creates an image, which can be copied
	on the storage medium using the <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">dd</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry> utility.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">The necessary commands to build a
	<application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> image are:</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">cd /usr/src/tools/tools/nanobsd</userinput> <co xml:id="nbsd-cd"/>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">sh nanobsd.sh</userinput> <co xml:id="nbsd-sh"/>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">cd /usr/obj/nanobsd.full</userinput> <co xml:id="nbsd-cd2"/>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">dd if=_.disk.full of=/dev/da0 bs=64k</userinput> <co xml:id="nbsd-dd"/></screen>

      <calloutlist xmlns:xlink="http://www.w3.org/1999/xlink">
	<callout arearefs="nbsd-cd">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Change the current directory to the base directory of
	    the <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> build
	    script.</para>
	</callout>

	<callout arearefs="nbsd-sh">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Start the build process.</para>
	</callout>

	<callout arearefs="nbsd-cd2">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Change the current directory to the place where the
	    built images are located.</para>
	</callout>

	<callout arearefs="nbsd-dd">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Install <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> onto the
	    storage medium.</para>
	</callout>
      </calloutlist>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Customizing a NanoBSD Image</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">This is probably the most important and most interesting
	feature of <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application>.  This is also
	where you will be spending most of the time when
	developing with <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application>.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Invocation of the following command will force the
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">nanobsd.sh</filename> to read its configuration from
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">myconf.nano</filename> located in the current
	directory:</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">sh nanobsd.sh -c myconf.nano</userinput></screen>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Customization is done in two ways:</para>

      <itemizedlist xmlns:xlink="http://www.w3.org/1999/xlink">
	<listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Configuration options</para>
	</listitem>

	<listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Custom functions</para>
	</listitem>
      </itemizedlist>

      <sect3 xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Configuration Options</title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">With configuration settings, it is possible to configure
	  options passed to both the
	  <buildtarget>buildworld</buildtarget> and
	  <buildtarget>installworld</buildtarget> stages of the
	  <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> build process, as well as
	  internal options passed to the main build process of
	  <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application>.  Through these options
	  it is possible to cut the system down, so it will fit on as
	  little as 64MB.  You can use the configuration options to
	  trim down FreeBSD even more, until it will consists of just the
	  kernel and two or three files in the userland.</para>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">The configuration file consists of configuration
	  options, which override the default values.  The most
	  important directives are:</para>

	<itemizedlist xmlns:xlink="http://www.w3.org/1999/xlink">
	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">NANO_NAME</literal> &#8212; Name of build
	      (used to construct the workdir names).</para>
	  </listitem>

	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">NANO_SRC</literal> &#8212; Path to the
	      source tree used to build the image.</para>
	  </listitem>

	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">NANO_KERNEL</literal> &#8212; Name of
	      kernel configuration file used to build kernel.</para>
	  </listitem>

	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">CONF_BUILD</literal> &#8212; Options passed
	      to the <buildtarget>buildworld</buildtarget> stage of
	      the build.</para>
	  </listitem>

	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">CONF_INSTALL</literal> &#8212; Options
	      passed to the <buildtarget>installworld</buildtarget>
	      stage of the build.</para>
	  </listitem>

	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">CONF_WORLD</literal> &#8212; Options passed
	      to both the <buildtarget>buildworld</buildtarget> and
	      the <buildtarget>installworld</buildtarget> stage of the
	      build.</para>
	  </listitem>

	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">FlashDevice</literal> &#8212; Defines what
	      type of media to use.  Check
	      <filename xmlns:xlink="http://www.w3.org/1999/xlink">FlashDevice.sub</filename> for more
	      details.</para>
	  </listitem>
	</itemizedlist>
      </sect3>

      <sect3 xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Custom Functions</title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">It is possible to fine-tune
	  <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> using shell functions in
	  the configuration file.  The following example illustrates
	  the basic model of custom functions:</para>

	<programlisting xmlns:xlink="http://www.w3.org/1999/xlink">cust_foo () (
	echo "bar=baz" &gt; \
		${NANO_WORLDDIR}/etc/foo
)
customize_cmd cust_foo</programlisting>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">A more useful example of a customization function is the
	  following, which changes the default size of the
	  <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc</filename> directory from 5MB to 30MB:</para>

	<programlisting xmlns:xlink="http://www.w3.org/1999/xlink">cust_etc_size () (
	cd ${NANO_WORLDDIR}/conf
	echo 30000 &gt; default/etc/md_size
)
customize_cmd cust_etc_size</programlisting>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">There are a few default pre-defined customization
	  functions ready for use:</para>

	<itemizedlist xmlns:xlink="http://www.w3.org/1999/xlink">
	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">cust_comconsole</literal> &#8212; Disables
	      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">getty</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> on the VGA devices (the
	      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/dev/ttyv*</filename> device nodes) and
	      enables the use of the COM1 serial port as the system
	      console.</para>
	  </listitem>

	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">cust_allow_ssh_root</literal> &#8212; Allow
	      <systemitem xmlns:xlink="http://www.w3.org/1999/xlink" class="username">root</systemitem> to login
	      via <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sshd</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>.</para>
	  </listitem>

	  <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink"><literal xmlns:xlink="http://www.w3.org/1999/xlink">cust_install_files</literal> &#8212;
	      Installs files from the
	      <filename xmlns:xlink="http://www.w3.org/1999/xlink">nanobsd/Files</filename>
	      directory, which contains some useful scripts for system
	      administration.</para>
	  </listitem>
	</itemizedlist>
      </sect3>

      <sect3 xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Adding Packages</title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Packages can be added to a
	  <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> image using a custom
	  function.  The following function will install all the
	  packages located in
	  <filename xmlns:xlink="http://www.w3.org/1999/xlink">/usr/src/tools/tools/nanobsd/packages</filename>:</para>

	<programlisting xmlns:xlink="http://www.w3.org/1999/xlink">install_packages () (
mkdir -p ${NANO_WORLDDIR}/packages
cp /usr/src/tools/tools/nanobsd/packages/* ${NANO_WORLDDIR}/packages
chroot ${NANO_WORLDDIR} sh -c 'cd packages; pkg_add -v *;cd ..;'
rm -rf ${NANO_WORLDDIR}/packages
)
customize_cmd install_packages</programlisting>
      </sect3>

      <sect3 xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Configuration File Example</title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">A complete example of a configuration file for building
	  a custom <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> image can
	  be:</para>

	<programlisting xmlns:xlink="http://www.w3.org/1999/xlink">NANO_NAME=custom
NANO_SRC=/usr/src
NANO_KERNEL=MYKERNEL
NANO_IMAGES=2

CONF_BUILD='
WITHOUT_KLDLOAD=YES
WITHOUT_NETGRAPH=YES
WITHOUT_PAM=YES
'

CONF_INSTALL='
WITHOUT_ACPI=YES
WITHOUT_BLUETOOTH=YES
WITHOUT_FORTRAN=YES
WITHOUT_HTML=YES
WITHOUT_LPR=YES
WITHOUT_MAN=YES
WITHOUT_SENDMAIL=YES
WITHOUT_SHAREDOCS=YES
WITHOUT_EXAMPLES=YES
WITHOUT_INSTALLLIB=YES
WITHOUT_CALENDAR=YES
WITHOUT_MISC=YES
WITHOUT_SHARE=YES
'

CONF_WORLD='
WITHOUT_BIND=YES
WITHOUT_MODULES=YES
WITHOUT_KERBEROS=YES
WITHOUT_GAMES=YES
WITHOUT_RESCUE=YES
WITHOUT_LOCALES=YES
WITHOUT_SYSCONS=YES
WITHOUT_INFO=YES
'

FlashDevice SanDisk 1G

cust_nobeastie() (
	touch ${NANO_WORLDDIR}/boot/loader.conf
	echo "beastie_disable=\"YES\"" &gt;&gt; ${NANO_WORLDDIR}/boot/loader.conf
)

customize_cmd cust_comconsole
customize_cmd cust_install_files
customize_cmd cust_allow_ssh_root
customize_cmd cust_nobeastie</programlisting>
      </sect3>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Updating NanoBSD</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">The update process of <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application>
	is relatively simple:</para>

      <procedure xmlns:xlink="http://www.w3.org/1999/xlink">
	<step xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Build a new <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> image,
	    as usual.</para>
	</step>

	<step xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Upload the new image into an unused partition of a
	    running <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application>
	    appliance.</para>

	  <para xmlns:xlink="http://www.w3.org/1999/xlink">The most important difference of this step from the
	    initial <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> installation is
	    that now instead of using <filename xmlns:xlink="http://www.w3.org/1999/xlink">_.disk.full</filename>
	    (which contains an image of the entire disk), the
	    <filename xmlns:xlink="http://www.w3.org/1999/xlink">_.disk.image</filename> image is installed
	    (which contains an image of a single system
	    partition).</para>
	</step>

	<step xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">Reboot, and start the system from the newly installed
	    partition.</para>
	</step>

	<step xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">If all goes well, the upgrade is finished.</para>
	</step>

	<step xmlns:xlink="http://www.w3.org/1999/xlink">
	  <para xmlns:xlink="http://www.w3.org/1999/xlink">If anything goes wrong, reboot back into the previous
	    partition (which contains the old, working image), to
	    restore system functionality as fast as possible.  Fix any
	    problems of the new build, and repeat the process.</para>
	</step>
      </procedure>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">To install new image onto the running
	<application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> system, it is possible to
	use either the <filename xmlns:xlink="http://www.w3.org/1999/xlink">updatep1</filename> or
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">updatep2</filename> script located in the
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/root</filename> directory, depending from which
	partition is running the current system.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">According to which services are available on host serving
	new <application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> image and what type of
	transfer is preferred, it is possible to examine one of these
	three ways:</para>

      <sect3 xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Using <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">ftp</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry></title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">If the transfer speed is in first place, use this
	  example:</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">ftp myhost
get _.disk.image "| sh updatep1"</userinput></screen>
      </sect3>

      <sect3 xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Using <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">ssh</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry></title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">If a secure transfer is preferred, consider using this
	  example:</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">ssh myhost cat _.disk.image.gz | zcat | sh updatep1</userinput></screen>
      </sect3>

      <sect3 xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Using <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">nc</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry></title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Try this example if the remote host is not running
	  neither <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">ftpd</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> or <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">sshd</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry> service:</para>

	<procedure xmlns:xlink="http://www.w3.org/1999/xlink">
	  <step xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink">At first, open a TCP listener on host serving the
	      image and make it send the image to client:</para>

	    <screen xmlns:xlink="http://www.w3.org/1999/xlink">myhost<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">nc -l <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">2222</replaceable> &lt; _.disk.image</userinput></screen>

	    <note xmlns:xlink="http://www.w3.org/1999/xlink">
	      <para xmlns:xlink="http://www.w3.org/1999/xlink">Make sure that the used port is not blocked to
		receive incoming connections from
		<application xmlns:xlink="http://www.w3.org/1999/xlink">NanoBSD</application> host by
		firewall.</para>
	    </note>
	  </step>

	  <step xmlns:xlink="http://www.w3.org/1999/xlink">
	    <para xmlns:xlink="http://www.w3.org/1999/xlink">Connect to the host serving new image and execute
	      <filename xmlns:xlink="http://www.w3.org/1999/xlink">updatep1</filename> script:</para>

	    <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">nc myhost <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">2222</replaceable> | sh updatep1</userinput></screen>
	  </step>
	</procedure>
      </sect3>
    </sect2>
  </sect1>

  <index xmlns:xlink="http://www.w3.org/1999/xlink"/>
</article>
