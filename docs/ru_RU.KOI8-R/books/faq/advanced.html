<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>Глава 18. Сложные темы</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Часто задаваемые вопросы по FreeBSD 8.X, 9.X и 10.X" /><link rel="up" href="index.html" title="Часто задаваемые вопросы по FreeBSD 8.X, 9.X и 10.X" /><link rel="prev" href="funnies.html" title="Глава 17. Юмор от FreeBSD" /><link rel="next" href="acknowledgments.html" title="Глава 19. Наши благодарности" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Глава 18. Сложные темы</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="funnies.html">Пред.</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="acknowledgments.html">След.</a></td></tr></table><hr /></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="advanced"></a>Глава 18. Сложные темы</h1></div></div></div><div class="qandaset"><a id="idp77714384"></a><dl><dt>18.1. <a href="advanced.html#idp77714640">Как можно узнать больше о внутреннем устройстве FreeBSD?</a></dt><dt>18.2. <a href="advanced.html#idp77718224">Как можно оказать помощь проекту FreeBSD?</a></dt><dt>18.3. <a href="advanced.html#idp77720784">Что такое снапшоты и релизы?</a></dt><dt>18.4. <a href="advanced.html#idp77750480">Можно ли работать с -CURRENT при
	    ограниченном доступе в Internet?</a></dt><dt>18.5. <a href="advanced.html#idp77753808">Я написал некоторое добавление к ядру, кому его послать?</a></dt><dt>18.6. <a href="advanced.html#idp77761104">Что делать при аварийном останове системы?</a></dt><dt>18.7. <a href="advanced.html#idp77873104">Перестала работать функция dlsym()
	    для исполняемых файлов ELF!</a></dt><dt>18.8. <a href="advanced.html#idp77882448">Как я могу увеличить или уменьшить адресное пространство
	    ядра в архитектуре i386?</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%" /><col /></colgroup><tbody><tr class="question"><td align="left" valign="top"><a id="idp77714640"></a><a id="learn-advanced"></a><p><strong>18.1.</strong></p></td><td align="left" valign="top"><p>Как можно узнать больше о внутреннем устройстве FreeBSD?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Список относящихся к делу книг можно найти в разделе
	    Руководства <a class="link" href="../../../../doc/ru_RU.KOI8-R/books/handbook/bibliography-osinternals.html" target="_top">
	    Библиография по внутреннему устройству операционной
	    системы</a>.</p><p>Кроме того, большинство общих знаний о <span class="trademark">UNIX</span>(R) непосредственно
	    применимо к FreeBSD.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp77718224"></a><a id="how-to-contribute"></a><p><strong>18.2.</strong></p></td><td align="left" valign="top"><p>Как можно оказать помощь проекту FreeBSD?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Пожалуйста, обратитесь к соответствующей <a class="link" href="../../../../doc/ru_RU.KOI8-R/articles/contributing/article.html" target="_top">статье</a>,
	    в которой вы получите советы относительно того, как это сделать.
	    Ваша помощь более чем приветствуется!</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp77720784"></a><a id="define-snap-release"></a><p><strong>18.3.</strong></p></td><td align="left" valign="top"><p>Что такое снапшоты и релизы?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>В <a class="link" href="http://svnweb.FreeBSD.org/base/" target="_top">Хранилище
	      Subversion</a> сейчас находятся 4
	    активно/полуактивно развивающихся ветки FreeBSD.  (Более
	    ранние ветки изменяются очень редко, именно поэтому в
	    разработке только 4 активные ветки):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="symbol">stable/8/</span>, также известная как
		<span class="emphasis"><em>8-STABLE</em></span></p></li><li class="listitem"><p><span class="symbol">stable/9/</span>, также известная как
		<span class="emphasis"><em>9-STABLE</em></span></p></li><li class="listitem"><p><span class="symbol">stable/10/</span>, также известная как
		<span class="emphasis"><em>10-STABLE</em></span></p></li><li class="listitem"><p><span class="symbol">head/</span>, также известная как
		<span class="emphasis"><em>-CURRENT</em></span> и <span class="emphasis"><em>11-CURRENT</em></span></p></li></ul></div><p><code class="literal">HEAD</code> - это не настоящий тэг ветки.
	    Это символьная константа для обозначения текущего,
	    не ветвящегося, находящегося в разработке дерева, то есть
	    <span class="emphasis"><em>-CURRENT</em></span>.</p><p>На данный момент <span class="emphasis"><em>-CURRENT</em></span> является
	    находящимся в разработке деревом 11.<em class="replaceable"><code>X</code></em>;
	    ветка <span class="emphasis"><em>10-STABLE</em></span>, <span class="symbol">stable/10/</span>,
	    отделилась от <span class="emphasis"><em>-CURRENT</em></span> в январе 2014 года
	    года, а ветка <span class="emphasis"><em>9-STABLE</em></span>,
	    <span class="symbol">stable/9/</span>, отделилась от
	    <span class="emphasis"><em>-CURRENT</em></span> в сентябре 2011 года.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp77750480"></a><a id="ctm"></a><p><strong>18.4.</strong></p></td><td align="left" valign="top"><p>Можно ли работать с <span class="emphasis"><em>-CURRENT</em></span> при
	    ограниченном доступе в Internet?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Да, это можно делать <span class="emphasis"><em>без</em></span> скачивания
	    полного дерева исходных текстов с помощью <a class="link" href="../../../../doc/ru_RU.KOI8-R/books/handbook/synching.html#ctx" target="_top">системы
	    CTM</a>.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp77753808"></a><a id="submitting-kernel-extensions"></a><p><strong>18.5.</strong></p></td><td align="left" valign="top"><p>Я написал некоторое добавление к ядру, кому его послать?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Обратитесь к статье о том, как <a class="link" href="../../../../doc/ru_RU.KOI8-R/articles/contributing/article.html" target="_top">помочь проекту
	    FreeBSD</a>, чтобы выяснить, как это сделать.</p><p>И спасибо Вам за Ваши усилия!</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp77761104"></a><a id="kernel-panic-troubleshooting"></a><p><strong>18.6.</strong></p></td><td align="left" valign="top"><p>Что делать при аварийном останове системы?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Вот типичная паника ядра:</p><pre class="programlisting">Fatal trap 12: page fault while in kernel mode
fault virtual address   = 0x40
fault code              = supervisor read, page not present
instruction pointer     = 0x8:0xf014a7e5
stack pointer           = 0x10:0xf4ed6f24
frame pointer           = 0x10:0xf4ed6f28
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, def32 1, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 80 (mount)
interrupt mask          =
trap number             = 12
panic: page fault</pre><p>Этого сообщения не достаточно.  Здесь важно значение
	    указателя инструкций, но оно зависит от конфигурации,
	    поскольку значение меняется для каждого конкретного файла
	    ядра.  Если это ядро <code class="filename">GENERIC</code> из
	    одного из снэпшотов, то кто-то ещё может отследить
	    функцию, вызвавшую ошибку, но в случае со специально
	    сконфигурированным ядром только вы можете сказать нам,
	    где случилась ошибка.</p><p>Чтобы продолжить:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Запишите значение указателя инструкций.  Заметьте,
		что часть <code class="literal">0x8:</code> в этом случае не
		важна: нам нужна часть <code class="literal">0xf0xxxxxx</code>.</p></li><li class="step"><p>Когда система перезагрузится, сделайте следующее:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nm -n kernel.that.caused.the.panic | grep f0xxxxxx</code></strong></pre><p>где <code class="literal">f0xxxxxx</code> - это значение
		указателя инструкций.  Однако неприятность заключается в
		том, что вы не получите точного соответствия, так как в
		таблице имен ядра для точек входа в функции даны адреса
		на начало функций, а указатель инструкций будет указывать
		куда-то внутрь её тела.  Если вы не получили точного
		соответствия, опустите последнюю цифру в значении
		указателя инструкций и попробуйте снова:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nm -n kernel.that.caused.the.panic | grep f0xxxxx</code></strong></pre><p>Если и это не привело ни к каким результатам, отрежьте
		следующую цифру.  Повторяйте, пока не получите хоть что-то.
		Результатом будет список функций, которые, возможно,
		привели к аварийному останову.  Этот механизм обнаружения
		ошибочного места довольно неточен, но это всё же лучше,
		чем ничего.</p></li></ol></div><p>Тем не менее, лучшим способом выяснить причину, вызвавшую
	    аварийный останов, является получение аварийного дампа системы,
	    а затем использование <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> для получения трассировки
	    вызовов в этом дампе.</p><p>В любом случае, метод таков:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Убедитесь в том, что в файле конфигурации ядра имеется
		следующая строка:</p><pre class="programlisting">makeoptions     DEBUG=-g          # Build kernel with gdb(1) debug symbols</pre></li><li class="step"><p>Перейдите в каталог <code class="filename">/usr/src</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong></pre></li><li class="step"><p>Скомпилируйте ядро:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make buildkernel KERNCONF=<em class="replaceable"><code>MYKERNEL</code></em></code></strong></pre></li><li class="step"><p>Дождитесь завершения компиляции.</p></li><li class="step"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make installkernel KERNCONF=MYKERNEL</code></strong></pre></li><li class="step"><p>Выполните перезагрузку.</p></li></ol></div><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если не указать <code class="varname">KERNCONF</code>, то
	      будет собрано и
	      установлено ядро <code class="filename">GENERIC</code>.</p></div><p>В процессе выполнения команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> будут
	    построены два ядра,
	    <code class="filename">/usr/obj/usr/src/sys/MYKERNEL/kernel</code>
	    и
	    <code class="filename">/usr/obj/usr/src/sys/MYKERNEL/kernel.debug</code>.
	    <code class="filename">kernel</code> будет установлен как
	    <code class="filename">/boot/kernel/kernel</code>, тогда как
	    <code class="filename">kernel.debug</code> может быть использован в
	    качестве источника отладочных символов для <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a>.</p><p>Чтобы получать аварийный дамп, отредактируйте файл
	    <code class="filename">/etc/rc.conf</code> так,
	    чтобы устройство <code class="literal">dumpdev</code> указывало на
	    раздел подкачки или имело значение <code class="literal">AUTO</code>.
	    В этом случае скрипты <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a> будут вызывать команду
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a> для создания аварийных дампов.  Эту команду
	    можно также запускать вручную.  После
	    аварийной остановки аварийный дамп может быть получен с
	    помощью программы <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> если значение переменной
	    <code class="literal">dumpdev</code> было установлено в
	    <code class="filename">/etc/rc.conf</code>, скрипты <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a> запустят
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> автоматически и поместят аварийный дамп в
	    каталог <code class="filename">/var/crash</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Аварийные дампы FreeBSD обычно имеют размер, равный
	      объёму оперативной памяти.  Поэтому убедитесь в наличии
	      достаточного места для хранения дампа в каталоге
	      <code class="filename">/var/crash</code>.  Либо запустите вручную
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a>, чтобы создать аварийный дамп в другом
	      каталоге, где достаточно места.  Размер аварийного дампа
	      можно уменьшить, указав в конфигурации ядра
	      <code class="literal">options MAXMEM=N</code>, где
	      <em class="replaceable"><code>N</code></em> - значение в Кбайт
	      для объёма памяти, которое будет использоваться ядром.
	      Например, для 1 Гбайт ОЗУ установите ограничение на
	      использование памяти ядром в 128 Мбайт, так чтобы
	      размер аварийного дампа был равен 128 Мбайт, а не
	      1 Гбайт.</p></div><p>Как только аварийный дамп получен, трассировку вызовов
	    можно получить таким образом:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>kgdb /usr/obj/usr/src/sys/MYKERNEL/kernel.debug /var/crash/vmcore.0</code></strong>
<code class="prompt">(kgdb)</code> <strong class="userinput"><code>backtrace</code></strong></pre><p>Заметьте, что это может дать несколько экранов
	    полезной информации.  Лучше всего использовать
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=script&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">script</span>(1)</span></a> для перехвата всего вывода.  При
	    использовании необработанного файла ядра со всей
	    отладочной информацией может быть найдена конкретная
	    строка исходного текста ядра, при достижении которой
	    случилась аварийная остановка.  Для выяснения
	    последовательности событий, приведших к аварийному
	    останову, трассировка стека обычно читается снизу вверх.
	    Также можно использовать <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> для вывода значений
	    различных переменных или структур, чтобы выяснить
	    состояние системы во время аварии.</p><div xmlns="" class="tip"><h3 class="admontitle">Подсказка: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если есть второй компьютер, то можно настроить
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> для удалённой отладки, включая точки
	      останова и пошаговый проход по коду ядра.</p></div><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если включена поддержка <code class="literal">DDB</code> и
	      ядро переходит в режим отладки, можно намеренно вызвать
	      аварийный останов и создание аварийного дампа, набрав
	      <code class="literal">panic</code> в приглашении командной строки
	      <code class="literal">ddb</code>.  Выполнение фазы аварийного
	      останова может снова остановиться с вызовом отладчика.
	      В этом случае наберите <code class="literal">continue</code>, и
	      процесс будет завершён созданием аварийного дампа.</p></div></td></tr><tr class="question"><td align="left" valign="top"><a id="idp77873104"></a><a id="dlsym-failure"></a><p><strong>18.7.</strong></p></td><td align="left" valign="top"><p>Перестала работать функция <code class="function">dlsym()</code>
	    для исполняемых файлов ELF!</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>По умолчанию при работе с форматом ELF символы,
	    определённые в исполняемом файле, не доступны динамическому
	    загрузчику.  Поэтому при вызове функции
	    <code class="function">dlsym()</code>, которая осуществляет поиск по
	    дескриптору, полученному после вызова <code class="function">dlopen(NULL,
	    flags)</code>, желаемый результат достигнут не будет.</p><p>Чтобы осуществить поиск символов в исполняемом файле
	    процесса с помощью функции <code class="function">dlsym()</code>,
	    выполните компоновку исполняемого файла с параметром
	    <code class="option">--export-dynamic</code> компоновщика ELF
	    (<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ld&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ld</span>(1)</span></a>).</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp77882448"></a><a id="change-kernel-address-space"></a><p><strong>18.8.</strong></p></td><td align="left" valign="top"><p>Как я могу увеличить или уменьшить адресное пространство
	    ядра в архитектуре i386?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>По умолчанию размер адресного пространства ядра для
	    i386 равен 1 Гбайт (2 Гбайт для PAE).  Для
	    работы сервера с интенсивной сетевой нагрузкой или при
	    использовании ZFS этого может быть недостаточно.</p><p>Чтобы увеличить доступное пространство, добавьте
	    следующую строку в файл конфигурации ядра и пересоберите
	    ядро:</p><pre class="programlisting">options KVA_PAGES=<em class="replaceable"><code>N</code></em></pre><p>Чтобы получить нужное значение для
	    <em class="replaceable"><code>N</code></em>, разделите желаемый размер
	    адресного пространства (в мегабайтах) на четыре (для
	    2 Гбайт это будет <code class="literal">512</code>).</p></td></tr></tbody></table></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="funnies.html">Пред.</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="acknowledgments.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Глава 17. Юмор от FreeBSD </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> Глава 19. Наши благодарности</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>