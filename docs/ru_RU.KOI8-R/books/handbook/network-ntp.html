<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>25.10. Синхронизация часов через NTP</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="network-servers.html" title="Глава 25. Сетевые серверы" /><link rel="prev" href="network-ftp.html" title="25.9. Протокол передачи файлов (FTP)" /><link rel="next" href="network-syslogd.html" title="25.11. * Remote Host Logging with syslogd" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">25.10. Синхронизация часов через NTP</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="network-ftp.html">Пред.</a> </td><th width="60%" align="center">Глава 25. Сетевые серверы</th><td width="20%" align="right"> <a accesskey="n" href="network-syslogd.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="network-ntp"></a>25.10. Синхронизация часов через NTP</h2></div><div><span class="authorgroup">Текст предоставил <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Tom</span> <span class="surname">Hukins</span></span>. </span></div></div></div><a id="idp98675408" class="indexterm"></a><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98675920"></a>25.10.1. Обзор</h3></div></div></div><p>С течением времени часы компьютера имеют тенденцию отставать.
	Network Time
	Protocol - Сетевой Протокол Времени (<acronym class="acronym">NTP</acronym>) является одним из способов
	вести точное время.</p><p>Многие сервисы Интернет опираются или сильно зависят от точности
	часов компьютеров.  К примеру, веб-сервер может получать запрос на
	посылку файла, который был недавно модифицирован.  В локальной сети
	необходимо, чтобы часы компьютеров, совместно использующих файлы,
	были синхронизированы, чтобы время модификации файлов устанавливалось
	правильно. Такие службы, как
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cron&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">cron</span>(8)</span></a>, также зависят от правильности установки системных
	часов, поскольку запускают команды в определенное время.</p><a id="idp98678608" class="indexterm"></a><p>FreeBSD поставляется с сервером <acronym class="acronym">NTP</acronym> <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a>, который можно
	использовать для опроса других серверов NTP для установки часов на
	вашей машине или предоставления услуг точного времени.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98685776"></a>25.10.2. Выбор подходящих серверов NTP</h3></div></div></div><a id="idp98686416" class="indexterm"></a><p>Для синхронизации ваших часов вам нужно найти для использования
	один или большее количество серверов NTP.  Ваш сетевой администратор
	или провайдер могут иметь сервер NTP для этой цели-обратитесь к
	ним, так ли это в вашем случае.  Существует <a class="link" href="http://support.ntp.org/bin/view/Servers/WebHome" target="_top">онлайн список
	общедоступных серверов NTP</a>, которым можно воспользоваться для
	поиска ближайшего к вам сервера NTP.  Не забудьте выяснить политику
	выбранного вами сервера и спросить разрешения, если это
	требуется.</p><p>Выбор нескольких несвязанных серверов NTP является хорошей идеей в
	том случае, если один из используемых вами серверов станет недоступным
	или его часы неточны.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a> использует ответы, которые он
	получает от других серверов с умом-он делает предпочтение
	надежным серверам.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98689744"></a>25.10.3. Настройка вашей машины</h3></div></div></div><a id="idp98690384" class="indexterm"></a><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98691536"></a>25.10.3.1. Базовая конфигурация</h4></div></div></div><a id="idp98692176" class="indexterm"></a><p>Если вам нужно только синхронизировать ваши часы при загрузке
	  машины, вы можете воспользоваться утилитой <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpdate&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpdate</span>(8)</span></a>.  Это
	  может подойти для некоторых настольных машин, которые часто
	  перезагружаются и только требуют изредка синхронизироваться, но
	  на большинстве машин должен работать <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a>.</p><p>Использование <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpdate&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpdate</span>(8)</span></a> при загрузке также хорошо для
	  машин, на которых запущен даемон <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a>.  Программа
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a> изменяет время постепенно, тогда как <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpdate&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpdate</span>(8)</span></a>
	  устанавливает время вне
	  зависимости от того, насколько велика разница между текущим временем
	  машины и точным временем.</p><p>Для включения <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpdate&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpdate</span>(8)</span></a> во время загрузки, добавьте строчку
	  <code class="literal">ntpdate_enable="YES"</code> в файл
	  <code class="filename">/etc/rc.conf</code>.  Вам также потребуется указать
	  все серверы, с которыми вы хотите синхронизироваться, и все
	  параметры, которые передаются в <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpdate&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpdate</span>(8)</span></a>, в
	  <code class="varname">ntpdate_flags</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98705488"></a>25.10.3.2. Общие настройки</h4></div></div></div><a id="idp98706256" class="indexterm"></a><p>NTP настраивается в файле <code class="filename">/etc/ntp.conf</code>,
	  формат которого описан в <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntp.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">ntp.conf</span>(5)</span></a>.  Вот простой
	  пример:</p><pre class="programlisting">server ntplocal.example.com prefer
server timeserver.example.org
server ntp2a.example.net

driftfile /var/db/ntp.drift</pre><p>Параметр <code class="literal">server</code> задает, какие серверы будут
	  использоваться, по одному в каждой строке.  Если сервер задан с
	  аргументом <code class="literal">prefer</code>, как <code class="systemitem">ntplocal.example.com</code>, то этому серверу отдается
	  предпочтение перед остальными.  Ответ от предпочтительного сервера
	  будет отброшен, если он значительно отличается от ответов других
	  серверов, в противном случае он будет использоваться безотносительно
	  к другим ответам.  Аргумент <code class="literal">prefer</code> обычно
	  используется для серверов NTP, о которых известно, что они очень
	  точны, такими, на которых используется специальное оборудование
	  точного времени.</p><p>Параметр <code class="literal">driftfile</code> задает файл, который
	  используется для хранения смещения частоты системных часов.
	  Программа <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a> использует его для автоматической компенсации
	  естественного смещения часов, позволяя ему поддерживать достаточно
	  правильную настройку, даже если он на некоторый период отключается от
	  внешнего источника информации о времени.</p><p>Параметр <code class="literal">driftfile</code> задает, какой файл
	  используется для сохранения информации о предыдущих ответах от
	  серверов NTP, которые вы используете.  Этот файл содержит внутреннюю
	  информацию для NTP.  Он не должен изменяться никакими другими
	  процессами.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98713936"></a>25.10.3.3. Управление доступом к вашему серверу</h4></div></div></div><p>По умолчанию ваш сервер NTP будет доступен всем хостам в
	  Интернет.  Параметр <code class="literal">restrict</code> в файле
	  <code class="filename">/etc/ntp.conf</code> позволяет вам контролировать,
	  какие машины могут обращаться к вашему серверу.</p><p>Если вы хотите запретить всем машинам обращаться к вашему серверу
	  NTP, добавьте следующую строку в
	  файл <code class="filename">/etc/ntp.conf</code>:</p><pre class="programlisting">restrict default ignore</pre><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Эта строка конфигурации также предотвратит доступ вашего
	    сервера
	    к другим серверам, перечисленным в вашей локальной конфигурации.
	    Если вам необходимо синхронизировать ваш сервер с внешним
	    сервером NTP, вам необходимо будет изменить настройки
	    относительно этого конкретного сервера.  За более детальной
	    информацией обратитесь к странице руководства
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntp.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">ntp.conf</span>(5)</span></a>.</p></div><p>Если вы хотите разрешить синхронизировать свои часы с вашим
	  сервером только машинам в вашей сети, но запретить им настраивать
	  сервер или быть равноправными участниками синхронизации времени, то
	  вместо указанной добавьте строчку</p><pre class="programlisting">restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</pre><p>где <code class="systemitem">192.168.1.0</code> является адресом
	  IP вашей сети, а <code class="systemitem">255.255.255.0</code> её
	  сетевой маской.</p><p><code class="filename">/etc/ntp.conf</code> может содержать несколько
	  директив <code class="literal">restrict</code>.  Для получения подробной
	  информации обратитесь к подразделу <code class="literal">Access Control
	  Support</code> (Поддержка Управления Доступом) в
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntp.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">ntp.conf</span>(5)</span></a>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98731600"></a>25.10.4. Запуск сервера NTP</h3></div></div></div><p>Для того, чтобы сервер NTP запускался при загрузке, добавьте строку
	<code class="literal">ntpd_enable="YES"</code> в файл
	<code class="filename">/etc/rc.conf</code>.  Если вы хотите передать
	дополнительные опции в <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a>, то отредактируйте параметр
	<code class="varname">ntpd_flags</code> в файле
	<code class="filename">/etc/rc.conf</code>.</p><p>Для запуска сервера без перезагрузки вашей машины, выполните
	команду <code class="command">ntpd</code>, не забыв задать дополнительные
	параметры из переменной <code class="varname">ntpd_flags</code> в файле
	<code class="filename">/etc/rc.conf</code>.  К примеру:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ntpd -p /var/run/ntpd.pid</code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98737616"></a>25.10.5. Использование ntpd с временным подключением к
	Интернет</h3></div></div></div><p>Для нормальной работы программе <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a> не требуется
	постоянное подключение к Интернет.  Однако если ваше временное
	подключение к Интернет настроено для дозвона по требованию, хорошо бы
	запретить трафику NTP вызывать дозвон или поддерживать соединение
	постоянно.  Если вы используете пользовательский PPP, то можете
	воспользоваться директивами <code class="literal">filter</code> в файле
	<code class="filename">/etc/ppp/ppp.conf</code>.  К примеру:</p><pre class="programlisting"> set filter dial 0 deny udp src eq 123
 # Prevent NTP traffic from initiating dial out
 set filter dial 1 permit 0 0
 set filter alive 0 deny udp src eq 123
 # Prevent incoming NTP traffic from keeping the connection open
 set filter alive 1 deny udp dst eq 123
 # Prevent outgoing NTP traffic from keeping the connection open
 set filter alive 2 permit 0/0 0/0</pre><p>Более подробную информацию можно найти в разделе <code class="literal">PACKET
	FILTERING</code> (ФИЛЬТРАЦИЯ ПАКЕТОВ) в <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ppp</span>(8)</span></a>, а примеры в
	<code class="filename">/usr/share/examples/ppp/</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Некоторые провайдеры Интернет блокируют трафик по портам с
	  маленькими номерами, что приводит к неработоспособности NTP, так как
	  ответы никогда не достигают вашей машины.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp98747600"></a>25.10.6. Дополнительная литература</h3></div></div></div><p>Документация по серверу NTP может быть найдена в каталоге
	<code class="filename">/usr/share/doc/ntp/</code> в формате HTML.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="network-ftp.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="network-servers.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="network-syslogd.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">25.9. Протокол передачи файлов (FTP) </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 25.11. * Remote Host Logging with <code class="command">syslogd</code></td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>