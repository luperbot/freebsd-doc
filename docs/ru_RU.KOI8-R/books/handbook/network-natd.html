<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>27.8. Даемон преобразования сетевых адресов (natd)</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="advanced-networking.html" title="Глава 27. Сложные вопросы работы в сети" /><link rel="prev" href="network-isdn.html" title="27.7. ISDN" /><link rel="next" href="network-plip.html" title="27.9. IP по параллельному порту (PLIP)" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">27.8. Даемон преобразования сетевых адресов (natd)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="network-isdn.html">Пред.</a> </td><th width="60%" align="center">Глава 27. Сложные вопросы работы в сети</th><td width="20%" align="right"> <a accesskey="n" href="network-plip.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="network-natd"></a>27.8. Даемон преобразования сетевых адресов (natd)</h2></div><div><span class="authorgroup">Текст предоставил <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Chern</span> <span class="surname">Lee</span></span>. </span></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="network-natoverview"></a>27.8.1. Обзор</h3></div></div></div><a id="idp100573520" class="indexterm"></a><p>Даемон преобразования сетевых адресов (Network Address
	Translation) во FreeBSD, широко известный как <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a>, является
	даемоном, который принимает входящие IP-пакеты, изменяет адрес
	отправителя на адрес локальной машины и повторно отправляет эти пакеты
	в потоке исходящих пакетов.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a> делает это, меняя IP-адрес
	отправителя и порт таким образом, что когда данные принимаются
	обратно, он может определить расположение источника начальных данных
	и переслать их машине, которая запрашивала данные изначально.</p><a id="idp100576336" class="indexterm"></a><a id="idp100577104" class="indexterm"></a><p>Чаще всего NAT используется для организации так называемого
	Совместного Использования Интернет.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="network-natsetup"></a>27.8.2. Настройка</h3></div></div></div><p>Из-за исчерпания пространства адресов в IPv4 и увеличения
	количества пользователей высокоскоростных каналов связи, таких, как
	кабельное подключение или DSL, необходимость в решении по Совместному
	Использованию Интернет растёт.  Возможность подключить несколько
	компьютеров через единственное соединение и IP-адрес делает
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a> подходящим решением.</p><p>Чаще всего у пользователя имеется машина, подключенная к кабельному
	каналу или каналу DSL с одним IP-адресом и есть желание использовать
	этот единственный подключенный компьютер для организации доступа в
	Интернет другим компьютерам в локальной сети.</p><p>Для этого машина FreeBSD, находящаяся в Интернет, должна выступать
	в роли шлюза.  Эта шлюзовая машина должна иметь два сетевых
	адаптера-один для подключения к маршрутизатору Интернет, а
	другой для подключения к ЛВС.  Все машины в локальной сети
	подключаются через сетевой концентратор или коммутатор.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Существует много способов подсоединить локальную сеть к
	 Internet через шлюз FreeBSD.  Этот пример показывает шлюз c
	 двумя сетевыми картами.</p></div><div class="mediaobject"><img src="advanced-networking/natd.png" alt="Структура сети" /></div><p>Подобная конфигурация часто используется для совместного
	использования доступа в Интернет.  Одна из подключенных к локальной
	сети машин подключается к Интернет.  Остальные машины работают с
	Интернет посредством этой <span class="quote"><<<span class="quote">шлюзовой</span>>></span> машины.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="network-natdkernconfiguration"></a>27.8.3. Настройка</h3></div></div></div><a id="idp100590672" class="indexterm"></a><p>В файле конфигурации ядра должны присутствовать следующие
	параметры:</p><pre class="programlisting">options IPFIREWALL
options IPDIVERT</pre><p>Дополнительно, если это нужно, можно добавить следующее:</p><pre class="programlisting">options IPFIREWALL_DEFAULT_TO_ACCEPT
options IPFIREWALL_VERBOSE</pre><p>В файле <code class="filename">/etc/rc.conf</code> должны быть такие
	строки:</p><pre class="programlisting">gateway_enable="YES" <a id="co-natd-gateway-enable"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
firewall_enable="YES" <a id="co-natd-firewall-enable"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
firewall_type="OPEN" <a id="co-natd-firewall-type"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
natd_enable="YES"
natd_interface="<em class="replaceable"><code>fxp0</code></em>" <a id="co-natd-natd-interface"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>
natd_flags="" <a id="co-natd-natd-flags"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co-natd-gateway-enable"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Указывает машине выступать в качестве шлюза.  Выполнение
	    команды <code class="command">sysctl net.inet.ip.forwarding=1</code>
	    приведёт к тому же самому результату.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-natd-firewall-enable"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>При загрузке включает использование правил брандмауэра
	    из файла <code class="filename">/etc/rc.firewall</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-natd-firewall-type"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Здесь задается предопределенный набор правил брандмауэра,
	    который разрешает все.  Посмотрите файл
	    <code class="filename">/etc/rc.firewall</code> для нахождения
	    дополнительных типов.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-natd-natd-interface"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Указывает, через какой интерфейс передавать пакеты
	    (интерфейс, подключенный к Интернет).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-natd-natd-flags"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Любые дополнительный параметры, передаваемые при запуске
	    даемону <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a>.</p></td></tr></table></div><p>При использовании вышеуказанных параметров в файле
	<code class="filename">/etc/rc.conf</code> при загрузке будет запущена команда
	<code class="command">natd -interface fxp0</code>.  Эту команду можно запустить и
	вручную.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если для передачи <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a> набирается слишком много
	  параметров, возможно также использовать конфигурационный файл.  В
	  этом случае имя настроечного файла должно быть задано добавлением
	  следующей строки в <code class="filename">/etc/rc.conf</code>:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">natd_flags="-f /etc/natd.conf"</pre><p xmlns="http://www.w3.org/1999/xhtml">Файл <code class="filename">/etc/natd.conf</code> будет содержать перечень
	  конфигурационных параметров, по одному в строке.  К примеру, для
	  примера из следующего раздела будет использоваться такой файл:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">redirect_port tcp 192.168.0.2:6667 6667
redirect_port tcp 192.168.0.3:80 80</pre><p xmlns="http://www.w3.org/1999/xhtml">Для получения более полной информации о конфигурационном файле
	  прочтите страницу справки по <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a> относительно параметра
	  <code class="option">-f</code>.</p></div><p>Каждой машине и интерфейсу в ЛВС должен быть назначен IP-адрес из
	адресного пространства частных сетей, как это определено в <a class="link" href="ftp://ftp.isi.edu/in-notes/rfc1918.txt" target="_top">RFC 1918</a>, а в
	качестве маршрутизатора по умолчанию должен быть задан IP-адрес машины
	с <span class="application">natd</span> из внутренней сети.</p><p>Например, клиенты <code class="systemitem">A</code> и <code class="systemitem">B</code> в ЛВС
	имеют IP-адреса <code class="systemitem">192.168.0.2</code> и <code class="systemitem">192.168.0.3</code>, а интерфейс машины с natd в
	локальной сети имеет IP-адрес <code class="systemitem">192.168.0.1</code>.  Маршрутизатором по умолчанию для
	клиентов <code class="systemitem">A</code> и <code class="systemitem">B</code> должна быть назначена
	машина с <span class="application">natd</span>, то есть <code class="systemitem">192.168.0.1</code>.  Внешний, или Интернет-интерфейс
	машины с <span class="application">natd</span> не требует особых
	настроек для работы <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="network-natdport-redirection"></a>27.8.4. Перенаправление портов</h3></div></div></div><p>Минусом использования <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a> является то, что машины в
	локальной сети
	недоступны из Интернет.  Клиенты в ЛВС могут выполнять исходящие
	соединения во внешний мир, но не могут обслуживать входящие.  Это
	является проблемой при запуске служб Интернет на клиентских машинах в
	локальной сети.  Простым решением является перенаправление некоторых
	портов Интернет машины с <span class="application">natd</span> на клиента
	локальной сети.</p><p>Пусть, к примеру, сервер IRC запущен на клиенте <code class="systemitem">A</code>,
	а Web-сервер работает на клиенте <code class="systemitem">B</code>.  Чтобы это
	работало, соединения, принимаемые на портах 6667 (IRC) и 80 (Web),
	должны перенаправляться на соответствующие машины.</p><p>Программе <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a> должна быть передана команда
	<code class="option">-redirect_port</code> с соответствующими параметрами.
	Синтаксис следующий:</p><pre class="programlisting">     -redirect_port proto targetIP:targetPORT[-targetPORT]
                 [aliasIP:]aliasPORT[-aliasPORT]
                 [remoteIP[:remotePORT[-remotePORT]]]</pre><p>В примере выше аргументы должен быть такими:</p><pre class="programlisting">    -redirect_port tcp 192.168.0.2:6667 6667
    -redirect_port tcp 192.168.0.3:80 80</pre><p>При этом будут перенаправлены соответствующие порты
	<span class="emphasis"><em>tcp</em></span> на клиентские машины в локальной сети.</p><p>Аргумент <code class="option">-redirect_port</code> может использоваться для
	указания диапазонов портов, а не конкретного порта.  Например,
	<em class="replaceable"><code>tcp 192.168.0.2:2000-3000 2000-3000</code></em> будет
	перенаправлять все соединения, принимаемые на портах от 2000 до 3000,
	на порты от 2000 до 3000 клиента <code class="systemitem">A</code>.</p><p>Эти параметры можно указать при непосредственном запуске
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a>, поместить их в параметр
	<code class="literal">natd_flags=""</code> файла
	<code class="filename">/etc/rc.conf</code>, либо передать через
	конфигурационный файл.</p><p>Для получение информации о других параметрах настройки обратитесь
	к справочной странице по <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a></p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="network-natdaddress-redirection"></a>27.8.5. Перенаправление адреса</h3></div></div></div><a id="idp100646480" class="indexterm"></a><p>Перенаправление адреса полезно, если имеется несколько адресов IP,
	и они должны быть на одной машине.  В этой ситуации <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a> может
	назначить каждому клиенту ЛВС свой собственный внешний IP-адрес.  Затем
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=natd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">natd</span>(8)</span></a> преобразует исходящие от клиентов локальной сети пакеты,
	заменяя IP-адреса на соответствующие внешние, и перенаправляет весь
	трафик, входящий на некоторый IP-адрес, обратно конкретному клиенту
	локальной сети.  Это также называют статическим NAT.  К примеру, пусть
	IP-адреса <code class="systemitem">128.1.1.1</code>, <code class="systemitem">128.1.1.2</code> и <code class="systemitem">128.1.1.3</code> принадлежат шлюзовой машине
	<span class="application">natd</span>.  <code class="systemitem">128.1.1.1</code> может использоваться в качестве
	внешнего IP-адреса шлюзовой машины <span class="application">natd</span>,
	тогда как <code class="systemitem">128.1.1.2</code> и <code class="systemitem">128.1.1.3</code> будут перенаправляться обратно
	к клиентам ЛВС <code class="systemitem">A</code> и <code class="systemitem">B</code>.</p><p>Синтаксис для <code class="option">-redirect_address</code> таков:</p><pre class="programlisting">-redirect_address localIP publicIP</pre><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><tbody><tr><td>localIP</td><td>Внутренний IP-адрес клиента локальной сети.</td></tr><tr><td>publicIP</td><td>Внешний IP, соответствующий клиенту локальной сети.</td></tr></tbody></table></div><p>В примере этот аргумент будет выглядеть так:</p><pre class="programlisting">-redirect_address 192.168.0.2 128.1.1.2
-redirect_address 192.168.0.3 128.1.1.3</pre><p>Как и для <code class="option">-redirect_port</code>, эти аргументы также
	помещаются в строку <code class="literal">natd_flags=""</code> файла
	<code class="filename">/etc/rc.conf</code> или передаются через конфигурационный
	файл.  При перенаправлении адресов нет нужды в перенаправлении портов,
	потому что перенаправляются все данные, принимаемые для конкретного
	IP-адреса.</p><p>Внешние IP-адреса машины с <span class="application">natd</span> должны
	быть активизированы и являться синонимами для внешнего интерфейса.
	Обратитесь к <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>, чтобы это сделать.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="network-isdn.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="advanced-networking.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="network-plip.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">27.7. ISDN </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 27.9. IP по параллельному порту (PLIP)</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>