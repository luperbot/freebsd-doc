<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>17.14. Мгновенные копии файловых систем</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="disks.html" title="Глава 17. Устройства хранения" /><link rel="prev" href="disks-virtual.html" title="17.13. Сетевые файловые системы, файловые системы в памяти и с отображением в файл" /><link rel="next" href="quotas.html" title="17.15. Квотирование файловых систем" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">17.14. Мгновенные копии файловых систем</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="disks-virtual.html">Пред.</a> </td><th width="60%" align="center">Глава 17. Устройства хранения</th><td width="20%" align="right"> <a accesskey="n" href="quotas.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="snapshots"></a>17.14. Мгновенные копии файловых систем</h2></div><div><span class="authorgroup">Текст предоставил <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Tom</span> <span class="surname">Rhodes</span></span>. </span></div></div></div><a id="idp92055376" class="indexterm"></a><p>Во FreeBSD 5.0 вместе с технологией <a class="link" href="configtuning-disk.html#soft-updates" title="12.12.2. Soft Updates">
      Отложенных обновлений</a> представлена новая возможность: генерация
      мгновенных копий файловых систем.</p><p>Мгновенные копии позволяют пользователю создавать образы заданных
      файловых систем и работать с ними как с файлами.
      Файлы мгновенных копий должны создаваться в той файловой
      системе, над которой производится действие, и пользователь может
      создавать не более 20 мгновенных копий для каждой файловой системы.
      Активные копии записываются в суперблок, так что они остаются в силе
      между операциями монтирования и размонтирования в процессе системных
      перезагрузок.  Если мгновенная копия больше не нужна, она может быть
      удалена стандартной командой <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rm&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rm</span>(1)</span></a>.  Мгновенные копии могут
      удаляться в любом порядке, однако всё использованное пространство не
      может быть использовано, так как другая мгновенная копия может
      претендовать на некоторые блоки из освобождённых.</p><p>Неизменяемый флаг <code class="option">snapshot</code> устанавливается на файл
      при помощи <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mksnap_ffs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mksnap_ffs</span>(8)</span></a> после первоначального создания файла
      мгновенной копии.  Команда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=unlink&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">unlink</span>(1)</span></a> делает исключение для
      файлов мгновенных копий, позволяя их удалять.</p><p>Мгновенные копии создаются при помощи утилиты <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a>.  Чтобы
      создать мгновенную копию <code class="filename">/var</code> в файле
      <code class="filename">/var/snapshot/snap</code>, воспользуйтесь такой
      командой:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -u -o snapshot /var/snapshot/snap /var</code></strong></pre><p>В качестве альтернативного средства создания мгновенных копий
      вы можете использовать утилиту <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mksnap_ffs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mksnap_ffs</span>(8)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mksnap_ffs /var /var/snapshot/snap</code></strong></pre><p>Файлы мгновенных копий файловых систем (к примеру,
      <code class="filename">/var</code>) можно найти при помощи команды
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=find&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">find</span>(1)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>find /var -flags snapshot</code></strong></pre><p>После создания мгновенной копии есть несколько способов её
      использования:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Некоторые администраторы будут использовать файл мгновенной
	  копии для целей создания резервной копии, так как мгновенная копия
	  может быть перенесена на CD или магнитную ленту.</p></li><li class="listitem"><p>Утилита проверка целостности файловой системы, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a>,
	  может быть запущена над мгновенной копией.  Полагая, что
	  файловая система была в порядке, когда она была смонтирована, вы
	  всегда должны получать нормальный (и неизменный) результат.
	  Это именно то, что выполняет фоновый процесс <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a>.</p></li><li class="listitem"><p>Запустить утилиту <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> с мгновенной копией.  Будет
	  создаваться дамп, соответствующий файловой системе на момент
	  создания мгновенной копии.  Утилита <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> при использовании
	  опции <code class="option">-L</code> тоже может работать с мгновенными копиями,
	  создавать их дампы, а затем удалять за один проход.</p></li><li class="listitem"><p>Смонтировать командой <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> мгновенную копию как
	  замороженный образ файловой системы.  Чтобы смонтировать командой
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> мгновенную копию
	  <code class="filename">/var/snapshot/snap</code>, запустите:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mdconfig -a -t vnode -f /var/snapshot/snap -u 4</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -r /dev/md4 /mnt</code></strong></pre></li></ul></div><p>Теперь вы можете пройтись по иерархии вашей зафиксированной файловой
      системы <code class="filename">/var</code>, смонтированной в каталог
      <code class="filename">/mnt</code>.  Первоначально всё будет в том же самом
      состоянии, в каком это было во время создания мгновенной копии.
      Единственным исключением будет то, что любые ранее сделанные мгновенные
      копии будут видны как файлы нулевой длины.  Когда использование
      мгновенной копии закончено, она может быть удалена командой:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>umount /mnt</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mdconfig -d -u 4</code></strong></pre><p>Для получения более полной информации о <code class="option">softupdates</code>
      и мгновенных копиях файловых систем, включая технической описание, вы
      можете посетить сайт Маршалла Кёрка МакКузика (Marshall Kirk McKusick) по
      адресу <code class="uri"><a class="uri" href="http://www.mckusick.com/" target="_top">http://www.mckusick.com/</a></code>.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="disks-virtual.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="disks.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="quotas.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">17.13. Сетевые файловые системы, файловые системы в памяти и с отображением
      в файл </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 17.15. Квотирование файловых систем</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>