<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>17.4. RAID</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="disks.html" title="Глава 17. Устройства хранения" /><link rel="prev" href="disks-adding.html" title="17.3. Добавление дисков" /><link rel="next" href="usb-disks.html" title="17.5. USB устройства хранения" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">17.4. RAID</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="disks-adding.html">Пред.</a> </td><th width="60%" align="center">Глава 17. Устройства хранения</th><td width="20%" align="right"> <a accesskey="n" href="usb-disks.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="raid"></a>17.4. RAID</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="raid-soft"></a>17.4.1. Программный RAID</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd"></a>17.4.1.1. Конфигурация драйвера объединённого диска (CCD)</h4></div><div><span class="authorgroup">Оригинальный текст предоставил <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Christopher</span> <span class="surname">Shumway</span></span>. </span></div><div><span class="authorgroup">Изменения внёс <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jim</span> <span class="surname">Brown</span></span>. </span></div></div></div><a id="idp91011024" class="indexterm"></a><a id="idp91012048" class="indexterm"></a><p>При выборе решения для организации хранилища самыми важными
	  характеристиками являются скорость, надежность и стоимость.  Редко
	  все эти характеристики наличествуют одновременно; обычно
	  быстрое и надёжное устройство хранения стоит дорого, а при
	  уменьшении стоимости в жертву приносятся скорость работы или
	  надёжность.</p><p>При проектировании описываемой далее системы в качестве
	  самого важного фактора была выбрана её стоимость, затем
	  быстродействие и надёжность.  Скорость передачи данных для этой
	  системы ограничивалась только пропускной способностью сети.  И,
	  хотя надёжность очень важна, CCD-диск, описываемый ниже,
	  обслуживал работу с данными, полные копии которых уже хранились на
	  дисках CD-R, так они могли быть с лёгкостью обновлены.</p><p>При выборе решения для массового хранения данных первым шагом
	  является определение ваших требований к нему.  Если в ваших
	  требованиях главными являются скорость или надёжность, а не
	  стоимость, то ваш выбор будет отличаться от описываемой в этом
	  разделе системы.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd-installhw"></a>17.4.1.1.1. Установка оборудования</h5></div></div></div><p>Кроме системного IDE-диска, основу описываемого далее CCD-диска
	    общим объёмом примерно в 90 Гбайт составили три IDE-диска Western
	    Digital 30GB, 5400 RPM.  В идеальном случае каждый диск IDE имеет
	    собственный контроллер и кабель, но для минимизации стоимости
	    дополнительные контроллеры IDE не использовались.  Вместо этого
	    диски были настроены при помощи переключателей так, что на каждом
	    IDE-контроллере находилось по одному ведущему и одному ведомому
	    диску.</p><p>До перезагрузки BIOS системы была настроена на автоматическое
	    распознавание подключенных дисков.  Более важно то, что при
	    перезагрузке их распознала FreeBSD:</p><pre class="programlisting">ad0: 19574MB &lt;WDC WD205BA&gt; [39770/16/63] at ata0-master UDMA33
ad1: 29333MB &lt;WDC WD307AA&gt; [59598/16/63] at ata0-slave UDMA33
ad2: 29333MB &lt;WDC WD307AA&gt; [59598/16/63] at ata1-master UDMA33
ad3: 29333MB &lt;WDC WD307AA&gt; [59598/16/63] at ata1-slave UDMA33</pre><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если FreeBSD не распознала все диски, проверьте корректность
	      положения переключателей на них.  На большинстве IDE-дисков
	      имеется также переключатель <span class="quote"><<<span class="quote">Cable Select</span>>></span>.  Он
	      <span class="emphasis"><em>не имеет</em></span> отношения к выбору ведущего и
	      ведомого устройств.  Для получения помощи по правильному
	      положению переключателей обратитесь к документации по
	      устройствам.</p></div></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd-setup"></a>17.4.1.1.2. Настройка CCD</h5></div></div></div><p>Драйвер <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> позволяет вам взять несколько
	    идентичных дисков и объединить их в одну логическую файловую
	    систему.  Для использования <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> нужно
	    ядро со встроенной поддержкой <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>.
	    Добавьте такую строку в файл конфигурации ядра, перестройте и
	    установите новое ядро:</p><pre class="programlisting">device   ccd</pre><p>Поддержка <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>
	    также может быть обеспечена загрузкой подгружаемого модуля
	    ядра.</p><p>Для настройки <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> сначала вам
	    нужно воспользоваться утилитой <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a> для разметки
	    дисков:</p><pre class="programlisting">bsdlabel -w ad1 auto
bsdlabel -w ad2 auto
bsdlabel -w ad3 auto</pre><p>При этом создаются метки для <code class="filename">ad1c</code>,
	    <code class="filename">ad2c</code> и <code class="filename">ad3c</code>,
	    которые занимают диск полностью.</p><p>Следующим шагом является изменение типа метки диска.  Для
	    редактирования дисков можно использовать утилиту
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a>:</p><pre class="programlisting">bsdlabel -e ad1
bsdlabel -e ad2
bsdlabel -e ad3</pre><p>При этом в редакторе, задаваемом переменной окружения
	    <code class="envar">EDITOR</code> (обычно это <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=vi&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">vi</span>(1)</span></a>),
	    открывается текущая метка каждого диска.</p><p>Не модифицированная метка диска будет выглядеть примерно
	    следующим образом:</p><pre class="programlisting">8 partitions:
#        size   offset    fstype   [fsize bsize bps/cpg]
  c: 60074784        0    unused        0     0     0   # (Cyl.    0 - 59597)</pre><p>Добавьте новый раздел <code class="literal">e</code> для использования
	    драйвером <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>.  Как правило, он может быть скопирован с
	    раздела <code class="literal">c</code>, но поле <code class="option">fstype</code>
	    <span class="emphasis"><em>должно</em></span> иметь значение
	    <strong class="userinput"><code>4.2BSD</code></strong>.  Теперь метка диска должна выглядеть
	    примерно так:</p><pre class="programlisting">8 partitions:
#        size   offset    fstype   [fsize bsize bps/cpg]
  c: 60074784        0    unused        0     0     0   # (Cyl.    0 - 59597)
  e: 60074784        0    4.2BSD        0     0     0   # (Cyl.    0 - 59597)</pre></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd-buildingfs"></a>17.4.1.1.3. Построение файловой системы</h5></div></div></div><p>Теперь, когда все диски размечены, вы должны построить
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>.  Для этого используйте утилиту
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ccdconfig</span>(8)</span></a> с параметрами, подобными следующим:</p><pre class="programlisting">ccdconfig ccd0<a id="co-ccd-dev"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span> 32<a id="co-ccd-interleave"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span> 0<a id="co-ccd-flags"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span> /dev/ad1e<a id="co-ccd-devs"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span> /dev/ad2e /dev/ad3e</pre><p>Использование и значение каждого параметра описывается
	    ниже:</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co-ccd-dev"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Первым аргументом является конфигурируемое устройство,
		в нашем случае <code class="filename">/dev/ccd0c</code>.  Часть
		<code class="filename">/dev/</code> является необязательной.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-ccd-interleave"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Чередование для файловой системы.  Оно определяет размер
		единицы блока данных в количестве дисковых блоков, каждый из
		которых обычно имеет объём в 512 байт.  Таким образом, при
		чередовании в 32 это будет составлять 16384 байт.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-ccd-flags"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Опции для <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ccdconfig</span>(8)</span></a>.  Если вы хотите включить
		зеркалирование диска, то можете задать это здесь.  В нашей
		конфигурации зеркалирование для <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> не предусмотрено,
		поэтому здесь задан 0 (ноль).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-ccd-devs"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Последним параметром для <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ccdconfig</span>(8)</span></a>
		является список устройств для объединения в массив.  Для
		каждого устройства нужно задавать полное имя.</p></td></tr></table></div><p>После запуска <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ccdconfig</span>(8)</span></a> устройство
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> будет отконфигурировано.  Может
	    будет построить файловую систему.  Обратитесь к справке по
	    команде <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a> для выяснения требуемых параметров, или
	    просто запустите: </p><pre class="programlisting">newfs /dev/ccd0c</pre></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd-auto"></a>17.4.1.1.4. Автоматическое выполнение</h5></div></div></div><p>Вообще говоря, вам потребуется монтировать
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> при каждой перезагрузке.  Для этого
	    сначала вы должны отконфигурировать это устройство.  Запишите
	    вашу текущую конфигурацию в файл <code class="filename">/etc/ccd.conf</code>
	    при помощи такой команды:</p><pre class="programlisting">ccdconfig -g &gt; /etc/ccd.conf</pre><p>При перезагрузке скрипт <code class="command">/etc/rc</code> запускает
	    команду <code class="command">ccdconfig -C</code>, если существует файл
	    <code class="filename">/etc/ccd.conf</code>.  При этом
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> автоматически конфигурируется так,
	    чтобы он мог быть смонтирован.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если при загрузке вы входите в однопользовательский режим, то
	      перед тем, как выполнять монтирование <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> по команде
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a>, вам нужно для конфигурации массива
	      запустить следующую команду:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">ccdconfig -C</pre></div><p>Для автоматического монтирования <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>
	    поместите запись о <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> в файл
	    <code class="filename">/etc/fstab</code>, чтобы он мог быть
	    смонтирован во время загрузки системы:</p><pre class="programlisting">/dev/ccd0c              /media       ufs     rw      2       2</pre></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="raid-hard"></a>17.4.2. Аппаратный RAID</h3></div></div></div><a id="idp91078224" class="indexterm"></a><p>FreeBSD поддерживает также целый ряд аппаратных контроллеров
	<acronym class="acronym">RAID</acronym>.  Эти устройства самостоятельно управляют
	<acronym class="acronym">RAID</acronym>-подсистемой, без необходимости иметь
	специфичное для FreeBSD программное обеспечения управления
	массивом.</p><p>При помощи встроенной в адаптер <acronym class="acronym">BIOS</acronym>, он
	сам управляет большинством дисковых операций.  Далее следует краткое
	описание установки при помощи контроллера Promise
	<acronym class="acronym">IDE</acronym> <acronym class="acronym">RAID</acronym>.
	После установки адаптера и запуска системы, выдаётся
	запрос на ввод.  Следуйте указаниям для входа в настройку адаптера.
	Отсюда вы можете объединить все подключенные диски.  После этого
	во FreeBSD диск(и) будут выглядеть как один диск.  Аналогично могут
	быть настроены и другие уровни <acronym class="acronym">RAID</acronym>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91082576"></a>17.4.3. Перестроение массивов ATA RAID1</h3></div></div></div><p>FreeBSD позволяет вам выполнять горячую замену вышедшего из строя
	диска.  При этом требуется, чтобы вы заметили это до
	перезагрузки.</p><p>Вероятно, в файле <code class="filename">/var/log/messages</code> или в
	выдаче команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dmesg&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dmesg</span>(8)</span></a> вы увидите примерно следующее:</p><pre class="programlisting">ad6 on monster1 suffered a hard error.
ad6: READ command timeout tag=0 serv=0 - resetting
ad6: trying fallback to PIO mode
ata3: resetting devices .. done
ad6: hard error reading fsbn 1116119 of 0-7 (ad6 bn 1116119; cn 1107 tn 4 sn 11)\\
status=59 error=40
ar0: WARNING - mirror lost</pre><p>При помощи <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=atacontrol&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">atacontrol</span>(8)</span></a> получите дополнительную
	информацию:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol list</code></strong>
ATA channel 0:
        Master:      no device present
        Slave:       acd0 &lt;HL-DT-ST CD-ROM GCR-8520B/1.00&gt; ATA/ATAPI rev 0

ATA channel 1:
        Master:      no device present
        Slave:       no device present

ATA channel 2:
        Master:      ad4 &lt;MAXTOR 6L080J4/A93.0500&gt; ATA/ATAPI rev 5
        Slave:       no device present

ATA channel 3:
        Master:      ad6 &lt;MAXTOR 6L080J4/A93.0500&gt; ATA/ATAPI rev 5
        Slave:       no device present

<code class="prompt">#</code> <strong class="userinput"><code>atacontrol status ar0</code></strong>
ar0: ATA RAID1 subdisks: ad4 ad6 status: DEGRADED</pre><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Сначала вам нужно отключить канал контроллера ATA, содержащий
	    отказавший диск, чтобы его можно было без последствий
	    извлечь:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol detach ata3</code></strong></pre></li><li class="step"><p>Замените диск.</p></li><li class="step"><p>Повторно подключите канал дискового контроллера:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol attach ata3</code></strong>
Master:  ad6 &lt;MAXTOR 6L080J4/A93.0500&gt; ATA/ATAPI rev 5
Slave:   no device present</pre></li><li class="step"><p>Добавьте новый диск к массиву в качестве резервного:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol addspare ar0 ad6</code></strong></pre></li><li class="step"><p>Перестройте массив:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol rebuild ar0</code></strong></pre></li><li class="step"><p>Проверить состояние дел можно при помощи следующей команды:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dmesg | tail -10</code></strong>
[выдача удалена]
ad6: removed from configuration
ad6: deleted from ar0 disk1
ad6: inserted into ar0 disk1 as spare

<code class="prompt">#</code> <strong class="userinput"><code>atacontrol status ar0</code></strong>
ar0: ATA RAID1 subdisks: ad4 ad6 status: REBUILDING 0% completed</pre></li><li class="step"><p>Дождитесь завершения этой операции.</p></li></ol></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="disks-adding.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="disks.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="usb-disks.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">17.3. Добавление дисков </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 17.5. USB устройства хранения</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>