<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>21.6. Пересборка <<world>></title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Руководство FreeBSD" /><link rel="up" href="updating-upgrading.html" title="Глава 21. Обновление системы и смена версии" /><link rel="prev" href="synching.html" title="21.5. Синхронизация ваших исходных текстов" /><link rel="next" href="small-lan.html" title="21.7. Отслеживание исходных текстов для нескольких машин" /><link rel="copyright" href="legalnotice.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">21.6. Пересборка <span class="quote"><<<span class="quote">world</span>>></span></th></tr><tr><td width="20%" align="left"><a accesskey="p" href="synching.html">Пред.</a> </td><th width="60%" align="center">Глава 21. Обновление системы и смена версии</th><td width="20%" align="right"> <a accesskey="n" href="small-lan.html">След.</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="makeworld"></a>21.6. Пересборка <span class="quote"><<<span class="quote">world</span>>></span></h2></div></div></div><a id="idp93621328" class="indexterm"></a><p>После того, как вы синхронизировали ваше локальное дерево
      исходных текстов с некоторой версией FreeBSD
      (FreeBSD-STABLE, FreeBSD-CURRENT и так далее),
      то можете использовать эти исходные тексты для перестроения
      системы.</p><div xmlns="" class="warning"><h3 class="admontitle">Создайте резервную копию: </h3><p xmlns="http://www.w3.org/1999/xhtml">Невозможно переоценить важность создания резервной
	копии вашей системы <span class="emphasis"><em>до того</em></span>, как вы будете
	это делать.  Хотя перестроение системы (пока вы следуете этим
	инструкциям) является простой задачей, вы всегда можете допустить
	ошибку, или ошибка может оказаться в исходных текстах, что может
	привести к тому, что система перестанет загружаться.</p><p xmlns="http://www.w3.org/1999/xhtml">Обязательно сделайте резервную копию.  И держите под рукой
	аварийную (fixit) дискету или загрузочный компакт диск.  Может быть,
	вам никогда не приходилось ими
	пользоваться, но, постучав по дереву, всегда лучше подготовиться, чем
	потом сожалеть.</p></div><div xmlns="" class="warning"><h3 class="admontitle">Подпишитесь на соответствующий список рассылки: </h3><a xmlns="http://www.w3.org/1999/xhtml" id="idp93625296" class="indexterm"></a><p xmlns="http://www.w3.org/1999/xhtml">Ветки FreeBSD-STABLE и FreeBSD-CURRENT кода по природе своей являются
	<span class="emphasis"><em>изменяющимися</em></span>.  В разработке FreeBSD участвуют
	люди, и время от времени случаются ошибки.</p><p xmlns="http://www.w3.org/1999/xhtml">Иногда эти ошибки достаточно безобидны и приводят к выводу
	нового диагностического сообщения.  Бывает, что изменение оказывается
	катастрофическим, и система не может загрузиться или разрушаются
	файловые системы (или что-нибудь ещё хуже).</p><p xmlns="http://www.w3.org/1999/xhtml">Если возникают подобные проблемы, в соответствующем списке
	рассылки публикуется сообщение <span class="quote"><<<span class="quote">heads up</span>>></span>, в котором
	описывается природа проблемы и затрагиваемые системы.  Когда проблема
	решается, публикуется сообщение <span class="quote"><<<span class="quote">all clear</span>>></span>.</p><p xmlns="http://www.w3.org/1999/xhtml">Если вы пытаетесь отслеживать FreeBSD-STABLE или FreeBSD-CURRENT и не
	читаете <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-stable" target="_top">Список рассылки, посвящённый обсуждению FreeBSD-STABLE</a> или <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current" target="_top">Список рассылки, посвящённый обсуждению FreeBSD-CURRENT</a> соответственно, то
	вы напрашиваетесь на неприятности.</p></div><div xmlns="" class="warning"><h3 class="admontitle">Не используйте <code xmlns="http://www.w3.org/1999/xhtml" class="command">make world</code>: </h3><p xmlns="http://www.w3.org/1999/xhtml">Множество старой документации рекомендует использование
	<code class="command">make world</code>.  При этом пропускаются многие
	важные шаги, и использование этой команды возможно лишь в том
	случае, если вы точно знаете, что делаете.  Почти во всех
	обстоятельствах	<code class="command">make world</code> это неправильный
	способ, вместо него необходимо использовать описанную здесь
	процедуру.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93636176"></a>21.6.1. Канонический способ обновления вашей системы</h3></div></div></div><p>Для обновления вашей системы вы должны прочесть
	<code class="filename">/usr/src/UPDATING</code> для выяснения шагов, которые
	нужно предпринять перед построением системы из вашей версии исходных
	текстов, а затем выполнить следующую последовательность
	действий:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make buildworld</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make buildkernel</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make installkernel</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>shutdown -r now</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Есть несколько редких случаев, когда перед выполнением
	  <code class="buildtarget">buildworld</code> необходимо дополнительно
	  запустить <code class="command">mergemaster -p</code>.  Они описаны в файле
	  <code class="filename">UPDATING</code>.  В общем случае вы можете без ущерба
	  пропустить этот шаг, если не выполняете обновление с одной большой
	  версии FreeBSD на другую.</p></div><p>После успешного выполнения <code class="buildtarget">installkernel</code>
	вам необходимо загрузить систему в однопользовательском режиме (то
	есть посредством команды <code class="command">boot -s</code>, заданной в
	приглашении загрузчика).  После этого выполните:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -a -t ufs</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mergemaster -p</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make installworld</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mergemaster</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>reboot</code></strong></pre><div xmlns="" class="warning"><h3 class="admontitle">Прочтите более полное описание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Описанная выше последовательность является только краткой
	  выжимкой для того, чтобы помочь вам начать.  Вы должны всё же
	  прочесть последующие разделы для полного понимания каждого шага,
	  особенно если собираетесь использовать собственную конфигурацию
	  ядра.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93650896"></a>21.6.2. Прочтите <code class="filename">/usr/src/UPDATING</code></h3></div></div></div><p>Перед тем, как делать что-либо, прочтите
	<code class="filename">/usr/src/UPDATING</code> (или соответствующий файл
	в вашей копии исходных текстов).  В этом файле
	содержится важная информация о проблемах, с которыми вы можете
	столкнуться, или указан порядок, в котором вы должны запускать
	определенные команды.  Если в файле <code class="filename">UPDATING</code>
	написано нечто, противоречащее тому, что вы здесь читаете, то
	нужно следовать указаниям в <code class="filename">UPDATING</code>.</p><div xmlns="" class="important"><h3 class="admontitle">Важно: </h3><p xmlns="http://www.w3.org/1999/xhtml">Чтение <code class="filename">UPDATING</code> не заменит подписки на
	  соответствующий список рассылки, как это и описано выше.  Эти два
	  условия являются дополняющими, а не взаимоисключающими друг
	  друга.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93654608"></a>21.6.3. Проверьте содержимое <code class="filename">/etc/make.conf</code></h3></div></div></div><a id="idp93696592" class="indexterm"></a><p>Просмотрите файлы <code class="filename">/usr/share/examples/etc/make.conf</code>
	и <code class="filename">/etc/make.conf</code>.  Первый содержит некоторые
	предопределенные по умолчанию значения - большинство из них
	закомментировано.  Чтобы воспользоваться ими при перестроении системы
	из исходных текстов, добавьте их в файл
	<code class="filename">/etc/make.conf</code>.  Имейте в виду, что все,
	добавляемое вами в <code class="filename">/etc/make.conf</code>, используется
	также каждый раз при запуске команды <code class="command">make</code>, так что
	полезно задать здесь значения, подходящие вашей системе.</p><p>Вероятно стоит скопировать строки
	<code class="varname">CFLAGS</code> и <code class="varname">NO_PROFILE</code>,
	расположенные в
	<code class="filename">/usr/share/examples/etc/make.conf</code>, в файл
	<code class="filename">/etc/make.conf</code> и раскомментировать их.</p><p>Посмотрите на другие определения (<code class="varname">COPTFLAGS</code>,
	<code class="varname">NOPORTDOCS</code> и так далее) и решите, нужны ли они
	вам.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93702992"></a>21.6.4. Обновите файлы в каталоге <code class="filename">/etc</code></h3></div></div></div><p>Каталог <code class="filename">/etc</code> содержит значительную часть
	информации о конфигурации вашей системы, а также скрипты, работающие
	в начале работы системы.  Некоторые из этих скриптов меняются от
	версии к версии FreeBSD.</p><p>Некоторые конфигурационные файлы также используются в ежедневной
	работе системы.  В частности, файл
	<code class="filename">/etc/group</code>.</p><p>Случалось, что установочная часть <code class="command">make installworld</code>
	ожидала существования определённых имен пользователей или групп.  При
	обновлении существует вероятность, что эти пользователи или группы не
	существуют.  Это вызывает проблемы при обновлении.  В некоторых
	случаях <code class="command">make buildworld</code> проверяет наличие этих
	пользователей или групп.</p><p>Примером этого является добавление пользователя
	<code class="systemitem">smmsp</code>.  Пользователи столкнулись с прерыванием
	процесса установки, когда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mtree&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mtree</span>(8)</span></a> пыталась
	создать <code class="filename">/var/spool/clientmqueue</code>.</p><p>Выходом является запуск утилиты <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> в
	режиме, предваряющем построение системы, задаваемым опцией
	<code class="option">-p</code>.  Она будет сравнивать только те файлы, которые
	необходимы для успешного выполнения целей
	<code class="buildtarget">buildworld</code> или
	<code class="buildtarget">installworld</code>.  Если ваша старая версия
	утилиты <code class="command">mergemaster</code> не поддерживает опцию
	<code class="option">-p</code>, воспользуйтесь новой версией из дерева исходных
	текстов при первом запуске:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/usr.sbin/mergemaster</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>./mergemaster.sh -p</code></strong></pre><div xmlns="" class="tip"><h3 class="admontitle">Подсказка: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если вы параноик, можете поискать файлы, владельцем которых
	  является та группа, которую вы переименовываете или удаляете:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>find / -group <em class="replaceable"><code>GID</code></em> -print</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">выдаст список всех файлов, владельцем которых является группа
	  <em class="replaceable"><code>GID</code></em> (задаваемая именем или
	  численным значением ID).</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="makeworld-singleuser"></a>21.6.5. Перейдите в однопользовательский режим</h3></div></div></div><a id="idp93721680" class="indexterm"></a><p>Вам может понадобиться откомпилировать систему в
	однопользовательском режиме.  Кроме обычного выигрыша в
	скорости процесса, переустановка системы затрагивает много важных
	системных файлов, все стандартные выполнимые файлы системы,
	библиотеки, include-файлы и так далее.  Изменение их на работающей
	системе (в частности, в которой активно работают пользователи) может
	привести к неприятностям.</p><a id="idp93722576" class="indexterm"></a><p>Другим способом является компиляция системы в многопользовательском
	режиме с последующим переходом в однопользовательский режим для
	выполнения установки.  Если вы хотите поступить именно так, просто
	следуйте инструкциям до момента окончания построения.  Вы можете
	отложить переход в однопользовательский режим до завершения целей
	<code class="buildtarget">installkernel</code> или
	<code class="buildtarget">installworld</code>.</p><p>Как администратор, вы можете выполнить:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>shutdown now</code></strong></pre><p>на работающей системе, что переведет ее в однопользовательский
	режим.</p><p>Либо вы можете выполнить перезагрузку и в приглашении загрузчика
	выбрать пункт <span class="quote"><<<span class="quote">single user</span>>></span>.  После этого система загрузится в
	однопользовательском режиме.  В приглашении командного процессора вы
	должны запустить:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fsck -p</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -u /</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -a -t ufs</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>swapon -a</code></strong></pre><p>Эти команды выполняют проверку файловых систем, повторно монтируют
	<code class="filename">/</code> в режиме чтения/записи, монтируют все
	остальные файловые системы UFS, перечисленные в файле
	<code class="filename">/etc/fstab</code> и включат подкачку.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если часы в вашей CMOS настроены на местное время, а не на GMT
	  (это имеет место, если команда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=date&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">date</span>(1)</span></a> выдаёт
	  неправильные время и зону), то вам может понадобиться запустить
	  следующую команду:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>adjkerntz -i</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">Это обеспечит корректную настройку местного часового пояса
	  - без этого впоследствии вы можете столкнуться с некоторыми
	  проблемами.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93738448"></a>21.6.6. Удалите <code class="filename">/usr/obj</code></h3></div></div></div><p>При перестроении частей системы они помещаются в каталоги,
	которые (по умолчанию) находятся в <code class="filename">/usr/obj</code>.
	Структура повторяет структуру <code class="filename">/usr/src</code>.</p><p>Вы можете ускорить выполнение процесса <code class="command">make buildworld</code>
	и, возможно, избавить себя от некоторой головной боли, связанной с
	зависимостями, удалив этот каталог.</p><p>На некоторых файлах из <code class="filename">/usr/obj</code> могут быть
	установлены специальные флаги (обратитесь к <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=chflags&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">chflags</span>(1)</span></a> за
	дополнительной информацией), которые сначала должны быть
	сняты.</p><pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/obj</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chflags -R noschg *</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>rm -rf *</code></strong>
      </pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="updating-upgrading-compilebase"></a>21.6.7. Перекомпилируйте исходные тексты базовой системы</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93767120"></a>21.6.7.1. Сохраните вывод</h4></div></div></div><p>Неплохо сохранить вывод, получаемый при работе программы
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>, в файл.  Если что-то вдруг пойдет не так, вы будете
	  иметь копию сообщения об ошибке и полную картину того, где она
	  произошла.  Хотя это может и не помочь в определении причин
	  происходящего, это может помочь другим, если вы опишите вашу
	  проблему в одном из списков рассылки FreeBSD.</p><p>Проще всего это сделать при помощи команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=script&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">script</span>(1)</span></a> с
	  параметром, в котором указано имя файла, в который нужно сохранить
	  вывод.  Вы должны сделать это непосредственно перед тем, как
	  перестроить систему, а по окончании процесса набрать
	  <strong class="userinput"><code>exit</code></strong>.</p><pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>script /var/tmp/mw.out</code></strong>
Script started, output file is /var/tmp/mw.out
<code class="prompt">#</code> <strong class="userinput"><code>make world</code></strong>
<span class="emphasis"><em>... compile, compile, compile ...</em></span>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>
Script done, ...
	</pre><p>Если вы делаете это, <span class="emphasis"><em>не</em></span> сохраняйте
	  вывод в <code class="filename">/tmp</code>.  Этот каталог может быть
	  очищен при следующей перезагрузке.  Лучше сохранить его в
	  <code class="filename">/var/tmp</code> (как в предыдущем примере) или в
	  домашнем каталоге пользователя <code class="systemitem">root</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="make-buildworld"></a>21.6.7.2. Компиляция базовых компонентов системы</h4></div></div></div><p>Вы должны находиться в каталоге
	  <code class="filename">/usr/src</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong></pre><p>(если, конечно, ваш исходный код не находится в другом месте, в
	  случае чего вам нужно перейти в соответствующий каталог).</p><a id="idp93786832" class="indexterm"></a><p>Для полного перестроения системы используется
	  команда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>.  Эта команда читает инструкции из файла
	  <code class="filename">Makefile</code>, описывающего, как должны быть
	  перестроены программы, которые составляют систему FreeBSD, в каком
	  порядке они должны быть построены и так далее.</p><p>Общий формат командной строки, которую вы будет набирать,
	  таков:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -<em class="replaceable"><code>x</code></em> -D<em class="replaceable"><code>VARIABLE</code></em> <em class="replaceable"><code>target</code></em></code></strong></pre><p>В этом примере <code class="option">-<em class="replaceable"><code>x</code></em></code>
	  является параметром, который вы передаете в <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>.
	  Обратитесь к справочной странице программы <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>, которая
	  содержит список возможных параметров.</p><p><code class="option">-D<em class="replaceable"><code>VARIABLE</code></em></code>
	  передает переменную в <code class="filename">Makefile</code>.  Поведение
	  <code class="filename">Makefile</code> определяется этими переменными.  Это
	  те же самые переменные, которые задаются в
	  <code class="filename">/etc/make.conf</code>, и это - еще один способ
	  их задания.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -DNO_PROFILE=true <em class="replaceable"><code>target</code></em></code></strong></pre><p>является другим способом указания того, что библиотеки для
	  профилирования строить не нужно, и соответствует строке</p><pre class="programlisting">NO_PROFILE=    true	# Обход построения библиотек для профилирования</pre><p>в файле <code class="filename">/etc/make.conf</code>.</p><p><em class="replaceable"><code>target</code></em> указывает программе
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> на то, что вы хотите сделать.  Каждый файл
	  <code class="filename">Makefile</code> определяет некоторое количество
	  различных <span class="quote"><<<span class="quote">целей</span>>></span>, и ваш выбор цели определяет то, что
	  будет делаться.</p><p>Некоторые цели, перечисленные в файле
	  <code class="filename">Makefile</code>, не предназначены для вызова.  Просто
	  они используются в процессе построения для разбиения его на этапы.</p><p>В большинстве случаев вам не нужно передавать никаких
	  параметров в <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>, так что ваша команда будет выглядеть
	  примерно так:</p><pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>make <em class="replaceable"><code>target</code></em></code></strong>
	</pre><p>Замените <em class="replaceable"><code>target</code></em> на одну или более из
	  опций сборки.  Первой из них всегда должна быть опция
	  <code class="varname">buildworld</code>.</p><p>Как указывают на это названия,
	  <code class="buildtarget">buildworld</code> строит полностью новое дерево
	  в каталоге <code class="filename">/usr/obj</code>, а
	  <code class="buildtarget">installworld</code> устанавливает это дерево на
	  используемой машине.</p><p>Разделение этих опций весьма полезно по двум причинам.  Во-первых, это позволяет
	  вам безопасно строить систему, зная, что компоненты вашей рабочей
	  системы затронуты не будут.  Построение
	  <span class="quote"><<<span class="quote">самодостаточно</span>>></span>.  По этой причине вы можете спокойно
	  запустить <code class="buildtarget">buildworld</code> на машине, работающей в
	  многопользовательском режиме без опаски получить какие-либо проблемы.
	  Но всё же рекомендуется запускать цель
	  <code class="buildtarget">installworld</code> в однопользовательском
	  режиме.</p><p>Во-вторых, это позволяет вам использовать монтирование по NFS для
	  обновления многих машин в сети.  Если у вас есть три машины,
	  <code class="systemitem">A</code>, <code class="systemitem">B</code> и <code class="systemitem">C</code>, которые
	  вы хотите обновить, запустите <code class="command">make buildworld</code> и
	  <code class="command">make installworld</code> на машине <code class="systemitem">A</code>.
	  Хосты <code class="systemitem">B</code> и <code class="systemitem">C</code> должны будут
	  затем смонтировать по NFS каталоги <code class="filename">/usr/src</code>
	  и <code class="filename">/usr/obj</code> с машины <code class="systemitem">A</code>, и вы
	  сможете запустить <code class="command">make installworld</code> для установки
	  результатов построения на машинах <code class="systemitem">B</code> и
	  <code class="systemitem">C</code>.</p><p>Хотя цель <code class="buildtarget">world</code> всё ещё имеется в
	  наличии, вам настоятельно рекомендуется не пользоваться ею.</p><p>Выполните</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make buildworld</code></strong></pre><p>Имеется возможность задавать команде
	  <code class="command">make</code> параметр <code class="option">-j</code>, который
	  приводит к запуску нескольких одновременно работающих процессов.
	  Наиболее полезно использовать это на многопроцессорных машинах.
	  Однако, так как процесс компиляции больше всего требователен к
	  подсистеме ввода/вывода, а не к производительности процессора, это
	  можно использовать и на машинах с одним процессором.</p><p>На типичной машине с одним CPU вы должны запускать:</p><pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>make -j4 buildworld</code></strong>
	</pre><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> будет иметь до 4 одновременно работающих
	  процессов.  Эмпирические замеры, опубликованные как-то в списке рассылки,
	  показывают, что в среднем это дает наибольшее увеличение
	  производительности.</p><p>Если у вас многопроцессорная машина и вы используете ядро с
	  настройками для SMP, попробуйте использовать значения между 6 и
	  10 и посмотрите, как это отразится на скорости работы.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93837648"></a>21.6.7.3. Время на построение</h4></div></div></div><a id="idp93838288" class="indexterm"></a><p>На время компиляции влияет множество факторов, но на данный
	  момент современные машины
	  справляются с построением дерева FreeBSD-STABLE примерно за 1-2 часа
	  без дополнительных хитростей и убыстряющих процесс уловок.  Дерево
	  FreeBSD-CURRENT строится несколько дольше.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93840464"></a>21.6.8. Откомпилируйте и установите новое ядро</h3></div></div></div><a id="idp93841104" class="indexterm"></a><p>Чтобы получить полную отдачу от вашей новой системы, вы должны
	перекомпилировать ядро.  Это практически необходимость, так как
	отдельные структуры в памяти могут меняться, и программы типа
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ps&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ps</span>(1)</span></a> и <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=top&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">top</span>(1)</span></a> не будут работать, пока версии ядра и
	исходных текстов системы не будут совпадать.</p><p>Самым простым и надежным способом сделать это является компиляция и
	установка ядра на основе <code class="filename">GENERIC</code>.  Хотя в
	<code class="filename">GENERIC</code> могут оказаться не все необходимые для
	работы вашей системы устройства, в нем имеется все необходимое
	для перезагрузки вашей системы обратно в однопользовательский режим.
	Это является хорошей проверкой на правильность работы новой системы.
	После загрузки с ядром <code class="filename">GENERIC</code> и проверки
	работоспособности системы вы можете построить новое ядро на основе
	вашего обычного конфигурационного файла ядра.</p><p>В FreeBSD важно выполнить <a class="link" href="makeworld.html#make-buildworld" title="21.6.7.2. Компиляция базовых компонентов системы">buildworld</a> перед сборкой
	нового ядра.</p><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если вы хотите построить собственное ядро и уже подготовили файл
	  конфигурации, просто используйте
	  <code class="literal">KERNCONF=<em class="replaceable"><code>MYKERNEL</code></em></code>
	  следующим образом:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make buildkernel KERNCONF=<em class="replaceable"><code>MYKERNEL</code></em></code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make installkernel KERNCONF=<em class="replaceable"><code>MYKERNEL</code></em></code></strong></pre></div><p>Заметьте, что, если вы установили
	<code class="literal">kern.securelevel</code> в значение, превышающее 1,
	<span class="emphasis"><em>и</em></span> установили флаг <code class="literal">noschg</code> или
	подобный на бинарный файл ядра, то вы будете вынуждены перейти в
	однопользовательский режим для того, чтобы воспользоваться
	<code class="buildtarget">installkernel</code>.  В противном случае вы
	должны выполнять эти команды без проблем.  Обратитесь к справочным
	страницам об <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=init&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">init</span>(8)</span></a> для получения подробной информации о
	<code class="literal">kern.securelevel</code> и <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=chflags&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">chflags</span>(1)</span></a> для получения
	информации о различных флагах файлов.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93859152"></a>21.6.9. Перезагрузитесь в однопользовательский режим</h3></div></div></div><a id="idp93859792" class="indexterm"></a><p>Для проверки работоспособности ядра вы должны перезагрузить систему
	и перейти в однопользовательский режим.  Сделайте это, следуя указаниям
	в <a class="xref" href="makeworld.html#makeworld-singleuser" title="21.6.5. Перейдите в однопользовательский режим">Раздел 21.6.5, <<Перейдите в однопользовательский режим>></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="make-installworld"></a>21.6.10. Установите новые версии системных программ</h3></div></div></div><p>Если вы компилировали достаточно свежую версию FreeBSD, в которой
	имеется команда <code class="command">make buildworld</code>, то для установки
	новых версий программ вы должны теперь выполнить команду
	<code class="buildtarget">installworld</code>.</p><p>Запустите</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make installworld</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Если при выполнении команды <code class="command">make buildworld</code> вы
	  задавали значения каких-либо переменных, то при выполнении
	  <code class="command">make installworld</code> вы должны задать те же самые
	  переменные.  Это не всегда так для остальных параметров; например,
	  при выполнении <code class="buildtarget">installworld</code> никогда не
	  должен использоваться параметр <code class="option">-j</code>.</p><p xmlns="http://www.w3.org/1999/xhtml">Например, если вы выполняли команду:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -DNO_PROFILE buildworld</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">то результат её выполнения должен устанавливаться командой</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -DNO_PROFILE installworld</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">В противном случае будет делаться попытка установить библиотеки
	  для профилирования, которые не компилировались на этапе выполнения
	  команды <code class="command">make buildworld</code>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93879376"></a>21.6.11. Обновите файлы, не обновленные по команде
	<code class="command">make installworld</code></h3></div></div></div><p>При перестроении системы не будут обновляться некоторые каталоги
	(в частности, <code class="filename">/etc</code>, <code class="filename">/var</code> и
	<code class="filename">/usr</code>) с конфигурационными
	файлами.</p><p>Самым простым способом обновить такие файлы является запуск
	утилиты <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a>, хотя можно сделать это и вручную, если вам
	так больше нравится.  Вне зависимости от выбранного вами способа
	обязательно сделайте резервную копию каталога <code class="filename">/etc</code>
	на случай, если произойдёт что-то непредвиденное.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="mergemaster"></a>21.6.11.1. <code class="command">mergemaster</code></h4></div><div><span class="authorgroup">Текст предоставил <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Tom</span> <span class="surname">Rhodes</span></span>. </span></div></div></div><a id="idp93886288" class="indexterm"></a><p>Утилита <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> является скриптом для оболочки Боурна,
	  которая поможет вам в определении разницы между вашими
	  конфигурационными файлами в каталоге <code class="filename">/etc</code> и
	  конфигурационными файлами из дерева исходных текстов
	  <code class="filename">/usr/src/etc</code>.  Это является рекомендуемым
	  способом синхронизации системных конфигурационных файлов с теми, что
	  размещены в дереве исходных текстов.</p><p>Для начала просто наберите <code class="command">mergemaster</code> в
	  приглашении командной строки и посмотрите, что происходит.
	  <code class="command">mergemaster</code> построит временное окружение для
	  пользователя root, начиная от <code class="filename">/</code>, а затем
	  заполнит его различными системными конфигурационными файлами.  Эти
	  файлы затем будут сравниваться с теми, что установлены в вашей
	  системе.  В этот момент файлы, которые имеют отличия, будут выданы в
	  формате <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a>, где знак <code class="option">+</code> будет означать
	  добавленные или изменённые строки, а знак <code class="option">-</code> будет
	  означать строки, которые были либо полностью удалены, либо заменены
	  на новые.  Обратитесь к страницам справочной системы по команде
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a> для получения более полной информации о синтаксисе
	  команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a> и формате выдачи отличий в файлах.</p><p>Затем <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> выдаст вам каждый файл, в котором есть
	  изменения, и в этот момент у вас есть возможность либо удалить новый
	  файл (который будем считать временным), установить временный файл в
	  его неизменённом виде, объединить временный файл с установленным на
	  данный момент, либо просмотреть выдачу <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a> ещё раз.</p><p>Выбор удаления временного файла укажет <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> на то,
	  что мы хотим оставить наш текущий файл без изменений и удалить его
	  новую версию.  Делать это не рекомендуется, если только
	  у вас нет причин вносить изменения в текущий файл.  Вы можете
	  получить помощь в любое время, набрав <span class="keycap"><strong>?</strong></span> в
	  приглашении <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a>.  Если пользователь выбирает пропуск
	  файла, запрос появится снова после того, как будут обработаны все
	  остальные файлы.</p><p>Выбор установки немодифицированного временного файла приведёт к
	  замене текущего файла новым.  Для большинства немодифицированных
	  файлов это является подходящим вариантом.</p><p>Выбор варианта с объединением файла приведёт к вызову текстового
	  редактора, содержащего текст обоих файлов.  Теперь вы можете
	  объединить их, просматривая оба файла на экране, и выбирая те части
	  из обоих, что подходят для окончательного варианта.  Когда файлы
	  сравниваются на экране, то нажатие <span class="keycap"><strong>l</strong></span> выбирает
	  содержимое слева, а нажатие <span class="keycap"><strong>r</strong></span> выбирает содержимое
	  справа.  В окончательном варианте будет файл, состоящий из обеих
	  частей, который и будет установлен.  Этот вариант используется для
	  файлов, настройки в которых изменялись пользователем.</p><p>Выбор повторного просмотра <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a>-разниц выдаст вам разницы
	  между файлами, как это делала утилита <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> до того,
	  как запросила вас о выборе.</p><p>После того, как утилита <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> закончит работу с
	  системными файлами, она выдаст запрос относительно других параметров.
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> может запросить вас относительно перестроения
	  файла паролей и завершит запросом на удаление оставшихся
	  временных файлов.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp93907920"></a>21.6.11.2. Обновление в ручном режиме</h4></div></div></div><p>Однако если вы хотите произвести обновление вручную, то вы не
	  можете просто скопировать файлы из <code class="filename">/usr/src/etc</code> в
	  <code class="filename">/etc</code> и получить работающую систему.  Некоторые
	  из этих файлов сначала нужно <span class="quote"><<<span class="quote">установить</span>>></span>.  Это нужно
	  потому, что каталог <code class="filename">/usr/src/etc</code>
	  <span class="emphasis"><em>не</em></span> является копией того, что должен содержать
	  ваш каталог <code class="filename">/etc</code>.  Кроме того, есть файлы,
	  которые должны присутствовать в <code class="filename">/etc</code>, но которых
	  нет в <code class="filename">/usr/src/etc</code>.</p><p>Если вы используете <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> (как это рекомендуется),
	  то вы можете перейти сразу к <a class="link" href="makeworld.html#updating-upgrading-rebooting" title="21.6.12. Перезагрузка">следующему
	  разделу</a>.</p><p>Вручную проще всего сделать это, установив файлы в новый каталог,
	а затем пройтись по ним, отмечая разницу.</p><div xmlns="" class="warning"><h3 class="admontitle">Сделайте резервную копию вашего каталога
	  <code xmlns="http://www.w3.org/1999/xhtml" class="filename">/etc</code>: </h3><p xmlns="http://www.w3.org/1999/xhtml">Хотя, в теории, никаких автоматических действий с этим
	  каталогом не производится,
	  всегда лучше чувствовать себя уверенным.  Так что скопируйте
	  имеющийся каталог <code class="filename">/etc</code> в какое-нибудь
	  безопасное место.  Запустите что-то вроде:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp -Rp /etc /etc.old</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml"><code class="option">-R</code> задает выполнение рекурсивного копирования,
	  а <code class="option">-p</code> сохраняет даты, владельца файлов и тому
	  подобное.</p></div><p>Вам нужно создать шаблонную структуру каталогов для установки
	нового содержимого <code class="filename">/etc</code> и других файлов.
	Подходящим местом является <code class="filename">/var/tmp/root</code>, и в нём
	потребуется разместить некоторое количество подкаталогов.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /var/tmp/root</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/etc</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make DESTDIR=/var/tmp/root distrib-dirs distribution</code></strong></pre><p>Эти команды приведут к созданию нужной структуры каталогов и
	установке файлов.  Множество каталогов, созданных в
	<code class="filename">/var/tmp/root</code>, будут пустыми и должны быть удалены.
	Проще всего сделать это так:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /var/tmp/root</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>find -d . -type d | xargs rmdir 2&gt;/dev/null</code></strong></pre><p>Эти команды удалят все пустые каталоги.  (Стандартный поток
	диагностических сообщений перенаправляется в
	<code class="filename">/dev/null</code> для исключения предупреждений о
	непустых каталогах.)</p><p>Теперь <code class="filename">/var/tmp/root</code> содержит все файлы,
	которые должны быть помещены в соответствующие места в
	<code class="filename">/</code>.  Теперь пройдитесь по каждому их этих файлов
	и определите, чем они отличаются от имеющихся у вас файлов.</p><p>Заметьте, что некоторые из файлов, которые были установлены в
	каталог <code class="filename">/var/tmp/root</code>, имеют первым символом
	<span class="quote"><<<span class="quote">.</span>>></span>.  На момент написания единственными такими файлами
	являлись файлы начальных скриптов командных процессоров в
	<code class="filename">/var/tmp/root/</code> и
	<code class="filename">/var/tmp/root/root/</code>, хотя могут быть и другие
	(зависит от того, когда вы это читаете).  Обязательно пользуйтесь
	командой <code class="command">ls -a</code>, чтобы выявить их.</p><p>Проще всего сделать это путём сравнения двух файлов при помощи
	команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>diff /etc/shells /var/tmp/root/etc/shells</code></strong></pre><p>Эта команда покажет разницу между вашим файлом
	<code class="filename">/etc/shells</code> и новым файлом
	<code class="filename">/var/tmp/root/etc/shells</code>.  Используйте это для
	определения того, переносить ли сделанные вами изменения или
	скопировать поверх вашего старого файла.</p><div xmlns="" class="tip"><h3 class="admontitle">Называйте новый корневой каталог
	  (<code xmlns="http://www.w3.org/1999/xhtml" class="filename">/var/tmp/root</code>) по дате, чтобы вы смогли легко
	  выявить разницу между версиями: </h3><p xmlns="http://www.w3.org/1999/xhtml">Частое перестроение системы означает также и частое обновление
	  <code class="filename">/etc</code>, которое может быть несколько
	  обременительным.</p><p xmlns="http://www.w3.org/1999/xhtml">Вы можете ускорить этот процесс, сохраняя копию последнего
	  набора измененных файлов, которые вы перенесли в
	  <code class="filename">/etc</code>.  Следующая процедура подаст вам одну
	  идею о том, как это сделать.</p><div xmlns="http://www.w3.org/1999/xhtml" class="procedure"><ol class="procedure" type="1"><li class="step"><p>Выполните перестроение системы обычным образом.  Когда вы
	      вам потребуется обновить <code class="filename">/etc</code> и другие
	      каталоги, дайте целевому каталогу имя на основе текущей даты.
	      Если вы делаете это 14 февраля 1998 года, то вы можете сделать
	      следующее:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /var/tmp/root-19980214</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/etc</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make DESTDIR=/var/tmp/root-19980214 \
    distrib-dirs distribution</code></strong></pre></li><li class="step"><p>Перенесите изменение из этого каталога, как это описано
	      выше.</p><p><span class="emphasis"><em>Не</em></span> удаляйте каталог
	      <code class="filename">/var/tmp/root-19980214</code> после окончания
	      этого процесса.</p></li><li class="step"><p>Когда вы загрузите самую последнюю версию исходного кода и
	      перестроите систему, выполните шаг 1.  Это даст вам новый
	      каталог, который может называться
	      <code class="filename">/var/tmp/root-19980221</code> (если вы ждете
	      неделю между обновлениями).</p></li><li class="step"><p>Теперь вы можете видеть изменения, которые были сделаны
	      за прошедшую неделю, выполнив при помощи команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a>
	      рекурсивное сравнение двух каталогов:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /var/tmp</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>diff -r root-19980214 root-19980221</code></strong></pre><p>Как правило, здесь содержится гораздо меньше отличий, чем
	      между каталогами
	      <code class="filename">/var/tmp/root-19980221/etc</code> и
	      <code class="filename">/etc</code>.  Так как отличий меньше, то и легче
	      перенести эти изменения в ваш каталог
	      <code class="filename">/etc</code>.</p></li><li class="step"><p>Теперь вы можете удалить более старый из двух каталогов
	      <code class="filename">/var/tmp/root-*</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>rm -rf /var/tmp/root-19980214</code></strong></pre></li><li class="step"><p>Повторяйте этот процесс всякий раз, когда вам нужно
	      перенести изменения в каталог <code class="filename">/etc</code>.</p></li></ol></div><p xmlns="http://www.w3.org/1999/xhtml">Для автоматической генерации имён каталогов можно
	  использовать команду <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=date&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">date</span>(1)</span></a>:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /var/tmp/root-`date "+%Y%m%d"`</code></strong></pre></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="updating-upgrading-rebooting"></a>21.6.12. Перезагрузка</h3></div></div></div><p>Теперь вы сделали всё.  После того, как вы проверили, что всё
	на месте, можете перегрузить систему.  Простая команда
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=shutdown&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">shutdown</span>(8)</span></a> должна это сделать:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>shutdown -r now</code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp94053456"></a>21.6.13. Завершение</h3></div></div></div><p>Теперь у вас имеется успешно обновлённая система FreeBSD.
	Поздравляем!</p><p>Если что-то работает неправильно, можно с лёгкостью перестроить
	конкретную часть системы.  Например, если вы случайно удалили файл
	<code class="filename">/etc/magic</code> в процессе обновления или переноса
	<code class="filename">/etc</code>, то команда <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=file&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">file</span>(1)</span></a> перестанет работать.
	В таком случае это можно исправить вот так:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/usr.bin/file</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make all install</code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp94058320"></a>21.6.14. Вопросы?</h3></div></div></div><div class="qandaset"><a id="idp94058960"></a><dl><dt>21.6.14.1. <a href="makeworld.html#idp94059216">Нужно ли полностью перестраивать систему при каждом
	      изменении?</a></dt><dt>21.6.14.2. <a href="makeworld.html#idp94065744">Компиляция прерывается с большим количеством ошибок по
	      сигналу 11
	      (или с другим номером сигнала).  Что
	      случилось?</a></dt><dt>21.6.14.3. <a href="makeworld.html#idp94069072">Могу ли я удалить каталог /usr/obj
	      после окончания?</a></dt><dt>21.6.14.4. <a href="makeworld.html#idp94094288">Могут ли быть продолжены прерванные процессы
	      построения?</a></dt><dt>21.6.14.5. <a href="makeworld.html#idp94109776">Как ускорить процесс построения системы?</a></dt><dt>21.6.14.6. <a href="makeworld.html#idp94140880">Что мне делать, если что-то пошло не так?</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%" /><col /></colgroup><tbody><tr class="question"><td align="left" valign="top"><a id="idp94059216"></a><a id="idp94059472"></a><p><strong>21.6.14.1.</strong></p></td><td align="left" valign="top"><p>Нужно ли полностью перестраивать систему при каждом
	      изменении?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Простого ответа на этот вопрос нет, так как это зависит от
	      характера изменения.  Например, если вы только что выполнили
	      <span class="application">CVSup</span>, и оказалось, что с момента
	      последнего его запуска были изменены следующие файлы:</p><pre class="screen"><code class="filename">src/games/cribbage/instr.c</code>
<code class="filename">src/games/sail/pl_main.c</code>
<code class="filename">src/release/sysinstall/config.c</code>
<code class="filename">src/release/sysinstall/media.c</code>
<code class="filename">src/share/mk/bsd.port.mk</code></pre><p>то перестраивать всю систему незачем.  Вы можете просто
	      перейти в соответствующий подкаталог и выдать команду
	      <code class="command">make all install</code>, этого будет достаточно.
	      Однако, если меняется что-то важное, например,
	      <code class="filename">src/lib/libc/stdlib</code>, то вы должны
	      перестроить всю систему или по крайней мере те ее части, которые
	      скомпонованы статически.</p><p>В конце концов, выбор за вами.  Может быть вам нравится
	      перестраивать систему, скажем, каждый вечер, а изменения
	      скачивать ночью.  Или вы можете захотеть перестраивать только
	      те вещи, которые менялись, но быть уверенным, что отслежены все
	      изменения.</p><p>И, конечно же, всё это зависит от того, как часто вы хотите
	      делать обновление, и отслеживаете ли вы FreeBSD-STABLE или
	      FreeBSD-CURRENT.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp94065744"></a><a id="idp94066000"></a><p><strong>21.6.14.2.</strong></p></td><td align="left" valign="top"><p>Компиляция прерывается с большим количеством ошибок по
	      сигналу 11<a id="idp94066640" class="indexterm"></a>
	      (или с другим номером сигнала).  Что
	      случилось?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Как правило, это говорит о проблемах с оборудованием.
	      (Пере)построение системы является эффективным стресс-тестом для
	      вашего оборудования и частенько выявляет проблемы с памятью.
	      Обычно это проявляется в виде неожиданных сбоев компилятора
	      или получения странных программных сигналов.</p><p>Явным указателем на это является то, что при перезапуске
	      процедуры построения она прекращается в различные моменты
	      времени.</p><p>В этом случае вы мало что можете сделать, разве что
	      попробовать заменить комплектующие вашей машины для определения
	      сбоящей компоненты.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp94069072"></a><a id="idp94089936"></a><p><strong>21.6.14.3.</strong></p></td><td align="left" valign="top"><p>Могу ли я удалить каталог <code class="filename">/usr/obj</code>
	      после окончания?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Если отвечать коротко, то да.</p><p>Каталог <code class="filename">/usr/obj</code> содержит все
	      объектные файлы, которые создаются во время фазы компиляции.
	      Обычно одним из первых шагов в процессе <code class="command">make buildworld</code>
	      является удаление этого каталога.  В этом случае сохранение
	      <code class="filename">/usr/obj</code> после окончания имеет мало смысла;
	      вдобавок, он будет занимать большой объём дискового
	      пространства (на данный момент около 340 МБ).</p><p>Однако если вы точно знаете, что делаете, то можете заставить
	      процедуру <code class="command">make buildworld</code> пропустить этот шаг.  Это
	      позволит последующие построения выполняться гораздо быстрее, так
	      как большинство исходных текстов не нужно будет
	      перекомпилировать.  Оборотной стороной медали этого подхода
	      является вероятность появления некоторых проблем с зависимостями,
	      что может привести к прерыванию построения по странным причинам.
	      Это частенько вызывает шум в списках рассылки FreeBSD, когда
	      кто-либо жалуется на прерывание процесса построения, не обращая
	      внимания на то, что он пытается срезать углы на
	      повороте.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp94094288"></a><a id="idp94094544"></a><p><strong>21.6.14.4.</strong></p></td><td align="left" valign="top"><p>Могут ли быть продолжены прерванные процессы
	      построения?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Это зависит от того, насколько далеко зашел процесс
	      построения перед тем, как вы обнаружили проблему.</p><p><span class="emphasis"><em>В общем случае</em></span> (и это несложное и
	      быстрое правило) процесс <code class="command">make buildworld</code> строит
	      новые копии необходимых инструментальных средств (таких, как
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gcc&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">gcc</span>(1)</span></a> и <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>) и системные библиотеки.  Затем эти
	      средства и библиотеки устанавливаются.  Новые инструментальные
	      средства и библиотеки затем используются для перестроения
	      самих себя, и повторно устанавливаются.  Система в целом
	      (теперь включая обычные пользовательские программы, такие,
	      как <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ls&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ls</span>(1)</span></a> или <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=grep&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">grep</span>(1)</span></a>) теперь перестраивается с
	      новыми системными файлами.</p><p>Если вы на последнем шаге, и вы знаете это (потому что
	      просматривали вывод, который сохраняете), то вы можете
	      (достаточно безболезненно) выполнить команду:</p><pre class="screen"><span class="emphasis"><em>... исправление проблемы ...</em></span>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make -DNO_CLEAN all</code></strong></pre><p>При этом результат предыдущего запуска
	      <code class="command">make buildworld</code> откатываться не будет.</p><p>Если вы видите сообщение:</p><pre class="screen">--------------------------------------------------------------
Building everything..
--------------------------------------------------------------</pre><p>в выводе команды <code class="command">make buildworld</code>, то делать так
	      достаточно безопасно.</p><p>Если этого сообщения не было, или вы в этом не уверены, то
	      всегда лучше обезопасить себя, и начать построение с самого
	      начала.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp94109776"></a><a id="idp94110032"></a><p><strong>21.6.14.5.</strong></p></td><td align="left" valign="top"><p>Как ускорить процесс построения системы?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Работайте в однопользовательском режиме.</p></li><li class="listitem"><p>Разместите каталоги <code class="filename">/usr/src</code> и
		  <code class="filename">/usr/obj</code> в отдельных файловых
		  системах, располагающихся на разных дисках.  Если это
		  возможно, то разместите эти диски на разных дисковых
		  контроллерах.</p></li><li class="listitem"><p>Ещё лучше разместить эти файловые системы на нескольких
		  дисках при помощи устройства <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> (драйвер
		  объединённых дисков).</p></li><li class="listitem"><p>Выключите генерацию профилирующего кода (установив
		  <span class="quote"><<<span class="quote">NO_PROFILE=true</span>>></span> в файле
		  <code class="filename">/etc/make.conf</code>).  Вам это скорее
		  всего никогда не понадобится.</p></li><li class="listitem"><p>Также в <code class="filename">/etc/make.conf</code> установите
		  значение <code class="varname">CFLAGS</code> во что-то типа <code class="option">-O
		  -pipe</code>.  Оптимизация <code class="option">-O2</code> выполняется
		  гораздо медленнее, а разница между <code class="option">-O</code> и
		  <code class="option">-O2</code> обычно несущественна.
		  <code class="option">-pipe</code> позволяет компилятору использовать для
		  связи вместо временных файлов программные каналы, что
		  уменьшает обращение к диску (за счет оперативной
		  памяти).</p></li><li class="listitem"><p>Передайте утилите <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> параметр
		  <code class="option">-j<em class="replaceable"><code>n</code></em></code> для запуска
		  параллельно нескольких процессов.  Обычно это помогает вне
		  зависимости от того, сколько процессоров установлено в вашей
		  машине.</p></li><li class="listitem"><p>Файловая система, на которой располагается каталог
		  <code class="filename">/usr/src</code>, может быть смонтирована (или
		  перемонтирована) с опцией <code class="option">noatime</code>.  При этом
		  запись на диск информации о времени последнего доступа к
		  файлам будет отключена.  Скорее всего, вам эта информация и
		  не нужна.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -u -o noatime /usr/src</code></strong></pre><div xmlns="" class="warning"><h3 class="admontitle">Предупреждение: </h3><p xmlns="http://www.w3.org/1999/xhtml">В примере предполагается, что
		    <code class="filename">/usr/src</code> располагается на
		    собственной файловой системе.  Если это не так (то
		    есть он является частью, скажем,
		    <code class="filename">/usr</code>), то вам нужно использовать
		    точку монтирования той файловой системы, а не
		    <code class="filename">/usr/src</code>.</p></div></li><li class="listitem"><p>Файловая система, на которой располагается
		  <code class="filename">/usr/obj</code>, может быть смонтирована (или
		  перемонтирована) с параметром <code class="option">async</code>.  Это
		  приведёт к тому, что операции записи на диск будут
		  выполняться асинхронно.  Другими словами, запись будет
		  завершаться немедленно, но данные записываться на диск
		  несколькими секундами позже.  Это позволит объединять
		  операции записи и приведёт к значительному приросту
		  производительности.</p><div xmlns="" class="warning"><h3 class="admontitle">Предупреждение: </h3><p xmlns="http://www.w3.org/1999/xhtml">Имейте в виду, что эта опция делает вашу файловую
		    систему менее устойчивой.  С этой опцией имеется больше
		    шансов, что при перезагрузке машины после неожиданного
		    сбоя при пропадании напряжения файловая система окажется
		    в невосстановимом состоянии.</p><p xmlns="http://www.w3.org/1999/xhtml">Если каталог <code class="filename">/usr/obj</code> - это все,
		    что есть в этой файловой системе, то это не проблема.
		    Если на той же самой файловой системе имеются какие-то
		    важные данные, то проверьте давность ваших резервных
		    копий перед включением этой опции.</p></div><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -u -o async /usr/obj</code></strong></pre><div xmlns="" class="warning"><h3 class="admontitle">Предупреждение: </h3><p xmlns="http://www.w3.org/1999/xhtml">Как и раньше, если каталог
		    <code class="filename">/usr/obj</code> располагается не на
		    собственной файловой системе, то в примере замените его
		    на имя соответствующей точки монтирования.</p></div></li></ul></div></td></tr><tr class="question"><td align="left" valign="top"><a id="idp94140880"></a><a id="idp94141136"></a><p><strong>21.6.14.6.</strong></p></td><td align="left" valign="top"><p>Что мне делать, если что-то пошло не так?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Скрупулезно проверьте, чтобы в вашем окружении не было
	      мешающих остатков от предыдущих построений.  Это достаточно
	      просто.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chflags -R noschg /usr/obj/usr</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>rm -rf /usr/obj/usr</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make cleandir</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make cleandir</code></strong></pre><p>Да, команду <code class="command">make cleandir</code> действительно
	      нужно выполнять дважды.</p><p>После этого повторите весь процесс снова, начиная с
	      <code class="command">make buildworld</code>.</p><p>Если у вас все еще есть проблемы, пришлите текст ошибки и
	      выдачу команды <code class="command">uname -a</code> на адрес списка рассылки
	      <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions" target="_top">freebsd-questions</a>.  Будьте готовы ответить на другие вопросы о
	      конфигурации вашей системы!</p></td></tr></tbody></table></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="synching.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="updating-upgrading.html">Наверх</a></td><td width="40%" align="right"> <a accesskey="n" href="small-lan.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">21.5. Синхронизация ваших исходных текстов </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> 21.7. Отслеживание исходных текстов для нескольких машин</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>