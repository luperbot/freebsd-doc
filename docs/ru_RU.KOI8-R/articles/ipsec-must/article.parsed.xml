<?xml version="1.0" encoding="koi8-r"?>
<!--
     The FreeBSD Russian Documentation Project

     $FreeBSD$
     $FreeBSDru: frdp/doc/ru_RU.KOI8-R/articles/ipsec-must/article.xml,v 1.7 2004/07/16 12:06:05 den Exp $

     Original revision: r44703
-->
<article xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:lang="ru">
  <info><title xmlns:xlink="http://www.w3.org/1999/xlink">Независимое исследование работы IPsec во FreeBSD</title>
    

    <author xmlns:xlink="http://www.w3.org/1999/xlink"><personname xmlns:xlink="http://www.w3.org/1999/xlink"><firstname xmlns:xlink="http://www.w3.org/1999/xlink">David</firstname><surname xmlns:xlink="http://www.w3.org/1999/xlink">Honig</surname></personname><affiliation xmlns:xlink="http://www.w3.org/1999/xlink">
	<address xmlns:xlink="http://www.w3.org/1999/xlink"><email xmlns:xlink="http://www.w3.org/1999/xlink">honig@sprynet.com</email></address>
      </affiliation></author>

    <pubdate xmlns:xlink="http://www.w3.org/1999/xlink">1999-05-03</pubdate>

    <legalnotice xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="trademarks" role="trademarks">
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">FreeBSD это зарегистрированная торговая
  марка FreeBSD Foundation.</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">Motif, OSF/1 и UNIX это
  зарегистрированные торговые марки, а IT DialTone и The Open Group это
  торговые марки Open Group в Соединенных Штатах и других
  странах.</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">Многие из обозначений, используемые
  производителями и продавцами для обозначения своих продуктов, заявляются
  в качестве торговых марок.  Когда такие обозначения появляются в этом
  документе, и Проекту FreeBSD известно о торговой марке, к обозначению
  добавляется знак <quote xmlns:xlink="http://www.w3.org/1999/xlink">TM</quote> или
  <quote xmlns:xlink="http://www.w3.org/1999/xlink">(R)</quote>.</para>
    </legalnotice>

    <releaseinfo xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</releaseinfo>

    <abstract xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">Вы только что установили и настроили IPsec, и оно,
	кажется, заработало.  Как это можно проверить?  Я опишу метод
	экспериментальной проверки правильного функционирования
	IPsec.</para>
    </abstract>
  </info>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="problem">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Постановка задачи</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Для начала предположим, что Вы <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="ipsec-install">
      настроили <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">IPsec</emphasis></link>.  Как Вы
      узнаете, что IPsec <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="caveat">работает</link>?
      Несомненно, соединения не будет, если Вы неверно его
      сконфигурировали.  И оно, конечно, появится в выводе команды
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">netstat</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>, когда Вы всё сделаете верно.  Но можно ли
      как-то подтвердить сам факт функционирования IPsec?</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="solution">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Решение</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Для начала немножко криптографической теории:</para>

    <orderedlist xmlns:xlink="http://www.w3.org/1999/xlink">
      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Шифрованные данные равномерно распределены по области
	  определения, то есть каждый символ имеет максимальную
	  энтропию;</para>
      </listitem>

      <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink"><quote xmlns:xlink="http://www.w3.org/1999/xlink">Сырые</quote> и несжатые данные как правило
	  избыточны, то есть их энтропия меньше максимально
	  возможной.</para>
      </listitem>
    </orderedlist>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Предположим, что у Вас имеется возможность измерить энтропию
      входящего и исходящего трафика на сетевом интерфейсе.  В этом
      случае Вы сможете легко отличить зашифрованные данные от
      открытых, причём даже в том случае, когда часть данных в
      <quote xmlns:xlink="http://www.w3.org/1999/xlink">режиме шифрования</quote> передаётся в открытом виде, к
      примеру внешние заголовки IP, которые используются для
      маршрутизации.</para>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="MUST">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">MUST</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink"><quote xmlns:xlink="http://www.w3.org/1999/xlink">Универсальный Статистический Тест для Генераторов
	Случайных Чисел</quote> Уэли Маурера (Ueli Maurer's Universal
	Statistical Test for Random Bit Generators), сокращённо <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.geocities.com/SiliconValley/Code/4704/universal.pdf">
	<acronym xmlns:xlink="http://www.w3.org/1999/xlink">MUST</acronym></link> позволяет быстро измерить
	энтропию последовательного набора данных.  Используемый
	алгоритм похож на алгоритм сжатия.  <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="code">В
	приложении</link> приведён исходный код, позволяющий измерять
	энтропию последовательных кусков данных размером около
	четверти мегабайта.</para>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="tcpdump">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Tcpdump</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Ещё нам нужен способ сохранения информации,
	проходящей через интерфейс.  Программа <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">tcpdump</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>
	позволяет сделать это в случае, если Вы <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="kernel">сконфигурировали своё ядро</link> с
	поддержкой <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">Пакетного Фильтра Беркли (Berkeley Packet
	Filter)</emphasis>.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Команда</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><userinput xmlns:xlink="http://www.w3.org/1999/xlink">tcpdump -c 4000 -s 10000 -w <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">dumpfile.bin</replaceable></userinput></screen>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">сохранит 4000 пакетов в файл
	<replaceable xmlns:xlink="http://www.w3.org/1999/xlink">dumpfile.bin</replaceable>.  В данном примере объём
	записываемой информации в каждом пакете не может превышать
	10,000 байтов.</para>
    </sect2>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="experiment">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Эксперимент</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Повторите следующие шаги эксперимента:</para>

    <procedure xmlns:xlink="http://www.w3.org/1999/xlink">
      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Откройте два окна терминала и свяжитесь в одном из них с
	  каким-нибудь компьютером через канал IPsec, а в другом - с
	  обычным, <quote xmlns:xlink="http://www.w3.org/1999/xlink">незащищённым</quote> компьютером.</para>
      </step>

      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Теперь начните <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="tcpdump">сохранять
	  пакеты</link>.</para>
      </step>

      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">В <quote xmlns:xlink="http://www.w3.org/1999/xlink">шифрованном</quote> окне запустите команду <trademark xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" class="registered">UNIX</trademark>
	  <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">yes</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>, которая будет выдавать бесконечный
	  поток символов <literal xmlns:xlink="http://www.w3.org/1999/xlink">y</literal>.  Немножко подождите и
	  завершите её.  Затем переключитесь в обычное окно (не
	  использующее канал IPsec) и сделайте то же самое.</para>
      </step>

      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Заключительный этап: запустите <link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="code">
	    MUST</link>, передав ему для обработки только что
	  сохранённые пакеты через командную строку.  Вы должны
	  увидеть что-то вроде изображённого чуть ниже.  Заметьте, что
	  безопасное соединение имеет 93% (6,7) от ожидаемого значения
	  (7,18), а обычное соединение - всего лишь 29%
	  (2,1).</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">%</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">tcpdump -c 4000 -s 10000 -w <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">ipsecdemo.bin</replaceable></userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">%</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">uliscan <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">ipsecdemo.bin</replaceable></userinput>

Uliscan 21 Dec 98
L=8 256 258560
Measuring file ipsecdemo.bin
Init done
Expected value for L=8 is 7.1836656
6.9396 --------------------------------------------------------
6.6177 -----------------------------------------------------
6.4100 ---------------------------------------------------
2.1101 -----------------
2.0838 -----------------
2.0983 -----------------</screen>
      </step>
    </procedure>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="caveat">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Замечание</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Этот эксперимент показывает, что IPsec
      <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">действительно</emphasis> распределяет передаваемые
      байты по области определения <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">равномерно</emphasis>,
      как и любое другое шифрование.  Однако этот метод <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">не
      может</emphasis> обнаружить множество других изъянов в системе
      (хотя я таковых не знаю).  Для примера можно привести плохие
      алгоритмы генерации или обмена ключами, нарушение
      конфиденциальности данных или ключей, использование слабых в
      криптографическом смысле алгоритмов, взлом ядра и т. д.  Изучайте
      исходный код, узнавайте, что там происходит.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="IPsec">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Определение IPsec</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">IPsec представляет собой протокол безопасного обмена
      информацией по Internet.  Существует в виде расширения к IPv4;
      является неотъемлемой частью IPv6.  Содержит в себе протокол
      шифрования и аутентификации на уровне IP (межмашинное
      <quote xmlns:xlink="http://www.w3.org/1999/xlink">host-to-host</quote> взаимодействие).  SSL защищает
      только лишь конкретный прикладной сокет;
      <application xmlns:xlink="http://www.w3.org/1999/xlink">SSH</application> защищает вход на машину;
      <application xmlns:xlink="http://www.w3.org/1999/xlink">PGP</application> защищает определённый файл или
      письмо.  IPsec шифрует всю информацию, передаваемую между двумя
      машинами.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="ipsec-install">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Установка IPsec</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Большинство современных версий FreeBSD уже имеют поддержку
      IPsec.  Вероятно, Вы должны будете лишь добавить опцию
      <option xmlns:xlink="http://www.w3.org/1999/xlink">IPsec</option> в конфигурационный файл ядра, и после
      сборки и инсталляции нового ядра, сконфигурировать соединение
      IPsec с помощью команды <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">setkey</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Более подробно о том, как запустить IPsec во FreeBSD можно
      прочесть в <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="../../../../doc/ru_RU.KOI8-R/books/handbook/ipsec.html">Руководстве
      пользователя</link>.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="kernel">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">src/sys/i386/conf/KERNELNAME</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Для того, чтобы захватывать сетевой трафик при помощи
      <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">tcpdump</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>, следующие строки должны присутствовать
      в конфигурационном файле ядра.  Не
      забудьте после модификации запустить <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">config</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>, и, как
      обычно, пересобрать и установить новое ядро.</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">device	bpf</programlisting>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="code">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Универсальный Статистический Тест Маурера (размер блока
      - 8 бит)</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Оригинал нижеприведённого кода находится по <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.geocities.com/SiliconValley/Code/4704/uliscanc.txt">
        этому адресу</link>.</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">/*
  ULISCAN.c   ---blocksize of 8

  1 Oct 98
  1 Dec 98
  21 Dec 98       uliscan.c derived from ueli8.c

  This version has // comments removed for Sun cc

  This implements Ueli M Maurer's "Universal Statistical Test for Random
  Bit Generators" using L=8

  Accepts a filename on the command line; writes its results, with other
  info, to stdout.

  Handles input file exhaustion gracefully.

  Ref: J. Cryptology v 5 no 2, 1992 pp 89-105
  also on the web somewhere, which is where I found it.

  -David Honig
  honig@sprynet.com

  Usage:
  ULISCAN filename
  outputs to stdout
*/

#define L 8
#define V (1&lt;&lt;L)
#define Q (10*V)
#define K (100   *Q)
#define MAXSAMP (Q + K)

#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

int main(argc, argv)
int argc;
char **argv;
{
  FILE *fptr;
  int i,j;
  int b, c;
  int table[V];
  double sum = 0.0;
  int iproduct = 1;
  int run;

  extern double   log(/* double x */);

  printf("Uliscan 21 Dec 98 \nL=%d %d %d \n", L, V, MAXSAMP);

  if (argc &lt; 2) {
    printf("Usage: Uliscan filename\n");
    exit(-1);
  } else {
    printf("Measuring file %s\n", argv[1]);
  }

  fptr = fopen(argv[1],"rb");

  if (fptr == NULL) {
    printf("Can't find %s\n", argv[1]);
    exit(-1);
  }

  for (i = 0; i &lt; V; i++) {
    table[i] = 0;
  }

  for (i = 0; i &lt; Q; i++) {
    b = fgetc(fptr);
    table[b] = i;
  }

  printf("Init done\n");

  printf("Expected value for L=8 is 7.1836656\n");

  run = 1;

  while (run) {
    sum = 0.0;
    iproduct = 1;

    if (run)
      for (i = Q; run &amp;&amp; i &lt; Q + K; i++) {
        j = i;
        b = fgetc(fptr);

        if (b &lt; 0)
          run = 0;

        if (run) {
          if (table[b] &gt; j)
            j += K;

          sum += log((double)(j-table[b]));

          table[b] = i;
        }
      }

    if (!run)
      printf("Premature end of file; read %d blocks.\n", i - Q);

    sum = (sum/((double)(i - Q))) /  log(2.0);
    printf("%4.4f ", sum);

    for (i = 0; i &lt; (int)(sum*8.0 + 0.50); i++)
      printf("-");

    printf("\n");

    /* refill initial table */
    if (0) {
      for (i = 0; i &lt; Q; i++) {
        b = fgetc(fptr);
        if (b &lt; 0) {
          run = 0;
        } else {
          table[b] = i;
        }
      }
    }
  }
}</programlisting>
  </sect1>
</article>
