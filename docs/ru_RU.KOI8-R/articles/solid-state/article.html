<?xml version="1.0" encoding="koi8-r"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>FreeBSD и твердотельные устройства</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><meta name="description" content="В этой статье описывается использование твердотельных дисковых устройств для создания встраиваемых систем на основе FreeBSD Встраиваемые системы имеют преимущество в повышенной надежности по причине отсутствия в них движущихся частей (жестких дисков). Однако, следует принять во внимание, что системе, как правило, доступно очень малое дисковое пространство и ограниченный объем запоминающего устройства. К отдельно рассматриваемым вопросам относятся типы и характеристики твердотельных носителей, подходящих для использования в качестве дисков во FreeBSD, параметры ядра, которые представляют интерес в таких условиях, механизмы rc.initdiskless, автоматизирующие инициализацию таких систем и удовлетворяющие требованиям файловых систем, доступных только для чтения, а также построение файловых систем с нуля. Статья заканчивается описанием некоторых общих стратегий для случаев малых систем FreeBSD и работ в режиме только для чтения." /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div xml:lang="ru" class="article" lang="ru"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp69385040"></a>FreeBSD и твердотельные устройства</h1></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="surname">Kozubik</span></h3><div class="affiliation"><div class="address"><p><code class="email">&lt;<a xmlns="" class="email" href="mailto:john@kozubik.com">john@kozubik.com</a>&gt;</code></p></div></div></div></div></div><div>Издание: <a href="https://svnweb.freebsd.org/changeset/doc/"><span class="svnref"></span></a></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">Авторские права © 2001, 2009 The FreeBSD Documentation Project</p></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="trademarks"></a><p>FreeBSD это зарегистрированная торговая
  марка FreeBSD Foundation.</p><p>Многие из обозначений, используемые
  производителями и продавцами для обозначения своих продуктов, заявляются
  в качестве торговых марок.  Когда такие обозначения появляются в этом
  документе, и Проекту FreeBSD известно о торговой марке, к обозначению
  добавляется знак <span class="quote"><<<span class="quote">TM</span>>></span> или
  <span class="quote"><<<span class="quote">(R)</span>>></span>.</p></div></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="legalnotice"></a><p>Распространение и использование исходных (SGML DocBook) и
    <span class="quote"><<<span class="quote">скомпилированных</span>>></span> форм (SGML, HTML, PDF, PostScript,
    RTF и прочих)
    с модификацией или без оной, разрешены при соблюдении следующих
    соглашений:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Распространяемые копии исходного кода (SGML DocBook) должны
        сохранять вышеупомянутые объявления copyright, этот список
	положений и следующий отказ от ответственности в первых строках
	этого файла в неизменном виде.</p></li><li class="listitem"><p>Распространяемые копии скомпилированных форм (преобразованные в
        другие DTD, конвертированные в PDF, PostScript, RTF и другие форматы)
	должны повторять вышеупомянутые объявления copyright, этот список
	положений и следующий отказ от ответственности в документации
	и/или других материалах, поставляемых с дистрибьюцией.</p></li></ol></div><div xmlns="" class="important"><h3 class="admontitle">Важно: </h3><p xmlns="http://www.w3.org/1999/xhtml">ЭТА ДОКУМЕНТАЦИЯ ПОСТАВЛЯЕТСЯ ПРОЕКТОМ ДОКУМЕНТАЦИИ FREEBSD
      "КАК ЕСТЬ" И ЛЮБЫЕ ЯВНЫЕ ИЛИ НЕЯВНЫЕ ГАРАНТИИ, ВКЛЮЧАЯ, НО НЕ
      ОГРАНИЧИВАЯСЬ НЕЯВНЫМИ ГАРАНТИЯМИ, КОММЕРЧЕСКОЙ ЦЕННОСТИ И ПРИГОДНОСТИ
      ДЛЯ КОНКРЕТНОЙ ЦЕЛИ ОТРИЦАЮТСЯ. НИ ПРИ КАКИХ УСЛОВИЯХ ПРОЕКТ
      ДОКУМЕНТИРОВАНИЯ FREEBSD НЕ НЕСЕТ ОТВЕТСТВЕННОСТИ ЗА ЛЮБОЙ ПРЯМОЙ, КОСВЕННЫЙ,
      СЛУЧАЙНЫЙ, СПЕЦИАЛЬНЫЙ, ОБРАЗЦОВЫЙ ИЛИ ПОСЛЕДУЮЩИЙ УЩЕРБЫ (ВКЛЮЧАЯ,
      НО НЕ ОГРАНИЧИВАЯСЬ ПОСТАВКОЙ ТОВАРОВ ЗАМЕНЫ ИЛИ УСЛУГ; ПОТЕРЮ ДАННЫХ
      ИЛИ ИХ НЕПРАВИЛЬНУЮ ПЕРЕДАЧУ ИЛИ ПОТЕРИ; ПРИОСТАНОВЛЕНИЕ БИЗНЕСА),
      И ТЕМ НЕ МЕНЕЕ ВЫЗВАННЫЕ И В ЛЮБОЙ ТЕОРИИ ОТВЕТСТВЕННОСТИ,
      НЕЗАВИСИМО ОТ КОНТРАКТНОЙ, СТРОГОЙ ОТВЕТСТВЕННОСТИ, ИЛИ
      ПРАВОНАРУШЕНИИ (ВКЛЮЧАЯ ХАЛАТНОСТЬ ИЛИ ИНЫМ СПОСОБОМ), ВОЗНИКШЕМ
      ЛЮБЫМ ПУТЕМ ПРИ ИСПОЛЬЗОВАНИИ ЭТОЙ ДОКУМЕНТАЦИИ, ДАЖЕ ЕСЛИ
      БЫ БЫЛО СООБЩЕНО О ВОЗМОЖНОСТИ ТАКОГО УЩЕРБА.</p></div></div></div><div>    .</div><div><div xmlns="http://www.w3.org/1999/xhtml" class="abstract"><div class="abstract-title">Аннотация</div><p>В этой статье описывается использование твердотельных дисковых
	устройств для создания встраиваемых систем на основе FreeBSD</p><p>Встраиваемые системы имеют преимущество в повышенной надежности
	по причине отсутствия в них движущихся частей (жестких дисков).
	Однако, следует принять во внимание, что системе, как правило, доступно
	очень малое дисковое пространство и ограниченный объем запоминающего
	устройства.</p><p>К отдельно рассматриваемым вопросам относятся типы и характеристики
	твердотельных носителей, подходящих для использования в качестве дисков
	во FreeBSD, параметры ядра, которые представляют интерес в таких условиях,
	механизмы <code class="filename">rc.initdiskless</code>, автоматизирующие
	инициализацию таких систем и удовлетворяющие требованиям файловых
	систем, доступных только для чтения, а также построение файловых систем
	с нуля.  Статья заканчивается описанием некоторых общих стратегий для
	случаев малых систем FreeBSD и работ в режиме только для чтения.</p></div></div></div><hr /></div><div class="toc"><div class="toc-title">Содержание</div><dl class="toc"><dt><span class="sect1"><a href="#intro">1. Твердотельные дисковые устройства</a></span></dt><dt><span class="sect1"><a href="#kernel">2. Параметры ядра</a></span></dt><dt><span class="sect1"><a href="#ro-fs">3. Подсистема <code class="literal">rc</code> и файловые системы в режиме только
      чтения</a></span></dt><dt><span class="sect1"><a href="#idp69891920">4. Создание файловой системы с нуля</a></span></dt><dt><span class="sect1"><a href="#strategies">5. Стратегии работы с системой для случаев небольших и доступных
      только для чтения файловых систем</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="intro"></a>1. Твердотельные дисковые устройства</h2></div></div></div><p>Эта статья будет ограничиваться рассмотрением твердотельных дисковых
      устройств, которые делаются на основе флэш-памяти.  Флэш-память является
      твердотельным (здесь нет движущихся частей) запоминающим устройством,
      которое является энергонезависимым (данные остаются в памяти даже после
      отключения всех источников питания).  Флэш-память может быть
      нечувствительной к сильным физическим воздействиям и достаточно быстра
      (решения на основе флэш-памяти, описываемые в этой статье, гораздо
      медленнее, чем диски EIDE для операций записи, и гораздо быстрее их в
      случае выполнения операций чтения).  Одним из очень важных свойств
      флэш-памяти, различные варианты которого будут рассмотрены далее в этой
      статье, является то, что каждый сектор имеет ограниченные возможности по
      перезаписыванию.  Вы можете только записывать, стирать и снова записывать
      на сектор флэш-памяти определенное количество раз до того, как сектор
      станет полностью неработоспособным.  Хотя многие продукты на основе
      флэш-памяти автоматически перенаправляют испорченные блоки, а некоторые
      даже распределяют операции записи по всему модулю, фактом является
      наличие ограничения на количество операций записи, которые могут
      выполняться с устройством.  Современные модули имеют характеристики от
      1,000,000 до 10,000,000 циклов записи на сектор.  Эти характеристики
      могут зависеть от температуры рабочей среды.</p><p>В частности, мы обсудим компактные модули флэш-памяти, совместимые со
      стандартом ATA, которые стали весьма популярными в качестве носителя
      данных для цифровых камер.  Особый интерес представляет тот факт, что они
      соответствуют шине IDE по контактам и совместимы с набором команд ATA.
      Таким образом, при помощи очень простого и дешевого адаптера такие
      устройства могут подключаться непосредственно к шине IDE компьютера.
      Если поступить таким образом, то такие операционные системы, как FreeBSD,
      распознают диск как обычный винчестер (весьма маленький).</p><p>Существуют и другие решения для твердотельных дисков, но их
      стоимость, безвестность и сравнительная сложность использования выводят
      их за рамки этой статьи.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kernel"></a>2. Параметры ядра</h2></div></div></div><p>Для тех, кто создает встраиваемую систему FreeBSD, интерес
      представляют несколько параметров ядра.</p><p>Все встраиваемые системы FreeBSD, которые используют
      флэш-память в качестве системного диска, заинтересованы в использовании
      дисков в памяти и файловых систем в памяти.  Из-за ограниченного
      количества циклов записи, которые можно выполнить с флэш-памятью, диск
      и файловые системы на нем будут, скорее всего, монтироваться в режиме
      доступа только для чтения.  В таком случае файловые системы типа
      <code class="filename">/tmp</code> и <code class="filename">/var</code> монтируются как
      файловые системы в памяти для того, чтобы позволить системе создать
      журналы и обновить счетчики и временные файлы.  Файловые системы в памяти
      являются критическим компонентом успешной работы FreeBSD на твердотельных
      устройствах.</p><p>Вы должны удостовериться, что в конфигурационном файле вашего ядра
      присутствуют следующие строки:</p><pre class="programlisting">options         MFS             # Memory Filesystem
options         MD_ROOT         # md device usable as a potential root device
pseudo-device   md              # memory disk</pre></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="ro-fs"></a>3. Подсистема <code class="literal">rc</code> и файловые системы в режиме только
      чтения</h2></div></div></div><p>Инициализация встраиваемой системы FreeBSD после загрузки управляется
      <code class="filename">/etc/rc.initdiskless</code>.</p><p><code class="filename">/etc/rc.d/var</code> монтирует
      <code class="filename">/var</code> как файловую систему в памяти, создает
      указываемый список каталогов в <code class="filename">/var</code> при помощи
      команды <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mkdir&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">mkdir</span>(1)</span></a>, изменяет режимы доступа на некоторые из этих
      каталогов.  В процессе выполнения
      <code class="filename">/etc/rc.d/var</code> задействуется еще одна переменная
      <code class="filename">rc.conf</code> - <code class="literal">varsize</code>.  Скрипт
      <code class="filename">/etc/rc.d/var</code> создает раздел
      <code class="filename">/var</code> на основе значения этой переменной из
      <code class="filename">rc.conf</code>:</p><pre class="programlisting">varsize=8192</pre><p>Запомните, что по умолчанию это значение указано в секторах.</p><p>Факт использования файловой системы <code class="filename">/var</code>
      в режиме чтения и записи является
      важным признаком, так как раздел <code class="filename">/</code> (и любые другие
      разделы, которые могут находиться на флэш-носителе) должен монтироваться
      в режиме только для чтения.  Вспомните, что в <a class="xref" href="#intro" title="1. Твердотельные дисковые устройства">Раздел 1, <<Твердотельные дисковые устройства>></a> мы
      касались ограничений флэш-памяти - особенно ограничений, касающихся
      возможностей записи.  Важно не монтировать файловые системы на
      флэш-носителях в режимах чтения и записи, и важность отказа от файла
      подкачки не может быть переоценена.  Файл подкачки на загруженной системе
      может пережечь кусок флэш-носителя менее чем за год.  Частое
      журналирование и создание временных файлов приводят к тому же результату.
      Поэтому, кроме удаления записи <code class="literal">swap</code> из вашего файла
      <code class="filename">/etc/fstab</code>, вы должны также изменить поле параметров
      каждой файловой системы на <code class="literal">ro</code> таким образом:</p><pre class="programlisting"># Device                Mountpoint      FStype  Options         Dump    Pass#
/dev/ad0s1a             /               ufs     ro              1       1</pre><p>В результате этих изменений в среднестатистической системе несколько
      приложений немедленно перестанут работать.  Например,  cron не будет
      нормально запускаться в результате отсутствия таблиц для него в каталоге
      <code class="filename">/var</code>, созданном <code class="filename">/etc/rc.d/var</code>,
      а syslog и dhcp будут испытывать проблемы из-за доступа файловой системы
      только для чтения, а также отсутствия записей в <code class="filename">/var</code>,
      который был создан скриптом <code class="filename">/etc/rc.d/var</code>.  Хотя эти
      проблемы являются временными и обсуждаются вместе с решением проблем
      с запуском распространенных программных пакетов, в <a class="xref" href="#strategies" title="5. Стратегии работы с системой для случаев небольших и доступных только для чтения файловых систем">Раздел 5, <<Стратегии работы с системой для случаев небольших и доступных
      только для чтения файловых систем>></a>.</p><p>Важно помнить, что файловая система, которая была смонтирована
      только для чтения при помощи файла <code class="filename">/etc/fstab</code>, в
      любой момент может быть сделана доступной по чтению и записи выдачей
      команды:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/sbin/mount -uw <em class="replaceable"><code>partition</code></em></code></strong></pre><p>и может быть возвращена к режиму доступа только для чтения по такой
      команде:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/sbin/mount -ur <em class="replaceable"><code>partition</code></em></code></strong></pre></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="idp69891920"></a>4. Создание файловой системы с нуля</h2></div></div></div><p>Так как совместимые с ATA компактные флэш-карты распознаются во FreeBSD
      как обычные жесткие диски IDE, то теоретически вы можете установить FreeBSD
      по сети при помощи дискет kern и mfsroot или с компакт-диска.</p><p>Однако даже маленькая установка FreeBSD при помощи обычных процедур
      установки может привести к созданию системы размером, превышающим 200
      мегабайт.  Так как большинство людей используют устройства флэш-памяти
      меньшего размера (128 мегабайт считается весьма большим - 32 или даже 16
      мегабайт используются гораздо чаще), то установка обычным образом не
      подходит-просто на диске нет места даже для самой минимальной
      установки.</p><p>Самым простым способом обойти это ограничение на объем является
      установка FreeBSD обычным образом на обычный жесткий диск.  После окончания
      установки, обрежьте операционную систему до размера, который помещается
      на ваш флэш-носитель, а затем полностью заархивируйте файловую систему.
      Следующие шаги поведут вас через процесс подготовки части флэш-памяти
      для вашей заархивированной файловой системы.  Запомните, что из-за того,
      что обычная установка не выполнялась, такие операции, как разбиение
      на разделы, разметка, создание файловой системы и так далее должны быть
      выполнены вручную.  Кроме дискет kern и mfsroot вам также нужно
      воспользоваться дискетой fixit.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Разбиение вашего флэш-носителя на разделы</strong></p><p>После загрузки при помощи дискет kern и mfsroot, выберите пункт
	  <code class="literal">custom</code> из меню установки.  Из следующего пункта
	  меню выберите <code class="literal">partition</code>.  В меню работы с
	  разделами вы должны удалить все существующие разделы при помощи
	  клавиши <span class="keycap"><strong>d</strong></span>.  После удаления всех имеющихся разделов
	  создайте раздел при помощи клавиши <span class="keycap"><strong>c</strong></span> и согласитесь
	  с предлагаемым по умолчанию размером раздела.  Когда вы будете
	  опрошены на предмет типа раздела, удостоверьтесь, что значение типа
	  равно <code class="literal">165</code>.  Теперь запишите эту таблицу разделов
	  на диск, нажав клавишу <span class="keycap"><strong>w</strong></span> (на этом экране эта опция
	  скрыта).  Если вы используете компактную флэш-карту, совместимую
	  с ATA, вы должны выбрать FreeBSD Boot Manager.  Теперь нажмите
	  клавишу <span class="keycap"><strong>q</strong></span> для выхода из меню работы с разделами.
	  Должно быть выдано еще раз меню для выбора менеджера загрузки -
	  повторите то, что вы выбирали ранее.</p></li><li class="step"><p class="title"><strong>Создание файловых систем на вашем устройстве флэш-памяти</strong></p><p>Выйдите из меню установки custom, и из главного меню установки
	  выберите пункт <code class="literal">fixit</code>.  После входа в режим работы
	  fixit, введите следующую команду:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>disklabel -e /dev/ad0c</code></strong></pre><p>В этот момент вы войдете в редактор vi из-под команды disklabel.
	  Затем, вам нужно добавить строку <code class="literal">a:</code> в конце файла.
	  Эта строка <code class="literal">a:</code> должна выглядеть примерно так:</p><pre class="programlisting">a:      <em class="replaceable"><code>123456</code></em>  0       4.2BSD  0       0</pre><p>Здесь <em class="replaceable"><code>123456</code></em> является числом, в
	  точности совпадающим с тем, что характеризует размер имеющейся записи
	  для <code class="literal">c:</code>.  В общем, вы копируете существующую
	  строку для <code class="literal">c:</code> для строки <code class="literal">a:</code>,
	  не забывая определить fstype как <code class="literal">4.2BSD</code>.
	  Сохраните файл и завершите редактирование.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>disklabel -B -r /dev/ad0c</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs /dev/ad0a</code></strong></pre></li><li class="step"><p class="title"><strong>Размещение вашей файловой системы на флэш-носителе</strong></p><p>Смонтируйте только что подготовленный флэш-носитель:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount /dev/ad0a /flash</code></strong></pre><p>Подключите эту машину к сети, чтобы можно было перенести наш
	  tar-файл и распаковать его в файловую систему на флэш-носителе.  Вот
	  пример того, как это можно сделать:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ifconfig xl0 192.168.0.10 netmask 255.255.255.0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>route add default 192.168.0.1</code></strong></pre><p>Теперь, когда машина находится в сети, перепишите ваш tar-файл.
	  Здесь вы можете столкнуться с некоторой проблемой - если объем вашей
	  флэш-памяти равен, к примеру, 128 мегабайтам, а ваш tar-файл
	  превышает 64 мегабайта, то вы не можете одновременно разместить
	  tar-файл на флэш-носителе и распаковать его - вам не хватит места.
	  Одним из решений этой проблемы, если вы используете FTP, является
	  распаковка файла во время его передачи по FTP.  Если вы передаете
	  файл именно так, то вы никогда не получите на диске одновременно
	  архивный файл и его содержимое:</p><pre class="screen"><code class="prompt">ftp&gt;</code> <strong class="userinput"><code>get tarfile.tar "| tar xvf -"</code></strong></pre><p>Если ваш файл обработан утилитой gzip, вы также можете этого
	  добиться:</p><pre class="screen"><code class="prompt">ftp&gt;</code> <strong class="userinput"><code>get tarfile.tar "| zcat | tar xvf -"</code></strong></pre><p>После того, как вы получили содержимое вашей заархивированной
	  файловой системы на файловой системе флэш-памяти, вы можете
	  размонтировать флэш-память и выполнить перезагрузку:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>umount /flash</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong></pre><p>Полагая, что вы правильно настроили вашу файловую систему при
	  ее построении на обычном диске (с вашей файловой системой,
	  смонтированной в режиме доступа только для чтения, и необходимыми
	  параметрами, присутствующими в ядре) вы должны успешно загрузить вашу
	  встраиваемую систему на основе FreeBSD.</p></li></ol></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="strategies"></a>5. Стратегии работы с системой для случаев небольших и доступных
      только для чтения файловых систем</h2></div></div></div><p>В <a class="xref" href="#ro-fs" title="3. Подсистема rc и файловые системы в режиме только чтения">Раздел 3, <<Подсистема <code class="literal">rc</code> и файловые системы в режиме только
      чтения>></a> было указано, что файловая система
      <code class="filename">/var</code>, создаваемая скриптом
      <code class="filename">/etc/rc.d/var</code>, и наличие корневой файловой
      системы, доступной только для чтения, приводят к проблемам при работе
      многих распространенных программных пакетов, используемых во FreeBSD.
      В этой статье будут даны рекомендации по настройке нормальной работы
      cron и syslog, установке портов и веб-сервера Apache.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp69985872"></a>5.1. cron</h3></div></div></div><p>Во время загрузки содержимое каталогa
	<code class="filename">/var</code> формируется скриптом
	<code class="filename">/etc/rc.d/var</code> используя данные из
	<code class="filename">/etc/mtree/BSD.var.dist</code>, поэтому в нем создается
	несколько стандартных каталогов, в числе которых -
	<code class="filename">cron</code>,
	<code class="filename">cron/tabs</code>,
	<code class="filename">at</code>.</p><p>Однако это не решает проблему с сохранением cron-таблиц
	между перезагрузками.  Когда система перезагружается, то файловая
	система	<code class="filename">/var</code>, которая располагается в памяти,
	будет уничтожена, вместе со всеми cron-таблицами, которые вы могли там
	иметь.  Поэтому одним из решений может стать создание cron-таблиц для
	пользователей, которым они нужны, монтирование вашей файловой системы
	<code class="filename">/</code> в режиме чтения и записи, и копирование этих
	cron-таблиц в безопасное место, например,
	в <code class="filename">/etc/tabs</code>, и последующее добавление строки в
	конец скрипта <code class="filename">/etc/rc.initdiskless</code> для копирования
	этих cron-таблиц в каталог <code class="filename">/var/cron/tabs</code> после
	его создания во время инициализации системы.  Вам может также
	потребоваться добавить строку, которая изменяет режимы доступа и
	права на каталоги, которые вы создали, и на файлы, которые вы
	скопировали в скрипте <code class="filename">/etc/rc.initdiskless</code>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp70015568"></a>5.2. syslog</h3></div></div></div><p>В файле <code class="filename">syslog.conf</code> задано местоположение
	некоторых файлов протоколов, которые имеются в каталоге
	<code class="filename">/var/log</code>.  Эти файлы не создаются скриптом
	<code class="filename">/etc/rc.d/var</code> во время инициализации системы.
	Поэтому где-нибудь в скрипте <code class="filename">/etc/rc.d/var</code>,
	после секции, создающей каталоги в <code class="filename">/var</code>, вам нужно
	добавить нечто вроде следующего:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>touch /var/log/security /var/log/maillog /var/log/cron /var/log/messages</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chmod 0644 /var/log/*</code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp70035792"></a>5.3. Установка портов</h3></div></div></div><p>Перед тем, как обсудить изменения, которые нужно сделать для
	успешного использования дерева портов, необходимо напомнить о том,
	что ваши файловые системы на флэш-носителях доступны только для чтения.
	Поэтому вам нужно временно монтировать их в режиме чтения и записи,
	используя параметры командной строки, как это показано в
	<a class="xref" href="#ro-fs" title="3. Подсистема rc и файловые системы в режиме только чтения">Раздел 3, <<Подсистема <code class="literal">rc</code> и файловые системы в режиме только
      чтения>></a>.  Вы всегда должны перемонтировать эти файловые
	системы в режим только для чтения после окончания работ -
	излишние записи на флеш носитель могут значительно сократить его
	срок эксплуатации.</p><p>Чтобы можно было войти в каталог с портами и успешно выполнить
	команду <code class="command">make</code> <code class="buildtarget">install</code>,
	необходимо создать каталог для пакаджей в файловой системе, не
	располагающейся в памяти, где будут храниться пакаджи между
	перезагрузками.  Так как для установки пакаджа в любом случае требуется
	монтирование ваших файловых систем для чтения и записи, имеет смысл
	выделить область флэш-носителя также и для записи информации
	о пакадже.</p><p>Прежде всего создайте каталог с базой данных о пакаджах.  Обычно
	это каталог <code class="filename">/var/db/pkg</code>, но мы не можем разместить
	базу именно здесь, так как она исчезнет после перезагрузки
	системы.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /etc/pkg</code></strong></pre><p>Теперь в скрипт <code class="filename">/etc/rc.d/var</code> добавьте
	строку, которая связывает каталог <code class="filename">/etc/pkg</code> с
	<code class="filename">/var/db/pkg</code>.  Например:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ln -s /etc/pkg /var/db/pkg</code></strong></pre><p>Теперь каждый раз при монтировании ваших файловых систем для чтения
	и записи и установки пакаджа, команда <code class="command">make</code>
	<code class="buildtarget">install</code> будет работать, а информация о пакадже
	будет успешно записана в каталог <code class="filename">/etc/pkg</code> (так как
	файловая система будет в это время смонтирована для чтения и записи),
	который всегда будет доступным операционной системе как
	<code class="filename">/var/db/pkg</code>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp70064848"></a>5.4. Веб-сервер Apache</h3></div></div></div><div xmlns="" class="note"><h3 class="admontitle">Примечание: </h3><p xmlns="http://www.w3.org/1999/xhtml">Шаги, описанные в этой части статьи, необходимо выполнить лишь
	  в том случае, если Apache настроен сохранять свой pid или лог файл
	  вне каталога <code class="filename">/var</code>.
	  С настройками по умолчанию Apache формирует свой pid файл в <code class="filename">/var/run/httpd.pid</code>, а лог файлы -
	  в <code class="filename">/var/log</code>.</p></div><p>Далее в статье подразумевается,
	что Apache сохраняет свои лог файлы в каталог <code class="filename"><em class="replaceable"><code>apache_log_dir</code></em></code>
	вне каталога <code class="filename">/var</code>.  Когда этот
	каталог расположен на файловой системе, смонтированной в режиме только
	для чтения, Apache не сможет сохранять лог файлы, что в свою очередь
	может вызывать проблемы в работе веб-сервера.  В таком случае
	необходимо добавить новый каталог к списку каталогов из
	<code class="filename">/etc/rc.d/var</code> для их создания в каталоге
	<code class="filename">/var</code> и связать
	<code class="filename"><em class="replaceable"><code>apache_log_dir</code></em></code>
	с <code class="filename">/var/log/apache</code>.  Нужно также задать права
	доступа и владельца нового каталога.</p><p>Сначала добавьте каталог <code class="literal">log/apache</code> к списку
	каталогов, создаваемых скриптом
	<code class="filename">/etc/rc.d/var</code>.</p><p>Затем добавьте в скрипт <code class="filename">/etc/rc.d/var</code>
	после секции создания каталогов такие команды:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chmod 0774 /var/log/apache</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chown nobody:nobody /var/log/apache</code></strong></pre><p>И наконец, удалите существующий каталог
	<code class="filename"><em class="replaceable"><code>apache_install</code></em>/logs</code>
	и замените его ссылкой:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>rm -rf <em class="replaceable"><code>apache_log_dir</code></em></code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>ln -s <em class="replaceable"><code>apache_log_dir</code></em></code></strong></pre></div></div></div></body></html>