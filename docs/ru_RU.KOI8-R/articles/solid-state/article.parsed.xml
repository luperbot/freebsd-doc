<?xml version="1.0" encoding="koi8-r"?>
<!--
     Copyright (c) 2001 The FreeBSD Documentation Project

     Redistribution and use in source (SGML DocBook) and 'compiled' forms
     (SGML, HTML, PDF, PostScript, RTF and so forth) with or without
     modification, are permitted provided that the following conditions
     are met:

      1. Redistributions of source code (SGML DocBook) must retain the above
         copyright notice, this list of conditions and the following
         disclaimer as the first lines of this file unmodified.

      2. Redistributions in compiled form (transformed to other DTDs,
         converted to PDF, PostScript, RTF and other formats) must reproduce
         the above copyright notice, this list of conditions and the
         following disclaimer in the documentation and/or other materials
         provided with the distribution.

     THIS DOCUMENTATION IS PROVIDED BY THE FREEBSD DOCUMENTATION PROJECT "AS
     IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
     THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
     PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL NIK CLAYTON BE LIABLE FOR ANY
     DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
     DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
     OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
     HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
     STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
     ANY WAY OUT OF THE USE OF THIS DOCUMENTATION, EVEN IF ADVISED OF THE
     POSSIBILITY OF SUCH DAMAGE.

     The FreeBSD Russian Documentation Project

     $FreeBSD$
     $FreeBSDru: frdp/doc/ru_RU.KOI8-R/articles/solid-state/article.xml,v 1.7 2006/03/28 16:20:06 gad Exp $

     Original revision: r43184
-->
<article xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:lang="ru">
  <info><title xmlns:xlink="http://www.w3.org/1999/xlink">FreeBSD и твердотельные устройства</title>
    

    <authorgroup xmlns:xlink="http://www.w3.org/1999/xlink">
      <author xmlns:xlink="http://www.w3.org/1999/xlink"><personname xmlns:xlink="http://www.w3.org/1999/xlink"><firstname xmlns:xlink="http://www.w3.org/1999/xlink">John</firstname><surname xmlns:xlink="http://www.w3.org/1999/xlink">Kozubik</surname></personname><affiliation xmlns:xlink="http://www.w3.org/1999/xlink">
	  <address xmlns:xlink="http://www.w3.org/1999/xlink"><email xmlns:xlink="http://www.w3.org/1999/xlink">john@kozubik.com</email></address>
	</affiliation></author>
    </authorgroup>

    <copyright xmlns:xlink="http://www.w3.org/1999/xlink">
      <year xmlns:xlink="http://www.w3.org/1999/xlink">2001</year>
      <year xmlns:xlink="http://www.w3.org/1999/xlink">2009</year>
      <holder xmlns:xlink="http://www.w3.org/1999/xlink">The FreeBSD Documentation Project</holder>
    </copyright>

    <pubdate xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</pubdate>

    <releaseinfo xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</releaseinfo>

    <legalnotice xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="trademarks" role="trademarks">
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">FreeBSD это зарегистрированная торговая
  марка FreeBSD Foundation.</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">Многие из обозначений, используемые
  производителями и продавцами для обозначения своих продуктов, заявляются
  в качестве торговых марок.  Когда такие обозначения появляются в этом
  документе, и Проекту FreeBSD известно о торговой марке, к обозначению
  добавляется знак <quote xmlns:xlink="http://www.w3.org/1999/xlink">TM</quote> или
  <quote xmlns:xlink="http://www.w3.org/1999/xlink">(R)</quote>.</para>
    </legalnotice>

    
<legalnotice xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="legalnotice">
  <para xmlns:xlink="http://www.w3.org/1999/xlink">Распространение и использование исходных (SGML DocBook) и
    <quote xmlns:xlink="http://www.w3.org/1999/xlink">скомпилированных</quote> форм (SGML, HTML, PDF, PostScript,
    RTF и прочих)
    с модификацией или без оной, разрешены при соблюдении следующих
    соглашений:</para>

  <orderedlist xmlns:xlink="http://www.w3.org/1999/xlink">
    <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">Распространяемые копии исходного кода (SGML DocBook) должны
        сохранять вышеупомянутые объявления copyright, этот список
	положений и следующий отказ от ответственности в первых строках
	этого файла в неизменном виде.</para>
    </listitem>

    <listitem xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">Распространяемые копии скомпилированных форм (преобразованные в
        другие DTD, конвертированные в PDF, PostScript, RTF и другие форматы)
	должны повторять вышеупомянутые объявления copyright, этот список
	положений и следующий отказ от ответственности в документации
	и/или других материалах, поставляемых с дистрибьюцией.</para>
    </listitem>
  </orderedlist>

  <important xmlns:xlink="http://www.w3.org/1999/xlink">
    <para xmlns:xlink="http://www.w3.org/1999/xlink">ЭТА ДОКУМЕНТАЦИЯ ПОСТАВЛЯЕТСЯ ПРОЕКТОМ ДОКУМЕНТАЦИИ FREEBSD
      "КАК ЕСТЬ" И ЛЮБЫЕ ЯВНЫЕ ИЛИ НЕЯВНЫЕ ГАРАНТИИ, ВКЛЮЧАЯ, НО НЕ
      ОГРАНИЧИВАЯСЬ НЕЯВНЫМИ ГАРАНТИЯМИ, КОММЕРЧЕСКОЙ ЦЕННОСТИ И ПРИГОДНОСТИ
      ДЛЯ КОНКРЕТНОЙ ЦЕЛИ ОТРИЦАЮТСЯ. НИ ПРИ КАКИХ УСЛОВИЯХ ПРОЕКТ
      ДОКУМЕНТИРОВАНИЯ FREEBSD НЕ НЕСЕТ ОТВЕТСТВЕННОСТИ ЗА ЛЮБОЙ ПРЯМОЙ, КОСВЕННЫЙ,
      СЛУЧАЙНЫЙ, СПЕЦИАЛЬНЫЙ, ОБРАЗЦОВЫЙ ИЛИ ПОСЛЕДУЮЩИЙ УЩЕРБЫ (ВКЛЮЧАЯ,
      НО НЕ ОГРАНИЧИВАЯСЬ ПОСТАВКОЙ ТОВАРОВ ЗАМЕНЫ ИЛИ УСЛУГ; ПОТЕРЮ ДАННЫХ
      ИЛИ ИХ НЕПРАВИЛЬНУЮ ПЕРЕДАЧУ ИЛИ ПОТЕРИ; ПРИОСТАНОВЛЕНИЕ БИЗНЕСА),
      И ТЕМ НЕ МЕНЕЕ ВЫЗВАННЫЕ И В ЛЮБОЙ ТЕОРИИ ОТВЕТСТВЕННОСТИ,
      НЕЗАВИСИМО ОТ КОНТРАКТНОЙ, СТРОГОЙ ОТВЕТСТВЕННОСТИ, ИЛИ
      ПРАВОНАРУШЕНИИ (ВКЛЮЧАЯ ХАЛАТНОСТЬ ИЛИ ИНЫМ СПОСОБОМ), ВОЗНИКШЕМ
      ЛЮБЫМ ПУТЕМ ПРИ ИСПОЛЬЗОВАНИИ ЭТОЙ ДОКУМЕНТАЦИИ, ДАЖЕ ЕСЛИ
      БЫ БЫЛО СООБЩЕНО О ВОЗМОЖНОСТИ ТАКОГО УЩЕРБА.</para>
  </important>
</legalnotice>


    <abstract xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">В этой статье описывается использование твердотельных дисковых
	устройств для создания встраиваемых систем на основе FreeBSD</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Встраиваемые системы имеют преимущество в повышенной надежности
	по причине отсутствия в них движущихся частей (жестких дисков).
	Однако, следует принять во внимание, что системе, как правило, доступно
	очень малое дисковое пространство и ограниченный объем запоминающего
	устройства.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">К отдельно рассматриваемым вопросам относятся типы и характеристики
	твердотельных носителей, подходящих для использования в качестве дисков
	во FreeBSD, параметры ядра, которые представляют интерес в таких условиях,
	механизмы <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.initdiskless</filename>, автоматизирующие
	инициализацию таких систем и удовлетворяющие требованиям файловых
	систем, доступных только для чтения, а также построение файловых систем
	с нуля.  Статья заканчивается описанием некоторых общих стратегий для
	случаев малых систем FreeBSD и работ в режиме только для чтения.</para>
    </abstract>
  </info>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="intro">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Твердотельные дисковые устройства</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Эта статья будет ограничиваться рассмотрением твердотельных дисковых
      устройств, которые делаются на основе флэш-памяти.  Флэш-память является
      твердотельным (здесь нет движущихся частей) запоминающим устройством,
      которое является энергонезависимым (данные остаются в памяти даже после
      отключения всех источников питания).  Флэш-память может быть
      нечувствительной к сильным физическим воздействиям и достаточно быстра
      (решения на основе флэш-памяти, описываемые в этой статье, гораздо
      медленнее, чем диски EIDE для операций записи, и гораздо быстрее их в
      случае выполнения операций чтения).  Одним из очень важных свойств
      флэш-памяти, различные варианты которого будут рассмотрены далее в этой
      статье, является то, что каждый сектор имеет ограниченные возможности по
      перезаписыванию.  Вы можете только записывать, стирать и снова записывать
      на сектор флэш-памяти определенное количество раз до того, как сектор
      станет полностью неработоспособным.  Хотя многие продукты на основе
      флэш-памяти автоматически перенаправляют испорченные блоки, а некоторые
      даже распределяют операции записи по всему модулю, фактом является
      наличие ограничения на количество операций записи, которые могут
      выполняться с устройством.  Современные модули имеют характеристики от
      1,000,000 до 10,000,000 циклов записи на сектор.  Эти характеристики
      могут зависеть от температуры рабочей среды.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">В частности, мы обсудим компактные модули флэш-памяти, совместимые со
      стандартом ATA, которые стали весьма популярными в качестве носителя
      данных для цифровых камер.  Особый интерес представляет тот факт, что они
      соответствуют шине IDE по контактам и совместимы с набором команд ATA.
      Таким образом, при помощи очень простого и дешевого адаптера такие
      устройства могут подключаться непосредственно к шине IDE компьютера.
      Если поступить таким образом, то такие операционные системы, как FreeBSD,
      распознают диск как обычный винчестер (весьма маленький).</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Существуют и другие решения для твердотельных дисков, но их
      стоимость, безвестность и сравнительная сложность использования выводят
      их за рамки этой статьи.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="kernel">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Параметры ядра</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Для тех, кто создает встраиваемую систему FreeBSD, интерес
      представляют несколько параметров ядра.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Все встраиваемые системы FreeBSD, которые используют
      флэш-память в качестве системного диска, заинтересованы в использовании
      дисков в памяти и файловых систем в памяти.  Из-за ограниченного
      количества циклов записи, которые можно выполнить с флэш-памятью, диск
      и файловые системы на нем будут, скорее всего, монтироваться в режиме
      доступа только для чтения.  В таком случае файловые системы типа
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/tmp</filename> и <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename> монтируются как
      файловые системы в памяти для того, чтобы позволить системе создать
      журналы и обновить счетчики и временные файлы.  Файловые системы в памяти
      являются критическим компонентом успешной работы FreeBSD на твердотельных
      устройствах.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Вы должны удостовериться, что в конфигурационном файле вашего ядра
      присутствуют следующие строки:</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">options         MFS             # Memory Filesystem
options         MD_ROOT         # md device usable as a potential root device
pseudo-device   md              # memory disk</programlisting>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="ro-fs">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Подсистема <literal xmlns:xlink="http://www.w3.org/1999/xlink">rc</literal> и файловые системы в режиме только
      чтения</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Инициализация встраиваемой системы FreeBSD после загрузки управляется
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.initdiskless</filename>.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink"><filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename> монтирует
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename> как файловую систему в памяти, создает
      указываемый список каталогов в <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename> при помощи
      команды <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">mkdir</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">1</manvolnum></citerefentry>, изменяет режимы доступа на некоторые из этих
      каталогов.  В процессе выполнения
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename> задействуется еще одна переменная
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</filename> - <literal xmlns:xlink="http://www.w3.org/1999/xlink">varsize</literal>.  Скрипт
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename> создает раздел
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename> на основе значения этой переменной из
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">rc.conf</filename>:</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">varsize=8192</programlisting>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Запомните, что по умолчанию это значение указано в секторах.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Факт использования файловой системы <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename>
      в режиме чтения и записи является
      важным признаком, так как раздел <filename xmlns:xlink="http://www.w3.org/1999/xlink">/</filename> (и любые другие
      разделы, которые могут находиться на флэш-носителе) должен монтироваться
      в режиме только для чтения.  Вспомните, что в <xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="intro"/> мы
      касались ограничений флэш-памяти - особенно ограничений, касающихся
      возможностей записи.  Важно не монтировать файловые системы на
      флэш-носителях в режимах чтения и записи, и важность отказа от файла
      подкачки не может быть переоценена.  Файл подкачки на загруженной системе
      может пережечь кусок флэш-носителя менее чем за год.  Частое
      журналирование и создание временных файлов приводят к тому же результату.
      Поэтому, кроме удаления записи <literal xmlns:xlink="http://www.w3.org/1999/xlink">swap</literal> из вашего файла
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/fstab</filename>, вы должны также изменить поле параметров
      каждой файловой системы на <literal xmlns:xlink="http://www.w3.org/1999/xlink">ro</literal> таким образом:</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink"># Device                Mountpoint      FStype  Options         Dump    Pass#
/dev/ad0s1a             /               ufs     ro              1       1</programlisting>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">В результате этих изменений в среднестатистической системе несколько
      приложений немедленно перестанут работать.  Например,  cron не будет
      нормально запускаться в результате отсутствия таблиц для него в каталоге
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename>, созданном <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename>,
      а syslog и dhcp будут испытывать проблемы из-за доступа файловой системы
      только для чтения, а также отсутствия записей в <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename>,
      который был создан скриптом <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename>.  Хотя эти
      проблемы являются временными и обсуждаются вместе с решением проблем
      с запуском распространенных программных пакетов, в <xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="strategies"/>.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Важно помнить, что файловая система, которая была смонтирована
      только для чтения при помощи файла <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/fstab</filename>, в
      любой момент может быть сделана доступной по чтению и записи выдачей
      команды:</para>

    <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/sbin/mount -uw <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">partition</replaceable></userinput></screen>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">и может быть возвращена к режиму доступа только для чтения по такой
      команде:</para>

    <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">/sbin/mount -ur <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">partition</replaceable></userinput></screen>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Создание файловой системы с нуля</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Так как совместимые с ATA компактные флэш-карты распознаются во FreeBSD
      как обычные жесткие диски IDE, то теоретически вы можете установить FreeBSD
      по сети при помощи дискет kern и mfsroot или с компакт-диска.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Однако даже маленькая установка FreeBSD при помощи обычных процедур
      установки может привести к созданию системы размером, превышающим 200
      мегабайт.  Так как большинство людей используют устройства флэш-памяти
      меньшего размера (128 мегабайт считается весьма большим - 32 или даже 16
      мегабайт используются гораздо чаще), то установка обычным образом не
      подходит-просто на диске нет места даже для самой минимальной
      установки.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Самым простым способом обойти это ограничение на объем является
      установка FreeBSD обычным образом на обычный жесткий диск.  После окончания
      установки, обрежьте операционную систему до размера, который помещается
      на ваш флэш-носитель, а затем полностью заархивируйте файловую систему.
      Следующие шаги поведут вас через процесс подготовки части флэш-памяти
      для вашей заархивированной файловой системы.  Запомните, что из-за того,
      что обычная установка не выполнялась, такие операции, как разбиение
      на разделы, разметка, создание файловой системы и так далее должны быть
      выполнены вручную.  Кроме дискет kern и mfsroot вам также нужно
      воспользоваться дискетой fixit.</para>

    <procedure xmlns:xlink="http://www.w3.org/1999/xlink">
      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Разбиение вашего флэш-носителя на разделы</title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">После загрузки при помощи дискет kern и mfsroot, выберите пункт
	  <literal xmlns:xlink="http://www.w3.org/1999/xlink">custom</literal> из меню установки.  Из следующего пункта
	  меню выберите <literal xmlns:xlink="http://www.w3.org/1999/xlink">partition</literal>.  В меню работы с
	  разделами вы должны удалить все существующие разделы при помощи
	  клавиши <keycap xmlns:xlink="http://www.w3.org/1999/xlink">d</keycap>.  После удаления всех имеющихся разделов
	  создайте раздел при помощи клавиши <keycap xmlns:xlink="http://www.w3.org/1999/xlink">c</keycap> и согласитесь
	  с предлагаемым по умолчанию размером раздела.  Когда вы будете
	  опрошены на предмет типа раздела, удостоверьтесь, что значение типа
	  равно <literal xmlns:xlink="http://www.w3.org/1999/xlink">165</literal>.  Теперь запишите эту таблицу разделов
	  на диск, нажав клавишу <keycap xmlns:xlink="http://www.w3.org/1999/xlink">w</keycap> (на этом экране эта опция
	  скрыта).  Если вы используете компактную флэш-карту, совместимую
	  с ATA, вы должны выбрать FreeBSD Boot Manager.  Теперь нажмите
	  клавишу <keycap xmlns:xlink="http://www.w3.org/1999/xlink">q</keycap> для выхода из меню работы с разделами.
	  Должно быть выдано еще раз меню для выбора менеджера загрузки -
	  повторите то, что вы выбирали ранее.</para>
      </step>

      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Создание файловых систем на вашем устройстве флэш-памяти</title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Выйдите из меню установки custom, и из главного меню установки
	  выберите пункт <literal xmlns:xlink="http://www.w3.org/1999/xlink">fixit</literal>.  После входа в режим работы
	  fixit, введите следующую команду:</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">disklabel -e /dev/ad0c</userinput></screen>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">В этот момент вы войдете в редактор vi из-под команды disklabel.
	  Затем, вам нужно добавить строку <literal xmlns:xlink="http://www.w3.org/1999/xlink">a:</literal> в конце файла.
	  Эта строка <literal xmlns:xlink="http://www.w3.org/1999/xlink">a:</literal> должна выглядеть примерно так:</para>

	<programlisting xmlns:xlink="http://www.w3.org/1999/xlink">a:      <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">123456</replaceable>  0       4.2BSD  0       0</programlisting>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Здесь <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">123456</replaceable> является числом, в
	  точности совпадающим с тем, что характеризует размер имеющейся записи
	  для <literal xmlns:xlink="http://www.w3.org/1999/xlink">c:</literal>.  В общем, вы копируете существующую
	  строку для <literal xmlns:xlink="http://www.w3.org/1999/xlink">c:</literal> для строки <literal xmlns:xlink="http://www.w3.org/1999/xlink">a:</literal>,
	  не забывая определить fstype как <literal xmlns:xlink="http://www.w3.org/1999/xlink">4.2BSD</literal>.
	  Сохраните файл и завершите редактирование.</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">disklabel -B -r /dev/ad0c</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">newfs /dev/ad0a</userinput></screen>
      </step>

      <step xmlns:xlink="http://www.w3.org/1999/xlink">
	<title xmlns:xlink="http://www.w3.org/1999/xlink">Размещение вашей файловой системы на флэш-носителе</title>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Смонтируйте только что подготовленный флэш-носитель:</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">mount /dev/ad0a /flash</userinput></screen>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Подключите эту машину к сети, чтобы можно было перенести наш
	  tar-файл и распаковать его в файловую систему на флэш-носителе.  Вот
	  пример того, как это можно сделать:</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">ifconfig xl0 192.168.0.10 netmask 255.255.255.0</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">route add default 192.168.0.1</userinput></screen>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Теперь, когда машина находится в сети, перепишите ваш tar-файл.
	  Здесь вы можете столкнуться с некоторой проблемой - если объем вашей
	  флэш-памяти равен, к примеру, 128 мегабайтам, а ваш tar-файл
	  превышает 64 мегабайта, то вы не можете одновременно разместить
	  tar-файл на флэш-носителе и распаковать его - вам не хватит места.
	  Одним из решений этой проблемы, если вы используете FTP, является
	  распаковка файла во время его передачи по FTP.  Если вы передаете
	  файл именно так, то вы никогда не получите на диске одновременно
	  архивный файл и его содержимое:</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns:xlink="http://www.w3.org/1999/xlink">ftp&gt;</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">get tarfile.tar "| tar xvf -"</userinput></screen>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Если ваш файл обработан утилитой gzip, вы также можете этого
	  добиться:</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns:xlink="http://www.w3.org/1999/xlink">ftp&gt;</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">get tarfile.tar "| zcat | tar xvf -"</userinput></screen>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">После того, как вы получили содержимое вашей заархивированной
	  файловой системы на файловой системе флэш-памяти, вы можете
	  размонтировать флэш-память и выполнить перезагрузку:</para>

	<screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">cd /</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">umount /flash</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">exit</userinput></screen>

	<para xmlns:xlink="http://www.w3.org/1999/xlink">Полагая, что вы правильно настроили вашу файловую систему при
	  ее построении на обычном диске (с вашей файловой системой,
	  смонтированной в режиме доступа только для чтения, и необходимыми
	  параметрами, присутствующими в ядре) вы должны успешно загрузить вашу
	  встраиваемую систему на основе FreeBSD.</para>
      </step>
    </procedure>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="strategies">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Стратегии работы с системой для случаев небольших и доступных
      только для чтения файловых систем</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">В <xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="ro-fs"/> было указано, что файловая система
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename>, создаваемая скриптом
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename>, и наличие корневой файловой
      системы, доступной только для чтения, приводят к проблемам при работе
      многих распространенных программных пакетов, используемых во FreeBSD.
      В этой статье будут даны рекомендации по настройке нормальной работы
      cron и syslog, установке портов и веб-сервера Apache.</para>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">cron</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Во время загрузки содержимое каталогa
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename> формируется скриптом
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename> используя данные из
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/mtree/BSD.var.dist</filename>, поэтому в нем создается
	несколько стандартных каталогов, в числе которых -
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">cron</filename>,
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">cron/tabs</filename>,
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">at</filename>.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Однако это не решает проблему с сохранением cron-таблиц
	между перезагрузками.  Когда система перезагружается, то файловая
	система	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename>, которая располагается в памяти,
	будет уничтожена, вместе со всеми cron-таблицами, которые вы могли там
	иметь.  Поэтому одним из решений может стать создание cron-таблиц для
	пользователей, которым они нужны, монтирование вашей файловой системы
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/</filename> в режиме чтения и записи, и копирование этих
	cron-таблиц в безопасное место, например,
	в <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/tabs</filename>, и последующее добавление строки в
	конец скрипта <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.initdiskless</filename> для копирования
	этих cron-таблиц в каталог <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var/cron/tabs</filename> после
	его создания во время инициализации системы.  Вам может также
	потребоваться добавить строку, которая изменяет режимы доступа и
	права на каталоги, которые вы создали, и на файлы, которые вы
	скопировали в скрипте <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.initdiskless</filename>.</para>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">syslog</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">В файле <filename xmlns:xlink="http://www.w3.org/1999/xlink">syslog.conf</filename> задано местоположение
	некоторых файлов протоколов, которые имеются в каталоге
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/var/log</filename>.  Эти файлы не создаются скриптом
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename> во время инициализации системы.
	Поэтому где-нибудь в скрипте <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename>,
	после секции, создающей каталоги в <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename>, вам нужно
	добавить нечто вроде следующего:</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">touch /var/log/security /var/log/maillog /var/log/cron /var/log/messages</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">chmod 0644 /var/log/*</userinput></screen>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Установка портов</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Перед тем, как обсудить изменения, которые нужно сделать для
	успешного использования дерева портов, необходимо напомнить о том,
	что ваши файловые системы на флэш-носителях доступны только для чтения.
	Поэтому вам нужно временно монтировать их в режиме чтения и записи,
	используя параметры командной строки, как это показано в
	<xref xmlns:xlink="http://www.w3.org/1999/xlink" linkend="ro-fs"/>.  Вы всегда должны перемонтировать эти файловые
	системы в режим только для чтения после окончания работ -
	излишние записи на флеш носитель могут значительно сократить его
	срок эксплуатации.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Чтобы можно было войти в каталог с портами и успешно выполнить
	команду <command xmlns:xlink="http://www.w3.org/1999/xlink">make</command> <buildtarget>install</buildtarget>,
	необходимо создать каталог для пакаджей в файловой системе, не
	располагающейся в памяти, где будут храниться пакаджи между
	перезагрузками.  Так как для установки пакаджа в любом случае требуется
	монтирование ваших файловых систем для чтения и записи, имеет смысл
	выделить область флэш-носителя также и для записи информации
	о пакадже.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Прежде всего создайте каталог с базой данных о пакаджах.  Обычно
	это каталог <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var/db/pkg</filename>, но мы не можем разместить
	базу именно здесь, так как она исчезнет после перезагрузки
	системы.</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">mkdir /etc/pkg</userinput></screen>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Теперь в скрипт <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename> добавьте
	строку, которая связывает каталог <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/pkg</filename> с
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/var/db/pkg</filename>.  Например:</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">ln -s /etc/pkg /var/db/pkg</userinput></screen>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Теперь каждый раз при монтировании ваших файловых систем для чтения
	и записи и установки пакаджа, команда <command xmlns:xlink="http://www.w3.org/1999/xlink">make</command>
	<buildtarget>install</buildtarget> будет работать, а информация о пакадже
	будет успешно записана в каталог <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/pkg</filename> (так как
	файловая система будет в это время смонтирована для чтения и записи),
	который всегда будет доступным операционной системе как
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/var/db/pkg</filename>.</para>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Веб-сервер Apache</title>

      <note xmlns:xlink="http://www.w3.org/1999/xlink">
	<para xmlns:xlink="http://www.w3.org/1999/xlink">Шаги, описанные в этой части статьи, необходимо выполнить лишь
	  в том случае, если Apache настроен сохранять свой pid или лог файл
	  вне каталога <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename>.
	  С настройками по умолчанию Apache формирует свой pid файл в <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var/run/httpd.pid</filename>, а лог файлы -
	  в <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var/log</filename>.</para>
      </note>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Далее в статье подразумевается,
	что Apache сохраняет свои лог файлы в каталог <filename xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">apache_log_dir</replaceable></filename>
	вне каталога <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename>.  Когда этот
	каталог расположен на файловой системе, смонтированной в режиме только
	для чтения, Apache не сможет сохранять лог файлы, что в свою очередь
	может вызывать проблемы в работе веб-сервера.  В таком случае
	необходимо добавить новый каталог к списку каталогов из
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename> для их создания в каталоге
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/var</filename> и связать
	<filename xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">apache_log_dir</replaceable></filename>
	с <filename xmlns:xlink="http://www.w3.org/1999/xlink">/var/log/apache</filename>.  Нужно также задать права
	доступа и владельца нового каталога.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Сначала добавьте каталог <literal xmlns:xlink="http://www.w3.org/1999/xlink">log/apache</literal> к списку
	каталогов, создаваемых скриптом
	<filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename>.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Затем добавьте в скрипт <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.d/var</filename>
	после секции создания каталогов такие команды:</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">chmod 0774 /var/log/apache</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">chown nobody:nobody /var/log/apache</userinput></screen>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">И наконец, удалите существующий каталог
	<filename xmlns:xlink="http://www.w3.org/1999/xlink"><replaceable xmlns:xlink="http://www.w3.org/1999/xlink">apache_install</replaceable>/logs</filename>
	и замените его ссылкой:</para>

      <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">rm -rf <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">apache_log_dir</replaceable></userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">ln -s <replaceable xmlns:xlink="http://www.w3.org/1999/xlink">apache_log_dir</replaceable></userinput></screen>
    </sect2>
  </sect1>
</article>
