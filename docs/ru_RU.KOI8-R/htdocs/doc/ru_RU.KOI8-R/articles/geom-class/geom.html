<?xml version="1.0" encoding="koi8-r" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r" /><title>4. Программирование в системе GEOM</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Создание класса GEOM" /><link rel="up" href="index.html" title="Создание класса GEOM" /><link rel="prev" href="kernelprog.html" title="3. Программирование в ядре FreeBSD" /><link rel="copyright" href="trademarks.html" title="Юридическое уведомление" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4. Программирование в системе GEOM</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="kernelprog.html">Пред.</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> </td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="geom"></a>4. Программирование в системе GEOM</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-ggate"></a>4.1. Ggate</h3></div></div></div><p>Если максимальная производительность не требуется,
	то более простой способ совершать преобразования данных -
	это выполнять их в пространстве пользовательских процессов
	посредством ggate (GEOM gate). К недостаткам следует отнести
	невозможность простого переноса кода в ядро.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-class"></a>4.2. Класс GEOM</h3></div></div></div><p>Класс GEOM выполняет преобразования данных. Эти преобразования
	могут быть скомпонованы друг с другом в виде дерева. Экземпляр
	класса GEOM называют <span class="emphasis"><em>geom</em></span>.</p><p>В каждом классе GEOM есть несколько <span class="quote"><<<span class="quote">методов класса</span>>></span>,
	которые вызываются когда экземпляра класса нет в наличии (или же
	они не привязаны к конкретному экземпляру класса).</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="function">.init</code> вызывается тогда, когда
	    системе GEOM становится известно о классе GEOM (например,
	    когда загружается модуль ядра).</p></li><li class="listitem"><p><code class="function">.fini</code> будет вызван в случае отказа
	    GEOM системы от класса (например, при выгрузке модуля).</p></li><li class="listitem"><p><code class="function">.taste</code> вызывается, когда в
	    системе появляется новый класс или поставщик geom
	    (<span class="quote"><<<span class="quote">provider</span>>></span>). Если соответствие найдено, то эта
	    функция обычно создает и запускает экземпляр geom.</p></li><li class="listitem"><p><code class="function">.destroy_geom</code> вызывается при
	    необходимости разрушить экземпляр geom.</p></li><li class="listitem"><p><code class="function">.ctlconf</code> будет вызван, когда
	    пользователь запросит изменение конфигурации существующего
	    экземпляра geom</p></li></ul></div><p>Также определены функции событий GEOM, которые копируются
	в экземпляр geom.</p><p>Поле <code class="function">.geom</code> в структуре
	<code class="varname">g_class</code> - это список (LIST) экземпляров
	geom, реализованных из класса.</p><p>Эти функции вызываются из g_event потока ядра.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-softc"></a>4.3. Softc</h3></div></div></div><p><span class="quote"><<<span class="quote">softc</span>>></span> - это устаревший термин
	для <span class="quote"><<<span class="quote">приватных данных драйвера</span>>></span> (<span class="quote"><<<span class="quote">driver
	private data</span>>></span>). Название вероятней всего происходит от
	устаревшего термина <span class="quote"><<<span class="quote">software control block</span>>></span>.
	В системе GEOM softc это структура (точнее: указатель на
	структуру) которая может быть присоединена к экземпляру geom
	и может содержать приватные данные экземпляра. У большинства
	классов GEOM есть следующие члены:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="varname">struct g_provider *provider</code> :
	    <span class="quote"><<<span class="quote">поставщик geom</span>>></span> предоставляемый данным экземпляром
	    geom</p></li><li class="listitem"><p><code class="varname">uint16_t n_disks</code> : Количество
	    потребителей geom (<span class="quote"><<<span class="quote">consumer</span>>></span>), обслуживаемых данным
	    экземпляром geom</p></li><li class="listitem"><p><code class="varname">struct g_consumer **disks</code> :
	    Массив <code class="varname">struct g_consumer*</code>. (Невозможно
	    обойтись одинарным указателем, потому что система GEOM создает
	    для нас структуры struct g_consumer*)</p></li></ul></div><p>Структура <code class="varname">softc</code> содержит состояние
	экземпляра geom. У каждого экземпляра есть свой softc.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-metadata"></a>4.4. Метаданные</h3></div></div></div><p>Формат метаданных в той или иной мере зависит от конкретного
	класса, но <span class="emphasis"><em>обязан</em></span> начинаться с:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>16-байтного буфера для подписи - строки с
	    завершающим нулем (обычно это имя класса)</p></li><li class="listitem"><p>uint32 идентификатора версии</p></li></ul></div><p>Подразумевается, что классы geom знают как обращаться с
	метаданными с идентификаторами версий ниже, чем их собственные.</p><p>Метаданные размещаются в последнем секторе поставщика geom
	(поэтому обязаны целиком умещаться в нем).</p><p>(Все это зависит от реализации, но весь существующий код работает
	подобно описанному и поддерживается библиотеками.)</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-creating"></a>4.5. Маркирование/создание экземпляра geom</h3></div></div></div><p>Последовательность событий следующая:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>пользователь запускает служебную программу <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=geom&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">geom</span>(8)</span></a></p></li><li class="listitem"><p>программа решает каким классом geom ей придется
	    управлять и ищет библиотеку
	    <code class="filename">geom_<em class="replaceable"><code>CLASSNAME</code></em>.so</code>
	    (которая обычно находится в <code class="filename">/lib/geom</code>).</p></li><li class="listitem"><p>она открывает библиотеку при помощи <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dlopen&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">dlopen</span>(3)</span></a>,
	    извлекает вспомогательные функции и определения параметров
	    командной строки.</p></li></ul></div><p>Вот так происходит создание/маркирование нового экземпляра
	geom:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=geom&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">geom</span>(8)</span></a> ищет команду в аргументах командной
	    строки (обычно это <code class="option">label</code>) и вызывает
	    вспомогательную функцию.</p></li><li class="listitem"><p>Вспомогательная функция проверяет параметры и
	    собирает метаданные, которые записываются во все вовлеченные
	    поставщики geom.</p></li><li class="listitem"><p>Это <span class="quote"><<<span class="quote">повреждает (spoil)</span>>></span> существующие
	    экземпляры geom (если они были) и порождает новый виток
	    <span class="quote"><<<span class="quote">тестирования</span>>></span> поставщиков geom. Целевой класс geom
	    опознает метаданные и активирует экземпляр geom.</p></li></ul></div><p>(Приведенная выше последовательность событий зависит от
	конкретной реализации, но весь существующий код работает
	подобно описанному и поддерживается библиотеками.)</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-command"></a>4.6. Структура команд geom</h3></div></div></div><p>Вспомогательная библиотека <code class="filename">geom_CLASSNAME.so</code>
	экспортирует структуру <code class="varname">class_commands</code>,
	которая является массивом элементов
	<code class="varname">struct g_command</code>. Эти команды одинакового
	формата и выглядят следующим образом:</p><pre class="programlisting">  команда [-опции] имя_geom [другие]</pre><p>Общими командами являются:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>label - записать метаданные в устройства,
	    чтобы они могли быть опознаны в процессе тестирования
	    и использованы в соответствующих экземплярах geom</p></li><li class="listitem"><p>destroy - разрушить метаданные, за которым
	    последует разрушение экземпляров geom</p></li></ul></div><p>Общие опции:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">-v</code> : детальный вывод</p></li><li class="listitem"><p><code class="literal">-f</code> : принудить</p></li></ul></div><p>Некоторые операции, к примеру маркирование метаданными и
	разрушение метаданных могут быть выполнены из пространства
	пользовательских процессов. Для этого, структура
	<code class="varname">g_command</code> содержит поле
	<code class="varname">gc_func</code>, которое может быть установлено на
	функцию (в том-же <code class="filename">.so</code>), которая будет вызвана
	для обработки команды. В случае, когда <code class="varname">gc_func</code>
	равно NULL, команда будет передана модулю ядра: функции
	<code class="function">.ctlreq</code> класса GEOM.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-geoms"></a>4.7. Экземпляры geom</h3></div></div></div><p>У экземпляров классов GEOM есть внутренние данные, которые
	хранятся в структурах softc, а также есть некоторые функции,
	посредством которых они реагируют на внешние события.</p><p>Функции событий:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="function">.access</code> : просчитывает
	    права доступа (чтение/запись/исключительный доступ)</p></li><li class="listitem"><p><code class="function">.dumpconf</code> : возвращает
	    информацию о экземпляре geom; формат XML</p></li><li class="listitem"><p><code class="function">.orphan</code> : вызывается, когда
	    отсоединяется любой из низлежащих поставщиков geom</p></li><li class="listitem"><p><code class="function">.spoiled</code> : вызывается, когда
	    производится запись в низлежащий поставщик geom</p></li><li class="listitem"><p><code class="function">.start</code> : обрабатывает ввод/вывод</p></li></ul></div><p>Эти функции вызываются из ядерного потока
	<code class="function">g_down</code> и в этом контексте не может быть
	блокировок (поищите определение <span class="quote"><<<span class="quote">блокировка</span>>></span> в других
	источниках), что немного ограничивает свободу действий, но
	способствует быстроте обработки.</p><p>Из вышеупомянутых, наиболее важной и выполняющей полезную работу
	функцией является <code class="function">.start</code>(), которая вызывается
	всякий раз, когда поставщику geom, управляемому экземпляром класса,
	приходит запрос BIO.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-threads"></a>4.8. Потоки выполнения системы geom</h3></div></div></div><p>Системой GEOM в ядре ОС создаются и используются три
	потока выполнения (kernel threads):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">g_down</code> : Обрабатывает запросы,
	    приходящие от высокоуровневых сущностей (таких, как запросы из
	    пространства пользовательских процессов) на пути к физическим
	    устройствам</p></li><li class="listitem"><p><code class="literal">g_up</code> : Обрабатывает ответы от
	    драйверов устройств на запросы, выполненные высокоуровневыми
	    сущностями</p></li><li class="listitem"><p><code class="literal">g_event</code> : Отрабатывает в остальных
	    случаях, как-то создание экземпляра geom, просчитывание прав
	    доступа, события <span class="quote"><<<span class="quote">повреждения</span>>></span> и т.п.</p></li></ul></div><p>Когда пользовательский процесс запрашивает <span class="quote"><<<span class="quote">прочитать
	данные X по смещению Y файла</span>>></span>, происходит следующее:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Файловая система преобразует запрос в экземпляр
	    структуры bio и передает его системе GEOM. Файловая система
	    <span class="quote"><<<span class="quote">знает</span>>></span>, что экземпляр geom должен обработать запрос,
	    так как файловые системы размещаются непосредственно
	    над экземпляром geom.</p></li><li class="listitem"><p>Запрос завершается вызовом функции
	    <code class="function">.start</code>() в потоке g_down и достигает
	    верхнего экземпляра geom.</p></li><li class="listitem"><p>Верхний экземпляр geom (например, это секционировщик
	    разделов (partition slicer)) определяет, что запрос должен быть
	    переадресован нижестоящему экземпляру geom (к примеру, драйверу
	    диска). Вышестоящий экземпляр geom создает копию запроса bio
	    (запросы bio <span class="emphasis"><em>ВСЕГДА</em></span> копируются при передаче
	    между экземплярами geom при помощи
	    <code class="function">g_clone_bio</code>()!),
	    изменяет поля смещения и целевого поставщика geom и запускает
	    на обработку копию при помощи функции
	    <code class="function">g_io_request</code>()</p></li><li class="listitem"><p>Драйвер диска также получает запрос bio, как вызов
	    функции <code class="function">.start</code>() в потоке
	    <code class="literal">g_down</code>. Драйвер обращается к контроллеру диска,
	    получает блок данных и вызывает функцию
	    <code class="function">g_io_deliver</code>() используя копию запроса bio
	    </p></li><li class="listitem"><p>Теперь, извещение о завершении bio
	    <span class="quote"><<<span class="quote">всплывает</span>>></span> в потоке <code class="literal">g_up</code>.
	    Сначала в потоке <code class="literal">g_up</code> вызывается функция
	    <code class="function">.done</code>() секционировщика разделов,
	    последний использует полученную информацию, разрушает
	    клонированный экземпляр структуры bio посредством
	    <code class="function">g_destroy_bio</code>() и вызывает
	    <code class="function">g_io_deliver</code>() используя
	    первоначальный запрос</p></li><li class="listitem"><p>Файловая система получает данные и передает их
	    пользовательскому процессу</p></li></ul></div><p>За информацией о том, как данные передаются в структуре
	<code class="varname">bio</code> между экземплярами geom,
	смотрите <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=g_bio&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">g_bio</span>(9)</span></a> (обратите внимание на использование полей
	<code class="varname">bio_parent</code> и <code class="varname">bio_children</code>).
	</p><p>Важный момент в том, что <span class="emphasis"><em>НЕЛЬЗЯ ДОПУСКАТЬ БЛОКИРОВОК
	В ПОТОКАХ G_UP И G_DOWN</em></span>. Вот неполный перечень того,
	что нельзя делать в этих потоках:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Вызывать функции <code class="function">msleep</code>() или
	    <code class="function">tsleep</code>().</p></li><li class="listitem"><p>Использовать функции
	    <code class="function">g_write_data</code>() и
	    <code class="function">g_read_data</code>(), так как они блокируются
	    в момент обмена данными с потребителями geom.</p></li><li class="listitem"><p>Ожидать ввод/вывод.</p></li><li class="listitem"><p>Вызывать <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=malloc&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">malloc</span>(9)</span></a> и
	    <code class="function">uma_zalloc</code>() с установленным флагом
	    <code class="varname">M_WAITOK</code>.</p></li><li class="listitem"><p>Использовать <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sx&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">sx</span>(9)</span></a> 
	    </p></li></ul></div><p>Это ограничение на код GEOM призвано избежать от
	<span class="quote"><<<span class="quote">засорения</span>>></span> пути запроса ввода/вывода, так как
	блокировки обычно не имеют четких временных границ, и нет гарантий
	на занимаемое время (также на то есть и другие технические причины).
	Это также значит, что в вышеупомянутых потоках сколь-нибудь сложные
	операции выполнить нельзя, например: любое сложное преобразование
	требует выделения памяти. К счастью решение есть: создание
	дополнительных ядерных потоков.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="geom-kernelthreads"></a>4.9. Ядерные потоки выполнения, предназначенные для использования
	в коде geom</h3></div></div></div><p>Ядерные потоки выполнения создаются функцией
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kthread_create&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">kthread_create</span>(9)</span></a>, в своем поведении они схожи с потоками,
	созданными в пространстве пользовательских процессов, но есть одно
	отличие: они не могут известить вызвавший их поток о своем завершении;
	по завершению - необходимо вызывать <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kthread_exit&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">kthread_exit</span>(9)</span></a></p><p>В коде GEOM обычное назначение этих потоков - разгрузить
	поток <code class="literal">g_down</code>
	(функцию <code class="function">.start</code>() ) от обработки запросов. Эти
	потоки подобны <span class="quote"><<<span class="quote">обработчикам событий</span>>></span>
	(<span class="quote"><<<span class="quote">event handlers</span>>></span>):
	у них есть очередь событий (которая наполняется событиями от разных
	функций из разных потоков; очередь необходимо защищать мьютексом),
	события из очереди выбираются одно за другим и обрабатываются
	в большом блоке <code class="literal">switch</code>().</p><p>Основное преимущество использования отдельного потока, который
	обрабатывает запросы ввода/вывода, то, что он может блокироваться по
	мере необходимости. Это, несомненно, привлекательно, но должно быть
	хорошо обдумано. Блокирование - хорошо и удобно, но может
	существенно снизить производительность преобразований данных в
	системе GEOM. Особо требовательные к производительности классы
	могут делать всю работу в функции <code class="function">.start</code>(),
	уделяя особое внимание ошибкам при работе с памятью.</p><p>Еще одно преимущество потока <span class="quote"><<<span class="quote">обработчика событий</span>>></span>
	это сериализация всех запросов и ответов, приходящих с разных
	потоков geom в один поток. Это также удобно, но может быть медленным.
	В большинстве случаев, обработка запросов функцией
	<code class="function">.done</code>() может быть оставлена потоку
	<code class="literal">g_up</code>.</p><p>У мьютексов в ядре FreeBSD (<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mutex&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">mutex</span>(9)</span></a>) есть одно различие
	с их аналогами из пространства пользовательских процессов -
	во время удержания мьютекса в коде не должно быть блокировки. Если
	в коде необходимо блокирование, то лучше использовать <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sx&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">sx</span>(9)</span></a>.
	С другой стороны, если вся ваша работа выполняется в одном потоке,
	вы можете обойтись вообще без мьютексов.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="kernelprog.html">Пред.</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> </td></tr><tr><td width="40%" align="left" valign="top">3. Программирование в ядре FreeBSD </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>Этот, и другие документы, могут быть скачаны с
    <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>По вопросам, связанным с FreeBSD, прочитайте
    <a href="http://www.FreeBSD.org/ru/docs.html">документацию</a> прежде чем писать в
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    По вопросам, связанным с этой документацией, пишите в рассылку
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.<br></br></small></p></body></html>