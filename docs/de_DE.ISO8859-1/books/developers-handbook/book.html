<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>FreeBSD Developers' Handbook</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><meta name="description" content="Willkommen zum Entwickler-Handbuch. Dieses Handbuch ist jederzeit unter Bearbeitung und das Ergebnis der Arbeit vieler Einzelpersonen. Dies kann dazu führen, dass bestimmte Bereiche nicht mehr aktuell sind und auf den neuesten Stand gebracht werden müssen. Bei Unklarheiten empfiehlt es sich daher stets, auch die englische Originalversion des Handbuchs zu lesen. Wenn Sie bei der Übersetzung dieses Handbuchs mithelfen möchten, senden Sie bitte eine E-Mail an die Mailingliste 'FreeBSD German Documentation Project' de-bsd-translators@de.FreeBSD.org. Die aktuelle Version dieses Handbuchs ist immer auf dem FreeBSD-Webserver verfügbar und kann in verschiedenen Formaten und in komprimierter Form vom FreeBSD-FTP-Server oder einem der zahlreichen Spiegel heruntergeladen werden (ältere Versionen finden Sie hingegen unter http://docs.FreeBSD.org/doc/)." /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div xml:lang="de" class="book" lang="de"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp61463888"></a>FreeBSD Developers' Handbook</h1></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="author"><h3 class="author"><span class="orgname">The FreeBSD Documentation Project</span></h3></div></div><div>Version: <a href="https://svnweb.freebsd.org/changeset/doc/"><span class="svnref"></span></a></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">Copyright © 2000-2010 The FreeBSD Documentation Project</p></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">Copyright © 2008-2010 The FreeBSD German Documentation Project</p></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="legalnotice"></a><p>Redistribution and use in source (SGML DocBook) and 'compiled'
    forms (SGML, HTML, PDF, PostScript, RTF and so forth) with or without
    modification, are permitted provided that the following conditions are
    met:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Redistributions of source code (SGML DocBook) must retain the
        above copyright notice, this list of conditions and the following
        disclaimer as the first lines of this file unmodified.</p></li><li class="listitem"><p>Redistributions in compiled form (transformed to other DTDs,
        converted to PDF, PostScript, RTF and other formats) must
        reproduce the above copyright notice, this list of conditions and
        the following disclaimer in the documentation and/or other
        materials provided with the distribution.</p></li></ol></div><div xmlns="" class="important"><h3 class="admontitle">Wichtig: </h3><p xmlns="http://www.w3.org/1999/xhtml">THIS DOCUMENTATION IS PROVIDED BY THE FREEBSD DOCUMENTATION
      PROJECT "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
      BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
      FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL
      THE FREEBSD DOCUMENTATION PROJECT BE LIABLE FOR ANY DIRECT, INDIRECT,
      INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
      BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS
      OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
      ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
      TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
      USE OF THIS DOCUMENTATION, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
      DAMAGE.</p></div></div></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="trademarks"></a><p>FreeBSD ist ein eingetragenes
  Warenzeichen der FreeBSD Foundation.</p><p>Apple, FireWire, Mac, Macintosh, Mac OS,
  Quicktime und TrueType sind eingetragene Warenzeichen von
  Apple Computer, Inc., in den Vereinigten Staaten und anderen
  Ländern.</p><p>IBM, AIX, OS/2,
  PowerPC, PS/2, S/390 und ThinkPad
  sind Warenzeichen der International Business Machines Corporation
  in den Vereinigten Staaten, anderen Ländern oder beiden.</p><p>IEEE, POSIX und 802 sind eingetragene
  Warenzeichen vom Institute of Electrical and Electronics Engineers,
  Inc. in den Vereinigten Staaten.</p><p>Intel, Celeron, EtherExpress, i386,
  i486, Itanium, Pentium und Xeon sind Warenzeichen oder eingetragene
  Warenzeichen der Intel Corporation oder ihrer Gesellschaften
  in den Vereinigten Staaten und in anderen Ländern.</p><p>Linux ist ein eingetragenes Warenzeichen
  von Linus Torvalds.</p><p>Microsoft, MS-DOS,
  Outlook, Windows, Windows Media und Windows NT sind entweder
  eingetragene Warenzeichen oder Warenzeichen der Microsoft Corporation
  in den Vereinigten Staaten und/oder in anderen Ländern.</p><p>Motif, OSF/1 und UNIX sind
  eingetragene Warenzeichen und IT DialTone und The Open Group
  sind Warenzeichen der The Open Group in den Vereinigten Staaten
  und in anderen Ländern.</p><p>Sun, Sun Microsystems, Java,
  Java Virtual Machine, JDK, JSP, JVM, Netra,
  Solaris, StarOffice
  und SunOS sind Warenzeichen oder eingetragene Warenzeichen von
  Sun Microsystems, Inc. in den Vereinigten Staaten und in anderen
  Ländern.</p><p>Viele Produktbezeichnungen von
  Herstellern und Verkäufern sind Warenzeichen.  Soweit dem
  FreeBSD Project das Warenzeichen bekannt ist, werden die in diesem
  Dokument vorkommenden Bezeichnungen mit dem Symbol
  <span class="quote">&#8222;<span class="quote">&#8482;</span>&#8220;</span> oder dem Symbol <span class="quote">&#8222;<span class="quote">®</span>&#8220;</span>
  gekennzeichnet.</p></div></div><div>Zuletzt bearbeitet am August 2000 von .</div><div><div xmlns="http://www.w3.org/1999/xhtml" class="abstract"><div class="abstract-title">Zusammenfassung</div><p>Willkommen zum Entwickler-Handbuch. Dieses Handbuch ist
	<span class="emphasis"><em>jederzeit unter Bearbeitung</em></span> und das
	Ergebnis der Arbeit vieler Einzelpersonen. Dies kann dazu
	führen, dass bestimmte Bereiche nicht mehr aktuell sind
	und auf den neuesten Stand gebracht werden müssen. Bei
	Unklarheiten empfiehlt es sich daher stets, auch die <a class="link" href="../../../../doc/en_US.ISO8859-1/books/developers-handbook/index.html" target="_top">
	englische Originalversion</a> des Handbuchs zu
	lesen.</p><p>Wenn Sie bei der Übersetzung dieses Handbuchs
	mithelfen möchten, senden Sie bitte eine E-Mail an die
	Mailingliste 'FreeBSD German Documentation Project'
  <code class="email">&lt;<a xmlns="" class="email" href="mailto:de-bsd-translators@de.FreeBSD.org">de-bsd-translators@de.FreeBSD.org</a>&gt;</code>.</p><p>Die aktuelle Version dieses Handbuchs ist immer auf dem
	<a class="link" href="http://www.FreeBSD.org/" target="_top">FreeBSD-Webserver</a>
	verfügbar und kann in verschiedenen Formaten und in
	komprimierter Form vom <a class="link" href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc" target="_top">FreeBSD-FTP-Server</a>
	oder einem der zahlreichen <a class="link" href="../../../../doc/de_DE.ISO8859-1/books/handbook/mirrors-ftp.html" target="_top">Spiegel</a>
	heruntergeladen werden (ältere Versionen finden Sie
	hingegen unter <code class="uri"><a class="uri" href="http://docs.FreeBSD.org/doc/" target="_top">http://docs.FreeBSD.org/doc/</a></code>).</p></div></div></div><div class="docformatnavi">
      [
      <a href="index.html">einzelne Abschnitte</a>
      /
      
	  komplettes Dokument
	
      ]
    </div><hr /></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="part"><a href="#Basics">I. Grundlagen</a></span></dt><dd><dl><dt><span class="chapter"><a href="#introduction">1. Einführung</a></span></dt><dd><dl><dt><span class="sect1"><a href="#introduction-devel">1.1. Unter FreeBSD entwickeln</a></span></dt><dt><span class="sect1"><a href="#introduction-bsdvision">1.2. Die Vision von BSD</a></span></dt><dt><span class="sect1"><a href="#introduction-archguide">1.3. Grundlegende Richtlinien</a></span></dt><dt><span class="sect1"><a href="#introduction-layout">1.4. Der Aufbau von
      <code class="filename">/usr/src</code></a></span></dt></dl></dd><dt><span class="chapter"><a href="#tools">2. Werkzeuge zur Programmierung</a></span></dt><dd><dl><dt><span class="sect1"><a href="#tools-synopsis">2.1. Überblick</a></span></dt><dt><span class="sect1"><a href="#tools-intro">2.2. Zusammenfassung</a></span></dt><dt><span class="sect1"><a href="#tools-programming">2.3. Einführung in die Programmierung</a></span></dt><dt><span class="sect1"><a href="#tools-compiling">2.4. Kompilieren mit dem <code class="command">cc</code></a></span></dt><dt><span class="sect1"><a href="#tools-make">2.5. Make</a></span></dt><dt><span class="sect1"><a href="#debugging">2.6. Debuggen</a></span></dt><dt><span class="sect1"><a href="#emacs">2.7. Emacs als Entwicklungsumgebung verwenden</a></span></dt><dt><span class="sect1"><a href="#tools-reading">2.8. Weiterführende Literatur</a></span></dt></dl></dd><dt><span class="chapter"><a href="#secure">3. Sicheres Programmieren</a></span></dt><dd><dl><dt><span class="sect1"><a href="#secure-synopsis">3.1. Zusammenfassung</a></span></dt><dt><span class="sect1"><a href="#secure-philosophy">3.2. Methoden des sicheren Entwurfs</a></span></dt><dt><span class="sect1"><a href="#secure-bufferov">3.3. Puffer-Überläufe</a></span></dt><dt><span class="sect1"><a href="#secure-setuid">3.4. SetUID-Themen</a></span></dt><dt><span class="sect1"><a href="#secure-chroot">3.5. Die Umgebung ihrer Programme einschränken</a></span></dt><dt><span class="sect1"><a href="#secure-trust">3.6. Vertrauen</a></span></dt><dt><span class="sect1"><a href="#secure-race-conditions">3.7. Race-Conditions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#l10n">4. Lokalisierung und Internationalisierung - L10N und
    I18N</a></span></dt><dd><dl><dt><span class="sect1"><a href="#l10n-programming">4.1. I18N-konforme Anwendungen programmieren</a></span></dt><dt><span class="sect1"><a href="#posix-nls">4.2. Lokalisierte Nachrichten mit POSIX.1 Native Language
      Support (NLS)</a></span></dt></dl></dd><dt><span class="chapter"><a href="#policies">5. Vorgaben und Richtlinien für das
    Quelltextverzeichnis</a></span></dt><dd><dl><dt><span class="sect1"><a href="#policies-style">5.1. Stil-Richtlinien</a></span></dt><dt><span class="sect1"><a href="#policies-maintainer">5.2. <code class="varname">MAINTAINER</code> eines Makefiles</a></span></dt><dt><span class="sect1"><a href="#policies-contributed">5.3. Beigesteuerte Software</a></span></dt><dt><span class="sect1"><a href="#policies-encumbered">5.4. Belastende Dateien</a></span></dt><dt><span class="sect1"><a href="#policies-shlib">5.5. Shared-Libraries</a></span></dt></dl></dd><dt><span class="chapter"><a href="#testing">6. Regressions- und Performance-Tests</a></span></dt><dd><dl><dt><span class="section"><a href="#testing-micro-benchmark">6.1. Mikro-Benchmark-Checkliste</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#ipc">II. Interprozess-Kommunikation</a></span></dt><dd><dl><dt><span class="chapter"><a href="#sockets">7. Sockets</a></span></dt><dt><span class="chapter"><a href="#ipv6">8. IPv6 Internals</a></span></dt><dd><dl><dt><span class="sect1"><a href="#ipv6-implementation">8.1. IPv6/IPsec-Implementierung</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#kernel">III. Kernel</a></span></dt><dd><dl><dt><span class="chapter"><a href="#kernelbuild">9. Einen FreeBSD-Kernel bauen und installieren</a></span></dt><dd><dl><dt><span class="sect1"><a href="#kernelbuild-traditional">9.1. Einen Kernel auf die <span class="quote">&#8222;<span class="quote">traditionelle</span>&#8220;</span> Art und
      Weise bauen</a></span></dt><dt><span class="sect1"><a href="#kernelbuild-new">9.2. Einen Kernel auf die <span class="quote">&#8222;<span class="quote">neue</span>&#8220;</span> Art und Weise
      bauen</a></span></dt></dl></dd><dt><span class="chapter"><a href="#kerneldebug">10. Kernel-Fehlersuche</a></span></dt><dd><dl><dt><span class="sect1"><a href="#kerneldebug-obtain">10.1. Besorgen eines Speicherauszugs nach einem
      Kernel-Absturz (Kernel-Crash-Dump)</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-gdb">10.2. Fehlersuche in einem Speicherauszug nach einem
      Kernel-Absturz mit <code class="command">kgdb</code></a></span></dt><dt><span class="sect1"><a href="#kerneldebug-ddd">10.3. Fehlersuche in einem Speicherauszug nach einem Absturz mit
      DDD</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-ddb">10.4. Online-Kernel-Fehlersuche mit DDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-gdb">10.5. Online-Kernel-Fehlersuche mit GDB auf einem entfernten
      System</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-console">10.6. Fehlersuche bei einem Konsolen-Treiber</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-deadlocks">10.7. Fehlersuche bei Deadlocks</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-options">10.8. Glossar der Kernel-Optionen zur Fehlersuche</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#architectures">IV. Architekturen</a></span></dt><dd><dl><dt><span class="chapter"><a href="#x86">11. x86-Assembler-Programmierung</a></span></dt><dd><dl><dt><span class="sect1"><a href="#x86-intro">11.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#x86-the-tools">11.2. Die Werkzeuge</a></span></dt><dt><span class="sect1"><a href="#x86-system-calls">11.3. Systemaufrufe</a></span></dt><dt><span class="sect1"><a href="#x86-return-values">11.4. Rückgabewerte</a></span></dt><dt><span class="sect1"><a href="#x86-portable-code">11.5. Portablen Code erzeugen</a></span></dt><dt><span class="sect1"><a href="#x86-first-program">11.6. Unser erstes Programm</a></span></dt><dt><span class="sect1"><a href="#x86-unix-filters">11.7. <span class="trademark">UNIX</span>®-Filter schreiben</a></span></dt><dt><span class="sect1"><a href="#x86-buffered-io">11.8. Gepufferte Eingabe und Ausgabe</a></span></dt><dt><span class="sect1"><a href="#x86-command-line">11.9. Kommandozeilenparameter</a></span></dt><dt><span class="sect1"><a href="#x86-environment">11.10. Die <span class="trademark">UNIX</span>®-Umgebung</a></span></dt><dt><span class="sect1"><a href="#x86-files">11.11. Arbeiten mit Dateien</a></span></dt><dt><span class="sect1"><a href="#x86-one-pointed-mind">11.12. One-Pointed Mind</a></span></dt><dt><span class="sect1"><a href="#x86-fpu">11.13. Die <acronym class="acronym">FPU</acronym> verwenden</a></span></dt><dt><span class="sect1"><a href="#x86-caveats">11.14. Vorsichtsmassnahmen</a></span></dt><dt><span class="sect1"><a href="#x86-acknowledgements">11.15. Danksagungen</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#appendices">V. Anhang</a></span></dt><dd><dl><dt><span class="bibliography"><a href="#idp68549968">Literaturverzeichnis</a></span></dt></dl></dd><dt><span class="index"><a href="#idp68599888">Stichwortverzeichnis</a></span></dt></dl></div><div class="list-of-examples"><div class="toc-title">Liste der Beispiele</div><dl><dt>2.1. <a href="#idp65742800">Eine einfache <code class="filename">.emacs</code>-Datei</a></dt></dl></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="Basics"></a>Teil I. Grundlagen</h1></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="chapter"><a href="#introduction">1. Einführung</a></span></dt><dd><dl><dt><span class="sect1"><a href="#introduction-devel">1.1. Unter FreeBSD entwickeln</a></span></dt><dt><span class="sect1"><a href="#introduction-bsdvision">1.2. Die Vision von BSD</a></span></dt><dt><span class="sect1"><a href="#introduction-archguide">1.3. Grundlegende Richtlinien</a></span></dt><dt><span class="sect1"><a href="#introduction-layout">1.4. Der Aufbau von
      <code class="filename">/usr/src</code></a></span></dt></dl></dd><dt><span class="chapter"><a href="#tools">2. Werkzeuge zur Programmierung</a></span></dt><dd><dl><dt><span class="sect1"><a href="#tools-synopsis">2.1. Überblick</a></span></dt><dt><span class="sect1"><a href="#tools-intro">2.2. Zusammenfassung</a></span></dt><dt><span class="sect1"><a href="#tools-programming">2.3. Einführung in die Programmierung</a></span></dt><dt><span class="sect1"><a href="#tools-compiling">2.4. Kompilieren mit dem <code class="command">cc</code></a></span></dt><dt><span class="sect1"><a href="#tools-make">2.5. Make</a></span></dt><dt><span class="sect1"><a href="#debugging">2.6. Debuggen</a></span></dt><dt><span class="sect1"><a href="#emacs">2.7. Emacs als Entwicklungsumgebung verwenden</a></span></dt><dt><span class="sect1"><a href="#tools-reading">2.8. Weiterführende Literatur</a></span></dt></dl></dd><dt><span class="chapter"><a href="#secure">3. Sicheres Programmieren</a></span></dt><dd><dl><dt><span class="sect1"><a href="#secure-synopsis">3.1. Zusammenfassung</a></span></dt><dt><span class="sect1"><a href="#secure-philosophy">3.2. Methoden des sicheren Entwurfs</a></span></dt><dt><span class="sect1"><a href="#secure-bufferov">3.3. Puffer-Überläufe</a></span></dt><dt><span class="sect1"><a href="#secure-setuid">3.4. SetUID-Themen</a></span></dt><dt><span class="sect1"><a href="#secure-chroot">3.5. Die Umgebung ihrer Programme einschränken</a></span></dt><dt><span class="sect1"><a href="#secure-trust">3.6. Vertrauen</a></span></dt><dt><span class="sect1"><a href="#secure-race-conditions">3.7. Race-Conditions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#l10n">4. Lokalisierung und Internationalisierung - L10N und
    I18N</a></span></dt><dd><dl><dt><span class="sect1"><a href="#l10n-programming">4.1. I18N-konforme Anwendungen programmieren</a></span></dt><dt><span class="sect1"><a href="#posix-nls">4.2. Lokalisierte Nachrichten mit POSIX.1 Native Language
      Support (NLS)</a></span></dt></dl></dd><dt><span class="chapter"><a href="#policies">5. Vorgaben und Richtlinien für das
    Quelltextverzeichnis</a></span></dt><dd><dl><dt><span class="sect1"><a href="#policies-style">5.1. Stil-Richtlinien</a></span></dt><dt><span class="sect1"><a href="#policies-maintainer">5.2. <code class="varname">MAINTAINER</code> eines Makefiles</a></span></dt><dt><span class="sect1"><a href="#policies-contributed">5.3. Beigesteuerte Software</a></span></dt><dt><span class="sect1"><a href="#policies-encumbered">5.4. Belastende Dateien</a></span></dt><dt><span class="sect1"><a href="#policies-shlib">5.5. Shared-Libraries</a></span></dt></dl></dd><dt><span class="chapter"><a href="#testing">6. Regressions- und Performance-Tests</a></span></dt><dd><dl><dt><span class="section"><a href="#testing-micro-benchmark">6.1. Mikro-Benchmark-Checkliste</a></span></dt></dl></dd></dl></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="introduction"></a>Kapitel 1. Einführung</h2></div><div><span class="authorgroup">Beigetragen von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Murray</span> <span class="surname">Stokely</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jeroen</span> <span class="surname">Ruigrok van der Werven</span></span>. </span></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Fabian</span> <span class="surname">Borschel</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#introduction-devel">1.1. Unter FreeBSD entwickeln</a></span></dt><dt><span class="sect1"><a href="#introduction-bsdvision">1.2. Die Vision von BSD</a></span></dt><dt><span class="sect1"><a href="#introduction-archguide">1.3. Grundlegende Richtlinien</a></span></dt><dt><span class="sect1"><a href="#introduction-layout">1.4. Der Aufbau von
      <code class="filename">/usr/src</code></a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="introduction-devel"></a>1.1. Unter FreeBSD entwickeln</h2></div></div></div><p>Hier sind wir also. Ihr System ist vollständig
      installiert und Sie wollen mit dem Programmieren beginnen.
      Aber womit sollen Sie anfangen? Was bietet Ihnen FreeBSD?
      Was kann es für einen Programmierer tun?</p><p>Dies sind einige der Fragen, welche dieses Handbuch
      zu beantworten versucht. Natürlich gibt es, analog zu
      anderen Berufen, auch bei Programmierern unterschiedliche
      Leistungsniveaus. Für die einen ist es ein Hobby,
      für die anderen ist es der Beruf. Die Informationen
      in diesem Kapitel dürften eher für den
      Programmieranfänger geeignet sein; allerdings könnte
      es auch für Programmierer, die bisher nichts mit der
      FreeBSD-Plattform zu tun hatten, interessante Informationen
      enthalten.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="introduction-bsdvision"></a>1.2. Die Vision von BSD</h2></div></div></div><p>Ziel ist es, das bestmögliche <span class="trademark">UNIX</span>®-artige
      Betriebssystempaket zu erstellen, mit dem gebührenden
      Respekt gegenüber der Ideologie der ursprünglichen
      Software, sowie der Bedienbarkeit, Leistungsfähigkeit und
      Stabilität.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="introduction-archguide"></a>1.3. Grundlegende Richtlinien</h2></div></div></div><p>Unsere Ideologie kann durch die folgenden Leitfäden
      beschrieben werden.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Füge keine neue Funktionalität hinzu, solange
	  ein Programmierer diese nicht zur Fertigstellung einer
	  realen Anwendung benötigt.</p></li><li class="listitem"><p>Zu entscheiden, was ein System ist, ist genauso
	  wichtig wie zu entscheiden, was ein System nicht ist.
	  Versuchen Sie nicht, alle möglichen Wünsche zu
	  erfüllen; machen Sie lieber das System erweiterbar, so
	  dass zusätzliche Bedürfnisse in einer
	  aufwärtskompatiblen Weise bedient werden
	  können.</p></li><li class="listitem"><p>Das Einzige, das schlimmer ist, als von einem Beispiel
	  auf die Allgemeinheit zu schließen, ist, von
	  überhaupt keinem Beispiel auf die Allgemeinheit zu
	  schließen.</p></li><li class="listitem"><p>Solange ein Problem nicht vollständig verstanden
	  wurde, ist es besser, keine Lösung
	  bereitzustellen.</p></li><li class="listitem"><p>Wenn Sie 90% des gewünschten Effektes bei nur 10%
	  des Aufwands erreichen können, sollten Sie besser die
	  einfachere Lösung verwenden.</p></li><li class="listitem"><p>Grenzen Sie Komplexität so gut wie möglich
	  ein.</p></li><li class="listitem"><p>Stellen Sie Mechanismen anstelle von Strategien bereit.
	  Überlassen Sie insbesondere Strategien für die
	  Benutzerschnittstelle dem Benutzerprogramm.</p></li></ul></div><p>Aus Scheifler &amp; Gettys: "X Window System"</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="introduction-layout"></a>1.4. Der Aufbau von
      <code class="filename">/usr/src</code></h2></div></div></div><p>Der vollständige Quelltext von FreeBSD ist über
      unser öffentliches Repository verfügbar. Der
      Quelltext wird normalerweise in <code class="filename">/usr/src</code> abgelegt und enthält
      die folgenden Unterverzeichnisse:</p><p>
      </p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><thead><tr><th>Verzeichnis</th><th>Beschreibung</th></tr></thead><tbody><tr><td><code class="filename">bin/</code></td><td>Quelldateien für Dateien in
		<code class="filename">/bin</code></td></tr><tr><td><code class="filename">cddl/</code></td><td>Quelldateien für Programme, die unter
		der Common Development and Distribution License
		stehen</td></tr><tr><td><code class="filename">contrib/</code></td><td>Quelldateien für Dateien von beigesteuerter
		Software</td></tr><tr><td><code class="filename">crypto/</code></td><td>Quelldateien für die Kryptographie</td></tr><tr><td><code class="filename">etc/</code></td><td>Quelldateien für Dateien in <code class="filename">/etc</code></td></tr><tr><td><code class="filename">games/</code></td><td>Quelldateien für Dateien in <code class="filename">/usr/games</code></td></tr><tr><td><code class="filename">gnu/</code></td><td>Programme, die unter der GNU Public License
		stehen</td></tr><tr><td><code class="filename">include/</code></td><td>Quelldateien für Dateien in <code class="filename">/usr/include</code></td></tr><tr><td><code class="filename">kerberos5/</code></td><td>Quelldateien für Kerberos Version 5</td></tr><tr><td><code class="filename">lib/</code></td><td>Quelldateien für Dateien in <code class="filename">/usr/lib</code></td></tr><tr><td><code class="filename">libexec/</code></td><td>Quelldateien für Dateien in <code class="filename">/usr/libexec</code></td></tr><tr><td><code class="filename">release/</code></td><td>Dateien, die für die Erstellung eines
		FreeBSD-Releases nötig sind</td></tr><tr><td><code class="filename">rescue/</code></td><td>Bausystem für die <code class="filename">/rescue</code>-Programme</td></tr><tr><td><code class="filename">sbin/</code></td><td>Quelldateien für Dateien in <code class="filename">/sbin</code></td></tr><tr><td><code class="filename">secure/</code></td><td>Quelldateien für FreeSec</td></tr><tr><td><code class="filename">share/</code></td><td>Quelldateien für Dateien in <code class="filename">/usr/share</code></td></tr><tr><td><code class="filename">sys/</code></td><td>Kernel-Quelldateien</td></tr><tr><td><code class="filename">tools/</code></td><td>Programme zum Verwalten und Testen von
		FreeBSD</td></tr><tr><td><code class="filename">usr.bin/</code></td><td>Quelldateien für Dateien in <code class="filename">/usr/bin</code></td></tr><tr><td><code class="filename">usr.sbin/</code></td><td>Quelldateien für Dateien in <code class="filename">/usr/sbin</code></td></tr></tbody></table></div><p>
    </p></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="tools"></a>Kapitel 2. Werkzeuge zur Programmierung</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">James</span> <span class="surname">Raynard</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Murray</span> <span class="surname">Stokely</span></span>. </span></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Dirk</span> <span class="surname">Arlt</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Fabian</span> <span class="surname">Borschel</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#tools-synopsis">2.1. Überblick</a></span></dt><dt><span class="sect1"><a href="#tools-intro">2.2. Zusammenfassung</a></span></dt><dt><span class="sect1"><a href="#tools-programming">2.3. Einführung in die Programmierung</a></span></dt><dt><span class="sect1"><a href="#tools-compiling">2.4. Kompilieren mit dem <code class="command">cc</code></a></span></dt><dt><span class="sect1"><a href="#tools-make">2.5. Make</a></span></dt><dt><span class="sect1"><a href="#debugging">2.6. Debuggen</a></span></dt><dt><span class="sect1"><a href="#emacs">2.7. Emacs als Entwicklungsumgebung verwenden</a></span></dt><dt><span class="sect1"><a href="#tools-reading">2.8. Weiterführende Literatur</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-synopsis"></a>2.1. Überblick</h2></div></div></div><p>Dieses Kapitel ist eine Einführung in die Benutzung
      einiger der Werkzeuge zur Programmierung die mit FreeBSD
      ausgeliefert werden. Trotzdem ist vieles auch auf verschiedene
      andere Versionen von <span class="trademark">UNIX</span>® übertragbar. Dieses Kapitel
      soll <span class="emphasis"><em>kein</em></span> Versuch sein Programmierung
      detailliert zu beschreiben. Der größte Teil dieses
      Kapitels setzt wenige oder gar keine Programmierkenntnisse
      voraus, dennoch sollten die meisten Programmierer etwas
      Sinnvolles darin finden.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-intro"></a>2.2. Zusammenfassung</h2></div></div></div><p>FreeBSD bietet eine exzellente Entwicklungsumgebung.
      Compiler für C und C++, sowie ein Assembler sind im
      Basissystem enthalten. Natürlich finden
      sich auch klassische <span class="trademark">UNIX</span>®-Werkzeuge wie <code class="command">sed</code>
      und <code class="command">awk</code>.  Sollte das nicht genug sein, finden sich
      zahlreiche weitere Compiler und Interpreter in der Ports-Sammlung.
      Der folgende Abschnitt, <a class="link" href="#tools-programming" title="2.3. Einführung in die Programmierung">Einführung in die Programmierung</a>,
      zählt ein paar der verfügbaren Optionen auf.  FreeBSD ist
      kompatibel zu vielen Standards wie <acronym class="acronym"><span class="trademark">POSIX</span>®</acronym>
      und <acronym class="acronym">ANSI</acronym> C, sowie zu seinem eigenen BSD Erbe. So
      ist es möglich Anwendungen zu schreiben, welche ohne oder
      zumindest ohne wesentliche Änderungen auf einer
      großen Zahl an Plattformen kompilieren und laufen
      werden.</p><p>Allerdings können all diese Möglichkeiten
      anfangs etwas überwältigend sein, wenn Sie vorher nie
      Programme auf einem <span class="trademark">UNIX</span>®-System geschrieben haben. Dieses
      Dokument hat die Zielsetzung ihnen beim Einstieg zu helfen ohne
      allzu weit in fortgeschrittene Themen vorzudringen. Die
      Intention ist, daß dieses Dokument ihnen ausreichend
      Basiswissen vermittelt und die weitergehende Dokumentation
      sinnvoll nutzen zu können.</p><p>Der größte Teil dieses Dokuments erfordert wenige
      oder gar keine Kenntnisse in der Programmierung, es werden
      trotzdem Basiswissen im Umgang mit <span class="trademark">UNIX</span>® und die Bereitschaft
      zu lernen vorausgesetzt!</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-programming"></a>2.3. Einführung in die Programmierung</h2></div></div></div><p>Ein Programm ist eine Zusammenstellung von Anweisungen, die
      den Computer auffordern verschiedenste Dinge zu tun. Dieser
      Abschnitt gibt ihnen einen Überblick über die beiden
      wesentlichen Methoden diese Anweisungen oder
      <span class="quote">&#8222;<span class="quote">Befehle</span>&#8220;</span>, wie man diese Anweisungen
      üblicherweise nennt, zu geben. Die eine Methode nutzt einen
      <em class="firstterm">Interpreter</em>, die andere einen
      <em class="firstterm">Compiler</em>. Da menschliche Sprachen
      für einen Computer nicht unmissverständlich sind,
      werden diese Befehle in einer Sprache geschrieben die speziell
      für diesen Zweck gedacht ist.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62135760"></a>2.3.1. Interpreter</h3></div></div></div><p>Mit einem Interpreter ist die Sprache vielmehr eine
	Umgebung, in der Sie ein Kommando an der Kommandozeile
	eingeben welches dann von der Umgebung ausgeführt wird.
	Für kompliziertere Programme können Sie die Befehle
	in eine Datei schreiben und den Interpreter dazu bringen diese
	Datei zu laden und die enthaltenen Befehle auszuführen.
	Falls etwas schief geht werden viele Interpreter Sie an einen
	Debugger weiterleiten.</p><p>Der Vorteil hierbei ist, das Sie das Ergebnis ihres
	Befehls direkt sehen und Fehler sofort korrigiert werden
	können. Der größte Nachteil bei dieser Methode
	entsteht, wenn Sie ihr Programm mit jemandem teilen wollen.
	Diese Person muss den selben Interpreter nutzen wie Sie es tun
	und Sie muss wissen wie dieser zu bedienen ist.
	Zudem werden Benutzer es nicht begrüßen sich in
	einem Debugger wiederzufinden, wenn Sie einmal die falsche
	Taste drücken! Bei einem Blick auf die
	Leistungsfähigkeit brauchen Interpreter oftmals viel
	Speicher und erzeugen den Code nicht so effizient wie
	Compiler.</p><p>Meiner Meinung nach sind interpretierte Sprachen der beste
	Anfang, wenn Sie bisher noch nicht programmiert haben. Diese
	Art von Umgebung findet man typischerweise bei Sprachen wie
	Lisp, Smalltalk, Perl und Basic. Man könnte auch sagen,
	dass die <span class="trademark">UNIX</span>® Shell (<code class="command">sh</code>,
	<code class="command">csh</code>) für sich bereits einen
	Interpreter darstellt und viele Leute schreiben
	tatsächlich Shell <span class="quote">&#8222;<span class="quote">Scripten</span>&#8220;</span> um sich bei
	einigen <span class="quote">&#8222;<span class="quote">Haushaltsaufgaben</span>&#8220;</span> auf ihren Maschinen
	helfen zu lassen. Tatsächlich war es ein wesentlicher
	Teil der originalen <span class="trademark">UNIX</span>® Philosophie eine große Zahl
	an kleinen Hilfsprogrammen zur Verfügung zu stellen,
	welche mittels eines Shellskripts miteinander kombiniert werden
	um bestimmte Aufgaben zu übernehmen.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62156752"></a>2.3.2. Für FreeBSD verfügbare Interpreter</h3></div></div></div><p>Im folgenden eine Liste der über die FreeBSD
	Ports-Sammlung verfügbaren Interpreter
	einschließlich einer kurzen Erörterung der
	populären interpretierten Sprachen.</p><p>Anleitungen wie man Anwendungen aus der Ports-Sammlung
	erhält und installiert können Sie dem Kapitel <a class="link" href="../../../../doc/de_DE.ISO8859-1/books/handbook/ports-using.html" target="_top">Benutzen der
	Ports-Sammlung</a> aus dem FreeBSD Handbuch
	entnehmen.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><acronym class="acronym">BASIC</acronym></span></dt><dd><p>Kurz für Beginner's All-purpose Symbolic
	      Instruction Code. Entwickelt in den 50er Jahren um
	      Studenten in Programmierung zu unterrichten, wurde
	      <acronym class="acronym">BASIC</acronym> in den 80er Jahren mit jedem
	      anständigen Personal Computer ausgeliefert und war
	      für viele Programmierer die erste
	      Programmiersprache. <acronym class="acronym">BASIC</acronym> ist auch
	      die Grundlage für Visual Basic.</p><p>Der Bywater Basic Interpreter findet sich in der
	      Ports-Sammlung unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/bwbasic/pkg-descr">lang/bwbasic</a> und Phil
	      Cockroft's Basic Interpreter (auch bekannt als Rabbit
	      Basic) findet sich unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/pbasic/pkg-descr">lang/pbasic</a>.</p></dd><dt><span class="term">Lisp</span></dt><dd><p>Diese Sprache wurde in den späten 50er Jahren
	      als Alternative zu den, zu dieser Zeit populären,
	      <span class="quote">&#8222;<span class="quote">zahlenverarbeitenden</span>&#8220;</span> Sprachen entwickelt.
	      Anstelle auf Zahlen basiert Lisp auf Listen;
	      tatsächlich ist der Name Lisp eine Kurzform
	      für <span class="quote">&#8222;<span class="quote">List Processing</span>&#8220;</span> (Listen
	      abarbeiten). Sehr populär fü
	      <acronym class="acronym">AI</acronym> (Artificial Intelligence/
	      künstliche Intelligez) (Fach-) Kreisen.</p><p>Lisp ist eine extrem kraftvolle und durchdachte
	      Sprache, kann aber auch recht groß und unhandlich
	      sein.</p><p>Zahlreiche Ausformungen von Lisp, die auf <span class="trademark">UNIX</span>®
	      Systemen laufen sind über die Ports-Sammlung
	      verfügbar. GNU Common Lisp befindet sich in
	      <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/gcl/pkg-descr">lang/gcl</a>. CLISP von
	      Bruno Haible und Michael Stoll ist in <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/clisp/pkg-descr">lang/clisp</a> zu finden. Für
	      CMUCL, welches auch einen hoch-optimierten Compiler
	      enthält, oder einfachere Ausformungen wie SLisp,
	      das die meisten gängigen Lisp Konstrukte in wenigen
	      hundert Zeilen C Code enthält sind in <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/cmucl/pkg-descr">lang/cmucl</a> und <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/slisp/pkg-descr">lang/slisp</a> ebenfalls
	      enthalten.</p></dd><dt><span class="term">Perl</span></dt><dd><p>Unter Systemadministratoren zum Schreiben von
	      Skripten sehr beliebt; wird häufig auch auf World
	      Wide Web Servern verwendet, um
	      <acronym class="acronym">CGI</acronym>-Skripte zu schreiben.</p><p>Perl ist in der Ports-Sammlung unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/perl5.8/pkg-descr">lang/perl5.8</a> für alle
	      FreeBSD-Versionen verfügbar, und wird im Basissystem
	      von 4.x als <code class="command">/usr/bin/perl</code>
	      installiert.</p></dd><dt><span class="term">Scheme</span></dt><dd><p>Ein Dialekt von Lisp, der kompakter und sauberer
	      als Common Lisp ist. Dieser Dialekt ist an
	      Universitäten sehr beliebt, da er zum einen
	      für den Unterricht im Grundstudium einfach genug
	      ist, und zum anderen ein ausreichend hohes
	      Abstraktionsniveau für den Einsatz in der Forschung
	      bietet.</p><p>Scheme ist in der Ports-Sammlung in Form des Elk
	      Scheme Interpreters als <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/elk/pkg-descr">lang/elk</a> verfügbar. Den
	      MIT Scheme Interpreter findet man unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/mit-scheme/pkg-descr">lang/mit-scheme</a>, und den SCM
	      Scheme Interpreter unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/scm/pkg-descr">lang/scm</a>.</p></dd><dt><span class="term">Icon</span></dt><dd><p>Icon ist eine Hochsprache mit ausgereiften
	      Möglichkeiten zur Verarbeitung von Zeichenketten
	      und Strukturen. Die unter FreeBSD verfügbare Version
	      von Icon steht in der Ports-Sammlung unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/icon/pkg-descr">lang/icon</a> zur
	      Verfügung.</p></dd><dt><span class="term">Logo</span></dt><dd><p>Logo ist eine leicht zu erlernende
	      Programmiersprache, welche in vielen Kursen als
	      einführende Programmiersprache gewählt wird.
	      Sie ist ein ideales Arbeitswerkzeug beim Unterricht mit
	      jungen Menschen, da mit ihr die Erstellung komplizierter
	      geometrischer Oberflächen selbst für kleine
	      Kinder einfach ist.</p><p>Die für FreeBSD aktuellste, verfügbare
	      Version findet man in der Ports-Sammlung unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/logo/pkg-descr">lang/logo</a>.</p></dd><dt><span class="term">Python</span></dt><dd><p>Python ist eine objektorientierte, interpretierte
	      Programmiersprache. Die Verfechter von Python
	      argumentieren, daß sie eine der besten
	      Programmiersprachen für Programmieranfänger
	      sei, da sie einfach zu erlernen ist, und anderen
	      populären interpretierten Programmiersprachen,
	      welche zur Entwicklung großer und komplexer
	      Anwendungen verwendet werden, in nichts nachsteht (Perl
	      und Tcl sind zwei solcher bekannten
	      Programmiersprachen).</p><p>Die aktuellste Version von Python ist in der
	      Ports-Sammlung unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/python/pkg-descr">lang/python</a>
	      verfügbar.</p></dd><dt><span class="term">Ruby</span></dt><dd><p>Ruby ist eine interpretierte und rein
	      objektorientierte Programmiersprache. Sie wurde wegen
	      ihrer leicht verständlichen Syntax, ihrer
	      Flexibilität und der Möglichkeit, große und
	      komplexe Programme einfach zu entwickeln und zu pflegen,
	      populär.</p><p>Ruby ist in der Ports-Sammlung unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/ruby18/pkg-descr">lang/ruby18</a>
	      verfügbar.</p></dd><dt><span class="term">Tcl und Tk</span></dt><dd><p>Tcl ist eine einbettbare, interpretierte
	      Programmiersprache, welche aufgrund ihrer Portierbarkeit
	      auf viele unterschiedliche Plattformen eine weite
	      Verbreitung erfahren hat. Sie kann sowohl für die
	      schnelle Entwicklung kleinerer Prototypen, als auch (in
	      Verbindung mit Tk, einem GUI Toolkit) vollwertiger,
	      ausgereifter Programme verwendet werden.</p><p>Es sind mehrere Versionen von Tcl als Ports
	      für FreeBSD verfügbar. Die aktuellste Version,
	      Tcl 8.5, ist unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/tcl85/pkg-descr">lang/tcl85</a>
	      verfügbar.</p></dd></dl></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62242512"></a>2.3.3. Compiler</h3></div></div></div><p>Compiler sind eher anders. Zuerst schreibt man seinen
	Code unter Verwendung eines Editors in eine Datei (oder
	mehrere Dateien). Anschließend ruft man den Compiler auf
	um zu sehen, ob dieser das Programm annimmt. Wenn das Programm
	nicht kompiliert werden konnte, muß man die Zähne
	zusammenbeissen und wieder zum Editor zurückkehren; falls
	das Programm kompiliert und eine ausführbare Anwendung
	erzeugt wurde, kann man diese über eine
	Eingabeaufforderung oder über einen Debugger aufrufen um
	zu sehen, ob sie auch funktioniert.

	<a href="#ftn.idp62243792" class="footnote" id="idp62243792"><sup class="footnote">[1]</sup></a>
      </p><p>Offensichtlich ist diese Art der Programmierung nicht
	so direkt wie die Verwendung eines Interpreters. Jedoch sind
	auf diese Weise viele Dinge möglich, die mit einem
	Interpreter nur sehr schwer oder überhaupt nicht
	realisierbar wären, wie z.B. das Schreiben von Code, der
	sehr eng mit dem Betriebsystem zusammen arbeitet&#8212;oder
	das Schreiben eines eigenen Betriebsystems selbst! Des
	weiteren ist so das Erzeugen von sehr effizientem Code
	möglich, da sich der Compiler für die Optimierung
	Zeit nehmen kann, was bei einem Interpreter inakzeptabel
	wäre. Ferner ist das Verbreiten von Programmen, welche
	für einen Compiler geschrieben wurden, einfacher als
	welche, die für einen Interpreter geschrieben
	wurden&#8212;man muss in ersterem Fall nur die
	ausführbare Datei verbreiten, vorausgesetzt, daß das
	gleiche Betriebssystem verwendet wird.</p><p>Programmiersprachen, die kompiliert werden, sind unter
	anderem Pascal, C und C++. C und C++ sind eher unbarmherzige
	Programmiersprachen und daher eher für erfahrene
	Programmierer gedacht; Pascal auf der anderen Seite wurde zu
	Ausbildungszwecken entworfen, und stellt daher eine
	einsteigerfreundliche Programmiersprache dar. FreeBSD
	beinhaltet im Basissystem keine Unterstützung für
	Pascal, stellt jedoch über die Ports-Sammlung den
	Free Pascal Compiler unter <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/lang/fpc/pkg-descr">lang/fpc</a> zur Verfügung.</p><p>Da der editier-kompilier-ausführ-debug-Kreislauf
	unter Verwendung mehrerer Programme eher mühsam ist haben
	viele Hersteller von Compilern integrierte
	Entwicklungsumgebungen (Integrated Development Environment;
	auch kurz <acronym class="acronym">IDE</acronym>) entwickelt. FreeBSD bietet
	zwar im Basissystem keine IDE an, stellt jedoch über die
	Ports-Sammlung IDEs wie <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/devel/kdevelop/pkg-descr">devel/kdevelop</a> oder
	<span class="application">Emacs</span> zur Verfügung, wobei
	letztere weit verbreitet ist. Die Verwendung von
	<span class="application">Emacs</span> als IDE wird unter <a class="xref" href="#emacs" title="2.7. Emacs als Entwicklungsumgebung verwenden">Abschnitt 2.7, &#8222;Emacs als Entwicklungsumgebung verwenden&#8220;</a> diskutiert.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-compiling"></a>2.4. Kompilieren mit dem <code class="command">cc</code></h2></div></div></div><p>Dieser Abschnitt behandelt ausschließlich den GNU
      Compiler für C und C++, da dieser bereits im Basissystem
      von FreeBSD enthalten ist. Er kann mittels <code class="command">cc</code>
      oder <code class="command">gcc</code> aufgerufen werden. Die Details zur
      Erstellung einer Anwendung mit einem Interpreter variieren
      zwischen verschiedenen Interpretern mehr oder weniger stark, und
      werden meist ausführlich in der zugehörigen
      Dokumentation oder Online-Hilfe beschrieben.</p><p>Sobald
      Sie Ihr Meisterwerk fertig geschrieben haben besteht der
      nächste Schritt darin, dieses (hoffentlich!) unter FreeBSD
      zum Laufen zu bekommen. Dies beinhaltet üblicherweise
      mehrere Schritte, wobei jeder einzelne Schritt von einem
      separaten Programm durchgeführt wird.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Aufbereiten Ihres Quelltextes durch Entfernen von
	  Kommentaren, sowie weiteren Tricks wie das Ersetzen von
	  Macros in C.</p></li><li class="step"><p>Überprüfen der Syntax Ihres Quelltextes, um
	  die Einhaltung der Sprachregeln sicherzustellen. Wenn Sie
	  diese verletzt haben werden entsprechende Fehlermeldungen
	  Ihnen dies mitteilen!</p></li><li class="step"><p>Übersetzen des Quelltextes in Assemblersprache
	  &#8212;diese ist dem eigentlichen Maschinencode schon sehr
	  nahe, jedoch immer noch für Menschen lesbar.
	  Angeblich.

	  <a href="#ftn.idp62267472" class="footnote" id="idp62267472"><sup class="footnote">[2]</sup></a>
	</p></li><li class="step"><p>Übersetzen der Assemblersprache in
	  Maschinencode&#8212;genau, wir sprechen hier von Bits und
	  Bytes, Einsen und Nullen.</p></li><li class="step"><p>Überprüfen, ob Sie Dinge wie Funktionen und
	  globale Variablen in einheitlicher Weise verwendet haben.
	  Wenn Sie z.B. eine nicht existierende Funktion aufgerufen
	  haben, wird eine entsprechende Fehlermeldung Ihnen dies
	  mitteilen.</p></li><li class="step"><p>Wenn aus mehreren Quelltextdateien eine
	  ausführbare Datei erstellt werden soll wird
	  herausgefunden, wie die einzelnen Codeteile
	  zusammengefügt werden müssen.</p></li><li class="step"><p>Ausarbeiten, wie das Programm aussehen muss, damit
	  der Lader zur Laufzeit des Systems dieses in den Speicher
	  laden und ausführen kann.</p></li><li class="step"><p>Endgültiges Schreiben der ausführbaren Datei
	  in das Dateisystem.</p></li></ol></div><p>Das Wort <em class="firstterm">kompilieren</em> wird häufig
      für die Schritte 1 bis 4 verwendet&#8212;die anderen werden
      mit dem Wort <em class="firstterm">verlinken</em> zusammengefasst.
      Manchmal wird Schritt 1 auch als
      <em class="firstterm">Pre-Processing</em> und die Schritte 3-4 als
      <em class="firstterm">assemblieren</em> bezeichnet.</p><p>Glücklicherweise werden alle diese Details vor Ihnen
      verborgen, da <code class="command">cc</code> ein Frontend ist, welches
      sich um die Ausführung all dieser Programme mit den
      richtigen Argumenten für Sie kümmert; einfaches
      eingeben von</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc foobar.c</code></strong></pre><p>führt zur Übersetzung von
      <code class="filename">foobar.c</code> durch alle bereits erwähnten
      Schritte. Wenn Sie mehr als eine Datei übersetzen wollen
      müssen Sie etwas wie folgt eingeben</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc foo.c bar.c</code></strong></pre><p>Beachten Sie, daß die Überprüfung der Syntax
      genau dies tut&#8212;das reine Überprüfen der Syntax.
      Es findet keine Überprüfung bzgl. logischer Fehler
      statt, die Sie vielleicht gemacht haben, wie z.B. das Programm
      in eine Endlosschleife zu versetzen, oder Bubble Sort zu
      verwenden, wenn Sie eigentlich Binary Sort benutzen wollten.

      <a href="#ftn.idp62317008" class="footnote" id="idp62317008"><sup class="footnote">[3]</sup></a>
    </p><p>Es gibt haufenweise Optionen für <code class="command">cc</code>,
      die alle in der zugehörigen Manualpage beschrieben werden.
      Im Folgenden werden ein paar der wichtigsten Optionen mit
      Beispielen ihrer Anwendung gezeigt.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-o <em class="replaceable"><code>filename</code></em></code></span></dt><dd><p>Die Name der Ausgabedatei. Wenn Sie diese Option nicht
	    verwenden erstellt <code class="command">cc</code> eine Datei mit
	    dem Namen <code class="filename">a.out</code>.

	    <a href="#ftn.idp62335824" class="footnote" id="idp62335824"><sup class="footnote">[4]</sup></a>
	  </p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc foobar.c</code></strong>               <em class="lineannotation"><span class="lineannotation">executable is a.out</span></em>
<code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.c</code></strong>     <em class="lineannotation"><span class="lineannotation">executable is foobar</span></em>
	    </pre></div></dd><dt><span class="term"><code class="option">-c</code></span></dt><dd><p>Dies kompiliert die Datei nur, verlinkt sie jedoch
	    nicht. Nützlich für Spielereien, um die Syntax
	    auf Korrektheit zu überprüfen, oder falls Sie
	    ein <code class="filename">Makefile</code> verwenden.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -c foobar.c</code></strong>
	    </pre></div><p>Dieser Befehl erzeugt eine
	    <em class="firstterm">Objektdatei</em> (nicht ausführbar)
	    mit den Namen <code class="filename">foobar.o</code>. Diese kann
	    mit anderen Objektdateien zusammen zu einer
	    ausführbaren Datei verlinkt werden.</p></dd><dt><span class="term"><code class="option">-g</code></span></dt><dd><p>Diese Option erzeugt die Debug-Version einer
	    ausführbaren Datei. Dabei fügt der Compiler
	    zusätzliche Informationen darüber, welcher
	    Funktionsaufruf zu welcher Zeile im Quelltext gehört,
	    der ausführbaren Datei hinzu. Ein Debugger kann Ihnen
	    mit Hilfe dieser Information den zugehörigen
	    Quelltext anzeigen, während Sie den Programmverlauf
	    schrittweise verfolgen, was <span class="emphasis"><em>sehr</em></span>
	    hilfreich sein kann; der Nachteil dabei ist, daß
	    durch die zusätzlichen Informationen das Programm
	    viel größer wird. Normalerweise verwendet man
	    die Option <code class="option">-g</code> während der
	    Entwicklung eines Programms, und für die
	    <span class="quote">&#8222;<span class="quote">Release-Version</span>&#8220;</span>, wenn man von der
	    Korrektheit des Programms überzeugt ist, kompiliert
	    man das Programm dann ohne diese Option.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -g foobar.c</code></strong>
	    </pre></div><p>Mit diesem Befehl wird eine Debug-Version des
	    Programms erzeugt.

	    <a href="#ftn.idp62375888" class="footnote" id="idp62375888"><sup class="footnote">[5]</sup></a>
	  </p></dd><dt><span class="term"><code class="option">-O</code></span></dt><dd><p>Diese Option erzeugt eine optimierte Version der
	    ausführbaren Datei. Der Compiler verwendet einige
	    clevere Tricks, um das erzeugte Programm schneller zu
	    machen. Sie können hinter der Option
	    <code class="option">-O</code> eine Zahl angeben, um eine
	    höheres Level der Optimierung festzulegen. Dadurch
	    wird jedoch häufig eine fehlerhafte Optimierung
	    seitens des Compilers aufgedeckt. Zum Beispiel erzeugte
	    die Version des <code class="command">cc</code>, welche mit dem
	    FreeBSD Release 2.1.0 mitgeliefert wurde, bei Verwendung
	    der Option <code class="option">-O2</code> unter bestimmten
	    Umständen falschen Code.</p><p>Optimierungen werden normalerweise nur beim
	    Kompilieren von Release-Versionen aktiviert.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -O -o foobar foobar.c</code></strong>
	    </pre></div><p>Durch diesen Befehl wird eine optimierte Version von
	    <code class="filename">foobar</code> erzeugt.</p></dd></dl></div><p>Die folgenden drei Flags zwingen den <code class="command">cc</code>
      dazu, Ihren Code auf die Einhaltung der internationalen
      Standards hin zu überprüfen, welche häufig als
      <acronym class="acronym">ANSI</acronym> Standards bezeichnet werden, obwohl sie
      streng genommen zum <acronym class="acronym">ISO</acronym> Standard
      gehören.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-Wall</code></span></dt><dd><p>Aktivieren aller Warnmeldungen, die die Autoren des
	    <code class="command">cc</code> für wichtig halten. Trotz des
	    Namens dieser Option werden dadurch nicht sämtliche
	    Warnungen ausgegeben, die der <code class="command">cc</code>
	    ausgeben könnte.</p></dd><dt><span class="term"><code class="option">-ansi</code></span></dt><dd><p>Deaktivieren der meisten, jedoch nicht aller,
	    nicht-<acronym class="acronym">ANSI</acronym> C Eigenschaften, die
	    der <code class="command">cc</code> bietet. Trotz des Namens ist
	    durch diese Option nicht sichergestellt, daß Ihr
	    Code diese Standards auch vollständig
	    einhält.</p></dd><dt><span class="term"><code class="option">-pedantic</code></span></dt><dd><p>Deaktivieren <span class="emphasis"><em>aller</em></span> Eigenschaften
	    des <code class="command">cc</code>, welche nicht konform zu
	    <acronym class="acronym">ANSI</acronym> C sind.</p></dd></dl></div><p>Ohne diese Flags wird Ihnen der <code class="command">cc</code> die
      Verwendung eigener Erweiterungen des Standards erlauben. Einige
      dieser Erweiterungen sind zwar sehr nützlich, werden jedoch
      nicht von anderen Compilern unterstützt&#8212;eigentlich
      ist eines der Hauptziele des Standards, das Leute Code so
      schreiben können, daß dieser mit jedem Compiler auf
      beliebigen Systemen funktioniert. Dies wird häufig als
      <em class="firstterm">portabler Code</em> bezeichnet.</p><p>Im Allgemeinen sollten Sie versuchen, Ihren Code so portabel
      wie möglich zu schreiben, da Sie ansonsten eventuell das
      gesamte Programm noch einmal neu schreiben müssen, falls
      dieser in einer anderen Umgebung laufen soll&#8212;und wer
      weiß schon was er in ein paar Jahren verwenden
      wird?</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -Wall -ansi -pedantic -o foobar foobar.c</code></strong></pre></div><p>Durch diesen Befehl wird eine ausführbare Datei namens
      <code class="filename">foobar</code> erzeugt, nachdem
      <code class="filename">foobar.c</code> auf die Einhaltung der Standards
      überprüft wurde.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-l<em class="replaceable"><code>library</code></em></code></span></dt><dd><p>Mit dieser Option kann eine Bibliothek mit Funktionen
	    angegeben werden, die während des Verlinkens
	    verwendet wird.</p><p>Das am häufigsten auftretende Beispiel dieser
	    Option ist die Übersetzung eines Programmes, welches
	    einige der mathematischen Funktionen in C verwendet. Im
	    Gegensatz zu den meisten anderen Plattformen befinden sich
	    diese Funktionen in einer separaten Bibliothek, deren
	    Verwendung Sie dem Compiler explizit mitteilen
	    müssen.</p><p>Angenommen eine Bibliothek heißt
	    <code class="filename">libirgendwas.a</code>,
	    dann müssen Sie dem <code class="command">cc</code> als
	    Argument
	    <code class="option">-l<em class="replaceable"><code>irgendwas</code></em></code>
	    übergeben. Zum Beispiel heißt die
	    Mathematik-Bibliothek <code class="filename">libm.a</code>, und
	    daher müssen Sie dem <code class="command">cc</code> als
	    Argument <code class="option">-lm</code> übergeben. Ein
	    typisches <span class="quote">&#8222;<span class="quote">Manko</span>&#8220;</span> der Mathematik-Bibliothek
	    ist, daß diese immer die letzte Bibliothek auf der
	    Kommandozeile sein muß.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.c -lm</code></strong>
	    </pre></div><p>Durch diesen Befehl werden die Funktionen aus der
	    Mathematik-Bibliothek in <code class="filename">foobar</code>
	    gelinkt.</p><p>Wenn Sie C++-Code kompilieren wollen, müssen Sie
	    <code class="option">-lg++</code>, bzw. <code class="option">-lstdc++</code>
	    falls Sie FreeBSD 2.2 oder neuer verwenden, zu Ihrer
	    Kommandozeile hinzufügen, um Ihr Programm gegen die
	    Funktionen der C++ Bibliothek zu linken. Alternativ
	    können Sie anstatt <code class="command">cc</code> auch
	    <code class="command">c++</code> aufrufen, welcher dies für Sie
	    erledigt. <code class="command">c++</code> kann unter FreeBSD auch
	    als <code class="command">g++</code> aufgerufen werden.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.cc -lg++</code></strong>     <em class="lineannotation"><span class="lineannotation">Bei FreeBSD 2.1.6 oder älter</span></em>
<code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.cc -lstdc++</code></strong>  <em class="lineannotation"><span class="lineannotation">Bei FreeBSD 2.2 und neuer</span></em>
<code class="prompt">%</code> <strong class="userinput"><code>c++ -o foobar foobar.cc</code></strong>
	    </pre></div><p>Beide Varianten erzeugen eine ausführbare
	    <code class="filename">foobar</code> aus der C++ Quelltextdatei
	    <code class="filename">foobar.cc</code>. Beachten Sie bitte,
	    daß auf <span class="trademark">UNIX</span>® Systemen C++ Quelltextdateien
	    üblicherweise auf <code class="filename">.C</code>,
	    <code class="filename">.cxx</code> oder <code class="filename">.cc</code>
	    enden, und nicht wie bei <span class="trademark">MS-DOS</span>® auf
	    <code class="filename">.cpp</code> (welche schon anderweitig
	    benutzt wurde). Der <code class="command">gcc</code> hat
	    normalerweise anhand dieser Information entschieden,
	    welcher Compiler für die Quelltextdatei zum Einsatz
	    kommen soll; allerdings gilt diese Einschränkung
	    jetzt nicht mehr, und Sie können Ihre C++-Dateien
	    ungestraft auf <code class="filename">.cpp</code> enden
	    lassen!</p></dd></dl></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62524752"></a>2.4.1. Häufig auftretende <code class="command">cc</code>-Fragen und
	-Probleme</h3></div></div></div><div class="qandaset"><a id="idp62527440"></a><dl><dt>2.4.1.1. <a href="#idp62528080">Ich versuche ein Programm zu schreiben, welches die
	      Funktion sin() verwendet, erhalte
	      jedoch eine Fehlermeldung. Was bedeutet diese?</a></dt><dt>2.4.1.2. <a href="#idp62541136">So, ich habe jetzt dieses einfache Programm als
	      Übung für -lm geschrieben.
	      Alles was es macht ist, 2.1 hoch 6 zu berechnen.</a></dt><dt>2.4.1.3. <a href="#idp62581456">Wie kann ich das korrigieren?</a></dt><dt>2.4.1.4. <a href="#idp62603856">Ich habe eine Datei mit dem Namen
	      foobar.c kompiliert, kann jedoch
	      nirgends eine ausführbare Datei namens
	      foobar finden. Wo befindet sich
	      diese?</a></dt><dt>2.4.1.5. <a href="#idp62617424">OK, ich habe eine ausführbare Datei namens
	      foobar, ich kann sie sehen, wenn
	      ich ls aufrufe. Gebe ich jedoch
	      foobar in die Kommandozeile ein wird
	      mir gesagt, daß eine Datei mit diesem Namen nicht
	      existiert. Warum kann die Datei nicht gefunden
	      werden?</a></dt><dt>2.4.1.6. <a href="#idp62646224">Ich habe meine ausführbare Datei
	      test genannt, allerdings passiert
	      nichts wenn ich diese aufrufe. Was ist hier los?</a></dt><dt>2.4.1.7. <a href="#idp62665808">Ich habe mein Programm kompiliert und bei dessen
	      Aufruf sah zuerst alles gut aus. Jedoch gab es dann eine
	      Fehlermeldung, welche irgendetwas mit core
	      dumped lautete. Was bedeutet das?</a></dt><dt>2.4.1.8. <a href="#idp62673232">Faszinierendes Zeugs, aber was soll ich jetzt
	      machen?</a></dt><dt>2.4.1.9. <a href="#idp62680016">Als mein Programm den core dump erzeugt hat, sagte
	      es etwas von einem segmentation
	      fault. Was ist das?</a></dt><dt>2.4.1.10. <a href="#idp62733904">Wenn ich einen core dump erhalte erscheint
	      manchmal die Meldung bus error.
	      In meinem UNIX®-Buch steht, daß die Ursache ein
	      Hardwareproblem sei. Der Computer scheint aber weiterhin
	      zu funktionieren. Ist dies wahr?</a></dt><dt>2.4.1.11. <a href="#idp62741072">Diese Sache mit den core dumps hört sich sehr
	      nützlich an, wenn ich so etwas selber an beliebiger
	      Stelle bewirken könnte. Kann ich das tun, oder
	      muß ich warten bis ein Fehler auftritt?</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%" /><col /></colgroup><tbody><tr class="question"><td align="left" valign="top"><a id="idp62528080"></a><a id="idp62528976"></a><p><strong>2.4.1.1.</strong></p></td><td align="left" valign="top"><p>Ich versuche ein Programm zu schreiben, welches die
	      Funktion <code class="function">sin()</code> verwendet, erhalte
	      jedoch eine Fehlermeldung. Was bedeutet diese?</p><div class="informalexample"><pre class="screen">/var/tmp/cc0143941.o: Undefined symbol `_sin' referenced from text segment
	      </pre></div></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Wenn Sie mathematische Funktionen wie
	      <code class="function">sin()</code> verwenden wollen, müssen
	      Sie den <code class="command">cc</code> anweisen, die
	      Mathematik-Bibliothek wie folgt zu verlinken:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.c -lm</code></strong>
	      </pre></div></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62541136"></a><a id="idp62541776"></a><p><strong>2.4.1.2.</strong></p></td><td align="left" valign="top"><p>So, ich habe jetzt dieses einfache Programm als
	      Übung für <code class="option">-lm</code> geschrieben.
	      Alles was es macht ist, 2.1 hoch 6 zu berechnen.</p><div class="informalexample"><pre class="programlisting">#include &lt;stdio.h&gt;

int main() {
	float f;

	f = pow(2.1, 6);
	printf("2.1 ^ 6 = %f\n", f);
	return 0;
}
	      </pre></div><p>und ich habe es wie folgt kompiliert:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc temp.c -lm</code></strong>
	      </pre></div><p>wie mir gesagt wurde. Allerdings bekomme ich jetzt
	      bei der Ausführung die folgende Ausgabe:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./a.out</code></strong>
2.1 ^ 6 = 1023.000000
	      </pre></div><p>Das ist <span class="emphasis"><em>nicht</em></span> die richtige
	      Antwort! Was ist hier los?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Wenn der Compiler Ihren Funktionsaufruf sieht,
	      überprüft er, ob er schon einmal einen
	      Prototypen für diese gesehen hat. Wenn nicht nimmt
	      er als Rückgabewert den Typ <span class="type">int</span> an,
	      was sicherlich nicht das ist, was Sie an dieser Stelle
	      wollen.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62581456"></a><a id="idp62582352"></a><p><strong>2.4.1.3.</strong></p></td><td align="left" valign="top"><p>Wie kann ich das korrigieren?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Die Prototypen der mathematischen Funktionen
	      befinden sich in der Datei <code class="filename">math.h</code>.
	      Wenn Sie diese Datei in Ihrem Quelltext includen ist der
	      Compiler in der Lage, den Prototypen zu finden, und wird
	      aufhören, seltsame Dinge mit Ihrer Berechnung zu
	      machen!</p><div class="informalexample"><pre class="programlisting">#include &lt;math.h&gt;
#include &lt;stdio.h&gt;

int main() {
...
	      </pre></div><p>Nach erneutem Compilieren sollte das Folgende bei
	      der Ausführung ausgegeben werden:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./a.out</code></strong>
2.1 ^ 6 = 85.766121
	      </pre></div><p>Wenn Sie irgendwelche mathematischen Funktionen
	      verwenden sollten Sie <span class="emphasis"><em>immer</em></span> die
	      Datei <code class="filename">math.h</code> includen und nicht
	      vergessen, Ihr Programm gegen die Mathematik-Bibliothek
	      zu verlinken.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62603856"></a><a id="idp62604112"></a><p><strong>2.4.1.4.</strong></p></td><td align="left" valign="top"><p>Ich habe eine Datei mit dem Namen
	      <code class="filename">foobar.c</code> kompiliert, kann jedoch
	      nirgends eine ausführbare Datei namens
	      <code class="filename">foobar</code> finden. Wo befindet sich
	      diese?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Denken Sie daran, daß der
	      <code class="command">cc</code> die ausführbare Datei
	      <code class="filename">a.out</code> nennt, wenn Sie nicht
	      explizit einen Namen angeben. Verwenden Sie in solch
	      einem Fall die Option
	      <code class="option">-o <em class="replaceable"><code>filename</code></em></code>:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.c</code></strong>
	      </pre></div></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62617424"></a><a id="idp62618064"></a><p><strong>2.4.1.5.</strong></p></td><td align="left" valign="top"><p>OK, ich habe eine ausführbare Datei namens
	      <code class="filename">foobar</code>, ich kann sie sehen, wenn
	      ich <code class="command">ls</code> aufrufe. Gebe ich jedoch
	      <code class="command">foobar</code> in die Kommandozeile ein wird
	      mir gesagt, daß eine Datei mit diesem Namen nicht
	      existiert. Warum kann die Datei nicht gefunden
	      werden?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Im Gegensatz zu <span class="trademark">MS-DOS</span>® sucht <span class="trademark">UNIX</span>® nicht im
	      aktuellen Verzeichnis nach einem ausführbaren
	      Programm, das Sie versuchen auszuführen, solange
	      Sie dies nicht explizit mit angeben. Sie können
	      entweder <code class="command">./foobar</code> eingeben, was
	      soviel bedeutet wie <span class="quote">&#8222;<span class="quote">führe eine Datei namens
	      <code class="filename">foobar</code> im aktuellen Verzeichnis
	      aus</span>&#8220;</span>, oder Sie können Ihre Umgebungsvariable
	      <code class="envar">PATH</code> so erweitern, daß sie
	      ähnlich wie folgt aussieht</p><div class="informalexample"><pre class="screen">bin:/usr/bin:/usr/local/bin:.
	      </pre></div><p>Der Punkt am Ende bedeutet <span class="quote">&#8222;<span class="quote">siehe im aktuellen
	      Verzeichnis nach, wenn es in keinem der anderen zu
	      finden war</span>&#8220;</span>.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62646224"></a><a id="idp62647248"></a><p><strong>2.4.1.6.</strong></p></td><td align="left" valign="top"><p>Ich habe meine ausführbare Datei
	      <code class="filename">test</code> genannt, allerdings passiert
	      nichts wenn ich diese aufrufe. Was ist hier los?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Bei den meisten <span class="trademark">UNIX</span>®-Systeme existiert bereits
	      ein Programm mit dem Namen <code class="command">test</code> im
	      Verzeichnis <code class="filename">/usr/bin</code>, und die Shell
	      nimmt dieses, bevor sie im aktuellen Verzeichnis
	      nachsieht. Sie können entweder den folgenden Befehl
	      eingeben:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./test</code></strong>
	      </pre></div><p>oder Sie können einen geeigneteren Namen
	      für Ihr Programm wählen!</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62665808"></a><a id="idp62666704"></a><p><strong>2.4.1.7.</strong></p></td><td align="left" valign="top"><p>Ich habe mein Programm kompiliert und bei dessen
	      Aufruf sah zuerst alles gut aus. Jedoch gab es dann eine
	      Fehlermeldung, welche irgendetwas mit <span class="errorname">core
	      dumped</span> lautete. Was bedeutet das?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Der Name <em class="firstterm">core dump</em> stammt
	      noch aus sehr frühen Zeiten von <span class="trademark">UNIX</span>®, als die
	      Maschinen noch Kernspeicher zum Speichern von Daten
	      verwendeten. Einfach ausgedrückt, wenn bei einem
	      Programm unter bestimmen Bedingungen ein Fehler auftrat,
	      hat das System den Inhalt des Kernspeichers auf der
	      Festplatte in eine Datei namens
	      <code class="filename">core</code> geschrieben, welche der
	      Programmierer dann näher untersuchen konnte, um die
	      Ursache des Fehlers herauszufinden.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62673232"></a><a id="idp62674256"></a><p><strong>2.4.1.8.</strong></p></td><td align="left" valign="top"><p>Faszinierendes Zeugs, aber was soll ich jetzt
	      machen?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Verwenden Sie den <code class="command">gdb</code>, um das
	      Speicherabbild zu untersuchen (siehe <a class="xref" href="#debugging" title="2.6. Debuggen">Abschnitt 2.6, &#8222;Debuggen&#8220;</a>).</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62680016"></a><a id="idp62680912"></a><p><strong>2.4.1.9.</strong></p></td><td align="left" valign="top"><p>Als mein Programm den core dump erzeugt hat, sagte
	      es etwas von einem <span class="errorname">segmentation
	      fault</span>. Was ist das?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Diese Meldung heißt im Prinzip, daß Ihr
	      Programm eine illegale Operation mit dem Speicher
	      durchführen wollte; <span class="trademark">UNIX</span>® wurde so entworfen,
	      daß es das andere Programme und das Betriebssystem
	      selbst vor wildgewordenen Programmen
	      schützt.</p><p>Häufige Ursachen hierfür sind:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Der Versuch, einen <span class="symbol">NULL</span>-Zeiger
		  zu beschreiben, z.B.</p><pre class="programlisting">char *foo = NULL;
strcpy(foo, "bang!");
		</pre></li><li class="listitem"><p>Einen Zeiger zu verwenden, welcher noch nicht
		  initialisiert wurde, z.B.</p><pre class="programlisting">char *foo;
strcpy(foo, "bang!");
		</pre><p>Der Zeiger hat einen zufälligen Wert,
		  welcher mit etwas Glück in einen Bereich des
		  Speichers zeigt, der für Ihr Programm nicht
		  verfügbar ist, und der Kernel bricht Ihr
		  Programm ab, bevor es irgendwelchen Schaden
		  anrichten kann. Wenn Sie Pech haben zeigt der Zeiger
		  irgendwo mitten in Ihr eigenes Programm, und
		  verändert dort ihre eigenen Datenstrukturen,
		  was zu sehr seltsamen Fehlern Ihres Programmes
		  führt.</p></li><li class="listitem"><p>Der Versuch, auf Daten außerhalb eines
		  Arrays zuzugreifen, z.B.</p><pre class="programlisting">int bar[20];
bar[27] = 6;
		</pre></li><li class="listitem"><p>Der Versuch, Daten in eine Speicherbereich zu
		  schreiben, der nur lesbar ist, z.B.</p><pre class="programlisting">char *foo = "My string";
strcpy(foo, "bang!");
		</pre><p><span class="trademark">UNIX</span>®-Compiler speichern häufig feste
		  Zeichenketten wie <code class="literal">"My string"</code> in
		  nur lesbaren Speicherbereichen ab.</p></li><li class="listitem"><p>Wenn man unerlaubte Operationen mit
		  <code class="function">malloc()</code> und
		  <code class="function">free()</code> ausführt,
		  z.B.</p><pre class="programlisting">char bar[80];
free(bar);
		</pre><p>oder</p><pre class="programlisting">char *foo = malloc(27);
free(foo);
free(foo);
		</pre></li></ul></div><p>Einzelne solcher Fehler führen zwar nicht
	      immer zu einem Fehlverhalten des Programms, stellen
	      jedoch immer eine falsche Verwendung dar. Manche Systeme
	      und Compiler sind toleranter als andere, weshalb
	      Programme auf dem einen System einwandfrei laufen, auf
	      dem anderen System jedoch abstürzen.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62733904"></a><a id="idp62734672"></a><p><strong>2.4.1.10.</strong></p></td><td align="left" valign="top"><p>Wenn ich einen core dump erhalte erscheint
	      manchmal die Meldung <span class="errorname">bus error</span>.
	      In meinem <span class="trademark">UNIX</span>®-Buch steht, daß die Ursache ein
	      Hardwareproblem sei. Der Computer scheint aber weiterhin
	      zu funktionieren. Ist dies wahr?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Nein, glücklicherweise nicht (es sei denn Sie
	      haben wirklich ein Hardwareproblem&#8230;).
	      Üblicherweise ist dies ein Weg Ihnen mitzuteilen,
	      daß Sie auf Speicher in einer Weise zugegriffen
	      haben, in der Sie dies nicht tun sollten.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp62741072"></a><a id="idp62742096"></a><p><strong>2.4.1.11.</strong></p></td><td align="left" valign="top"><p>Diese Sache mit den core dumps hört sich sehr
	      nützlich an, wenn ich so etwas selber an beliebiger
	      Stelle bewirken könnte. Kann ich das tun, oder
	      muß ich warten bis ein Fehler auftritt?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Ja, nehmen sie einfach eine andere Konsole oder
	      XTerm und führen Sie</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ps</code></strong>
	    </pre><p>aus, um die Prozess-ID Ihres Programms
	      herauszufinden. Führen Sie
	      anschließend</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>kill -ABRT pid</code></strong>
	    </pre><p>aus, wobei
	      <em class="parameter"><code><em class="replaceable"><code>pid</code></em></code></em>
	      die Prozess-ID ist, die Sie vorher ermittelt
	      haben.</p><p>Dies ist nützlich, wenn sich Ihr Programm z.B.
	      in einer Endlosschleife verfangen hat. Sollte Ihr
	      Programm das Signal <span class="symbol">SIGABRT</span> abfangen,
	      gibt es noch andere Möglichkeiten, die denselben
	      Effekt haben.</p><p>Alternativ können Sie einen core dump aus
	      Ihrem Programm heraus erstellen, indem Sie die Funktion
	      <code class="function">abort()</code> aufrufen. Weitere
	      Informationen darüber können Sie in der
	      Manualpage <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=abort&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">abort</span>(3)</span></a> nachlesen.</p><p>Wenn Sie einen core dump von außerhalb Ihres
	      Programms erzeugen wollen, ohne dabei den Prozess
	      abzubrechen, können Sie das Programm
	      <code class="command">gcore</code> verwenden. Weitere
	      Informationen dazu finden Sie in der zugehörigen
	      Manualpage <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gcore&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">gcore</span>(1)</span></a>.</p></td></tr></tbody></table></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-make"></a>2.5. Make</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62777424"></a>2.5.1. Was ist <code class="command">make</code>?</h3></div></div></div><p>Wenn Sie an einem einfachen Programm mit nur einer oder
	zwei Quelltextdateien arbeiten, ist die Eingabe von</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc file1.c file2.c</code></strong></pre><p>zwar nicht aufwendig, wird aber mit zunehmender Anzahl
	der Quelltextdateien sehr lästig&#8212;und auch das
	Kompilieren kann eine Weile dauern.</p><p>Eine Möglichkeit dies zu umgehen besteht in der
	Verwendung von Objektdateien, wobei man nur die
	Quelltextdateien neu kompiliert, die verändert wurden. So
	könnten wir etwa folgendes erhalten:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc file1.o file2.o</code></strong> &#8230; <strong class="userinput"><code>file37.c</code></strong> &#8230;</pre><p>falls wir seit dem letzten Kompiliervorgang nur die Datei
	<code class="filename">file37.c</code> verändert haben. Dadurch
	könnte der Kompiliervorgang um einiges beschleunigt
	werden, es muß jedoch immer noch alles von Hand
	eingegeben werden.</p><p>Oder wir könnten uns ein Shell Skript schreiben.
	Dieses würde jedoch alles immer wieder neu kompilieren,
	was bei einem großen Projekt sehr ineffizient
	wäre.</p><p>Was ist, wenn wir hunderte von Quelltextdateien
	hätten? Was ist, wenn wir in einem Team mit anderen
	Leuten arbeiten würden, die vergessen uns Bescheid zu
	sagen, falls sie eine der Quelltextdateien verändert
	haben, die wir ebenfalls benutzen?</p><p>Vielleicht könnten wir beide Lösungen
	kombinieren und etwas wie ein Shell Skript schreiben, welches
	eine Art magische Regel enthalten würde, die feststellt,
	welche Quelltextdateien neu kompiliert werden müssten.
	Alles was wir bräuchten wäre ein Programm, das diese
	Regeln verstehen könnte, da diese Aufgabe etwas zu
	kompliziert für eine Shell ist.</p><p>Dieses Programm heißt <code class="command">make</code>. Es
	liest eine Datei namens <em class="firstterm">makefile</em>,
	welche ihm sagt, wie unterschiedliche Dateien voneinander
	abhängen, und berechnet, welche Dateien neu kompiliert
	werden müssen und welche nicht. Zum Beispiel könnte
	eine Regel etwas sagen wie <span class="quote">&#8222;<span class="quote">wenn
	<code class="filename">fromboz.o</code> älter als
	<code class="filename">fromboz.c</code> ist, bedeutet dies, daß
	jemand die Datei <code class="filename">fromboz.c</code> verändert
	haben muß, und diese daher neu kompiliert werden
	muß.</span>&#8220;</span> Das makefile enthält außerdem
	Regeln die make sagen, <span class="emphasis"><em>wie</em></span> die
	Quelltextdatei neu kompiliert werden muß, was dieses
	Tool noch sehr viel mächtiger macht.</p><p>Makefiles werden normalerweise im selben Verzeichnis
	wie die Quelltextdateien abgelegt, zu denen sie gehören,
	und kann <code class="filename">makefile</code>,
	<code class="filename">Makefile</code> oder
	<code class="filename">MAKEFILE</code> heißen. Die meisten
	Programmierer verwenden den Namen
	<code class="filename">Makefile</code>, da diese Schreibweise
	dafür sorgt, daß die Datei gut lesbar ganz oben in
	der Verzeichnisliste aufgeführt wird.

	<a href="#ftn.idp62819024" class="footnote" id="idp62819024"><sup class="footnote">[6]</sup></a>
      </p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62823376"></a>2.5.2. Beispielhafte Verwendung von <code class="command">make</code></h3></div></div></div><p>Hier ist eine sehr einfache make Datei:</p><pre class="programlisting">foo: foo.c
	cc -o foo foo.c</pre><p>Sie besteht aus zwei Zeilen, einer
	Abhängigkeitszeile und einer Erzeugungszeile.</p><p>Die Abhängigkeitszeile hier besteht aus dem Namen
	des Programms (auch <em class="firstterm">Ziel</em> genannt),
	gefolgt von einem Doppelpunkt und einem Leerzeichen, und
	anschließend dem Namen der Quelltextdatei. Wenn
	<code class="command">make</code> diese Zeile liest überprüft
	es die Existenz von <code class="filename">foo</code>; falls diese
	Datei existiert vergleicht es das Datum der letzten
	Änderung von <code class="filename">foo</code> mit der von
	<code class="filename">foo.c</code>. Falls <code class="filename">foo</code>
	nicht existiert, oder älter als
	<code class="filename">foo.c</code> ist, liest es die Erzeugungszeile
	um herauszufinden, was zu tun ist. Mit anderen Worten, dies
	ist die Regel die festlegt, wann <code class="filename">foo.c</code>
	neu kompiliert werden muß.</p><p>Die Erzeugungszeile beginnt mit einem <span class="token">tab</span>
	(drücken Sie dazu die <span class="keycap"><strong>tab</strong></span>-Taste) gefolgt
	von dem Befehl, mit dem Sie <code class="filename">foo</code> manuell
	erzeugen würden. Wenn <code class="filename">foo</code> veraltet
	ist, oder nicht existiert, führt <code class="command">make</code>
	diesen Befehl aus, um die Datei zu erzeugen. Mit anderen
	Worten, dies ist die Regel die make sagt, wie
	<code class="filename">foo.c</code> kompiliert werden muß.</p><p>Wenn Sie also <strong class="userinput"><code>make</code></strong> eingeben wird
	dieses sicherstellen, daß <code class="filename">foo</code> bzgl.
	Ihrer letzten Änderungen an <code class="filename">foo.c</code>
	auf dem neuesten Stand ist. Dieses Prinzip kann auf
	<code class="filename">Makefile</code>s mit hunderten von
	Zielen&#8212;es ist bei FreeBSD praktisch möglich, das
	gesamte Betriebssystem zu kompilieren, indem man nur
	<strong class="userinput"><code>make world</code></strong> im richtigen Verzeichnis
	eingibt!</p><p>Eine weitere nützliche Eigenschaft der makefiles
	ist, daß die Ziele keine Programme sein müssen. Wir
	könnten zum Beispiel eine make Datei haben, die wie folgt
	aussieht:</p><pre class="programlisting">foo: foo.c
	cc -o foo foo.c

install:
	cp foo /home/me</pre><p>Wir können make sagen welches Ziel wir erzeugt haben
	wollen, indem wir etwas wie folgt eingeben:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>make target</code></strong></pre><p><code class="command">make</code> wird dann nur dieses Ziel
	beachten und alle anderen ignorieren. Wenn wir zum Beispiel
	<strong class="userinput"><code>make foo</code></strong> mit dem obigen makefile
	eingeben, dann wird make das Ziel
	<code class="buildtarget">install</code> ignorieren.</p><p>Wenn wir nur <strong class="userinput"><code>make</code></strong> eingeben wird
	make immer nur nach dem ersten Ziel suchen und danach mit dem
	Suchen aufhören. Wenn wir hier also nur
	<strong class="userinput"><code>make</code></strong> eingegeben hätten, würde
	es nur zu dem Ziel <code class="buildtarget">foo</code> gehen,
	gegebenenfalls <code class="filename">foo</code> neu kompilieren, und
	danach einfach aufhören, ohne das Ziel
	<code class="buildtarget">install</code> zu beachten.</p><p>Beachten Sie, daß das <code class="buildtarget">install</code>-Ziel
	von nichts anderem abhängt! Dies bedeutet, daß der
	Befehl in der nachfolgenden Zeile immer ausgeführt wird,
	wenn wir dieses Ziel mittels <strong class="userinput"><code>make
	install</code></strong> aufrufen. In diesem Fall wird die Datei
	<code class="filename">foo</code> in das Heimatverzeichnis des
	Benutzers kopiert. Diese Vorgehensweise wird häufig bei
	makefiles von Anwendungen benutzt, damit die Anwendung nach
	erfolgreicher Kompilierung in das richtige Verzeichnis
	installiert werden kann.</p><p>Dieser Teil ist etwas schwierig zu erklären. Wenn
	Sie immer noch nicht so richtig verstanden haben, wie
	<code class="command">make</code> funktioniert, wäre es das Beste,
	sie erstellen sich selber ein einfaches Programm wie
	<span class="quote">&#8222;<span class="quote">hello world</span>&#8220;</span> und eine make Datei wie die weiter
	oben angegebene, und experimentieren damit selber ein bißchen
	herum. Als nächstes könnten Sie mehrere
	Quelltextdateien verwenden, oder in Ihrer Quelltextdatei eine
	Header-Datei includen. Der Befehl <code class="command">touch</code> ist
	an dieser Stelle ganz hilfreich&#8212;er verändert das
	Datum einer Datei, ohne das Sie diese extra editieren
	müssen.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62895696"></a>2.5.3. Make und include-Dateien</h3></div></div></div><p>C-Code beginnt häufig mit einer Liste von Dateien,
	die included werden sollen, zum Beispiel stdio.h. Manche
	dieser Dateien sind include-Dateien des Systems, andere
	gehören zum aktuellen Projekt, an dem Sie gerade
	arbeiten:</p><pre class="programlisting">#include &lt;stdio.h&gt;
#include "foo.h"

int main(....</pre><p>Um sicherzustellen, daß diese Datei neu kompiliert
	wird, wenn <code class="filename">foo.h</code> verändert wurde,
	müssen Sie diese Datei Ihrem
	<code class="filename">Makefile</code> hinzufügen:</p><pre class="programlisting">foo: foo.c foo.h</pre><p>Sobald Ihr Projekt größer wird und Sie mehr
	und mehr eigene include-Dateien verwalten müssen wird es
	nur noch sehr schwer möglich sein, die Übersicht
	über alle include-Dateien und Dateien, die von diesen
	abhängen, beizubehalten. Falls Sie eine include-Datei
	verändern, jedoch das erneute Kompilieren aller Dateien,
	die von dieser Datei abhängen, vergessen, werden die
	Folgen verheerend sein. Der <code class="command">gcc</code> besitzt
	eine Option, bei der er Ihre Dateien analysiert und eine Liste
	aller include-Dateien und deren Abhängigkeiten erstellt:
	<code class="option">-MM</code>.</p><p>Wenn Sie das Folgende zu Ihrem Makefile
	hinzufügen:</p><pre class="programlisting">depend:
	gcc -E -MM *.c &gt; .depend</pre><p>und <strong class="userinput"><code>make depend</code></strong> ausführen,
	wird die Datei <code class="filename">.depend</code> mit einer Liste
	von Objekt-Dateien, C-Dateien und den include-Dateien
	auftauchen:</p><pre class="programlisting">foo.o: foo.c foo.h</pre><p>Falls Sie <code class="filename">foo.h</code> verändern
	werden beim nächsten Aufruf von <code class="command">make</code>
	alle Dateien, die von <code class="filename">foo.h</code>
	abhängen, neu kompiliert.</p><p>Vergessen Sie nicht jedes mal
	<code class="command">make depend</code> aufzurufen, wenn Sie eine
	include-Datei zu einer Ihrer Dateien hinzugefügt
	haben.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62920528"></a>2.5.4. FreeBSD Makefiles</h3></div></div></div><p>Makefiles können eher schwierig zu schreiben sein.
	Glücklicherweise kommen BSD-basierende Systeme wie
	FreeBSD mit einigen sehr mächtigen solcher Dateien als
	Teil des Systems daher. Ein sehr gutes Beispiel dafür ist
	das FreeBSD Portssystem. Hier ist der grundlegende Teil eines
	typischen <code class="filename">Makefile</code>s des
	Portssystems:</p><pre class="programlisting">MASTER_SITES=   ftp://freefall.cdrom.com/pub/FreeBSD/LOCAL_PORTS/
DISTFILES=      scheme-microcode+dist-7.3-freebsd.tgz

.include &lt;bsd.port.mk&gt;</pre><p>Wenn wir jetzt in das Verzeichnis dieses Ports wechseln
	und <strong class="userinput"><code>make</code></strong> aufrufen, passiert das
	Folgende:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Es wird überprüft, ob sich der Quelltext
	    für diesen Port bereits auf Ihrem System
	    befindet.</p></li><li class="step"><p>Falls dies nicht der Fall ist wird eine
	    FTP-Verbindung zu der URL in <span class="symbol">MASTER_SITES</span>
	    aufgebaut und der Quelltext heruntergeladen.</p></li><li class="step"><p>Die Checksumme für den Quelltext wird berechnet
	    und mit der schon bekannten und für sicher und gut
	    empfundenen verglichen. Damit wird sichergestellt,
	    daß der Quelltext bei der Übertragung nicht
	    beschädigt wurde.</p></li><li class="step"><p>Sämtliche Anpassungen, die nötig sind,
	    damit der Quelltext unter FreeBSD funktioniert, werden
	    vorgenommen&#8212;dieser Vorgang wird auch
	    <em class="firstterm">patchen</em> genannt.</p></li><li class="step"><p>Alle speziellen Konfigurationen, die am Quelltext
	    nötig sind, werden vorgenommen. (Viele <span class="trademark">UNIX</span>®
	    Programmdistributionen versuchen herauszufinden, auf
	    welcher <span class="trademark">UNIX</span>®-Version sie kompiliert werden sollen und
	    welche optionalen <span class="trademark">UNIX</span>®-Features vorhanden sind&#8212;an
	    dieser Stelle erhalten sie die Informationen im FreeBSD
	    Ports Szenario).</p></li><li class="step"><p>Der Quelltext für das Programm wird kompiliert.
	    Im Endeffekt wechseln wir in das Verzeichnis, in das der
	    Quelltext entpackt wurde, und rufen
	    <code class="command">make</code> auf&#8212;die eigene make-Datei
	    des Programms besitzt die nötigen Informationen um
	    dieses zu bauen.</p></li><li class="step"><p>Wir haben jetzt eine kompilierte Version des
	    Programmes. Wenn wir wollen können wir dieses jetzt
	    testen; wenn wir überzeugt vom Programm sind,
	    können wir <strong class="userinput"><code>make install</code></strong>
	    eingeben. Dadurch werden das Programm sowie alle
	    zugehörigen Dateien an die richtige Stelle kopiert;
	    es wird auch ein Eintrag in der
	    <span class="database">Paketdatenbank</span> erzeugt, sodaß
	    der Port sehr einfach wieder deinstalliert werden kann,
	    falls wir unsere Meinung über dieses geändert
	    haben.</p></li></ol></div><p>Ich glaube jetzt werden Sie mit mir übereinstimmen,
	daß dies ziemlich eindrucksvoll für ein Skript mit
	vier Zeilen ist!</p><p>Das Geheimnis liegt in der letzten Zeile, die
	<code class="command">make</code> anweist, in das makefile des Systems
	mit dem Namen <code class="filename">bsd.port.mk</code> zu sehen. Man
	kann diese Zeile zwar leicht übersehen, aber hierher
	kommt all das klevere Zeugs&#8212;jemand hat ein makefile
	geschrieben, welches <code class="command">make</code> anweist, alle
	weiter oben beschriebenen Schritte durchzuführen (neben
	vielen weiteren Dingen, die ich nicht angesprochen habe,
	einschließlich der Behandlung sämtlicher Fehler,
	die auftreten könnten) und jeder kann darauf
	zurückgreifen, indem er eine einzige Zeile in seine
	eigene make-Datei einfügt!</p><p>Falls Sie einen Blick in die makefiles des Systems werfen
	möchten, finden Sie diese in
	<code class="filename">/usr/share/mk</code>. Es ist aber wahrscheinlich
	besser, wenn Sie damit noch warten, bis Sie ein bißchen mehr
	Praxiserfahrung mit makefiles gesammelt haben, da die dortigen
	makefiles sehr kompliziert sind (und wenn Sie sich diese
	ansehen sollten Sie besser eine Kanne starken Kaffee
	griffbereit haben!)</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp62981712"></a>2.5.5. Fortgeschrittene Verwendung von
	<code class="command">make</code></h3></div></div></div><p><code class="command">Make</code> ist ein sehr mächtiges
	Werkzeug und kann noch sehr viel mehr als die gezeigten
	einfachen Beispiele weiter oben. Bedauerlicherweise gibt es
	mehrere verschiedene Versionen von <code class="command">make</code>,
	und sie alle unterscheiden sich beträchtlich voneinander.
	Der beste Weg herauszufinden was sie können ist
	wahrscheinlich deren Dokumentation zu lesen&#8212;hoffentlich
	hat diese Einführung Ihnen genügend Grundkenntnisse
	vermitteln können, damit Sie dies tun können.</p><p>Die Version von make, die in FreeBSD enthalten ist, ist
	<span class="application">Berkeley make</span>; es gibt eine
	Anleitung dazu in
	<code class="filename">/usr/share/doc/psd/12.make</code>. Um sich diese
	anzusehen, müssen Sie</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>zmore paper.ascii.gz</code></strong></pre><p>in diesem Verzeichnis ausführen.</p><p>Viele Anwendungen in den Ports verwenden
	<span class="application">GNU make</span>, welches einen sehr guten
	Satz an <span class="quote">&#8222;<span class="quote">info</span>&#8220;</span>-Seiten mitbringt. Falls Sie
	irgendeinen dieser Ports installiert haben wurde
	<span class="application">GNU make</span> automatisch als
	<code class="command">gmake</code> mit installiert. Es ist auch als
	eigenständiger Port und Paket verfügbar.</p><p>Um sich die Info-Seiten für
	<span class="application">GNU make</span> anzusehen müssen Sie
	die Datei <code class="filename">dir</code> in
	<code class="filename">/usr/local/info</code> um einen entsprechenden
	Eintrag erweitern. Dies beinhaltet das Einfügen einer
	Zeile wie</p><pre class="programlisting"> * Make: (make).                 The GNU Make utility.</pre><p>in die Datei. Nachdem Sie dies getan haben können
	Sie <strong class="userinput"><code>info</code></strong> eingeben und dann den
	Menüeintrag <span class="guimenuitem">make</span>
	auswählen (oder Sie können in
	<span class="application">Emacs</span> die Tastenkombination
	<strong class="userinput"><code>C-h i</code></strong> verwenden).</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="debugging"></a>2.6. Debuggen</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63016400"></a>2.6.1. Der Debugger</h3></div></div></div><p>Der Debugger bei FreeBSD heißt
	<code class="command">gdb</code> (<span class="application">GNU
	debugger</span>). Sie können Ihn durch die Eingabe
	von</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>gdb progname</code></strong></pre><p>starten, wobei viele Leute ihn vorzugsweise
	innerhalb von <span class="application">Emacs</span> aufrufen. Sie
	erreichen dies durch die Eingabe von:</p><pre class="screen"><strong class="userinput"><code>M-x gdb RET progname RET</code></strong></pre><p>Die Verwendung eines Debuggers erlaubt Ihnen Ihr
	Programm unter kontrollierteren Bedingungen ausführen zu
	können. Typischerweise können Sie so Zeile für
	Zeile durch Ihr Programm gehen, die Werte von Variablen
	untersuchen, diese verändern, dem Debugger sagen er soll
	das Programm bis zu einem bestimmten Punkt ausführen und
	dann anhalten, und so weiter und so fort. Sie können
	damit sogar ein schon laufendes Programm untersuchen, oder
	eine Datei mit einem Kernspeicherabbild laden um
	herauszufinden, warum das Programm abgestürzt ist. Es ist
	sogar möglich damit den Kernel zu debuggen, wobei dies
	etwas trickreicher als bei den Benutzeranwendungen ist, welche
	wir in diesem Abschnitt behandeln werden.</p><p>Der <code class="command">gdb</code> besitzt eine recht gute
	Online-Hilfe, sowie einen Satz von Info-Seiten, weshalb sich
	dieser Abschnitt auf ein paar grundlegende Befehle
	beschränken wird.</p><p>Falls Sie den textbasierten Kommandozeilen-Stil
	abstoßend finden gibt es ein graphisches Front-End
	dafür (<a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/devel/xxgdb/pkg-descr">devel/xxgdb</a>) in der Ports-Sammlung.</p><p>Dieser Abschnitt ist als Einführung in die
	Verwendung des <code class="command">gdb</code> gedacht und beinhaltet
	nicht spezielle Themen wie das Debuggen des Kernels.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63044944"></a>2.6.2. Ein Programm im Debugger ausführen</h3></div></div></div><p>Sie müssen das Programm mit der Option
	<code class="option">-g</code> kompiliert haben um den
	<code class="command">gdb</code> effektiv einsetzen zu können. Es
	geht auch ohne diese Option, allerdings werden Sie dann nur
	den Namen der Funktion sehen, in der Sie sich gerade befinden,
	anstatt direkt den zugehörigen Quelltext. Falls Sie eine
	Meldung wie die folgende sehen:</p><pre class="screen">&#8230; (no debugging symbols found) &#8230;</pre><p>wenn der <code class="command">gdb</code> gestartet wird, dann
	wissen Sie, daß das Programm nicht mit der Option
	<code class="option">-g</code> kompiliert wurde.</p><p>Geben Sie in der Eingabeaufforderung des
	<code class="command">gdb</code> <strong class="userinput"><code>break main</code></strong> ein.
	Dies weist den Debugger an, dass Sie nicht daran interessiert sind,
	den einleitenden Schritten beim Programmstart zuzusehen und dass
	am Anfang Ihres Codes die Ausführung beginnen soll.  Geben Sie
	nun <strong class="userinput"><code>run</code></strong> ein, um das Programm zu starten -
	es wird starten und beim Aufruf von <code class="function">main()</code> vom
	Debugger angehalten werden. (Falls Sie sich jemals gewundert haben von
	welcher Stelle <code class="function">main()</code> aufgerufen wird, dann
	wissen Sie es jetzt!).</p><p>Sie können nun Schritt für Schritt durch Ihr
	Programm gehen, indem Sie <code class="command">n</code> drücken.
	Wenn Sie zu einem Funktionsaufruf kommen können Sie diese
	Funktion durch drücken von <code class="command">s</code> betreten.
	Sobald Sie sich in einem Funktionsaufruf befinden können
	Sie diesen durch drücken von <code class="command">f</code> wieder
	verlassen. Sie können auch <code class="command">up</code> und
	<code class="command">down</code> verwenden, um sich schnell den
	Aufrufer einer Funktion anzusehen.</p><p>Hier ist ein einfaches Beispiel, wie man mit Hilfe des
	<code class="command">gdb</code> einen Fehler in einem Programm findet.
	Dies ist unser eigenes Programm (mit einem absichtlich
	eingebauten Fehler):</p><pre class="programlisting">#include &lt;stdio.h&gt;

int bazz(int anint);

main() {
	int i;

	printf("This is my program\n");
	bazz(i);
	return 0;
}

int bazz(int anint) {
	printf("You gave me %d\n", anint);
	return anint;
}</pre><p>Dieses Programm setzt <span class="symbol">i</span> auf den Wert
	<code class="literal">5</code> und übergibt dies einer Funktion
	<code class="function">bazz()</code>, welche den Wert ausgibt, den Sie
	von uns erhalten hat.</p><p>Wenn wir das Programm kompilieren und ausführen
	erhalten wir</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -g -o temp temp.c</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./temp</code></strong>
This is my program
anint = 4231</pre><p>Das ist nicht was wir erwartet hatten! Es ist Zeit,
	daß wir sehen was hier passiert!</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>gdb temp</code></strong>
GDB is free software and you are welcome to distribute copies of it
 under certain conditions; type "show copying" to see the conditions.
There is absolutely no warranty for GDB; type "show warranty" for details.
GDB 4.13 (i386-unknown-freebsd), Copyright 1994 Free Software Foundation, Inc.
(gdb) <strong class="userinput"><code>break main</code></strong>				<em class="lineannotation"><span class="lineannotation">Skip the set-up code</span></em>
Breakpoint 1 at 0x160f: file temp.c, line 9.	<em class="lineannotation"><span class="lineannotation">gdb puts breakpoint at main()</span></em>
(gdb) <strong class="userinput"><code>run</code></strong>					<em class="lineannotation"><span class="lineannotation">Run as far as main()</span></em>
Starting program: /home/james/tmp/temp		<em class="lineannotation"><span class="lineannotation">Program starts running</span></em>

Breakpoint 1, main () at temp.c:9		<em class="lineannotation"><span class="lineannotation">gdb stops at main()</span></em>
(gdb) <strong class="userinput"><code>n</code></strong>						<em class="lineannotation"><span class="lineannotation">Go to next line</span></em>
This is my program				<em class="lineannotation"><span class="lineannotation">Program prints out</span></em>
(gdb) <strong class="userinput"><code>s</code></strong>						<em class="lineannotation"><span class="lineannotation">step into bazz()</span></em>
bazz (anint=4231) at temp.c:17			<em class="lineannotation"><span class="lineannotation">gdb displays stack frame</span></em>
(gdb)</pre><p>Halt mal! Wieso hat denn <span class="symbol">anint</span> den Wert
	<code class="literal">4231</code>? Haben wir dieser Variablen nicht in
	<code class="function">main()</code> den Wert <code class="literal">5</code>
	zugewiesen? Gehen wir mal zurück zu
	<code class="function">main()</code> und schauen dort nach.</p><pre class="screen">(gdb) <strong class="userinput"><code>up</code></strong>					<em class="lineannotation"><span class="lineannotation">Move up call stack</span></em>
#1  0x1625 in main () at temp.c:11		<em class="lineannotation"><span class="lineannotation">gdb displays stack frame</span></em>
(gdb) <strong class="userinput"><code>p i</code></strong>					<em class="lineannotation"><span class="lineannotation">Show us the value of i</span></em>
$1 = 4231					<em class="lineannotation"><span class="lineannotation">gdb displays 4231</span></em></pre><p>Oh! Anscheinend haben wir vergessen <span class="symbol">i</span> zu
	initialisieren. Wir wollten eigentlich</p><pre class="programlisting"><em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
main() {
	int i;

	i = 5;
	printf("This is my program\n");
<em class="lineannotation"><span class="lineannotation">&#8230;</span></em></pre><p>schreiben, haben aber die Zeile mit
	<code class="literal">i=5;</code> vergessen. Da wir <span class="symbol">i</span>
	nicht initialisiert haben hatte diese Variable gerade den
	Wert, der in dem ihr zugewiesenen Speicherbereich stand als
	wir das Programm gestartet haben, welcher in diesem Fall
	<code class="literal">4231</code> war.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Der <code class="command">gdb</code> zeigt jedes mal, wenn wir
	  eine Funktion betreten oder verlassen, den Inhalt des
	  Stack-Rahmens an, selbst wenn wir uns mit
	  <code class="command">up</code> und <code class="command">down</code> im
	  Aufruf-Stack umher bewegen. Dabei wird der Name der Funktion
	  sowie der übergebenen Argumente angezeigt, was uns
	  dabei hilft, die Übersicht zu behalten. (Der Stack ist
	  ein Speicherbereich, in dem ein Programm Informationen
	  über die an eine Funktion übergebenen Argumente
	  ablegt, sowie die Rücksprungadresse eines
	  Funktionsaufrufes).</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63144528"></a>2.6.3. Eine Kernspeicherdatei untersuchen</h3></div></div></div><p>Eine Kernspeicherdatei ist im Prinzip eine Datei, die den
	vollständigen Zustand eines Prozesses enthält, als
	dieses abgestürzt ist. In <span class="quote">&#8222;<span class="quote">den guten alten
	Zeiten</span>&#8220;</span> mußten Programmierer hexadezimale Listen
	der Kernspeicherdatei ausdrucken und über
	Maschinencodehandbüchern schwitzen, aber heutzutage ist
	das Leben etwas einfacher geworden. Zufälligerweise wird
	die Kernspeicherdatei unter FreeBSD und anderen
	4.4BSD-Systemen
	<code class="filename">progname.core</code>
	anstatt einfach nur <code class="filename">core</code> genannt, um
	deutlich zu machen, zu welchem Programm eine Kernspeicherdatei
	gehört.</p><p>Um eine Kernspeicherdatei zu untersuchen müssen Sie
	den <code class="command">gdb</code> wie gewohnt starten. An Stelle von
	<code class="command">break</code> oder <code class="command">run</code>
	müssen Sie das Folgende eingeben</p><pre class="screen">(gdb) <strong class="userinput"><code>core progname.core</code></strong></pre><p>Wenn Sie sich nicht in demselben Verzeichnis befinden wie
	die Kernspeicherdatei müssen Sie zuerst <strong class="userinput"><code>dir
	/path/to/core/file</code></strong> eingeben.</p><p>Sie sollten dann etwas wie folgt sehen:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>gdb a.out</code></strong>
GDB is free software and you are welcome to distribute copies of it
 under certain conditions; type "show copying" to see the conditions.
There is absolutely no warranty for GDB; type "show warranty" for details.
GDB 4.13 (i386-unknown-freebsd), Copyright 1994 Free Software Foundation, Inc.
(gdb) <strong class="userinput"><code>core a.out.core</code></strong>
Core was generated by `a.out'.
Program terminated with signal 11, Segmentation fault.
Cannot access memory at address 0x7020796d.
#0  0x164a in bazz (anint=0x5) at temp.c:17
(gdb)</pre><p>In diesem Fall hieß das Programm
	<code class="filename">a.out</code>, weshalb die Kernspeicherdatei den
	Namen <code class="filename">a.out.core</code> trägt. Wie wir
	sehen können stürzte das Programm in einer Funktion
	namens <code class="function">bazz</code> ab, als es versuchte auf
	einen Speicherbereich zuzugreifen, der dem Programm nicht zur
	Verfügung stand.</p><p>Manchmal ist es ganz nützlich zu sehen, wie eine
	Funktion aufgerufen wurde, da bei komplexen Programmen das
	eigentliche Problem schon sehr viel weiter oben auf dem
	Aufruf-Stack aufgetreten sein könnte. Der Befehl
	<code class="command">bt</code> veranlaßt den
	<code class="command">gdb</code> dazu, einen Backtrace des Aufruf-Stacks
	auszugeben:</p><pre class="screen">(gdb) <strong class="userinput"><code>bt</code></strong>
#0  0x164a in bazz (anint=0x5) at temp.c:17
#1  0xefbfd888 in end ()
#2  0x162c in main () at temp.c:11
(gdb)</pre><p>Die Funktion <code class="function">end()</code> wird aufgerufen,
	wenn ein Programm abstürzt; in diesem Fall wurde die
	Funktion <code class="function">bazz()</code> aus der
	<code class="function">main()</code>-Funktion heraus aufgerufen.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63181904"></a>2.6.4. Ein bereits laufendes Programm untersuchen</h3></div></div></div><p>Eine der tollsten Features des <code class="command">gdb</code>
	ist die Möglichkeit, damit bereits laufende Programme zu
	untersuchen. Dies bedeutet natürlich, daß Sie die
	erforderlichen Rechte dafür besitzen. Ein häufig
	auftretendes Problem ist das Untersuchen eines Programmes,
	welches sich selber forkt. Vielleicht will man den Kindprozess
	untersuchen, aber der Debugger erlaubt einem nur den Zugriff
	auf den Elternprozess.</p><p>Was Sie an solch einer Stelle machen ist, Sie starten
	einen weiteren <code class="command">gdb</code>, ermitteln mit Hilfe von
	<code class="command">ps</code> die Prozess-ID des Kindprozesses, und
	geben</p><pre class="screen">(gdb) <strong class="userinput"><code>attach pid</code></strong></pre><p>im <code class="command">gdb</code> ein, und können dann wie
	üblich mit der Fehlersuche fortfahren.</p><p><span class="quote">&#8222;<span class="quote">Das ist zwar alles sehr schön,</span>&#8220;</span> werden
	Sie jetzt vielleicht denken, <span class="quote">&#8222;<span class="quote">aber in der Zeit, in der
	ich diese Schritte durchführe, ist der Kindprozess schon
	längst über alle Berge</span>&#8220;</span>. Fürchtet euch
	nicht, edler Leser, denn Ihr müßt wie folgt
	vorgehen (freundlicherweise zur Verfügung gestellt von
	den Info-Seite des <code class="command">gdb</code>):</p><pre class="screen"><em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
if ((pid = fork()) &lt; 0)		/* _Always_ check this */
	error();
else if (pid == 0) {		/* child */
	int PauseMode = 1;

	while (PauseMode)
		sleep(10);	/* Wait until someone attaches to us */
	<em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
} else {			/* parent */
	<em class="lineannotation"><span class="lineannotation">&#8230;</span></em></pre><p>Alles was Sie jetzt noch tun müssen ist, sich an
	den Kindprozess ranzuhängen, <span class="symbol">PauseMode</span>
	auf <code class="literal">0</code> zu setzen und auf den
	<code class="function">sleep()</code> Funktionsaufruf zu warten, um
	zurückzukehren!</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="emacs"></a>2.7. Emacs als Entwicklungsumgebung verwenden</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63211728"></a>2.7.1. Emacs</h3></div></div></div><p>Leider werden <span class="trademark">UNIX</span>®-Systeme nicht mit einem
	alles-was-du-jemals-brauchst-und-vieles-mehr-megapaket an
	integrierten Entwicklungsumgebungen ausgestattet, die bei
	anderen Systemen dabei sind.

	<a href="#ftn.idp63215184" class="footnote" id="idp63215184"><sup class="footnote">[7]</sup></a>

	Trotzdem ist es möglich, seine eigene
	Entwicklungsumgebung aufzusetzen. Diese wird vielleicht nicht
	so hübsch und integriert sein, aber dafür
	können Sie sie Ihren eigenen Wünschen anpassen. Und
	sie ist frei. Und Sie haben die Quelltexte davon.</p><p>Der Schlüssel zu all dem ist Emacs. Es gibt zwar ein
	paar Leute die ihn hassen, es gibt jedoch auch viele die ihn
	lieben. Falls Sie zu ersteren gehören befürchte ich,
	daß dieser Abschnitt Ihnen wenig interessantes zu bieten
	hat. Des weiteren benötigen Sie eine angemessene Menge an
	freiem Speicher, um ihn zu benutzen&#8212;ich würde 8MB
	für den Textmodus und 16MB unter X als absolutes Minimum
	empfehlen, um eine halbwegs brauchbare Performance zu
	erhalten.</p><p>Emacs ist im Prinzip ein extrem anpassbarer Editor&#8212;
	in der Tat ist er so stark veränderbar, daß er eher
	einem Betriebssystem als einem Editor gleicht! Viele
	Entwickler und Systemadministratoren erledigen praktisch ihre
	gesamte Arbeit aus Emacs heraus und beenden ihn nur, um sich
	komplett auszuloggen.</p><p>Es ist nicht einmal möglich alles hier
	zusammenzufassen, was man mit dem Emacs machen kann. Im
	Folgenden werden einige Features aufgelistet, die für
	einen Entwickler interessant sein könnten:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Sehr mächtiger Editor, der suchen-und-ersetzen
	    mit Zeichenfolgen und regulären Ausdrücken
	    (Pattern) sowie das direkte Anspringen von Anfang/Ende von
	    Blockausdrücken erlaubt, etc, etc.</p></li><li class="listitem"><p>Pull-Down Menüs und eine Online-Hilfe.</p></li><li class="listitem"><p>Sprachunabhängige Syntaxhervorhebung und
	    automatische Einrückung.</p></li><li class="listitem"><p>Vollständig konfigurierbar.</p></li><li class="listitem"><p>Sie können Programme im Emacs kompilieren und
	    debuggen.</p></li><li class="listitem"><p>Bei Kompilationsfehlern können Sie direkt zu der
	    entsprechenden Zeile im Quelltext springen.</p></li><li class="listitem"><p>Benutzerfreundliches Front-End für das
	    <code class="command">info</code>-Programm, um die GNU Hypertext
	    Dokumentation inklusive der Dokumentation des Emacs
	    selber.</p></li><li class="listitem"><p>Benutzerfreundliches Front-End für den
	    <code class="command">gdb</code> um sich beim Verfolgen der
	    Programmanweisungen den zugehörigen Quelltext
	    anzeigen zu lassen.</p></li><li class="listitem"><p>Sie können E-Mails und News im Usenet lesen,
	    während ihr Programm kompiliert wird.</p></li></ul></div><p>Und zweifelsfrei viele weitere Punkte, die ich
	übersehen habe.</p><p>Emacs kann unter FreeBSD über den	<a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/editors/emacs/pkg-descr">editors/emacs</a> Port installiert werden.</p><p>Sobald er installiert ist starten Sie ihn, und geben
	dann <strong class="userinput"><code>C-h t</code></strong> ein, um die Einführung
	in Emacs zu lesen&#8212;d.h. Sie sollen bei gedrückter
	<span class="keycap"><strong>Strg</strong></span>-Taste die <span class="keycap"><strong>h</strong></span>-Taste
	drücken, beide wieder loslassen und anschließend
	<span class="keycap"><strong>t</strong></span> drücken. (Alternativ können Sie
	mit der Maus den Eintrag <span class="guimenuitem">Emacs
	Tutorial</span> aus dem
	<span class="guimenu">Hilfe</span>-Menü auswählen).</p><p>Obwohl der Emacs Menüs besitzt ist das Erlernen der
	Tastaturkombinationen lohnenswert, da man beim Editieren sehr
	viel schneller Tastenkombinationen eingeben kann, als die Maus
	zu finden und mit dieser dann an der richtigen Stelle zu
	klicken. Und wenn Sie sich mit erfahrenen Emacs-Benutzern
	unterhalten werden Sie feststellen, daß diese
	häufig nebenbei Ausdrücke wie <span class="quote">&#8222;<span class="quote"><code class="literal">M-x
	replace-s RET foo RET bar RET</code></span>&#8220;</span> verwenden,
	weshalb das Erlernen dieser sehr nützlich ist. Und Emacs
	hat auf jeden Fall weit mehr nützliche Funktionen als das
	diese in der Menüleiste unterzubringen wären.</p><p>Zum Glück ist es sehr einfach die jeweiligen
	Tastaturkombinationen herauszubekommen, da diese direkt neben
	den Menüeinträgen stehen. Meine Empfehlung
	wäre, den Menüeintrag für, sagen wir, das
	Öffnen einer Datei zu verwenden, bis Sie die
	Funktionsweise verstanden haben und sie mit dieser vertraut
	sind, und es dann mit C-x C-f versuchen. Wenn Sie damit
	zufrieden sind, gehen Sie zum nächsten
	Menüeintrag.</p><p>Falls Sie sich nicht daran erinnern können, was eine
	bestimmte Tastenkombination macht, wählen Sie
	<span class="guimenuitem">Describe Key</span> aus dem
	<span class="guimenu">Hilfe</span>-Menü aus und geben Sie die
	Tastenkombination ein&#8212;Emacs sagt Ihnen dann was diese
	macht. Sie können ebenfalls den Menüeintrag
	<span class="guimenuitem">Command Apropos</span> verwenden, um alle
	Befehle, die ein bestimmtes Wort enthalten, mit den
	zugehörigen Tastenkombinationen aufgelistet zu
	bekommen.</p><p>Übrigends bedeutet der Ausdruck weiter oben, bei
	gedrückter <span class="keysym">Meta</span>-Taste <span class="keysym">x</span>
	zu drücken, beide wieder loszulassen,
	<strong class="userinput"><code>replace-s</code></strong> einzugeben (Kurzversion
	für <code class="literal">replace-string</code>&#8212;ein weiteres
	Feature des Emacs ist, daß Sie Befehle abkürzen
	können), anschließend die
	<span class="keysym">return</span>-Taste zu drücken, dann
	<strong class="userinput"><code>foo</code></strong> einzugeben (die Zeichenkette, die
	Sie ersetzen möchten), dann wieder
	<span class="keysym">return</span>, dann die Leertaste zu drücken
	(die Zeichenkette, mit der Sie <code class="literal">foo</code> ersetzen
	möchten) und anschließend erneut
	<span class="keysym">return</span> zu drücken. Emacs wird dann die
	gewünschte suchen-und-ersetzen-Operation
	ausführen.</p><p>Wenn Sie sich fragen was in aller Welt die
	<span class="keysym">Meta</span>-Taste ist, das ist eine spezielle Taste
	die viele <span class="trademark">UNIX</span>®-Workstations besitzen. Bedauerlicherweise
	haben PCs keine solche Taste, und daher ist es
	üblicherweise die <span class="keycap"><strong>alt</strong></span>-Taste (oder falls
	Sie Pech haben die <span class="keycap"><strong>Esc</strong></span>-Taste).</p><p>Oh, und um den Emacs zu verlassen müssen sie
	<code class="command">C-x C-c</code> (das bedeutet, Sie müssen bei
	gedrückter <span class="keysym">Strg</span>-Taste zuerst
	<span class="keysym">x</span> und dann <span class="keysym">c</span> drücken)
	eingeben. Falls Sie noch irgendwelche ungespeicherten Dateien
	offen haben wird Emacs Sie fragen ob Sie diese speichern
	wollen. (Ignorieren Sie bitte die Stelle der Dokumentation, an
	der gesagt wird, daß <code class="command">C-z</code> der
	übliche Weg ist, Emacs zu verlassen&#8212;dadurch wird
	der Emacs in den Hintergrund geschaltet, was nur nützlich
	ist, wenn Sie an einem System ohne virtuelle Terminals
	arbeiten).</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp63287632"></a>2.7.2. Emacs konfigurieren</h3></div></div></div><p>Emacs kann viele wundervolle Dinge; manche dieser Dinge
	sind schon eingebaut, andere müssen erst konfiguriert
	werden.</p><p>Anstelle einer proprietären Macrosprache verwendet
	der Emacs für die Konfiguration eine speziell für
	Editoren angepaßte Version von Lisp, auch bekannt als
	Emacs Lisp. Das Arbeiten mit Emacs Lisp kann sehr hilfreich
	sein, wenn Sie darauf aufbauend etwas wie Common Lisp lernen
	möchten. Emacs Lisp hat viele Features von Common Lisp
	obwohl es beträchtlich kleiner ist (und daher auch
	einfacher zu beherrschen).</p><p>Der beste Weg um Emacs Lisp zu erlernen besteht darin,
	sich das <a class="link" href="ftp://ftp.gnu.org/old-gnu/emacs/elisp-manual-19-2.4.tar.gz" target="_top">Emacs
	Tutorial</a> herunterzuladen.</p><p>Es ist jedoch keine Kenntnis von Lisp erforderlich, um
	mit der Konfiguration von Emacs zu beginnen, da ich eine
	beispielhafte <code class="filename">.emacs</code>-Datei hier
	eingefügt habe, die für den Anfang ausreichen
	sollte. Kopieren Sie diese einfach in Ihr Heimverzeichnis und
	starten Sie den Emacs neu, falls dieser bereits läuft; er
	wird die Befehle aus der Datei lesen und Ihnen (hoffentlich)
	eine brauchbare Grundeinstellung bieten.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp65699408"></a>2.7.3. Eine beispielhafte <code class="filename">.emacs</code>-Datei</h3></div></div></div><p>Bedauerlicherweise gibt es hier viel zu viel, um es im
	Detail zu erklären; es gibt jedoch ein oder zwei Punkte,
	die besonders erwähnenswert sind.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Alles was mit einem <code class="literal">;</code> anfängt
	    ist ein Kommentar und wird von Emacs ignoriert.</p></li><li class="listitem"><p>In der ersten Zeile mit
	    <code class="literal">-*- Emacs-Lisp -*-</code> sorgt
	    dafür, daß wir die Datei
	    <code class="filename">.emacs</code> in Emacs selber editieren
	    können und uns damit alle tollen Features zum
	    Editieren von Emacs Lisp zur Verfügung stehen. Emacs
	    versucht dies normalerweise anhand des Dateinamens
	    auszumachen, was vielleicht bei
	    <code class="filename">.emacs</code> nicht funktionieren
	    könnte.</p></li><li class="listitem"><p>Die <span class="keysym">Tab</span>-Taste ist in manchen Modi
	    an die Einrückungsfunktion gebunden, so daß
	    beim drücken dieser Taste die aktuelle Zeile
	    eingerückt wird. Wenn Sie ein
	    <span class="token">tab</span>-Zeichen in einen Text, welchen auch
	    immer Sie dabei schreiben, einfügen wollen,
	    müssen Sie bei gedrückter
	    <span class="keysym">Strg</span>-Taste die <span class="keysym">Tab</span>-Taste
	    drücken.</p></li><li class="listitem"><p>Diese Datei unterstützt Syntax Highlighting
	    für C, C++, Perl, Lisp und Scheme, indem die Sprache
	    anhand des Dateinamens erraten wird.</p></li><li class="listitem"><p>Emacs hat bereits eine vordefinierte Funktion mit dem
	    Namen <code class="function">next-error</code>. Diese erlaubt es
	    einem, in einem Fenster mit der Kompilierungsausgabe
	    mittels <code class="command">M-n</code> von einem zum nächsten
	    Kompilierungsfehler zu springen; wir definieren eine
	    komplementäre Funktion
	    <code class="function">previous-error</code>, die es uns erlaubt,
	    mittels <code class="command">M-p</code> von einem zum vorherigen
	    Kompilierungsfehler zu springen. Das schönste Feature
	    von allen ist, daß mittels <code class="command">C-c
	    C-c</code> die Quelltextdatei, in der der Fehler
	    aufgetreten ist, geöffnet und die betreffende Zeile
	    direkt angesprungen wird.</p></li><li class="listitem"><p>Wir aktivieren die Möglichkeit von Emacs als
	    Server zu agieren, so daß wenn Sie etwas
	    außerhalb von Emacs machen und eine Datei editieren
	    möchten, Sie einfach das folgende eingeben
	    können</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>emacsclient filename</code></strong>
	  </pre><p>und dann die Datei in Ihrem Emacs editieren
	    können!

	    <a href="#ftn.idp65712080" class="footnote" id="idp65712080"><sup class="footnote">[8]</sup></a>
	  </p></li></ul></div><div class="example"><a id="idp65742800"></a><div class="example-title">Beispiel 2.1. Eine einfache <code class="filename">.emacs</code>-Datei</div><div class="example-contents"><pre class="programlisting">;; -*-Emacs-Lisp-*-

;; This file is designed to be re-evaled; use the variable first-time
;; to avoid any problems with this.
(defvar first-time t
  "Flag signifying this is the first time that .emacs has been evaled")

;; Meta
(global-set-key "\M- " 'set-mark-command)
(global-set-key "\M-\C-h" 'backward-kill-word)
(global-set-key "\M-\C-r" 'query-replace)
(global-set-key "\M-r" 'replace-string)
(global-set-key "\M-g" 'goto-line)
(global-set-key "\M-h" 'help-command)

;; Function keys
(global-set-key [f1] 'manual-entry)
(global-set-key [f2] 'info)
(global-set-key [f3] 'repeat-complex-command)
(global-set-key [f4] 'advertised-undo)
(global-set-key [f5] 'eval-current-buffer)
(global-set-key [f6] 'buffer-menu)
(global-set-key [f7] 'other-window)
(global-set-key [f8] 'find-file)
(global-set-key [f9] 'save-buffer)
(global-set-key [f10] 'next-error)
(global-set-key [f11] 'compile)
(global-set-key [f12] 'grep)
(global-set-key [C-f1] 'compile)
(global-set-key [C-f2] 'grep)
(global-set-key [C-f3] 'next-error)
(global-set-key [C-f4] 'previous-error)
(global-set-key [C-f5] 'display-faces)
(global-set-key [C-f8] 'dired)
(global-set-key [C-f10] 'kill-compilation)

;; Keypad bindings
(global-set-key [up] "\C-p")
(global-set-key [down] "\C-n")
(global-set-key [left] "\C-b")
(global-set-key [right] "\C-f")
(global-set-key [home] "\C-a")
(global-set-key [end] "\C-e")
(global-set-key [prior] "\M-v")
(global-set-key [next] "\C-v")
(global-set-key [C-up] "\M-\C-b")
(global-set-key [C-down] "\M-\C-f")
(global-set-key [C-left] "\M-b")
(global-set-key [C-right] "\M-f")
(global-set-key [C-home] "\M-&lt;")
(global-set-key [C-end] "\M-&gt;")
(global-set-key [C-prior] "\M-&lt;")
(global-set-key [C-next] "\M-&gt;")

;; Mouse
(global-set-key [mouse-3] 'imenu)

;; Misc
(global-set-key [C-tab] "\C-q\t")	; Control tab quotes a tab.
(setq backup-by-copying-when-mismatch t)

;; Treat 'y' or &lt;CR&gt; as yes, 'n' as no.
(fset 'yes-or-no-p 'y-or-n-p)
(define-key query-replace-map [return] 'act)
(define-key query-replace-map [?\C-m] 'act)

;; Load packages
(require 'desktop)
(require 'tar-mode)

;; Pretty diff mode
(autoload 'ediff-buffers "ediff" "Intelligent Emacs interface to diff" t)
(autoload 'ediff-files "ediff" "Intelligent Emacs interface to diff" t)
(autoload 'ediff-files-remote "ediff"
  "Intelligent Emacs interface to diff")

(if first-time
    (setq auto-mode-alist
	  (append '(("\\.cpp$" . c++-mode)
		    ("\\.hpp$" . c++-mode)
		    ("\\.lsp$" . lisp-mode)
		    ("\\.scm$" . scheme-mode)
		    ("\\.pl$" . perl-mode)
		    ) auto-mode-alist)))

;; Auto font lock mode
(defvar font-lock-auto-mode-list
  (list 'c-mode 'c++-mode 'c++-c-mode 'emacs-lisp-mode 'lisp-mode 'perl-mode 'scheme-mode)
  "List of modes to always start in font-lock-mode")

(defvar font-lock-mode-keyword-alist
  '((c++-c-mode . c-font-lock-keywords)
    (perl-mode . perl-font-lock-keywords))
  "Associations between modes and keywords")

(defun font-lock-auto-mode-select ()
  "Automatically select font-lock-mode if the current major mode is in font-lock-auto-mode-list"
  (if (memq major-mode font-lock-auto-mode-list)
      (progn
	(font-lock-mode t))
    )
  )

(global-set-key [M-f1] 'font-lock-fontify-buffer)

;; New dabbrev stuff
;(require 'new-dabbrev)
(setq dabbrev-always-check-other-buffers t)
(setq dabbrev-abbrev-char-regexp "\\sw\\|\\s_")
(add-hook 'emacs-lisp-mode-hook
	  '(lambda ()
	     (set (make-local-variable 'dabbrev-case-fold-search) nil)
	     (set (make-local-variable 'dabbrev-case-replace) nil)))
(add-hook 'c-mode-hook
	  '(lambda ()
	     (set (make-local-variable 'dabbrev-case-fold-search) nil)
	     (set (make-local-variable 'dabbrev-case-replace) nil)))
(add-hook 'text-mode-hook
	  '(lambda ()
	     (set (make-local-variable 'dabbrev-case-fold-search) t)
	     (set (make-local-variable 'dabbrev-case-replace) t)))

;; C++ and C mode...
(defun my-c++-mode-hook ()
  (setq tab-width 4)
  (define-key c++-mode-map "\C-m" 'reindent-then-newline-and-indent)
  (define-key c++-mode-map "\C-ce" 'c-comment-edit)
  (setq c++-auto-hungry-initial-state 'none)
  (setq c++-delete-function 'backward-delete-char)
  (setq c++-tab-always-indent t)
  (setq c-indent-level 4)
  (setq c-continued-statement-offset 4)
  (setq c++-empty-arglist-indent 4))

(defun my-c-mode-hook ()
  (setq tab-width 4)
  (define-key c-mode-map "\C-m" 'reindent-then-newline-and-indent)
  (define-key c-mode-map "\C-ce" 'c-comment-edit)
  (setq c-auto-hungry-initial-state 'none)
  (setq c-delete-function 'backward-delete-char)
  (setq c-tab-always-indent t)
;; BSD-ish indentation style
  (setq c-indent-level 4)
  (setq c-continued-statement-offset 4)
  (setq c-brace-offset -4)
  (setq c-argdecl-indent 0)
  (setq c-label-offset -4))

;; Perl mode
(defun my-perl-mode-hook ()
  (setq tab-width 4)
  (define-key c++-mode-map "\C-m" 'reindent-then-newline-and-indent)
  (setq perl-indent-level 4)
  (setq perl-continued-statement-offset 4))

;; Scheme mode...
(defun my-scheme-mode-hook ()
  (define-key scheme-mode-map "\C-m" 'reindent-then-newline-and-indent))

;; Emacs-Lisp mode...
(defun my-lisp-mode-hook ()
  (define-key lisp-mode-map "\C-m" 'reindent-then-newline-and-indent)
  (define-key lisp-mode-map "\C-i" 'lisp-indent-line)
  (define-key lisp-mode-map "\C-j" 'eval-print-last-sexp))

;; Add all of the hooks...
(add-hook 'c++-mode-hook 'my-c++-mode-hook)
(add-hook 'c-mode-hook 'my-c-mode-hook)
(add-hook 'scheme-mode-hook 'my-scheme-mode-hook)
(add-hook 'emacs-lisp-mode-hook 'my-lisp-mode-hook)
(add-hook 'lisp-mode-hook 'my-lisp-mode-hook)
(add-hook 'perl-mode-hook 'my-perl-mode-hook)

;; Complement to next-error
(defun previous-error (n)
  "Visit previous compilation error message and corresponding source code."
  (interactive "p")
  (next-error (- n)))

;; Misc...
(transient-mark-mode 1)
(setq mark-even-if-inactive t)
(setq visible-bell nil)
(setq next-line-add-newlines nil)
(setq compile-command "make")
(setq suggest-key-bindings nil)
(put 'eval-expression 'disabled nil)
(put 'narrow-to-region 'disabled nil)
(put 'set-goal-column 'disabled nil)
(if (&gt;= emacs-major-version 21)
	(setq show-trailing-whitespace t))

;; Elisp archive searching
(autoload 'format-lisp-code-directory "lispdir" nil t)
(autoload 'lisp-dir-apropos "lispdir" nil t)
(autoload 'lisp-dir-retrieve "lispdir" nil t)
(autoload 'lisp-dir-verify "lispdir" nil t)

;; Font lock mode
(defun my-make-face (face color &amp;optional bold)
  "Create a face from a color and optionally make it bold"
  (make-face face)
  (copy-face 'default face)
  (set-face-foreground face color)
  (if bold (make-face-bold face))
  )

(if (eq window-system 'x)
    (progn
      (my-make-face 'blue "blue")
      (my-make-face 'red "red")
      (my-make-face 'green "dark green")
      (setq font-lock-comment-face 'blue)
      (setq font-lock-string-face 'bold)
      (setq font-lock-type-face 'bold)
      (setq font-lock-keyword-face 'bold)
      (setq font-lock-function-name-face 'red)
      (setq font-lock-doc-string-face 'green)
      (add-hook 'find-file-hooks 'font-lock-auto-mode-select)

      (setq baud-rate 1000000)
      (global-set-key "\C-cmm" 'menu-bar-mode)
      (global-set-key "\C-cms" 'scroll-bar-mode)
      (global-set-key [backspace] 'backward-delete-char)
					;      (global-set-key [delete] 'delete-char)
      (standard-display-european t)
      (load-library "iso-transl")))

;; X11 or PC using direct screen writes
(if window-system
    (progn
      ;;      (global-set-key [M-f1] 'hilit-repaint-command)
      ;;      (global-set-key [M-f2] [?\C-u M-f1])
      (setq hilit-mode-enable-list
	    '(not text-mode c-mode c++-mode emacs-lisp-mode lisp-mode
		  scheme-mode)
	    hilit-auto-highlight nil
	    hilit-auto-rehighlight 'visible
	    hilit-inhibit-hooks nil
	    hilit-inhibit-rebinding t)
      (require 'hilit19)
      (require 'paren))
  (setq baud-rate 2400)			; For slow serial connections
  )

;; TTY type terminal
(if (and (not window-system)
	 (not (equal system-type 'ms-dos)))
    (progn
      (if first-time
	  (progn
	    (keyboard-translate ?\C-h ?\C-?)
	    (keyboard-translate ?\C-? ?\C-h)))))

;; Under UNIX
(if (not (equal system-type 'ms-dos))
    (progn
      (if first-time
	  (server-start))))

;; Add any face changes here
(add-hook 'term-setup-hook 'my-term-setup-hook)
(defun my-term-setup-hook ()
  (if (eq window-system 'pc)
      (progn
;;	(set-face-background 'default "red")
	)))

;; Restore the "desktop" - do this as late as possible
(if first-time
    (progn
      (desktop-load-default)
      (desktop-read)))

;; Indicate that this file has been read at least once
(setq first-time nil)

;; No need to debug anything now

(setq debug-on-error nil)

;; All done
(message "All done, %s%s" (user-login-name) ".")
	</pre></div></div><br class="example-break" /></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp65744464"></a>2.7.4. Erweitern des von Emacs unterstützten Sprachbereichs</h3></div></div></div><p>Das ist jetzt alles sehr schön wenn Sie
	ausschließlich in einer der Sprachen programmieren
	wollen, um die wir uns bereits in der
	<code class="filename">.emacs</code>-Datei gekümmert haben (C,
	C++, Perl, Lisp und Scheme), aber was passiert wenn eine neue
	Sprache namens <span class="quote">&#8222;<span class="quote">whizbang</span>&#8220;</span> herauskommt, mit jeder
	Menge neuen tollen Features?</p><p>Als erstes muß festgestellt werden, ob whizbang mit
	irgendwelchen Dateien daherkommt, die Emacs etwas über
	die Sprache sagen. Diese enden üblicherweise auf
	<code class="filename">.el</code>, der Kurzform für <span class="quote">&#8222;<span class="quote">Emacs
	Lisp</span>&#8220;</span>. Falls whizbang zum Beispiel ein FreeBSD Port
	ist, könnten wir diese Dateien mittels</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>find /usr/ports/lang/whizbang -name "*.el" -print</code></strong></pre><p>finden und durch Kopieren in das Emacs-seitige
	Lisp-Verzeichnis installieren. Unter FreeBSD ist dies
	<code class="filename">/usr/local/share/emacs/site-lisp</code>.</p><p>Wenn zum Beispiel die Ausgabe des find-Befehls wie folgt
	war</p><pre class="screen">/usr/ports/lang/whizbang/work/misc/whizbang.el</pre><p>könnten wir das folgende tun</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp /usr/ports/lang/whizbang/work/misc/whizbang.el /usr/local/share/emacs/site-lisp</code></strong></pre><p>Als nächstes müssen wir festlegen, welche
	Dateiendung Quelltextdateien für whizbang haben. Lassen
	Sie uns um der Argumente Willen annehmen, die Dateiendung sei
	<code class="filename">.wiz</code>. Wir müssen dann einen Eintrag
	unserer <code class="filename">.emacs</code>-Datei hinzufügen um
	sicherzustellen, daß Emacs die Informationen in
	<code class="filename">whizbang.el</code> auch verwenden kann.</p><p>Suchen Sie den <span class="symbol">auto-mode-alist Eintrag</span>
	in der <code class="filename">.emacs</code>-Datei und fügen Sie an
	dieser Stelle eine Zeile wie folgt für whizbang
	hinzu:</p><pre class="programlisting"><em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
("\\.lsp$" . lisp-mode)
("\\.wiz$" . whizbang-mode)
("\\.scm$" . scheme-mode)
<em class="lineannotation"><span class="lineannotation">&#8230;</span></em></pre><p>Dies bedeutet das Emacs automatisch in den
	<code class="function">whizbang-mode</code> wechseln wird, wenn Sie
	eine Datei mit der Dateiendung <code class="filename">.wiz</code>
	editieren.</p><p>Direkt darunter werden Sie den Eintrag
	<span class="symbol">font-lock-auto-mode-list</span> finden. Erweitern
	Sie den <code class="function">whizbang-mode</code> um diesen wie
	folgt:</p><pre class="programlisting">;; Auto font lock mode
(defvar font-lock-auto-mode-list
  (list 'c-mode 'c++-mode 'c++-c-mode 'emacs-lisp-mode 'whizbang-mode 'lisp-mode 'perl-mode 'scheme-mode)
  "List of modes to always start in font-lock-mode")</pre><p>Dies bedeutet das Emacs immer
	<code class="function">font-lock-mode</code> (z.B. Syntax Highlighting)
	aktiviert, wenn Sie eine <code class="filename">.wiz</code>-Datei
	editieren.</p><p>Und das ist alles was benötigt wird. Falls es
	weitere Dinge gibt, die automatisch beim Öffnen einer
	<code class="filename">.wiz</code>-Datei ausgeführt werden sollen,
	können Sie einen <code class="function">whizbang-mode
	hook</code>-Eintrag hinzufügen (für ein
	einfaches Beispiel, welches <code class="function">auto-indent</code>
	hinzufügt, sehen Sie sich bitte
	<code class="function">my-scheme-mode-hook</code> an).</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-reading"></a>2.8. Weiterführende Literatur</h2></div></div></div><p>Für Informationen zum Aufsetzen einer
      Entwicklungsumgebung, um Fehlerbehebungen an FreeBSD selber
      beizusteuern sehen Sie sich bitte <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=development&amp;sektion=7"><span class="citerefentry"><span class="refentrytitle">development</span>(7)</span></a> an.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Brian Harvey and Matthew Wright
	  <span class="emphasis"><em>Simply Scheme</em></span>
	  MIT 1994.
	  ISBN 0-262-08226-8</p></li><li class="listitem"><p>Randall Schwartz
	  <span class="emphasis"><em>Learning Perl</em></span>
	  O'Reilly 1993
	  ISBN 1-56592-042-2</p></li><li class="listitem"><p>Patrick Henry Winston and Berthold Klaus Paul Horn
	  <span class="emphasis"><em>Lisp (3rd Edition)</em></span>
	  Addison-Wesley 1989
	  ISBN 0-201-08319-1</p></li><li class="listitem"><p>Brian W. Kernighan and Rob Pike
	  <span class="emphasis"><em>The Unix Programming Environment</em></span>
	  Prentice-Hall 1984
	  ISBN 0-13-937681-X</p></li><li class="listitem"><p>Brian W. Kernighan and Dennis M. Ritchie
	  <span class="emphasis"><em>The C Programming Language (2nd Edition)</em></span>
	  Prentice-Hall 1988
	  ISBN 0-13-110362-8</p></li><li class="listitem"><p>Bjarne Stroustrup
	<span class="emphasis"><em>The C++ Programming Language</em></span>
	Addison-Wesley 1991
	ISBN 0-201-53992-6</p></li><li class="listitem"><p>W. Richard Stevens
	  <span class="emphasis"><em>Advanced Programming in the Unix Environment</em></span>
	  Addison-Wesley 1992
	  ISBN 0-201-56317-7</p></li><li class="listitem"><p>W. Richard Stevens
	  <span class="emphasis"><em>Unix Network Programming</em></span>
	  Prentice-Hall 1990
	  ISBN 0-13-949876-1</p></li></ul></div></div><div class="footnotes"><br /><hr class="footnote-hr" /><div id="ftn.idp62243792" class="footnote"><p><a href="#idp62243792" class="para"><sup class="para">[1] </sup></a>Wenn die Anwendung über eine Eingabeaufforderung
	    gestartet wird könnte bei Auftreten eines
	    Programmfehlers dieses abgebrochen und ein Speicherabbild
	    erzeugt werden.</p></div><div id="ftn.idp62267472" class="footnote"><p><a href="#idp62267472" class="para"><sup class="para">[2] </sup></a>Um genau zu sein übersetzt der
	      <code class="command">cc</code> den Quelltext an dieser Stelle
	      nicht in Assemblersprache, sondern in seine eigene,
	      maschinenunabhängige Sprache namens
	      <em class="firstterm">p-code</em>.</p></div><div id="ftn.idp62317008" class="footnote"><p><a href="#idp62317008" class="para"><sup class="para">[3] </sup></a>Falls Sie es nicht wußten, Binary Sort ist, im
	  Gegensatz zu Bubble Sort, eine effektive Möglichkeit,
	  Dinge zu sortieren.</p></div><div id="ftn.idp62335824" class="footnote"><p><a href="#idp62335824" class="para"><sup class="para">[4] </sup></a>Der Grund dafür ist im Haufen der Geschichte
		begraben.</p></div><div id="ftn.idp62375888" class="footnote"><p><a href="#idp62375888" class="para"><sup class="para">[5] </sup></a>Beachten Sie, daß an dieser Stelle die
		Option <code class="option">-o</code> zum Festlegen des Namens
		der ausführbaren Datei nicht verwendet wurde,
		weswegen an dieser Stelle die erzeugte Datei
		<code class="filename">a.out</code> heißt. Die Erzeugung
		einer Debug-Version namens <code class="filename">foobar</code>
		ist als Übung dem Leser überlassen!</p></div><div id="ftn.idp62819024" class="footnote"><p><a href="#idp62819024" class="para"><sup class="para">[6] </sup></a>Verwenden Sie nicht <code class="filename">MAKEFILE</code> mit
	    lauter Großbuchstaben, da diese Schreibweise
	    häufig für Dokumentationsdateien wie
	    <code class="filename">README</code> benutzt wird.</p></div><div id="ftn.idp63215184" class="footnote"><p><a href="#idp63215184" class="para"><sup class="para">[7] </sup></a>Es gibt jetzt einige mächtige und freie IDEs in
	    der Ports-Sammlung wie etwa KDevelop.</p></div><div id="ftn.idp65712080" class="footnote"><p><a href="#idp65712080" class="para"><sup class="para">[8] </sup></a>Viele Emacs-Benutzer setzen Ihre
	        <code class="envar">EDITOR</code>-Umgebungsvariable auf
	        <code class="literal">emacsclient</code>, so daß dies
	        immer passiert, wenn sie eine Datei editieren
	        müssen.</p></div></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="secure"></a>Kapitel 3. Sicheres Programmieren</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Murray</span> <span class="surname">Stokely</span></span>. </span></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#secure-synopsis">3.1. Zusammenfassung</a></span></dt><dt><span class="sect1"><a href="#secure-philosophy">3.2. Methoden des sicheren Entwurfs</a></span></dt><dt><span class="sect1"><a href="#secure-bufferov">3.3. Puffer-Überläufe</a></span></dt><dt><span class="sect1"><a href="#secure-setuid">3.4. SetUID-Themen</a></span></dt><dt><span class="sect1"><a href="#secure-chroot">3.5. Die Umgebung ihrer Programme einschränken</a></span></dt><dt><span class="sect1"><a href="#secure-trust">3.6. Vertrauen</a></span></dt><dt><span class="sect1"><a href="#secure-race-conditions">3.7. Race-Conditions</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-synopsis"></a>3.1. Zusammenfassung</h2></div></div></div><p>Dieses Kapitel beschreibt einige Sicherheitsprobleme, die
      <span class="trademark">UNIX</span>®-Programmierer seit Jahrzehnten quälen, und
      inzwischen verfügbare Werkzeuge, die Programmierern helfen,
      Sicherheitslücken in ihrem Quelltext zu vermeiden.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-philosophy"></a>3.2. Methoden des sicheren Entwurfs</h2></div></div></div><p>Sichere Anwendungen zu schreiben erfordert eine sehr
      skeptische und pessimistische Lebenseinstellung. Anwendungen
      sollten nach dem Prinzip der <span class="quote">&#8222;<span class="quote">geringsten
      Privilegien</span>&#8220;</span> ausgeführt werden, sodass kein Prozess
      mit mehr als dem absoluten Minimum an Zugriffsrechten arbeitet,
      die er zum Erfüllen seiner Aufgabe benötigt. Wo es
      möglich ist, sollte Quelltext, der bereits
      überprüft wurde, wiederverwendet werden, um
      häufige Fehler, die andere schon korrigiert haben, zu
      vermeiden.</p><p>Eine der Stolperfallen der <span class="trademark">UNIX</span>®-Umgebung ist, dass es
      sehr einfach ist Annahmen über die Konsistenz der Umgebung
      zu machen. Anwendungen sollten Nutzereingaben (in allen Formen)
      niemals trauen, genauso wenig wie den System-Ressourcen,
      der Inter-Prozess-Kommunikation oder dem zeitlichen Ablauf von
      Ereignissen. <span class="trademark">UNIX</span>®-Prozesse arbeiten nicht synchron. Daher sind
      logische Operationen selten atomar.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-bufferov"></a>3.3. Puffer-Überläufe</h2></div></div></div><p>Puffer-Überläufe gibt es schon seit den
      Anfängen der Von-Neuman-Architektur <a class="xref" href="#COD">1</a>.

      <a id="idp65810640" class="indexterm"></a>
      <a id="idp65811152" class="indexterm"></a>

      Sie erlangten zum ersten Mal durch den Internetwurm Morris im
      Jahre 1988 öffentliche Bekanntheit. Unglücklicherweise

      <a id="idp65811664" class="indexterm"></a>

      funktioniert der gleiche grundlegende Angriff noch heute.  Die bei weitem
      häufigste Form eines Puffer-Überlauf-Angriffs basiert darauf,
      den Stack zu korrumpieren.</p><a id="idp65812304" class="indexterm"></a><a id="idp65812816" class="indexterm"></a><p>Die meisten modernen Computer-Systeme verwenden einen
      Stack, um Argumente an Prozeduren zu übergeben und
      lokale Variablen zu speichern. Ein Stack ist ein
      last-in-first-out-Puffer (LIFO) im hohen Speicherbereich
      eines Prozesses. Wenn ein Programm eine Funktion

      <a id="idp65813584" class="indexterm"></a>
      <a id="idp65814096" class="indexterm"></a>

      aufruft wird ein neuer "Stackframe" erzeugt. Dieser besteht aus
      den Argumenten, die der Funktion übergeben wurden und
      einem variabel grossem Bereich für lokale Variablen. Der
      "Stack-Pointer" ist ein Register, dass die

      <a id="idp65819472" class="indexterm"></a>
      <a id="idp65819984" class="indexterm"></a>

      aktuelle Adresse der Stack-Spitze enthält.
      Da sich dieser Wert oft ändert, wenn neue Werte
      auf dem Stack abgelegt werden, bieten viele Implementierungen
      einen "Frame-Pointer", der nahe am Anfang des Stack-Frames
      liegt und es so leichter macht lokale Variablen relativ zum
      aktuellen Stackframe zu adressieren. <a class="xref" href="#COD">1</a>
      Die Rücksprungadresse

      <a id="idp65820880" class="indexterm"></a>
      <a id="idp65821392" class="indexterm"></a>
      <a id="idp65822544" class="indexterm"></a>
      <a id="idp65823056" class="indexterm"></a>

      der Funktionen werden ebenfalls auf dem Stack
      gespeichert und das ist der Grund für
      Stack-Überlauf-Exploits. Denn ein böswilliger Nutzer
      kann die Rücksprungadresse der Funktion überschreiben
      indem er eine lokale Variable in der Funktion
      überlaufen lässt, wodurch es ihm möglich ist
      beliebigen Code auszuführen.</p><p>Obwohl Stack-basierte Angriffe bei weitem die
      Häufigsten sind, ist es auch möglich den Stack mit
      einem Heap-basierten (malloc/free) Angriff zu
      überschreiben.</p><p>Die C-Programmiersprache führt keine automatischen
      Bereichsüberprüfungen bei Feldern oder Zeigern durch, wie
      viele andere Sprachen das tun. Außerdem enthält
      die C-Standardbibliothek eine Handvoll sehr
      gefährlicher Funktionen.</p><div class="informaltable"><table width="100%" border="0"><colgroup><col /><col /></colgroup><tbody><tr><td><code class="function">strcpy</code>(char *dest, const
	      char *src)</td><td><p>Kann den Puffer dest überlaufen
	      lassen</p></td></tr><tr><td><code class="function">strcat</code>(char *dest, const
	      char *src)</td><td><p>Kann den Puffer dest überlaufen
	      lassen</p></td></tr><tr><td><code class="function">getwd</code>(char *buf)</td><td><p>Kann den Puffer buf überlaufen
	      lassen</p></td></tr><tr><td><code class="function">gets</code>(char *s)</td><td><p>Kann den Puffer s überlaufen
	      lassen</p></td></tr><tr><td><code class="function">[vf]scanf</code>(const char
	      *format, ...)</td><td><p>Kann sein Argument überlaufen
	      lassen</p></td></tr><tr><td><code class="function">realpath</code>(char *path,
	      char resolved_path[])</td><td><p>Kann den Puffer path überlaufen
	      lassen</p></td></tr><tr><td><code class="function">[v]sprintf</code>(char *str,
	      const char *format, ...)</td><td><p>Kann den Puffer str überlaufen
	      lassen</p></td></tr></tbody></table></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp65853392"></a>3.3.1. Puffer-Überlauf Beispiel</h3></div></div></div><p>Das folgende Quellcode-Beispiel enthält einen
	Puffer-Überlauf, der darauf ausgelegt ist die
	Rücksprungadresse zu überschreiben und die
	Anweisung direkt nach dem Funktionsaufruf zu
	überspringen. (Inspiriert durch
	<a class="xref" href="#Phrack">4</a>)</p><pre class="programlisting">#include &lt;stdio.h&gt;

void manipulate(char *buffer) {
char newbuffer[80];
strcpy(newbuffer,buffer);
}

int main() {
char ch,buffer[4096];
int i=0;

while ((buffer[i++] = getchar()) != '\n') {};

i=1;
manipulate(buffer);
i=2;
printf("The value of i is : %d\n",i);
return 0;
}</pre><p>Betrachten wir nun, wie das Speicherabbild dieses
	Prozesses aussehen würde, wenn wir 160 Leerzeichen
	in unser kleines Programm eingeben, bevor wir Enter
	drücken.</p><p>[XXX figure here!]</p><p>Offensichtlich kann man durch böswilligere Eingaben
	bereits kompilierten Programmtext ausführen (wie z.B.
	exec(/bin/sh)).</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp65856464"></a>3.3.2. Puffer-Überläufe vermeiden</h3></div></div></div><p>Die direkteste Lösung, um
	Stack-Überläufe zu vermeiden, ist immer
	grössenbegrenzten Speicher und String-Copy-Funktionen
	zu verwenden.
	<code class="function">strncpy</code> und <code class="function">strncat</code>
	sind Teil der C-Standardbibliothek.

	<a id="idp65858128" class="indexterm"></a>
	<a id="idp65859280" class="indexterm"></a>

	Diese Funktionen akzeptieren einen Längen-Parameter. Dieser
	Wert sollte nicht größer sein als die Länge
	des Zielpuffers. Die Funktionen kopieren dann bis zu
	`length' Bytes von der Quelle zum Ziel. Allerdings gibt es
	einige Probleme. Keine der Funktionen garantiert, dass
	die Zeichenkette NUL-terminiert ist, wenn die
	Größe

	<a id="idp65860560" class="indexterm"></a>

	des Eingabepuffers so groß ist wie das Ziel.
	Außerdem wird der Parameter length zwischen strncpy
	und strncat inkonsistent definiert, weshalb Programmierer
	leicht bezüglich der korrekten Verwendung durcheinander
	kommen können. Weiterhin gibt es einen spürbaren
	Leistungsverlust im Vergleich zu
	<code class="function">strcpy</code>, wenn eine kurze Zeichenkette in
	einen großen Puffer kopiert wird. Denn
	<code class="function">strncpy</code> fült den Puffer bis zur
	angegebenen Länge mit NUL auf.
      </p><p>In OpenBSD wurde eine weitere Möglichkeit zum

	<a id="idp65862224" class="indexterm"></a>

	kopieren von Speicherbereichen implementiert, die dieses
	Problem umgeht. Die Funktionen <code class="function">strlcpy</code>
	und <code class="function">strlcat</code> garantieren, dass das Ziel
	immer NUL-terminiert wird, wenn das Argument length ungleich
	null ist. Für weitere Informationen über diese
	Funktionen lesen Sie bitte <a class="xref" href="#OpenBSD">6</a>. Die
	OpenBSD-Funktionen <code class="function">strlcpy</code> und
	<code class="function">strlcat</code> sind seit Version 3.3 auch in
	FreeBSD verfügbar.</p><a id="idp65864784" class="indexterm"></a><a id="idp65865936" class="indexterm"></a><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp65867088"></a>3.3.2.1. Compiler-basierte Laufzeitüberprüfung
	  von Grenzen</h4></div></div></div><a id="idp65867728" class="indexterm"></a><p>Unglücklicherweise gibt es immer noch sehr viel
	  Quelltext, der allgemein verwendet wird und blind Speicher
	  umherkopiert, ohne eine der gerade besprochenen Funktionen,
	  die Begrenzungen unterstützen, zu verwenden.
	  Glücklicherweise gibt es einen Weg, um solche Angriffe zu
	  verhindern -  Überprüfung der Grenzen zur Laufzeit, die in
	  verschiedenen C/C++ Compilern eingebaut ist.</p><a id="idp65881680" class="indexterm"></a><a id="idp65882192" class="indexterm"></a><a id="idp65882704" class="indexterm"></a><p>ProPolice ist eine solche Compiler-Eigenschaft und ist in den
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gcc&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">gcc</span>(1)</span></a> Versionen 4.1 und höher integriert.  Es ersetzt und
	  erweitert die <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gcc&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">gcc</span>(1)</span></a> StackGuard-Erweiterung von
	  früher.</p><p>ProPolice schützt gegen stackbasierte
	  Pufferüberläufe und andere Angriffe durch das Ablegen von
	  Pseudo-Zufallszahlen in Schlüsselbereichen des Stacks bevor es
	  irgendwelche Funktionen aufruft.  Wenn eine Funktion beendet wird,
	  werden diese <span class="quote">&#8222;<span class="quote">Kanarienvögel</span>&#8220;</span> überprüft
	  und wenn festgestellt wird, dass diese verändert wurden wird das
	  Programm sofort abgebrochen.  Dadurch wird jeglicher Versuch, die
	  Rücksprungadresse oder andere Variablen, die auf dem Stack
	  gespeichert werden, durch die Ausführung von Schadcode zu
	  manipulieren, nicht funktionieren, da der Angreifer auch die
	  Pseudo-Zufallszahlen unberührt lassen müsste.</p><a id="idp65885904" class="indexterm"></a><p>Ihre Anwendungen mit ProPolice neu zu kompilieren ist
	  eine effektive Maßnahme, um sie vor den meisten
	  Puffer-Überlauf-Angriffen zu schützen, aber die
	  Programme können noch immer kompromittiert werden.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp65886928"></a>3.3.2.2. Bibliotheks-basierte Laufzeitüberprüfung
	  von Grenzen</h4></div></div></div><a id="idp65887696" class="indexterm"></a><p>Compiler-basierte Mechanismen sind bei Software,
	  die nur im Binärformat vertrieben wird, und die somit
	  nicht neu kompiliert werden kann völlig nutzlos.
	  Für diesen Fall gibt es einige Bibliotheken, welche
	  die unsicheren Funktionen der C-Bibliothek
	  (<code class="function">strcpy</code>, <code class="function">fscanf</code>,
	  <code class="function">getwd</code>, etc..) neu implementieren und
	  sicherstellen, dass nicht hinter den Stack-Pointer
	  geschrieben werden kann.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">libsafe</li><li class="listitem">libverify</li><li class="listitem">libparanoia</li></ul></div><p>Leider haben diese Bibliotheks-basierten
	  Verteidigungen mehrere Schwächen. Diese Bibliotheken
	  schützen nur vor einer kleinen Gruppe von
	  Sicherheitslücken und sie können das
	  eigentliche Problem nicht lösen. Diese
	  Maßnahmen können versagen, wenn die Anwendung
	  mit -fomit-frame-pointer kompiliert wurde.
	  Außerdem kann der Nutzer die Umgebungsvariablen
	  LD_PRELOAD und LD_LIBRARY_PATH überschreiben oder
	  löschen.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-setuid"></a>3.4. SetUID-Themen</h2></div></div></div><a id="idp65922768" class="indexterm"></a><p>Es gibt zu jedem Prozess mindestens sechs verschiedene
      IDs, die diesem zugeordnet sind. Deshalb müssen Sie
      sehr vorsichtig mit den Zugriffsrechten sein, die Ihr Prozess
      zu jedem Zeitpunkt besitzt. Konkret bedeutet dass, das alle
      seteuid-Anwendungen ihre Privilegien abgeben sollten, sobald
      sie diese nicht mehr benötigen.</p><a id="idp65923664" class="indexterm"></a><a id="idp65924816" class="indexterm"></a><p>Die reale Benutzer-ID kann nur von einem
      Superuser-Prozess geändert werden. Das Programm
      <span class="application">login</span> setzt sie, wenn sich ein
      Benutzer am System anmeldet, und sie wird nur selten
      geändert.</p><p>Die effektive Benutzer-ID wird von der Funktion
      <code class="function">exec()</code> gesetzt, wenn ein Programm
      das seteuid-Bit gesetzt hat. Eine Anwendung kann
      <code class="function">seteuid()</code> jederzeit aufrufen, um die
      effektive Benutzer-ID entweder auf die reale Benutzer-ID oder
      die gespeicherte set-user-ID zu setzen. Wenn eine der
      <code class="function">exec()</code>-Funktionen die effektive
      Benutzer-ID setzt, wird der vorherige Wert als
      gespeicherte set-user-ID abgelegt.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-chroot"></a>3.5. Die Umgebung ihrer Programme einschränken</h2></div></div></div><a id="idp65929424" class="indexterm"></a><p>Die herkömmliche Methode, um einen Prozess
      einzuschränken, besteht in dem Systemaufruf
      <code class="function">chroot()</code>. Dieser Aufruf
      ändert das Wurzelverzeichnis, auf das sich alle
      Pfadangaben des Prozesses und jegliche Kind-Prozesse beziehen.
      Damit dieser Systemaufruf gelingt, muss der Prozess
      Ausführungsrechte (Durchsuchungsrechte) für das
      Verzeichnis haben, auf das er sich bezieht. Die neue Umgebung
      wird erst wirksam, wenn Sie mittels
      <code class="function">chdir()</code> in Ihre neue Umgebung wechseln.
      Es sollte erwähnt werden, dass ein Prozess recht einfach
      aus der chroot-Umgebung ausbrechen kann, wenn er root-Rechte
      besitzt. Das kann man erreichen, indem man Gerätedateien
      anlegt, um Kernel-Speicher zu lesen, oder indem man einen
      Debugger mit einem Prozess außerhalb seiner
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=chroot&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">chroot</span>(8)</span></a>-Umgebung verbindet, oder auf viele andere
      kreative Wege.</p><p>Das Verhalten des Systemaufrufs
      <code class="function">chroot()</code> kann durch die
      kern.chroot.allow_open_directories
      <code class="command">sysctl</code>-Variable beeinflusst werden. Wenn
      diese auf 0 gesetzt ist, wird <code class="function">chroot()</code>
      mit EPERM fehlschlagen, wenn irgendwelche Verzeichnisse
      geöffnet sind. Wenn die Variable auf den Standardwert 1
      gesetzt ist, wird <code class="function">chroot()</code> mit EPERM
      fehlschlagen, wenn irgendwelche Verzeichnisse geöffnet
      sind und sich der Prozess bereits in einer
      <code class="function">chroot()</code>-Umgebung befindet. Bei jedem
      anderen Wert wird die Überprüfung auf
      geöffnete Verzeichnisse komplett umgangen.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp65934288"></a>3.5.1. Die Jail-Funktionalität in FreeBSD</h3></div></div></div><a id="idp65934928" class="indexterm"></a><p>Das Konzept einer Jail (Gefängnis) erweitert
	<code class="function">chroot()</code>, indem es die Macht des
	Superusers einschränkt, um einen echten 'virtuellen
	Server' zu erzeugen. Wenn ein solches Gefängnis einmal
	eingerichtet ist, muss die gesamte Netzwerkkommunikation
	über eine bestimmte IP-Adresse erfolgen und die
	"root-Privilegien" innerhalb der Jail sind sehr stark
	eingeschränkt.</p><p>Solange Sie sich in einer Jail befinden, werden alle
	Tests auf Superuser-Rechte durch den Aufruf von
	<code class="function">suser()</code> fehlschlagen. Allerdings wurden
	einige Aufrufe von <code class="function">suser()</code>
	abgeändert, um die neue
	<code class="function">suser_xxx()</code>-Schnittstelle zu
	implementieren. Diese Funktion ist dafür verantwortlich,
	festzustellen, ob bestimmte Superuser-Rechte einem
	eingesperrten Prozess zur Verfügung stehen.</p><p>Ein Superuser-Prozess innerhalb einer Jail darf
	folgendes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Berechtigungen verändern mittels:
	    <code class="function">setuid</code>,
	    <code class="function">seteuid</code>,
	    <code class="function">setgid</code>,
	    <code class="function">setegid</code>,
	    <code class="function">setgroups</code>,
	    <code class="function">setreuid</code>,
	    <code class="function">setregid</code>,
	    <code class="function">setlogin</code></li><li class="listitem">Ressourcenbegrenzungen setzen mittels
	    <code class="function">setrlimit</code></li><li class="listitem">Einige sysctl-Variablen (kern.hostname)
	    verändern</li><li class="listitem"><code class="function">chroot()</code></li><li class="listitem">Ein Flag einer vnode setzen:
	    <code class="function">chflags</code>,
	    <code class="function">fchflags</code></li><li class="listitem">Attribute einer vnode setzen wie Dateiberechtigungen,
	    Eigentümer, Gruppe, Größe, Zugriffszeit
	    und Modifikationszeit</li><li class="listitem">Binden eines Prozesses an einen öffentlichen
	    privilegierten Port (ports &lt; 1024)</li></ul></div><p><code class="function">Jail</code>s sind ein mächtiges
	Werkzeug, um Anwendungen in einer sicheren Umgebung
	auszuführen, aber sie haben auch ihre Nachteile.
	Derzeit wurden die IPC-Mechanismen noch nicht an
	<code class="function">suser_xxx</code> angepasst, so dass Anwendungen
	wie MySQL nicht innerhalb einer Jail ausgeführt werden
	können. Der Superuser-Zugriff hat in einer Jail nur eine
	sehr eingeschränkte Bedeutung, aber es gibt keine
	Möglichkeit zu definieren was
	"sehr eingeschränkt" heißt.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp65953232"></a>3.5.2. <span class="trademark">POSIX</span>®.1e Prozess Capabilities</h3></div></div></div><a id="idp65958480" class="indexterm"></a><a id="idp65958992" class="indexterm"></a><p><span class="trademark">POSIX</span>® hat einen funktionalen Entwurf (Working Draft)
	herausgegeben, der Ereignisüberprüfung,
	Zugriffskontrolllisten, feiner einstellbare Privilegien,
	Informationsmarkierung und verbindliche Zugriffskontrolle
	enthält.</p><p>Dies ist im Moment in Arbeit und das Hauptziel des <a class="link" href="http://www.trustedbsd.org/" target="_top">TrustedBSD</a>-Projekts.
	Ein Teil der bisherigen Arbeit wurde in FreeBSD-CURRENT
	übernommen (cap_set_proc(3)).</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-trust"></a>3.6. Vertrauen</h2></div></div></div><p>Eine Anwendung sollte niemals davon ausgehen, dass
      irgendetwas in der Nutzerumgebung vernünftig ist.
      Das beinhaltet (ist aber sicher nicht darauf
      beschränkt): Nutzereingaben, Signale,
      Umgebungsvariablen, Ressourcen, IPC, mmaps, das
      Arbeitsverzeichnis im Dateisystem, Dateideskriptoren,
      die Anzahl geöffneter Dateien, etc..</p><a id="idp65962576" class="indexterm"></a><a id="idp65963088" class="indexterm"></a><p>Sie sollten niemals annehmen, dass Sie jede Art von
      inkorrekten Eingaben abfangen können, die ein Nutzer
      machen kann. Stattdessen sollte Ihre Anwendung positive
      Filterung verwenden, um nur eine bestimmte Teilmenge an
      Eingaben zuzulassen, die Sie für sicher halten.
      Ungeeignete Datenüberprüfung ist die Ursache
      vieler Exploits, besonders für CGI-Skripte im Internet.
      Bei Dateinamen müssen Sie besonders vorsichtig sein,
      wenn es sich um Pfade ("../", "/"), symbolische
      Verknüpfungen und Shell-Escape-Sequenzen handelt.</p><a id="idp65963984" class="indexterm"></a><p>Perl bietet eine wirklich coole Funktion, den sogenannten
      "Taint"-Modus, der verwendet werden kann, um zu verhindern,
      dass Skripte Daten, die von außerhalb des Programmes
      stammen, auf unsichere Art und Weise verwenden. Dieser
      Modus überprüft Kommandozeilenargumente,
      Umgebungsvariablen, Lokalisierungsinformationen, die
      Ergebnisse von Systemaufrufen
      (<code class="function">readdir()</code>,
      <code class="function">readlink()</code>,
      <code class="function">getpwxxx()</code>)
      und alle Dateieingaben.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-race-conditions"></a>3.7. Race-Conditions</h2></div></div></div><p>Eine Race-Condition ist ein unnormales Verhalten, das von
      einer unerwarteten Abhängigkeit beim Timing von Ereignissen
      verursacht wird. Mit anderen Worten heißt das, ein
      Programmierer nimmt irrtümlicher Weise an, dass ein
      bestimmtes Ereignis immer vor einem anderen stattfindet.</p><a id="idp65967440" class="indexterm"></a><a id="idp65968336" class="indexterm"></a><a id="idp65969232" class="indexterm"></a><p>Einige der häufigsten Ursachen für
      Race-Conditions sind Signale, Zugriffsprüfungen und das
      Öffnen von Dateien. Signale sind von Natur aus
      asynchrone Ereignisse, deshalb ist besondere Vorsicht im
      Umgang damit geboten. Das Prüfen des Zugriffs mittels
      der Aufrufe <code class="function">access(2)</code> gefolgt von
      <code class="function">open(2)</code> ist offensichtlich nicht atomar.
      Benutzer können zwischen den beiden Aufrufen Dateien
      verschieben. Stattdessen sollten privilegierte Anwendungen
      <code class="function">seteuid()</code> direkt gefolgt von
      <code class="function">open()</code> aufrufen. Auf die gleiche Art
      sollte eine Anwendung immer eine korrekte Umask vor dem
      Aufruf von <code class="function">open()</code> setzen, um
      störende Aufrufe von <code class="function">chmod()</code> zu
      umgehen.</p></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="l10n"></a>Kapitel 4. Lokalisierung und Internationalisierung - L10N und
    I18N</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jochen</span> <span class="surname">Neumeister</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#l10n-programming">4.1. I18N-konforme Anwendungen programmieren</a></span></dt><dt><span class="sect1"><a href="#posix-nls">4.2. Lokalisierte Nachrichten mit POSIX.1 Native Language
      Support (NLS)</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="l10n-programming"></a>4.1. I18N-konforme Anwendungen programmieren</h2></div></div></div><a id="idp66013776" class="indexterm"></a><a id="idp66014288" class="indexterm"></a><p>Um Ihre Anwendung verwendbarer für andere
      Sprachen zu machen, hoffen wir, dass Sie I18N-konform
      programmieren. Der GNU gcc-Compiler und Bibliotheken
      für grafische Benutzeroberflächen wie QT und GTK
      unterstützen I18N durch eine spezielle Verarbeitung von
      Zeichenketten. Das Erstellen eines I18N-konformen Programms
      ist sehr einfach und erlaubt anderen Mitwirkenden, Ihre
      Programme leichter in andere Sprachen zu übersetzen.
      Lesen Sie die Bibliothek-spezifischen I18N-Dokumentationen
      für weitere Details.</p><p>Im Gegensatz zur allgemeinen Meinung ist I18N-konformer
      Code einfach zu programmieren. Üblicherweise umfasst
      dies nur das Einbetten Ihrer Zeichenketten in
      Bibliothek-spezifische Funktionen. Stellen Sie außerdem
      bitte sicher, dass Sie Unterstützung für Unicode- und
      Multibyte-Zeichen vorsehen.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66015568"></a>4.1.1. Ein Aufruf, die I18N-Bemühungen zu
	vereinheitlichen</h3></div></div></div><p>Wir sind darauf aufmerksam geworden, dass die
	einzelnen I18N-/L10N-Bemühungen für jedes Land
	wiederholt wurden. Viele von uns haben somit unproduktiverweise
	das Rad immer wieder neu erfunden. Wir hoffen, dass die
	verschiedenen großen Gruppen für I18N Ihre
	Bemühungen in einer Gruppe vereinen können,
	ähnlich der Zuständigkeit des Core-Teams.</p><p>Derzeit hoffen wir, dass wenn Sie I18N-konforme
	Programme schreiben oder portieren, diese an die
	betreffenden FreeBSD-Mailinglisten jedes Landes schicken, um
	sie testen zu lassen. Wir hoffen in Zukunft, Anwendungen zu
	entwickeln, die in allen Sprachen direkt und ohne unsaubere
	Änderungen funktionieren.</p><p>Die <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-i18n" target="_top">FreeBSD
  internationalization</a>-Mailingliste ist eingerichtet worden. Wenn
	Sie I18N-/L10N-Entwickler sind, schicken Sie bitte Ihre
	Kommentare, Ideen, Fragen und alles, das Sie mit dem Thema in
	Verbindung bringen, dorthin.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66018000"></a>4.1.2. Perl und Python</h3></div></div></div><a id="idp66018640" class="indexterm"></a><a id="idp66019408" class="indexterm"></a><p>Perl und Python bieten Bibliotheken für I18N und zur
	Behandlung von Unicode-Zeichen. Bitte nutzen Sie diese
	für I18N-Konformität.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="posix-nls"></a>4.2. Lokalisierte Nachrichten mit POSIX.1 Native Language
      Support (NLS)</h2></div><div><span class="authorgroup">Beigetragen von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Gábor</span> <span class="surname">Kövesdán</span></span>. </span></div></div></div><p>Über die Basisfunktionen von I18N hinaus, wie das Bereitstellen
      von verschiedenen Eingabecodierungen oder die diversen nationalen
      Konventionen, zum Beispiel die verschiedenen Dezimalpunkte, ist es
      auf einem höheren Level von I18N möglich, die Ausgabe
      von Programmen zu lokalisieren.  Ein Weg dies zu tun besteht in der
      Nutzung der POSIX.1 NLS-Funktionen von FreeBSD.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nls-catalogs"></a>4.2.1. Organisation von lokalisierten Mitteilungen in Katalog
          Dateien</h3></div></div></div><p>POSIX.1 NLS basiert auf Katalogdateien, welche die lokalisierten
      Mitteilungen in der entsprechenden Codierung enthalten.  Die
      Mitteilungen sind in Sets organisiert und jede Mitteilung ist
      durch eine eindeutige Zahl in dem jeweiligen Set identifiziert.
      Die Katalogdateien werden nach der Lokale, von den jeweiligen
      lokalisierten Mitteilungen, die sie enthalten, gefolgt von der
      <code class="literal">.msg</code> Endung benannt. Zum Beispiel werden die
      ungarischen Mitteilungen für das ISO8859-2  Encoding in
      einer Datei mit dem Dateinamen <code class="filename">hu_HU.ISO8859-2</code>
      gespeichert.</p><p>Diese Katalogdateien sind normale Textdateien, welche die
      nummerierten Mitteilungen enthalten.  Es ist möglich
      Kommentare in die Dateien zu schreiben, indem Sie ein
      <code class="literal">$</code>-Zeichen an den Anfang der Zeile setzen.
      Das Setzen von Grenzen wird ebenfalls durch spezielle Kommentare
      möglich wobei das Schlüsselwort <code class="literal">set</code>
      direkt nach dem <code class="literal">$</code>-Zeichen folgen muss.  Dem
      Schlüsselwort <code class="literal">set</code> folgt dann die Set-Nummer.
      Ein Beispiel:</p><pre class="programlisting">$set 1</pre><p>Der aktuelle Mitteilungseintrag startet mit der
      Mitteilungsnummer gefolgt von der lokalisierten Nachricht.  Die
      bekannten Modifikatoren von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=printf&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">printf</span>(3)</span></a> werden akzeptiert:</p><pre class="programlisting">15 "File not found: %s\n"</pre><p>Die Katalogdateien müssen in binärer Form vorliegen,
      bevor sie von einem Programm benutzt werden können.  Dies wird
      mit dem <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gencat&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">gencat</span>(1)</span></a> Tool durchgeführt.  Das erste Argument
      ist der Dateiname des kompilierten Katalogs und die weiteren
      Argumente sind die Eingabekataloge.  Die lokalisierten
      Mitteilungen können auf mehrere Katalogdateien aufgeteilt
      sein.  Danach werden dann alle auf einmal mit dem <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gencat&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">gencat</span>(1)</span></a>
      Tool kompiliert.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nls-using"></a>4.2.2. Nutzung der Katalogdateien im Quellcode</h3></div></div></div><p>Das Benutzen der Katalogdateien ist einfach.  Um die
        relevante Funktion zu nutzen, muss <code class="filename">nl_types.h</code> in die Quelldatei
        eingefügt werden.  Bevor ein Katalog benutzt werden
        kann, muss er mit <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a> geöffnet werden.
        Die Funktion hat 2 Argumente.  Der erste Parameter ist der
        Name des installierten und kompilierten Katalogs.  Normalerweise
        wird der Name des Programmes, zum Beispiel
        <span class="application">grep</span>, genutzt.  Dieser Name wird
        zum Suchen der kompilierten Katalogdatei benutzt.  Der Aufruf
        von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a> sucht nach dieser Datei in <code class="filename">/usr/share/nls/locale/catname</code>
        und in <code class="filename">/usr/local/share/nls/locale/catname</code>,
        wobei <code class="literal">locale</code> die gesetzte Lokale und
        <code class="literal">catname</code> der Katalogname ist.  Der zweite
        Parameter ist eine Konstante, die zwei Werte haben kann:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">NL_CAT_LOCALE</code>, hat die Bedeutung,
            dass die benutzte Katalogdatei auf
            <code class="envar">LC_MESSAGES</code> basiert.</p></li><li class="listitem"><p><code class="literal">0</code>, hat die Bedeutung, dass
            <code class="envar">LANG</code> benutzt wird, um die Katalogdatei
            zu öffnen.
          </p></li></ul></div><p>Der <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a> Aufruf gibt einen Katalogidentifizierer
        vom Type <code class="literal">nl_catd</code> zurück.  Sehen Sie in der
        Manualpage nach, um eine Liste mit möglichen Fehlercodes
        zu erhalten.</p><p>Nach dem Öffnen eines Katalogs, kann <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=catgets&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">catgets</span>(3)</span></a>
        benutzt werden, um Mitteilungen zu erhalten.  Der erste
        Parameter ist der Katalogidentifizierer, der von
        <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a> zurück gegeben wurde, das zweite ist die
        Nummer des Sets, das dritte die Nummer der Mitteilung und das
        vierte ist eine Fallbackmitteilung, die angezeigt wird,
        falls die gewünschte Mitteilung in der Katalogdatei
        nicht verfügbar ist.</p><p>Nach der Nutzung der Katalogdatei, muss sie mit dem
        Kommando <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=catclose&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">catclose</span>(3)</span></a>, geschlossen werden.  Es besitzt
        ein Argument, die Katalog ID.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nls-example"></a>4.2.3. Ein Beispiel aus der Praxis</h3></div></div></div><p>Das folgende Beispiel zeigt einen einfachen Weg wie man
          NLS-Kataloge flexibel nutzen kann.</p><p>Die nachfolgenden Zeilen müssen in eine allgemeine
          Headerdatei, die in allen Quelldateien vorhanden ist, die
          lokalisierte Mitteilungen benutzen, eingefügt werden:</p><pre class="programlisting">
#ifdef WITHOUT_NLS
#define getstr(n)         nlsstr[n]
#else
#include &lt;nl_types.h&gt;

extern nl_catd            catalog;
#define getstr(n)         catgets(catalog, 1, n, nlsstr[n])
#endif

extern char              *nlsstr[];
        </pre><p>Als nächstes fügen Sie die folgenden Zeilen
	  in den globalen Deklarationsteil der Hauptquelldatei ein:</p><pre class="programlisting">
#ifndef WITHOUT_NLS
#include &lt;nl_types.h&gt;
nl_catd   catalog;
#endif

/*
* Default messages to use when NLS is disabled or no catalog
* is found.
*/
char    *nlsstr[] = {
        "",
/* 1*/  "some random message",
/* 2*/  "some other message"
};
	</pre><p>Als nächstes kommt der Code der den Katalog
	  öffnet, liest und schließt:</p><pre class="programlisting">
#ifndef WITHOUT_NLS
 catalog = catopen("myapp", NL_CAT_LOCALE);
#endif

...

printf(getstr(1));

...

#ifndef WITHOUT_NLS
 catclose(catalog);
#endif
	</pre><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66056656"></a>4.2.3.1. Reduzierung von zu lokalisierenden Zeichenketten</h4></div></div></div><p>Es gibt einen guten Weg, Zeichenketten die lokaliesert
	    werden müssen, durch den Einsatz von
	    <span class="application">libc</span>-Fehlermeldungen zu reduzieren.
	    Dadurch vermeidet man Duplikate und erstellt gleiche Meldungen
	    für häufige Fehlermeldungen, die bei vielen
	    Programmen auftreten können.</p><p>Als erstes ist hier ein Beispiel, dass keine
	    <span class="application">libc</span>-Fehlermeldungen benutzt:</p><pre class="programlisting">
#include &lt;err.h&gt;
...
if (!S_ISDIR(st.st_mode))
 err(1, "argument is not a directory");
	  </pre><p>Dies kann so abgeändert werden, dass eine
	    Fehlermeldung durch Auslesen der Variabel <code class="varname">errno</code>
	    ausgegeben wird.  Die Fehlermeldung wird entsprechend dem Beispiel
	    ausgegeben:</p><pre class="programlisting">
#include &lt;err.h&gt;
#include &lt;errno.h&gt;
...
if (!S_ISDIR(st.st_mode)) {
 errno = ENOTDIR;
 err(1, NULL);
}
	  </pre><p>In diesem Beispiel wurde die benutzerdefinierte
	    Zeichenkette entfernt. Übersetzer haben weniger Arbeit,
	    wenn sie ein Programm lokalisieren und die Benutzer sehen die
	    übliche <span class="quote">&#8222;<span class="quote">"Not a directory"</span>&#8220;</span>
	    Fehlermeldung, wenn dieser Fehler auftritt.  Diese Meldung wird
	    ihnen wahrscheinlich vertraut erscheinen.  Bitte beachten Sie,
	    dass es notwendig ist,
	    <code class="filename">errno.h</code>
	    hinzuzufügen um einen direkten Zugriff auf
	    <code class="varname">errno</code> zu haben.</p><p>Es lohnt sich darauf hinzuweisen, dass es Fälle gibt,
	    in denen <code class="varname">errno</code> automatisch aufgerufen wird,
	    so dass es nicht notwendig ist, es explizit zu tun:</p><pre class="programlisting">
#include &lt;err.h&gt;
...
if ((p = malloc(size)) == NULL)
 err(1, NULL);
	  </pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nls-mk"></a>4.2.4. Benutzung von <code class="filename">bsd.nls.mk</code></h3></div></div></div><p>Das Benutzen von Katalogdateien setzt einige sich
	  wiederholende Schritte, wie das kompilieren und installieren
	  der Kataloge, voraus.  Um diese Schritte zu vereinfachen,
	  stellt <code class="filename">bsd.nls.mk</code> einige Makros zur
	  Verfügung. Es ist nicht notwendig
	  <code class="filename">bsd.nls.mk</code> explizit hinein zu kopieren,
	  es wird automatisch aus den allgemeinen Makefiles wie
	  <code class="filename">bsd.prog.mk</code> oder
	  <code class="filename">bsd.lib.mk</code> gezogen.</p><p>Normalerweise reicht es, <code class="varname">NLSNAME</code> zu
	  definieren, die den Namen des Kataloges als erstes
	  Argument von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a> enthalten sollte und die
	  Katalogdateien in <code class="varname">NLS</code> ohne ihre Endung
	  <code class="literal">.msg</code> auflistet.  Hier ist ein Beispiel, das
	  es ermöglicht, NLS mit dem obigen Code zu deaktivieren.
	  Die <code class="varname">WITHOUT_NLS</code> Variable von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>
	  muss so definiert werden, dass das Programm ohne
	  NLS-Unterstützung gebaut wird.</p><pre class="programlisting">
.if !defined(WITHOUT_NLS)
NLS=     es_ES.ISO8859-1
NLS+=    hu_HU.ISO8859-2
NLS+=    pt_BR.ISO8859-1
.else
CFLAGS+= -DWITHOUT_NLS
.endif
	</pre><p>Normalerweise werden die Katalogdateien in dem
	  <code class="filename">nls</code>-Unterverzeichnis
	  abgelegt.  Dies ist der Standard von
	  <code class="filename">bsd.nls.mk</code>.  Es ist möglich, mit der
	  <code class="varname">NLSSRCDIR</code>-Variablen von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> diese zu
	  überschreiben.  Der Standardname der vorkompilierten
	  Katalogdateien folgt den Namenskonventionen, wie oben beschrieben.
	  Er kann durch die <code class="varname">NLSNAME</code>-Variablen
	  überschrieben werden.  Es gibt noch weitere Optionen, um
	  eine Feinabstimmung zur Verarbeitung der Katalogdateien
	  zu erreichen.  Da sie nicht notwendig sind, werden sie hier
	  nicht weiter beschrieben.  Weitere Informationen über
	  <code class="filename">bsd.nls.mk</code> finden Sie in der Datei selbst.
	  Der Text ist kurz und leicht zu verstehen.</p></div></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="policies"></a>Kapitel 5. Vorgaben und Richtlinien für das
    Quelltextverzeichnis</h2></div><div><span class="authorgroup">Beigesteuert von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Poul-Henning</span> <span class="surname">Kamp</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Giorgos</span> <span class="surname">Keramidas</span></span>. </span></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Axel</span> <span class="surname">Gruner</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#policies-style">5.1. Stil-Richtlinien</a></span></dt><dt><span class="sect1"><a href="#policies-maintainer">5.2. <code class="varname">MAINTAINER</code> eines Makefiles</a></span></dt><dt><span class="sect1"><a href="#policies-contributed">5.3. Beigesteuerte Software</a></span></dt><dt><span class="sect1"><a href="#policies-encumbered">5.4. Belastende Dateien</a></span></dt><dt><span class="sect1"><a href="#policies-shlib">5.5. Shared-Libraries</a></span></dt></dl></div><p>Dieses Kapitel dokumentiert verschiedene Vorgaben und
    Richtlinien für das FreeBSD-Quelltextverzeichnis.</p><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-style"></a>5.1. Stil-Richtlinien</h2></div></div></div><a id="idp66097104" class="indexterm"></a><p>Ein konsistenter Code-Stil ist extrem wichtig, besonders
      in einem so grossen Projekt wie FreeBSD.  Der Code sollte dem
      FreeBSD Code-Stil entsprechen, welcher in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=style&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">style</span>(9)</span></a> und
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=style.Makefile&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">style.Makefile</span>(5)</span></a> genauer beschrieben ist.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-maintainer"></a>5.2. <code class="varname">MAINTAINER</code> eines Makefiles</h2></div></div></div><a id="idp66100688" class="indexterm"></a><p>Wenn ein bestimmter Bereich der FreeBSD
      <code class="filename">src/</code>-Distribution von einer Person oder Gruppe
      gepflegt wird, kann dies durch einen Eintrag in die Datei
      <code class="filename">src/MAINTAINERS</code> der Öffentlichkeit
      mitgeteilt werden.  Maintainer eines Ports in der Ports-Sammlung
      können ihre Verantwortung über den Port durch einen Eintrag in
      die <code class="varname">MAINTAINER</code>-Zeile im <code class="filename">Makefile</code>
      des Ports der Welt mitteilen.</p><pre class="programlisting"><code class="varname">MAINTAINER</code>= <em class="replaceable"><code>email-addresses</code></em></pre><div xmlns="" class="tip"><h3 class="admontitle">Tipp: </h3><p xmlns="http://www.w3.org/1999/xhtml">Für andere Teile des Repositories oder andere Abschnitte, die
        noch keinen Maintainer aufweisen, oder falls Sie sich nicht sicher
        sind, wer der Maintainer ist, sehen Sie sich die Commit-Historie des
        betreffenden Ports an.  Es ist recht häufig der Fall, dass ein
        Maintainer nicht explizit aufgeführt ist, aber trotzdem diejenigen
        Personen, die den Port seit den letzten paar Jahren aktiv betreuen,
        daran interessiert sind, Änderungen zu begutachten.  Selbst wenn
        dies nicht explizit in der Dokumentation oder im Quellcode erwähnt
        ist, wird es trotzdem als höfliche Geste angesehen, wenn man
        nach einer Überprüfung der eigenen Änderungen
        fragt.</p></div><p>Die Rolle eines Maintainers ist die folgende:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Der Maintainer ist verantwortlich für diesen Code.  Er
          oder sie muss einerseits für die Behebung von Fehlern und das
          Beantworten von Problemberichten für diesen Code die
          Verantwortung tragen und andererseits, falls es sich um beigesteuerte
          Software handelt, neue Versionen verfolgen und bereitstellen.</p></li><li class="listitem"><p>Änderungen an Verzeichnissen, die ein Maintainer definiert
          hat, sollten an den Maintainer für eine Überprüfung
          gesendet werden, bevor diese committet werden. Nur wenn der
          Maintainer in einer inakzeptablen Zeitspanne auf mehrere E-Mails
          nicht antwortet, können die Änderungen, die mit dem Commit
          in Kraft treten, auch ohne Überprüfung durch den Maintainer
          vollzogen werden.  Dennoch wird empfohlen, dass die Änderungen,
          falls möglich, von jemand anderem überprüft
          werden.</p></li><li class="listitem"><p>Es ist natürlich nicht akzeptabel, einer Person oder Gruppe
          den Status eines Maintainers zu geben, so lange sie nicht zustimmt,
          diese Pflicht auf sich zu nehmen. Andererseits muss es kein einzelner
          Mensch sein. Eine Gruppe von Menschen ist genauso in Ordnung.</p></li></ul></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-contributed"></a>5.3. Beigesteuerte Software</h2></div><div><span class="authorgroup">Beigesteuert von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Poul-Henning</span> <span class="surname">Kamp</span></span>, <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">David</span> <span class="surname">O'Brien</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Gavin</span> <span class="surname">Atkinson</span></span>. </span></div></div></div><a id="idp66116816" class="indexterm"></a><p>Einige Teile der FreeBSD-Distribution enthalten Software,
      die aktiv außerhalb des FreeBSD-Projektes gepflegt wird.
      Aus historischen Gründen nennen wir dies
      <span class="emphasis"><em>contributed</em></span> Software. Beispiele dafür
      sind <span class="application">sendmail</span>,
      <span class="application">gcc</span> und
      <span class="application">patch</span>.</p><p>Über die Jahre wurden verschiedene Methoden genutzt,
      um solche Software zu verwalten, und jede hat Vor-
      wie auch Nachteile. So hat sich kein eindeutiger Gewinner
      herauskristallisiert.</p><p>Es wurde viel über diesen Umstand diskutiert und
      eine Methode als die <span class="quote">&#8222;<span class="quote">offizielle</span>&#8220;</span>
      vorgestellt, um in Zukunft diese Art der Software zu
      importieren. Ferner wird dringend geraten, dass sich
      existierende, beigesteuerte Software diesem Modell
      annähert, da es signifikante Vorteile gegenüber der
      alten Methode gibt. Dazu gehört auch, dass jeder
      einfach Diffs bezüglich der
      <span class="quote">&#8222;<span class="quote">offiziellen</span>&#8220;</span> Quelltext-Versionen erzeugen kann
      (auch ohne direkten Repository-Zugang). Dies wird es deutlich
      vereinfachen, Änderungen an die Hauptentwickler
      zurückfließen zu lassen.</p><p>Letztendlich kommt es jedoch auf die Menschen an, welche die
      Arbeit leisten. Wenn die Durchführung dieses Modells bei
      einem Paket mal nicht möglich ist, können Ausnahmen
      dieser Regeln nur mit Genehmigung des Core-Teams und der
      Übereinstimmung der anderen Entwickler gewährt werden.
      Die Fähigkeit, dieses Paket auch in Zukunft pflegen zu
      können, ist eine der Schlüsselfragen bei dieser
      Entscheidung.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Durch einige bedauernswerte Einschränkungen des <acronym class="acronym">RCS</acronym>-Dateiformats und die
        Handhabung von Herstellerzweigen ist von unwesentlichen, trivialen
        und/oder kosmetischen Änderungen an Dateien <span class="emphasis"><em>dringend
	abzuraten</em></span>, die dem Herstellerzweig folgen.
	<span class="quote">&#8222;<span class="quote">Grammatikalische oder sprachliche
	Fehlerbehebungen</span>&#8220;</span> sind explizit unter der
	<span class="quote">&#8222;<span class="quote">Kosmetik</span>&#8220;</span>-Kategorie einzuordnen und sollten vermieden
	werden.  Das Repository kann sich durch Änderungen einzelner
	Zeichen dramatisch aufblähen.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="vendor-imports-cvs"></a>5.3.1. Herstellerimports mit CVS</h3></div></div></div><p>Das <span class="application">file</span>-Werkzeug soll als Beispiel
       dienen, wie dieses Modell funktioniert:</p><p><code class="filename">src/contrib/file</code> enthält den
      Quelltext so, wie vom Maintainer dieses Pakets bereitgestellt.
      Teile, die unter FreeBSD gänzlich unnutzbar sind, können entfernt
      werden. Im Fall von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=file&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">file</span>(1)</span></a> wurde u.a. das Unterverzeichnis
      <code class="filename">python</code> und Dateien mit dem Präfix
      <code class="filename">lt</code> vor dem Import entfernt.</p><p><code class="filename">src/lib/libmagic</code> enthält ein
      <code class="filename">Makefile</code> im <span class="application">bmake</span>-Stil,
      das die Regeln des Standard-Makefiles <code class="filename">bsd.lib.mk</code>
      nutzt, um die Bibliothek zu erstellen und die Dokumentation zu
      installieren.</p><p><code class="filename">src/usr.bin/file</code> enthält ein
      <code class="filename">Makefile</code> im <span class="application">bmake</span>-Stil,
      welches das <code class="command">file</code>-Programm erstellt und installiert,
      ebenso die dazugehörigen Manualpages, welche die Regeln von
      <code class="filename">bsd.prog.mk</code> nutzen.</p><p>Das Entscheidende ist hier das
      <code class="filename">src/contrib/file</code>-Verzeichnis, welches nach
      den folgenden Regeln erstellt wird: Es muss den
      Quelltext aus dem Original enthalten (ohne
      <acronym class="acronym">RCS</acronym>-Schlüsselworte und im korrekten
      Herstellerzweig) mit so wenig FreeBSD-spezifischen Änderungen wie
      möglich. Sollte es Zweifel geben, wie hier zu verfahren
      ist, unbedingt zuerst nachfragen und nicht auf gut Glück etwas
      probieren in der vagen Hoffnung, dass es
      <span class="quote">&#8222;<span class="quote">irgendwie funktioniert</span>&#8220;</span>.</p><p>Aufgrund der eingangs schon erwähnten Einschränkungen
      bei Herstellerzweigen ist es erforderlich, dass <span class="quote">&#8222;<span class="quote">offizielle</span>&#8220;</span>
      Fehlerbehebungen vom Hersteller in die Originalquellen der Distribution
      einfließen und als Resultat wieder in den Herstellerzweig
      importiert werden.  Offizielle Fehlerbehebungen sollten nie direkt in
      FreeBSD eingepflegt und <span class="quote">&#8222;<span class="quote">committet</span>&#8220;</span> werden, da dies
      den Herstellerzweig zerstören würde und der Import
      von zukünftigen Versionen wäre um ein Vielfaches
      schwerer, da es zu Konflikten kommen würde.</p><p>Da einige Pakete Dateien enthalten, die zur
      Kompatibilität mit anderen Architekturen und Umgebungen
      als FreeBSD gedacht sind, ist es zulässig, diese Teile zu
      löschen, wenn sie für FreeBSD nicht von Interesse
      sind, und so Speicherplatz zu sparen. Dateien, die ein
      Copyright und Release-artige Informationen zu den vorhandenen
      Dateien enthalten, sollten <span class="emphasis"><em>nicht</em></span>
      gelöscht werden.</p><p>Falls es einfacher erscheint, können die
      <code class="command">bmake</code>-<code class="filename">Makefile</code>s vom
      Verzeichnisbaum durch einige Dienstprogramme automatisch
      erstellt werden, was es hoffentlich sogar noch einfacher macht,
      eine Version zu aktualisieren. Ist dies geschehen, so stellen
      Sie bitte sicher, diese Werkzeuge in das Verzeichnis
      <code class="filename">src/tools</code> gleich mit dem Port an sich
      einzuchecken, sodass es für zukünftige Maintainer
      verfügbar ist.</p><p>Im Verzeichnis <code class="filename">src/contrib/file</code> sollte
      eine Datei mit dem Namen <code class="filename">FREEBSD-upgrade</code>
      hinzugefügt werden und sie sollte den Stand wie folgt
      anzeigen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Welche Dateien ausgelassen wurden.</p></li><li class="listitem"><p>Von wo die Original-Distribution stammt und/oder wo die
	  offizielle Hauptseite zu finden ist.</p></li><li class="listitem"><p>Wohin Fehlerbehebungen an den Originalautor gesendet
	  werden können.</p></li><li class="listitem"><p>Möglicherweise eine Übersicht, welche
	  FreeBSD-spezifischen Änderungen vorgenommen
	  wurden.</p></li></ul></div><p>Ein Beispielinhalt von
      <code class="filename">src/contrib/groff/FREEBSD-upgrade</code> ist hier
      aufgelistet:</p><pre class="programlisting">$FreeBSD: src/contrib/groff/FREEBSD-upgrade,v 1.5.12.1 2005/11/15 22:06:18 ru Exp $

This directory contains virgin sources of the original distribution files
on a "vendor" branch.  Do not, under any circumstances, attempt to upgrade
the files in this directory via patches and a cvs commit.

To upgrade to a newer version of groff, when it is available:
        1. Unpack the new version into an empty directory.
           [Do not make ANY changes to the files.]

        2. Use the command:
                cvs import -m 'Virgin import of FSF groff v&lt;version&gt;' \
                        src/contrib/groff FSF v&lt;version&gt;

           For example, to do the import of version 1.19.2, I typed:
                cvs import -m 'Virgin import of FSF groff v1.19.2' \
                        src/contrib/groff FSF v1_19_2

        3. Follow the instructions printed out in step 2 to resolve any
           conflicts between local FreeBSD changes and the newer version.

Do not, under any circumstances, deviate from this procedure.

To make local changes to groff, simply patch and commit to the main
branch (aka HEAD).  Never make local changes on the FSF branch.

All local changes should be submitted to Werner Lemberg &lt;wl@gnu.org&gt; or
Ted Harding &lt;ted.harding@nessie.mcc.ac.uk&gt; for inclusion in the next
vendor release.

ru@FreeBSD.org - 20 October 2005</pre><p>Eine weitere Möglichkeit ist es, eine Liste von Dateien, die
      nicht enthalten sein sollen zu pflegen, was besonders dann sehr hilfreich
      sein kann, wenn die Liste ziemlich gross oder kompliziert ist bzw.
      Imports sehr häufig stattfinden.  Durch erstellen einer Datei namens
      <code class="filename">FREEBSD-Xlist</code> im gleichen Verzeichnis, in welches
      das Herstellerverzeichnis importiert werden soll, die eine Liste von
      auszuschliessenden Dateinamen-Mustern pro Zeile enthält, können
      zukünftige Imports folgendermassen durchgeführt werden:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>tar -X FREEBSD-Xlist -xzf vendor-source.tgz</code></strong></pre><p>Als Beispiel einer <code class="filename">FREEBSD-Xlist</code>-Datei wird
      hier diejenige von <code class="filename">src/contrib/tcsh</code> gezeigt:</p><pre class="programlisting">*/BUGS
*/config/a*
*/config/bs2000
*/config/bsd
*/config/bsdreno
*/config/[c-z]*
*/tests
*/win32</pre><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Bitte importieren Sie weder <code class="filename">FREEBSD-upgrade</code>
        noch <code class="filename">FREEBSD-Xlist</code> mit den beigesteuerten
        Quellen.  Stattdessen sollten Sie diese Dateien nach dem initialen
        Import hinzufügen.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="vendor-import-svn"></a>5.3.2. Herstellerimports mit SVN</h3></div><div><span class="authorgroup">Beigetragen von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Dag-Erling</span> <span class="surname">Smørgrav</span></span>. </span></div></div></div><p>Dieser Abschnitt beschreibt die Prozedur für Herstellerimports
      mit <span class="application">Subversion</span> im Detail.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Vorbereiten des Quellbaums</strong></p><p>Wenn dies Ihr erster Import nach dem Wechsel zu
          <acronym class="acronym">SVN</acronym> ist, sollen Sie den Herstellerbaum
          aufräumen, verflachen und die Merge-Historie in den Hauptzweig
          vorbereiten.  Falls das nicht Ihr erster Import ist, können
          Sie diesen Schritt ohne Probleme überspringen.</p><p>Während der Konvertierung von <acronym class="acronym">CVS</acronym> zu
          <acronym class="acronym">SVN</acronym> wurden Herstellerzweige mit der gleichen
          Struktur wie der Hauptzweig importiert.  Beispielsweise wurden die
          <span class="application">foo</span> Herstellerquellen in
          <code class="filename">vendor/foo/dist/contrib/foo</code>
          abgelegt, jedoch ist dies unpraktisch und zwecklos.  Was wir wirklich
          wollen, ist dass die Herstellerquellen direkt in
          <code class="filename">vendor/foo/dist</code>
          liegen, beispielsweise so:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd vendor/foo/dist/contrib/foo</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn move $(svn list) ../..</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>cd ../..</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn remove contrib</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn propdel -R svn:mergeinfo</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn commit</code></strong></pre><p>Beachten Sie, dass das <code class="literal">propdel</code>-Bit notwendig
          ist, da mit Subversion 1.5 automatisch
          <code class="literal">svn:mergeinfo</code> zu jedem Verzeichnis
           hinzugefügt wird, das Sie kopieren oder verschieben.  In diesem
           Fall brauchen Sie diese Informationen nicht, da Sie nichts in den
           Zweig mergen werden, den Sie gelöscht haben.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Sie werden wahrscheinlich die Tags genauso verflachen wollen.
            Die Prozedur dafür ist die selbe.  Wenn Sie dies tun, sollten
            Sie den Commit bis zum Schluss aufschieben.</p></div><p>Prüfen Sie den <code class="filename">dist</code>-Baum und
          führen Sie alle nötigen Aufräumarbeiten durch, die Sie
          für sinnvoll erachten.  Sie werden möglicherweise die
          Erweiterung von Schlüsselwörtern deaktivieren wollen, da
          dies auf unmodifizierten Quellen keinen Sinn ergibt.  In machen
          Fällen kann dies sogar schädlich sein.</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>svn propdel svn:keywords -R .</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn commit</code></strong></pre><p>Bootstrappen der <code class="literal">svn:mergeinfo</code> auf dem
          Zielverzeichnis (des Hauptzweiges) auf die Revision die mit der
          letzten Änderung, die im Herstellerzweig vor dem Import der
          neuen Quellen durchgeführt wurde, korrespondiert, wird ebenso
          benötigt:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd head/contrib/foo</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn merge --record-only svn_base/vendor/foo/dist@12345678 .</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn commit</code></strong></pre><p>Dabei entspricht <em class="replaceable"><code>svn_base</code></em> dem
          Basisverzeichnis Ihres <acronym class="acronym">SVN</acronym>-Repositories, z.B.
          <code class="literal">svn+ssh://svn.FreeBSD.org/base</code>.</p></li><li class="step"><p class="title"><strong>Neue Quellen importieren</strong></p><p>Bereiten Sie einen kompletten, sauberen Baum mit
          Herstellerquellen vor.  Mit <acronym class="acronym">SVN</acronym> können wir
          eine komplette Distribution in dem Herstellerzweig aufbewahren, ohne
          den Hauptzweig aufzublähen.  Importieren Sie alles, aber mergen
          Sie nur das, was wirklich benötigt wird.</p><p>Beachten Sie, dass Sie alle Dateien, die seit dem letzten
          Herstellerimport hinzugefügt wurden, auch einbeziehen und
          diejenigen, welche entfernt wurden, auch löschen
          müssen.  Um dies zu bewerkstelligen, sollten Sie sortierte
          Listen der Bestandteile des Herstellerbaums und von den Quellen,
          Sie die vorhaben zu importieren, vorbereiten:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd vendor/foo/dist</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn list -R | grep -v '/$' | sort &gt; ../old</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>cd ../foo-9.9</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>find . -type f | cut -c 3- | sort &gt; ../new</code></strong></pre><p>Mit diesen beiden Dateien, wird Ihnen das folgende Kommando alle
          Dateien auflisten, die entfernt wurden (nur die Dateien in
          <code class="filename">old</code>):</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>comm -23 ../old ../new</code></strong></pre><p>Der folgende Befehl wird die hinzugefügten Dateien auflisten
          (nur diejenigen Dateien in
          <code class="filename">new</code>):</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>comm -13 ../old ../new</code></strong></pre><p>Wir führen dies nun zusammen:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd vendor/foo/foo-9.9</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>tar cf - . | tar xf - -C ../dist</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>cd ../dist</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>comm -23 ../old ../new | xargs svn remove</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>comm -13 ../old ../new | xargs svn add</code></strong></pre><div xmlns="" class="warning"><h3 class="admontitle">Warnung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Wenn in der neuen Version neue Verzeichnisse hinzugekommen
            sind, wird dieser letzte Befehl fehlschlagen.  Sie müssen
            diese Verzeichnisse hinzufügen und anschliessend den Befehl
            erneut ausführen.  Genauso müssen Sie Verzeichnisse, die
            entfernt wurden, händisch löschen.</p></div><p>Prüfen Sie die Eigenschaften jeder neuen Datei:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Alle Textdateien sollten <code class="literal">svn:eol-style</code> auf
            den Wert <code class="literal">native</code> gesetzt haben.</p></li><li class="listitem"><p>Alle Binärdateien sollten
              <code class="literal">svn:mime-type</code> auf
              <code class="literal">application/octet-stream</code> gesetzt haben,
              ausser es existiert ein passenderer Medientyp.</p></li><li class="listitem"><p>Ausführbare Dateien sollten
              <code class="literal">svn:executable</code> auf <code class="literal">*</code>
              gesetzt haben.</p></li><li class="listitem"><p>Es sollten keine anderen Eigenschaften auf den Dateien im
              Baum gesetzt sein.</p></li></ul></div><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Sie sind bereit, zu committen, jedoch sollten Sie zuerst die
            Ausgabe von <code class="command">svn stat</code> und <code class="command">svn
            diff</code> überprüfen, um sicher zu gehen, dass alles
            in Ordnung ist.</p></div><p>Sobald Sie den die neue Release-Version des Herstellers
          committed haben, sollten Sie Ihn für zukünftige Referenzen
          taggen.  Die beste und schnellste Methode ist, dies direkt im
          Repository zu tun:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>svn copy svn_base/vendor/foo/dist svn_base/vendor/foo/9.9</code></strong></pre><p>Um den neuen Tag zu bekommen, brauchen Sie nur ihre Arbeitskopie
          von <code class="filename">vendor/foo</code> zu
          aktualisieren.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Wenn Sie lieber die Kopie in der ausgecheckten Kopie
            durchführen wollen, vergessen Sie nicht, die generierte
            <code class="literal">svn:mergeinfo</code> wie oben beschrieben zu
            entfernen.</p></div></li><li class="step"><p class="title"><strong>Mit <span class="emphasis"><em>-HEAD</em></span> mergen</strong></p><p>Nachdem Sie Ihren Import vorbereitet haben, wird es Zeit zu
          mergen.  Die Option <code class="option">--accept=postpone</code> weist
          <acronym class="acronym">SVN</acronym> an, noch keine merge-Konflikte
          aufzulösen, weil wir uns um diese manuell kümmern
          werden:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd head/contrib/foo</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn update</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn merge --accept=postpone svn_base/vendor/foo/dist</code></strong></pre><p>Lösen Sie die Konflikte und stellen Sie sicher, dass alle
          Dateien, die im Herstellerzweig hinzugefügt oder entfernt
          wurden, auch sauber im Hauptzweig hinzugefügt bzw. gelöscht
          wurden.  Es ist immer ratsam, diese Unterschiede gegen den
          Herstellerbaum zu prüfen:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>svn diff --no-diff-deleted --old=svn_base/vendor/foo/dist --new=.</code></strong></pre><p>Die Option <code class="option">--no-diff-deleted</code> weist
          <acronym class="acronym">SVN</acronym> an, keine Dateien zu prüfen, die sich
          zwar im Herstellerbaum, aber nicht im Hauptzweig befinden.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Bei <acronym class="acronym">SVN</acronym> gibt es das Konzept von innerhalb
            und ausserhalb des Herstellerbaums nicht.  Wenn eine Datei, die
            zuvor eine lokale Änderung hatte, aber nun keine mehr
            besitzt, entfernen Sie einfach das was übrig ist, wie FreeBSD
            Versionstags, damit diese nicht länger in den diffs gegen
            den Herstellerbaum erscheinen.</p></div><p>Wenn irgendwelche Änderungen notwendig sind, um die Welt
          mit den neuen Quellen zu bauen, machen Sie diese jetzt und testen
          Sie diese bis Sie sicher sind, dass alles korrekt gebaut wird und
          richtig funktionert.</p></li><li class="step"><p class="title"><strong>Commit</strong></p><p>Nun sind Sie bereit für den Commit.  Stellen Sie sicher,
          dass Sie alles in einem einzigen Schritt durchführen.
          Idealerweise sollten Sie alle diese Schritte in einem sauberen Baum
          durchgeführt haben.  Falls dies der Fall ist, können Sie
          einfach aus dem obersten Verzeichnis dieses Baums committen.  Dies
          ist der beste Weg, um Überraschungen zu vermeiden.  Wenn Sie
          dies korrekt durchführen, wird der Baum atomar von einem
          konsistenten Zustand mit dem alten Code in einen neuen konsistenten
          Zustand mit dem neuen Code überführt.</p></li></ol></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-encumbered"></a>5.4. Belastende Dateien</h2></div></div></div><p>Es kann gelegentlich notwendig sein, belastende Dateien
      in den FreeBSD-Quelltextbaum zu integrieren. Braucht ein
      Gerät zum Beispiel ein Stück binären Code, der
      zuerst geladen werden muss, bevor das Gerät funktioniert,
      und wir haben keine Quellen zu diesem Code, dann wird die
      binäre Datei als belastend bezeichnet. Die folgenden
      Richtlinien sind beim Aufnehmen von belastenden Dateien in den
      FreeBSD-Quelltextbaum zu beachten.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Jede Datei, die durch die System-CPU(s) ausgeführt
	  wird und nicht als Quelltext vorliegt, ist belastend.</p></li><li class="listitem"><p>Jede Datei, deren Lizenz restriktiver ist als die BSD-
	  oder GNU-Lizenz, ist belastend.</p></li><li class="listitem"><p>Eine Datei, die herunterladbare Binär-Daten
	  enthält, ist nur belastend, wenn (1) oder (2)
	  zutreffen. Sie muss in einem ASCII-Format
	  gespeichert werden, das Architektur-neutral ist (file2c
	  oder uuencoding wird empfohlen).</p></li><li class="listitem"><p>Jede belastende Datei braucht eine spezielle
	  Genehmigung vom <a class="link" href="../../../../administration.html#t-core" target="_top">Core-Team</a>,
	  bevor diese in das Repository aufgenommen werden darf.</p></li><li class="listitem"><p>Belastende Dateien liegen unter
	  <code class="filename">src/contrib</code> oder
	  <code class="filename">src/sys/contrib</code>.</p></li><li class="listitem"><p>Das komplette Modul sollte auch am Stück
	  aufbewahrt werden. Es gibt keinen Grund, dieses zu teilen,
	  außer es gibt einen Code-Austausch mit Quelltext, der
	  nicht belastend ist.</p></li><li class="listitem"><p>Objekt-Dateien werden wie folgt benannt:
	  <code class="filename">arch/filename.o.uu&gt;</code>.</p></li><li class="listitem"><p>Kernel-Dateien:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Sollten immer nach
	      <code class="filename">conf/files.*</code> verweisen (um den Bau
	      einfach zu halten).</p></li><li class="listitem"><p>Sollten sich immer in <code class="filename">LINT</code>
	      befinden, jedoch entscheidet das <a class="link" href="../../../../administration.html#t-core" target="_top">Core-Team</a>
	      je nach Fall, ob es
	      auskommentiert wird oder nicht. Das <a class="link" href="../../../../administration.html#t-core" target="_top">Core-Team</a>
	      kann sich zu einem späteren Zeitpunkt
	      immer noch anders entscheiden.</p></li><li class="listitem"><p>Der <em class="firstterm">Release-Engineer</em>
	      entscheidet, ob es in ein Release aufgenommen wird oder
	      nicht.</p></li></ol></div></li><li class="listitem"><p>Userland-Dateien:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><a id="idp66252368" class="indexterm"></a><p>Das <a class="link" href="../../../../administration.html#t-core" target="_top">Core-Team</a>
	      entscheidet, ob der Code von
	      <code class="command">make world</code> gebaut wird oder nicht.</p></li><li class="listitem"><a id="idp66258768" class="indexterm"></a><p>Der <a class="link" href="../../../../administration.html#t-re" target="_top">Release-Engineer</a>
	      entscheidet, ob es in das Release
	      aufgenommen wird oder nicht.</p></li></ol></div></li></ol></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-shlib"></a>5.5. Shared-Libraries</h2></div><div><span class="authorgroup">Beigesteuert von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Satoshi</span> <span class="surname">Asami</span></span>, <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Peter</span> <span class="surname">Wemm</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">David</span> <span class="surname">O'Brien</span></span>. </span></div></div></div><p>Sollten Sie die Unterstützung für
      Shared-Libraries bei einem Port oder einem Stück Software,
      das dies nicht hat, hinzufügen, sollten die Versionsnummern
      dessen Regeln folgen. Im Allgemeinen hat die sich daraus
      resultierende Nummer nichts mit der Release-Version der Software
      zu tun.</p><p>Die drei Grundsätze zum Erstellen von Shared-Libraries
      sind:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Sie beginnen mit <code class="literal">1.0</code>.</p></li><li class="listitem"><p>Gibt es eine Änderung, die
	  abwärtskompatibel ist, so springen Sie zur
	  nächsten Minor-Version (beachten Sie, dass ELF-Systeme
	  die Minor-Version ignorieren).</p></li><li class="listitem"><p>Gibt es eine inkompatible Änderung, so springen
	  Sie bitte zur nächsten Major-Version.</p></li></ul></div><p>Zum Beispiel wird beim Hinzufügen von Funktionen und
      oder Fehlerbehebungen zur nächsten Minor-Version
      gesprungen, beim Löschen einer Funktion, Ändern
      von Funktionsaufrufen usw. ändert sich die Major-Version.</p><p>Bleiben Sie bei Versionsnummern in der Form major.minor
      (<em class="replaceable"><code>x</code></em>.<em class="replaceable"><code>y</code></em>).
      Unser dynamischer Linker a.out kann mit Versionsnummern
      in der Form
      <em class="replaceable"><code>x</code></em>.<em class="replaceable"><code>y</code></em>.<em class="replaceable"><code>z</code></em>
      nicht gut umgehen.
      Jede Versionsnummer nach dem <em class="replaceable"><code>y</code></em>
      (die dritte Zahl) wird völlig ignoriert, wenn
      Versionsnummern der Shared-Libraries verglichen werden, um
      zu bestimmen, mit welcher Bibliothek eine Anwendung verlinkt wird.
      Sind zwei Shared-Libraries vorhanden, die sich nur in der
      <span class="quote">&#8222;<span class="quote">micro</span>&#8220;</span>-Revision unterscheiden, so wird
      <code class="command">ld.so</code> zu der höheren verlinken.
      Dies bedeutet, dass wenn Sie mit <code class="filename">libfoo.so.3.3.3</code>
      verlinken, der Linker nur <code class="literal">3.3</code> in den
      Header aufnimmt und alles linkt, was mit
      <em class="replaceable"><code>libfoo.so.3</code></em>
      .<em class="replaceable"><code>(irgendetwas
      &gt;= 3)</code></em>.<em class="replaceable"><code>(höchste
      verfügbare Nummer)</code></em> beginnt.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml"><code class="command">ld.so</code> wird immer die höchste
	<span class="quote">&#8222;<span class="quote">Minor</span>&#8220;</span>-Revision benutzen. Beispielsweise wird
	es die <code class="filename">libc.so.2.2</code> bevorzugen
	gegenüber der <code class="filename">libc.so.2.0</code>, auch
	dann, wenn das Programm ursprünglich mit
	<code class="filename">libc.so.2.0</code> verlinkt war.</p></div><p>Unser dynamischer ELF-Linker kann keine Minor-Versionen
      handhaben. Dennoch sollten die Major- und Minor-Versionen genutzt
      werden, da unsere <code class="filename">Makefile</code>s <span class="quote">&#8222;<span class="quote">das
      Richtige machen</span>&#8220;</span> bezogen auf den Systemtyp.</p><p>Für nicht-Port-Bibliotheken lautet die Richtlinie,
      die Shared-Library-Versionsnummer nur einmal zwischen den
      Releases zu ändern. Weiterhin ist es vorgeschrieben, die
      Major-Version der Shared-Libraries nur bei Major-OS-Releases zu
      ändern (beispielsweise von 6.0 auf 7.0). Wenn Sie also eine
      Änderung an einer Systembibliothek vornehmen, die eine neue
      Versionsnummer benötigt, überprüfen Sie die
      Commit-Logs des <code class="filename">Makefile</code>s. Es liegt in der
      Verantwortung des Committers, dass sich eine erste solche
      Änderung seit dem letzten Release in der aktualisierten
      Versionsnummer der Shared-Library im
      <code class="filename">Makefile</code> äußert, folgende
      Änderungen werden nicht berücksichtigt.</p></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing"></a>Kapitel 6. Regressions- und Performance-Tests</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jürgen</span> <span class="surname">Lock</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="section"><a href="#testing-micro-benchmark">6.1. Mikro-Benchmark-Checkliste</a></span></dt></dl></div><p>Regressions-Tests werden durchgeführt, um zu überprüfen,
    ob ein bestimmter Teil des Systems wie erwartet funktioniert, und
    um sicherzustellen, dass bereits beseitigte Fehler nicht wieder eingebaut
    werden.</p><p>Die FreeBSD-Regressions-Testwerkzeuge finden Sie im
    FreeBSD-Quelltextbaum unter <code class="filename">src/tools/regression</code>.</p><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="testing-micro-benchmark"></a>6.1. Mikro-Benchmark-Checkliste</h2></div></div></div><p>Dieser Abschnitt enthält Tipps, wie
      ordnungsgemäße Mikro-Benchmarks unter FreeBSD oder für
      FreeBSD selbst erstellt werden.</p><p>Es ist nicht möglich, immer alle der folgenden
      Vorschläge zu berücksichtigen, aber je mehr davon,
      desto besser wird der Benchmark kleine
      Unterschiede nachweisen können.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Schalten Sie <acronym class="acronym">APM</acronym> und alles andere,
	  das den Systemtakt beeinflusst, ab
	  (<acronym class="acronym">ACPI</acronym>?).</p></li><li class="listitem"><p>Starten Sie in den Single-User-Modus. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=cron&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">cron</span>(8)</span></a>
	  und andere Systemdienste verursachen nur Störungen.
	  Genauso der <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a>-Systemdienst.
	  Falls während des Tests
	  SSH-Zugriff benötigt wird, schalten Sie entweder die
	  Neuerstellung des SSHv1-Schlüssels ab oder beenden Sie
	  den <code class="command">sshd</code>-Elternprozess während der
	  Tests.</p></li><li class="listitem"><p>Beenden Sie <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a>.</p></li><li class="listitem"><p>Falls <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=syslog&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">syslog</span>(3)</span></a>-Ereignisse erzeugt werden,
	  starten Sie <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a> mit leerer
	  <code class="filename">/etc/syslogd.conf</code> oder beenden Sie
	  es.</p></li><li class="listitem"><p>Sorgen Sie für möglichst wenig Disk-I/O;
	  vermeiden Sie es ganz wenn möglich.</p></li><li class="listitem"><p>Hängen Sie keine Dateisysteme ein, die Sie nicht
	  benötigen.</p></li><li class="listitem"><p>Hängen Sie <code class="filename">/</code>, <code class="filename">/usr</code> und die anderen
	  Dateisysteme nur lesbar ein wenn möglich. Dies
	  verhindert, dass atime-Aktualisierungen auf der Festplatte (usw.) das
	  Ergebnis verfälschen.</p></li><li class="listitem"><p>Initialisieren Sie das beschreibbare
	  Test-Dateisystem mit <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a> neu und füllen Sie es
	  aus einer <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a>- oder <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a>-Datei vor jedem
	  Lauf. Hängen Sie es aus und wieder ein, bevor Sie den
	  Test starten. Dies sorgt für einen konsistenten
	  Dateisystemaufbau. Bei einem <span class="quote">&#8222;<span class="quote">worldstone</span>&#8220;</span>-Test
	  bezieht sich dies auf <code class="filename">/usr/obj</code> (Initialisieren Sie
	  es einfach mit <code class="command">newfs</code> neu und hängen Sie
	  es ein). Um absolut reproduzierbare Ergebnisse zu bekommen,
	  füllen Sie das Dateisystem aus einer <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dd&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">dd</span>(1)</span></a>-Datei
	  (d.h. <code class="command">dd
	  if=myimage of=/dev/ad0s1h
	  bs=1m</code>).</p></li><li class="listitem"><p>Benutzen Sie malloc-gestützte oder vorbelastete
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=md&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">md</span>(4)</span></a>-Partitionen.</p></li><li class="listitem"><p>Starten Sie zwischen den einzelnen
	  Durchläufen neu, dies sichert einen konsistenteren
	  Zustand.</p></li><li class="listitem"><p>Entfernen Sie alle nicht unbedingt benötigten
	  Gerätetreiber aus dem Kernel. Wenn z.B. USB für
	  den Test nicht benötigt wird, entfernen Sie es aus dem
	  Kernel. Gerätetreiber, die sich Hardware zuteilen, haben
	  oft <span class="quote">&#8222;<span class="quote">tickende</span>&#8220;</span> Timeouts.</p></li><li class="listitem"><p>Konfigurieren Sie nicht Hardware, die
	  nicht benutzt wird. Entfernen Sie Festplatten
	  mit <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=atacontrol&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">atacontrol</span>(8)</span></a> und <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=camcontrol&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">camcontrol</span>(8)</span></a>, wenn diese
	  für den Test nicht gebraucht werden.</p></li><li class="listitem"><p>Konfigurieren Sie nicht das Netzwerk, es sei denn es
	  wird getestet, oder warten Sie, bis der Test fertig ist, wenn
	  Sie das Ergebnis auf einen anderen Rechner übertragen
	  wollen.</p><p>Falls das System an ein öffentliches Netzwerk
	  angeschlossen sein muss, achten Sie auf Spitzen im
	  Broadcast-Verkehr. Obwohl dieser kaum auffällt, wird
	  er CPU-Zyklen brauchen. Ähnliches gilt für
	  Multicast.</p></li><li class="listitem"><p>Legen Sie jedes Dateisystem auf eine eigene Festplatte.
	  Dies minimiert Jitter durch Optimierungen von
	  Lesekopfbewegungen.</p></li><li class="listitem"><p>Minimieren Sie Ausgaben auf serielle oder VGA-Konsolen.
	  Ausgabenumleitung in Dateien ergibt weniger Jitter
	  (serielle Konsolen werden leicht zum Flaschenhals).
	  Benutzen Sie die Tastatur nicht, während der Test
	  läuft, sogar <span class="keycap"><strong>space</strong></span> oder
	  <span class="keycap"><strong>back-space</strong></span> wirken sich auf die
	  Ergebnisse aus.</p></li><li class="listitem"><p>Stellen Sie sicher, dass der Test lang genug
	  läuft, aber nicht zu lange. Wenn er zu kurz ist, sind
	  Zeitstempel ein Problem. Wenn er zu lang ist, werden
	  Temperaturänderungen und Drift die Frequenz von
	  Quarzkristallen im Rechner beeinflussen. Daumenregel: mehr
	  als eine Minute, weniger als eine Stunde.</p></li><li class="listitem"><p>Versuchen Sie, die Temperatur in der Umgebung des
	  Rechners so stabil wie möglich zu halten. Diese beeinflusst
	  sowohl Quarzkristalle als auch Festplatten-Algorithmen.
	  Um einen wirklich stabilen Takt zu erhalten, wäre es auch
	  möglich, einen stabilisierten Takt anzuschließen.
	  D.h. besorgen Sie sich einen OCXO + PLL und koppeln Sie das
	  Ausgangssignal mit den Taktgeberschaltkreisen anstelle des
	  Quarzkristalls der Hauptplatine. Wenden Sie sich an
	  Poul-Henning Kamp, wenn Sie mehr Informationen hierüber
	  benötigen.</p></li><li class="listitem"><p>Lassen Sie den Test mindestens drei Mal laufen, besser
	  mehr als 20 Mal, sowohl
	  für <span class="quote">&#8222;<span class="quote">vor</span>&#8220;</span> als auch für
	  <span class="quote">&#8222;<span class="quote">nach</span>&#8220;</span> dem Code. Versuchen Sie abzuwechseln
	  (d.h. nicht erst 20 Mal <span class="quote">&#8222;<span class="quote">vorher</span>&#8220;</span> und dann 20
	  Mal <span class="quote">&#8222;<span class="quote">nachher</span>&#8220;</span>), dies ermöglicht,
	  umgebungsbedingte Effekte zu erkennen. Wechseln Sie nicht
	  1:1 ab, sondern 3:3; dies erlaubt,
	  Wechselwirkungseffekte zu erkennen.</p><p>Ein gutes Muster ist:
	  <code class="literal">bababa{bbbaaa}*</code>. Dies gibt Hinweise nach
	  den ersten 1+1-Läufen (sodass Sie den Test stoppen
	  können, falls er völlig daneben geht), Sie
	  können die Standardabweichung nach den ersten 3+3-Läufen
	  überprüfen (zeigt an, ob sich ein
	  längerer Lauf lohnt), später
	  Trends und Wechselwirkungen.</p></li><li class="listitem"><p>Benutzen Sie <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ministat&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ministat</span>(1)</span></a>, um
	  festzustellen, ob Ihre Ergebnisse signifikant sind.
	  Überlegen Sie sich, das Buch <span class="quote">&#8222;<span class="quote">Cartoon guide to
	  statistics</span>&#8220;</span> ISBN: 0062731025 zu kaufen. Es ist sehr
	  empfehlenswert, falls Sie Dinge wie Standardabweichung und
	  Studentsche t-Verteilung vergessen oder nie gelernt
	  haben.</p></li><li class="listitem"><p>Benutzen Sie keinen Hintergrund-<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a>, wenn Sie
	  ihn nicht selbst testen
	  wollen. Schalten Sie auch <code class="varname">background_fsck</code>
	  in <code class="filename">/etc/rc.conf</code> aus, es sei denn der
	  Benchmark wird nicht mindestens 60+<span class="quote">&#8222;<span class="quote">Laufzeit von
	  <code class="command">fsck</code></span>&#8220;</span> Sekunden nach Systemstart
	  gestartet, da <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a> startet und prüft, ob
	  <code class="command">fsck</code> auf irgendeinem der Dateisysteme
	  laufen muss, wenn Hintergrund-<code class="command">fsck</code>
	  eingeschaltet ist. Stellen Sie ebenfalls sicher, dass keine
	  Snapshots herumliegen, falls der Benchmark nicht ein Test
	  mit Snapshots ist.</p></li><li class="listitem"><p>Falls der Benchmark unerwartet schlechte Performance
	  zeigt, überprüfen Sie Dinge wie große Mengen
	  Interrupts von unerwarteten Quellen. Es gibt Berichte, dass
	  einige <acronym class="acronym">ACPI</acronym>-Versionen sich <span class="quote">&#8222;<span class="quote">daneben
	  benehmen</span>&#8220;</span> und ein Übermaß an Interrupts
	  erzeugen. Um zu helfen, ungewöhnliche Testergebnisse zu
	  diagnostizieren, machen Sie ein paar Momentaufnahmen von
	  <code class="command">vmstat -i</code> und suchen Sie nach
	  Ungewöhnlichem.</p></li><li class="listitem"><p>Gehen Sie mit Parametern zur Optimierung
	  von Kernel, Userland und Fehlersuche vorsichtig um.
	  Es passiert schnell, irgendetwas durchrutschen zu
	  lassen und dann später festzustellen, dass der Test
	  nicht das gleiche verglichen hat.</p></li><li class="listitem"><p>Erstellen Sie nie Benchmarks unter Verwendung der Kernel-Optionen
	  <code class="literal">WITNESS</code> und <code class="literal">INVARIANTS</code>,
	  wenn der Test nicht diese Merkmale selbst
	  untersuchen soll. <code class="literal">WITNESS</code> kann zu 400% und
	  mehr Performance-Abnahme führen. Ähnliches gilt
	  für Userland-<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=malloc&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">malloc</span>(3)</span></a>-Parameter, Voreinstellungen
	  hierbei unterscheiden sich bei -CURRENT von denen bei
	  Production-Releases.</p></li></ul></div></div></div></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipc"></a>Teil II. Interprozess-Kommunikation</h1></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="chapter"><a href="#sockets">7. Sockets</a></span></dt><dt><span class="chapter"><a href="#ipv6">8. IPv6 Internals</a></span></dt><dd><dl><dt><span class="sect1"><a href="#ipv6-implementation">8.1. IPv6/IPsec-Implementierung</a></span></dt></dl></dd></dl></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets"></a>Kapitel 7. Sockets</h2></div></div></div><p>Dieses Kapitel ist noch nicht übersetzt.
    Lesen Sie bitte <a class="link" href="../../../../doc/en_US.ISO8859-1/books/developers-handbook/sockets.html" target="_top">
    das Original in englischer Sprache</a>.  Wenn Sie helfen
    wollen, dieses Kapitel zu übersetzen, senden Sie bitte
    eine E-Mail an die Mailingliste 'FreeBSD German Documentation Project'
  <code class="email">&lt;<a xmlns="" class="email" href="mailto:de-bsd-translators@de.FreeBSD.org">de-bsd-translators@de.FreeBSD.org</a>&gt;</code>.</p></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6"></a>Kapitel 8. IPv6 Internals</h2></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#ipv6-implementation">8.1. IPv6/IPsec-Implementierung</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="ipv6-implementation"></a>8.1. IPv6/IPsec-Implementierung</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Yoshinobu</span> <span class="surname">Inoue</span></span>. </span></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Michelle</span> <span class="surname">Wechter</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jürgen</span> <span class="surname">Dankoweit</span></span>. </span></div></div></div><p>Dieser Abschnitt erklärt die von der IPv6- und
      IPsec-Implementierung abhängigen Internas. Die
      Funktionalitäten wurden vom <a class="link" href="http://www.kame.net/" target="_top">KAME-Projekt</a>
      abgeleitet</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6details"></a>8.1.1. IPv6</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66406992"></a>8.1.1.1. Konformität</h4></div></div></div><p>Die IPv6 abhängigen Funktionen richten sich nach,
	  oder versuchen sich nach den neuesten IPv6-Spezifikationen
	  zu richten. (<span class="emphasis"><em>Achtung</em></span>: Dies ist keine
	  vollständige Liste - es wäre zu aufwändig,
	  diese zu pflegen...).</p><p>Für weitere Details beachten sie bitte die
	  entsprechenden Kapitel, RFCs, manual pages, oder Kommentare
	  in den Quelltexten.</p><p>Konformitätsprüfungen wurden basierend auf
	  KAME-STABLE-Kit des TAHI-Projekts durchgeführt. Die
	  Ergebnisse können unter <code class="uri"><a class="uri" href="http://www.tahi.org/report/KAME/" target="_top">http://www.tahi.org/report/KAME/</a></code> eingesehen
	  werden. In der Vergangenheit begleiteten wir auch Tests mit
	  unseren älteren "Snapshots" an der Univ. of New
	  Hampshire IOL (<code class="uri"><a class="uri" href="http://www.iol.unh.edu/" target="_top">http://www.iol.unh.edu/</a></code>).</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>RFC1639: FTP Operation Over Big Address Records
	      (FOOBAR)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>RFC2428 wird gegenüber RFC1639 bevorzugt.
		  FTP-Clients versuchen zuerst RFC2428, dann im
		  Fehlerfall RFC1639.</p></li></ul></div></li><li class="listitem"><p>RFC1886: DNS Extensions to support IPv6</p></li><li class="listitem"><p>RFC1933: Transition Mechanisms for IPv6 Hosts and
	      Routers</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>IPv4 kompatible Adressen werden nicht
		  unterstützt.</p></li><li class="listitem"><p>Automatisches Tunneln (beschrieben in 4.3 dieses
		  RFC) wird nicht unterstützt.</p></li><li class="listitem"><p>Die <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gif&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">gif</span>(4)</span></a>-Schnittstelle implementiert
		  einen IPv[46]-over-IPv[46] Tunnel in einer
		  allgemeinen Art und Weise und es umfaßt
		  "configured tunnel" wie in der Spezifikation
		  beschrieben. Siehe auch <a class="link" href="#gif" title="8.1.1.5. Generische Tunnel-Schnittstelle">23.5.1.5</a> in diese Dokument
		  für weitere Details.</p></li></ul></div></li><li class="listitem"><p>RFC1981: Path MTU Discovery for IPv6</p></li><li class="listitem"><p>RFC2080: RIPng for IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>usr.sbin/route6d unterstützt dies.</p></li></ul></div></li><li class="listitem"><p>RFC2292: Advanced Sockets API for IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Unterstützte Bibliotheksfunktionen bzw.
		  Kernel-APIs, siehe auch
		  <code class="filename">sys/netinet6/ADVAPI</code>.</p></li></ul></div></li><li class="listitem"><p>RFC2362: Protocol Independent Multicast-Sparse
	    Mode (PIM-SM)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>RFC2362 definiert Paketformate für PIM-SM.
		  <code class="filename">draft-ietf-pim-ipv6-01.txt</code>
		  wurde basierend auf diesem RFC verfaßt.</p></li></ul></div></li><li class="listitem"><p>RFC2373: IPv6 Addressing Architecture</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Unterstützt vom Knoten erforderliche
		  Adressen und richtet sich nach den Erfordernissen
		  des Bereichs.</p></li></ul></div></li><li class="listitem"><p>RFC2374: An IPv6 Aggregatable Global Unicast Address
	      Format</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Unterstützt die 64-Bit-Breite einer
		  Interface ID.</p></li></ul></div></li><li class="listitem"><p>RFC2375: IPv6 Multicast Address Assignments</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Userland-Applikationen nutzen die bekannten
		  Adressen, die in den RFC festgelegt sind.</p></li></ul></div></li><li class="listitem"><p>RFC2428: FTP Extensions for IPv6 and NATs</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>RFC2428 wird gegenüber RFC1639 bevorzugt.
		  FTP-Clients versuchen zuerst RFC2428, dann im
		  Fehlerfall RFC1639.</p></li></ul></div></li><li class="listitem"><p>RFC2460: IPv6 specification</p></li><li class="listitem"><p>RFC2461: Neighbor discovery for IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Siehe auch <a class="link" href="#neighbor-discovery" title="8.1.1.2. Neighbor Discovery">23.5.1.2</a> in
		  diesem Dokument für weitere Details.</p></li></ul></div></li><li class="listitem"><p>RFC2462: IPv6 Stateless Address
	      Autoconfiguration</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Siehe auch <a class="link" href="#ipv6-pnp" title="8.1.1.4. Plug and Play">23.5.1.4</a> in diesem
		  Dokument für weitere Details.</p></li></ul></div></li><li class="listitem"><p>RFC2463: ICMPv6 for IPv6 specification</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Siehe auch <a class="link" href="#icmpv6" title="8.1.1.9. ICMPv6">23.5.1.9</a> in diesem Dokument
		  für weitere Details.</p></li></ul></div></li><li class="listitem"><p>RFC2464: Transmission of IPv6 Packets over Ethernet
	      Networks</p></li><li class="listitem"><p>RFC2465: MIB for IPv6: Textual Conventions and
	      General Group</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Notwendige Statistiken werden vom Kernel
		  gesammelt. Die aktuelle
		  IPv6-MIB-Unterstützung wird als Patch-Sammlung
		  für ucd-snmp bereitgestellt.</p></li></ul></div></li><li class="listitem"><p>RFC2466: MIB for IPv6: ICMPv6 group</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Notwendige Statistiken werden vom Kernel
		  gesammelt. Die aktuelle IPv6-MIB-Unterstützung
		  wird als Patch-Sammlung für ucd-snmp
		  bereitgestellt.</p></li></ul></div></li><li class="listitem"><p>RFC2467: Transmission of IPv6 Packets over FDDI
	      Networks</p></li><li class="listitem"><p>RFC2497: Transmission of IPv6 packet over ARCnet
	      Networks</p></li><li class="listitem"><p>RFC2553: Basic Socket Interface Extensions for
	      IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>IPv4 mapped address (3.7) and special behavior
		  of IPv6 wildcard bind socket (3.8) are supported.
		  See <a class="link" href="#ipv6-wildcard-socket" title="8.1.1.12. IPv4-Mapped-Address und IPv6-Wildcard-Socket">23.5.1.12</a> in
		  this document for details.</p></li></ul></div></li><li class="listitem"><p>RFC2675: IPv6 Jumbogramms</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Siehe auch <a class="link" href="#ipv6-jumbo" title="8.1.1.7. Jumbo Payload">23.5.1.7</a> in diesem
		  Dokument für weitere Details.</p></li></ul></div></li><li class="listitem"><p>RFC2710: Multicast Listener Discovery for
	      IPv6</p></li><li class="listitem"><p>RFC2711: IPv6 router alert option</p></li><li class="listitem"><p><code class="filename">draft-ietf-ipngwg-router-renum-08</code>:
	      Router renumbering for IPv6</p></li><li class="listitem"><p><code class="filename">draft-ietf-ipngwg-icmp-namelookups-02</code>:
	      IPv6 Name Lookups Through ICMP</p></li><li class="listitem"><p><code class="filename">draft-ietf-ipngwg-icmp-name-lookups-03</code>:
	      IPv6 Name Lookups Through ICMP</p></li><li class="listitem"><p><code class="filename">draft-ietf-pim-ipv6-01.txt</code>:
	      PIM for IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pim6dd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pim6dd</span>(8)</span></a> implementiert dense mode.
		  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=pim6sd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">pim6sd</span>(8)</span></a> implementiert sparse mode.</p></li></ul></div></li><li class="listitem"><p><code class="filename">draft-itojun-ipv6-tcp-to-anycast-00</code>:
	      Unterbrechen einer TCP-Verbindung toward IPv6 anycast
	      address</p></li><li class="listitem"><p><code class="filename">draft-yamamoto-wideipv6-comm-model-00</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Beachte <a class="link" href="#ipv6-sas" title="8.1.1.6. Source Address Selection">23.5.1.6</a>
		  in deisem Dokument für weitere Deatils.</p></li></ul></div></li><li class="listitem"><p><code class="filename">draft-ietf-ipngwg-scopedaddr-format-00.txt
	      </code>: Eine Erweiterung des Format for IPv6 Scoped
	      Addresses</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="neighbor-discovery"></a>8.1.1.2. Neighbor Discovery</h4></div></div></div><p>Neighbor Discovery ist weitestgehend stabil. Zur Zeit
	  werden Addressauflösung, Duplicated Address Detection
	  (DAD), und Neighbor Unreachability Detection (NUD)
	  unterstützt. In der näheren Zukunft werden wir
	  Proxy Neighbor Advertisement Unterstützung in den
	  Kernel einbauen und Unsolicited Neighbor Advertisement
	  Übertragungskommandos als Verwaltungsprogramm zur
	  Verfügung stellen.</p><p>Falls DAD versagt, wird die Adresse als "duplicated"
	  markiert und eine Nachricht wird erzeugt, die an Syslog
	  gesandt wird (und für gewöhnlich an die Konsole).
	  Die "duplicated"-Markierung kann mit <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ifconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ifconfig</span>(8)</span></a>
	  überprüft werden. Es liegt in der Verantwortung
	  des Administrators, auf DAD-Fehler zu achten und diese zu
	  beheben. Dieses Verhalten sollte in der näheren Zukunft
	  verbessert werden.</p><p>Manche Netzwerktreiber verbinden Multicast-Pakete mit
	  sich selbst, sogar, wenn es vorgeschrieben ist, es nicht zu
	  tun (vor allem im Promiscuous-Modus). In solchen Fällen
	  könnte DAD versagen, weil die DAD-Steuerung ein inbound
	  NS packet sieht (eigentlich vom Knoten selber) und
	  betrachtet es als ein Duplikat. Sie könnten sich die
	  #if-Bedingung ansehen, die in
	  sys/netinet6/nd6_nbr.c:nd6_dad_timer() als "Workaround" mit
	  "heuristics" markiert ist (Beachte, dass das Kodefragment im
	  Abschnitt "heuristics" nicht der Spezifikation
	  entspricht).</p><p>Neighbor Discovery specification (RFC2461)
	  kommuniziert in den folgenden Fällen nicht über
	  neighbor cache handling:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Der Knoten empfing ein unverlangtes
	      RS/NS/NA/redirect-Paket ohne Link-Layer-Adresse, wenn
	      kein neighbor cache-Eintrag vorhanden ist.</p></li><li class="listitem"><p>neighbor cache handling bei Geräten ohne
	      Link-Layer-Adresse (wir benötigen einen neighbor
	      cache Eintrag für das IsRouter-Bit)</p></li></ol></div><p>Im ersten Fall implemenierten wir einen Workaround
	  basierend auf Diskussionen in der IETF-Ipngwg-Mailing-Liste.
	  Für weitere Details beachten Sie die Kommentare im
	  Quelltext und im Email-Thread, der bei (IPng 7155) mit dem
	  Datum vom 6. Feb 1999 gestartet wurde.</p><p>IPv6 on-link Erkennungsregel (RFC2461) ist recht
	  unterschiedlich zu Übernahmen im BSD-Netzwerkkode. Zur
	  Zeit wird keine on-link Erkennungsregel unterstützt,
	  bei der die Defaultrouter-Liste leer ist (RFC2461, Abschnitt
	  5.2, letzter Satz im zweiten Absatz - beachte, dass die
	  Spezifikation das Wort "host" und "Knoten" an mehreren
	  Stellen im Abschnitt mißbraucht).</p><p>Um mögliche DoS-Attacken und unendliche Schleifen
	  zu verhindern, werden bis jetzt nur 10 Optionen bei
	  ND-Paketen akzeptiert. Deshalb werden nur die ersten 10
	  Präfixe berücksichtigt, wenn man
	  20-Präfixoptionen zu RA hinzugefügt hat. Falls
	  das zu Schwierigkeiten führen sollte, dann sollte in
	  der FREEBSD-CURRENT-Mailing-Liste gefragt werden und/oder
	  die Variable nd6_maxndopt in
	  <code class="filename">sys/netinet6/nd6.c</code> modifizieren. Falls
	  die Nachfrage groß genug ist, könnte man einen
	  sysctl-Knopf für die Variable vorsehen.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-scope-index"></a>8.1.1.3. Bereichsindex</h4></div></div></div><p>IPv6 benutzt Adressbereiche (Scoped Addresses).
	  Deshalb ist es sehr wichtig, mit einer IPv6-Adresse einen
	  Bereichsindex anzugeben (Schnittstellenindex für
	  link-local-Adresse, oder einen Lageindex für
	  site-local-Adressen). Ohne einen Bereichsindex ist ein
	  IPv6-Adressbereich für den Kernel zweideutig und dem
	  Kernel ist es nicht möglich, die Ausgabeschnittstelle
	  für ein Paket festzustellen.</p><p>Gewöhnliche Userland-Anwendungen sollten die
	  erweiterte Programmierschnittstelle (RFC2292) benutzen, um
	  den Bereichsindex oder Schnittstellenindex festzulegen.
	  Für ähnliche Zwecke wurde in RFC2553 sin6_scope_id
	  member in der sockaddr_in6-Struktur definiert. Wie auch
	  immer, die Semantik für sin6_scope_id ist ziemlich
	  wage. Wenn man auf Portierbarkeit der Anwendung
	  achten muß, dann schlagen wir vor, die erweiterte
	  Programmierschnittstelle anstelle von sin6_scope_id zu
	  benutzen.</p><p>Im Kernel ist ein Schnittstellenindex für
	  link-local scoped-Adressen in das zweite 16bit-Wort (drittes
	  und viertes Byte) der IPv6-Adresse eingebettet. Zum
	  Beispiel sieht man folgendes</p><pre class="screen">	fe80:1::200:f8ff:fe01:6317</pre><p>in der Routing-Tabelle und in der
	  Schnittstellenadress-Struktur (structin6_ifaddr). Oben
	  genannte Adresse ist eine "link-local unicast address" die
	  zu einer Netzwerkschnittstelle gehört, deren
	  Schnittstellenbezeichner 1 (eins) ist. Der
	  eingebettete Index ermöglicht es, IPv6 link
	  local-Adressen über mehrere Schnittstellen hinweg
	  effektiv und mit wenig Änderungen am Kode zu
	  identifizieren.</p><p>Routing-Dämonen und Konfigurationsprogramme wie
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=route6d&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">route6d</span>(8)</span></a> und <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ifconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ifconfig</span>(8)</span></a> werden den
	  "eingebetteten" Bereichsindex verändern müssen.
	  Diese Programme benutzen routing sockets und ioctls (wie
	  SIOCGIFADDR_IN6) und die Kernel-Programmierschnittstelle
	  wird IPv6-Adressen, dessen zweites 16-Bit-Word gesetzt ist,
	  zurückgeben. Diese Programmierschnittstellen dienen
	  zur Änderung der Kernel-internen Struktur. Programme,
	  die diese Programmierschnittstellen benutzen, müssen
	  ohnehin auf Unterschiede in den Kerneln vorbereitet
	  sein.</p><p>Wenn man einen Adressbereich in der Kommandozeile
	  angibt, schreibt man niemals die eingebettete Form (so etwas
	  wie ff02:1::1 or fe80:2::fedc). Man erwartet nicht, dass es
	  funktioniert. Man benutzt immer die Standardform wie
	  ff02::1 oder fe80::fedc, zusammen mit der
	  Kommandozeilenoption, die die Schnittstelle festlegt (wie
	  <code class="command">ping6 -I ne0 ff02::1</code>). Allgemein gilt,
	  wenn ein Kommando keine Kommandozeilenoption hat, um die
	  Ausgabeschnittstelle zu definieren, ist dieses Kommando noch
	  nicht für Adressbereiche bereit. Dies scheint der
	  Prämisse von IPv6 entgegenzustehen. Wir glauben, dass
	  die Spezifikationen einige Verbesserungen
	  benötigen.</p><p>Einige der Userland-Werkzeuge unterstützen die
	  erweiterte numerische IPv6-Syntax wie sie in
	  <code class="filename">draft-ietf-ipngwg-scopedaddr-format-00.txt</code>
	  beschrieben ist. Man kann die ausgehende Verbindung
	  angeben, indem man den Namen der ausgehenden Schnittstelle
	  wie folgt benutzt: "fe80::1%ne0". Auf diese Art und Weise
	  ist man in der Lage, eine link-local scoped Adresse ohne
	  viele Schwierigkeiten anzugeben.</p><p>Um die Erweiterungen im eigenen Programm zu nutzen,
	  muss man <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> und <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getnameinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getnameinfo</span>(3)</span></a> mit
	  NI_WITHSCOPEID verwenden. Die Implementierung setzt im
	  Moment eine 1-zu-1 Beziehung zwischen einer Verbindung und
	  einer Schnittstelle voraus, die stärker ist, als es die
	  Spezifikationen beschreiben.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-pnp"></a>8.1.1.4. Plug and Play</h4></div></div></div><p>Der grösste Teil der statuslosen
	  IPv6-Adress-Autokonfiguration ist im Kernel implementiert.
	  Neighbor-Discovery-Funktionen sind als ganzes im Kernel
	  implementiert. Router-Advertisement (RA) Eingabe für
	  Hosts ist im Kernel implementiert. Router-Solicitation (RS)
	  Ausgabe für Hosts, RS-Eingabe für Router und
	  RA-Ausgabe für Router ist im Userland
	  implementiert.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66514896"></a>8.1.1.4.1. Zuweisung von link-local und speziellen
	    Adressen</h5></div></div></div><p>Die IPv6 link-local-Adresse wird aus einer
	    IEEE802-Adresse (Ethernet MAC address) erzeugt. Jeder
	    Schnittstelle wird automatisch eine IPv6
	    link-local-Adresse zugewiesen, sobald die Schnittstelle
	    aktiv ist (IFF_UP). Ebenso wird eine direkte Route
	    für die link-local-Adresse zur Routing-Tabelle
	    hinzugefügt.</p><p>Hier ist eine Ausgabe des netstat-Kommandos:</p><pre class="screen">Internet6:
Destination                   Gateway                   Flags      Netif Expire
fe80:1::%ed0/64               link#1                    UC          ed0
fe80:2::%ep0/64               link#2                    UC          ep0</pre><p>Schnittstellen, die keine IEEE802-Adresse haben
	    (Pseudo-Schnittstellen wie Tunnel-Schnittstellen oder
	    ppp-Schnittstellen), borgen sich eine IEEE802-Adresse von
	    anderen Schnittstellen wie Ethernet-Schnittstellen aus,
	    wann immer das möglich ist. Wenn keine
	    IEEE802-Geräte eingebaut sind, wird als letzte
	    Möglichkeit eine Pseudo-Zufallszahl - MD5(hostname) -
	    als Quelle für eine link-local-Adresse benutzt.
	    Falls diese für den Einsatz nicht geeignet sein
	    sollte, dann muss man eine link-local-Adresse manuell
	    konfigurieren.</p><p>Falls eine Schnittstelle nicht imstande ist,
	    IPv6-Adressen zu handhaben (wie fehlende
	    Unterstützung des multicast), wird keine
	    link-local-Adresse der Schnittstelle zugewiesen. Siehe
	    Abschnitt 2 für weitere Details.</p><p>Jede Schnittstelle verbindet die solicited multicast
	    Adresse und link-local all-nodes multicast-Adressen (z.B.
	    fe80::1:ff01:6317 und ff02::1, jeweils zu der Verbindung,
	    an die die Schnittstelle verbunden ist). zusätzlich
	    zu einer link-local-Adresse wird eine loopback-Adresse
	    (::1) einer loopback-Schnittstelle zugewiesen.
	    Außerdem werden ::1/128 und ff01::/32 automatisch
	    zur Routing-Tabelle hinzugefügt und die
	    loopback-Schnittstelle verbindet sich mit der node-local
	    multicast Gruppe ff01::1.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66517968"></a>8.1.1.4.2. Stateless address autoconfiguration beim Host</h5></div></div></div><p>In der IPv6-Spezifikation werden Knoten in zwei
	    Kategorien unterteilt: <span class="emphasis"><em>Router</em></span> und
	    <span class="emphasis"><em>Hosts</em></span>. Router leiten Pakete, die an
	    andere adressiert sind, weiter, Hosts leiten Pakete nicht
	    weiter. net.inet6.ip6.forwarding definiert, ob dieser
	    Knoten ein Router oder ein Host ist (Router falls es 1
	    ist, Host, falls es 0 ist).</p><p>Sobald ein Host ein Router-Advertisement vom Router
	    hört, kann er sich selbst mit statusloser
	    automatischer Adressen konfigurieren. Dieses Verhalten
	    kann mit net.inet6.ip6.accept_rtadv (der Host konfiguriert
	    sich selber, wenn es auf 1 gesetzt ist) beeinflusst
	    werden. Bei einer automatischen Konfiguration wird das
	    Netzwerkadresspräfix für die empfangende
	    Schnittstelle (für gewöhnlich das globale
	    Adresspräfix) hinzugefügt. Die Standard-Route
	    wird ebenso konfiguriert. Router erzeugen periodisch
	    Router-Advertisement-Pakete. Um einen benachbarten Router
	    aufzufordern, ein RA-Paket zu erzeugen, kann eine
	    Host-Router-Solicitation übertragen werden. Um
	    jederzeit ein RS-Paket zu erzeugen, benutzt man das
	    <span class="emphasis"><em>rtsol</em></span>-Kommando. Ein
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rtsold&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rtsold</span>(8)</span></a>-Dämon ist ebenso verfügbar.
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rtsold&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rtsold</span>(8)</span></a> erzeugt Router-Solicitation, wann immer es
	    notwendig ist und es funktioniert großartig "bei
	    normadischem Einsatz" (Notebooks/Laptops). Falls jemand
	    Router-Advertisements zu ignorieren wünscht, setzt man
	    mit sysctl et.inet6.ip6.accept_rtadv auf 0.</p><p>Um Router-Advertisement von einem Router aus zu
	    erzeugen, benutzt man den
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rtadvd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rtadvd</span>(8)</span></a>-Dämon.</p><p>Beachte, dass die IPv6-Spezifikation von folgenden
	    Punkte ausgeht und nicht konforme Fälle werden als
	    nicht spezifiziert ausgelassen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Nur Hosts hören auf Router-Angebote</p></li><li class="listitem"><p>Hosts haben eine einzige Netzwerk-Schnittstelle
		(außer loopback)</p></li></ul></div><p>Deshalb ist es unklug, net.inet6.ip6.accept_rtadv
	    bei Routern oder bei Hosts mit mehreren Schnittstellen
	    einzuschalten. Ein falsch konfigurierter Knoten kann sich
	    seltsam verhalten (nicht konforme Konfiguration ist
	    für diejenigen erlaubt, die Experimente
	    durchführen möchten).</p><p>Eine Zusammenfassung des sysctl-Angaben:</p><pre class="screen">	accept_rtadv forwarding Rolle des Knotens
   ---	   ---    ---
    0       0    Host (wird manuell konfiguriert)
    0       1    Router
    1       0    automatisch konfigurierter Host
	             (Die Spezifikation setzt voraus, dass der Host nur eine einzelne Schnittstelle hat, ein automatisch konfigurierter Host mit mehreren Schnittstellen ist außerhalb der Betrachtung)
    1       1    ungültig, oder für Experimentierzwecke (außerhalb der Spezifikation)</pre><p>RFC2462 hat eine Überprüfungsregel gegen
	    eingehende RA-prefix-information-option, in 5.5.3 (e).
	    Dies dient zum Schutz des Hosts vor schlecht oder falsch
	    konfigurierten Routern, die eine sehr kurze
	    Präfixlebenszeit ankündigen. Es gab
	    Aktualisierungen von Jim Bound in der ipngwg-Mailing-Liste
	    (suche nach "(ipng 6712)" im Archive) und es wurde Jims
	    Aktualisierung implementiert.</p><p>Siehe auch <a class="link" href="#neighbor-discovery" title="8.1.1.2. Neighbor Discovery">23.5.1.2</a> im Dokument
	    für das Verhältnis zwischen DAD und
	    autoconfiguration.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="gif"></a>8.1.1.5. Generische Tunnel-Schnittstelle</h4></div></div></div><p>GIF (Generische Schnittstelle) ist eine
	  Pseudoschnittstelle für konfigurierte Tunnel. Details
	  sind in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gif&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">gif</span>(4)</span></a> beschrieben. Im Moment sind</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>v6 in v6</p></li><li class="listitem"><p>v6 in v4</p></li><li class="listitem"><p>v4 in v6</p></li><li class="listitem"><p>v4 in v4</p></li></ul></div><p>verfügbar. Benutze <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gifconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gifconfig</span>(8)</span></a>, um die
	  physikalische (außerhalb liegende) Quelle und die
	  Zieladresse den gif-Schnittstellen zuzuweisen. Eine
	  Konfiguration, die die selbe Adressfamilie für innere und
	  äußere IP-Header (v4 in v4, oder v6 in v6) benutzt, ist
	  gefährlich. Es ist sehr leicht, Schnittstellen und
	  Routing-Tabellen so zu konfigurieren, dass eine unendliche
	  Ebene von Tunneln ausgeführt wird. <span class="emphasis"><em>Seien Sie
	  also gewarnt</em></span>.</p><p>gif kann ECN-freundlich konfiguriert werden. Beachte
	  <a class="link" href="#ipsec-ecn" title="8.1.4.5. ECN-Betrachtung von IPsec-Tunneln">23.5.4.5</a> für eine
	  ECN-Freundlichkeit von Tunneln und <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gif&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">gif</span>(4)</span></a> wie man sie
	  konfiguriert.</p><p>Falls man einen IPv4-in-IPv6-Tunnel mit einer
	  gif-Schnittstelle konfigurieren möchte, sollte man
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gif&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">gif</span>(4)</span></a> sorgfältig lesen. Man muss die IPv6
	  link-local Adresse, die automatisch der gif-Schnittstelle
	  zugewiesen wird, entfernen.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-sas"></a>8.1.1.6. Source Address Selection</h4></div></div></div><p>Im Moment ist die Regel zur Auswahl der Quelle
	  bereichsorientiert (es gibt einige Ausnahmen - siehe unten).
	  Für ein gegebenes Ziel wird eine Quell-IPv6-Adresse
	  durch folgende Regel ausgewählt:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Falls die Quelladresse explizit durch den Benutzer
	      angegeben ist (z.B. über das erweiterte API), dann
	      wird die angegebene Adresse benutzt.</p></li><li class="listitem"><p>Falls eine Adresse der ausgehenden Schnittstelle
	      zugewiesen wird, die den selben Bereich wie die
	      Zieladresse hat (was normalerweise durch einen Blick in
	      die Routing-Tabelle festgestellt werden kann), dann wird
	      diese Adresse benutzt.</p><p>Dies ist ein typischer Fall.</p></li><li class="listitem"><p>Falls keine Adresse der obigen Bedingung
	      genügt, dann wählt man eine globale Adresse,
	      die einer der Schnittstellen des sendenden Knotens
	      zugewiesen ist.</p></li><li class="listitem"><p>Falls keine Adresse der obigen Bedingung
	      genügt und die Zieladresse ist im site
	      local-Bereich, dann wählt man eine eine site
	      local-Adresse, die einer der Schnittstellen des
	      sendenden Knotens zugewiesen ist.</p></li><li class="listitem"><p>Falls keine Adresse der obigen Bedingung
	      genügt, dann wählt man eine Adresse, die mit
	      einem Eintrag in der Routing-Tabelle für das Ziel
	      verbunden ist. Dies ist die letzte Möglichkeit,
	      die eine Bereichsverletzung verursachen
	      könnte.</p></li></ol></div><p>Zum Beispiel, ::1 ist ausgewählt für
	  ff01::1, fe80:1::200:f8ff:fe01:6317 für
	  fe80:1::2a0:24ff:feab:839b (beachte den eingebetteten
	  Schnittstelleindex - beschrieben in <a class="link" href="#ipv6-scope-index" title="8.1.1.3. Bereichsindex">23.5.1.3</a> - er hilft uns,
	  die richtige Quelladresse auszuwählen. Diese
	  eingebetteten Indexe werden nicht übertragen). Falls
	  die ausgehende Schnittstelle mehrere Adressen für einen
	  Bereich hat, wird die Quelle gewählt, die die breiteste
	  passende Basis hat (Regel 3). Angenommen
	  2001:0DB8:808:1:200:f8ff:fe01:6317 und
	  2001:0DB8:9:124:200:f8ff:fe01:6317 sind einer ausgehenden
	  Schnittstelle zugewiesen.
	  2001:0DB8:808:1:200:f8ff:fe01:6317 wird als Quelle für
	  das Ziel 2001:0DB8:800::1 ausgewählt.</p><p>Beachte, dass obige Regel nicht in der
	  IPv6-Spezifikation dokumentiert ist. Es wird als "up to
	  implementation"-Punkt betrachtet. Es gibt einige Fälle,
	  bei denen die obige Regel nicht benutzt werden soll. Ein
	  Beispiel ist die verbundene TCP-Sitzung und man benutzt die
	  Adresse, die in tcb als Quelle gehalten wird. Ein anderes
	  Beispiel ist die Quelladresse für Neighbor
	  Advertisement. Laut Spezifikation (RFC2461 7.2.2) sollte
	  die Quelle des NA die Zieladresse des korrespondierenden
	  Ziel des NS sein. In diesem Fall folgen wir eher der
	  Spezifikation, als der obigen longest-match-Regel.</p><p>Für neue Verbindungen werden (wenn Regel eins
	  nicht zutrifft) abgelehnte Adressen (Adressen mit
	  bevorzugter Lebenszeit = 0) nicht ausgewählt, wenn
	  andere Auswahlmöglichkeiten bestehen. Wenn keine
	  anderen Auswahlmöglichkeiten bestehen, werden
	  abgelehnte Adressen als letzte Möglichkeit benutzt.
	  Falls mehrere Auswahlmöglichkeiten für abgelehnte
	  Adressen bestehen, dann wird ogige Regel verwendet, um aus
	  diesen abgelehnten Adressen auszuwählen. Falls man aus
	  bestimmten Gründen die Benutzung abgelehnter Adressen
	  unterbinden möchte, dann setzt man
	  net.inet6.ip6.use_deprecated auf 0. Der Punkt
	  bezüglich der abgelehnten Adressen ist in RFC2462 5.5.4
	  beschrieben (Beachte: Im Moment wird in der IETF ipngwg
	  darüber debatiert, wie angelehnte Adressen benutzt
	  werden sollen).</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-jumbo"></a>8.1.1.7. Jumbo Payload</h4></div></div></div><p>Die Jumbo-Payload hop-by-hop-Option ist implementiert
	  und kann benutzt werden, um IPv6-Pakete mit Datenpaketen
	  größer als 65.535 Oktette. Aber im Moment wird
	  keine physikalische Schnittstelle unterstützt, deren MTU
	  größer ist als 65.536, so dass diese Datenpakete
	  nur bei den loopback-Schnittstellen zu finden sind (z.B.
	  lo0).</p><p>Falls man die Jumbo Payloads testen möchte, muss
	  man zunächst den Kernel rekonfigurieren, so dass die
	  MTU der loopback-Schnittstelle grösser 65.535 Bytes
	  sein kann. Füge folgende Zeile zur Kernel-Konfiguration
	  hinzu:</p><p><code class="literal">
	  options		"LARGE_LOMTU"		#Um Jumbo Payload zu testen
	  </code></p><p>und dann kompiliere den Kernel neu.</p><p>Dann kann man die Jumbo-Payloads mittels
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ping6&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ping6</span>(8)</span></a>-Kommando mit den Optionen -b und -s testen.
	  Die Option -b muss angegeben werden, um die Größe
	  des Socket-Puffers zu erhön, und die Option -s gibt die
	  Größe des Pakets an, die größer als
	  65.535 sein sollte. Beispielsweise gibt man folgendes
	  ein:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ping6 -b 70000 -s 68000 ::1</code></strong></pre><p>Die IPv6-Spezifikation verlangt, dass die
	  Jumbo-Payload-Option nicht in einem Paket verwendet werden
	  darf, das einen fragmentierten Header hat. Falls diese
	  Bedingung nicht zutrifft, dann muss eine
	  ICMPv6-Parameter-Problem-Nachricht an den Absender
	  geschickt werden. Die Spezifikation ist befolgt, aber man
	  kann normalerweise nicht einen ICMPv6-Fehler sehen, der
	  durch diese Forderung hervorgerufen wird.</p><p>Wenn ein IPv6-Paket empfangen wird, dann wird die
	  Rahmenlänge geprüft und sie wird mit der
	  Größe verglichen, die im Datenfeld für die
	  Paketgröße des IPv6-Headers oder im Wert für
	  die Jumbo-Payload-Option angegeben ist, sofern vorhanden.
	  Falls ersterer kleiner als letzterer ist, dann wird das
	  Paket abgelehnt und die Statistiken werden erhöht. Man
	  kann die Statistik als Ausgabe des <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=netstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">netstat</span>(8)</span></a>-Kommandos
	  mit der `-s -p ip6'-Option sehen:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>netstat -s -p ip6</code></strong>
	  ip6:
		(snip)
		1 with data size &lt; data length</pre><p>So, der Kernel sendet keinen ICMPv6-Fehler,
	  außer das fehlerhafte Paket ist ein aktuelles
	  Jumbo-Payload, dessen Paketgröße
	  größer als 65,535 Bytes ist. Wie oben
	  beschrieben, gibt es momentan keine physikalische
	  Schnittstelle, die eine so riesige MTU unterstützt,
	  daher gibt es so selten einen ICMPv6-Fehler.</p><p>TCP/UDP over Jumbogramm wird im Moment nicht
	  unterstützt. Dies kommt daher, weil wir kein Medium
	  (außer loopback) haben, dies zu testen. Melden Sie
	  sich, falls Sie es benötigen.</p><p>IPsec funktioniert nicht mit Jumbogramm. Dies ist
	  bedingt durch einige Änderungen an der Spezifikation,
	  welche die Unterstützung von AH mit Jumbogramm
	  betrifft (AH-Header-Größe beeinflusst die
	  Länge des Datenpakets und das macht es richtig
	  schwierig, ein eingehendes Paket mit Jumbo-Payload-Option so
	  gut zu authentifizieren wie ein AH).</p><p>Es gibt grundlegende Punkte in der
	  *BSD-Unterstützung für Jumbogramms. Wir
	  würden jene gerne ansprechen, aber wir benötigen
	  mehr Zeit diese fertig zu stellen. Um ein paar zu
	  benennen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>mbuf pkthdr.len-Feld ist in 4.4BSD typisiert als
	      "int", so dass es kein Jumbogramm mit len &gt; 2G bei
	      32Bit-Architekturen aufnehmen kann. Wenn wir
	      Jumbogramme geeignet unterstützen wollten, dann
	      muss das Feld erweitert werden, damit es 4G +
	      IPv6-Header + link-layer-Header aufnehmen kann. Deshalb
	      muss es schließlich auf int64_t (u_int32_t ist
	      NICHT genug) erweitert werden.</p></li><li class="listitem"><p>Irrigerweise benutzen wir "int" an vielen Stellen,
	      um die Paketlänge aufzunehmen. Wir müssen sie
	      in einen größeren ganzzahligen Typ
	      konvertieren. Es braucht große Vorsicht, weil wir
	      sonst einen Überlauf während der Berechnung
	      der Paketlänge erleben können.</p></li><li class="listitem"><p>Irrigerweise prüfen wir das ip6_plen-Feld des
	      IPv6-Header für packet payload length an
	      verschiedenen Stellen. Wir sollten mbuf pkthdr.len
	      stattdessen prüfen. ip6_input() wird bei der
	      Eingabe eine Prüfung der Jumbo -Payload-Option
	      durchführen und wir können danach mbuf
	      pkthdr.len sicher benutzen.</p></li><li class="listitem"><p>Natürlich braucht der TCP-Kode an einigen
	      Stellen eine sorgfältige Aktualisierung.</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66570704"></a>8.1.1.8. Verhindern von Schleifen beim Verarbeiten von
	  Headern</h4></div></div></div><p>Die IPv6-Spezifikation erlaubt eine willkürliche
	  Zahl von Erweiterungs-Headern, die in einem Paket platziert
	  werden können. Wenn wir IPv6-Kode für die
	  Paketverarbeitung auf die Art und Weise implementieren wie
	  wir es beim BSD-IPv4-Kode geschehen ist, dann würde
	  wegen einer lange Kette von Funktionsaufrufen der
	  Kernel-Stack überlaufen. sys/netinet6-Kode ist
	  behutsam entwickelt wurden, um einen Überlauf des
	  Kernel-Stacks zu verhindern. Deswegen definiert der
	  sys/netinet6-Kode seine eigene Protocol-Switch-Struktur
	  "struct ip6protosw" (siehe auch
	  <code class="filename">netinet6/ip6protosw.h</code>). Aus
	  Gründen der Kompatibilität gibt es keine solche
	  Aktualisierung im IPv4-Teil (sys/netinet), aber eine kleine
	  Änderung ist zum pr_input()-Prototyp hinzugefügt
	  worden. So ist "struct ipprotosw" ebenso definiert.
	  Deswegen kann der Kernel-Stack sich aufblähen, wenn man
	  ein IPsec-over-IPv4-Paket mit einer massiven Zahl von
	  IPSec-Header empfängt. IPsec-over-IPv6 ist in Ordnung.
	  (Natürlich muss für all diese zu verarbeitenden
	  IPSec-Header jeder einzelne IPSec-Header jede
	  IPSec-Prüfung durchlaufen. So wird es einem anonymen
	  Angreifer unmöglich gemacht eine Attacke
	  durchzuführen.)</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="icmpv6"></a>8.1.1.9. ICMPv6</h4></div></div></div><p>Nachdem RFC2463 veröffentlicht worden war, hat
	  die IETF-ipngwg beschlossen ICMPv6-Fehler-Pakete gegen
	  ICMPv6 umzuleiten, um einen ICMPv6-Sturm auf einem
	  Netzwerkmedium zu unterbinden. Dies ist bereits im Kernel
	  implementiert.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66581840"></a>8.1.1.10. Anwendungen</h4></div></div></div><p>Für Programmierung des Userland unterstützen
	  wir das IPv6-Socket-API wie es in RFC2553, RFC2292 und in
	  aufkommenden Internet-Konzepten beschrieben ist.</p><p>TCP/UDP über IPv6 ist verfügbar und ziemlich
	  stabil. Man kann sich an <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=telnet&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">telnet</span>(1)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ftp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ftp</span>(1)</span></a>,
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rlogin&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rlogin</span>(1)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rsh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rsh</span>(1)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a>, usw. erfreuen.
	  Diese Anwendungen sind unabhängig vom Protokoll. Das
	  liegt daran, weil diese Programme automatisch IPv4 oder IPv6
	  entsprechend des DNS auswählen.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66587216"></a>8.1.1.11. Kernel Interna</h4></div></div></div><p>Während ip_forward() ip_output() aufruft, ruft
	  ip6_forward() direkt if_output() auf, da Router IPv6-Pakete
	  nicht in Fragmente teilen dürfen.</p><p>ICMPv6 sollte das original Paket so lang wie
	  möglich bis maximal 1280 halten. UDP6/IP6 port
	  unreach, zum Beispiel, sollte alle Erweiterungs-Header und
	  die unveränderten UDP6- und IP6-Header enthalten. Um
	  das originale Paket zu erhalten, konvertieren alle
	  IP6-Funktionen außer TCP niemals Network-Byte-Order in
	  Host-Byte-Order.</p><p>tcp_input(), udp6_input() und icmp6_input()
	  können nicht voraussetzen, dass der IP6-Header vor dem
	  Transport-Header, der zum Extension-Header gehört,
	  kommt. Deshalb wurde in6_cksum() implementiert, um Pakete,
	  deren IP6-Header und Transport-Header nicht fortlaufend ist,
	  zu behandeln. Weder TCP/IP6- noch
	  UDP6/IP6-Header-Strukturen existieren, um eine Prüsumme
	  zu bilden.</p><p>Um IP6-Header, Extension-Header und Transport-Headers
	  leichter verarbeiten zu können, werden nun
	  Netzwerktreiber benötigt, die Pakete in einem internen
	  mbuf oder in einem oder mehreren externen mbuf speichern
	  können. Ein typischer alter Treiber legt zwei interne
	  mbuf für 96 - 204 Bytes an Daten an, wie auch immer
	  wird ein solches Paket jetzt in einem externen mbuf
	  gespeichert.</p><p><code class="command">netstat -s -p ip6</code> ermittelt, ob der
	  Treiber sich nach solchen Erfordernissen richtet, oder
	  nicht. Im folgenden Beispiel verletzt "cce0" dies
	  Erfordernisse (Für weitere Informationen, siehe
	  Abschnitt 2.).</p><pre class="screen">Mbuf statistics:
                317 one mbuf
                two or more mbuf::
                        lo0 = 8
			cce0 = 10
                3282 one ext mbuf
                0 two or more ext mbuf</pre><p>Jede Eingabefunktion ruft IP6_EXTHDR_CHECK am Anfang
	  auf, um zu prüfen, ob der Bereich zwischen IP6 und
	  seinen Header durchgehend ist. IP6_EXTHDR_CHECK ruft
	  m_pullup() nur dann auf, wenn mbuf das M_LOOP-Flag gestzt
	  hat, weil das Paket von der Loopback-Schnittstelle kommt.
	  m_pullup() wird niemals aufgerufen, wenn Pakete von
	  physikalischen Netzwerkschnittstellen kommen.</p><p>IP- und IP6-Reassemble-Funktionen rufen niemals
	  m_pullup() auf.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-wildcard-socket"></a>8.1.1.12. IPv4-Mapped-Address und IPv6-Wildcard-Socket</h4></div></div></div><p>RFC2553 beschreibt IPv4-Mapped-Address (3.7) und die
	  spezielle Verhaltensweise des IPv6-Wildcard-Bind-Socket
	  (3.8). Die Spezifikation gestattet es:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>IPv4-Verbindungen von AF_INET6-Wildcard-Bind-Socket
	      zu erlauben.</p></li><li class="listitem"><p>IPv4-Pakete über AF_INET6-Socket zu
	      transportieren, indem eine spezielle Form der Adresse
	      wie ::ffff:10.1.1.1 benutzt wird.</p></li></ul></div><p>Aber die Spezifikation ist sehr kompliziert und
	  spezifiziert nicht, wie der Socket-Layer sich verhalten
	  soll. Darauf Bezug nehmend nennen wir hier ersteren
	  "hörende Seite" und letzteren "beginnende
	  Seite".</p><p>Man kann einen Wildcard-Bind auf demselben Port bei
	  beiden Adressfamilien durchführen.</p><p>Die folgende Tabelle zeigt das Verhalten von FreeBSD
	  4.x.</p><pre class="screen">Hörende Seite          Beginnende Seite
                (AF_INET6-Wildcard-      (Verbindung zu ::ffff:10.1.1.1)
                Socket erreicht IPv4 Verb.)
                ---                     ---
FreeBSD 4.x     Konfigurierbar            unterstützt
                Standard: erlaubt</pre><p>Die folgende Abschnitte zeigen mehr Details und wie
	  man das Verhalten konfigurieren kann.</p><p>Kommentare auf der hörenden Seite:</p><p>Es sieht so aus, dass RFC2553 zu wenig zu den Punkten
	  über Wildcard-Bind erläutert, speziell zum
	  Punkt über Port-Space, Fehler-Modus und Beziehung
	  zwischen AF_INET/INET6 wildcard bind. Es kann mehrere
	  unterschiedliche Interpretationen zu diesem RFC geben, die
	  sich nach diesen richten, aber sich unterschiedlich
	  verhalten. Um eine portable Anwendung zu implementieren,
	  sollte man deshalb nicht ein bestimmtes Verhalten des
	  Kernels voraussetzen. Der Einsatz von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a>
	  ist der sicherste Weg. Port number space und wildcard bind
	  issues wurden Mitte Mai 1999 detailliert in der
	  Ipv6imp-Mailing-Liste diskutiert und es sieht so aus, als ob
	  es keinen konkreten Konsens gab (means, up to implementers).
	  Vielleicht sollte man die Archive der Mailing-Liste
	  prüfen.</p><p>Wenn eine Server-Anwendung IPv4- und IPv6-Verbindungen
	  annehmen möchte, dann gibt es zwei Alternativen.</p><p>Eine benutzt AF_INET- und AF_INET6-Socket (man
	  benötigt zwei Sockets). Benutze <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a>
	  mit gesetztem AI_PASSIVE-Bit in ai_flags, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=socket&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">socket</span>(2)</span></a> und
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bind&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">bind</span>(2)</span></a> für alle zurückgegebenen Adressen.
	  Mit dem öffnen mehrerer Sockets kann man Verbindungen
	  an dem Socket mit der richtigen Adressfamilie annehmen.
	  IPv4-Verbindungen werden vom AF_INET-Socket und
	  IPv6-Verbindungen vom AF_INET6-Socket angenommen.</p><p>Ein anderer Weg ist einen AF_INET6 wildcard
	  bind-Socket zu verwenden. Man benutzt <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a>
	  mit AI_PASSIVE in ai_flags, mit AF_INET6 in ai_family, man
	  setzt das erste Argument hostname auf NULL, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=socket&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">socket</span>(2)</span></a>
	  und <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bind&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">bind</span>(2)</span></a> auf die zurückgegebene Adresse (es
	  sollte eine unspezifizierte IPv6-Adresse sein). Man kann
	  IPv4- und IPv6-Paket über diesen Socket
	  annehmen.</p><p>Um nur IPv6-Datenverkehr portabel an AF_INET6 wildcard
	  gebundenen Socket zu unterstützen, prüft man,
	  sobald die Verbindung Zustande gekommen ist, immer die
	  Peer-Adresse gegen den hörenden AF_INET6-Socket. Wenn
	  die Adresse eine IPv4-Mapped-Adresse ist, dann sollte man
	  die Verbindung zurückweisen. Man kann die Bedingung
	  mit dem IN6_IS_ADDR_V4MAPPED()-Makro prüfen.</p><p>Um diesen Punkt leichter lösen zu können,
	  gibt es für <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=setsockopt&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">setsockopt</span>(2)</span></a> die System
	  abhängige Option IPV6_BINDV6ONLY, die wie folgt benutzt
	  wird.</p><pre class="screen">	int on;

	setsockopt(s, IPPROTO_IPV6, IPV6_BINDV6ONLY,
		   (char *)&amp;on, sizeof (on)) &lt; 0));</pre><p>Wenn der Aufruf erfolgreich ist, dann empfängt
	  dieser Socket nur IPv6-Pakete.</p><p>Kommentare zur sendenden Seite:</p><p>Ratschlag an Anwendungsentwickler: um eine portable
	  IPv6-Anwendung zu implementieren (die mit verschiedenen
	  IPv6-Kerneln funktioniert), ist das Folgende der
	  Schlüssel zum Erfolg wie wir glauben:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>NIEMALS AF_INET oder AF_INET6 hart kodieren.</p></li><li class="listitem"><p>Benutze <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> und
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getnameinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getnameinfo</span>(3)</span></a> überall im System. Benutze
	      niemals gethostby*(), getaddrby*(), inet_*() oder
	      getipnodeby*() (Um bestehende Applikationen leicht IPv6
	      fähig zu machen, wird getipnodeby*() manchmal
	      nützlich sein. Falss es aber möglich sein
	      sollte, versuche den Kode neu zu schreiben und
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> und <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getnameinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getnameinfo</span>(3)</span></a> zu
	      benutzen)</p></li><li class="listitem"><p>Wenn man sich an ein Ziel verbinden möchte,
	      benutze <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> und versuche alle
	      zurückgegebenen Ziele, wie <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=telnet&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">telnet</span>(1)</span></a> es
	      macht.</p></li><li class="listitem"><p>Einige IPv6-Stacks sind mit fehlerhafter
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> verschickt worden. Man verschickt
	      als letzte Möglichkeit eine minimal arbeitende
	      Version der Anwendung.</p></li></ul></div><p>Wenn man einen AF_INET6-Socket für jeweils eine
	  ausgehende IPv4- und IPv6-Verbingung benutzen möchte,
	  dann muss man <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getipnodebyname&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getipnodebyname</span>(3)</span></a> benutzen. Wenn man
	  seine existierende Anwendung mit wenig Aufwand
	  IPv6-fähig machen möchte, dann sollte dieser
	  Versuch gewählt werden. Aber beachte bitte, dass dies
	  eine temporäre Lösung ist, weil
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getipnodebyname&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getipnodebyname</span>(3)</span></a> selber noch zu empfehlen ist, da es
	  noch keine Adressbereiche verarbeitet. Für eine
	  IPv6-NAmensauflösung ist <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> das
	  bevorzugte API. Deshalb sollte man seine Anwendung so
	  umschreiben, dass <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> benutzt wird, wann man
	  Zeit dazu hat.</p><p>Wenn man Anwendungen schreibt, die ausgehende
	  Verbindungen herstellen, wird die Geschichte viel einfacher,
	  wenn man AF_INET und AF_INET6 als total getrennte
	  Adressfamilien behandelt. {set,get}sockopt funktioniert
	  viel einfacher, DNS-Angelegenheiten werden einfacher
	  gemacht. Wir empfehlen sich nicht auf IPv4-Mapped-Adressen
	  zu verlassen.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66628304"></a>8.1.1.12.1. Einheitlicher TCP-und INPCB-Kode</h5></div></div></div><p>FreeBSD 4.x benutzt shared TCP-Kode zwischen IPv4
	    und IPv6 (von sys/netinet/tcp*) und separaten udp4/6-Kode.
	    Es benutzt eine vereinheitlichte inpcb-Struktur.</p><p>Die Plattform kann für eine Unterstützung
	    von IPv4-mapped-Adressen konfiguriert werden. Die
	    Kernel-Konfiguration läßt sich wie folgt
	    zusammenfassen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>By default, AF_INET6 socket will grab IPv4
		connections in certain condition, and can initiate
		connection to IPv4 destination embedded in IPv4 mapped
		IPv6 address.</p></li><li class="listitem"><p>Man kann es wie unten beschrieben
		abschalten.</p><p><code class="command">sysctl
		net.inet6.ip6.mapped_addr=0</code></p></li></ul></div><div class="sect5"><div xmlns="" class="titlepage"><div><div><h6 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66636368"></a>8.1.1.12.1.1. Hörende Seite</h6></div></div></div><p>Jeder Socket kann für eine Unterstützung
	      eines speziellen AF_INET6 wildcard bind
	      (Standardmäßig eingeschaltet) konfiguriert
	      werden. Man kann es auf Socket-Basis mit
	      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=setsockopt&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">setsockopt</span>(2)</span></a> wie unten beschrieben
	      abschalten.</p><pre class="screen">	int on;

	setsockopt(s, IPPROTO_IPV6, IPV6_BINDV6ONLY,
		   (char *)&amp;on, sizeof (on)) &lt; 0));</pre><p>Wildcard-AF_INET6-Socket schnappt sich die
	      IPv4-Verbindung, wenn, und nur wenn folgende Bedingungen
	      erfüllt sind::</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Es gibt keinen AF_INET-Socket, der zu einer
		  IPv4-Verbindung passt</p></li><li class="listitem"><p>Der AF_INET6-Socket ist so konfiguriert, dass er
		  IPv4-Datenverkehr akzeptiert, z.B. gibt
		  getsockopt(IPV6_BINDV6ONLY) 0 zurück.</p></li></ul></div><p>Es gibt kein Problem mit der
	      Öffnen/Schließen-Reihenfolge.</p></div><div class="sect5"><div xmlns="" class="titlepage"><div><div><h6 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66641360"></a>8.1.1.12.1.2. initiating side</h6></div></div></div><p>FreeBSD 4.x unterstützt ausgehende
	      Verbindungen zu IPv4 mapped Adressen (::ffff:10.1.1.1),
	      falls der Knoten so konfiguriert ist, dass er IPv4
	      mapped Adressen unterstützt.</p></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66642896"></a>8.1.1.13. sockaddr_storage</h4></div></div></div><p>Als RFC2553 kurz vor der Vollendung stand, gab es eine
	  Diskussion, wie struct sockaddr_storage Mitglieder benannt
	  werden sollten. Ein Vorschlag war "__" den Mitgliedern (wie
	  "__ss_len") voranzustellen und es sollten sie nicht
	  verändert werden. Der andere Vorschlag war, nichts
	  voranzustellen (wie "ss_len") also mußten wir solche
	  Mitglieder direkt verändern. Es gab keinen klaren
	  Konsens.</p><p>Als Ergebnis definiert RFC2553 die Struktur
	  sockaddr_storage wie folgt:</p><pre class="screen">	struct sockaddr_storage {
		u_char	__ss_len;	/* address length */
		u_char	__ss_family;	/* address family */
		/* and bunch of padding */
	};</pre><p>Im Gegensatz dazu definiert der XNET-Entwurf die
	  Struktur wie folgt:</p><pre class="screen">	struct sockaddr_storage {
		u_char	ss_len;		/* address length */
		u_char	ss_family;	/* address family */
		/* and bunch of padding */
	};</pre><p>Im Dezember 1999 kam man überein, dass RFC2553bis
	  letztere Definition (XNET) aufnehmen sollte.</p><p>Die aktuelle Implementierung ist konform zur
	  XNET-Definition basierend auf der RFC2553bis
	  Diskussion.</p><p>Wenn man mehrere IPv6-Implementierungen betrachtet, wird
	  man beide Definitionen sehen. Für Userland-Programmierer
	  ist der folgende Weg der meist portable um damit
	  umzugehen:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Man versichert sich, dass ss_family und/oder
	      ss_len für die Plattform verfügbar sind, indem
	      man GNU autoconf verwendet,</p></li><li class="listitem"><p>Man benutzet -Dss_family=__ss_family um alle
	      Vorkommen (einschließlich der Header-Files) zu
	      __ss_family zu vereinheitlichen, oder</p></li><li class="listitem"><p>Man benutzt niemals __ss_family. Man führe
	      einen Typecast nach sockaddr * durch und verwendet
	      sa_family wie folgt:</p><pre class="screen">	struct sockaddr_storage ss;
	family = ((struct sockaddr *)&amp;ss)-&gt;sa_family</pre></li></ol></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66650064"></a>8.1.2. Netzwerktreiber</h3></div></div></div><p>Die beiden folgenden Dinge müssen zwingend von
	Standardtreibern unterstützt werden:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Mbuf-Clustering-Erfordernis. In diesem stabilen
	    Release haben wir für alle Betriebssystem MINCLSIZE
	    in MHLEN+1 geändert, damit sich alle Treiber wie
	    erwartet verhalten.</p></li><li class="listitem"><p>Multicast. Falls <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ifmcstat&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ifmcstat</span>(8)</span></a> keine
	    Multicast-Gruppe für die Schnittstelle liefert, dann muss
	    diese Schnittstelle überarbeitet werden.</p></li></ol></div><p>Falls keiner der Treiber die Erfordernisse erfüllt,
	dann können die Treiber nicht für
	IPv6/IPSec-Kommunikation verwendet werden. Falls man ein
	Problem beim Einsatz von IPv6/IPSec mit seiner Karte hat, dann
	melde es bitte bei <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-bugs" target="_top">FreeBSD problem reports</a>.</p><p>(Beachte: In der Vergangenheit haben wir gefordert, dass
	alle PCMCIA-Treiber einen Aufruf nach in6_ifattach() haben.
	Inzwischen haben wir keine solche Forderung mehr)</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66655312"></a>8.1.3. Translator</h3></div></div></div><p>Wir kategorisieren einen IPv4/IPv6-Translator in 4
	Typen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="emphasis"><em>Translator A</em></span> --- Er wird im
	    frühen Stadium des Übergangs benutzt um es zu
	    ermöglichen, dass eine Verbindung von einem IPv6-Host
	    auf einer IPv6-Insel zu einem IPv4-Host im IPv4-Ozean
	    hergestellt wird.</p></li><li class="listitem"><p><span class="emphasis"><em>Translator B</em></span> --- Er wird im
	    frühen Stadium des Übergangs benutzt um es zu
	    ermöglichen, dass eine Verbindung von einem IPv4-Host
	    im IPv4-Ozean zu einem IPv6-Host auf einer IPv6-Insel
	    hergestellt wird.</p></li><li class="listitem"><p><span class="emphasis"><em>Translator C</em></span> --- Er wird im
	    frühen Stadium des Übergangs benutzt um es zu
	    ermöglichen, dass eine Verbindung von einem IPv4-Host
	    auf einer IPv4-Insel zu einem IPv6-Host im IPv6-Ozean
	    hergestellt wird.</p></li><li class="listitem"><p><span class="emphasis"><em>Translator D</em></span> --- Er wird im
	    frühen Stadium des Übergangs benutzt um es zu
	    ermöglichen, dass eine Verbindung von einem IPv6-Host
	    im IPv6-Ozean zu einem IPv4-Host auf einer IPv4-Insel
	    hergestellt wird.</p></li></ul></div><p>Ein TCP-Relay-Translator der Kategorie A wird
	unterstützt. Er wird "FAITH" genannt. Wir stellen
	ebenso einen IP-Header-Translator der Kataegorie A zur
	Verfügung (Letzterer ist noch nicht in FreeBSD 4.x
	übernommen).</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66661328"></a>8.1.3.1. FAITH TCP-Relay-Translator</h4></div></div></div><p>Das FAITH-System benutzt mit Hilfe des Kernels den
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=faithd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">faithd</span>(8)</span></a> genannten TCP-Relay-Daemon. FAITH wird einen
	  IPv6-Adress-Präfix reservieren und eine
	  TCP-Verbindungen an diesen Präfix zum IPv4-Ziel
	  weiterleiten.</p><p>Wenn beispielsweise der IPv6-Präfix
	  2001:0DB8:0200:ffff:: ist und das IPv6-Ziel für
	  TCP-Verbindungen 2001:0DB8:0200:ffff::163.221.202.12 ist,
	  dann wird die Verbindung an das IPv4-Ziel 163.221.202.12
	  weitergeleitet.</p><pre class="screen">	IPv4-Ziel-Knoten (163.221.202.12)
	  ^
	  | IPv4 tcp toward 163.221.202.12
	FAITH-relay dual stack node
	  ^
	  | IPv6 TCP toward 2001:0DB8:0200:ffff::163.221.202.12
	source IPv6 node</pre><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=faithd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">faithd</span>(8)</span></a> muss auf FAITH-relay dual stack node
	  aufgerufen werden.</p><p>Für weitere Details siehe
	  <code class="filename">src/usr.sbin/faithd/README</code></p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipsec-implementation"></a>8.1.4. IPsec</h3></div></div></div><p>IPsec besteht hauptsächlich aus drei
	Komponenten.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Policy Management</p></li><li class="listitem"><p>Key Management</p></li><li class="listitem"><p>AH und ESP Behandlung</p></li></ol></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66677968"></a>8.1.4.1. Regel Management</h4></div></div></div><p>Im Kernel ist experimenteller Kode für
	  Regel-Management implementiert. Es gibt zwei Wege eine
	  Sicherheitsregel zu handhaben. Einer ist eine Regel
	  für jeden Socket mithilfe von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=setsockopt&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">setsockopt</span>(2)</span></a> zu
	  konfigurieren. Für diesen Fall ist die Konfiguration
	  der Regel in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ipsec_set_policy&amp;sektion=3"><span class="citerefentry"><span class="refentrytitle">ipsec_set_policy</span>(3)</span></a> beschrieben. Der
	  andere Weg ist eine auf einem Kernel-Packet-Filter
	  basierende Regel mithilfe der PF_KEY-Schnittstelle mittels
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=setkey&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">setkey</span>(8)</span></a> zu konfigurieren.</p><p>Der Regeleintrag mit seinen Indices wird nicht
	  sortiert, so dass es sehr wichtig ist, wann ein Eintrag
	  hinzugefügt wird.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66681808"></a>8.1.4.2. Key Management</h4></div></div></div><p>Der in dieser Bibliothek (sys/netkey) implementierte
	  Kode für das key management ist eine Eigenentwicklung
	  der PFKEYv2-Implementierung.
	  Er ist konform zu RFC2367.</p><p>Die Eigenentwicklung des IKE-Daemons "racoon" ist in
	  der Bibliothek (kame/kame/racoon) implementiert.
	  Grundsätzlich muss man racoon als Dämonprozess
	  laufen lassen, dann setzt man eine Regel auf, die
	  Schlüssel erwartet (ähnlich wie <code class="command">ping -P
	  'out ipsec esp/transport//use'</code>). Der Kernel wird
	  den racoon-Dämon wegen des notwendigen Austauschs der
	  Schlüssel kontaktieren.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66683856"></a>8.1.4.3. AH- und ESP-Handhabung</h4></div></div></div><p>Das IPsec-Modul ist als "hook" in die
	  Standard-IPv4/IPv6-Verarbeitung implementiert. Sobald ein
	  Paket gesendet wird, prüft ip{,6_output(), ob eine
	  ESP/AH-Verarbeitung notwendig ist. Es findet eine
	  Überprüfung statt, ob eine passende SPD (Security
	  Policy Database) gefunden wurde. Wenn ESP/AH benötigt
	  wird, dann wird {esp,ah}{4,6}_output() aufgerufen und mbuf
	  wird folglich aktualisiert. Wenn ein Paket empfangen wird,
	  dann wird {esp,ah}4_input() basierend auf der Protokollnummer
	  aufgerufen, z.B. (*inetsw[proto])(). {esp,ah}4_input()
	  entschlüsselt/prüft die Authentizität des
	  Pakets und entfernt den daisy-chained-Header und das Padding
	  des ESP/AH. Es ist sicherer den ESP/AH-Header beim Empfang
	  zu entfernen, weil man das empfangene Paket niemals so wie
	  es ist benutzt.</p><p>Mit der Verwendung von ESP/AH wird die effektive
	  TCP4/6-Datensegmentgröße durch weitere von ESP/AH
	  eingefügte Daisy-chained-Headers beeinflußt.
	  Unser Kode berücksichtigt dies.</p><p>Grundlegende Crypto-Funktionen sind im Verzeichnis
	  "sys/crypto" zu finden. ESP/AH-Umformungen sind zusammen mit
	  den Wrapper-Funktionen in {esp,ah}_core.c gelistet. Wenn
	  man einige Algorithmen hinzufügen möchte, dann
	  fügt man in {esp,ah}_core.c eine Wrapper-Funktion hinzu
	  und trägt seinen Crypto-Algorithmus in sys/crypto
	  ein.</p><p>Der Tunnel-Modus wird in diesem Release teilweise mit
	  den folgenden Restriktionen unterstützt:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Der IPsec-Tunnel ist nicht mit der generischen
	      Tunnelschnittstelle kombiniert. Man muss sehr
	      vorsichtig sein, weil man sonst eine Endlosschleife
	      zwischen ip_output() und tunnelifp-&gt;if_output()
	      aufbaut. Die Meinungen gehen auseinander, ob es besser
	      ist dies zu vereinheitlichen, oder nicht.</p></li><li class="listitem"><p>Die Betrachtung von MTU und des "Don't
	      Fragment"-Bits (IPv4) müssen mehr geprüft
	      werden, aber grundsätzlichen arbeiten sie
	      gut.</p></li><li class="listitem"><p>Das Authentifizierungsmodel für einen
	      AH-Tunnel muss überarbeitet werden. Man muss
	      eventuell die "policy management engine"
	      überarbeiten.</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66688848"></a>8.1.4.4. Konformität zu RFCs und IDs</h4></div></div></div><p>Der IPsec-Kode im Kernel ist konform (oder versucht
	  konform zu sein) zu den folgenden Standards:</p><p>Die "alte IPsec"-Spezifikation, die in
	  <code class="filename">rfc182[5-9].txt</code> dokumentiert ist</p><p>Die "neue IPsec"-Spezifikation, die
	  <code class="filename">rfc240[1-6].txt</code>,
	  <code class="filename">rfc241[01].txt</code>,
	  <code class="filename">rfc2451.txt</code> und
	  <code class="filename">draft-mcdonald-simple-ipsec-api-01.txt</code>
	  (Der Entwurf ist erloschen, aber man kann ihn sich von
	  <a class="link" href="ftp://ftp.kame.net/pub/internet-drafts/" target="_top">
	  ftp://ftp.kame.net/pub/internet -drafts/</a> holen)
	  dokumentiert ist (Beachte: Die IKE-Spezifikationen
	  <code class="filename">rfc241[7-9].txt</code> sind im Userland als
	  "racoon"-IKE-Daemon implementiert).</p><p>Aktuell werden folgende Algorithmen
	  unterstützt:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>altes IPsec-AH</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>null crypto Prüfsumme (Kein Dokument, nur
		  für Debug-Zwecke)</p></li><li class="listitem"><p>keyed MD5 mit 128bit crypto Prüfsumme
		  (<code class="filename">rfc1828.txt</code>)</p></li><li class="listitem"><p>keyed SHA1 mit 128bit crypto Prüfsumme
		  (kein Document)</p></li><li class="listitem"><p>HMAC MD5 mit 128bit crypto Prüfsumme
		  (<code class="filename">rfc2085.txt</code>)</p></li><li class="listitem"><p>HMAC SHA1 mit 128bit crypto Prüfsumme (kein
		  Dokument)</p></li></ul></div></li><li class="listitem"><p>altes IPsec-ESP</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>null encryption (kein Dokument, ähnlich zu
		  <code class="filename">rfc2410.txt</code>)</p></li><li class="listitem"><p>DES-CBC-Modus
		  (<code class="filename">rfc1829.txt</code>)</p></li></ul></div></li><li class="listitem"><p>neues IPsec-AH</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>null crypto Prüfsumme (kein Dokument, nur
		  für Debug-Zwecke)</p></li><li class="listitem"><p>keyed MD5 mit 96bit crypto Prüfsumme (kein
		  Dokument)</p></li><li class="listitem"><p>keyed SHA1 mit 96bit crypto Prüfsumme (kein
		  Dokument)</p></li><li class="listitem"><p>HMAC MD5 mit 96bit crypto Prüfsumme
		  (<code class="filename">rfc2403.txt</code>)</p></li><li class="listitem"><p>HMAC SHA1 mit 96bit crypto Prüfsumme
		  (<code class="filename">rfc2404.txt</code>)</p></li></ul></div></li><li class="listitem"><p>neues IPsec-ESP</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>null encryption
		  (<code class="filename">rfc2410.txt</code>)</p></li><li class="listitem"><p>DES-CBC mit abgeleiteter IV
		  (<code class="filename">draft-ietf-ipsec-ciph-des-derived-01.txt</code>,
		  Entwurf abgelaufen)</p></li><li class="listitem"><p>DES-CBC mit expliziter IV
		  (<code class="filename">rfc2405.txt</code>)</p></li><li class="listitem"><p>3DES-CBC mit expliziter IV
		  (<code class="filename">rfc2451.txt</code>)</p></li><li class="listitem"><p>BLOWFISH CBC
		  (<code class="filename">rfc2451.txt</code>)</p></li><li class="listitem"><p>CAST128 CBC
		  (<code class="filename">rfc2451.txt</code>)</p></li><li class="listitem"><p>RC5 CBC
		  (<code class="filename">rfc2451.txt</code>)</p></li><li class="listitem"><p>Jeder Algorithmus kann kombiniert werden
		  mit:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><p>ESP-Beglaubigung mit HMAC-MD5(96bit)</p></li><li class="listitem"><p>ESP-Beglaubigung mit HMAC-SHA1(96bit)</p></li></ul></div></li></ul></div></li></ul></div><p>Die folgenden Algorithmen werden NICHT
	  unterstützt:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>altes IPsec-AH</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>HMAC MD5 mit 128bit crypto Prüfsumme +
		  64bit replay prevention
		  (<code class="filename">rfc2085.txt</code>)</p></li><li class="listitem"><p>keyed SHA1 mit 160bit crypto Prüfsumme +
		  32bit padding
		  (<code class="filename">rfc1852.txt</code>)</p></li></ul></div></li></ul></div><p>IPsec (im Kernel) und IKE (im Userland als "racoon")
	  wurden bei unterschiedlichen Interoperabilitätstests
	  geprüft und es ist bekannt, dass es mit vielen anderen
	  Implementierungen gut zusammenarbeitet. Außerdem
	  wurde die IPsec-Implementierung sowie die breite Abdeckung
	  mit IPsec-Crypto-Algorithmen, die in den RFCs dokumentiert
	  sind, geprüft (es werden nur Algorithmen ohne
	  intellektuelle Besitzansprüche behandelt).</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipsec-ecn"></a>8.1.4.5. ECN-Betrachtung von IPsec-Tunneln</h4></div></div></div><p>ECN-freundliche IPsec-Tunnel werden unterstützt wie
	  es in <code class="filename">draft-ipsec-ecn-00.txt</code>
	  beschrieben ist.</p><p>Normale IPsec-Tunnel sind in RFC2401 beschrieben.
	  Für eine Kapselung wird das IPv4-TOS-Feld (oder das
	  IPv6-Traffic-Class-Feld) vom inneren in den
	  äußeren IP-Header kopiert. Für eine
	  Entkapselung wird der ässere IP-Header einfach
	  verworfen. Die Entkapselungsregel ist nicht mit ECN
	  kompatibel, sobald das ECN-Bit im äußeren
	  IP-TOS/Traffic-Class-Feld verloren geht.</p><p>Um einen IPsec-Tunnel ECN-freundlich zu machen, sollte
	  man die Kapselungs- und Entkapselungsprozeduren
	  modifizieren. Dies ist in <a class="link" href="http://www.aciri.org/floyd/papers/draft-ipsec-ecn-00.txt" target="_top">
	  http://www.aciri.org/floyd/papers/draft-ipsec-ecn-00.txt</a>,
	  Kapitel 3, beschrieben.</p><p>Die IPsec-Tunnel-Implementierung kann drei
	  Zustände annehmen, indem man net.inet.ipsec.ecn (oder
	  net.inet6.ipsec6.ecn) auf diese Werte setzt:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>RFC2401: Keine Betrachtung von ECN (Sysctl-Wert
	      -1)</p></li><li class="listitem"><p>ECN verboten (Sysctl-Wert 0)</p></li><li class="listitem"><p>ECN erlaubt (Sysctl-Wert 1)</p></li></ul></div><p>Beachte, dass dieses Verhalten per-node konfigurierbar
	  ist und nicht per-SA (draft-ipsec-ecn-00 möchte per-SA
	  Konfiguration).</p><p>Das Verhalten ist wie folgt zusammengefaßt (man
	  beachte auch den Quelltext für weitere
	  Details):</p><pre class="screen">                encapsulate                     decapsulate
                ---                             ---
RFC2401         kopiere alle TOS-Bits               lösche TOS-Bits im äußeren
                von innen nach außen.            (benutze innere TOS-Bits so wie sie sind)

ECN verboten   kopiere TOS-Bits außer für ECN    lösche TOS-Bits im äußeren
                (maskiert mit 0xfc) von innen   (benutze innere TOS-Bits so wie sie sind)
                nach außen.  Setze ECN-Bits auf 0.

ECN erlaubt     kopiere TOS-Bits außer für ECN    benutze innere TOS-Bits mit einigen Änderungen.
                CE (maskiert mit 0xfe) von      Wenn das äußere ECN-CE-Bit 1 ist,
                innen nach außen.                 setze das ECN-CE-Bit im
                Setze ECN-CE-Bit auf 0.            Inneren.</pre><p>Allgemeine Strategie zur Konfiguration:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Wenn beide IPsec-Tunnel-Endpunkte ein
	      ECN-freundliches Verhalten beherrschen, dann sollte man
	      besser beide Endpunkte auf <span class="quote">&#8222;<span class="quote">ECN allowed</span>&#8220;</span>
	      (Sysctl-Wert 1) setzen.</p></li><li class="listitem"><p>Wenn das andere Ende das TOS-Bit sehr strikt
	      handhabt, dann benutzt man "RFC2401" (Sysctl-Wert
	      -1).</p></li><li class="listitem"><p>in den anderen Fällen benutzt man "ECN
	      verboten" (Sysctl-Wert 0).</p></li></ul></div><p>Der Standard ist "ECN verboten" (Sysctl-Wert 0).</p><p>Für weitere Informationen siehe auch:</p><p><a class="link" href="http://www.aciri.org/floyd/papers/draft-ipsec-ecn-00.txt" target="_top">
	  http://www.aciri.org/floyd/papers/draft-ipsec-ecn-00.txt</a>,
	  RFC2481 (Explicit Congestion Notification),
	  src/sys/netinet6/{ah,esp}_input.c</p><p>(Dank gebührt Kenjiro Cho
	  <code class="email">&lt;<a xmlns="" class="email" href="mailto:kjc@csl.sony.co.jp">kjc@csl.sony.co.jp</a>&gt;</code> für seine detailliert
	  Analyse)</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp66793552"></a>8.1.4.6. Interoperabilität</h4></div></div></div><p>Hier sind einige Plattformen angegeben, die in der
	  Vergangenheit die IPsec/IKE-Interoperabilität mit dem
	  KAME-Kode getestet haben. Beachte, dass beide Enden
	  vielleicht ihre Implementierung verändert haben,
	  deshalb sollte man folgende Liste nur für
	  Referenzzwecke benutzen.</p><p>Altiga, Ashley-laurent (vpcom.com), Data Fellows
	  (F-Secure), Ericsson ACC, FreeS/WAN, HITACHI, IBM <span class="trademark">AIX</span>®,
	  IIJ, Intel, <span class="trademark">Microsoft</span>® <span class="trademark">Windows NT</span>®, NIST (linux IPsec +
	  plutoplus), Netscreen, OpenBSD, RedCreek, Routerware, SSH,
	  Secure Computing, Soliton, Toshiba, VPNet, Yamaha
	  RT100i</p></div></div></div></div></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kernel"></a>Teil III. Kernel</h1></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="chapter"><a href="#kernelbuild">9. Einen FreeBSD-Kernel bauen und installieren</a></span></dt><dd><dl><dt><span class="sect1"><a href="#kernelbuild-traditional">9.1. Einen Kernel auf die <span class="quote">&#8222;<span class="quote">traditionelle</span>&#8220;</span> Art und
      Weise bauen</a></span></dt><dt><span class="sect1"><a href="#kernelbuild-new">9.2. Einen Kernel auf die <span class="quote">&#8222;<span class="quote">neue</span>&#8220;</span> Art und Weise
      bauen</a></span></dt></dl></dd><dt><span class="chapter"><a href="#kerneldebug">10. Kernel-Fehlersuche</a></span></dt><dd><dl><dt><span class="sect1"><a href="#kerneldebug-obtain">10.1. Besorgen eines Speicherauszugs nach einem
      Kernel-Absturz (Kernel-Crash-Dump)</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-gdb">10.2. Fehlersuche in einem Speicherauszug nach einem
      Kernel-Absturz mit <code class="command">kgdb</code></a></span></dt><dt><span class="sect1"><a href="#kerneldebug-ddd">10.3. Fehlersuche in einem Speicherauszug nach einem Absturz mit
      DDD</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-ddb">10.4. Online-Kernel-Fehlersuche mit DDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-gdb">10.5. Online-Kernel-Fehlersuche mit GDB auf einem entfernten
      System</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-console">10.6. Fehlersuche bei einem Konsolen-Treiber</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-deadlocks">10.7. Fehlersuche bei Deadlocks</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-options">10.8. Glossar der Kernel-Optionen zur Fehlersuche</a></span></dt></dl></dd></dl></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kernelbuild"></a>Kapitel 9. Einen FreeBSD-Kernel bauen und installieren</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Johann</span> <span class="surname">Kois</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#kernelbuild-traditional">9.1. Einen Kernel auf die <span class="quote">&#8222;<span class="quote">traditionelle</span>&#8220;</span> Art und
      Weise bauen</a></span></dt><dt><span class="sect1"><a href="#kernelbuild-new">9.2. Einen Kernel auf die <span class="quote">&#8222;<span class="quote">neue</span>&#8220;</span> Art und Weise
      bauen</a></span></dt></dl></div><p>Ein Kernelentwickler muss wissen, wie der Bau eines angepassten
    Kernels funktioniert, da das Debuggen des FreeBSD-Kernels nur durch den
    Bau eines neuen Kernels möglich ist. Es gibt zwei Wege, einen
    angepassten Kernel zu bauen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Den <span class="quote">&#8222;<span class="quote">traditionellen</span>&#8220;</span> Weg</p></li><li class="listitem"><p>Den <span class="quote">&#8222;<span class="quote">neuen</span>&#8220;</span> Weg</p></li></ul></div><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Die folgenden Ausführungen setzen voraus, dass Sie
      den Abschnitt <a class="link" href="../handbook/kernelconfig-building.html" target="_top">
      Erstellen und Installation eines angepassten Kernels</a> des
      FreeBSD-Handbuchs gelesen haben und daher wissen, wie man einen
      FreeBSD-Kernel baut.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kernelbuild-traditional"></a>9.1. Einen Kernel auf die <span class="quote">&#8222;<span class="quote">traditionelle</span>&#8220;</span> Art und
      Weise bauen</h2></div></div></div><p>Bis FreeBSD 4.X wurde dieser Weg zum Bau eines angepassten
      Kernels empfohlen. Sie können Ihren Kernel nach wie vor
      auf diese Art und Weise bauen (anstatt das Target
      <span class="quote">&#8222;<span class="quote">buildkernel</span>&#8220;</span> der Makefiles im Verzeichnis
      <code class="filename">/usr/src/</code> zu verwenden).
      Dies kann beispielsweise sinnvoll sein, wenn Sie am
      Kernel-Quellcode arbeiten. Haben Sie nur ein oder zwei Optionen
      der Kernelkonfigurationsdatei geändert, ist dieser Weg in
      der Regel schneller als der <span class="quote">&#8222;<span class="quote">neue</span>&#8220;</span> Weg.
      Andererseits kann es aber auch zu unerwarteten Fehlern beim
      Bau des Kernels kommen, wenn Sie Ihren Kernel unter aktuellen
      FreeBSD-Versionen auf diese Art und Weise bauen.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Erzeugen Sie den Kernel-Quellcode mit
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=config&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">config</span>(8)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/usr/sbin/config MYKERNEL</code></strong></pre></li><li class="step"><p>Wechseln Sie in das Build-Verzeichnis. <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=config&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">config</span>(8)</span></a>
	  gibt den Namen dieses Verzeichnisses aus, wenn die Erzeugung
	  des Kernel-Quellcodes im vorherigen Schritt erfolgreich
	  abgeschlossen wurde.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd ../compile/MYKERNEL</code></strong></pre></li><li class="step"><p>Kompilieren Sie den neuen Kernel:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make depend</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make</code></strong></pre></li><li class="step"><p>Installieren Sie den neuen Kernel:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make install</code></strong></pre></li></ol></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kernelbuild-new"></a>9.2. Einen Kernel auf die <span class="quote">&#8222;<span class="quote">neue</span>&#8220;</span> Art und Weise
      bauen</h2></div></div></div><p>Dieser Weg wird für alle aktuellen FreeBSD-Versionen
      empfohlen. Lesen Sie bitte den Abschnitt <a class="link" href="../handbook/kernelconfig-building.html" target="_top">Erstellen und
      Installation eines angepassten Kernels</a> des
      FreeBSD-Handbuchs, wenn Sie Ihren Kernel auf diese Art und Weise
      bauen wollen.</p></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kerneldebug"></a>Kapitel 10. Kernel-Fehlersuche</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Paul</span> <span class="surname">Richards</span></span>, <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jörg</span> <span class="surname">Wunsch</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Robert</span> <span class="surname">Watson</span></span>. </span></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Fabian</span> <span class="surname">Ruch</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#kerneldebug-obtain">10.1. Besorgen eines Speicherauszugs nach einem
      Kernel-Absturz (Kernel-Crash-Dump)</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-gdb">10.2. Fehlersuche in einem Speicherauszug nach einem
      Kernel-Absturz mit <code class="command">kgdb</code></a></span></dt><dt><span class="sect1"><a href="#kerneldebug-ddd">10.3. Fehlersuche in einem Speicherauszug nach einem Absturz mit
      DDD</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-ddb">10.4. Online-Kernel-Fehlersuche mit DDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-gdb">10.5. Online-Kernel-Fehlersuche mit GDB auf einem entfernten
      System</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-console">10.6. Fehlersuche bei einem Konsolen-Treiber</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-deadlocks">10.7. Fehlersuche bei Deadlocks</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-options">10.8. Glossar der Kernel-Optionen zur Fehlersuche</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-obtain"></a>10.1. Besorgen eines Speicherauszugs nach einem
      Kernel-Absturz (Kernel-Crash-Dump)</h2></div></div></div><p>Wenn ein Entwicklungs-Kernel (z.B. FreeBSD-CURRENT) wie zum
      Beispiel ein Kernel unter Extrembedingungen (z.B. sehr hohe
      Belastungsraten (Load), eine äußerst hohe Anzahl an
      gleichzeitigen Benutzern, Hunderte <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a>s usw.)
      eingesetzt oder eine neue Funktion oder ein neuer
      Gerätetreiber in FreeBSD-STABLE verwendet wird (z.B.
      <acronym class="acronym">PAE</acronym>), tritt manchmal eine Kernel-Panic ein.
      In einem solchen Fall zeigt dieses Kapitel, wie dem Absturz
      nützliche Informationen entnommen werden
      können.</p><p>Bei Kernel-Panics ist ein Neustart unvermeidlich. Nachdem
      ein System neu gestartet wurde, ist der Inhalt des
      physikalischen Speichers (<acronym class="acronym">RAM</acronym>), genauso wie
      jedes Bit, das sich vor der Panic auf dem Swap-Gerät
      befand, verloren. Um die Bits im physikalischen Speicher zu
      erhalten, zieht der Kernel Nutzen aus dem Swap-Gerät als
      vorübergehenden Ablageort, wo die Bits, welche sich im RAM
      befinden, auch nach einem Neustart nach einem Absturz
      verfügbar sind. Durch diese Vorgehensweise kann ein
      Kernel-Abbild, wenn FreeBSD nach einem Absturz startet, abgezogen
      und mit der Fehlersuche begonnen werden.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Ein Swap-Gerät, das als Ausgabegerät
	(Dump-Device) konfiguriert wurde, verhält sich immer noch
	wie ein Swap-Gerät. Die Ausgabe auf
	Nicht-Swap-Geräte (wie zum Beispiel Bänder oder
	CDRWs) wird zur Zeit nicht unterstützt. Ein
	<span class="quote">&#8222;<span class="quote">Swap-Gerät</span>&#8220;</span> ist gleichbedeutend mit einer
	<span class="quote">&#8222;<span class="quote">Swap-Partition</span>&#8220;</span>.</p></div><p>Es stehen verschiedene Arten von Speicherabzügen zur
      Verfügung: komplette Speicherabzüge (full memory dumps), welche
      den gesamten Inhalt des physischen Speichers beinhalten, Miniauszüge
      (minidumps), die nur die gerade verwendeten Speicherseiten des Kernels
      enthalten (FreeBSD 6.2 und höhere Versionen) und Textauszüge
      (textdumps), welche geskriptete oder Debugger-Ausgaben enthalten
      (FreeBSD 7.1 und höher).  Miniauszüge sind der Standardtyp
      der Abzüge seit FreeBSD 7.0 und fangen in den meisten Fällen
      alle nötigen Informationen ein, die in einem kompletten
      Kernel-Speicherabzug enthalten sind, da die meisten Probleme nur durch
      den Zustand des Kernels isoliert werden können.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="config-dumpdev"></a>10.1.1. Konfigurieren des Ausgabegeräts</h3></div></div></div><p>Bevor der Kernel den Inhalt seines physikalischen
	Speichers auf einem Ausgabegerät ablegt, muss ein solches
	konfiguriert werden. Ein Ausgabegerät wird durch Benutzen
	des <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a>-Befehls festgelegt, um dem Kernel
	mitzuteilen, wohin die Speicherauszüge bei einem
	Kernel-Absturz gesichert werden sollen. Das
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a>-Programm muss aufgerufen werden, nachdem die
	Swap-Partition mit <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=swapon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">swapon</span>(8)</span></a> konfiguriert wurde. Dies
	wird normalerweise durch Setzen der
	<code class="varname">dumpdev</code>-Variable in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> auf den
	Pfad des Swap-Geräts (der empfohlene Weg, um einen
	Kernel-Speicherauszug zu entnehmen) bewerkstelligt, oder über
	<code class="literal">AUTO</code>, um die erste konfigurierte Swap-Partition
	zu verwenden. In HEAD ist die Standardeinstellung für
        <code class="varname">dumpdev</code> <code class="filename">AUTO</code> und
        änderte sich in den RELENG_*-Zweigen (mit Ausnahme von
        RELENG_7, bei dem <code class="literal">AUTO</code> beibehalten wurde) auf
        <code class="literal">NO</code>.  In FreeBSD 9.0-RELEASE und späteren
        Versionen fragt <span class="application">bsdinstall</span>, ob
        Speicherauszüge für das Zielsystem während des
        Installationsvorgangs aktiviert werden sollen.</p><div xmlns="" class="tip"><h3 class="admontitle">Tipp: </h3><p xmlns="http://www.w3.org/1999/xhtml">Vergleichen Sie <code class="filename">/etc/fstab</code> oder
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=swapinfo&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">swapinfo</span>(8)</span></a> für eine Liste der
	  Swap-Geräte.</p></div><div xmlns="" class="important"><h3 class="admontitle">Wichtig: </h3><p xmlns="http://www.w3.org/1999/xhtml">Stellen Sie sicher, dass das in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>
	  festgelegte <code class="varname">dumpdir</code> vor einem
	  Kernel-Absturz vorhanden ist.</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /var/crash</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chmod 700 /var/crash</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">Denken Sie auch daran, dass der Inhalt von
	  <code class="filename">/var/crash</code> heikel ist und sehr
	  wahrscheinlich vertrauliche Informationen wie
	  Passwörter enthält.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="extract-dump"></a>10.1.2. Entnehmen eines Kernel-Speicherauszugs
	(Kernel-Dump)</h3></div></div></div><p>Sobald ein Speicherauszug auf ein Ausgabegerät
	geschrieben wurde, muss er entnommen werden, bevor das
	Swap-Gerät eingehängt wird. Um einen Speicherauszug
	aus einem Ausgabegerät zu entnehmen, benutzen Sie das
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a>-Programm. Falls <code class="varname">dumpdev</code> in
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> gesetzt wurde, wird <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a>
	automatisch beim ersten Start in den Multiuser-Modus nach dem
	Absturz und vor dem Einhängen des Swap-Geräts
	aufgerufen. Der Speicherort des entnommenen Kernels ist im
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>-Wert <code class="varname">dumpdir</code>,
	standardmäßig <code class="filename">/var/crash</code>,
	festgelegt und der Dateiname wird
	<code class="filename">vmcore.0</code> sein.</p><p>In dem Fall, dass bereits eine Datei mit dem Namen
	<code class="filename">vmcore.0</code> in
	<code class="filename">/var/crash</code> (oder auf was auch immer
	<code class="varname">dumpdir</code> gesetzt ist) vorhanden ist,
	erhöht der Kernel die angehängte Zahl bei jedem
	Absturz um eins und verhindert damit, dass ein vorhandener
	<code class="filename">vmcore</code> (z.B.
	<code class="filename">vmcore.1</code>) überschrieben wird.
	Während der Fehlersuche, möchten Sie höchst
	wahrscheinlich den <code class="filename">vmcore</code> mit der
	höchsten Version in <code class="filename">/var/crash</code>
	benutzen, wenn Sie den passenden <code class="filename">vmcore</code>
	suchen.</p><div xmlns="" class="tip"><h3 class="admontitle">Tipp: </h3><p xmlns="http://www.w3.org/1999/xhtml">Falls Sie einen neuen Kernel testen, aber einen anderen
	  starten müssen, um Ihr System wieder in Gang zu
	  bringen, starten Sie es nur in den Singleuser-Modus, indem
	  Sie das <code class="option">-s</code>-Flag an der
	  Boot-Eingabeaufforderung benutzen, und nehmen dann folgende
	  Schritte vor:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fsck -p</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -a -t ufs</code></strong>       # make sure /var/crash is writable
<code class="prompt">#</code> <strong class="userinput"><code>savecore /var/crash /dev/ad0s1b</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>                  # exit to multi-user</pre><p xmlns="http://www.w3.org/1999/xhtml">Dies weist <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> an, einen
	  Kernel-Speicherauszug aus <code class="filename">/dev/ad0s1b</code>
	  zu entnehmen und den Inhalt in
	  <code class="filename">/var/crash</code> abzulegen. Vergessen Sie
	  nicht sicherzustellen, dass das Zielverzeichnis
	  <code class="filename">/var/crash</code> genug freien Speicherplatz
	  für den Speicherauszug zur Verfügung hat.
	  Vergessen Sie auch nicht, den korrekten Pfad des
	  Swap-Geräts anzugeben, da es sehr wahrscheinlich anders
	  als <code class="filename">/dev/ad0s1b</code> lautet!</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-gdb"></a>10.2. Fehlersuche in einem Speicherauszug nach einem
      Kernel-Absturz mit <code class="command">kgdb</code></h2></div></div></div><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Dieser Abschnitt deckt <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> ab, wie es in FreeBSD 5.3
	und später zu finden ist. In früheren Versionen muss
	<code class="command">gdb -k</code> benutzt werden, um einen
	Kernspeicherauszug auszulesen.</p></div><p>Sobald ein Speicherauszug zur Verfügung steht, ist es
      recht einfach nützliche Informationen für einfache
      Probleme daraus zu bekommen. Bevor Sie sich auf die Interna von
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> stürzen, um die Fehler im Kernspeicherauszug
      zu suchen und zu beheben, machen Sie die Debug-Version Ihres
      Kernels (normalerweise <code class="filename">kernel.debug</code>
      genannt) und den Pfad der Quelldateien, die zum Bau Ihres
      Kernels verwendet wurden (normalerweise
      <code class="filename">/usr/obj/usr/src/sys/KERNCONF</code>,
      wobei <code class="filename">KERNCONF</code>
      das in einer Kernel-<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=config&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">config</span>(5)</span></a> festgelegte
      <code class="varname">ident</code> ist), ausfindig. Mit diesen beiden
      Informationen kann die Fehlersuche beginnen.</p><p>Um in den Debugger zu gelangen und mit dem
      Informationserhalt aus dem Speicherauszug zu beginnen, sind
      zumindest folgende Schritte nötig:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/obj/usr/src/sys/KERNCONF</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>kgdb kernel.debug /var/crash/vmcore.0</code></strong></pre><p>Sie können Fehler im Speicherauszug nach dem Absturz
      suchen, indem Sie die Kernel-Quellen benutzen, genauso wie Sie
      es bei jedem anderen Programm können.</p><p>Dieser erste Speicherauszug ist aus einem 5.2-BETA-Kernel
      und der Absturz ist tief im Kernel begründet. Die Ausgabe
      unten wurde dahingehend bearbeitet, dass sie nun Zeilennummern
      auf der linken Seite einschließt. Diese erste
      Ablaufverfolgung (Trace) untersucht den Befehlszeiger
      (Instruction-Pointer) und beschafft eine Zurückverfolgung
      (Back-Trace). Die Adresse, die in Zeile 41 für den
      <code class="command">list</code>-Befehl benutzt wird, ist der
      Befehlszeiger und kann in Zeile 17 gefunden werden. Die meisten
      Entwickler wollen zumindest dies zugesendet bekommen, falls Sie
      das Problem nicht selber untersuchen und beheben können.
      Falls Sie jedoch das Problem lösen, stellen Sie sicher,
      dass Ihr Patch seinen Weg in den Quellbaum mittels eines
      Fehlerberichts, den Mailinglisten oder ihres Privilegs, zu
      committen, findet!</p><pre class="screen"> 1:<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/obj/usr/src/sys/KERNCONF</code></strong>
 2:<code class="prompt">#</code> <strong class="userinput"><code>kgdb kernel.debug /var/crash/vmcore.0</code></strong>
 3:GNU gdb 5.2.1 (FreeBSD)
 4:Copyright 2002 Free Software Foundation, Inc.
 5:GDB is free software, covered by the GNU General Public License, and you are
 6:welcome to change it and/or distribute copies of it under certain conditions.
 7:Type "show copying" to see the conditions.
 8:There is absolutely no warranty for GDB.  Type "show warranty" for details.
 9:This GDB was configured as "i386-undermydesk-freebsd"...
10:panic: page fault
11:panic messages:
12:---
13:Fatal trap 12: page fault while in kernel mode
14:cpuid = 0; apic id = 00
15:fault virtual address   = 0x300
16:fault code:             = supervisor read, page not present
17:instruction pointer     = 0x8:0xc0713860
18:stack pointer           = 0x10:0xdc1d0b70
19:frame pointer           = 0x10:0xdc1d0b7c
20:code segment            = base 0x0, limit 0xfffff, type 0x1b
21:                        = DPL 0, pres 1, def32 1, gran 1
22:processor eflags        = resume, IOPL = 0
23:current process         = 14394 (uname)
24:trap number             = 12
25:panic: page fault
26      cpuid = 0;
27:Stack backtrace:
28
29:syncing disks, buffers remaining... 2199 2199 panic: mi_switch: switch in a critical section
30:cpuid = 0;
31:Uptime: 2h43m19s
32:Dumping 255 MB
33: 16 32 48 64 80 96 112 128 144 160 176 192 208 224 240
34:---
35:Reading symbols from /boot/kernel/snd_maestro3.ko...done.
36:Loaded symbols for /boot/kernel/snd_maestro3.ko
37:Reading symbols from /boot/kernel/snd_pcm.ko...done.
38:Loaded symbols for /boot/kernel/snd_pcm.ko
39:#0  doadump () at /usr/src/sys/kern/kern_shutdown.c:240
40:240             dumping++;
41:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>list *0xc0713860</code></strong>
42:0xc0713860 is in lapic_ipi_wait (/usr/src/sys/i386/i386/local_apic.c:663).
43:658                     incr = 0;
44:659                     delay = 1;
45:660             } else
46:661                     incr = 1;
47:662             for (x = 0; x &lt; delay; x += incr) {
48:663                     if ((lapic-&gt;icr_lo &amp; APIC_DELSTAT_MASK) == APIC_DELSTAT_IDLE)
49:664                             return (1);
50:665                     ia32_pause();
51:666             }
52:667             return (0);
53:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>backtrace</code></strong>
54:#0  doadump () at /usr/src/sys/kern/kern_shutdown.c:240
55:#1  0xc055fd9b in boot (howto=260) at /usr/src/sys/kern/kern_shutdown.c:372
56:#2  0xc056019d in panic () at /usr/src/sys/kern/kern_shutdown.c:550
57:#3  0xc0567ef5 in mi_switch () at /usr/src/sys/kern/kern_synch.c:470
58:#4  0xc055fa87 in boot (howto=256) at /usr/src/sys/kern/kern_shutdown.c:312
59:#5  0xc056019d in panic () at /usr/src/sys/kern/kern_shutdown.c:550
60:#6  0xc0720c66 in trap_fatal (frame=0xdc1d0b30, eva=0)
61:    at /usr/src/sys/i386/i386/trap.c:821
62:#7  0xc07202b3 in trap (frame=
63:      {tf_fs = -1065484264, tf_es = -1065484272, tf_ds = -1065484272, tf_edi = 1, tf_esi = 0, tf_ebp = -602076292, tf_isp = -602076324, tf_ebx = 0, tf_edx = 0, tf_ecx = 1000000, tf_eax = 243, tf_trapno = 12, tf_err = 0, tf_eip = -1066321824, tf_cs = 8, tf_eflags = 65671, tf_esp = 243, tf_ss = 0})
64:    at /usr/src/sys/i386/i386/trap.c:250
65:#8  0xc070c9f8 in calltrap () at {standard input}:94
66:#9  0xc07139f3 in lapic_ipi_vectored (vector=0, dest=0)
67:    at /usr/src/sys/i386/i386/local_apic.c:733
68:#10 0xc0718b23 in ipi_selected (cpus=1, ipi=1)
69:    at /usr/src/sys/i386/i386/mp_machdep.c:1115
70:#11 0xc057473e in kseq_notify (ke=0xcc05e360, cpu=0)
71:    at /usr/src/sys/kern/sched_ule.c:520
72:#12 0xc0575cad in sched_add (td=0xcbcf5c80)
73:    at /usr/src/sys/kern/sched_ule.c:1366
74:#13 0xc05666c6 in setrunqueue (td=0xcc05e360)
75:    at /usr/src/sys/kern/kern_switch.c:422
76:#14 0xc05752f4 in sched_wakeup (td=0xcbcf5c80)
77:    at /usr/src/sys/kern/sched_ule.c:999
78:#15 0xc056816c in setrunnable (td=0xcbcf5c80)
79:    at /usr/src/sys/kern/kern_synch.c:570
80:#16 0xc0567d53 in wakeup (ident=0xcbcf5c80)
81:    at /usr/src/sys/kern/kern_synch.c:411
82:#17 0xc05490a8 in exit1 (td=0xcbcf5b40, rv=0)
83:    at /usr/src/sys/kern/kern_exit.c:509
84:#18 0xc0548011 in sys_exit () at /usr/src/sys/kern/kern_exit.c:102
85:#19 0xc0720fd0 in syscall (frame=
86:      {tf_fs = 47, tf_es = 47, tf_ds = 47, tf_edi = 0, tf_esi = -1, tf_ebp = -1077940712, tf_isp = -602075788, tf_ebx = 672411944, tf_edx = 10, tf_ecx = 672411600, tf_eax = 1, tf_trapno = 12, tf_err = 2, tf_eip = 671899563, tf_cs = 31, tf_eflags = 642, tf_esp = -1077940740, tf_ss = 47})
87:    at /usr/src/sys/i386/i386/trap.c:1010
88:#20 0xc070ca4d in Xint0x80_syscall () at {standard input}:136
89:---Can't read userspace from dump, or kernel process---
90:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>quit</code></strong></pre><p>Diese nächste Ablaufverfolgung ist ein älterer
      Speicherauszug aus FreeBSD 2-Zeiten, aber ist komplizierter und
      zeigt mehr der <code class="command">gdb</code>-Funktionen. Lange Zeilen
      wurden gefaltet, um die Lesbarkeit zu verbessern, und die Zeilen
      wurden zur Verweisung nummeriert. Trotzdem ist es eine reale
      Fehlerverfolgung (Error-Trace), die während der Entwicklung
      des pcvt-Konsolentreibers entstanden ist.</p><pre class="screen"> 1:Script started on Fri Dec 30 23:15:22 1994
 2:<code class="prompt">#</code> <strong class="userinput"><code>cd /sys/compile/URIAH</code></strong>
 3:<code class="prompt">#</code> <strong class="userinput"><code>gdb -k kernel /var/crash/vmcore.1</code></strong>
 4:Reading symbol data from /usr/src/sys/compile/URIAH/kernel
...done.
 5:IdlePTD 1f3000
 6:panic: because you said to!
 7:current pcb at 1e3f70
 8:Reading in symbols for ../../i386/i386/machdep.c...done.
 9:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>backtrace</code></strong>
10:#0  boot (arghowto=256) (../../i386/i386/machdep.c line 767)
11:#1  0xf0115159 in panic ()
12:#2  0xf01955bd in diediedie () (../../i386/i386/machdep.c line 698)
13:#3  0xf010185e in db_fncall ()
14:#4  0xf0101586 in db_command (-266509132, -266509516, -267381073)
15:#5  0xf0101711 in db_command_loop ()
16:#6  0xf01040a0 in db_trap ()
17:#7  0xf0192976 in kdb_trap (12, 0, -272630436, -266743723)
18:#8  0xf019d2eb in trap_fatal (...)
19:#9  0xf019ce60 in trap_pfault (...)
20:#10 0xf019cb2f in trap (...)
21:#11 0xf01932a1 in exception:calltrap ()
22:#12 0xf0191503 in cnopen (...)
23:#13 0xf0132c34 in spec_open ()
24:#14 0xf012d014 in vn_open ()
25:#15 0xf012a183 in open ()
26:#16 0xf019d4eb in syscall (...)
27:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>up 10</code></strong>
28:Reading in symbols for ../../i386/i386/trap.c...done.
29:#10 0xf019cb2f in trap (frame={tf_es = -260440048, tf_ds = 16, tf_\
30:edi = 3072, tf_esi = -266445372, tf_ebp = -272630356, tf_isp = -27\
31:2630396, tf_ebx = -266427884, tf_edx = 12, tf_ecx = -266427884, tf\
32:_eax = 64772224, tf_trapno = 12, tf_err = -272695296, tf_eip = -26\
33:6672343, tf_cs = -266469368, tf_eflags = 66066, tf_esp = 3072, tf_\
34:ss = -266427884}) (../../i386/i386/trap.c line 283)
35:283                             (void) trap_pfault(&amp;frame, FALSE);
36:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>frame frame-&gt;tf_ebp frame-&gt;tf_eip</code></strong>
37:Reading in symbols for ../../i386/isa/pcvt/pcvt_drv.c...done.
38:#0  0xf01ae729 in pcopen (dev=3072, flag=3, mode=8192, p=(struct p\
39:roc *) 0xf07c0c00) (../../i386/isa/pcvt/pcvt_drv.c line 403)
40:403             return ((*linesw[tp-&gt;t_line].l_open)(dev, tp));
41:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>list</code></strong>
42:398
43:399             tp-&gt;t_state |= TS_CARR_ON;
44:400             tp-&gt;t_cflag |= CLOCAL;  /* cannot be a modem (:-) */
45:401
46:402     #if PCVT_NETBSD || (PCVT_FREEBSD &gt;= 200)
47:403             return ((*linesw[tp-&gt;t_line].l_open)(dev, tp));
48:404     #else
49:405             return ((*linesw[tp-&gt;t_line].l_open)(dev, tp, flag));
50:406     #endif /* PCVT_NETBSD || (PCVT_FREEBSD &gt;= 200) */
51:407     }
52:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>print tp</code></strong>
53:Reading in symbols for ../../i386/i386/cons.c...done.
54:$1 = (struct tty *) 0x1bae
55:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>print tp-&gt;t_line</code></strong>
56:$2 = 1767990816
57:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>up</code></strong>
58:#1  0xf0191503 in cnopen (dev=0x00000000, flag=3, mode=8192, p=(st\
59:ruct proc *) 0xf07c0c00) (../../i386/i386/cons.c line 126)
60:       return ((*cdevsw[major(dev)].d_open)(dev, flag, mode, p));
61:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>up</code></strong>
62:#2  0xf0132c34 in spec_open ()
63:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>up</code></strong>
64:#3  0xf012d014 in vn_open ()
65:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>up</code></strong>
66:#4  0xf012a183 in open ()
67:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>up</code></strong>
68:#5  0xf019d4eb in syscall (frame={tf_es = 39, tf_ds = 39, tf_edi =\
69: 2158592, tf_esi = 0, tf_ebp = -272638436, tf_isp = -272629788, tf\
70:_ebx = 7086, tf_edx = 1, tf_ecx = 0, tf_eax = 5, tf_trapno = 582, \
71:tf_err = 582, tf_eip = 75749, tf_cs = 31, tf_eflags = 582, tf_esp \
72:= -272638456, tf_ss = 39}) (../../i386/i386/trap.c line 673)
73:673             error = (*callp-&gt;sy_call)(p, args, rval);
74:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>up</code></strong>
75:Initial frame selected; you cannot go up.
76:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>quit</code></strong></pre><p>Kommentare zum Skript oben:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Zeile 6:</span></dt><dd><p>Dies ist ein Speicherauszug, der innerhalb von DDB
	    genommen wurde (siehe unten), deswegen der Kommentar zur
	    Panic <span class="quote">&#8222;<span class="quote">because you said to!</span>&#8220;</span> und die eher
	    lange Stack-Ablaufverfolgung (Stack-Trace); der
	    anfängliche Grund für das Starten von DDB war
	    jedoch ein Seitenfehler-Trap (Page-Fault-Trap).</p></dd><dt><span class="term">Zeile 20:</span></dt><dd><p>Dies ist die Position der Funktion
	    <code class="function">trap()</code> in der
	    Stack-Ablaufverfolgung.</p></dd><dt><span class="term">Zeile 36:</span></dt><dd><p>Erzwingt die Benutzung eines neuen Stack-Frames; dies
	    ist nicht mehr notwendig. Die Stack-Frames sollen jetzt an
	    die richtige Stelle im Speicher zeigen, selbst im Falle
	    eines Traps. Nach einem Blick auf den Code in Zeile 403
	    ergibt sich mit hoher Wahrscheinlichkeit, dass entweder
	    der Zeigerzugriff auf <span class="quote">&#8222;<span class="quote">tp</span>&#8220;</span> fehlerbehaftet
	    oder der Array-Zugriff unerlaubt war.</p></dd><dt><span class="term">Zeile 52:</span></dt><dd><p>Der Zeiger scheint verdächtig, aber besitzt
	    zufällig eine gültige Adresse.</p></dd><dt><span class="term">Zeile 56:</span></dt><dd><p>Jedoch zeigt er offensichtlich auf nichts und so haben
	    wir unseren Fehler gefunden! (Für diejenigen, die
	    nichts mit diesem speziellen Stück Code anfangen
	    können: <code class="literal">tp-&gt;t_line</code> verweist
	    hier auf das Zeilenverhalten (Line-Discipline) des
	    Konsolen-Geräts, was eine ziemlich kleine Ganzzahl
	    (Integer) sein muss.)</p></dd></dl></div><div xmlns="" class="tip"><h3 class="admontitle">Tipp: </h3><p xmlns="http://www.w3.org/1999/xhtml">Falls Ihr System regelmäßig abstürzt und
	und Sie bald keinen freien Speicherplatz mehr zur
	Verfügung haben, könnte das Löschen alter
	<code class="filename">vmcore</code>-Dateien in
	<code class="filename">/var/core</code> einen beträchtlichen
	Betrag an Speicherplatz einsparen.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-ddd"></a>10.3. Fehlersuche in einem Speicherauszug nach einem Absturz mit
      DDD</h2></div></div></div><p>Die Untersuchung eines Speicherauszugs nach einem
      Kernel-Absturz mit einem grafischen Debugger wie
      <code class="command">ddd</code> ist auch möglich (Sie müssen
      den <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/devel/ddd/pkg-descr">devel/ddd</a>-Port
      installieren, um den <code class="command">ddd</code>-Debugger benutzen zu
      können). Nehmen Sie die <code class="option">-k</code> mit in die
      <code class="command">ddd</code>-Kommandozeile auf, die Sie normalerweise
      benutzen würden. Zum Beispiel:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ddd --debugger kgdb kernel.debug /var/crash/vmcore.0</code></strong></pre><p>Sie sollten nun in der Lage sein, die Untersuchung des
      Speicherauszugs nach dem Absturz unter Benutzung der grafischen
      Schnittstelle von <code class="command">ddd</code> anzugehen.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-online-ddb"></a>10.4. Online-Kernel-Fehlersuche mit DDB</h2></div></div></div><p>Während <code class="command">kgdb</code> als Offline-Debugger
      eine Benutzerschnittstelle auf höchster Ebene bietet, gibt
      es einige Dinge, die es nicht kann. Die wichtigsten sind das
      Setzen von Breakpoints und das Abarbeiten des Kernel-Codes in
      Einzelschritten (Single-Stepping).</p><p>Falls Sie eine systemnahe Fehlersuche an Ihrem Kernel
      vorhaben, steht Ihnen ein Online-Debugger mit dem Namen DDB zur
      Verfügung. Er erlaubt Ihnen das Setzen von Breakpoints, die
      Abarbeitung von Kernel-Funktionen in Einzelschritten, das
      Untersuchen und Verändern von Kernel-Variablen usw. Jedoch
      hat er keinen Zugriff auf Kernel-Quelldateien, sondern kann nur,
      im Gegensatz zu <code class="command">gdb</code>, welches auf die ganzen
      Informationen zur Fehlersuche zurückgreifen kann, auf
      globale und statische Symbole zugreifen.</p><p>Um DDB in Ihren Kernel einzubinden, fügen Sie die
      Optionen

      </p><pre class="programlisting">options KDB</pre><p>
      </p><pre class="programlisting">options DDB</pre><p>

      Ihrer Konfigurationsdatei hinzu und bauen Sie den Kernel neu.
      (Details zur Konfiguration des FreeBSD-Kernels finden Sie im
      <a class="link" href="../../../../doc/de_DE.ISO8859-1/books/handbook/index.html" target="_top">FreeBSD-Handbuch</a>).</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Falls Sie eine ältere Version des Boot-Blocks haben,
	könnte es sein, dass Ihre Symbole zur Fehlersuche noch
	nicht einmal geladen werden. Aktualisieren Sie den Boot-Block;
	aktuelle Versionen laden die DDB-Symbole automatisch.</p></div><p>Sobald Ihr Kernel mit DDB startet, gibt es mehrere Wege, um
      in DDB zu gelangen. Der erste und früheste Weg ist, das
      Boot-Flag <code class="option">-d</code> gleich an der
      Boot-Eingabeaufforderung einzugeben. Der Kernel startet dann in
      den Debug-Modus und betritt DDB noch vor jedweder
      Gerätesuche. Somit können Sie Funktionen zur
      Gerätesuche/-bereitstellung auf Fehler untersuchen.
      FreeBSD-CURRENT-Benutzer müssen die sechste Option im
      Boot-Menü auswählen, um an eine Eingabeaufforderung zu
      gelangen.</p><p>Das zweite Szenario ist der Gang in den Debugger, sobald das
      System schon gestartet ist. Es gibt zwei einfache Wege dies zu
      erreichen. Falls Sie von der Eingabeaufforderung aus in den
      Debugger gelangen möchten, geben Sie einfach folgenden
      Befehl ab:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sysctl debug.kdb.enter=1</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Um eine schnelle Panic zu erzwingen, geben Sie das folgende
        Kommando ein:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sysctl debug.kdb.panic=1</code></strong></pre></div><p>Anderenfalls können Sie ein Tastenkürzel auf der
      Tastatur benutzen, wenn Sie an der Systemkonsole sind. Die
      Voreinstellung für die break-to-debugger-Sequenz ist
      <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>Alt</strong></span>+<span class="keycap"><strong>ESC</strong></span>.
      In syscons kann diese Sequenz auf eine andere Tastenkombination
      gelegt werden (remap) und manche der verfügbaren
      Tastaturlayouts tun dies, stellen Sie also sicher, dass Sie die
      richtige Sequenz kennen, die benutzt werden soll. Für
      serielle Konsolen ist eine Option vorhanden, die die Benutzung
      einer Unterbrechung der seriellen Verbindung (BREAK) auf der
      Kommandozeile erlaubt, um in DDB zu gelangen (<code class="literal">options
      BREAK_TO_DEBUGGER</code> in der Kernel-Konfigurationsdatei).
      Dies ist jedoch nicht der Standard, da viele serielle Adapter in
      Verwendung sind, die grundlos eine BREAK-Bedingung erzeugen, zum
      Beispiel bei Ziehen des Kabels.</p><p>Die dritte Möglichkeit ist, dass jede Panic-Bedingung
      in DDB springt, falls der Kernel hierfür konfiguriert ist.
      Aus diesem Grund ist es nicht sinnvoll einen Kernel mit DDB
      für ein unbeaufsichtigtes System zu konfigurieren.</p><p>Um die unbeaufsichtigte Funktionsweise zu erreichen
      fügen Sie:</p><pre class="programlisting">options	KDB_UNATTENDED</pre><p>der Kernel-Konfigurationsdatei hinzu und bauen/installieren
      Sie den Kernel neu.</p><p>Die DDB-Befehle ähneln grob einigen
      <code class="command">gdb</code>-Befehlen. Das Erste, das Sie vermutlich
      tun müssen, ist einen Breakpoint zu setzen:</p><pre class="screen"><strong class="userinput"><code>break function-name address</code></strong></pre><p>Zahlen werden standardmäßig hexadezimal
      angegeben, aber um sie von Symbolnamen zu unterscheiden, muss
      Zahlen, die mit den Buchstaben <code class="literal">a-f</code> beginnen,
      <code class="literal">0x</code> vorangehen (dies ist für andere
      Zahlen beliebig). Einfache Ausdrücke sind erlaubt, zum
      Beispiel: <code class="literal">function-name + 0x103</code>.</p><p>Um den Debugger zu verlassen und mit der Abarbeitung
      fortzufahren, geben Sie ein:</p><pre class="screen"><strong class="userinput"><code>continue</code></strong></pre><p>Um eine Stack-Ablaufverfolgung zu erhalten, benutzen
      Sie:</p><pre class="screen"><strong class="userinput"><code>trace</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Beachten Sie, dass wenn Sie DDB mittels einer
	Schnelltaste betreten, der Kernel zurzeit einen Interrupt
	bereitstellt, sodass die Stack-Ablaufverfolgung Ihnen nicht
	viel nützen könnte.</p></div><p>Falls Sie einen Breakpoint entfernen möchten, benutzen
      Sie</p><pre class="screen"><strong class="userinput"><code>del</code></strong>
<strong class="userinput"><code>del address-expression</code></strong></pre><p>Die erste Form wird direkt, nachdem ein Breakpoint anschlug,
      angenommen und entfernt den aktuellen Breakpoint. Die zweite
      kann jeden Breakpoint löschen, aber Sie müssen die
      genaue Adresse angeben; diese kann bezogen werden durch:</p><pre class="screen"><strong class="userinput"><code>show b</code></strong></pre><p>oder:</p><pre class="screen"><strong class="userinput"><code>show break</code></strong></pre><p>Um den Kernel in Einzelschritten auszuführen, probieren
      Sie:</p><pre class="screen"><strong class="userinput"><code>s</code></strong></pre><p>Dies springt in Funktionen, aber Sie können DDB
      veranlassen, diese schrittweise zu verfolgen, bis die passende
      Rückkehranweisung (Return-Statement) erreicht ist. Nutzen
      Sie hierzu:</p><pre class="screen"><strong class="userinput"><code>n</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Dies ist nicht das gleiche wie die
	<code class="command">next</code>-Anweisung von <code class="command">gdb</code>;
	es ist wie <code class="command">gdb</code>s <code class="command">finish</code>.
	Mehrmaliges Drücken von <span class="keycap"><strong>n</strong></span> führt zu
	einer Fortsetzung.</p></div><p>Um Daten aus dem Speicher zu untersuchen, benutzen Sie (zum
      Beispiel):

      </p><pre class="screen"><strong class="userinput"><code>x/wx 0xf0133fe0,40</code></strong>
<strong class="userinput"><code>x/hd db_symtab_space</code></strong>
<strong class="userinput"><code>x/bc termbuf,10</code></strong>
<strong class="userinput"><code>x/s stringbuf</code></strong></pre><p>

      für Word/Halfword/Byte-Zugriff und
      Hexadezimal/Dezimal/Character/String-Ausgabe. Die Zahl nach dem
      Komma ist der Objektzähler. Um die nächsten 0x10
      Objekte anzuzeigen benutzen Sie einfach:</p><pre class="screen"><strong class="userinput"><code>x ,10</code></strong></pre><p>Gleichermaßen benutzen Sie

      </p><pre class="screen"><strong class="userinput"><code>x/ia foofunc,10</code></strong></pre><p>

      um die ersten 0x10 Anweisungen aus <code class="function">foofunc</code>
      zu zerlegen (disassemble) und Sie zusammen mit ihrem
      Adressabstand (Offset) vom Anfang von
      <code class="function">foofunc</code> auszugeben.</p><p>Um Speicher zu verändern benutzen Sie den
      Schreibbefehl:</p><pre class="screen"><strong class="userinput"><code>w/b termbuf 0xa 0xb 0</code></strong>
<strong class="userinput"><code>w/w 0xf0010030 0 0</code></strong></pre><p>Die Befehlsoption
      (<code class="literal">b</code>/<code class="literal">h</code>/<code class="literal">w</code>)
      legt die Größe der Daten fest, die geschrieben werden
      sollen, der erste Ausdruck danach ist die Adresse, wohin
      geschrieben werden soll, und der Rest wird als Daten
      verarbeitet, die in aufeinander folgende Speicherstellen
      geschrieben werden.</p><p>Falls Sie die aktuellen Register wissen möchten,
      benutzen Sie:</p><pre class="screen"><strong class="userinput"><code>show reg</code></strong></pre><p>Alternativ können Sie den Inhalt eines einzelnen
      Registers ausgeben mit z.B.

      </p><pre class="screen"><strong class="userinput"><code>p $eax</code></strong></pre><p>

      und ihn bearbeiten mit:</p><pre class="screen"><strong class="userinput"><code>set $eax new-value</code></strong></pre><p>Sollten Sie irgendeine Kernel-Funktion aus DDB heraus
      aufrufen wollen, geben Sie einfach ein:</p><pre class="screen"><strong class="userinput"><code>call func(arg1, arg2, ...)</code></strong></pre><p>Der Rückgabewert wird ausgegeben.</p><p>Für eine Zusammenfassung aller laufenden Prozesse im
      Stil von <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ps&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ps</span>(1)</span></a> benutzen Sie:</p><pre class="screen"><strong class="userinput"><code>ps</code></strong></pre><p>Nun haben Sie herausgefunden, warum Ihr Kernel
      fehlschlägt, und möchten neu starten. Denken Sie
      daran, dass, abhängig von der Schwere vorhergehender
      Störungen, nicht alle Teile des Kernels wie gewohnt
      funktionieren könnten. Führen Sie eine der folgenden
      Aktionen durch, um Ihr System herunterzufahren und neu zu
      starten:</p><pre class="screen"><strong class="userinput"><code>panic</code></strong></pre><p>Dies wird Ihren Kernel dazu veranlassen abzustürzen,
      einen Speicherauszug abzulegen und neu zu starten, sodass Sie
      den Kernspeicherauszug später auf höherer Ebene mit
      <code class="command">gdb</code> auswerten können. Diesem Befehl muss
      normalerweise eine weitere <code class="command">continue</code>-Anweisung
      folgen.</p><pre class="screen"><strong class="userinput"><code>call boot(0)</code></strong></pre><p>Dürfte ein guter Weg sein, um das laufende System
      sauber herunterzufahren, alle Festplatten mittels
      <code class="function">sync()</code> zu schreiben und schließlich,
      in manchen Fällen, neu zu starten. Solange die Festplatten-
      und Dateisystemschnittstellen des Kernels nicht beschädigt
      sind, könnte dies ein guter Weg für ein beinahe
      sauberes Abschalten sein.</p><pre class="screen"><strong class="userinput"><code>call cpu_reset()</code></strong></pre><p>Dies ist der letzte Ausweg aus der Katastrophe und kommt
      beinahe dem Drücken des Ausschaltknopfes gleich.</p><p>Falls Sie eine kurze Zusammenfassung aller Befehle
      benötigen, geben Sie einfach ein:</p><pre class="screen"><strong class="userinput"><code>help</code></strong></pre><p>Es ist strengstens empfohlen, eine ausgedruckte Version der
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ddb&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ddb</span>(4)</span></a>-Manualpage während der Fehlersuche neben sich
      liegen zu haben. Denken Sie daran, dass es schwer ist, die
      Online-Hilfe zu lesen, während der Ausführung des
      Kernels in Einzelschritten.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-online-gdb"></a>10.5. Online-Kernel-Fehlersuche mit GDB auf einem entfernten
      System</h2></div></div></div><p>Diese Funktion wird seit FreeBSD 2.2 unterstützt und
      ist wirklich sehr geschickt.</p><p>GDB unterstützt <span class="emphasis"><em>die Fehlersuche von einem
      entfernten System aus</em></span> bereits einige Zeit. Dies
      geschieht unter Benutzung eines sehr einfachen Protokolls
      über eine serielle Verbindung. Anders als bei den anderen,
      oben beschriebenen, Vorgehensweisen werden hier zwei Systeme
      benötigt. Das eine ist das Hostsystem, welches die Umgebung
      zur Fehlersuche, einschließlich aller Quellen und einer
      Kopie der Kernel-Binärdatei mit allen Symbolen
      bereitstellt, und das andere das Zielsystem, welches einfach nur
      eine Kopie desselben Kernels ausführt (ohne die
      Informationen zur Fehlersuche).</p><p>Sie sollten den Kernel im Zweifelsfall mit <code class="command">config
      -g</code> konfigurieren, <code class="option">DDB</code> in die
      Konfiguration aufnehmen und den Kernel, wie sonst auch,
      kompilieren. Dies ergibt, aufgrund der zusätzlichen
      Informationen zur Fehlersuche, eine umfangreiche
      Binärdatei. Kopieren Sie diesen Kernel auf das Zielsystem,
      entfernen Sie die Symbole zur Fehlersuche mit <code class="command">strip
      -x</code> und starten Sie ihn mit der
      <code class="option">-d</code>-Boot-Option. Stellen Sie die serielle
      Verbindung zwischen dem Zielsystem, welches "flags 80" für
      dessen sio-Gerät gesetzt hat, und dem Hostsystem, welches
      die Fehlersuche übernimmt, her. Nun wechseln Sie auf dem
      Hostsystem in das Bauverzeichnis des Ziel-Kernels und starten
      <code class="command">gdb</code>:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>kgdb kernel</code></strong>
GDB is free software and you are welcome to distribute copies of it
 under certain conditions; type "show copying" to see the conditions.
There is absolutely no warranty for GDB; type "show warranty" for details.
GDB 4.16 (i386-unknown-freebsd),
Copyright 1996 Free Software Foundation, Inc...
<code class="prompt">(kgdb)</code> </pre><p>Stellen Sie die entfernte Sitzung zur Fehlersuche ein mit
      (angenommen, der erste serielle Port ist in Verwendung):</p><pre class="screen"><code class="prompt">(kgdb)</code> <strong class="userinput"><code>target remote /dev/cuaa0</code></strong></pre><p>Jetzt geben Sie auf dem Zielsystem, welches noch vor Beginn
      der Gerätesuche in DDB gelangt ist, ein:</p><pre class="screen">Debugger("Boot flags requested debugger")
Stopped at Debugger+0x35: movb  $0, edata+0x51bc
<code class="prompt">db&gt;</code> <strong class="userinput"><code>gdb</code></strong></pre><p>DDB antwortet dann mit:</p><pre class="screen">Next trap will enter GDB remote protocol mode</pre><p>Jedesmal wenn Sie <code class="command">gdb</code> eingeben, wird
      zwischen dem lokalen DDB und entfernten GDB umgeschaltet. Um
      einen nächsten Trap sofort zu erzwingen, geben Sie einfach
      <code class="command">s</code> (step) ein. Ihr GDB auf dem Hostsystem
      erhält nun die Kontrolle über den Ziel-Kernel:</p><pre class="screen">Remote debugging using /dev/cuaa0
Debugger (msg=0xf01b0383 "Boot flags requested debugger")
    at ../../i386/i386/db_interface.c:257
<code class="prompt">(kgdb)</code></pre><p>Sie können mit dieser Sitzung wie mit jeder anderen
      GDB-Sitzung umgehen, einschließlich vollem Zugriff auf die
      Quellen, Starten im gud-Modus innerhalb eines Emacs-Fensters
      (was Ihnen automatische Quelltext-Ausgabe in einem weiteren
      Emacs-Fenster bietet), usw.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-console"></a>10.6. Fehlersuche bei einem Konsolen-Treiber</h2></div></div></div><p>Da Sie nunmal einen Konsolen-Treiber benötigen, um DDB
      zu starten, ist alles ein wenig komplizierter, sobald der
      Konsolen-Treiber selbst versagt. Sie erinnern sich vielleicht an
      die Benutzung einer seriellen Konsole (entweder durch
      Verändern des Boot-Blocks oder Eingabe von
      <code class="option">-h</code> an der
      <code class="prompt">Boot:</code>-Eingabeaufforderung) und das
      Anschließen eines Standard-Terminals an Ihren ersten
      seriellen Port. DDB funktioniert auf jedem konfigurierten
      Konsolen-Treiber, auch auf einer seriellen Konsole.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-deadlocks"></a>10.7. Fehlersuche bei Deadlocks</h2></div></div></div><p>Sie erleben vielleicht mal sogenannte Deadlocks, wobei ein
      System aufhört, nützliche Arbeit zu machen. Um in
      einer solchen Situation einen hilfreichen Fehlerbericht zu
      liefern, benutzen Sie <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ddb&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ddb</span>(4)</span></a>, wie oben beschrieben.
      Hängen Sie die Ausgabe von <code class="command">ps</code> und
      <code class="command">trace</code> für verdächtige Prozesse an
      den Bericht an.</p><p>Falls möglich, versuchen Sie, weitere Untersuchungen
      anzustellen. Der Empfang der Ausgaben unten ist besonders dann
      nützlich, wenn Sie den Auslöser für die Blockade
      des Systems auf VFS-Ebene vermuten. Fügen Sie die folgenden
      Optionen

      </p><pre class="programlisting">makeoptions		DEBUG=-g
	options		INVARIANTS
	options		INVARIANT_SUPPORT
	options		WITNESS
	options		DEBUG_LOCKS
	options		DEBUG_VFS_LOCKS
	options		DIAGNOSTIC</pre><p>

      der Kernel-Konfigurationsdatei hinzu. Wenn die Blockade
      ausgelöst wird, stellen Sie, zusätzlich der Ausgabe
      vom <code class="command">ps</code>-Befehl, die Informationen aus
      <code class="command">show pcpu</code>, <code class="command">show allpcpu</code>,
      <code class="command">show locks</code>, <code class="command">show alllocks</code>,
      <code class="command">show lockedvnods</code> und
      <code class="command">alltrace</code> bereit.</p><p>Um aussagekräftige Zurückverfolgungen von in
      Threads aufgeteilten Prozesse zu erhalten, benutzen Sie
      <code class="command">thread thread-id</code>, um zum Thread-Stack zu
      wechseln und eine Zurückverfolgung mit
      <code class="command">where</code> anzustellen.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-options"></a>10.8. Glossar der Kernel-Optionen zur Fehlersuche</h2></div></div></div><p>Dieser Abschnitt bietet ein kurzes Glossar der zur
      Kompilierzeit verfügbaren Kernel-Optionen, die die
      Fehlersuche unterstützen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">options KDB</code>: Kompiliert das
	  Kernel-Debugger-Framework ein. Wird von <code class="literal">options
	  DDB</code> und <code class="literal">options GDB</code>
	  benötigt. Kein oder nur geringer Leistungs-Overhead.
	  Standardmäßig wird bei einer Panic der Debugger
	  gestartet, anstatt automatisch neu zu starten.</p></li><li class="listitem"><p><code class="literal">options KDB_UNATTENDED</code>: Setzt den
	  Standard des
	  <code class="literal">debug.debugger_on_panic</code>-sysctl-Werts auf
	  0, welcher regelt, ob der Debugger bei einer Panic gestartet
	  wird. Solange <code class="literal">options KDB</code> nicht in den
	  Kernel einkompiliert ist, wird bei einer Panic automatisch
	  neu gestartet; sobald es in den Kernel einkompiliert ist,
	  wird standardmäßig der Debugger gestartet,
	  solange <code class="literal">options KDB_UNATTENDED</code> nicht
	  einkompiliert ist. Falls Sie den Kernel-Debugger in den
	  Kernel einkompiliert lassen wollen, aber möchten, dass
	  das System neu startet, wenn Sie nicht zur Stelle sind, um
	  den Debugger zur Diagnose zu benutzen, wählen Sie diese
	  Option.</p></li><li class="listitem"><p><code class="literal">options KDB_TRACE</code>: Setzt den Standard
	  des <code class="literal">debug.trace_on_panic</code>-sysctl-Werts auf
	  1, welcher regelt, ob der Debugger bei einer Panic
	  automatisch eine Stack-Ablaufverfolgung ausgibt. Besonders
	  wenn der Kernel mit <code class="literal">KDB_UNATTENDED</code>
	  läuft, kann dies hilfreich sein, um grundlegende
	  Informationen zur Fehlersuche auf der seriellen oder
	  Firewire-Konsole zu erhalten, während immer noch zur
	  Wiederherstellung neu gestartet wird.</p></li><li class="listitem"><p><code class="literal">options DDB</code>: Kompiliert die
	  Unterstützung für den Konsolen-Debugger DDB ein.
	  Dieser interaktive Debugger läuft auf was auch immer
	  die aktive Konsole des Systems auf niedrigster Ebene ist,
	  dazu gehören die Video-, serielle und Firewire-Konsole.
	  Er bietet grundlegende, eingebaute Möglichkeiten zur
	  Fehlersuche wie zum Beispiel das Erstellen von
	  Stack-Ablaufverfolgungen, das Auflisten von Prozessen und
	  Threads, das Ablegen des Lock-, VM- und Dateisystemstatus
	  und die Verwaltung des Kernel-Speichers. DDB benötigt
	  keine Software, die auf einem zweiten System läuft,
	  oder die Fähigkeit, einen Kernspeicherauszug oder
	  Kernel-Symbole zur vollen Fehlersuche zu erzeugen und bietet
	  detaillierte Fehlerdiagnose des Kernels zur Laufzeit. Viele
	  Fehler können allein unter Benutzung der DDB-Ausgabe
	  untersucht werden. Diese Option hängt von
	  <code class="literal">options KDB</code> ab.</p></li><li class="listitem"><p><code class="literal">options GDB</code>: Kompiliert die
	  Unterstützung für den Debugger GDB ein, welcher
	  von einem entfernten System aus über ein serielles
	  Kabel oder Firewire agieren kann. Wenn der Debugger
	  gestartet ist, kann GDB dazu verwendet werden, um
	  Struktur-Inhalte einzusehen, Stack-Ablaufverfolgungen zu
	  erzeugen, usw. Bei manchem Kernel-Status ist der Zugriff
	  ungeschickter als mit DDB, welcher dazu in der Lage ist,
	  nützliche Zusammenfassungen des Kernel-Status
	  automatisch zu erstellen wie zum Beispiel das automatische
	  Abgehen der Lock-Fehlersuche oder der Strukturen zur
	  Kernel-Speicher-Verwaltung, und es wird ein zweites System
	  benötigt. Auf der anderen Seite verbindet GDB
	  Informationen aus den Kernel-Quellen mit vollständigen
	  Symbolen zur Fehlersuche, erkennt komplette
	  Datenstrukturdefinitionen, lokale Variablen und ist in
	  Skripten einsetzbar. Diese Option hängt von
	  <code class="literal">options KDB</code> ab, ist aber nicht zur
	  Benutzung von GDB auf einem Kernel-Kernspeicherauszug
	  nötig.</p></li><li class="listitem"><p><code class="literal">options BREAK_TO_DEBUGGER</code>,
	  <code class="literal">options ALT_BREAK_TO_DEBUGGER</code>: Erlaubt
	  ein Abbruch- oder Alternativ-Signal auf der Konsole, um in
	  den Debugger zu gelangen. Falls sich das System ohne eine
	  Panic aufhängt, ist dies ein nützlicher Weg, um
	  den Debugger zu erreichen. Aufgrund der aktuellen
	  Verriegelung durch den Kernel ist ein Abbruch-Signal, das
	  auf einer seriellen Konsole erzeugt wurde, deutlich
	  vertrauenswürdiger beim Gelangen in den Debugger und
	  wird allgemein empfohlen. Diese Option hat kaum oder keine
	  Auswirkung auf den Durchsatz.</p></li><li class="listitem"><p><code class="literal">options INVARIANTS</code>: Kompiliert eine
	  große Anzahl an Aussageprüfungen und -tests
	  (Assertion-Checks und -Tests) ein, welche ständig die
	  Intaktheit der Kernel-Datenstrukturen und die Invarianten
	  der Kernel-Algorithmen prüfen. Diese Tests können
	  aufwendig sein und sind deswegen nicht von Anfang an
	  einkompiliert, aber helfen nützliches "fail
	  stop"-Verhalten, wobei bestimmte Gruppen nicht
	  erwünschten Verhaltens den Debugger öffnen, bevor
	  Beschädigungen an Kernel-Daten auftreten,
	  bereitzustellen, welches es einfacher macht, diese auf
	  Fehler hin zu untersuchen. Die Tests beinhalten Säubern
	  von Speicher und use-after-free-Prüfungen, was eine der
	  bedeutenderen Quellen von Overhead ist. Diese Option
	  hängt von <code class="literal">options INVARIANT_SUPPORT</code>
	  ab.</p></li><li class="listitem"><p><code class="literal">options INVARIANT_SUPPORT</code>: Viele der
	  in <code class="literal">options INVARIANTS</code> vorhandenen Tests
	  benötigen veränderte Datenstrukturen und
	  zusätzliche Kernel-Symbole, die festgelegt werden
	  müssen.</p></li><li class="listitem"><p><code class="literal">options WITNESS</code>: Diese Option
	  aktiviert Verfolgung und Prüfung von Lock-Anforderungen
	  zur Laufzeit und ist als Werkzeug für die
	  Deadlock-Diagnose von unschätzbarem Wert. WITNESS
	  pflegt ein Diagramm mit erworbenen Lock-Anträgen nach
	  Typ geordnet und prüft bei jedem Erwerb nach Zyklen
	  (implizit oder explizit). Falls ein Zyklus entdeckt wird,
	  werden eine Warnung und eine Stack-Ablaufverfolgung erzeugt
	  und als Hinweis, dass ein möglicher Deadlock gefunden
	  wurde, auf der Konsole ausgegeben. WITNESS wird
	  benötigt, um die DDB-Befehle <code class="command">show
	  locks</code>, <code class="command">show witness</code> und
	  <code class="command">show alllocks</code> benutzen zu können.
	  Diese Debug-Option hat einen bedeutenden Leistung-Overhead,
	  welcher ein ein wenig durch Benutzung von <code class="literal">options
	  WITNESS_SKIPSPIN</code> gemildert werden kann.
	  Detaillierte Dokumentation kann in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=witness&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">witness</span>(4)</span></a> gefunden
	  werden.</p></li><li class="listitem"><p><code class="literal">options WITNESS_SKIPSPIN</code>: Deaktiviert
	  die Prüfung von Spinlock-Lock-Anforderungen mit WITNESS
	  zur Laufzeit. Da Spinlocks am häufigsten im Scheduler
	  angefordert werden und Scheduler-Ereignisse oft auftreten,
	  kann diese Option Systeme, die mit WITNESS laufen, merklich
	  beschleunigen. Diese Option hängt von <code class="literal">options
	  WITNESS</code> ab.</p></li><li class="listitem"><p><code class="literal">options WITNESS_KDB</code>: Setzt den
	  Standard des
	  <code class="literal">debug.witness.kdb</code>-sysctl-Werts auf 1, was
	  bewirkt, dass WITNESS den Debugger aufruft, sobald eine
	  Lock-Anforderungsverletzung vorliegt, anstatt einfach nur
	  eine Warnung auszugeben. Diese Option hängt von
	  <code class="literal">options WITNESS</code> ab.</p></li><li class="listitem"><p><code class="literal">options SOCKBUF_DEBUG</code>: Führt
	  umfassende Beschaffenheitsprüfungen in Socket-Puffern
	  durch, was nützlich zur Fehlersuche bei Socket-Fehlern
	  und Anzeichen für Ressourceblockaden (Race) in
	  Protokollen und Gerätetreibern, die mit Sockets
	  arbeiten, sein kann. Diese Option hat bedeutende Auswirkung
	  auf die Netzwerkleistung und kann die Zeitverhältnisse
	  bei gegenseitiger Ressourceblockade in Gerätetreibern
	  ändern.</p></li><li class="listitem"><p><code class="literal">options DEBUG_VFS_LOCKS</code>: Verfolgt
	  Lock-Anforderungs-Einzelheiten bei lockmgr/vnode-Locks, was
	  die Menge der Informationen, die von <code class="command">show
	  lockdevnods</code> in DDB angezeigt werden,
	  vergrößert. Diese Option hat messbare Auswirkung
	  auf die Leistung.</p></li><li class="listitem"><p><code class="literal">options DEBUG_MEMGUARD</code>: Ein Ersatz
	  für die Kernel-Speicher-Zuweisung durch <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=malloc&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">malloc</span>(9)</span></a>,
	  die das VM-System benutzt, um Lese- und Schreibzugriffe auf
	  zugewiesenen Speicher nach der Freigabe zu entdecken.
	  Details können in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=memguard&amp;sektion=9"><span class="citerefentry"><span class="refentrytitle">memguard</span>(9)</span></a> gefunden werden.
	  Diese Option hat bedeutende Auswirkung auf die Leistung,
	  aber kann sehr nützlich bei der Fehlersuche sein, wenn
	  Kernel-Speicher-Beschädigungen durch Fehler verursacht
	  werden.</p></li><li class="listitem"><p><code class="literal">options DIAGNOSTIC</code>: Aktiviert
	  zusätzliche, aufwendigere Diagnosetests analog zu
	  <code class="literal">options INVARIANTS</code>.</p></li></ul></div></div></div></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="architectures"></a>Teil IV. Architekturen</h1></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="chapter"><a href="#x86">11. x86-Assembler-Programmierung</a></span></dt><dd><dl><dt><span class="sect1"><a href="#x86-intro">11.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#x86-the-tools">11.2. Die Werkzeuge</a></span></dt><dt><span class="sect1"><a href="#x86-system-calls">11.3. Systemaufrufe</a></span></dt><dt><span class="sect1"><a href="#x86-return-values">11.4. Rückgabewerte</a></span></dt><dt><span class="sect1"><a href="#x86-portable-code">11.5. Portablen Code erzeugen</a></span></dt><dt><span class="sect1"><a href="#x86-first-program">11.6. Unser erstes Programm</a></span></dt><dt><span class="sect1"><a href="#x86-unix-filters">11.7. <span class="trademark">UNIX</span>®-Filter schreiben</a></span></dt><dt><span class="sect1"><a href="#x86-buffered-io">11.8. Gepufferte Eingabe und Ausgabe</a></span></dt><dt><span class="sect1"><a href="#x86-command-line">11.9. Kommandozeilenparameter</a></span></dt><dt><span class="sect1"><a href="#x86-environment">11.10. Die <span class="trademark">UNIX</span>®-Umgebung</a></span></dt><dt><span class="sect1"><a href="#x86-files">11.11. Arbeiten mit Dateien</a></span></dt><dt><span class="sect1"><a href="#x86-one-pointed-mind">11.12. One-Pointed Mind</a></span></dt><dt><span class="sect1"><a href="#x86-fpu">11.13. Die <acronym class="acronym">FPU</acronym> verwenden</a></span></dt><dt><span class="sect1"><a href="#x86-caveats">11.14. Vorsichtsmassnahmen</a></span></dt><dt><span class="sect1"><a href="#x86-acknowledgements">11.15. Danksagungen</a></span></dt></dl></dd></dl></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86"></a>Kapitel 11. x86-Assembler-Programmierung</h2></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="sect1"><a href="#x86-intro">11.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#x86-the-tools">11.2. Die Werkzeuge</a></span></dt><dt><span class="sect1"><a href="#x86-system-calls">11.3. Systemaufrufe</a></span></dt><dt><span class="sect1"><a href="#x86-return-values">11.4. Rückgabewerte</a></span></dt><dt><span class="sect1"><a href="#x86-portable-code">11.5. Portablen Code erzeugen</a></span></dt><dt><span class="sect1"><a href="#x86-first-program">11.6. Unser erstes Programm</a></span></dt><dt><span class="sect1"><a href="#x86-unix-filters">11.7. <span class="trademark">UNIX</span>®-Filter schreiben</a></span></dt><dt><span class="sect1"><a href="#x86-buffered-io">11.8. Gepufferte Eingabe und Ausgabe</a></span></dt><dt><span class="sect1"><a href="#x86-command-line">11.9. Kommandozeilenparameter</a></span></dt><dt><span class="sect1"><a href="#x86-environment">11.10. Die <span class="trademark">UNIX</span>®-Umgebung</a></span></dt><dt><span class="sect1"><a href="#x86-files">11.11. Arbeiten mit Dateien</a></span></dt><dt><span class="sect1"><a href="#x86-one-pointed-mind">11.12. One-Pointed Mind</a></span></dt><dt><span class="sect1"><a href="#x86-fpu">11.13. Die <acronym class="acronym">FPU</acronym> verwenden</a></span></dt><dt><span class="sect1"><a href="#x86-caveats">11.14. Vorsichtsmassnahmen</a></span></dt><dt><span class="sect1"><a href="#x86-acknowledgements">11.15. Danksagungen</a></span></dt></dl></div><p><span class="emphasis"><em>Dieses Kapitel wurde geschrieben von
    G. Adam Stanislav.</em></span></p><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-intro"></a>11.1. Synopsis</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><p>Assembler-Programmierung unter <span class="trademark">UNIX</span>® ist höchst
      undokumentiert. Es wird allgemein angenommen, dass niemand sie
      jemals benutzen will, da <span class="trademark">UNIX</span>®-Systeme auf verschiedenen
      Mikroprozessoren laufen, und man deshalb aus Gründen der
      Portabilität alles in C schreiben sollte.</p><p>In Wirklichkeit ist die Portabilität von C
      größtenteils ein Mythos. Auch C-Programme müssen
      angepasst werden, wenn man sie von einem <span class="trademark">UNIX</span>® auf ein anderes
      portiert, egal auf welchem Prozessor jedes davon läuft.
      Typischerweise ist ein solches Programm voller Bedingungen, die
      unterscheiden für welches System es kompiliert wird.</p><p>Sogar wenn wir glauben, dass jede <span class="trademark">UNIX</span>®-Software in C, oder
      einer anderen High-Level-Sprache geschrieben werden sollte,
      brauchen wir dennoch Assembler-Programmierer: Wer sonst sollte
      den Abschnitt der C-Bibliothek schreiben, die auf den Kernel
      zugreift?</p><p>In diesem Kapitel möchte ich versuchen zu zeigen, wie
      man Assembler-Sprache verwenden kann, um <span class="trademark">UNIX</span>®-Programme,
      besonders unter FreeBSD, zu schreiben.</p><p>Dieses Kapitel erklärt nicht die Grundlagen der
      Assembler-Sprache. Zu diesem Thema gibt es bereits genug Quellen
      (einen vollständigen Online-Kurs finden Sie in Randall
      Hydes <a class="link" href="http://webster.cs.ucr.edu/" target="_top">Art of Assembly
      Language</a>; oder falls Sie ein gedrucktes Buch bevorzugen,
      können Sie einen Blick auf Jeff Duntemanns <a class="link" href="http://www.int80h.org/cgi-bin/isbn?isbn=0471375233" target="_top">Assembly
      Language Step-by-Step</a> werfen). Jedenfalls sollte jeder
      Assembler-Programmierer nach diesem Kapitel schnell und
      effizient Programme für FreeBSD schreiben
      können.</p><p>Copyright © 2000-2001 G. Adam Stanislav. All rights
      reserved.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-the-tools"></a>11.2. Die Werkzeuge</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-the-assembler"></a>11.2.1. Der Assembler</h3></div></div></div><p>Das wichtigste Werkzeug der Assembler-Programmierung ist
	der Assembler, diese Software übersetzt Assembler-Sprache
	in Maschinencode.</p><p>Für FreeBSD stehen zwei verschiedene Assembler zur
	Verfügung. Der erste ist
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=as&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">as</span>(1)</span></a>,
	der die traditionelle <span class="trademark">UNIX</span>®-Assembler-Sprache verwendet.
	Dieser ist Teil des Systems.</p><p>Der andere ist
	<span class="application">/usr/ports/devel/nasm</span>. Dieser
	benutzt die Intel-Syntax und sein Vorteil ist, dass es Code
	fü viele Vetriebssysteme übersetzen kann. Er muss
	gesondert installiert werden, aber ist völlig
	frei.</p><p>In diesem Kapitel wird die
	<span class="application">nasm</span>-Syntax verwendet. Einerseits
	weil es die meisten Assembler-Programmierer, die von anderen
	Systemen zu FreeBSD kommen, leichter verstehen werden. Und
	offen gesagt, weil es das ist, was ich gewohnt bin.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-the-linker"></a>11.2.2. Der Linker</h3></div></div></div><p>Die Ausgabe des Assemblers muss, genau wie der Code jedes
	Compilers, gebunden werden, um eine ausführbare Datei zu
	bilden.</p><p>Der Linker
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ld&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ld</span>(1)</span></a>
	ist der Standard und Teil von FreeBSD. Er funktioniert mit dem
	Code beider Assembler.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-system-calls"></a>11.3. Systemaufrufe</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-default-calling-convention"></a>11.3.1. Standard-Aufrufkonvention</h3></div></div></div><p>Standardmäßig benutzt der FreeBSD-Kernel die
	C-Aufrufkonvention. Weiterhin wird, obwohl auf den Kernel
	durch <code class="function">int 80h</code> zugegriffen
	wird, angenommen, dass das Programm eine Funktion aufruft, die
	<code class="function">int 80h</code> verwendet, anstatt
	<code class="function">int 80h</code> direkt
	aufzurufen.</p><p>Diese Konvention ist sehr praktisch und der
	<span class="trademark">Microsoft</span>®-Konvention von <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>
	überlegen. Warum? Weil es die <span class="trademark">UNIX</span>®-Konvention jedem
	Programm, egal in welcher Sprache es geschrieben ist, erlaubt
	auf den Kernel zuzugreifen.</p><p>Ein Assembler-Programm kann das ebenfalls. Beispielsweise
	könnten wir eine Datei öffnen:</p><pre class="programlisting">kernel:
	int	80h	; Call kernel
	ret

open:
	push	dword mode
	push	dword flags
	push	dword path
	mov	eax, 5
	call	kernel
	add	esp, byte 12
	ret</pre><p>Das ist ein sehr sauberer und portabler Programmierstil.
	Wenn Sie das Programm auf ein anderes <span class="trademark">UNIX</span>® portieren, das
	einen anderen Interrupt oder eie andere Art der
	Parameterübergabe verwendet, müssen sie nur die
	Prozedur kernel ändern.</p><p>Aber Assembler-Programmierer lieben es Taktzyklen zu
	schinden. Das obige Beispiel benötigt eine <code class="function">call/ret</code>-Kombination. Das können
	wir entfernen, indem wir einen weiteren Parameter mit
	<code class="function">push</code> übergeben:</p><pre class="programlisting">open:
	push	dword mode
	push	dword flags
	push	dword path
	mov	eax, 5
	push	eax		; Or any other dword
	int	80h
	add	esp, byte 16</pre><p>Die Konstante <code class="constant">5</code>, die wir in <code class="varname">EAX</code> ablegen, identifiziert die
	Kernel-Funktion, die wir aufrufen. In diesem Fall ist das
	<code class="function">open</code>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-alternate-calling-convention"></a>11.3.2. Alternative Aufruf-Konvention</h3></div></div></div><p>FreeBSD ist ein extrem flexibles System. Es bietet noch
	andere Wege, um den Kernel aufzurufen. Damit diese
	funktionieren muss allerdings die Linux-Emulation installiert
	sein.</p><p>Linux ist ein <span class="trademark">UNIX</span>®-artiges System. Allerdings verwendet
	dessen Kernel die gleiche Systemaufruf-Konvention, bei der
	Parameter in Registern abgelegt werden, wie
	<acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>. Genau wie bei der
	<span class="trademark">UNIX</span>®-Konvention wird die Nummer der Funktion in <code class="varname">EAX</code> abgelegt. Allerdings werden die
	Parameter nicht auf den Stack gelegt, sondern in die Register
	<code class="varname">EBX, ECX, EDX, ESI, EDI,
	EBP</code>:</p><pre class="programlisting">open:
	mov	eax, 5
	mov	ebx, path
	mov	ecx, flags
	mov	edx, mode
	int	80h</pre><p>Diese Konvention hat einen großen Nachteil
	gegenüber der von <span class="trademark">UNIX</span>®, was die
	Assembler-Programmierung angeht: Jedesmal, wenn Sie einen
	Kernel-Aufruf machen, müssen Sie die Register <code class="function">push</code>en und sie später <code class="function">pop</code>en. Das macht Ihren Code
	unförmiger und langsamer. Dennoch lässt FreeBSD
	ihnen die Wahl.</p><p>Wenn Sie sich für die Linux-Konvention entscheiden,
	müssen Sie es das System wissen lassen. Nachdem ihr
	Programm übersetzt und gebunden wurde, müssen Sie
	die ausführbare Datei kennzeichnen:</p><pre class="screen"><code class="prompt">%</code>
	<strong class="userinput"><code>brandelf -t Linux
	filename</code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-use-geneva"></a>11.3.3. Welche Konvention Sie verwenden sollten</h3></div></div></div><p>Wenn Sie speziell für FreeBSD programmieren, sollten
	Sie die <span class="trademark">UNIX</span>®-Konvention verwenden: Diese ist schneller, Sie
	können globale Variablen in Registern ablegen, Sie
	müssen die ausführbare Datei nicht kennzeichnen und
	Sie erzwingen nicht die Installation der Linux-Emulation auf
	dem Zielsystem.</p><p>Wenn Sie portablen Programmcode erzeugen wollen, der auch
	unter Linux funktioniert, wollen Sie den FreeBSD-Nutzern
	vielleicht dennoch den effizientesten Programmcode bieten, der
	möglich ist. Ich werde Ihnen zeigen, wie Sie das
	erreichen können, nachdem ich die Grundlagen erklärt
	habe.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-call-numbers"></a>11.3.4. Aufruf-Nummern</h3></div></div></div><p>Um dem Kernel mitzuteilen welchen Dienst Sie aufrufen,
	legen Sie dessen Nummer in <code class="varname">EAX</code> ab. Natürlich müssen
	Sie dazu wissen welche Nummer die Richtige ist.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-the-syscalls-file"></a>11.3.4.1. Die Datei <code class="filename">syscalls</code></h4></div></div></div><p>Die Nummer der Funktionen sind in der Datei
	  <code class="filename">syscalls</code> aufgeführt. Mittels
	  <code class="command">locate syscalls</code> finden Sie diese in
	  verschiedenen Formaten, die alle auf die gleiche Weise aus
	  <code class="filename">syscalls.master</code> erzeugt werden.</p><p>Die Master-Datei für die
	  <span class="trademark">UNIX</span>®-Standard-Aufrufkonvention finden sie unter
	  <code class="filename">/usr/src/sys/kern/syscalls.master</code>.
	  Falls Sie die andere Konvention, die im
	  Linux-Emulations-Modus implementiert ist, verwenden
	  möchten, lesen Sie bitte
	  <code class="filename">/usr/src/sys/i386/linux/syscalls.master</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">FreeBSD und Linux unterscheiden sich nicht nur in
	  den Aufrufkonventionen, sie haben teilweise auch
	  verschiedene Nummern für die gleiche
	  Funktion.</p></div><p><code class="filename">syscalls.master</code> beschreibt, wie der
	  Aufruf gemacht werden muss:</p><pre class="programlisting">0	STD	NOHIDE	{ int nosys(void); } syscall nosys_args int
1	STD	NOHIDE	{ void exit(int rval); } exit rexit_args void
2	STD	POSIX	{ int fork(void); }
3	STD	POSIX	{ ssize_t read(int fd, void *buf, size_t nbyte); }
4	STD	POSIX	{ ssize_t write(int fd, const void *buf, size_t nbyte); }
5	STD	POSIX	{ int open(char *path, int flags, int mode); }
6	STD	POSIX	{ int close(int fd); }
etc...</pre><p>In der ersten Spalte steht die Nummer, die in <code class="varname">EAX</code> abgelegt werden muss.</p><p>Die Spalte ganz rechts sagt uns welche Parameter wir
	  <code class="function">push</code>en müssen. Die
	  Reihenfolge ist dabei <span class="emphasis"><em>von rechts nach
	  links</em></span>.</p><div class="informalexample"><p>Um beispielsweise eine Datei mittels
	  <code class="function">open</code> zu öffnen, müssen wir
	  zuerst den <code class="varname">mode</code> auf den Stack <code class="function">push</code>en, danach die
	  <code class="varname">flags</code>, dann die Adresse an der der
	  <code class="varname">path</code> gespeichert
	  ist.</p></div></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-return-values"></a>11.4. Rückgabewerte</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><p>Ein Systemaufruf wäre meistens nicht sehr
      nützlich, wenn er nicht irgendeinen Wert zurückgibt:
      Beispielsweise den Dateideskriptor einer geöffneten Datei,
      die Anzahl an Bytes die in einen Puffer gelesen wurde, die
      Systemzeit, etc.</p><p>Außerdem muss Sie das System informieren, falls ein
      Fehler auftritt: Wenn eine Datei nicht existiert, die
      Systemressourcen erschöpft sind, wir ein ungültiges
      Argument übergeben haben, etc.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-man-pages"></a>11.4.1. Manualpages</h3></div></div></div><p>Der herkömmliche Ort, um nach Informationen über
	verschiedene Systemaufrufe unter <span class="trademark">UNIX</span>®-Systemen zu suchen,
	sind die Manualpages. FreeBSD beschreibt seine Systemaufrufe
	in Abschnitt 2, manchmal auch Abschnitt 3.</p><p>In
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=open&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">open</span>(2)</span></a>
	steht beispielsweise:</p><div class="blockquote"><blockquote class="blockquote"><p>Falls erfolgreich, gibt
	<code class="function">open()</code> einen nicht negativen Integerwert,
	als Dateideskriptor bezeichnet, zurück. Es gibt
	<code class="varname">-1</code> im Fehlerfall zurück und setzt
	<code class="varname">errno</code> um den Fehler
	anzuzeigen.</p></blockquote></div><p>Ein Assembler-Programmierer, der neu bei <span class="trademark">UNIX</span>® und
	FreeBSD ist, wird sich sofort fragen: Wo finde ich
	<code class="varname">errno</code> und wie erreiche ich es?</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Die Information der Manualpage bezieht sich auf
	C-Programme. Der Assembler-Programmierer benötigt
	zusätzliche Informationen.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-where-return-values"></a>11.4.2. Wo sind die Rückgabewerde?</h3></div></div></div><p>Leider gilt: Es kommt darauf an... Für die meisten
	Systemaufrufe liegt er in <code class="varname">EAX</code>, aber nicht für alle. Eine
	gute Daumenregel, wenn man zum ersten Mal mit einem
	Systemaufruf arbeitet, ist in <code class="varname">EAX</code> nach dem Rückgabewert zu
	suchen. Wenn er nicht dort ist, sind weitere Untersuchungen
	nötig.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Mir ist ein Systemaufruf bekannt, der den
	Rückgabewert in <code class="varname">EDX</code>
	ablegt: <code class="function">SYS_fork</code> Alle
	anderen mit denen ich bisher gearbeitet habe verwenden
	<code class="varname">EAX</code>. Allerdings habe ich
	noch nicht mit allen gearbeitet.</p></div><div xmlns="" class="tip"><h3 class="admontitle">Tipp: </h3><p xmlns="http://www.w3.org/1999/xhtml">Wenn Sie die Antwort weder hier, noch irgendwo anders
	finden, studieren Sie den Quelltext von
	<span class="application">libc</span> und sehen sich an, wie es mit
	dem Kernel zusammenarbeitet.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-where-errno"></a>11.4.3. Wo ist <code class="varname">errno</code>?</h3></div></div></div><p>Tatsächlich, nirgendwo...</p><p><code class="varname">errno</code> ist ein Teil der Sprache C, nicht
	des <span class="trademark">UNIX</span>®-Kernels. Wenn man direkt auf Kernel-Dienste
	zugreift, wird der Fehlercode in <code class="varname">EAX</code> zurückgegeben, das selbe
	Register in dem der Rückgabewert, bei einem erfolgreichen
	Aufruf landet.</p><p>Das macht auch Sinn. Wenn kein Fehler auftritt, gibt es
	keinen Fehlercode. Wenn ein Fehler auftritt, gibt es keinen
	Rückgabewert. Ein einziges Register kann also beides
	enthalten.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-how-to-know-error"></a>11.4.4. Feststellen, dass ein Fehler aufgetreten ist</h3></div></div></div><p>Wenn Sie die Standard FreeBSD-Aufrufkonvention verwenden
	wird das <code class="varname">carry flag</code>
	gelöscht wenn der Aufruf erfolgreich ist und gesetzt wenn
	ein Fehler auftritt.</p><p>Wenn Sie den Linux-Emulationsmodus verwenden ist der
	vorzeichenbehaftete Wert in <code class="varname">EAX</code> nicht negativ, bei einem
	erfolgreichen Aufruf. Wenn ein Fehler auftritt ist der Wert
	negativ, also <code class="varname">-errno</code>.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-portable-code"></a>11.5. Portablen Code erzeugen</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><p>Portabilität ist im Allgemeinen keine Stärke der
      Assembler-Programmierung. Dennoch ist es, besonders mit
      <span class="application">nasm</span>, möglich
      Assembler-Programme für verschiedene Plattformen zu
      schreiben. Ich selbst habe bereits Assembler-Bibliotheken
      geschrieben die auf so unterschiedlichen Systemen wie <span class="trademark">Windows</span>®
      und FreeBSD übersetzt werden können.</p><p>Das ist um so besser möglich, wenn Ihr Code auf zwei
      Plattformen laufen soll , die, obwohl sie verschieden sind, auf
      ähnlichen Architekturen basieren.</p><p>Beispielsweise ist FreeBSD ein <span class="trademark">UNIX</span>®, während Linux
      <span class="trademark">UNIX</span>®-artig ist. Ich habe bisher nur drei Unterschiede zwischen
      beiden (aus Sicht eines Assembler-Programmierers) erwähnt:
      Die Aufruf-Konvention, die Funktionsnummern und die Art der
      Übergabe von Rückgabewerten.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-deal-with-function-numbers"></a>11.5.1. Mit Funktionsnummern umgehen</h3></div></div></div><p>In vielen Fällen sind die Funktionsnummern die
	selben. Allerdings kann man auch wenn sie es nicht sind
	leicht mit diesem Problem umgehen: Anstatt die Nummern in
	Ihrem Code zu verwenden, benutzen Sie Konstanten, die Sie
	abhängig von der Zielarchitektur unterschiedlich
	definieren:</p><pre class="programlisting">%ifdef	LINUX
%define	SYS_execve	11
%else
%define	SYS_execve	59
%endif</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-deal-with-geneva"></a>11.5.2. Umgang mit Konventionen</h3></div></div></div><p>Sowohl die Aufrufkonvention, als auch die
	Rückgabewerte (das <code class="varname">errno</code> Problem) kann
	man mit Hilfe von Makros lösen:</p><pre class="programlisting">%ifdef	LINUX

%macro	system	0
	call	kernel
%endmacro

align 4
kernel:
	push	ebx
	push	ecx
	push	edx
	push	esi
	push	edi
	push	ebp

	mov	ebx, [esp+32]
	mov	ecx, [esp+36]
	mov	edx, [esp+40]
	mov	esi, [esp+44]
	mov	ebp, [esp+48]
	int	80h

	pop	ebp
	pop	edi
	pop	esi
	pop	edx
	pop	ecx
	pop	ebx

	or	eax, eax
	js	.errno
	clc
	ret

.errno:
	neg	eax
	stc
	ret

%else

%macro	system	0
	int	80h
%endmacro

%endif</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-deal-with-other-portability"></a>11.5.3. Umgang mit anderen
	Portabilitätsangelegenheiten</h3></div></div></div><p>Die oben genannte Lösung funktioniert in den meisten
	Fällen, wenn man Code schreibt, der zwischen FreeBSD und
	Linux portierbar sein soll. Allerdings sind die Unterschiede
	bei einigen Kernel-Diensten tiefgreifender.</p><p>In diesem Fällen müssen Sie zwei verschiedene
	Handler für diese Systemaufrufe schreiben und bedingte
	Assemblierung benutzen, um diese zu übersetzen.
	Glücklicherweise wird der größte Teil Ihres
	Codes nicht den Kernel aufrufen und Sie werden deshalb nur
	wenige solcher bedingten Abschnitte benötigen.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-portable-library"></a>11.5.4. Eine Bibliothek benutzen</h3></div></div></div><p>Sie können Portabilitätsprobleme im Hauptteil
	ihres Codes komplett vermeiden, indem Sie eine Bibliothek
	für Systemaufrufe schreiben. Erstellen Sie eine
	Bibliothek für FreeBSD, eine für Linux und weitere
	für andere Betriebssysteme.</p><p>Schreiben Sie in ihrer Bibliothek eine gesonderte Funktion
	(oder Prozedur, falls Sie die traditionelle
	Assembler-Terminologie bevorzugen) für jeden
	Systemaufruf. Verwenden Sie dabei die C-Aufrufkonvention um
	Parameter zu übergeben, aber verwenden Sie weiterhin
	<code class="varname">EAX</code>, für die
	Aufrufnummer. In diesem Fall kann ihre FreeBSD-Bibliothek sehr
	einfach sein, da viele scheinbar unterschiedliche Funktionen
	als Label für denselben Code implementiert sein
	können:</p><pre class="programlisting">sys.open:
sys.close:
[etc...]
	int	80h
	ret</pre><p>Ihre Linux-Bibliothek wird mehr verschiedene Funktionen
	benötigen, aber auch hier können Sie Systemaufrufe,
	welche die Anzahl an Parametern akzeptieren
	zusammenfassen:</p><pre class="programlisting">sys.exit:
sys.close:
[etc... one-parameter functions]
	push	ebx
	mov	ebx, [esp+12]
	int	80h
	pop	ebx
	jmp	sys.return

...

sys.return:
	or	eax, eax
	js	sys.err
	clc
	ret

sys.err:
	neg	eax
	stc
	ret</pre><p>Der Bibliotheks-Ansatz mag auf den ersten Blick unbequem
	aussehen, weil Sie eine weitere Datei erzeugen müssen von
	der Ihr Code abhängt. Aber er hat viele Vorteile: Zum
	einen müssen Sie die Bibliothek nur einmal schreiben und
	können sie dann in allen Ihren Programmen verwenden. Sie
	können sie sogar von anderen Assembler-Programmierern
	verwenden lassen, oder eine die von jemand anderem geschrieben
	wurde verwenden. Aber der vielleicht größte Vorteil
	ist, dass Ihr Code sogar von anderen Programmierer auf andere
	Systeme portiert werden kann, einfach indem man eine neue
	Bibliothek schreibt, völlig ohne Änderungen an Ihrem
	Code.</p><p>Falls Ihnen der Gedanke eine Bibliothek zu nutzen nicht
	gefällt, können Sie zumindest all ihre Systemaufrufe
	in einer gesonderten Assembler-Datei ablegen und diese mit
	Ihrem Hauptprogramm zusammen binden. Auch hier müssen
	alle, die ihr Programm portieren, nur eine neue Objekt-Datei
	erzeugen und an Ihr Hauptprogramm binden.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-portable-include"></a>11.5.5. Eine Include-Datei verwenden</h3></div></div></div><p>Wenn Sie ihre Software als (oder mit dem) Quelltext
	ausliefern, können Sie Makros definieren und in einer
	getrennten Datei ablegen, die Sie ihrem Code beilegen.</p><p>Porter Ihrer Software schreiben dann einfach eine neue
	Include-Datei. Es ist keine Bibliothek oder eine externe
	Objekt-Datei nötig und Ihr Code ist portabel, ohne dass
	man ihn editieren muss.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Das ist der Ansatz den wir in diesem Kapitel verwenden
	  werden. Wir werden unsere Include-Datei
	  <code class="filename">system.inc</code> nennen und jedesmal, wenn
	  wir einen neuen Systemaufruf verwenden, den entsprechenden
	  Code dort einfügen.</p></div><p>Wir können unsere <code class="filename">system.inc</code>
	beginnen indem wir die Standard-Dateideskriptoren
	deklarieren:</p><pre class="programlisting">%define	stdin	0
%define	stdout	1
%define	stderr	2</pre><p>Als Nächstes erzeugen wir einen symbolischen Namen
	für jeden Systemaufruf:</p><pre class="programlisting">%define	SYS_nosys	0
%define	SYS_exit	1
%define	SYS_fork	2
%define	SYS_read	3
%define	SYS_write	4
; [etc...]</pre><p>Wir fügen eine kleine, nicht globale Prozedur mit
	langem Namen ein, damit wir den Namen nicht aus Versehen in
	unserem Code wiederverwenden:</p><pre class="programlisting">section	.text
align 4
access.the.bsd.kernel:
	int	80h
	ret</pre><p>Wir erzeugen ein Makro, das ein Argument erwartet, die
	Systemaufruf-Nummer:</p><pre class="programlisting">%macro	system	1
	mov	eax, %1
	call	access.the.bsd.kernel
%endmacro</pre><p>Letztlich erzeugen wir Makros für jeden Systemaufruf.
	Diese Argumente erwarten keine Argumente.</p><pre class="programlisting">%macro	sys.exit	0
	system	SYS_exit
%endmacro

%macro	sys.fork	0
	system	SYS_fork
%endmacro

%macro	sys.read	0
	system	SYS_read
%endmacro

%macro	sys.write	0
	system	SYS_write
%endmacro

; [etc...]</pre><p>Fahren Sie fort, geben das in Ihren Editor ein und
	speichern es als <code class="filename">system.inc</code>. Wenn wir
	Systemaufrufe besprechen, werden wir noch Ergänzungen in
	dieser Datei vornehmen.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-first-program"></a>11.6. Unser erstes Programm</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><p>Jetzt sind wir bereit für unser erstes Programm, das
      übliche <span class="application">Hello, World!</span></p><pre class="programlisting"> 1:	%include	'system.inc'
 2:
 3:	section	.data
 4:	hello	db	'Hello, World!', 0Ah
 5:	hbytes	equ	$-hello
 6:
 7:	section	.text
 8:	global	_start
 9:	_start:
10:	push	dword hbytes
11:	push	dword hello
12:	push	dword stdout
13:	sys.write
14:
15:	push	dword 0
16:	sys.exit</pre><p>Hier folgt die Erklärung des Programms: Zeile 1
      fügt die Definitionen ein, die Makros und den Code aus
      <code class="filename">system.inc</code>.</p><p>Die Zeilen 3 bis 5 enthalten die Daten: Zeile 3 beginnt den
      Datenabschnitt/das Datensegment. Zeile 4 enthält die
      Zeichenkette "Hello, World!", gefolgt von einem Zeilenumbruch
      (<code class="constant">0Ah</code>). Zeile 5 erstellt eine Konstante, die
      die Länge der Zeichenkette aus Zeile 4 in Bytes
      enthält.</p><p>Die Zeilen 7 bis 16 enthalten den Code. Beachten Sie
      bitte, dass FreeBSD das Dateiformat <span class="emphasis"><em>elf</em></span>
      für diese ausführbare Datei verwendet, bei dem jedes
      Programm mit dem Label <code class="varname">_start</code> beginnt (oder,
      um genau zu sein, wird dies vom Linker erwartet). Diese Label
      muss global sein.</p><p>Die Zeilen 10 bis 13 weisen das System an
      <code class="varname">hbytes</code> Bytes der Zeichenkette
      <code class="varname">hello</code> nach <code class="varname">stdout</code> zu
      schreiben.</p><p>Die Zeilen 15 und 16 weisen das System an das Programm mit
      dem Rückgabewert <code class="constant">0</code> zu beenden. Der
      Systemaufruf <code class="function">SYS_exit</code> kehrt
      niemals zurück, somit endet das Programm hier.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Wenn Sie von <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>-Assembler zu
	<span class="trademark">UNIX</span>® gekommen sind, sind Sie es vielleicht gewohnt direktauf
	die Video-Hardware zu schreiben. Unter FreeBSD müssen Sie
	sich darum keine Gedanken machen, ebenso bei jeder anderen Art
	von <span class="trademark">UNIX</span>®. Soweit es Sie betrifft schreiben Sie in eine Datei
	namens <code class="filename">stdout</code>. Das kann der Bildschirm,
	oder ein <span class="application">telnet</span>-Terminal, eine
	wirkliche Datei, oder die Eingabe eines anderen Programms
	sein. Es liegt beim System herauszufinden, welches davon es
	tatsächlich ist.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-assemble-1"></a>11.6.1. Den Code assemblieren</h3></div></div></div><p>Geben Sie den Code (außer den Zeilennummern) in
	einen Editor ein und speichern Sie ihn in einer Datei namens
	<code class="filename">hello.asm</code>. Um es zu assemblieren
	benötigen Sie <span class="application">nasm</span>.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-get-nasm"></a>11.6.1.1. <span class="application">nasm</span> installieren</h4></div></div></div><p>Wenn Sie <span class="application">nasm</span> noch nicht
	  installiert haben geben Sie folgendes ein:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>su</code></strong>
Password:<strong class="userinput"><code>your root password</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/ports/devel/nasm</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make install</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>
<code class="prompt">%</code></pre><p>Sie können auch <strong class="userinput"><code>make install
	  clean</code></strong> anstatt <strong class="userinput"><code>make
	  install</code></strong> eingeben, wenn Sie den Quelltext von
	  <span class="application">nasm</span> nicht behalten
	  möchten.</p><p>Auf jeden Fall wird FreeBSD
	  <span class="application">nasm</span> automatisch aus dem Internet
	  herunterladen, es kompilieren und auf Ihrem System
	  installieren.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Wenn es sich bei Ihrem System nicht um FreeBSD
	    handelt, müssen Sie <span class="application">nasm</span>
	    von dessen <a class="link" href="https://sourceforge.net/projects/nasm" target="_top">Homepage</a>
	    herunterladen. Sie können es aber dennoch verwenden
	    um FreeBSD code zu assemblieren.</p></div><p>Nun können Sie den Code assemblieren, binden und
	  ausführen:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hello.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hello hello.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hello</code></strong>
Hello, World!
<code class="prompt">%</code></pre></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-unix-filters"></a>11.7. <span class="trademark">UNIX</span>®-Filter schreiben</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><p>Ein häufiger Typ von <span class="trademark">UNIX</span>®-Anwendungen ist ein Filter
      &#8212; ein Programm, das Eingaben von
      <code class="filename">stdin</code> liest, sie verarbeitet und das
      Ergebnis nach <code class="filename">stdout</code> schreibt.</p><p>In diesem Kapitel möchten wir einen einfachen Filter
      entwickeln und lernen, wie wir von <code class="filename">stdin</code>
      lesen und nach <code class="filename">stdout</code> schreiben. Dieser
      Filter soll jedes Byte seiner Eingabe in eine hexadezimale Zahl
      gefolgt von einem Leerzeichen umwandeln.</p><pre class="programlisting">%include	'system.inc'

section	.data
hex	db	'0123456789ABCDEF'
buffer	db	0, 0, ' '

section	.text
global	_start
_start:
	; read a byte from stdin
	push	dword 1
	push	dword buffer
	push	dword stdin
	sys.read
	add	esp, byte 12
	or	eax, eax
	je	.done

	; convert it to hex
	movzx	eax, byte [buffer]
	mov	edx, eax
	shr	dl, 4
	mov	dl, [hex+edx]
	mov	[buffer], dl
	and	al, 0Fh
	mov	al, [hex+eax]
	mov	[buffer+1], al

	; print it
	push	dword 3
	push	dword buffer
	push	dword stdout
	sys.write
	add	esp, byte 12
	jmp	short _start

.done:
	push	dword 0
	sys.exit</pre><p>Im Datenabschnitt erzeugen wir ein Array mit Namen
      <code class="varname">hex</code>. Es enthält die 16 hexadezimalen
      Ziffern in aufsteigender Reihenfolge. Diesem Array folgt ein
      Puffer, den wir sowohl für die Ein- als auch für die
      Ausgabe verwenden. Die ersten beiden Bytes dieses Puffers werden
      am Anfang auf <code class="constant">0</code> gesetzt. Dorthin schreiben
      wir die beiden hexadezimalen Ziffern (das erste Byte ist auch
      die Stelle an die wir die Eingabe lesen). Das dritte Byte ist
      ein Leerzeichen.</p><p>Der Code-Abschnitt besteht aus vier Teilen: Das Byte lesen,
      es in eine hexadezimale Zahl umwandeln, das Ergebnis schreiben
      und letztendlich das Programm verlassen.</p><p>Um das Byte zu lesen, bitten wir das System ein Byte von
      <code class="filename">stdin</code> zu lesen und speichern es im ersten
      Byte von <code class="varname">buffer</code>. Das System gibt die Anzahl
      an Bytes, die gelesen wurden, in <code class="varname">EAX</code> zurück. Diese wird
      <code class="constant">1</code> sein, wenn eine Eingabe empfangen wird
      und <code class="constant">0</code>, wenn keine Eingabedaten mehr
      verfügbar sind. Deshalb überprüfen wir den Wert
      von <code class="varname">EAX</code>. Wenn dieser
      <code class="constant">0</code> ist, springen wir zu
      <code class="varname">.done</code>, ansonsten fahren wir fort.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Zu Gunsten der Einfachheit ignorieren wir hier die
	Möglichkeit eines Fehlers.</p></div><p>Die Umwandlungsroutine in eine Hexadezimalzahl liest das
      Byte aus <code class="varname">buffer</code> in <code class="varname">EAX</code>, oder genaugenommen nur in
      <code class="varname">AL</code>, wobei die übrigen
      Bits von <code class="varname">EAX</code> auf null gesetzt
      werden. Außerdem kopieren wir das Byte nach <code class="varname">EDX</code>, da wir die oberen vier Bits
      (Nibble) getrennt von den unteren vier Bits umwandeln
      müssen. Das Ergebnis speichern wir in den ersten beiden
      Bytes des Puffers.</p><p>Als Nächstes bitten wir das System die drei Bytes in
      den Puffer zu schreiben, also die zwei hexadezimalen Ziffern und
      das Leerzeichen nach <code class="filename">stdout</code>. Danach
      springen wir wieder an den Anfang des Programms und verarbeiten
      das nächste Byte.</p><p>Wenn die gesamte Eingabe verarbeitet ist, bitten wie das
      System unser Programm zu beenden und null zurückzuliefern,
      welches traditionell die Bedeutung hat, dass unser Programm
      erfolgreich war.</p><p>Fahren Sie fort und speichern Sie den Code in eine Datei
      namens <code class="filename">hex.asm</code>. Geben Sie danach folgendes
      ein (<strong class="userinput"><code>^D</code></strong> bedeutet, dass Sie die
      Steuerungstaste drücken und dann <strong class="userinput"><code>D</code></strong>
      eingeben, während Sie Steuerung gedrückt
      halten):</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hex.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hex hex.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hex</code></strong>
<strong class="userinput"><code>Hello, World!</code></strong>
48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 0A <strong class="userinput"><code>Here I come!</code></strong>
48 65 72 65 20 49 20 63 6F 6D 65 21 0A <strong class="userinput"><code>^D</code></strong> <code class="prompt">%</code></pre><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Wenn Sie von <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> zu <span class="trademark">UNIX</span>®
	wechseln, wundern Sie sich vielleicht, warum jede Zeile mit
	<code class="constant">0A</code> an Stelle von <code class="constant">0D
	0A</code> endet. Das liegt daran, dass <span class="trademark">UNIX</span>® nicht die
	CR/LF-Konvention, sondern die "new line"-Konvention verwendet,
	welches hexadezimal als <code class="constant">0A</code> dargestellt
	wird.</p></div><p>Können wir das Programm verbessern? Nun, einerseits ist
      es etwas verwirrend, dass die Eingabe, nachdem wir eine Zeile
      verarbeitet haben, nicht wieder am Anfang der Zeile beginnt.
      Deshalb können wir unser Programm anpassen um einen
      Zeilenumbruch an Stelle eines Leerzeichens nach jedem
      <code class="constant">0A</code> auszugeben:</p><pre class="programlisting">%include	'system.inc'

section	.data
hex	db	'0123456789ABCDEF'
buffer	db	0, 0, ' '

section	.text
global	_start
_start:
	mov	cl, ' '

.loop:
	; read a byte from stdin
	push	dword 1
	push	dword buffer
	push	dword stdin
	sys.read
	add	esp, byte 12
	or	eax, eax
	je	.done

	; convert it to hex
	movzx	eax, byte [buffer]
	mov	[buffer+2], cl
	cmp	al, 0Ah
	jne	.hex
	mov	[buffer+2], al

.hex:
	mov	edx, eax
	shr	dl, 4
	mov	dl, [hex+edx]
	mov	[buffer], dl
	and	al, 0Fh
	mov	al, [hex+eax]
	mov	[buffer+1], al

	; print it
	push	dword 3
	push	dword buffer
	push	dword stdout
	sys.write
	add	esp, byte 12
	jmp	short .loop

.done:
	push	dword 0
	sys.exit</pre><p>Wir haben das Leerzeichen im Register <code class="varname">CL</code> abgelegt. Das können wir
      bedenkenlos tun, da <span class="trademark">UNIX</span>®-Systemaufrufe im Gegensatz zu denen
      von <span class="trademark">Microsoft</span>® <span class="trademark">Windows</span>® keine Werte von Registern ändern in
      denen sie keine Werte zurückliefern.</p><p>Das bedeutet, dass wir <code class="varname">CL</code>
      nur einmal setzen müssen. Dafür haben wir ein neues
      Label <code class="varname">.loop</code> eingefügt, zu dem wir an
      Stelle von <code class="varname">_start</code> springen, um das
      nächste Byte einzulesen. Außerdem haben wir das Label
      <code class="varname">.hex</code> eingefügt, somit können wir
      wahlweise ein Leerzeichen oder einen Zeilenumbruch im dritten
      Byte von <code class="varname">buffer</code> ablegen.</p><p>Nachdem Sie <code class="filename">hex.asm</code> entsprechend der
      Neuerungen geändert haben, geben Sie Folgendes ein:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hex.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hex hex.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hex</code></strong>
<strong class="userinput"><code>Hello, World!</code></strong>
48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 0A
<strong class="userinput"><code>Here I come!</code></strong>
48 65 72 65 20 49 20 63 6F 6D 65 21 0A
<strong class="userinput"><code>^D</code></strong> <code class="prompt">%</code></pre><p>Das sieht doch schon besser aus. Aber der Code ist ziemlich
      ineffizient! Wir führen für jeden einzelne Byte
      zweimal einen Systemaufruf aus (einen zum Lesen und einen um es
      in die Ausgabe zu schreiben).</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-buffered-io"></a>11.8. Gepufferte Eingabe und Ausgabe</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Hagen</span> <span class="surname">Kühl</span></span>. </span></div></div></div><p>Wir können die Effizienz unseres Codes erhöhen,
      indem wir die Ein- und Ausgabe puffern. Wir erzeugen einen
      Eingabepuffer und lesen dann eine Folge von Bytes auf einmal.
      Danach holen wir sie Byte für Byte aus dem Puffer.</p><p>Wir erzeugen ebenfalls einen Ausgabepuffer. Darin speichern
      wir unsere Ausgabe bis er voll ist. Dann bitten wir den Kernel
      den Inhalt des Puffers nach <code class="filename">stdout</code> zu
      schreiben.</p><p>Diese Programm endet, wenn es keine weitere Eingaben gibt.
      Aber wir müssen den Kernel immernoch bitten den Inhalt des
      Ausgabepuffers ein letztes Mal nach <code class="filename">stdout</code>
      zu schreiben, denn sonst würde ein Teil der Ausgabe zwar im
      Ausgabepuffer landen, aber niemals ausgegeben werden. Bitte
      vergessen Sie das nicht, sonst fragen Sie sich später warum
      ein Teil Ihrer Ausgabe verschwunden ist.</p><pre class="programlisting">%include	'system.inc'

%define	BUFSIZE	2048

section	.data
hex	db	'0123456789ABCDEF'

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE

section	.text
global	_start
_start:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	mov	edi, obuffer

.loop:
	; read a byte from stdin
	call	getchar

	; convert it to hex
	mov	dl, al
	shr	al, 4
	mov	al, [hex+eax]
	call	putchar

	mov	al, dl
	and	al, 0Fh
	mov	al, [hex+eax]
	call	putchar

	mov	al, ' '
	cmp	dl, 0Ah
	jne	.put
	mov	al, dl

.put:
	call	putchar
	jmp	short .loop

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	ret

read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword stdin
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.done
	sub	eax, eax
	ret

align 4
.done:
	call	write		; flush output buffer
	push	dword 0
	sys.exit

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword stdout
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
	ret</pre><p>Als dritten Abschnitt im Quelltext haben wir
      <code class="varname">.bss</code>. Dieser Abschnitt wird nicht in unsere
      ausführbare Datei eingebunden und kann daher nicht
      initialisiert werden. Wir verwenden <code class="function">resb</code> anstelle von <code class="function">db</code>. Dieses reserviert einfach die
      angeforderte Menge an uninitialisiertem Speicher zu unserer
      Verwendung.</p><p>Wir nutzen, die Tatsache, dass das System die Register nicht
      verändert: Wir benutzen Register, wo wir anderenfalls
      globale Variablen im Abschnitt <code class="varname">.data</code>
      verwenden müssten. Das ist auch der Grund, warum die
      <span class="trademark">UNIX</span>®-Konvention, Parameter auf dem Stack zu übergeben,
      der von Microsoft, hierfür Register zu verwenden,
      überlegen ist: Wir können Register für unsere
      eigenen Zwecke verwenden.</p><p>Wir verwenden <code class="varname">EDI</code> und
      <code class="varname">ESI</code> als Zeiger auf das
      nächste zu lesende oder schreibende Byte. Wir verwenden
      <code class="varname">EBX</code> und <code class="varname">ECX</code>, um die Anzahl der Bytes in den
      beiden Puffern zu zählen, damit wir wissen, wann wir die
      Ausgabe an das System übergeben, oder neue Eingabe vom
      System entgegen nehmen müssen.</p><p>Lassen Sie uns sehen, wie es funktioniert:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hex.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hex hex.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hex</code></strong>
<strong class="userinput"><code>Hello, World!</code></strong>
<strong class="userinput"><code>Here I come!</code></strong>
48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 0A
48 65 72 65 20 49 20 63 6F 6D 65 21 0A
<strong class="userinput"><code>^D</code></strong> <code class="prompt">%</code></pre><p>Nicht was Sie erwartet haben? Das Programm hat die Ausgabe
      nicht auf dem Bildschirm ausgegeben bis sie
      <strong class="userinput"><code>^D</code></strong> gedrückt haben. Das kann man
      leicht zu beheben indem man drei Zeilen Code einfügt,
      welche die Ausgabe jedesmal schreiben, wenn wir einen
      Zeilenumbruch in <code class="constant">0A</code> umgewandelt haben. Ich
      habe die betreffenden Zeilen mit &gt; markiert (kopieren Sie die
      &gt; bitte nicht mit in Ihre
      <code class="filename">hex.asm</code>).</p><pre class="programlisting">%include    'system.inc'

%define	BUFSIZE	2048

section	.data
hex	db	'0123456789ABCDEF'

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE

section	.text
global	_start
_start:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	mov	edi, obuffer

.loop:
	; read a byte from stdin
	call	getchar

	; convert it to hex
	mov	dl, al
	shr	al, 4
	mov	al, [hex+eax]
	call	putchar

	mov	al, dl
	and	al, 0Fh
	mov	al, [hex+eax]
	call	putchar

	mov	al, ' '
	cmp	dl, 0Ah
	jne	.put
	mov	al, dl

.put:
	call	putchar
&gt;	cmp	al, 0Ah
&gt;	jne	.loop
&gt;	call	write
	jmp	short .loop

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	ret

read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword stdin
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.done
	sub	eax, eax
	ret

align 4
.done:
	call	write		; flush output buffer
	push	dword 0
	sys.exit

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword stdout
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
	ret</pre><p>Lassen Sie uns jetzt einen Blick darauf werfen, wie es
      funktioniert.</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hex.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hex hex.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hex</code></strong>
<strong class="userinput"><code>Hello, World!</code></strong>
48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 0A
<strong class="userinput"><code>Here I come!</code></strong>
48 65 72 65 20 49 20 63 6F 6D 65 21 0A
<strong class="userinput"><code>^D</code></strong> <code class="prompt">%</code></pre><p>Nicht schlecht für eine 644 Byte große
      Binärdatei, oder?</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Dieser Ansatz für gepufferte Ein- und Ausgabe
        enthält eine Gefahr, auf die ich im Abschnitt <a class="link" href="#x86-buffered-dark-side" title="11.12.1.1. Die dunkle Seite des Buffering">Die dunkle Seite des
        Buffering</a> eingehen werde.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-ungetc"></a>11.8.1. Ein Zeichen ungelesen machen</h3></div></div></div><div xmlns="" class="warning"><h3 class="admontitle">Warnung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Das ist vielleicht ein etwas fortgeschrittenes Thema,
	  das vor allem für Programmierer interessant ist, die
	  mit der Theorie von Compilern vertraut sind. Wenn Sie
	  wollen, können Sie <a class="link" href="#x86-command-line" title="11.9. Kommandozeilenparameter">zum
	  nächsten Abschnitt springen</a> und das hier
	  vielleicht später lesen.</p></div><p>Unser Beispielprogramm benötigt es zwar nicht, aber
	etwas anspruchsvollere Filter müssen häufig
	vorausschauen. Mit anderen Worten, sie müssen wissen was
	das nächste Zeichen ist (oder sogar mehrere Zeichen).
	Wenn das nächste Zeichen einen bestimmten Wert hat, ist
	es Teil des aktuellen Tokens, ansonsten nicht.</p><p>Zum Beispiel könnten Sie den Eingabestrom für
	eine Text-Zeichenfolge parsen (z.B. wenn Sie einen Compiler
	einer Sprache implementieren): Wenn einem Buchstaben ein
	anderer Buchstabe oder vielleicht eine Ziffer folgt, ist er
	ein Teil des Tokens, das Sie verarbeiten. Wenn ihm ein
	Leerzeichen folgt, oder ein anderer Wert, ist er nicht Teil
	des aktuellen Tokens.</p><p>Das führt uns zu einem interessanten Problem: Wie
	kann man ein Zeichen zurück in den Eingabestrom geben,
	damit es später noch einmal gelesen werden kann?</p><p>Eine mögliche Lösung ist, das Zeichen in einer
	Variable zu speichern und ein Flag zu setzen. Wir können
	<code class="function">getchar</code> so anpassen, dass es das Flag
	überprüft und, wenn es gesetzt ist, das Byte aus der
	Variable anstatt dem Eingabepuffer liest und das Flag
	zurück setzt. Aber natürlich macht uns das
	langsamer.</p><p>Die Sprache C hat eine Funktion
	<code class="function">ungetc()</code> für genau diesen Zweck.
	Gibt es einen schnellen Weg, diese in unserem Code zu
	implementieren? Ich möchte Sie bitten nach oben zu
	scrollen und sich die Prozedur <code class="function">getchar</code>
	anzusehen und zu versuchen eine schöne und schnelle
	Lösung zu finden, bevor Sie den nächsten Absatz
	lesen. Kommen Sie danach hierher zurück und schauen sich
	meine Lösung an.</p><p>Der Schlüssel dazu ein Zeichen an den Eingabestrom
	zurückzugeben, liegt darin, wie wir das Zeichen
	bekommen:</p><p>Als erstes überprüfen wir, ob der Puffer leer
	ist, indem wir den Wert von <code class="varname">EBX</code> testen. Wenn er null ist, rufen
	wir die Prozedur <code class="function">read</code> auf.</p><p>Wenn ein Zeichen bereit ist verwenden wir <code class="function">lodsb</code>, dann verringern wir den Wert
	von <code class="varname">EBX</code>. Die Anweisung
	<code class="function">lodsb</code> ist letztendlich
	identisch mit:</p><pre class="programlisting">	mov	al, [esi]
	  inc	esi</pre><p>Das Byte, welches wir abgerufen haben, verbleibt im Puffer
	bis <code class="function">read</code> zum nächsten Mal aufgerufen
	wird. Wir wissen nicht wann das passiert, aber wir wissen,
	dass es nicht vor dem nächsten Aufruf von
	<code class="function">getchar</code> passiert. Daher ist alles was wir
	tun müssen um das Byte in den Strom "zurückzugeben"
	ist den Wert von <code class="varname">ESI</code> zu
	verringern und den von <code class="varname">EBX</code>
	zu erhöhen:</p><pre class="programlisting">ungetc:
	  dec	esi
	  inc	ebx
	  ret</pre><p>Aber seien Sie vorsichtig! Wir sind auf der sicheren Seite,
	solange wir immer nur ein Zeichen im Voraus lesen. Wenn wir
	mehrere kommende Zeichen betrachten und
	<code class="function">ungetc</code> mehrmals hintereinander aufrufen,
	wird es meistens funktionieren, aber nicht immer (und es wird
	ein schwieriger Debug). Warum?</p><p>Solange <code class="function">getchar</code>
	<code class="function">read</code> nicht aufrufen muss, befinden sich
	alle im Voraus gelesenen Bytes noch im Puffer und
	<code class="function">ungetc</code> arbeitet fehlerfrei. Aber sobald
	<code class="function">getchar</code> <code class="function">read</code> aufruft
	verändert sich der Inhalt des Puffers.</p><p>Wir können uns immer darauf verlassen, dass
	<code class="function">ungetc</code> auf dem zuletzt mit
	<code class="function">getchar</code> gelesenen Zeichen korrekt
	arbeitet, aber nicht auf irgendetwas, das davor gelesen
	wurde.</p><p>Wenn Ihr Programm mehr als ein Byte im Voraus lesen soll,
	haben Sie mindestens zwei Möglichkeiten:</p><p>Die einfachste Lösung ist, Ihr Programm so zu
	ändern, dass es immer nur ein Byte im Voraus liest, wenn
	das möglich ist.</p><p>Wenn Sie diese Möglichkeit nicht haben, bestimmen Sie
	zuerst die maximale Anzahl an Zeichen, die Ihr Programm auf
	einmal an den Eingabestrom zurückgeben muss. Erhöhen
	Sie diesen Wert leicht, nur um sicherzugehen, vorzugsweise auf
	ein Vielfaches von 16&#8212;damit er sich schön
	ausrichtet. Dann passen Sie den <code class="varname">.bss</code>
	Abschnitt Ihres Codes an und erzeugen einen kleinen
	Reserver-Puffer, direkt vor ihrem Eingabepuffer, in etwa
	so:</p><pre class="programlisting">section	.bss
	  resb	16	; or whatever the value you came up with
  ibuffer	resb	BUFSIZE
  obuffer	resb	BUFSIZE</pre><p>Außerdem müssen Sie <code class="function">ungetc</code>
	anpassen, sodass es den Wert des Bytes, das zurückgegeben
	werden soll, in <code class="varname">AL</code>
	übergibt:</p><pre class="programlisting">ungetc:
	  dec	esi
	  inc	ebx
	  mov	[esi], al
	  ret</pre><p>Mit dieser Änderung können Sie sicher
	<code class="function">ungetc</code> bis zu 17 Mal hintereinander
	gqapaufrufen (der erste Aufruf erfolgt noch im Puffer, die
	anderen 16 entweder im Puffer oder in der Reserve).</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-command-line"></a>11.9. Kommandozeilenparameter</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Fabian</span> <span class="surname">Ruch</span></span>. </span></div></div></div><p>Unser <span class="application">hex</span>-Programm wird
      nützlicher, wenn es die Dateinamen der Ein- und Ausgabedatei
      über die Kommandozeile einlesen kann, d.h., wenn es
      Kommandozeilenparameter verarbeiten kann. Aber... Wo sind
      die?</p><p>Bevor ein <span class="trademark">UNIX</span>®-System ein Programm ausführt, legt es
      einige Daten auf dem Stack ab (<code class="function">push</code>) und springt dann an das
      <code class="varname">_start</code>-Label des Programms. Ja, ich sagte
      springen, nicht aufrufen. Das bedeutet, dass auf die Daten
      zugegriffen werden kann, indem <code class="varname">[esp+offset]</code>
      ausgelesen wird oder die Daten einfach vom Stack genommen werden
      (<code class="function">pop</code>).</p><p>Der Wert ganz oben auf dem Stack enthält die Zahl der
      Kommandozeilenparameter. Er wird traditionell
      <code class="varname">argc</code> wie "argument count" genannt.</p><p>Die Kommandozeilenparameter folgen einander, alle
      <code class="varname">argc</code>. Von diesen wird üblicherweise als
      <code class="varname">argv</code> wie "argument value(s)" gesprochen. So
      erhalten wir <code class="varname">argv[0]</code>,
      <code class="varname">argv[1]</code>, <code class="varname">...</code> und
      <code class="varname">argv[argc-1]</code>. Dies sind nicht die eigentlichen
      Parameter, sondern Zeiger (Pointer) auf diese, d.h.,
      Speicheradressen der tatsächlichen Parameter. Die Parameter
      selbst sind durch NULL beendete Zeichenketten.</p><p>Der <code class="varname">argv</code>-Liste folgt ein NULL-Zeiger, was
      einfach eine <code class="constant">0</code> ist. Es gibt noch mehr, aber
      dies ist erst einmal genug für unsere Zwecke.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Falls Sie von der
	<acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>-Programmierumgebung kommen, ist
	der größte Unterschied die Tatsache, dass jeder
	Parameter eine separate Zeichenkette ist. Der zweite
	Unterschied ist, dass es praktisch keine Grenze gibt, wie
	viele Parameter vorhanden sein können.</p></div><p>Ausgerüstet mit diesen Kenntnissen, sind wir beinahe
      bereit für eine weitere Version von
      <code class="filename">hex.asm</code>. Zuerst müssen wir jedoch
      noch ein paar Zeilen zu <code class="filename">system.inc</code>
      hinzufügen:</p><p>Erstens benötigen wir zwei neue Einträge in unserer
      Liste mit den Systemaufrufnummern:</p><pre class="programlisting">%define	SYS_open	5
%define	SYS_close	6</pre><p>Zweitens fügen wir zwei neue Makros am Ende der Datei
      ein:</p><pre class="programlisting">%macro	sys.open	0
	system	SYS_open
%endmacro

%macro	sys.close	0
	system	SYS_close
%endmacro</pre><p>Und hier ist schließlich unser veränderter
      Quelltext:</p><pre class="programlisting">%include	'system.inc'

%define	BUFSIZE	2048

section	.data
fd.in	dd	stdin
fd.out	dd	stdout
hex	db	'0123456789ABCDEF'

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE

section	.text
align 4
err:
	push	dword 1		; return failure
	sys.exit

align 4
global	_start
_start:
	add	esp, byte 8	; discard argc and argv[0]

	pop	ecx
	jecxz	.init		; no more arguments

	; ECX contains the path to input file
	push	dword 0		; O_RDONLY
	push	ecx
	sys.open
	jc	err		; open failed

	add	esp, byte 8
	mov	[fd.in], eax

	pop	ecx
	jecxz	.init		; no more arguments

	; ECX contains the path to output file
	push	dword 420	; file mode (644 octal)
	push	dword 0200h | 0400h | 01h
	; O_CREAT | O_TRUNC | O_WRONLY
	push	ecx
	sys.open
	jc	err

	add	esp, byte 12
	mov	[fd.out], eax

.init:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	mov	edi, obuffer

.loop:
	; read a byte from input file or stdin
	call	getchar

	; convert it to hex
	mov	dl, al
	shr	al, 4
	mov	al, [hex+eax]
	call	putchar

	mov	al, dl
	and	al, 0Fh
	mov	al, [hex+eax]
	call	putchar

	mov	al, ' '
	cmp	dl, 0Ah
	jne	.put
	mov	al, dl

.put:
	call	putchar
	cmp	al, dl
	jne	.loop
	call	write
	jmp	short .loop

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	ret

read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword [fd.in]
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.done
	sub	eax, eax
	ret

align 4
.done:
	call	write		; flush output buffer

	; close files
	push	dword [fd.in]
	sys.close

	push	dword [fd.out]
	sys.close

	; return success
	push	dword 0
	sys.exit

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword [fd.out]
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
	ret</pre><p>In unserem <code class="varname">.data</code>-Abschnitt befinden
      sich nun die zwei neuen Variablen <code class="varname">fd.in</code> und
      <code class="varname">fd.out</code>. Hier legen wir die Dateideskriptoren
      der Ein- und Ausgabedatei ab.</p><p>Im <code class="varname">.text</code>-Abschnitt haben wir die
      Verweise auf <code class="varname">stdin</code> und
      <code class="varname">stdout</code> durch <code class="varname">[fd.in]</code> und
      <code class="varname">[fd.out]</code> ersetzt.</p><p>Der <code class="varname">.text</code>-Abschnitt beginnt nun mit
      einer einfachen Fehlerbehandlung, welche nur das Programm mit
      einem Rückgabewert von <code class="constant">1</code> beendet. Die
      Fehlerbehandlung befindet sich vor <code class="varname">_start</code>,
      sodass wir in geringer Entfernung von der Stelle sind, an der
      der Fehler auftritt.</p><p>Selbstverständlich beginnt die
      Programmausführung immer noch bei
      <code class="varname">_start</code>. Zuerst entfernen wir
      <code class="varname">argc</code> und <code class="varname">argv[0]</code> vom
      Stack: Sie sind für uns nicht von Interesse (sprich, in
      diesem Programm).</p><p>Wir nehmen <code class="varname">argv[1]</code> vom Stack und legen
      es in <code class="varname">ECX</code> ab. Dieses Register
      ist besonders für Zeiger geeignet, da wir mit <code class="function">jecxz</code> NULL-Zeiger verarbeiten
      können. Falls <code class="varname">argv[1]</code> nicht NULL ist,
      versuchen wir, die Datei zu öffnen, die der erste Parameter
      festlegt. Andernfalls fahren wir mit dem Programm fort wie
      vorher: Lesen von <code class="varname">stdin</code> und Schreiben nach
      <code class="varname">stdout</code>. Falls wir die Eingabedatei nicht
      öffnen können (z.B. sie ist nicht vorhanden), springen
      wir zur Fehlerbehandlung und beenden das Programm.</p><p>Falls es keine Probleme gibt, sehen wir nun nach dem
      zweiten Parameter. Falls er vorhanden ist, öffnen wir die
      Ausgabedatei. Andernfalls schreiben wir die Ausgabe nach
      <code class="varname">stdout</code>. Falls wir die Ausgabedatei nicht
      öffnen können (z.B. sie ist zwar vorhanden, aber wir
      haben keine Schreibberechtigung), springen wir auch wieder in
      die Fehlerbehandlung.</p><p>Der Rest des Codes ist derselbe wie vorher, außer
      dem Schließen der Ein- und Ausgabedatei vor dem Verlassen
      des Programms und, wie bereits erwähnt, die Benutzung von
      <code class="varname">[fd.in]</code> und
      <code class="varname">[fd.out]</code>.</p><p>Unsere Binärdatei ist nun kolossale 768 Bytes
      groß.</p><p>Können wir das Programm immer noch verbessern?
      Natürlich! Jedes Programm kann verbessert werden. Hier
      finden sich einige Ideen, was wir tun könnten:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Die Fehlerbehandlung eine Warnung auf
	  <code class="varname">stderr</code> ausgeben lassen.</p></li><li class="listitem"><p>Den <code class="function">Lese</code>- und
	  <code class="function">Schreib</code>funkionen eine Fehlerbehandlung
	  hinzufügen.</p></li><li class="listitem"><p>Schließen von <code class="varname">stdin</code>, sobald wir
	  eine Eingabedatei öffnen, von <code class="varname">stdout</code>,
	  sobald wir eine Ausgabedatei öffnen.</p></li><li class="listitem"><p>Hinzufügen von Kommandozeilenschaltern wie zum
	  Beispiel <em class="parameter"><code>-i</code></em> und
	  <em class="parameter"><code>-o</code></em>, sodass wir die Ein- und
	  Ausgabedatei in irgendeiner Reihenfolge angeben oder
	  vielleicht von <code class="varname">stdin</code> lesen und in eine
	  Datei schreiben können.</p></li><li class="listitem"><p>Ausgeben einer Gebrauchsanweisung, falls die
	  Kommandozeilenparameter fehlerhaft sind.</p></li></ul></div><p>Ich beabsichtige, diese Verbesserungen dem Leser als
      Übung zu hinterlassen: Sie wissen bereits alles, das Sie
      wissen müssen, um die Verbesserungen
      durchzuführen.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-environment"></a>11.10. Die <span class="trademark">UNIX</span>®-Umgebung</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Fabian</span> <span class="surname">Ruch</span></span>. </span></div></div></div><p>Ein entscheidendes Konzept hinter <span class="trademark">UNIX</span>® ist die Umgebung,
      die durch <span class="emphasis"><em>Umgebungsvariablen</em></span> festgelegt
      wird. Manche werden vom System gesetzt, andere von Ihnen und
      wieder andere von der <span class="application">shell</span> oder
      irgendeinem Programm, das ein anderes lädt.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-find-environment"></a>11.10.1. Umgebungsvariablen herausfinden</h3></div></div></div><p>Ich sagte vorher, dass wenn ein Programm mit der
	Ausführung beginnt, der Stack <code class="varname">argc</code>
	gefolgt vom durch NULL beendeten <code class="varname">argv</code>-Array
	und etwas Anderem enthält. Das "etwas Andere" ist die
	<span class="emphasis"><em>Umgebung</em></span> oder, um genauer zu sein, ein
	durch NULL beendetes Array von Zeigern auf
	<span class="emphasis"><em>Umgebungsvariablen</em></span>. Davon wird oft als
	<code class="varname">env</code> gesprochen.</p><p>Der Aufbau von <code class="varname">env</code> entspricht dem von
	<code class="varname">argv</code>, eine Liste von Speicheradressen gefolgt
	von NULL (<code class="constant">0</code>). In diesem Fall gibt es kein
	<code class="varname">"envc"</code>&#8212;wir finden das Ende heraus,
	indem wir nach dem letzten NULL suchen.</p><p>Die Variablen liegen normalerweise in der Form
	<code class="varname">name=value</code> vor, aber manchmal kann der
	<code class="varname">=value</code>-Teil fehlen. Wir müssen diese
	Möglichkeit in Betracht ziehen.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-webvar"></a>11.10.2. webvars</h3></div></div></div><p>Ich könnte Ihnen einfach etwas Code zeigen, der die
	Umgebung in der Art vom <span class="trademark">UNIX</span>®-Befehl
	<span class="application">env</span> ausgibt. Aber ich dachte, dass es
	interessanter sei, ein einfaches CGI-Werkzeug in Assembler zu
	schreiben.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-cgi"></a>11.10.2.1. CGI: Ein kurzer Überblick</h4></div></div></div><p>Ich habe eine <a class="link" href="http://www.whizkidtech.redprince.net/cgi-bin/tutorial" target="_top">detaillierte
	  <acronym class="acronym">CGI</acronym>-Anleitung</a> auf meiner Webseite,
	  aber hier ist ein sehr kurzer Überblick über
	  <acronym class="acronym">CGI</acronym>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Der Webserver kommuniziert mit dem
	      <acronym class="acronym">CGI</acronym>-Programm, indem er
	      <span class="emphasis"><em>Umgebungsvariablen</em></span> setzt.</p></li><li class="listitem"><p>Das <acronym class="acronym">CGI</acronym>-Programm schreibt seine
	      Ausgabe auf <code class="filename">stdout</code>. Der Webserver
	      liest von da.</p></li><li class="listitem"><p>Die Ausgabe muss mit einem
	      <acronym class="acronym">HTTP</acronym>-Kopfteil gefolgt von zwei
	      Leerzeilen beginnen.</p></li><li class="listitem"><p>Das Programm gibt dann den
	      <acronym class="acronym">HTML</acronym>-Code oder was für einen
	      Datentyp es auch immer verarbeitet
	      aus.</p></li><li class="listitem"><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Während bestimmte
		<span class="emphasis"><em>Umgebungsvariablen</em></span> Standardnamen
		benutzen, unterscheiden sich andere, abhängig vom
		Webserver. Dies macht <span class="application">webvars</span>
		zu einem recht nützlichen Werkzeug.</p></div></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-webvars-the-code"></a>11.10.2.2. Der Code</h4></div></div></div><p>Unser <span class="application">webvars</span>-Programm muss
	  also den <acronym class="acronym">HTTP</acronym>-Kopfteil gefolgt von etwas
	  <acronym class="acronym">HTML</acronym>-Auszeichnung versenden. Dann muss es
	  die <span class="emphasis"><em>Umgebungsvariablen</em></span> eine nach der
	  anderen auslesen und sie als Teil der
	  <acronym class="acronym">HTML</acronym>-Seite versenden.</p><p>Nun der Code. Ich habe Kommentare und Erklärungen
	  direkt in den Code eingefügt:</p><pre class="programlisting">
;;;;;;; webvars.asm ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; Copyright (c) 2000 G. Adam Stanislav
; All rights reserved.
;
; Redistribution and use in source and binary forms, with or without
; modification, are permitted provided that the following conditions
; are met:
; 1. Redistributions of source code must retain the above copyright
;    notice, this list of conditions and the following disclaimer.
; 2. Redistributions in binary form must reproduce the above copyright
;    notice, this list of conditions and the following disclaimer in the
;    documentation and/or other materials provided with the distribution.
;
; THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
; ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
; SUCH DAMAGE.
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; Version 1.0
;
; Started:	 8-Dec-2000
; Updated:	 8-Dec-2000
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
%include	'system.inc'

section	.data
http	db	'Content-type: text/html', 0Ah, 0Ah
	db	'&lt;?xml version="1.0" encoding="utf-8"?&gt;', 0Ah
	db	'&lt;!DOCTYPE html PUBLIC "-//W3C/DTD XHTML Strict//EN" '
	db	'"DTD/xhtml1-strict.dtd"&gt;', 0Ah
	db	'&lt;html xmlns="http://www.w3.org/1999/xhtml" '
	db	'xml.lang="en" lang="en"&gt;', 0Ah
	db	'&lt;head&gt;', 0Ah
	db	'&lt;title&gt;Web Environment&lt;/title&gt;', 0Ah
	db	'&lt;meta name="author" content="G. Adam Stanislav" /&gt;', 0Ah
	db	'&lt;/head&gt;', 0Ah, 0Ah
	db	'&lt;body bgcolor="#ffffff" text="#000000" link="#0000ff" '
	db	'vlink="#840084" alink="#0000ff"&gt;', 0Ah
	db	'&lt;div class="webvars"&gt;', 0Ah
	db	'&lt;h1&gt;Web Environment&lt;/h1&gt;', 0Ah
	db	'&lt;p&gt;The following &lt;b&gt;environment variables&lt;/b&gt; are defined '
	db	'on this web server:&lt;/p&gt;', 0Ah, 0Ah
	db	'&lt;table align="center" width="80" border="0" cellpadding="10" '
	db	'cellspacing="0" class="webvars"&gt;', 0Ah
httplen	equ	$-http
left	db	'&lt;tr&gt;', 0Ah
	db	'&lt;td class="name"&gt;&lt;tt&gt;'
leftlen	equ	$-left
middle	db	'&lt;/tt&gt;&lt;/td&gt;', 0Ah
	db	'&lt;td class="value"&gt;&lt;tt&gt;&lt;b&gt;'
midlen	equ	$-middle
undef	db	'&lt;i&gt;(undefined)&lt;/i&gt;'
undeflen	equ	$-undef
right	db	'&lt;/b&gt;&lt;/tt&gt;&lt;/td&gt;', 0Ah
	db	'&lt;/tr&gt;', 0Ah
rightlen	equ	$-right
wrap	db	'&lt;/table&gt;', 0Ah
	db	'&lt;/div&gt;', 0Ah
	db	'&lt;/body&gt;', 0Ah
	db	'&lt;/html&gt;', 0Ah, 0Ah
wraplen	equ	$-wrap

section	.text
global	_start
_start:
	; First, send out all the http and xhtml stuff that is
	; needed before we start showing the environment
	push	dword httplen
	push	dword http
	push	dword stdout
	sys.write

	; Now find how far on the stack the environment pointers
	; are. We have 12 bytes we have pushed before "argc"
	mov	eax, [esp+12]

	; We need to remove the following from the stack:
	;
	;	The 12 bytes we pushed for sys.write
	;	The  4 bytes of argc
	;	The EAX*4 bytes of argv
	;	The  4 bytes of the NULL after argv
	;
	; Total:
	;	20 + eax * 4
	;
	; Because stack grows down, we need to ADD that many bytes
	; to ESP.
	lea	esp, [esp+20+eax*4]
	cld		; This should already be the case, but let's be sure.

	; Loop through the environment, printing it out
.loop:
	pop	edi
	or	edi, edi	; Done yet?
	je	near .wrap

	; Print the left part of HTML
	push	dword leftlen
	push	dword left
	push	dword stdout
	sys.write

	; It may be tempting to search for the '=' in the env string next.
	; But it is possible there is no '=', so we search for the
	; terminating NUL first.
	mov	esi, edi	; Save start of string
	sub	ecx, ecx
	not	ecx		; ECX = FFFFFFFF
	sub	eax, eax
repne	scasb
	not	ecx		; ECX = string length + 1
	mov	ebx, ecx	; Save it in EBX

	; Now is the time to find '='
	mov	edi, esi	; Start of string
	mov	al, '='
repne	scasb
	not	ecx
	add	ecx, ebx	; Length of name

	push	ecx
	push	esi
	push	dword stdout
	sys.write

	; Print the middle part of HTML table code
	push	dword midlen
	push	dword middle
	push	dword stdout
	sys.write

	; Find the length of the value
	not	ecx
	lea	ebx, [ebx+ecx-1]

	; Print "undefined" if 0
	or	ebx, ebx
	jne	.value

	mov	ebx, undeflen
	mov	edi, undef

.value:
	push	ebx
	push	edi
	push	dword stdout
	sys.write

	; Print the right part of the table row
	push	dword rightlen
	push	dword right
	push	dword stdout
	sys.write

	; Get rid of the 60 bytes we have pushed
	add	esp, byte 60

	; Get the next variable
	jmp	.loop

.wrap:
	; Print the rest of HTML
	push	dword wraplen
	push	dword wrap
	push	dword stdout
	sys.write

	; Return success
	push	dword 0
	sys.exit</pre><p>Dieser Code erzeugt eine 1.396-Byte große
	  Binärdatei. Das meiste davon sind Daten, d.h., die
	  <acronym class="acronym">HTML</acronym>-Auszeichnung, die wir versenden
	  müssen.</p><p>Assemblieren Sie es wie immer:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf webvars.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o webvars webvars.o</code></strong></pre><p>Um es zu benutzen, müssen Sie
	  <code class="filename">webvars</code> auf Ihren Webserver hochladen.
	  Abhängig von Ihrer Webserver-Konfiguration, müssen
	  Sie es vielleicht in einem speziellen
	  <code class="filename">cgi-bin</code>-Verzeichnis ablegen oder es mit
	  einer <code class="filename">.cgi</code>-Dateierweiterung
	  versehen.</p><p>Schließlich benötigen Sie Ihren Webbrowser,
	  um sich die Ausgabe anzusehen. Um die Ausgabe auf meinem
	  Webserver zu sehen, gehen Sie bitte auf <a class="link" href="http://www.int80h.org/webvars/" target="_top"><code class="filename">http://www.int80h.org/webvars/</code></a>.
	  Falls Sie neugierig sind, welche zusätzlichen Variablen
	  in einem passwortgeschützten Webverzeichnis vorhanden
	  sind, gehen Sie auf <a class="link" href="http://www.int80h.org/private/" target="_top"><code class="filename">http://www.int80h.org/private/</code></a>
	  unter Benutzung des Benutzernamens <strong class="userinput"><code>asm</code></strong>
	  und des Passworts <strong class="userinput"><code>programmer</code></strong>.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-files"></a>11.11. Arbeiten mit Dateien</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Paul</span> <span class="surname">Keller</span></span> und <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Fabian</span> <span class="surname">Borschel</span></span>. </span></div></div></div><p>Wir haben bereits einfache Arbeiten mit Dateien gemacht:
      Wir wissen wie wir sie öffnen und schliessen, oder wie
      man sie mit Hilfe von Buffern liest und schreibt. Aber <span class="trademark">UNIX</span>®
      bietet viel mehr Funktionalität wenn es um Dateien geht.
      Wir werden einige von ihnen in dieser Sektion untersuchen und
      dann mit einem netten Datei Konvertierungs Werkzeug
      abschliessen.</p><p>In der Tat, Lasst uns am Ende beginnen, also mit dem Datei
      Konvertierungs Werkzeug. Es macht Programmieren immer einfacher,
      wenn wir bereits am Anfang wissen was das End Produkt bezwecken
      soll.</p><p>Eines der ersten Programme die ich für <span class="trademark">UNIX</span>® schrieb
      war <a class="link" href="ftp://ftp.int80h.org/unix/tuc/" target="_top"><span class="application">
      tuc</span></a>, ein Text-Zu-<span class="trademark">UNIX</span>® Datei Konvertierer.
      Es konvertiert eine Text Datei von einem anderen Betriebssystem
      zu einer <span class="trademark">UNIX</span>® Text Datei. Mit anderen Worten, es ändert
      die verschiedenen Arten von Zeilen Begrenzungen zu der Zeilen
      Begrenzungs Konvention von <span class="trademark">UNIX</span>®. Es speichert die Ausgabe in
      einer anderen Datei. Optional konvertiert es eine <span class="trademark">UNIX</span>® Text
      Datei zu einer <acronym class="acronym">DOS</acronym> Text Datei.</p><p>Ich habe <span class="application">tuc</span> sehr oft benutzt,
      aber nur von irgendeinem anderen <acronym class="acronym">OS</acronym> nach
      <span class="trademark">UNIX</span>® zu konvertieren, niemals anders herum. Ich habe mir immer
      gewünscht das die Datei einfach überschrieben wird
      anstatt das ich die Ausgabe in eine andere Datei senden muss.
      Meistens, habe ich diesen Befehl verwendet:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>tuc myfile tempfile</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>mv tempfile myfile</code></strong></pre><p>Es wäre schö ein  <span class="application">ftuc</span>
      zu haben, also, <span class="emphasis"><em>fast tuc</em></span>, und es so zu
      benutzen:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ftuc myfile</code></strong></pre><p>In diesem Kapitel werden wir dann, <span class="application">ftuc
      </span> in Assembler schreiben (das Original
      <span class="application">tuc</span> ist in C), und verschiedene
      Datei-Orientierte Kernel Dienste in dem Prozess studieren.</p><p>Auf erste Sicht, ist so eine Datei Konvertierung sehr
      simpel: Alles was du zu tun hast, ist die Wagenrückläufe
      zu entfernen, richtig?</p><p>Wenn du mit ja geantwortet hast, denk nochmal darüber
      nach: Dieses Vorgehen wird die meiste Zeit funktionieren
      (zumindest mit <acronym class="acronym">MSDOS</acronym> Text Dateien), aber
      gelegentlich fehlschlagen.</p><p>Das Problem ist das nicht alle <span class="trademark">UNIX</span>® Text Dateien ihre
      Zeilen mit einer Wagen Rücklauf / Zeilenvorschub Sequenz
      beenden. Manche benutzen Wagenrücklauf ohne Zeilenvorschub.
      Andere kombinieren mehrere leere Zeilen in einen einzigen
      Wagenrücklauf gefolgt von mehreren Zeilenvorschüben.
      Und so weiter.</p><p>Ein Text Datei Konvertierer muss dann also in der Lage sein
      mit allen möglichen Zeilenenden umzugehen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Wagenrücklauf / Zeilenvorschub</p></li><li class="listitem"><p>Wagenrücklauf</p></li><li class="listitem"><p>Zeilenvorschub / Wagenrücklauf</p></li><li class="listitem"><p>Zeilenvorschub</p></li></ul></div><p>Es sollte außerdem in der Lage sein mit Dateien
      umzugehen die irgendeine Art von Kombination der oben stehenden
      Möglichkeiten verwendet. (z.B., Wagenrücklauf gefolgt
      von mehreren Zeilenvorschüben).</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-finite-state-machine"></a>11.11.1. Endlicher Zustandsautomat</h3></div></div></div><p>Das Problem wird einfach gelöst in dem man eine
	Technik benutzt die sich <span class="emphasis"><em>Endlicher
	Zustandsautomat</em></span> nennt, ursprünglich wurde sie
	von den Designern digitaler elektronischer Schaltkreise
	entwickelt. Eine <span class="emphasis"><em>Endlicher Zustandsautomat</em></span>
	ist ein digitaler Schaltkreis dessen Ausgabe nicht nur von der
	Eingabe abhängig ist sondern auch von der vorherigen
	Eingabe, d.h., von seinem Status. Der Mikroprozessor ist ein
	Beispiel für einen <span class="emphasis"><em>Endlichen Zustandsautomaten
	</em></span>: Unser Assembler Sprach Code wird zu
	Maschinensprache übersetzt in der manche Assembler Sprach
	Codes ein einzelnes Byte produzieren, während andere
	mehrere Bytes produzieren. Da der Microprozessor die Bytes
	einzeln aus dem Speicher liest, ändern manche nur seinen
	Status anstatt eine Ausgabe zu produzieren. Wenn alle Bytes
	eines OP Codes gelesen wurden, produziert der Mikroprozessor
	eine Ausgabe, oder ändert den Wert eines Registers,
	etc.</p><p>Aus diesem Grund, ist jede Software eigentlich nur eine
	Sequenz von Status Anweisungen für den Mikroprozessor.
	Dennoch, ist das Konzept eines <span class="emphasis"><em>Endlichen
	Zustandsautomaten</em></span> auch im Software Design sehr
	hilfreich.</p><p>Unser Text Datei Konvertierer kann als
	<span class="emphasis"><em>Endlicher Zustandsautomat</em></span> mit 3
	möglichen Stati desgined werden. Wir könnten diese
	von 0-2 benennen, aber es wird uns das Leben leichter machen
	wenn wir ihnen symbolische Namen geben:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="symbol">ordinary</span></p></li><li class="listitem"><p><span class="symbol">cr</span></p></li><li class="listitem"><p><span class="symbol">lf</span></p></li></ul></div><p>Unser Programm wird in dem <span class="symbol">ordinary</span> Status
	starten. Während dieses Status, hängt die Aktion des
	Programms von seiner Eingabe wie folgt ab:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Wenn die Eingabe etwas anderes als ein
	    Wagenrücklauf oder einem Zeilenvorschub ist, wird die
	    Eingabe einfach nur an die Ausgabe geschickt. Der Status
	    bleibt unverändert.</p></li><li class="listitem"><p>Wenn die Eingabe ein Wagenrücklauf ist, wird der
	    Status auf <span class="symbol">cr</span> gesetzt. Die Eingabe wird
	    dann verworfen, d.h., es entsteht keine Ausgabe.</p></li><li class="listitem"><p>Wenn die Eingabe ein Zeilenvorschub ist, wird der
	    Status auf <span class="symbol">lf</span> gesetzt. Die Eingabe wird
	    dann verworfen.</p></li></ul></div><p>Wann immer wir in dem <span class="symbol">cr</span> Status sind,
	ist das weil die letzte Eingabe ein Wagenrücklauf war,
	welcher nicht verarbeitet wurde. Was unsere Software in
	diesem Status macht hängt von der aktuellen Eingabe
	ab:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Wenn die Eingabe irgendetwas anderes als ein
	    Wagenrücklauf oder ein Zeilenvorschub ist, dann gib
	    einen Zeilenvorschub aus, dann gib die Eingabe aus und
	    dann ändere den Status zu
	    <span class="symbol">ordinary</span>.</p></li><li class="listitem"><p>Wenn die Eingabe ein Wagenrücklauf ist, haben
	    wir zwei (oder mehr) Wagenrückläufe in einer
	    Reihe. Wir verwerfen die Eingabe, wir geben einen
	    Zeilenvorschub aus und lassen den Status
	    unverändert.</p></li><li class="listitem"><p>Wenn die Eingabe ein Zeilenvorschub ist, geben wir
	    den Zeilenvorschub aus und ändern den Status zu
	    <span class="symbol">ordinary</span>. Achte darauf, dass das nicht
	    das gleiche wie in dem Fall oben drüber ist &#8211;
	    würden wir versuchen beide zu kombinieren,
	    würden wir zwei Zeilenvorschübe anstatt einen
	    ausgeben.</p></li></ul></div><p>Letztendlich, sind wir in dem <span class="symbol">lf</span> Status
	nachdem wir einen Zeilenvorschub empfangen haben der nicht
	nach einem Wagenrücklauf kam. Das wird passieren wenn
	unsere Datei bereits im <span class="trademark">UNIX</span>® Format ist, oder jedesmal wenn
	mehrere Zeilen in einer Reihe durch einen einzigen
	Wagenrücklauf gefolgt von mehreren Zeilenvorschüben
	ausgedrückt wird, oder wenn die Zeile mit einer
	Zeilenvorschub / Wagenrücklauf Sequenz endet. Wir
	sollten mit unserer Eingabe in diesem Status folgendermaßen
	umgehen:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Wenn die Eingabe irgendetwas anderes als ein
	    Wagenrücklauf oder ein Zeilenvorschub ist, geben wir
	    einen Zeilenvorschub aus, geben dann  die Eingabe aus und
	    ändern dann den Status zu <span class="symbol">ordinary</span>.
	    Das ist exakt die gleiche Aktion wie in dem
	    <span class="symbol">cr</span> Status nach dem Empfangen der selben
	    Eingabe.</p></li><li class="listitem"><p>Wenn die Eingabe ein Wagenrücklauf ist, verwerfen
	    wir die Eingabe, geben einen Zeilenvorschub aus und
	    ändern dann den Status zu <span class="symbol">ordinary</span>.
	    </p></li><li class="listitem"><p>Wenn die Eingabe ein Zeilenvorschub ist, geben wir den
	    Zeilenvorschub aus und lassen den Status unverändert.
	    </p></li></ul></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-final-state"></a>11.11.1.1. Der Endgültige Status</h4></div></div></div><p>Der obige <span class="emphasis"><em>Endliche Zustandsautomat</em></span>
	  funktioniert für die gesamte Datei, aber lässt die
	  Möglichkeit das die letzte Zeile ignoriert wird. Das
	  wird jedesmal passieren wenn die Datei mit einem einzigen
	  Wagenrücklauf oder einem einzigen Zeilenvorschub endet.
	  Daran habe ich nicht gedacht als ich
	  <span class="application">tuc</span> schrieb, nur um festzustellen,
	  daß das letzte Zeilenende gelegentlich weggelassen
	  wird.</p><p>Das Problem wird einfach dadurch gelöst, indem man
	  den Status überprüft nachdem die gesamte Datei
	  verarbeitet wurde. Wenn der Status nicht
	  <span class="symbol">ordinary</span> ist, müssen wir nur den
	  letzten Zeilenvorschub ausgeben.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Nachdem wir unseren Algorithmus nun als einen
	    <span class="emphasis"><em>Endlichen Zustandsautomaten</em></span> formuliert
	    haben, könnten wir einfach einen festgeschalteten
	    digitalen elektronischen Schaltkreis (einen "Chip")
	    designen, der die Umwandlung für uns übernimmt.
	    Natürlich wäre das sehr viel teurer, als ein
	    Assembler Programm zu schreiben.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-tuc-counter"></a>11.11.1.2. Der Ausgabe Zähler</h4></div></div></div><p>Weil unser Datei Konvertierungs Programm
	  möglicherweise zwei Zeichen zu einem kombiniert,
	  müssen wir einen Ausgabe Zähler verwenden. Wir
	  initialisieren den Zähler zu <code class="constant">0</code>
	  und erhöhen ihn jedes mal wenn wir ein Zeichen an die
	  Ausgabe schicken. Am Ende des Programms, wird der
	  Zähler uns sagen auf welche Grösse wir die Datei
	  setzen müssen.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-software-fsm"></a>11.11.2. Implementieren von EZ als Software</h3></div></div></div><p>Der schwerste Teil beim arbeiten mit einer
	<span class="emphasis"><em>Endlichen Zustandsmaschine</em></span> ist das
	analysieren des Problems und dem ausdrücken als eine
	<span class="emphasis"><em>Endliche Zustandsmaschine</em></span>. That geschafft,
	schreibt sich die Software fast wie von selbst.</p><p>In eine höheren Sprache, wie etwa C, gibt es mehrere
	Hauptansätze. Einer wäre ein <code class="function">switch</code> Angabe zu verwenden die
	auswählt welche Funktion genutzt werden soll. Zum
	Beispiel,</p><pre class="programlisting">
	switch (state) {
	default:
	case REGULAR:
		regular(inputchar);
		break;
	case CR:
		cr(inputchar);
		break;
	case LF:
		lf(inputchar);
		break;
	}
      </pre><p>Ein anderer Ansatz ist es ein Array von Funktions Zeigern
	zu benutzen, etwa wie folgt:</p><pre class="programlisting">
	(output[state])(inputchar);
      </pre><p>Noch ein anderer ist es aus <code class="varname">state</code> einen
	Funktions Zeiger zu machen und ihn zu der entsprechenden
	Funktion zeigen zu lassen:</p><pre class="programlisting">
	(*state)(inputchar);
      </pre><p>Das ist der Ansatz den wir in unserem Programm verwenden
	werden, weil es in Assembler sehr einfach und schnell geht.
	Wir werden einfach die Adresse der Prozedur in <code class="varname">EBX</code> speichern und dann einfach das
	ausgeben:</p><pre class="programlisting">
	call	ebx
      </pre><p>Das ist wahrscheinlich schneller als die Adresse im Code
	zu hardcoden weil der Mikroprozessor die Adresse nicht aus dem
	Speicher lesen muss&#8212;es ist bereits in einer der Register
	gespeichert. Ich sagte <span class="emphasis"><em>wahrscheinlich</em></span>
	weil durch das Cachen neuerer Mikroprozessoren beide Varianten
	in etwa gleich schnell sind.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="memory-mapped-files"></a>11.11.3. Speicher abgebildete Dateien</h3></div></div></div><p>Weil unser Programm nur mit einzelnen Dateien
	funktioniert, können wir nicht den Ansatz verwedenden der
	zuvor funktioniert hat, d.h., von einer Eingabe Datei zu lesen
	und in eine Ausgabe Datei zu schreiben.</p><p><span class="trademark">UNIX</span>® erlaubt es uns eine Datei, oder einen Bereich einer
	Datei, in den Speicher abzubilden. Um das zu tun, müssen
	wir zuerst eine Datei mit den entsprechenden Lese/Schreib
	Flags öffnen. Dann benutzen wir den <code class="function">mmap</code> system call um sie in den
	Speicher abzubilden. Ein Vorteil von <code class="function">mmap</code> ist, das es automatisch mit
	virtuellem Speicher arbeitet: Wir können mehr von der
	Datei im Speicher abbilden als wir überhaupt
	physikalischen Speicher zur Verfügung haben, noch immer
	haben wir aber durch normale OP Codes wie <code class="function">mov</code>, <code class="function">lods</code>, und <code class="function">stos</code> Zugriff darauf. Egal welche
	Änderungen wir an dem Speicherabbild der Datei vornehmen,
	sie werden vom System in die Datei geschrieben. Wir
	müssen die Datei nicht offen lassen: So lange sie
	abgebildet bleibt, können wir von ihr lesen und in sie
	schreiben.</p><p>Ein 32-bit Intel Mikroprozessor kann auf bis zu vier
	Gigabyte Speicher zugreifen &#8211; physisch oder virtuell.
	Das FreeBSD System erlaubt es uns bis zu der Hälfte
	für die Datei Abbildung zu verwenden.</p><p>Zur Vereinfachung, werden wir in diesem Tutorial nur
	Dateien konvertieren die in ihrere Gesamtheit im Speicher
	abgebildet werden können. Es gibt wahrscheinlich nicht
	all zu viele Text Dateien die eine Grösse von zwei
	Gigabyte überschreiben. Falls unser Programm doch auf
	eine trifft, wird es einfach eine Meldung anzeigen mit dem
	Vorschlag das originale <span class="application">tuc</span> statt
	dessen zu verwenden.</p><p>Wenn du deine Kopie von
	<code class="filename">syscalls.master</code> überprüfst,
	wirst du zwei verschiedene Systemaufrufe
	finden die sich <code class="function">mmap</code>
	nennen. Das kommt von der Entwicklung von <span class="trademark">UNIX</span>®: Es gab das
	traditionelle <acronym class="acronym">BSD</acronym> <code class="function">mmap</code>, Systemaufruf 71. Dieses wurde
	durch das <acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> <code class="function">mmap</code> ersetzt, Systemaufruf 197. Das
	FreeBSD System unterstützt beide, weil ältere
	Programme mit der originalen <acronym class="acronym">BSD</acronym> Version
	geschrieben wurden. Da neue Software die
	<acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> Version nutzt, werden wir diese
	auch verwenden.</p><p>Die <code class="filename">syscalls.master</code> Datei zeigt die
	<acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> Version wie folgt:</p><pre class="programlisting">
197	STD	BSD	{ caddr_t mmap(caddr_t addr, size_t len, int prot, \
			    int flags, int fd, long pad, off_t pos); }
      </pre><p>Das weicht etwas von dem ab was
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mmap&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">mmap</span>(2)</span></a> sagt. Das ist weil
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mmap&amp;sektion=2"><span class="citerefentry"><span class="refentrytitle">mmap</span>(2)</span></a> die C Version
	beschreibt.</p><p>Der Unterschiede liegt in dem <code class="varname">long pad</code>
	Argument, welches in der C Version nicht vorhanden ist. Wie
	auch immer, der FreeBSD Systemaufruf fügt einen 32-bit
	Block ein nachdem es ein 64-Bit Argument auf den Stack
	ge<code class="function">push</code>t hat. In diesem
	Fall, ist <code class="varname">off_t</code> ein 64-Bit Wert.</p><p>Wenn wir fertig sind mit dem Arbeiten einer im Speicher
	abgebildeten Datei, entfernen wir das Speicherabbild mit dem
	<code class="function">munmap</code> Systemaufruf:</p><div xmlns="" class="tip"><h3 class="admontitle">Tipp: </h3><p xmlns="http://www.w3.org/1999/xhtml">Für eine detailliert Behandlung von <code class="function">mmap</code>, sieh in W. Richard Stevens'
	  <a class="link" href="http://www.int80h.org/cgi-bin/isbn?isbn=0130810819" target="_top">
	  Unix Network Programming, Volume 2, Chapter 12</a>
	  nach.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-file-size"></a>11.11.4. Feststellen der Datei Grösse</h3></div></div></div><p>Weil wir <code class="function">mmap</code> sagen
	müssen wie viele Bytes von Datei wir im Speicher abbilden
	wollen und wir außerdem die gesamte Datei abbilden wollen,
	müssen wir die Grösse der Datei feststellen.</p><p>Wir können den <code class="function">fstat</code>	Systemaufruf verwenden um alle
	Informationen über eine geöffnete Datei zu erhalten
	die uns das System geben kann. Das beinhaltet die Datei
	Grösse.</p><p>Und wieder, zeigt uns <code class="filename">syscalls.master</code>
	zwei Versionen von <code class="function">fstat</code>,
	eine traditionelle (Systemaufruf 62), und eine
	<acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> (Systemaufruf 189) Variante.
	Natürlich, verwenden wir die <acronym class="acronym"><span class="trademark">POSIX</span>®</acronym>
	Version:</p><pre class="programlisting">
189	STD	POSIX	{ int fstat(int fd, struct stat *sb); }
      </pre><p>Das ist ein sehr unkomplizierter Aufruf: Wir
	übergeben ihm die Adresse einer
	<code class="varname">stat</code> Structure und den Deskriptor
	einer geöffneten Datei. Es wird den Inhalt der
	<code class="varname">stat</code> Struktur ausfüllen.</p><p>Ich muss allerdings sagen, das ich versucht habe die
	<code class="varname">stat</code> Struktur in dem
	<code class="varname">.bss</code> Bereich zu deklarieren, und
	<code class="function">fstat</code> mochte es nicht:
	Es setzte das Carry Flag welches einen Fehler anzeigt.
	Nachdem ich den Code veränderte so dass er die Struktur
	auf dem Stack anlegt, hat alles gut funktioniert.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-ftruncate"></a>11.11.5. Ändern der Dateigrösse</h3></div></div></div><p>Dadurch das unser Programm
      Wagenrücklauf/Zeilenvorschub-Sequenzen in einfache
      Zeilenvorschübe zusammenfassen könnte, könnte
      unsere Ausgabe kleiner sein als unsere Eingabe. Und da wir die
      Ausgabe in dieselbe Datei um, aus der wir unsere Eingabe
      erhalten, müssen wir eventuell die Dateigrösse
      anpassen.</p><p>Der Systemaufruf <code class="function">ftruncate</code> erlaubt uns, dies zu tun.
      Abgesehen von dem etwas unglücklich gewählten Namen
      <code class="function">ftruncate</code> können wir
      mit dieser Funktion eine Datei vergrössern, oder
      verkleinern.</p><p>Und ja, wir werden zwei Versionen von <code class="function">ftruncate</code> in
      <code class="filename">syscalls.master</code> finden, eine ältere
      (130) und eine neuere (201). Wir werden die neuere Version
      verwenden:</p><pre class="programlisting">
201	STD	BSD	{ int ftruncate(int fd, int pad, off_t length); }
      </pre><p>Beachten Sie bitte, dass hier wieder <code class="varname">int
	pad</code> verwendet wird.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-ftuc"></a>11.11.6. ftuc</h3></div></div></div><p>Wir wissen jetzt alles nötige, um
      <span class="application">ftuc</span> zu schreiben. Wir beginnen,
      indem wir ein paar neue Zeilen der Datei
      <code class="filename">system.inc</code> hinzufügen. Als erstes
      definieren wir irgendwo am Anfang der Datei einige Konstanten
      und Strukturen:</p><pre class="programlisting">
;;;;;;; open flags
%define	O_RDONLY	0
%define	O_WRONLY	1
%define	O_RDWR	2

;;;;;;; mmap flags
%define	PROT_NONE	0
%define	PROT_READ	1
%define	PROT_WRITE	2
%define	PROT_EXEC	4
;;
%define	MAP_SHARED	0001h
%define	MAP_PRIVATE	0002h

;;;;;;; stat structure
struc	stat
st_dev		resd	1	; = 0
st_ino		resd	1	; = 4
st_mode		resw	1	; = 8, size is 16 bits
st_nlink	resw	1	; = 10, ditto
st_uid		resd	1	; = 12
st_gid		resd	1	; = 16
st_rdev		resd	1	; = 20
st_atime	resd	1	; = 24
st_atimensec	resd	1	; = 28
st_mtime	resd	1	; = 32
st_mtimensec	resd	1	; = 36
st_ctime	resd	1	; = 40
st_ctimensec	resd	1	; = 44
st_size		resd	2	; = 48, size is 64 bits
st_blocks	resd	2	; = 56, ditto
st_blksize	resd	1	; = 64
st_flags	resd	1	; = 68
st_gen		resd	1	; = 72
st_lspare	resd	1	; = 76
st_qspare	resd	4	; = 80
endstruc
      </pre><p>Wir definieren die neuen Systemaufrufe:</p><pre class="programlisting">
%define	SYS_mmap	197
%define	SYS_munmap	73
%define	SYS_fstat	189
%define	SYS_ftruncate	201
      </pre><p>Wir fügen die Makros hinzu:</p><pre class="programlisting">
%macro	sys.mmap	0
	system	SYS_mmap
%endmacro

%macro	sys.munmap	0
	system	SYS_munmap
%endmacro

%macro	sys.ftruncate	0
	system	SYS_ftruncate
%endmacro

%macro	sys.fstat	0
	system	SYS_fstat
%endmacro
      </pre><p>Und hier ist unser Code:</p><pre class="programlisting">
;;;;;;; Fast Text-to-Unix Conversion (ftuc.asm) ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;; Started:	21-Dec-2000
;; Updated:	22-Dec-2000
;;
;; Copyright 2000 G. Adam Stanislav.
;; All rights reserved.
;;
;;;;;;; v.1 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
%include	'system.inc'

section	.data
	db	'Copyright 2000 G. Adam Stanislav.', 0Ah
	db	'All rights reserved.', 0Ah
usg	db	'Usage: ftuc filename', 0Ah
usglen	equ	$-usg
co	db	"ftuc: Can't open file.", 0Ah
colen	equ	$-co
fae	db	'ftuc: File access error.', 0Ah
faelen	equ	$-fae
ftl	db	'ftuc: File too long, use regular tuc instead.', 0Ah
ftllen	equ	$-ftl
mae	db	'ftuc: Memory allocation error.', 0Ah
maelen	equ	$-mae

section	.text

align 4
memerr:
	push	dword maelen
	push	dword mae
	jmp	short error

align 4
toolong:
	push	dword ftllen
	push	dword ftl
	jmp	short error

align 4
facerr:
	push	dword faelen
	push	dword fae
	jmp	short error

align 4
cantopen:
	push	dword colen
	push	dword co
	jmp	short error

align 4
usage:
	push	dword usglen
	push	dword usg

error:
	push	dword stderr
	sys.write

	push	dword 1
	sys.exit

align 4
global	_start
_start:
	pop	eax		; argc
	pop	eax		; program name
	pop	ecx		; file to convert
	jecxz	usage

	pop	eax
	or	eax, eax	; Too many arguments?
	jne	usage

	; Open the file
	push	dword O_RDWR
	push	ecx
	sys.open
	jc	cantopen

	mov	ebp, eax	; Save fd

	sub	esp, byte stat_size
	mov	ebx, esp

	; Find file size
	push	ebx
	push	ebp		; fd
	sys.fstat
	jc	facerr

	mov	edx, [ebx + st_size + 4]

	; File is too long if EDX != 0 ...
	or	edx, edx
	jne	near toolong
	mov	ecx, [ebx + st_size]
	; ... or if it is above 2 GB
	or	ecx, ecx
	js	near toolong

	; Do nothing if the file is 0 bytes in size
	jecxz	.quit

	; Map the entire file in memory
	push	edx
	push	edx		; starting at offset 0
	push	edx		; pad
	push	ebp		; fd
	push	dword MAP_SHARED
	push	dword PROT_READ | PROT_WRITE
	push	ecx		; entire file size
	push	edx		; let system decide on the address
	sys.mmap
	jc	near memerr

	mov	edi, eax
	mov	esi, eax
	push	ecx		; for SYS_munmap
	push	edi

	; Use EBX for state machine
	mov	ebx, ordinary
	mov	ah, 0Ah
	cld

.loop:
	lodsb
	call	ebx
	loop	.loop

	cmp	ebx, ordinary
	je	.filesize

	; Output final lf
	mov	al, ah
	stosb
	inc	edx

.filesize:
	; truncate file to new size
	push	dword 0		; high dword
	push	edx		; low dword
	push	eax		; pad
	push	ebp
	sys.ftruncate

	; close it (ebp still pushed)
	sys.close

	add	esp, byte 16
	sys.munmap

.quit:
	push	dword 0
	sys.exit

align 4
ordinary:
	cmp	al, 0Dh
	je	.cr

	cmp	al, ah
	je	.lf

	stosb
	inc	edx
	ret

align 4
.cr:
	mov	ebx, cr
	ret

align 4
.lf:
	mov	ebx, lf
	ret

align 4
cr:
	cmp	al, 0Dh
	je	.cr

	cmp	al, ah
	je	.lf

	xchg	al, ah
	stosb
	inc	edx

	xchg	al, ah
	; fall through

.lf:
	stosb
	inc	edx
	mov	ebx, ordinary
	ret

align 4
.cr:
	mov	al, ah
	stosb
	inc	edx
	ret

align 4
lf:
	cmp	al, ah
	je	.lf

	cmp	al, 0Dh
	je	.cr

	xchg	al, ah
	stosb
	inc	edx

	xchg	al, ah
	stosb
	inc	edx
	mov	ebx, ordinary
	ret

align 4
.cr:
	mov	ebx, ordinary
	mov	al, ah
	; fall through

.lf:
	stosb
	inc	edx
	ret
      </pre><div xmlns="" class="warning"><h3 class="admontitle">Warnung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Verwenden Sie dieses Programm nicht mit Dateien, die
	  sich auf Datenträgern befinden, welche mit
	  <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> oder <span class="trademark">Windows</span>® formatiert
	  wurden. Anscheinend gibt es im Code von FreeBSD einen
	  subtilen Bug, wenn <code class="function">mmap</code>
	  auf solchen Datenträgern verwendet wird: Wenn die Datei
	  eine bestimmte Grösse überschreitet, füllt
	  <code class="function">mmap</code> den Speicher mit
	  lauter Nullen, und überschreibt damit anschliessend den
	  Dateiinhalt.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-one-pointed-mind"></a>11.12. One-Pointed Mind</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Daniel</span> <span class="surname">Seuffert</span></span>. </span></div></div></div><p>Als ein Zen-Schüler liebe ich die Idee eines
      fokussierten Bewußtseins: Tu nur ein Ding zur gleichen
      Zeit, aber mache es richtig.</p><p>Das ist ziemlich genau die gleiche Idee, welche <span class="trademark">UNIX</span>®
      richtig funktionieren lässt. Während eine typische
      <span class="trademark">Windows</span>®-Applikation versucht alles Vorstellbare zu tun (und
      daher mit Fehler durchsetzt ist), versucht eine
      <span class="trademark">UNIX</span>®-Applikation nur eine Funktion zu erfüllen und das
      gut.</p><p>Der typische <span class="trademark">UNIX</span>®-Nutzer stellt sich sein eigenes System
      durch Shell-Skripte zusammen, die er selbst schreibt, und welche
      die Vorteile bestehender Applikationen dadurch kombinieren,
      indem sie die Ausgabe eines Programmes als Eingabe in ein
      anderes Programm durch eine Pipe übergeben.</p><p>Wenn Sie ihre eigene <span class="trademark">UNIX</span>®-Software schreiben, ist es
      generell eine gute Idee zu betrachten, welcher Teil der
      Problemlösung durch bestehende Programme bewerkstelligt
      werden kann. Man schreibt nur die Programme selbst, für die
      keine vorhandene Lösung existiert.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-csv"></a>11.12.1. CSV</h3></div></div></div><p>Ich will dieses Prinzip an einem besonderen Beispiel
	aus der realen Welt demonstrieren, mit dem ich kürzlich
	konfrontiert wurde:</p><p>Ich mußte jeweils das elfte Feld von jedem
	Datensatz aus einer Datenbank extrahieren, die ich von einer
	Webseite heruntergeladen hatte. Die Datenbank war eine
	<acronym class="acronym">CSV</acronym>-Datei, d.h. eine Liste von
	<span class="emphasis"><em>Komma-getrennten Werten</em></span>. Dies ist ein
	ziemlich gewöhnliches Format für den Code-Austausch
	zwischen Menschen, die eine unterschiedliche
	Datenbank-Software nutzen.</p><p>Die erste Zeile der Datei enthält eine Liste der
	Felder durch Kommata getrennt. Der Rest der Datei enthält
	die einzelnen Datensätze mit durch Kommata getrennten
	Werten in jeder Zeile.</p><p>Ich versuchte <span class="application">awk</span> unter
	Nutzung des Kommas als Trenner. Da aber einige Zeilen durch in
	Bindestriche gesetzte Kommata getrennt waren, extrahierte
	<span class="application">awk</span> das falsche Feld aus diesen
	Zeilen.</p><p>Daher mußte ich meine eigene Software schreiben,
	um das elfte Feld aus der <acronym class="acronym">CSV</acronym>-Datei
	auszulesen. Aber durch Anwendung der <span class="trademark">UNIX</span>®-Philosophie
	mußte ich nur einen einfachen Filter schreiben, das
	Folgende tat:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Entferne die erste Zeile aus der Datei.</p></li><li class="listitem"><p>Ändere alle Kommata ohne Anführungszeichen
	    in einen anderen Buchstaben.</p></li><li class="listitem"><p>Entferne alle Anführungszeichen.</p></li></ul></div><p>Streng genommen könnte ich
	<span class="application">sed</span> benutzen, um die erste Zeile
	der Datei zu entfernen, aber das zu Bewerkstelligen war in
	meinem Programm sehr einfach, also entschloss ich mich dazu
	und reduzierte dadurch die Größe der
	Pipeline.</p><p>Unter Berücksichtigung aller Faktoren kostete mich
	das Schreiben dieses Programmes ca. 20 Minuten. Das Schreiben
	eines Programmes, welches jeweils das elfte Feld aus einer
	<acronym class="acronym">CSV</acronym>-Datei extrahiert hätte wesentlich
	länger gedauert und ich hätte es nicht
	wiederverwenden können, um ein anderes Feld aus irgendeiner
	anderen Datenbank zu extrahieren.</p><p>Diesmal entschied ich mich dazu, etwas mehr Arbeit zu
	investieren, als man normalerweise für ein typisches
	Tutorial verwenden würde:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Es parst die Kommandozeilen nach Optionen.</p></li><li class="listitem"><p>Es zeigt die richtige Nutzung an, falls es ein
	    falsches Argument findet.</p></li><li class="listitem"><p>Es gibt vernünftige Fehlermeldungen aus.</p></li></ul></div><p>Hier ist ein Beispiel für seine Nutzung:</p><pre class="screen">Usage: csv [-t&lt;delim&gt;] [-c&lt;comma&gt;] [-p] [-o &lt;outfile&gt;] [-i &lt;infile&gt;]</pre><p>Alle Parameter sind optional und können in beliebiger
	Reihenfolge auftauchen.</p><p>Der <em class="parameter"><code>-t</code></em>-Parameter legt fest, was
	zu die Kommata zu ersetzen sind. Der <code class="constant">tab</code>
	ist die Vorgabe hierfür. Zum Beispiel wird
	<em class="parameter"><code>-t;</code></em> alle unquotierten Kommata mit
	Semikolon ersetzen.</p><p>Ich brauche die <em class="parameter"><code>-c</code></em>-Option nicht,
	aber sie könnte zukünftig nützlich sein. Sie
	ermöglicht mir festzulegen, daß ich einen anderen
	Buchstaben als das Kommata mit etwas anderem ersetzen
	möchte. Zum Beispiel wird der Parameter
	<em class="parameter"><code>-c@</code></em> alle @-Zeichen ersetzen
	(nützlich, falls man eine Liste von Email-Adressen in
	Nutzername und Domain aufsplitten will).</p><p>Die <em class="parameter"><code>-p</code></em>-Option erhält die
	erste Zeile, d.h. die erste Zeile der Datei wird nicht
	gelöscht. Als Vorgabe löschen wir die erste Zeile,
	weil die <acronym class="acronym">CSV</acronym>-Datei in der ersten Zeile
	keine Daten, sondern Feldbeschreibungen enthält.</p><p>Die Parameter <em class="parameter"><code>-i</code></em>- und
	<em class="parameter"><code>-o</code></em>-Optionen erlauben es mir, die
	Ausgabe- und Eingabedateien festzulegen. Vorgabe sind
	<code class="filename">stdin</code> und <code class="filename">stdout</code>,
	also ist es ein regulärer <span class="trademark">UNIX</span>®-Filter.</p><p>Ich habe sichergestellt, daß sowohl <em class="parameter"><code>-i
	filename</code></em> und <em class="parameter"><code>-ifilename</code></em>
	akzeptiert werden. Genauso habe ich dafür Sorge getragen,
	daß sowohl Eingabe- als auch Ausgabedateien festgelegt
	werden können.</p><p>Um das elfte Feld jeden Datensatzes zu erhalten kann ich
	nun folgendes eingeben:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>csv '-t;' data.csv | awk '-F;' '{print $11}'</code></strong></pre><p>Der Code speichert die Optionen (bis auf die
	Dateideskriptoren) in <code class="varname">EDX</code>:
	Das Kommata in <code class="varname">DH</code>, den
	neuen Feldtrenner in <code class="varname">DL</code> und
	das Flag für die <em class="parameter"><code>-p</code></em>-Option in dem
	höchsten Bit von <code class="varname">EDX</code>.
	Ein kurzer Abgleich des Zeichens wird uns also eine schnelle
	Entscheidung darüber erlauben, was zu tun ist.</p><p>Hier ist der Code:</p><pre class="programlisting">
;;;;;;; csv.asm ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; Convert a comma-separated file to a something-else separated file.
;
; Started:	31-May-2001
; Updated:	 1-Jun-2001
;
; Copyright (c) 2001 G. Adam Stanislav
; All rights reserved.
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

%include	'system.inc'

%define	BUFSIZE	2048

section	.data
fd.in	dd	stdin
fd.out	dd	stdout
usg	db	'Usage: csv [-t&lt;delim&gt;] [-c&lt;comma&gt;] [-p] [-o &lt;outfile&gt;] [-i &lt;infile&gt;]', 0Ah
usglen	equ	$-usg
iemsg	db	"csv: Can't open input file", 0Ah
iemlen	equ	$-iemsg
oemsg	db	"csv: Can't create output file", 0Ah
oemlen	equ	$-oemsg

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE

section	.text
align 4
ierr:
	push	dword iemlen
	push	dword iemsg
	push	dword stderr
	sys.write
	push	dword 1		; return failure
	sys.exit

align 4
oerr:
	push	dword oemlen
	push	dword oemsg
	push	dword stderr
	sys.write
	push	dword 2
	sys.exit

align 4
usage:
	push	dword usglen
	push	dword usg
	push	dword stderr
	sys.write
	push	dword 3
	sys.exit

align 4
global	_start
_start:
	add	esp, byte 8	; discard argc and argv[0]
	mov	edx, (',' &lt;&lt; 8) | 9

.arg:
	pop	ecx
	or	ecx, ecx
	je	near .init		; no more arguments

	; ECX contains the pointer to an argument
	cmp	byte [ecx], '-'
	jne	usage

	inc	ecx
	mov	ax, [ecx]

.o:
	cmp	al, 'o'
	jne	.i

	; Make sure we are not asked for the output file twice
	cmp	dword [fd.out], stdout
	jne	usage

	; Find the path to output file - it is either at [ECX+1],
	; i.e., -ofile --
	; or in the next argument,
	; i.e., -o file

	inc	ecx
	or	ah, ah
	jne	.openoutput
	pop	ecx
	jecxz	usage

.openoutput:
	push	dword 420	; file mode (644 octal)
	push	dword 0200h | 0400h | 01h
	; O_CREAT | O_TRUNC | O_WRONLY
	push	ecx
	sys.open
	jc	near oerr

	add	esp, byte 12
	mov	[fd.out], eax
	jmp	short .arg

.i:
	cmp	al, 'i'
	jne	.p

	; Make sure we are not asked twice
	cmp	dword [fd.in], stdin
	jne	near usage

	; Find the path to the input file
	inc	ecx
	or	ah, ah
	jne	.openinput
	pop	ecx
	or	ecx, ecx
	je near usage

.openinput:
	push	dword 0		; O_RDONLY
	push	ecx
	sys.open
	jc	near ierr		; open failed

	add	esp, byte 8
	mov	[fd.in], eax
	jmp	.arg

.p:
	cmp	al, 'p'
	jne	.t
	or	ah, ah
	jne	near usage
	or	edx, 1 &lt;&lt; 31
	jmp	.arg

.t:
	cmp	al, 't'		; redefine output delimiter
	jne	.c
	or	ah, ah
	je	near usage
	mov	dl, ah
	jmp	.arg

.c:
	cmp	al, 'c'
	jne	near usage
	or	ah, ah
	je	near usage
	mov	dh, ah
	jmp	.arg

align 4
.init:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	mov	edi, obuffer

	; See if we are to preserve the first line
	or	edx, edx
	js	.loop

.firstline:
	; get rid of the first line
	call	getchar
	cmp	al, 0Ah
	jne	.firstline

.loop:
	; read a byte from stdin
	call	getchar

	; is it a comma (or whatever the user asked for)?
	cmp	al, dh
	jne	.quote

	; Replace the comma with a tab (or whatever the user wants)
	mov	al, dl

.put:
	call	putchar
	jmp	short .loop

.quote:
	cmp	al, '"'
	jne	.put

	; Print everything until you get another quote or EOL. If it
	; is a quote, skip it. If it is EOL, print it.
.qloop:
	call	getchar
	cmp	al, '"'
	je	.loop

	cmp	al, 0Ah
	je	.put

	call	putchar
	jmp	short .qloop

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	ret

read:
	jecxz	.read
	call	write

.read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword [fd.in]
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.done
	sub	eax, eax
	ret

align 4
.done:
	call	write		; flush output buffer

	; close files
	push	dword [fd.in]
	sys.close

	push	dword [fd.out]
	sys.close

	; return success
	push	dword 0
	sys.exit

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	jecxz	.ret	; nothing to write
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword [fd.out]
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
.ret:
	ret</pre><p>Vieles daraus ist aus <code class="filename">hex.asm</code>
	entnommen worden. Aber es gibt einen wichtigen Unterschied:
	Ich rufe nicht länger <code class="function">write</code> auf,
	wann immer ich eine Zeilenvorschub ausgebe. Nun kann der Code
	sogar interaktiv genutzt werden.</p><p>Ich habe eine bessere Lösung gefunden für das
	Interaktivitätsproblem seit ich mit dem Schreiben dieses
	Kapitels begonnen habe. Ich wollte sichergehen, daß jede
	Zeile einzeln ausgegeben werden kann, falls erforderlich. Aber
	schlussendlich gibt es keinen Bedarf jede Zeile einzeln
	auszugeben, falls nicht-interaktiv genutzt.</p><p>Die neue Lösung besteht darin, die Funktion
	<code class="function">write</code> jedesmal aufzurufen, wenn ich den
	Eingabepuffer leer vorfinde. Auf diesem Wege liest das
	Programm im interaktiven Modus eine Zeile aus der Tastatur des
	Nutzers, verarbeitet sie und stellt fest, ob deren
	Eingabepuffer leer ist, dann leert es seine Ausgabe und liest
	die nächste Zeile.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-buffered-dark-side"></a>11.12.1.1. Die dunkle Seite des Buffering</h4></div></div></div><p>Diese Änderung verhindert einen mysteriösen
	  Aufhänger in einem speziellen Fall. Ich bezeichne dies
	  als die <span class="emphasis"><em>dunkle Seite des Buffering</em></span>,
	  hauptsächlich, weil es eine nicht offensichtliche
	  Gefahr darstellt.</p><p>Es ist unwahrscheinlich, daß dies mit dem
	  <span class="application">csv</span>-Programm oben geschieht aber
	  lassen Sie uns einen weiteren Filter betrachten: Nehmen wir
	  an ihre Eingabe sind rohe Daten, die Farbwerte darstellen,
	  wie z.B. die Intensität eines Pixel mit den Farben
	  <span class="emphasis"><em>rot</em></span>, <span class="emphasis"><em>grün</em></span> und
	  <span class="emphasis"><em>blau</em></span>. Unsere Ausgabe wird der negative
	  Wert unserer Eingabe sein.</p><p>Solch ein Filter würde sehr einfach zu schreiben
	  sein. Der größte Teil davon würde so
	  aussehen wie all die anderen Filter, die wir bisher
	  geschrieben haben, daher beziehe ich mich nur auf den Kern
	  der Prozedur:</p><pre class="programlisting">.loop:
	call	getchar
	not	al		; Create a negative
	call	putchar
	jmp	short .loop</pre><p>Da dieser Filter mit rohen Daten arbeitet ist es
	  unwahrscheinlich, daß er interaktiv genutzt werden
	  wird.</p><p>Aber das Programm könnte als
	  Bildbearbeitungssoftware tituliert werden. Wenn es nicht
	  <code class="function">write</code> vor jedem Aufruf von
	  <code class="function">read</code> durchführt, ist die
	  Möglichkeit gegeben, das es sich aufhängt.</p><p>Dies könnte passieren:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Der Bildeditor wird unseren Filter laden mittels der
	    C-Funktion <code class="function">popen()</code>.</p></li><li class="step"><p>Er wird die erste Zeile von Pixeln laden aus einer
	      Bitmap oder Pixmap.</p></li><li class="step"><p>Er wird die erste Zeile von Pixeln geschrieben in
	      die <span class="emphasis"><em>Pipe</em></span>, welche zur Variable
	      <code class="varname">fd.in</code> unseres Filters
	      führt.</p></li><li class="step"><p>Unser Filter wird jeden Pixel auslesen von der
	      Eingabe, in in seinen negativen Wert umkehren und ihn in
	      den Ausgabepuffer schreiben.</p></li><li class="step"><p>Unser Filter wird die Funktion
	      <code class="function">getchar</code> aufrufen, um das
	      nächste Pixel abzurufen.</p></li><li class="step"><p>Die Funktion <code class="function">getchar</code> wird einen
	      leeren Eingabepuffer vorfinden und daher die Funktion
	      <code class="function">read</code> aufrufen.</p></li><li class="step"><p><code class="function">read</code> wird den Systemaufruf
	      <code class="function">SYS_read</code>
	      starten.</p></li><li class="step"><p>Der <span class="emphasis"><em>Kernel</em></span> wird unseren Filter
	      unterbrechen, bis der Bildeditor mehr Daten zur Pipe
	      sendet.</p></li><li class="step"><p>Der Bildedior wird aus der anderen Pipe lesen,
	      welche verbunden ist mit <code class="varname">fd.out</code>
	      unseres Filters, damit er die erste Zeile des
	      auszugebenden Bildes setzen kann
	      <span class="emphasis"><em>bevor</em></span> er uns die zweite Zeile der
	      Eingabe einliest.</p></li><li class="step"><p>Der <span class="emphasis"><em>Kernel</em></span> unterbricht den
	      Bildeditor, bis er eine Ausgabe unseres Filters
	      erhält, um ihn an den Bildeditor
	      weiterzureichen.</p></li></ol></div><p>An diesem Punkt wartet unser Filter auf den
	  Bildeditor, daß er ihm mehr Daten zur Verarbeitung
	  schicken möge. Gleichzeitig wartet der Bildeditor
	  darauf, daß unser Filter das Resultat der Berechnung
	  ersten Zeile sendet. Aber das Ergebnis sitzt in unserem
	  Ausgabepuffer.</p><p>Der Filter und der Bildeditor werden fortfahren bis in
	  die Ewigkeit aufeinander zu warten (oder zumindest bis sie
	  per kill entsorgt werden). Unsere Software hat den eine
	  <a class="link" href="#secure-race-conditions" title="3.7. Race-Conditions">Race Condition</a>
	  erreicht.</p><p>Das Problem tritt nicht auf, wenn unser Filter seinen
	  Ausgabepuffer leert <span class="emphasis"><em>bevor</em></span> er vom
	  <span class="emphasis"><em>Kernel</em></span> mehr Eingabedaten
	  anfordert.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-fpu"></a>11.13. Die <acronym class="acronym">FPU</acronym> verwenden</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Fabian</span> <span class="surname">Borschel</span></span>. </span></div></div></div><p>Seltsamerweise erwähnt die meiste Literatur zu
      Assemblersprachen nicht einmal die Existenz der
      <acronym class="acronym">FPU</acronym>, oder
      <span class="emphasis"><em>floating point unit</em></span>
      (Fließkomma-Recheneinheit), geschweige denn, daß
      auf die Programmierung mit dieser eingegangen wird.</p><p>Dabei kann die Assemblerprogrammierung gerade bei
      hoch optimiertem <acronym class="acronym">FPU</acronym>-Code, der
      <span class="emphasis"><em>nur</em></span> mit einer Assemblersprache realisiert
      werden kann, ihre große Stärke ausspielen.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-fpu-organization"></a>11.13.1. Organisation der <acronym class="acronym">FPU</acronym></h3></div></div></div><p>Die <acronym class="acronym">FPU</acronym> besteht aus 8 80&#8211;bit
	Fließkomma-Registern. Diese sind in Form eines
	Stacks organisiert&#8212;Sie können einen Wert durch
	den Befehl <code class="function">push</code> auf dem
	<acronym class="acronym">TOS</acronym> (<span class="emphasis"><em>top of stack</em></span>)
	ablegen, oder durch <code class="function">pop</code> von diesem
	holen.</p><p>Da also die Befehle <code class="function">push</code>
        und <code class="function">pop</code> schon verwendet
	werden, kann es	keine op-Codes in Assemblersprache mit diesen
	Namen geben.</p><p>Sie können mit einen Wert auf dem
	<acronym class="acronym">TOS</acronym> ablegen, indem Sie
	<code class="function">fld</code>, <code class="function">fild</code>, und <code class="function">fbld</code> verwenden. Mit weiteren op-Codes
	lassen sich <span class="emphasis"><em>Konstanten</em></span>&#8212;wie z.B.
	<span class="emphasis"><em>Pi</em></span>&#8212;auf dem <acronym class="acronym">TOS</acronym>
	ablegen.</p><p>Analog dazu können Sie einen Wert
	holen, indem Sie <code class="function">fst</code>,
	<code class="function">fstp</code>, <code class="function">fist</code>, <code class="function">fistp</code>, und <code class="function">fbstp</code> verwenden. Eigentlich
	holen (<code class="function">pop</code>) nur die op-Codes, die auf
	<span class="emphasis"><em>p</em></span> enden, einen Wert, während die
	anderen den Wert irgendwo speichern (<code class="function">store</code>)
	ohne ihn vom <acronym class="acronym">TOS</acronym> zu entfernen.</p><p>Daten können zwischen dem <acronym class="acronym">TOS</acronym>
	und dem Hauptspeicher als 32&#8211;bit, 64&#8211;bit oder
	80&#8211;bit <span class="emphasis"><em>real</em></span>, oder als 16&#8211;bit,
	32&#8211;bit oder 64&#8211;bit <span class="emphasis"><em>Integer</em></span>,
	oder als 80&#8211;bit <span class="emphasis"><em>packed decimal</em></span>
	übertragen werden.</p><p>Das 80&#8211;bit <span class="emphasis"><em>packed decimal</em></span>-Format
        ist ein Spezialfall des
	<span class="emphasis"><em>binary coded decimal</em></span>-Formates,
	welches üblicherweise bei der Konvertierung zwischen der
	<acronym class="acronym">ASCII</acronym>- und
	<acronym class="acronym">FPU</acronym>-Darstellung von Daten verwendet wird.
	Dieses erlaubt die Verwendung von 18 signifikanten
	Stellen.</p><p>Unabhängig davon, wie Daten im Speicher dargestellt
	werden, speichert die <acronym class="acronym">FPU</acronym> ihre Daten immer
	im 80&#8211;bit <span class="emphasis"><em>real</em></span>-Format in den
	Registern.</p><p>Ihre interne Genauigkeit beträgt mindestens 19
	Dezimalstellen. Selbst wenn wir also Ergebnisse im
	<acronym class="acronym">ASCII</acronym>-Format mit voller 18&#8211;stelliger
	Genauigkeit darstellen lassen, werden immer noch korrekte
	Werte angezeigt.</p><p>Des weiteren können mathematische Operationen auf
	dem <acronym class="acronym">TOS</acronym> ausgeführt werden: Wir
	können dessen <span class="emphasis"><em>Sinus</em></span> berechnen, wir
	können ihn <span class="emphasis"><em>skalieren</em></span> (z.B.
	können wir ihn mit dem Faktor 2 Multiplizieren oder
	Dividieren), wir können dessen
	<span class="emphasis"><em>Logarithmus</em></span> zur Basis 2 nehmen, und viele
	weitere Dinge.</p><p>Wir können auch <acronym class="acronym">FPU</acronym>-Register
	<span class="emphasis"><em>multiplizieren</em></span>,
	<span class="emphasis"><em>dividieren</em></span>, <span class="emphasis"><em>addieren</em></span>
	und <span class="emphasis"><em>subtrahieren</em></span>, sogar einzelne
	Register mit sich selbst.</p><p>Der offizielle Intel op-Code für den
	<acronym class="acronym">TOS</acronym> ist <code class="varname">st</code> und für die
	<span class="emphasis"><em>Register</em></span> <code class="varname">st(0)</code>&#8211; <code class="varname">st(7)</code>. <code class="varname">st</code> und <code class="varname">st(0)</code> beziehen sich dabei auf das
	gleiche Register.</p><p>Aus welchen Gründen auch immer hat sich der
	Originalautor von <span class="application">nasm</span> dafür
	entschieden, andere op-Codes zu verwenden, nämlich
	<code class="varname">st0</code>&#8211; <code class="varname">st7</code>. Mit anderen Worten, es gibt
	keine Klammern, und der <acronym class="acronym">TOS</acronym> ist immer
	<code class="varname">st0</code>, niemals einfach nur
	<code class="function">st</code>.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-fpu-packed-decimal"></a>11.13.1.1. Das Packed Decimal-Format</h4></div></div></div><p>Das <span class="emphasis"><em>packed decimal</em></span>-Format verwendet
	  10 Bytes (80 Bits) zur Darstellung von 18 Ziffern. Die so
	  dargestellte Zahl ist immer ein
	  <span class="emphasis"><em>Integer</em></span>.</p><div xmlns="" class="tip"><h3 class="admontitle">Tipp: </h3><p xmlns="http://www.w3.org/1999/xhtml">Sie können durch Multiplikation des
	    <acronym class="acronym">TOS</acronym> mit Potenzen von 10 die einzelnen
	    Dezimalstellen verschieben.</p></div><p>Das höchste Bit des höchsten Bytes (Byte 9)
	  ist das <span class="emphasis"><em>Vorzeichenbit</em></span>:
	  Wenn es gesetzt ist, ist die Zahl
	  <span class="emphasis"><em>negativ</em></span>, ansonsten
	  <span class="emphasis"><em>positiv</em></span>. Die restlichen Bits dieses
	  Bytes werden nicht verwendet bzw. ignoriert.</p><p>Die restlichen 9 Bytes enthalten die 18 Ziffern der
	  gespeicherten Zahl: 2 Ziffern pro Byte.</p><p>Die <span class="emphasis"><em>signifikantere Ziffer</em></span> wird in
	  der <span class="emphasis"><em>oberen Hälfte</em></span> (4 Bits) eines
	  Bytes gespeichert, die andere in der
	  <span class="emphasis"><em>unteren Hälfte</em></span>.</p><p>Vielleicht würden Sie jetzt annehmen, das
	  <code class="constant">-1234567</code> auf die folgende Art im
	  Speicher abgelegt wird (in hexadezimaler Notation):</p><pre class="programlisting">80 00 00 00 00 00 01 23 45 67</pre><p>Dem ist aber nicht so! Bei Intel werden alle Daten im
	  <span class="emphasis"><em>little&#8211;endian</em></span>-Format gespeichert,
	  auch das <span class="emphasis"><em>packed decimal</em></span>-Format.</p><p>Dies bedeutet, daß <code class="constant">-1234567</code>
	  wie folgt gespeichert wird:</p><pre class="programlisting">67 45 23 01 00 00 00 00 00 80</pre><p>Erinnern Sie sich an diesen Umstand, bevor Sie sich
	  aus lauter Verzweiflung die Haare
	  ausreißen.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Das lesenswerte Buch&#8212;falls Sie es finden
	    können&#8212;ist Richard Startz' <a class="link" href="http://www.int80h.org/cgi-bin/isbn?isbn=013246604X" target="_top">
	    8087/80287/80387 for the IBM PC &amp; Compatibles</a>.
	    Obwohl es anscheinend die Speicherung der <span class="emphasis"><em>packed
	    decimal</em></span> im little&#8211;endian-Format für
	    gegeben annimmt. Ich mache keine Witze über meine
	    Verzweiflung, als ich den Fehler im unten stehenden Filter
	    gesucht habe, <span class="emphasis"><em>bevor</em></span> mir einfiel,
	    daß ich einfach mal versuchen sollte, das
	    little&#8211;endian-Format, selbst für diesen Typ von
	    Daten, anzuwenden.</p></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-photography"></a>11.13.2. Ausflug in die Lochblendenphotographie</h3></div></div></div><p>Um sinnvolle Programme zu schreiben, müssen wir nicht
	nur unsere Programmierwerkzeuge beherrschen, sondern auch das
	Umfeld, für das die Programme gedacht sind.</p><p>Unser nächster Filter wird uns dabei helfen, wann
	immer wir wollen, eine <span class="emphasis"><em>Lochkamera</em></span> zu
	bauen. Wir brauchen also etwas Hintergrundwissen über
	die <span class="emphasis"><em>Lochblendenphotographie</em></span>, bevor wir
	weiter machen können.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-camera"></a>11.13.2.1. Die Kamera</h4></div></div></div><p>Die einfachste Form, eine Kamera zu beschreiben, ist
	  die eines abgeschlossenen, lichtundurchlässigen
	  Raumes, in dessen Abdeckung sich ein kleines Loch
	  befindet.</p><p>Die Abdeckung ist normalerweise fest (z.B. eine
	  Schachtel), manchmal jedoch auch flexibel (z.B. ein Balgen).
	  Innerhalb der Kamera ist es sehr dunkel. Nur durch ein
	  kleines Loch kann Licht von einem einzigen Punkt aus in den
	  Raum eindringen (in manchen Fällen sind es mehrere
	  Löcher). Diese Lichtstrahlen kommen von einem Bild,
	  einer Darstellung von dem was sich außerhalb der
	  Kamera, vor dem kleinen Loch, befindet.</p><p>Wenn ein lichtempfindliches Material (wie z.B. ein Film)
	  in der Kamera angebracht wird, so kann dieses das Bild
	  einfangen.</p><p>Das Loch enthält häufig eine
	  <span class="emphasis"><em>Linse</em></span>, oder etwas linsenartiges,
	  häufig auch einfach <span class="emphasis"><em>Objektiv</em></span>
	  genannt.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-the-pinhole"></a>11.13.2.2. Die Lochblende</h4></div></div></div><p>Streng genommen ist die Linse nicht notwendig: Die
	  ursprünglichen Kameras verwendeten keine Linse, sondern
	  eine <span class="emphasis"><em>Lochblende</em></span>. Selbst heutzutage
	  werden noch <span class="emphasis"><em>Lochblenden</em></span> verwendet,
	  zum einen, um die Funktionsweise einer Kamera zu erlernen,
	  und zum anderen, um eine spezielle Art von Bildern zu
	  erzeugen.</p><p>Das Bild, das von einer <span class="emphasis"><em>Lochblende</em></span>
	  erzeugt wird, ist überall scharf. Oder unscharf. Es
	  gibt eine ideale Größe für eine Lochblende:
	  Wenn sie größer oder kleiner ist, verliert das
	  Bild seine Schärfe.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-focal-length"></a>11.13.2.3. Brennweite</h4></div></div></div><p>Dieser ideale Lochblendendurchmesser ist eine Funktion
	  der Quadratwurzel der <span class="emphasis"><em>Brennweite</em></span>,
	  welche dem Abstand der Lochblende von dem Film
	  entspricht.</p><pre class="programlisting">     D = PC * sqrt(FL)</pre><p>Hier ist <code class="varname">D</code> der ideale Durchmesser der
	  Lochblende, <code class="varname">FL</code> die Brennweite und
	  <code class="constant">PC</code> eine Konstante der Brennweite. Nach
	  Jay Bender hat die Konstante den Wert
	  <code class="constant">0.04</code>, nach Kenneth Connors
	  <code class="constant">0.037</code>. Andere Leute
	  haben andere Werte vorgeschlagen. Des weiteren gelten diese
	  Werte nur für Tageslicht: Andere Arten von
	  Licht benötigen andere konstante Werte, welche nur
	  durch Experimente bestimmt werden können.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-f-number"></a>11.13.2.4. Der f&#8211;Wert</h4></div></div></div><p>Der f&#8211;Wert ist eine sehr nützliche
	  Größe, die angibt, wieviel Licht den Film erreicht.
	  Ein Belichtungsmesser kann dies messen, um z.B. für
	  einen Film mit einer Empfindlichkeit von f5.6 eine
	  Belichtungsdauer von 1/1000 Sekunden auszurechnen.</p><p>Es spielt keine Rolle, ob es eine 35&#8211;mm- oder
	  eine 6x9cm-Kamera ist, usw. Solange wir den f&#8211;Wert
	  kennen, können wir die benötigte Belichtungszeit
	  berechnen.</p><p>Der f&#8211;Wert läßt sich einfach wie folgt
	  berechnen:</p><pre class="programlisting">    F = FL / D</pre><p>Mit anderen Worten, der f&#8211;Wert ergibt sich aus
	  der Brennweite (FL), dividiert durch den Durchmesser (D) der
	  Lochblende. Ein großer f&#8211;Wert impliziert also
	  entweder eine kleine Lochblende, oder eine große
	  Brennweite, oder beides. Je größer also der
	  f&#8211;Wert ist, um so länger muß die
	  Belichtungszeit sein.</p><p>Des weiteren sind der Lochblendendurchmesser und die
	  Brennweite eindimensionale Meßgrößen,
	  während der Film und die Lochblende an sich
	  zweidimensionale Objekte darstellen. Das bedeutet, wenn
	  man für einen f&#8211;Wert <code class="varname">A</code>
	  eine Belichtungsdauer <code class="varname">t</code> bestimmt hat,
	  dann ergibt sich daraus für einen f&#8211;Wert
	  <code class="varname">B</code> eine Belichtungszeit von:</p><pre class="programlisting">    t * (B / A)²</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-normalized-f-number"></a>11.13.2.5. Normalisierte f&#8211;Werte</h4></div></div></div><p>Während heutige moderne Kameras den Durchmesser
	  der Lochblende, und damit deren f&#8211;Wert, weich und
	  schrittweise verändern können, war dies
	  früher nicht der Fall.</p><p>Um unterschiedliche f&#8211;Werte einstellen zu
	  können, besaßen Kameras typischerweise eine
	  Metallplatte mit Löchern unterschiedlichen
	  Durchmessers als Lochblende.</p><p>Die Durchmesser wurden entsprechend obiger Formel
	  gewählt, daß der resultierende f&#8211;Wert
	  ein fester Standardwert war, der für alle Kameras
	  verwendet wurde. Z.B. hat eine sehr alte Kodak Duaflex
	  IV Kamera in meinem Besitz drei solche Löcher
	  für die f&#8211;Werte 8, 11 und 16.</p><p>Eine neuere Kamera könnte f&#8211;Werte wie 2.8,
	  4, 5.6, 8, 11, 16, 22, und 32 (und weitere) besitzen.
	  Diese Werte wurden nicht zufällig ausgewählt:
	  Sie sind alle vielfache der Quadratwurzel aus 2, wobei
	  manche Werte gerundet wurden.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-f-stop"></a>11.13.2.6. Der f&#8211;Stopp</h4></div></div></div><p>Eine typische Kamera ist so konzipiert, daß die
	  Nummernscheibe bei den normalisierten f&#8211;Werten
	  einrastet. Die Nummernscheibe <span class="emphasis"><em>stoppt</em></span>
	  an diesen Positionen. Daher werden diese Positionen auch
	  f&#8211;Stopps genannt.</p><p>Da die f&#8211;Werte bei jedem Stopp vielfache der
	  Quadratwurzel aus 2 sind, verdoppelt die Drehung der
	  Nummernscheibe um einen Stopp die für die gleiche
	  Belichtung benötigte Lichtmenge. Eine Drehung
	  um 2 Stopps vervierfacht die benötigte Belichtungszeit.
	  Eine Drehung um 3 Stopps verachtfacht sie, etc.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-software"></a>11.13.3. Entwurf der Lochblenden-Software</h3></div></div></div><p>Wir können jetzt festlegen, was genau unsere
	Lochblenden-Software tun soll.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="xpinhole-processing-input"></a>11.13.3.1. Verarbeitung der Programmeingaben</h4></div></div></div><p>Da der Hauptzweck des Programms darin besteht, uns
	  beim Entwurf einer funktionierenden Lochkamera zu
	  helfen, wird die <span class="emphasis"><em>Brennweite</em></span>
	  die Programmeingabe sein. Dies ist etwas, das wir ohne
	  zusätzliche Programme feststellen können:
	  Die geeignete Brennweite ergibt sich aus der
	  Größe des Films und der Art des Fotos, ob
	  dieses ein "normales" Bild, ein Weitwinkelbild oder
	  ein Telebild sein soll.</p><p>Die meisten bisher geschriebenen Programme arbeiteten
	  mit einzelnen Zeichen, oder Bytes, als Eingabe: Das
	  <span class="application">hex</span>-Programm konvertierte
	  einzelne Bytes in hexadezimale Werte, das
	  <span class="application">csv</span>-Programm ließ entweder
	  einzelne Zeichen unverändert, löschte oder
	  veränderte sie, etc.</p><p>Das Programm <span class="application">ftuc</span> verwendete
	  einen Zustandsautomaten, um höchstens zwei gleichzeitig
	  eingegebene Bytes zu verarbeiten.</p><p>Das <span class="application">pinhole</span>-Programm dagegen
	  kann nicht nur mit einzelnen Zeichen arbeiten, sondern
	  muß mit größeren syntaktischen Einheiten
	  zurrecht kommen.</p><p>Wenn wir z.B. möchten, daß unser Programm den
	  Lochblendendurchmesser (und weitere Werte, die wir
	  später noch diskutieren werden) für die Brennweiten
	  <code class="constant">100 mm</code>, <code class="constant">150 mm</code> und
	  <code class="constant">210 mm</code> berechnet, wollen wir etwa
	  folgendes eingeben:</p><pre class="screen"><strong class="userinput"><code>100, 150, 210</code></strong></pre><p>Unser Programm muß mit der gleichzeitigen Eingabe
	  von mehr als nur einem einzelnen Byte zurecht kommen. Wenn
	  es eine <code class="constant">1</code> erkennt, muß es wissen,
	  daß dies die erste Stelle einer dezimalen Zahl ist.
	  Wenn es eine <code class="constant">0</code>, gefolgt von einer
	  weiteren <code class="constant">0</code> sieht, muß es wissen,
	  daß dies zwei unterschiedliche Stellen mit der
	  gleichen Zahl sind.</p><p>Wenn es auf das erste Komma trifft, muß es wissen,
	  daß die folgenden Stellen nicht mehr zur ersten
	  Zahl gehören. Es muß die Stellen der ersten
	  Zahl in den Wert <code class="constant">100</code> konvertieren
	  können. Und die Stellen der zweiten Zahl müssen
	  in den Wert <code class="constant">150</code> konvertiert werden.
	  Und die Stellen der dritten Zahl müssen in den Wert
	  <code class="constant">210</code> konvertiert werden.</p><p>Wir müssen festlegen, welche Trennsymbole
	  zulässig sind: Sollen die Eingabewerte durch Kommas
	  voneinander getrennt werden? Wenn ja, wie sollen zwei
	  Zahlen behandelt werden, die durch ein anderes Zeichen
	  getrennt sind?</p><p>Ich persönlich mag es einfach. Entweder etwas ist
	  eine Zahl, dann wird es verarbeitet, oder es ist keine
	  Zahl, dann wird es verworfen. Ich mag es nicht, wenn sich der
	  Computer bei der <span class="emphasis"><em>offensichtlichen</em></span>
	  Eingabe eines zusätzlichen Zeichens beschwert.
	  Duh!</p><p>Zusätzlich erlaubt es mir, die Monotonie des
	  Tippens zu durchbrechen, und eine Anfrage anstelle einer
	  simplen Zahl zu stellen:</p><pre class="screen"><strong class="userinput"><code>Was ist der beste Lochblendendurchmesser
	  bei einer Brennweite von 150?</code></strong></pre><p>Es gibt keinen Grund dafür, die Ausgabe mehrerer
	  Fehlermeldungen aufzuteilen:</p><pre class="screen">Syntax error: Was
Syntax error: ist
Syntax error: der
Syntax error: beste</pre><p>Et cetera, et cetera, et cetera.</p><p>Zweitens mag ich das <code class="constant">#</code>-Zeichen, um
	  Kommentare zu markieren, die ab dem Zeichen bis zum Ende der
	  jeweiligen Zeile gehen. Dies verlangt nicht viel
	  Programmieraufwand, und ermöglicht es mir, Eingabedateien
	  für meine Programme als ausführbare Skripte zu
	  handhaben.</p><p>In unserem Fall müssen wir auch entscheiden, in
	  welchen Einheiten die Dateneingabe erfolgen soll: Wir
	  wählen <span class="emphasis"><em>Millimeter</em></span>, da die meisten
	  Photographen die Brennweite in dieser Einheit messen.</p><p>Letztendlich müssen wir noch entscheiden, ob wir die
	  Verwendung des dezimalen Punktes erlauben (in diesem Fall
	  müssen wir berücksichtigen, daß in vielen
	  Ländern der Welt das dezimale <span class="emphasis"><em>Komma</em></span>
	  verwendet wird).</p><p>In unserem Fall würde das Zulassen eines dezimalen
	  Punktes/Kommas zu einer fälschlicherweise angenommenen,
	  höheren Genauigkeit führen: Der Unterschied
	  zwischen den Brennweiten <code class="constant">50</code> und
	  <code class="constant">51</code> ist fast nicht wahrnehmbar. Die
	  Zulassung von Eingaben wie <code class="constant">50.5</code> ist
	  also keine gute Idee. Beachten Sie bitte, das dies meine
	  Meinung ist. In diesem Fall bin ich der Autor des Programmes.
	  Bei Ihren eigenen Programmen müssen Sie selbst solche
	  Entscheidungen treffen.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-options"></a>11.13.3.2. Optionen anbieten</h4></div></div></div><p>Das wichtigste, was wir zum Bau einer Lochkamera
	  wissen müssen, ist der Durchmesser der Lochblende. Da
	  wir scharfe Bilder schießen wollen, werden wir obige
	  Formel für die Berechnung des korrekten Durchmessers zu
	  gegebener Brennweite verwenden. Da Experten mehrere
	  Werte für die <code class="constant">PC</code>-Konstante
	  anbieten, müssen wir uns hier für einen Wert
	  entscheiden.</p><p>In der Programmierung unter <span class="trademark">UNIX</span>® ist es üblich,
	  zwei Hauptvarianten anzubieten, um Parameter an Programme zu
	  übergeben, und des weiteren eine Standardeinstellung
	  für den Fall zu haben, das der Benutzer gar keine
	  Parameter angibt.</p><p>Warum zwei Varianten, Parameter anzugeben?</p><p>Ein Grund ist, eine (relativ) <span class="emphasis"><em>feste</em></span>
	  Einstellung anzubieten, die automatisch bei jedem
	  Programmaufruf verwendet wird, ohne das wir diese
	  Einstellung immer und immer wieder mit angeben
	  müssen.</p><p>Die feste Einstellung kann in einer Konfigurationsdatei
	  gespeichert sein, typischerweise im Heimatverzeichnis des
	  Benutzers. Die Datei hat üblicherweise denselben Namen
	  wie das zugehörige Programm, beginnt jedoch mit einem
	  Punkt. Häufig wird <span class="emphasis"><em>"rc"</em></span> dem
	  Dateinamen hinzugefügt. Unsere Konfigurationsdatei
	  könnte also <code class="filename">~/.pinhole</code> oder
	  <code class="filename">~/.pinholerc</code> heißen. (Die
	  Zeichenfolge <code class="filename">~/</code> steht für das
	  Heimatverzeichnis des aktuellen Benutzers.)</p><p>Konfigurationsdateien werden häufig von Programmen
	  verwendet, die viele konfigurierbare Parameter besitzen.
	  Programme, die nur eine (oder wenige) Parameter anbieten,
	  verwenden häufig eine andere Methode: Sie erwarten die
	  Parameter in einer <span class="emphasis"><em>Umgebungsvariablen</em></span>.
	  In unserem Fall könnten wir eine Umgebungsvariable mit
	  dem Namen <code class="varname">PINHOLE</code> benutzen.</p><p>Normalerweise verwendet ein Programm entweder die eine,
	  oder die andere der beiden obigen Methoden. Ansonsten
	  könnte ein Programm verwirrt werden, wenn eine
	  Konfigurationsdatei das eine sagt, die Umgebungsvariable
	  jedoch etwas anderes.</p><p>Da wir nur <span class="emphasis"><em>einen</em></span> Parameter
	  unterstützen müssen, verwenden wir die zweite
	  Methode, und benutzen eine Umgebungsvariable mit dem
	  Namen <code class="varname">PINHOLE</code>.</p><p>Der andere Weg erlaubt uns, <span class="emphasis"><em>ad hoc</em></span>
	  Entscheidungen zu treffen: <span class="emphasis"><em>"Obwohl ich
	  normalerweise einen Wert von 0.039 verwende, will ich dieses
	  eine Mal einen Wert von 0.03872 anwenden."</em></span>
	  Mit anderen Worten, dies erlaubt uns, die Standardeinstellung
	  außer Kraft zu setzen.</p><p>Diese Art der Auswahl wird häufig über
	  Kommandozeilenparameter gemacht.</p><p>Schließlich braucht ein Programm
	  <span class="emphasis"><em>immer</em></span> eine
	  <span class="emphasis"><em>Standardeinstellung</em></span>. Der Benutzer
	  könnte keine Parameter angeben. Vielleicht weiß
	  er auch gar nicht, was er einstellen sollte. Vielleicht will
	  er es "einfach nur ausprobieren". Vorzugsweise wird die
	  Standardeinstellung eine sein, die die meisten Benutzer
	  sowieso wählen würden. Somit müssen diese
	  keine zusätzlichen Parameter angeben, bzw. können
	  die Standardeinstellung ohne zusätzlichen Aufwand
	  benutzen.</p><p>Bei diesem System könnte das Programm
	  widersprüchliche Optionen vorfinden, und auf die
	  folgende Weise reagieren:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Wenn es eine <span class="emphasis"><em>ad
	      hoc</em></span>-Einstellung vorfindet (z.B. ein
	      Kommandozeilenparameter), dann sollte es diese
	      Einstellung annehmen. Es muß alle vorher
	      festgelegten sowie die standardmäßige
	      Einstellung ignorieren.</p></li><li class="step"><p><span class="emphasis"><em>Andererseits</em></span>, wenn es eine
	      festgelegte Option (z.B. eine Umgebungsvariable)
	      vorfindet, dann sollte es diese akzeptieren und die
	      Standardeinstellung ignorieren.</p></li><li class="step"><p><span class="emphasis"><em>Ansonsten</em></span> sollte es die
	      Standardeinstellung verwenden.</p></li></ol></div><p>Wir müssen auch entscheiden, welches
	  <span class="emphasis"><em>Format</em></span> unsere
	  <code class="constant">PC</code>-Option haben soll.</p><p>Auf den ersten Blick scheint es einleuchtend, das
	  Format <code class="varname">PINHOLE=0.04</code> für die
	  Umgebungsvariable, und <em class="parameter"><code>-p0.04</code></em>
	  für die Kommandozeile zu verwenden.</p><p>Dies zuzulassen wäre eigentlich eine
	  Sicherheitslücke. Die <code class="constant">PC</code>-Konstante
	  ist eine sehr kleine Zahl. Daher würden wir unsere
	  Anwendung mit verschiedenen, kleinen Werten für
	  <code class="constant">PC</code> testen. Aber was würde
	  passieren, wenn jemand das Programm mit einem sehr
	  großen Wert aufrufen würde?</p><p>Es könnte abstürzen, weil wir das Programm
	  nicht für den Umgang mit großen Werten
	  entworfen haben.</p><p>Oder wir investieren noch weiter Zeit in das Programm,
	  so daß dieses dann auch mit großen Zahlen
	  umgehen kann. Wir könnten dies machen, wenn wir
	  kommerzielle Software für computertechnisch
	  unerfahrene Benutzer schreiben würden.</p><p>Oder wir könnten auch sagen <span class="emphasis"><em>"Pech gehabt!
	  Der Benutzer sollte es besser wissen."</em></span></p><p>Oder wir könnten es für den Benutzer
	  unmöglich machen, große Zahlen einzugeben. Dies
	  ist die Variante, die wir verwenden werden: Wir nehmen einen
	  <span class="emphasis"><em>impliziten 0.</em></span>-Präfix an.</p><p>Mit anderen Worten, wenn der Benutzer den Wert
	  <code class="constant">0.04</code> angeben will, so muß er
	  entweder <em class="parameter"><code>-p04</code></em> als Parameter angeben,
	  oder <code class="varname">PINHOLE=04</code> als Variable in seiner
	  Umgebung definieren. Falls der Benutzer
	  <em class="parameter"><code>-p9999999</code></em> angibt, so wird dies als
	  <code class="constant">0.9999999</code> interpretiert&#8212;zwar
	  immer noch sinnlos, aber zumindest sicher.</p><p>Zweitens werden viele Benutzer einfach die Konstanten
	  von Bender oder Connors benutzen wollen. Um es diesen
	  Benutzern einfacher zu machen, werden wir
	  <em class="parameter"><code>-b</code></em> als <em class="parameter"><code>-p04</code></em>,
	  und <em class="parameter"><code>-c</code></em> als
	  <em class="parameter"><code>-p037</code></em> interpretieren.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-output"></a>11.13.3.3. Die Ausgabe</h4></div></div></div><p>Wir müssen festlegen, was und in welchem Format
	  unsere Anwendung Daten ausgeben soll.</p><p>Da wir als Eingabe beliebig viele Brennweiten
	  erlauben, macht es Sinn, die Ergebnisse in Form
	  einer traditionellen Datenbank&#8211;Ausgabe darzustellen,
	  bei der zeilenweise zu jeder Brennweite der
	  zugehörige berechnete Wert, getrennt durch ein
	  <code class="constant">tab</code>-Zeichen, ausgegeben wird.</p><p>Optional sollten wir dem Benutzer die Möglichkeit
	  geben, die Ausgabe in dem schon beschriebenen
	  <acronym class="acronym">CSV</acronym>-Format festzulegen. In diesem Fall
	  werden wir zu Beginn der Ausgabe eine Zeile einfügen,
	  in der die Beschreibungen der einzelnen Felder, durch
	  Kommas getrennt, aufgelistet werden, gefolgt von der Ausgabe
	  der Daten wie schon beschrieben, wobei das
	  <code class="constant">tab</code>-Zeichen durch ein
	  <code class="constant">Komma</code> ersetzt wird.</p><p>Wir brauchen eine Kommandozeilenoption für das
	  <acronym class="acronym">CSV</acronym>-Format. Wir können nicht
	  <em class="parameter"><code>-c</code></em> verwenden, da diese Option bereits
	  für <span class="emphasis"><em>verwende Connors Konstante</em></span>
	  steht. Aus irgendeinem seltsamen Grund bezeichnen
	  viele Webseiten <acronym class="acronym">CSV</acronym>-Dateien als
	  <span class="emphasis"><em>"Excel Kalkulationstabelle"</em></span> (obwohl das
	  <acronym class="acronym">CSV</acronym>-Format älter ist als Excel). Wir
	  werden daher <em class="parameter"><code>-e</code></em> als Schalter für
	  die Ausgabe im <acronym class="acronym">CSV</acronym>-Format
	  verwenden.</p><p>Jede Zeile der Ausgabe wird mit einer Brennweite
	  beginnen. Dies mag auf den ersten Blick überflüssig
	  erscheinen, besonders im interaktiven Modus: Der Benutzer
	  gibt einen Wert für die Brennweite ein, und das Programm
	  wiederholt diesen.</p><p>Der Benutzer kann jedoch auch mehrere Brennweiten
	  in einer Zeile angeben. Die Eingabe kann auch aus einer Datei,
	  oder aus der Ausgabe eines anderen Programmes, kommen. In
	  diesen Fällen sieht der Benutzer die Eingabewerte
	  überhaupt nicht.</p><p>Ebenso kann die Ausgabe in eine Datei umgelenkt werden,
	  was wir später noch untersuchen werden, oder sie
	  könnte an einen Drucker geschickt werden, oder auch
	  als Eingabe für ein weiteres Programm dienen.</p><p>Es macht also wohl Sinn, jede Zeile mit einer durch den
	  Benutzer eingegebenen Brennweite beginnen zu lassen.</p><p>Halt! Nicht, wie der Benutzer die Daten eingegeben hat.
	  Was passiert, wenn der Benutzer etwas wie folgt
	  eingibt:</p><pre class="screen"><strong class="userinput"><code>00000000150</code></strong></pre><p>Offensichtlich müssen wir die führenden Nullen
	  vorher abschneiden.</p><p>Wir müssen also die Eingabe des Benutzers
	  sorgfältig prüfen, diese dann in der
	  <acronym class="acronym">FPU</acronym> in die binäre Form konvertieren,
	  und dann von dort aus ausgeben.</p><p>Aber...</p><p>Was ist, wenn der Benutzer etwas wie folgt eingibt:</p><pre class="screen"><strong class="userinput"><code>17459765723452353453534535353530530534563507309676764423</code></strong></pre><p>Ha! Das packed decimal-Format der <acronym class="acronym">FPU</acronym>
	  erlaubt uns die Eingabe einer 18&#8211;stelligen
	  Zahl. Aber der Benutzer hat mehr als 18 Stellen eingegeben.
	  Wie gehen wir damit um?</p><p>Wir <span class="emphasis"><em>könnten</em></span> unser Programm
	  so modifizieren, daß es die ersten 18 Stellen liest,
	  der <acronym class="acronym">FPU</acronym> übergibt, dann weitere
	  18 Stellen liest, den Inhalt des <acronym class="acronym">TOS</acronym>
	  mit einem Vielfachen von 10, entsprechend der Anzahl der
	  zusätzlichen Stellen multipliziert, und dann beide
	  Werte mittels <code class="function">add</code> zusammen
	  addiert.</p><p>Ja, wir könnten das machen. Aber in
	  <span class="emphasis"><em>diesem</em></span> Programm wäre es
	  unnötig (in einem anderen wäre es vielleicht
	  der richtige Weg): Selbst der Erdumfang in Millimetern ergibt
	  nur eine Zahl mit 11 Stellen. Offensichtlich können wir
	  keine Kamera dieser Größe bauen (jedenfalls jetzt
	  noch nicht).</p><p>Wenn der Benutzer also eine so große Zahl eingibt,
	  ist er entweder gelangweilt, oder er testet uns, oder er
	  versucht, in das System einzudringen, oder er spielt&#8212;
	  indem er irgendetwas anderes macht als eine Lochkamera
	  zu entwerfen.</p><p>Was werden wir tun?</p><p>Wir werden ihn ohrfeigen, gewissermaßen:</p><pre class="screen">17459765723452353453534535353530530534563507309676764423	???	???	???	???	???</pre><p>Um dies zu erreichen, werden wir einfach alle
	  führenden Nullen ignorieren. Sobald wir eine Ziffer
	  gefunden haben, die nicht Null ist, initialisieren wir
	  einen Zähler mit <code class="constant">0</code> und
	  beginnen mit drei Schritten:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Sende die Ziffer an die Ausgabe.</p></li><li class="step"><p>Füge die Ziffer einem Puffer hinzu, welchen wir
	      später benutzen werden, um den packed decimal-Wert
	      zu erzeugen, den wir an die
	      <acronym class="acronym">FPU</acronym> schicken können.</p></li><li class="step"><p>Erhöhe den Zähler um eins.</p></li></ol></div><p>Während wir diese drei Schritte wiederholen,
	  müssen wir auf zwei Bedingungen achten:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Wenn der Zähler den Wert 18 übersteigt,
	      hören wir auf, Ziffern dem Puffer hinzuzufügen.
	      Wir lesen weiterhin Ziffern und senden sie an die
	      Ausgabe.</p></li><li class="listitem"><p>Wenn, bzw. <span class="emphasis"><em>falls</em></span>, das
	      nächste Eingabezeichen keine Zahl ist, sind wir mit
	      der Bearbeitung der Eingabe erst einmal fertig.</p><p>Übrigends können wir einfach Zeichen, die
	      keine Ziffern sind, verwerfen, solange sie kein
	      <code class="constant">#</code>-Zeichen sind, welches wir an den
	      Eingabestrom zurückgeben müssen. Dieses Zeichen
	      markiert den Beginn eines Kommentars. An dieser Stelle
	      muß die Erzeugung der Ausgabe fertig sein, und wir
	      müssen mit der Suche nach weiteren Eingabedaten
	      fortfahren.</p></li></ul></div><p>Es bleibt immer noch eine Möglichkeit
	  unberücksichtigt: Wenn der Benutzer eine Null (oder
	  mehrere) eingibt, werden wir niemals eine von Null
	  verschiedene Zahl vorfinden.</p><p>Wir können solch einen Fall immer anhand des
	  Zählerstandes feststellen, welcher dann
	  immer bei <code class="constant">0</code> bleibt. In diesem Fall
	  müssen wir einfach eine <code class="constant">0</code> an
	  die Ausgabe senden, und anschließend dem Benutzer
	  erneut eine "Ohrfeige" verpassen:</p><pre class="screen">0	???	???	???	???	???</pre><p>Sobald wir die Brennweite ausgegeben, und die
	  Gültigkeit dieser Eingabe verifiziert haben,
	  (größer als <code class="constant">0</code> und kleiner
	  als 18 Zahlen) können wir den Durchmesser der
	  Lochblende berechnen.</p><p>Es ist kein Zufall, daß
	  <span class="emphasis"><em>Lochblende</em></span> das Wort
	  <span class="emphasis"><em>Loch</em></span> enthält. In der Tat ist eine
	  Lochblende buchstäblich eine
	  <span class="emphasis"><em>Loch Blende</em></span>, also eine Blende, in die
	  mit einer Nadel vorsichtig ein kleines Loch gestochen
	  wird.</p><p>Daher ist eine typische Lochblende sehr klein. Unsere
	  Formel liefert uns das Ergebnis in Millimetern. Wir werden
	  dieses mit <code class="constant">1000</code> multiplizieren, so
	  daß die Ausgabe in <code class="constant">Mikrometern</code>
	  erfolgt.</p><p>An dieser Stelle müssen wir auf eine weitere Falle
	  achten: <span class="emphasis"><em>Zu hohe Genauigkeit.</em></span></p><p>Ja, die <acronym class="acronym">FPU</acronym> wurde für
	  mathematische Berechnungen mit hoher Genauigkeit entworfen.
	  Unsere Berechnungen hier erfordern jedoch keine solche
	  mathematische Genauigkeit. Wir haben es hier mit Physik zu
	  tun (Optik, um genau zu sein).</p><p>Angenommen, wir wollten aus eine Lastkraftwagen eine
	  Lochkamera bauen (wir wären dabei nicht die
	  ersten, die das versuchen würden!). Angenommen, die
	  Länge des Laderaumes beträgt <code class="constant">12</code>
	  Meter lang, so daß wir eine Brennweite von
	  <code class="constant">12000</code> hätten. Verwenden wir
	  Benders Konstante, so erhalten wir durch Multiplizieren
	  von <code class="constant">0.04</code> mit der Quadratwurzel aus
	  <code class="constant">12000</code> einen Wert von
	  <code class="constant">4.381780460</code> Millimetern, oder
	  <code class="constant">4381.780460</code> Micrometern.</p><p>So oder so ist das Rechenergebnis absurd präzise.
	  Unser Lastkraftwagen ist nicht <span class="emphasis"><em>genau</em></span>
	  <code class="constant">12000</code> Millimeter lang. Wir haben
	  diese Länge nicht mit einer so hohen Genauigkeit
	  gemessen, weswegen es falsch wäre zu behaupten,
	  unser Lochblendendurchmesser müsse exakt
	  <code class="constant">4.381780460</code> Millimeter sein. Es
	  reicht vollkommen aus, wenn der Durchmesser
	  <code class="constant">4.4</code> Millimeter beträgt.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Ich habe in obigem Beispiel das Rechenergebnis "nur"
	    auf 10 Stellen genau angegeben. Stellen Sie sich vor,
	    wie absurd es wäre, die vollen uns zur Verfügung
	    stehenden, 18 Stellen anzugeben!</p></div><p>Wir müssen also die Anzahl der signifikanten Stellen
	  beschränken. Eine Möglichkeit wäre, die
	  Mikrometer durch eine ganze Zahl darzustellen. Unser
	  Lastkraftwaren würde dann eine Lochblende mit einem
	  Durchmesser von <code class="constant">4382</code> Mikrometern
	  benötigen. Betrachten wir diesen Wert, dann stellen wir
	  fest, das <code class="constant">4400</code> Mikrometer, oder
	  <code class="constant">4.4</code> Millimeter, immer noch genau
	  genug ist.</p><p>Zusätzlich können wir noch, unabhängig von
	  der Größe eines Rechenergebnisses, festlegen,
	  daß wir nur vier signifikante Stellen anzeigen wollen
	  (oder weniger). Leider bietet uns die <acronym class="acronym">FPU</acronym>
	  nicht die Möglichkeit, das Ergebnis automatisch bis
	  auf eine bestimmte Stelle zu runden (sie sieht die Daten ja
	  nicht als Zahlen, sondern als binäre Daten an).</p><p>Wir müssen also selber einen Algorithmus entwerfen,
	  um die Anzahl der signifikanten Stellen zu reduzieren.</p><p>Hier ist meiner (ich denke er ist peinlich&#8212;wenn
	  Ihnen ein besserer Algorithmus einfällt, verraten sie
	  ihn mir <span class="emphasis"><em>bitte</em></span>):</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Initialisiere einen Zähler mit
	      <code class="constant">0</code>.</p></li><li class="step"><p>Solange die Zahl größer oder gleich
	      <code class="constant">10000</code> ist, dividiere die Zahl durch
	      <code class="constant">10</code>, und erhöhe den Zähler
	      um eins.</p></li><li class="step"><p>Gebe das Ergebnis aus.</p></li><li class="step"><p>Solange der Zähler größer als
	      <code class="constant">0</code> ist, gebe eine
	      <code class="constant">0</code> aus, und reduziere den Zähler
	      um eins.</p></li></ol></div><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Der Wert <code class="constant">10000</code> ist nur für
	    den Fall, daß Sie <span class="emphasis"><em>vier</em></span>
	    signifikante Stellen haben wollen. Für eine andere
	    Anzahl signifikanter Stellen müssen Sie den Wert
	    <code class="constant">10000</code> mit <code class="constant">10</code>,
	    hoch der Anzahl der gewünschten signifikanten Stellen,
	    ersetzen.</p></div><p>Wir können so den Lochblendendurchmesser, auf vier
	  signifikante Stellen gerundet, ausgeben.</p><p>An dieser Stellen kennen wir nun die <span class="emphasis"><em>Brennweite
	  </em></span> und den
	  <span class="emphasis"><em>Lochblendendurchmesser</em></span>. Wir haben also
	  jetzt genug Informationen, um den
	  <span class="emphasis"><em>f&#8211;Wert</em></span> zu bestimmen.</p><p>Wir werden den f&#8211;Wert, auf vier signifikante
	  Stellen gerundet, ausgeben. Es könnte passieren,
	  daß diese vier Stellen recht wenig aussagen. Um die
	  Aussagekraft des f&#8211;Wertes zu erhöhen, könnten
	  wir den nächstliegenden, <span class="emphasis"><em>normalisierten
	  f&#8211;Wert</em></span> bestimmen, also z.B. das
	  nächstliegende Vielfache der Quadratwurzel aus 2.</p><p>Wir erreichen dies, indem wir den aktuellen f&#8211;Wert
	  mit sich selbst multiplizieren, so daß wir dessen
	  Quadrat (<code class="function">square</code>) erhalten.
	  Anschließend berechnen wir den Logarithmus zur Basis 2
	  von dieser Zahl. Dies ist sehr viel einfacher, als direkt den
	  Logarithmus zur Basis der Quadratwurzel aus 2 zu berechnen!
	  Wir runden dann das Ergebnis auf die nächstliegende
	  ganze Zahl. Genau genommen können wir mit Hilfe der
	  <acronym class="acronym">FPU</acronym> diese Berechnung beschleunigen: Wir
	  können den op-Code
	  <code class="function">fscale</code> verwenden, um eine
	  Zahl um 1 zu "skalieren", was dasselbe ist, wie eine Zahl
	  mittels <code class="function">shift</code> um eine
	  Stelle nach links zu verschieben. Am Ende berechnen wir noch
	  die Quadratwurzel aus allem, und erhalten dann den
	  nächstliegenden, normalisierten f&#8211;Wert.</p><p>Wenn das alles jetzt viel zu kompliziert wirkt&#8212;oder
	  viel zu aufwendig&#8212;wird es vielleicht klarer, wenn man
	  den Code selber betrachtet. Wir benötigen insgesamt
	  9 op-Codes:</p><pre class="programlisting">fmul    st0, st0
    fld1
    fld     st1
    fyl2x
    frndint
    fld1
    fscale
    fsqrt
    fstp    st1</pre><p>Die erste Zeile,
	  <code class="function">fmul st0, st0</code>, quadriert
	  den Inhalt des <acronym class="acronym">TOS</acronym> (Top Of Stack, was
	  dasselbe ist wie <code class="varname">st</code>, von
	  <span class="application">nasm</span> auch
	  <code class="varname">st0</code> genannt). Die Funktion
	  <code class="function">fld1</code> fügt eine
	  <code class="constant">1</code> dem <acronym class="acronym">TOS</acronym>
	  hinzu.</p><p>Die nächste Zeile, <code class="function">fld
	  st1</code>, legt das Quadrat auf dem
	  <acronym class="acronym">TOS</acronym> ab. An diesem Punkt befindet sich das
	  Quadrat sowohl in <code class="varname">st</code> als
	  auch in <code class="varname">st(2)</code> (es wird
	  sich gleich zeigen, warum wir eine zweite Kopie auf dem
	  Stack lassen.) <code class="varname">st(1)</code>
	  enthält die <code class="constant">1</code>.</p><p>Im nächsten Schritt, <code class="function">fyl2x</code>, wird der Logarithmus von
	  <code class="varname">st</code> zur Basis 2 berechnet,
	  und anschließend mit <code class="varname">st(1)</code> multipliziert. Deshalb haben
	  wir vorher die <code class="constant">1</code> in <code class="varname">st(1)</code> abgelegt.</p><p>An dieser Stelle enthält
	  <code class="varname">st</code> den gerade berechneten
	  Logarithmus, und <code class="varname">st(1)</code>
	  das Quadrat des aktuellen f&#8211;Wertes, den wir für
	  später gespeichert haben.</p><p><code class="function">frndint</code> rundet den
	  <acronym class="acronym">TOS</acronym> zur nächstliegenden ganzen Zahl.
	  <code class="function">fld1</code> legt eine
	  <code class="constant">1</code> auf dem Stack ab.
	  <code class="function">fscale</code> shiftet die
	  <code class="constant">1</code> auf dem <acronym class="acronym">TOS</acronym> um
	  <code class="varname">st(1)</code> Stellen, wodurch im
	  Endeffekt eine 2 in <code class="varname">st(1)</code>
	  steht.</p><p>Schließlich berechnet
	  <code class="function">fsqrt</code> die Quadratwurzel
	  des Rechenergebnisses, also des nächstliegenden,
	  normalisierten f&#8211;Wertes.</p><p>Wir haben nun den nächstliegenden, normalisierten
	  f&#8211;Wert auf dem <acronym class="acronym">TOS</acronym> liegen, den auf
	  den Logarithmus zur Basis 2 gerundeten, nächstliegenden
	  ganzzahligen Wert in <code class="varname">st(1)</code>, und das Quadrat des
	  aktuellen f&#8211;Wertes in <code class="varname">st(2)</code>. Wir speichern den Wert
	  für eine spätere Verwendung in <code class="varname">st(2)</code>.</p><p>Aber wir brauchen den Inhalt von
	  <code class="varname">st(1)</code> gar nicht mehr. Die
	  letzte Zeile, <code class="function">fstp st1</code>,
	  platziert den Inhalt von <code class="varname">st</code>
	  in <code class="varname">st(1)</code>, und erniedrigt
	  den Stackpointer um eins. Dadurch ist der Inhalt von
	  <code class="varname">st(1)</code> jetzt
	  <code class="varname">st</code>, der Inhalt von
	  <code class="varname">st(2)</code> jetzt
	  <code class="varname">st(1)</code> usw. Der neue
	  <code class="varname">st</code> speichert jetzt den
	  normalisierten f&#8211;Wert. Der neue
	  <code class="varname">st(1)</code> speichert das
	  Quadrat des aktuellen f&#8211;Wertes für die
	  Nachwelt.</p><p>Jetzt können wir den normalisierten f&#8211;Wert
	  ausgeben. Da er normalisiert ist, werden wir ihn nicht auf
	  vier signifikante Stellen runden, sondern stattdessen
	  mit voller Genauigkeit ausgeben.</p><p>Der normalisierte f&#8211;Wert ist nützlich, solange
	  er so klein ist, daß wir ihn auf einem Photometer
	  wiederfinden können. Ansonsten brauchen wir eine andere
	  Methode, um die benötigten Belichtungsdaten zu
	  bestimmen.</p><p>Wir haben weiter oben eine Formel aufgestellt, über
	  die wir einen f&#8211;Wert mit Hilfe eines anderen
	  f&#8211;Wertes und den zugehörigen Belichtungsdaten
	  bestimmen können.</p><p>Jedes Photometer, das ich jemals gesehen habe, konnte
	  die benötigte Belichtungszeit für f5.6 berechnen.
	  Wir werden daher einen
	  <span class="emphasis"><em>"f5.6 Multiplizierer"</em></span> berechnen, der
	  uns den Faktor angibt, mit dem wir die bei f5.6 gemessene
	  Belichtungszeit für unsere Lochkamera multiplizieren
	  müssen.</p><p>Durch die Formel wissen wir, daß dieser Faktor
	  durch Dividieren unseres f&#8211;Wertes (der aktuelle Wert,
	  nicht der normalisierte) durch <code class="constant">5.6</code>
	  und anschließendes Quadrieren, berechnen
	  können.</p><p>Mathematisch äquivalent dazu wäre, wenn wir
	  das Quadrat unseres f&#8211;Wertes durch das Quadrat von
	  <code class="constant">5.6</code> dividieren würden.</p><p>Numerisch betrachtet wollen wir nicht zwei Zahlen
	  quadrieren, wenn es möglich ist, nur
	  eine Zahl zu quadrieren. Daher wirkt die erste Variante
	  auf den ersten Blick besser.</p><p>Aber...</p><p><code class="constant">5.6</code> ist eine
	  <span class="emphasis"><em>Konstante</em></span>. Wir müssen nicht
	  wertvolle Rechenzeit der <acronym class="acronym">FPU</acronym> verschwenden.
	  Es reicht aus, daß wir die Quadrate der einzelnen
	  f&#8211;Werte durch den konstanten Wert
	  <code class="constant">5.6²</code> dividieren. Oder wir
	  können den jeweiligen f&#8211;Wert durch
	  <code class="constant">5.6</code> dividieren, und dann das Ergebnis
	  quadrieren. Zwei Möglichkeiten, die gleich
	  erscheinen.</p><p>Aber das sind sie nicht!</p><p>Erinnern wir uns an die Grundlagen der Photographie
	  weiter oben, dann wissen wir, daß sich die
	  Konstante <code class="constant">5.6</code> aus dem 5-fachen der
	  Quadratwurzel aus 2 ergibt. Eine
	  <span class="emphasis"><em>irrationale</em></span> Zahl. Das Quadrat dieser
	  Zahl ist <span class="emphasis"><em>exakt</em></span>
	  <code class="constant">32</code>.</p><p><code class="constant">32</code> ist nicht nur eine ganze Zahl,
	  sondern auch ein Vielfaches von 2. Wir brauchen also
	  gar nicht das Quadrat eines f&#8211;Wertes durch
	  <code class="constant">32</code> zu teilen. Wir müssen lediglich
	  mittels <code class="function">fscale</code> den
	  f&#8211;Wert um fünf Stellen nach rechts shiften.
	  Aus Sicht der <acronym class="acronym">FPU</acronym> müssen wir also
	  <code class="function">fscale</code> mit
	  <code class="varname">st(1)</code>, welcher gleich
	  <code class="constant">-5</code> ist, auf den f&#8211;Wert anwenden.
	  Dies ist <span class="emphasis"><em>sehr viel schneller</em></span> als die
	  Division.</p><p>Jetzt wird es auch klar, warum wir das Quadrat des
	  f&#8211;Wertes ganz oben auf dem Stack der
	  <acronym class="acronym">FPU</acronym> gespeichert haben. Die Berechnung
	  des f5.6 Multiplizierers ist die einfachste Berechnung
	  des gesamten Programmes! Wir werden das Ergebnis auf vier
	  signifikante Stellen gerundet ausgeben.</p><p>Es gibt noch eine weitere nützliche Zahl, die wir
	  berechnen können: Die Anzahl der Stopps, die unser
	  f&#8211;Wert von f5.6 entfernt ist. Dies könnte
	  hilfreich sein, wenn unser f&#8211;Wert außerhalb des
	  Meßbereiches unseres Photometers liegt, wir aber eine
	  Blende haben, bei der wir unterschiedliche Geschwindigkeiten
	  einstellen können, und diese Blende Stopps
	  benutzt.</p><p>Angenommen, unser f&#8211;Wert ist 5 Stopps von f5.6
	  entfernt, und unser Photometer sagt uns, daß wir eine
	  Belichtungszeit von 1/1000 Sek. einstellen sollen. Dann
	  können wir unsere Blende auf die Geschwindigkeit 1/1000
	  einstellen, und unsere Skala um 5 Stopps verschieben.</p><p>Diese Rechnung ist ebenfalls sehr einfach. Alles, was
	  wir tun müssen, ist, den Logarithmus des f5.6
	  Multiplizierers, den wir schon berechnet haben (wobei wir
	  dessen Wert vor der Rundung nehmen müssen) zur Basis 2
	  zu nehmen. Wir runden dann das Ergebnis zur nächsten
	  ganzen Zahl hin, und geben dies aus. Wir müssen uns
	  nicht darum kümmern, ob wir mehr als vier signifikante
	  Stellen haben: Das Ergebnis besteht
	  höchstwahrscheinlich nur aus einer oder zwei
	  Stellen.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-fpu-optimizations"></a>11.13.4. FPU Optimierungen</h3></div></div></div><p>In Assemblersprache können wir den Code für die
	<acronym class="acronym">FPU</acronym> besser optimieren, als in einer der
	Hochsprachen, inklusive C.</p><p>Sobald eine C-Funktion die Berechnung einer
	Fließkommazahl durchführen will, lädt sie erst
	einmal alle benötigten Variablen und Konstanten in die
	Register der <acronym class="acronym">FPU</acronym>. Dann werden die
	Berechnungen durchgeführt, um das korrekte Ergebnis zu
	erhalten. Gute C-Compiler können diesen Teil des Codes
	sehr gut optimieren.</p><p>Das Ergebnis wird "zurückgegeben", indem dieses auf
	dem <acronym class="acronym">TOS</acronym> abgelegt wird. Vorher wird
	aufgeräumt. Sämtliche Variablen und Konstanten, die
	während der Berechnung verwendet wurden, werden dabei
	aus der <acronym class="acronym">FPU</acronym> entfernt.</p><p>Was wir im vorherigen Abschnitt selber getan haben, kann so
	nicht durchgeführt werden: Wir haben das Quadrat des
	f&#8211;Wertes berechnet, und das Ergebnis für eine
	weitere Berechnung mit einer anderen Funktion auf dem Stack
	behalten.</p><p>Wir <span class="emphasis"><em>wußten</em></span>, daß wir
	diesen Wert später noch einmal brauchen würden. Wir
	wußten auch, daß auf dem Stack genügend Platz
	war (welcher nur Platz für 8 Zahlen bietet), um den Wert
	dort zu speichern.</p><p>Ein C-Compiler kann nicht wissen, ob ein Wert auf dem
        Stack in naher Zukunft noch einmal gebraucht wird.</p><p>Natürlich könnte der C-Programmierer dies wissen.
	Aber die einzige Möglichkeit, die er hat, ist, den Wert
	im verfügbaren Speicher zu halten.</p><p>Das bedeutet zum einen, daß der Wert mit der
	<acronym class="acronym">FPU</acronym>-internen, 80-stelligen
	Genauigkeit in einer normalen C-Variable vom Typ
	<span class="emphasis"><em>double</em></span> (64 Bit) oder vom Typ
	<span class="emphasis"><em>single</em></span> (32 Bit) gespeichert wird.</p><p>Dies bedeutet außerdem, daß der Wert aus dem
	<acronym class="acronym">TOS</acronym> in den Speicher verschoben werden
	muß, und später wieder zurück. Von allen
	Operationen mit der <acronym class="acronym">FPU</acronym> ist der Zugriff
	auf den Speicher die langsamste.</p><p>Wann immer also mit der <acronym class="acronym">FPU</acronym> in einer
	Assemblersprache programmiert wird, sollte nach
	Möglichkeiten gesucht werden, Zwischenergebnisse auf dem
	Stack der <acronym class="acronym">FPU</acronym> zu lassen.</p><p>Wir können mit dieser Idee noch einen Schritt weiter
	gehen! In unserem Programm verwenden wir eine
	<span class="emphasis"><em>Konstante</em></span> (die wir <code class="constant">PC</code>
	genannt haben).</p><p>Es ist unwichtig, wieviele Lochblendendurchmesser wir
	berechnen: 1, 10, 20, 1000, wir verwenden immer dieselbe
	Konstante. Daher können wir unser Programm so optimieren,
	daß diese Konstante immer auf dem Stack belassen
	wird.</p><p>Am Anfang unseres Programmes berechnen wir die oben
	erwähnte Konstante. Wir müssen die Eingabe für
	jede Dezimalstelle der Konstanten durch <code class="constant">10</code>
	dividieren.</p><p>Multiplizieren geht sehr viel schneller als Dividieren.
	Wir teilen also zu Beginn unseres Programmes
	<code class="constant">1</code> durch <code class="constant">10</code>, um
	<code class="constant">0.1</code> zu erhalten, was wir auf dem Stack
	speichern: Anstatt daß wir nun für jede einzelne
	Dezimalstelle die Eingabe wieder durch <code class="constant">10</code>
	teilen,	multiplizieren wir sie stattdessen mit
	<code class="constant">0.1</code>.</p><p>Auf diese Weise geben wir <code class="constant">0.1</code> nicht
	direkt ein, obwohl wir dies könnten. Dies hat einen Grund:
	Während <code class="constant">0.1</code> durch nur eine einzige
	Dezimalstelle dargestellt werden kann, wissen wir nicht,
	wieviele <span class="emphasis"><em>binäre</em></span> Stellen benötigt
	werden. Wir überlassen die Berechnung des binären
	Wertes daher der <acronym class="acronym">FPU</acronym>, mit dessen eigener,
	hoher Genauigkeit.</p><p>Wir verwenden noch weitere Konstanten: Wir multiplizieren
	den Lochblendendurchmesser mit <code class="constant">1000</code>, um
	den Wert von Millimeter in Micrometer zu konvertieren. Wir
	vergleichen Werte mit <code class="constant">10000</code>, wenn wir
	diese auf vier signifikante Stellen runden wollen. Wir
	behalten also beide Konstanten, <code class="constant">1000</code>
	und <code class="constant">10000</code>, auf dem Stack. Und
	selbstverständlich verwenden wir erneut die gespeicherte
	<code class="constant">0.1</code>, um Werte auf vier signifikante
	Stellen zu runden.</p><p>Zu guter letzt behalten wir <code class="constant">-5</code> noch
	auf dem Stack. Wir brauchen diesen Wert, um das Quadrat des
	f&#8211;Wertes zu skalieren, anstatt diesen durch
	<code class="constant">32</code> zu teilen. Es ist kein Zufall, daß
	wir diese Konstante als letztes laden. Dadurch wird diese
	Zahl die oberste Konstante auf dem Stack. Wenn später
	das Quadrat des f&#8211;Wertes skaliert werden muß,
	befindet sich die <code class="constant">-5</code> in
	<code class="varname">st(1)</code>, also genau da, wo
	die Funktion <code class="function">fscale</code> diesen
	Wert erwartet.</p><p>Es ist üblich, einige Konstanten per Hand zu erzeugen,
	anstatt sie aus dem Speicher zu laden. Genau das machen wir
	mit der <code class="constant">-5</code>:</p><pre class="programlisting">
    	fld1			; TOS =  1
    	fadd	st0, st0	; TOS =  2
    	fadd	st0, st0	; TOS =  4
    	fld1			; TOS =  1
    	faddp	st1, st0	; TOS =  5
    	fchs			; TOS = -5</pre><p>Wir können all diese Optimierungen in einer Regel
	zusammenfassen: <span class="emphasis"><em>Behalte wiederverwendbare Werte auf
	dem Stack!</em></span></p><div xmlns="" class="tip"><h3 class="admontitle">Tipp: </h3><p xmlns="http://www.w3.org/1999/xhtml"><span class="emphasis"><em><span class="trademark">PostScript</span>®</em></span> ist eine
	  Stack-orientierte Programmiersprache. Es gibt weit mehr
	  Bücher über <span class="trademark">PostScript</span>®, als über die
	  Assemblersprache der <acronym class="acronym">FPU</acronym>: Werden Sie
	  in <span class="trademark">PostScript</span>® besser, dann werden Sie auch automatisch
	  in der Programmierung der <acronym class="acronym">FPU</acronym>
	  besser.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-the-code"></a>11.13.5. <span class="application">pinhole</span>&#8212;Der Code</h3></div></div></div><pre class="programlisting">
;;;;;;; pinhole.asm ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; Find various parameters of a pinhole camera construction and use
;
; Started:	 9-Jun-2001
; Updated:	10-Jun-2001
;
; Copyright (c) 2001 G. Adam Stanislav
; All rights reserved.
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

%include	'system.inc'

%define	BUFSIZE	2048

section	.data
align 4
ten	dd	10
thousand	dd	1000
tthou	dd	10000
fd.in	dd	stdin
fd.out	dd	stdout
envar	db	'PINHOLE='	; Exactly 8 bytes, or 2 dwords long
pinhole	db	'04,', 		; Bender's constant (0.04)
connors	db	'037', 0Ah	; Connors' constant
usg	db	'Usage: pinhole [-b] [-c] [-e] [-p &lt;value&gt;] [-o &lt;outfile&gt;] [-i &lt;infile&gt;]', 0Ah
usglen	equ	$-usg
iemsg	db	"pinhole: Can't open input file", 0Ah
iemlen	equ	$-iemsg
oemsg	db	"pinhole: Can't create output file", 0Ah
oemlen	equ	$-oemsg
pinmsg	db	"pinhole: The PINHOLE constant must not be 0", 0Ah
pinlen	equ	$-pinmsg
toobig	db	"pinhole: The PINHOLE constant may not exceed 18 decimal places", 0Ah
biglen	equ	$-toobig
huhmsg	db	9, '???'
separ	db	9, '???'
sep2	db	9, '???'
sep3	db	9, '???'
sep4	db	9, '???', 0Ah
huhlen	equ	$-huhmsg
header	db	'focal length in millimeters,pinhole diameter in microns,'
	db	'F-number,normalized F-number,F-5.6 multiplier,stops '
	db	'from F-5.6', 0Ah
headlen	equ	$-header

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE
dbuffer	resb	20		; decimal input buffer
bbuffer	resb	10		; BCD buffer

section	.text
align 4
huh:
	call	write
	push	dword huhlen
	push	dword huhmsg
	push	dword [fd.out]
	sys.write
	add	esp, byte 12
	ret

align 4
perr:
	push	dword pinlen
	push	dword pinmsg
	push	dword stderr
	sys.write
	push	dword 4		; return failure
	sys.exit

align 4
consttoobig:
	push	dword biglen
	push	dword toobig
	push	dword stderr
	sys.write
	push	dword 5		; return failure
	sys.exit

align 4
ierr:
	push	dword iemlen
	push	dword iemsg
	push	dword stderr
	sys.write
	push	dword 1		; return failure
	sys.exit

align 4
oerr:
	push	dword oemlen
	push	dword oemsg
	push	dword stderr
	sys.write
	push	dword 2
	sys.exit

align 4
usage:
	push	dword usglen
	push	dword usg
	push	dword stderr
	sys.write
	push	dword 3
	sys.exit

align 4
global	_start
_start:
	add	esp, byte 8	; discard argc and argv[0]
	sub	esi, esi

.arg:
	pop	ecx
	or	ecx, ecx
	je	near .getenv		; no more arguments

	; ECX contains the pointer to an argument
	cmp	byte [ecx], '-'
	jne	usage

	inc	ecx
	mov	ax, [ecx]
	inc	ecx

.o:
	cmp	al, 'o'
	jne	.i

	; Make sure we are not asked for the output file twice
	cmp	dword [fd.out], stdout
	jne	usage

	; Find the path to output file - it is either at [ECX+1],
	; i.e., -ofile --
	; or in the next argument,
	; i.e., -o file

	or	ah, ah
	jne	.openoutput
	pop	ecx
	jecxz	usage

.openoutput:
	push	dword 420	; file mode (644 octal)
	push	dword 0200h | 0400h | 01h
	; O_CREAT | O_TRUNC | O_WRONLY
	push	ecx
	sys.open
	jc	near oerr

	add	esp, byte 12
	mov	[fd.out], eax
	jmp	short .arg

.i:
	cmp	al, 'i'
	jne	.p

	; Make sure we are not asked twice
	cmp	dword [fd.in], stdin
	jne	near usage

	; Find the path to the input file
	or	ah, ah
	jne	.openinput
	pop	ecx
	or	ecx, ecx
	je near usage

.openinput:
	push	dword 0		; O_RDONLY
	push	ecx
	sys.open
	jc	near ierr		; open failed

	add	esp, byte 8
	mov	[fd.in], eax
	jmp	.arg

.p:
	cmp	al, 'p'
	jne	.c
	or	ah, ah
	jne	.pcheck

	pop	ecx
	or	ecx, ecx
	je	near usage

	mov	ah, [ecx]

.pcheck:
	cmp	ah, '0'
	jl	near usage
	cmp	ah, '9'
	ja	near usage
	mov	esi, ecx
	jmp	.arg

.c:
	cmp	al, 'c'
	jne	.b
	or	ah, ah
	jne	near usage
	mov	esi, connors
	jmp	.arg

.b:
	cmp	al, 'b'
	jne	.e
	or	ah, ah
	jne	near usage
	mov	esi, pinhole
	jmp	.arg

.e:
	cmp	al, 'e'
	jne	near usage
	or	ah, ah
	jne	near usage
	mov	al, ','
	mov	[huhmsg], al
	mov	[separ], al
	mov	[sep2], al
	mov	[sep3], al
	mov	[sep4], al
	jmp	.arg

align 4
.getenv:
	; If ESI = 0, we did not have a -p argument,
	; and need to check the environment for "PINHOLE="
	or	esi, esi
	jne	.init

	sub	ecx, ecx

.nextenv:
	pop	esi
	or	esi, esi
	je	.default	; no PINHOLE envar found

	; check if this envar starts with 'PINHOLE='
	mov	edi, envar
	mov	cl, 2		; 'PINHOLE=' is 2 dwords long
rep	cmpsd
	jne	.nextenv

	; Check if it is followed by a digit
	mov	al, [esi]
	cmp	al, '0'
	jl	.default
	cmp	al, '9'
	jbe	.init
	; fall through

align 4
.default:
	; We got here because we had no -p argument,
	; and did not find the PINHOLE envar.
	mov	esi, pinhole
	; fall through

align 4
.init:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	sub	edx, edx
	mov	edi, dbuffer+1
	mov	byte [dbuffer], '0'

	; Convert the pinhole constant to real
.constloop:
	lodsb
	cmp	al, '9'
	ja	.setconst
	cmp	al, '0'
	je	.processconst
	jb	.setconst

	inc	dl

.processconst:
	inc	cl
	cmp	cl, 18
	ja	near consttoobig
	stosb
	jmp	short .constloop

align 4
.setconst:
	or	dl, dl
	je	near perr

	finit
	fild	dword [tthou]

	fld1
	fild	dword [ten]
	fdivp	st1, st0

	fild	dword [thousand]
	mov	edi, obuffer

	mov	ebp, ecx
	call	bcdload

.constdiv:
	fmul	st0, st2
	loop	.constdiv

	fld1
	fadd	st0, st0
	fadd	st0, st0
	fld1
	faddp	st1, st0
	fchs

	; If we are creating a CSV file,
	; print header
	cmp	byte [separ], ','
	jne	.bigloop

	push	dword headlen
	push	dword header
	push	dword [fd.out]
	sys.write

.bigloop:
	call	getchar
	jc	near done

	; Skip to the end of the line if you got '#'
	cmp	al, '#'
	jne	.num
	call	skiptoeol
	jmp	short .bigloop

.num:
	; See if you got a number
	cmp	al, '0'
	jl	.bigloop
	cmp	al, '9'
	ja	.bigloop

	; Yes, we have a number
	sub	ebp, ebp
	sub	edx, edx

.number:
	cmp	al, '0'
	je	.number0
	mov	dl, 1

.number0:
	or	dl, dl		; Skip leading 0's
	je	.nextnumber
	push	eax
	call	putchar
	pop	eax
	inc	ebp
	cmp	ebp, 19
	jae	.nextnumber
	mov	[dbuffer+ebp], al

.nextnumber:
	call	getchar
	jc	.work
	cmp	al, '#'
	je	.ungetc
	cmp	al, '0'
	jl	.work
	cmp	al, '9'
	ja	.work
	jmp	short .number

.ungetc:
	dec	esi
	inc	ebx

.work:
	; Now, do all the work
	or	dl, dl
	je	near .work0

	cmp	ebp, 19
	jae	near .toobig

	call	bcdload

	; Calculate pinhole diameter

	fld	st0	; save it
	fsqrt
	fmul	st0, st3
	fld	st0
	fmul	st5
	sub	ebp, ebp

	; Round off to 4 significant digits
.diameter:
	fcom	st0, st7
	fstsw	ax
	sahf
	jb	.printdiameter
	fmul	st0, st6
	inc	ebp
	jmp	short .diameter

.printdiameter:
	call	printnumber	; pinhole diameter

	; Calculate F-number

	fdivp	st1, st0
	fld	st0

	sub	ebp, ebp

.fnumber:
	fcom	st0, st6
	fstsw	ax
	sahf
	jb	.printfnumber
	fmul	st0, st5
	inc	ebp
	jmp	short .fnumber

.printfnumber:
	call	printnumber	; F number

	; Calculate normalized F-number
	fmul	st0, st0
	fld1
	fld	st1
	fyl2x
	frndint
	fld1
	fscale
	fsqrt
	fstp	st1

	sub	ebp, ebp
	call	printnumber

	; Calculate time multiplier from F-5.6

	fscale
	fld	st0

	; Round off to 4 significant digits
.fmul:
	fcom	st0, st6
	fstsw	ax
	sahf

	jb	.printfmul
	inc	ebp
	fmul	st0, st5
	jmp	short .fmul

.printfmul:
	call	printnumber	; F multiplier

	; Calculate F-stops from 5.6

	fld1
	fxch	st1
	fyl2x

	sub	ebp, ebp
	call	printnumber

	mov	al, 0Ah
	call	putchar
	jmp	.bigloop

.work0:
	mov	al, '0'
	call	putchar

align 4
.toobig:
	call	huh
	jmp	.bigloop

align 4
done:
	call	write		; flush output buffer

	; close files
	push	dword [fd.in]
	sys.close

	push	dword [fd.out]
	sys.close

	finit

	; return success
	push	dword 0
	sys.exit

align 4
skiptoeol:
	; Keep reading until you come to cr, lf, or eof
	call	getchar
	jc	done
	cmp	al, 0Ah
	jne	.cr
	ret

.cr:
	cmp	al, 0Dh
	jne	skiptoeol
	ret

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	clc
	ret

read:
	jecxz	.read
	call	write

.read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword [fd.in]
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.empty
	sub	eax, eax
	ret

align 4
.empty:
	add	esp, byte 4
	stc
	ret

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	jecxz	.ret	; nothing to write
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword [fd.out]
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
.ret:
	ret

align 4
bcdload:
	; EBP contains the number of chars in dbuffer
	push	ecx
	push	esi
	push	edi

	lea	ecx, [ebp+1]
	lea	esi, [dbuffer+ebp-1]
	shr	ecx, 1

	std

	mov	edi, bbuffer
	sub	eax, eax
	mov	[edi], eax
	mov	[edi+4], eax
	mov	[edi+2], ax

.loop:
	lodsw
	sub	ax, 3030h
	shl	al, 4
	or	al, ah
	mov	[edi], al
	inc	edi
	loop	.loop

	fbld	[bbuffer]

	cld
	pop	edi
	pop	esi
	pop	ecx
	sub	eax, eax
	ret

align 4
printnumber:
	push	ebp
	mov	al, [separ]
	call	putchar

	; Print the integer at the TOS
	mov	ebp, bbuffer+9
	fbstp	[bbuffer]

	; Check the sign
	mov	al, [ebp]
	dec	ebp
	or	al, al
	jns	.leading

	; We got a negative number (should never happen)
	mov	al, '-'
	call	putchar

.leading:
	; Skip leading zeros
	mov	al, [ebp]
	dec	ebp
	or	al, al
	jne	.first
	cmp	ebp, bbuffer
	jae	.leading

	; We are here because the result was 0.
	; Print '0' and return
	mov	al, '0'
	jmp	putchar

.first:
	; We have found the first non-zero.
	; But it is still packed
	test	al, 0F0h
	jz	.second
	push	eax
	shr	al, 4
	add	al, '0'
	call	putchar
	pop	eax
	and	al, 0Fh

.second:
	add	al, '0'
	call	putchar

.next:
	cmp	ebp, bbuffer
	jb	.done

	mov	al, [ebp]
	push	eax
	shr	al, 4
	add	al, '0'
	call	putchar
	pop	eax
	and	al, 0Fh
	add	al, '0'
	call	putchar

	dec	ebp
	jmp	short .next

.done:
	pop	ebp
	or	ebp, ebp
	je	.ret

.zeros:
	mov	al, '0'
	call	putchar
	dec	ebp
	jne	.zeros

.ret:
	ret</pre><p>Der Code folgt demselben Aufbau wie alle anderen Filter,
	die wir bisher gesehen haben, bis auf eine Kleinigkeit:</p><div class="blockquote"><blockquote class="blockquote"><p>Wir nehmen nun nicht mehr an, daß das Ende
	  der Eingabe auch das Ende der nötigen Arbeit bedeutet,
	  etwas, das wir für <span class="emphasis"><em>zeichenbasierte</em></span>
	  Filter automatisch angenommen haben.</p><p>Dieser Filter verarbeitet keine Zeichen. Er verarbeitet
	  eine <span class="emphasis"><em>Sprache</em></span> (obgleich eine sehr
	  einfache, die nur aus Zahlen besteht).</p><p>Wenn keine weiteren Eingaben vorliegen, kann das zwei
	  Ursachen haben:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Wir sind fertig und können aufhören. Dies
	      ist dasselbe wie vorher.</p></li><li class="listitem"><p>Das Zeichen, das wir eingelesen haben, war eine Zahl.
	      Wir haben diese am Ende unseres <acronym class="acronym">ASCII</acronym>
	      &#8211;zu&#8211;float Kovertierungspuffers gespeichert.
	      Wir müssen nun den gesamten Pufferinhalt in eine
	      Zahl konvertieren, und die letzte Zeile unserer Ausgabe
	      ausgeben.</p></li></ul></div><p>Aus diesem Grund haben wir unsere <code class="function">getchar
	  </code>- und <code class="function">read</code>-Routinen
	  so angepaßt, daß sie das
	  <code class="varname">carry flag</code>
	  <span class="emphasis"><em>clear</em></span> immer dann zurückgeben, wenn
	  wir ein weiteres Zeichen aus der Eingabe lesen, und das
	  <code class="varname">carry flag</code>
	  <span class="emphasis"><em>set</em></span> immer dann zurückgeben, wenn
	  es keine weiteren Eingabedaten gibt.</p><p>Selbstverständlich verwenden wir auch hier die
	  Magie der Assemblersprache! Schauen Sie sich
	  <code class="function">getchar</code> näher an. Dieses gibt
	  <span class="emphasis"><em>immer</em></span> das
	  <code class="varname">carry flag</code>
	  <span class="emphasis"><em>clear</em></span> zurück.</p><p>Dennoch basiert der Hauptteil unseres Programmes auf dem
	  <code class="varname">carry flag</code>, um diesem eine
	  Beendigung mitzuteilen&#8212;und es funktioniert.</p><p>Die Magie passiert in <code class="function">read</code>. Wann
	  immer weitere Eingaben durch das System zur Verfügung
	  stehen, ruft diese Funktion <code class="function">getchar</code>
	  auf, welche ein weiteres Zeichen aus dem Eingabepuffer
	  einliest, und anschließend das
	  <code class="varname">carry flag</code>
	  <span class="emphasis"><em>clear</em></span>t.</p><p>Wenn aber <code class="function">read</code> keine weiteren
	  Eingaben von dem System bekommt, ruft dieses
	  <span class="emphasis"><em>nicht</em></span> <code class="function">getchar</code>
	  auf. Stattdessen addiert der op-Code
	  <code class="function">add esp, byte 4</code>
	  <code class="constant">4</code> zu
	  <code class="varname">ESP</code> hinzu,
	  <span class="emphasis"><em>setzt</em></span> das
	  <code class="varname">carry flag</code>, und
	  springt zurück.</p><p>Wo springt diese Funktion hin? Wann immer ein Programm
	  den op-Code <code class="function">call</code>
	  verwendet, <code class="function">push</code>t der
	  Mikroprozessor die Rücksprungandresse, d.h. er
	  speichert diese ganz oben auf dem Stack (nicht auf dem
	  Stack der <acronym class="acronym">FPU</acronym>, sondern auf dem Systemstack,
	  der sich im Hauptspeicher befindet). Wenn ein Programm den
	  op-Code <code class="function">ret</code> verwendet,
	  <code class="function">pop</code>t der
	  Mikroprozessor den Rückgabewert von dem Stack, und
	  springt zu der Adresse, die dort gespeichert wurde.</p><p>Da wir aber <code class="constant">4</code> zu
	  <code class="varname">ESP</code> hinzuaddiert haben
	  (welches das Register der Stackzeiger ist), haben wir
	  effektiv dem Mikroprzessor eine kleine
	  <span class="emphasis"><em>Amnesie</em></span> verpaßt: Dieser erinnert
	  sich nun nicht mehr daran, daß
	  <code class="function">getchar</code> durch
	  <code class="function">read</code> aufgerufen wurde.</p><p>Und da <code class="function">getchar</code> nichts vor dem
	  Aufruf von <code class="function">read</code> auf dem Stack abgelegt
	  hat, enthält der Anfang des Stacks nun die
	  Rücksprungadresse von der Funktion, die
	  <code class="function">getchar</code> aufgerufen hat. Soweit es den
	  Aufrufer betrifft, hat dieser <code class="function">getchar</code>
	  ge<code class="function">call</code>t, welche mit
	  einem gesetzten
	  <code class="varname">carry flag</code>
	  <code class="function">ret</code>urned.</p></blockquote></div><p>Des weiteren wird die Routine <code class="function">bcdload</code>
	bei einem klitzekleinen Problem zwischen der Big&#8211;Endian-
	und Little&#8211;Endian-Codierung aufgerufen.</p><p>Diese konvertiert die Textrepräsentation einer
	Zahl in eine andere Textrepräsentation: Der Text wird
	in der Big&#8211;Endian-Codierung gespeichert, die
	<span class="emphasis"><em>packed decimal</em></span>-Darstellung jedoch in der
	Little&#8211;Endian-Codierung.</p><p>Um dieses Problem zu lösen haben wir vorher den
	op-Code <code class="function">std</code> verwendet. Wir machen diesen
	Aufruf später mittels <code class="function">cld</code> wieder
	rückgängig: Es ist sehr wichtig, daß wir keine
	Funktion mittels <code class="function">call</code> aufrufen, die von
	einer Standardeinstellung des
	<span class="emphasis"><em>Richtungsflags</em></span> abhängig ist,
	während <code class="function">std</code> ausgeführt
	wird.</p><p>Alles weitere in dem Programm sollte leicht zu verstehen
	sein, vorausgesetzt, daß Sie das gesamte vorherige
	Kapitel gelesen haben.</p><p>Es ist ein klassisches Beispiel für das Sprichwort,
	daß das Programmieren eine Menge Denkarbeit, und nur
	ein wenig Programmcode benötigt. Sobald wir uns über
	jedes Detail im klaren sind, steht der Code fast schon
	da.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-using"></a>11.13.6. Das Programm <span class="application">pinhole</span>
	verwenden</h3></div></div></div><p>Da wir uns bei dem Programm dafür entschieden haben,
	alle Eingaben, die keine Zahlen sind, zu ignorieren (selbst
	die in Kommentaren), können wir jegliche
	<span class="emphasis"><em>textbasierten Eingaben</em></span> verarbeiten. Wir
	<span class="emphasis"><em>müssen</em></span> dies nicht tun, wir
	<span class="emphasis"><em>könnten</em></span> aber.</p><p>Meiner bescheidenen Meinung nach wird ein Programm durch
	die Möglichkeit, anstatt einer strikten Eingabesyntax
	textbasierte Anfragen stellen zu können, sehr viel
	benutzerfreundlicher.</p><p>Angenommen, wir wollten eine Lochkamera für einen
	4x5 Zoll Film bauen. Die standardmäßige Brennweite
	für diesen Film ist ungefähr 150mm.
	Wir wollen diesen Wert <span class="emphasis"><em>optimieren</em></span>, so
	daß der Lochblendendurchmesser eine möglichst
	runde Zahl ergibt. Lassen Sie uns weiter annehmen, daß
	wir zwar sehr gut mit Kameras umgehen können, dafür
	aber nicht so gut mit Computern. Anstatt das wir nun eine
	Reihe von Zahlen eingeben, wollen wir lieber ein paar
	<span class="emphasis"><em>Fragen</em></span> stellen.</p><p>Unsere Sitzung könnte wie folgt aussehen:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>pinhole

Computer,

Wie groß müßte meine Lochblende bei einer Brennweite
von 150 sein?</code></strong>
150	490	306	362	2930	12
<strong class="userinput"><code>Hmmm... Und bei 160?</code></strong>
160	506	316	362	3125	12
<strong class="userinput"><code>Laß uns bitte 155 nehmen.</code></strong>
155	498	311	362	3027	12
<strong class="userinput"><code>Ah, laß uns 157 probieren...</code></strong>
157	501	313	362	3066	12
<strong class="userinput"><code>156?</code></strong>
156	500	312	362	3047	12
<strong class="userinput"><code>Das ist es! Perfekt! Vielen Dank!
^D</code></strong></pre><p>Wir haben herausgefunden, daß der
	Lochblendendurchmesser bei einer Brennweite von 150 mm
	490 Mikrometer, oder 0.49 mm ergeben würde. Bei einer fast
	identischen Brennweite von 156 mm würden wir
	einen Durchmesser von genau einem halben Millimeter
	bekommen.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-scripting"></a>11.13.7. Skripte schreiben</h3></div></div></div><p>Da wir uns dafür entschieden haben, das Zeichen
	<code class="constant">#</code> als den Anfang eines Kommentares zu
	interpretieren, können wir unser
	<span class="application">pinhole</span>-Programm auch als
	<span class="emphasis"><em>Skriptsprache</em></span> verwenden.</p><p>Sie haben vielleicht schon einmal
	<span class="application">shell</span><span class="emphasis"><em>-Skripte</em></span>
	gesehen, die mit folgenden Zeichen begonnen haben:</p><pre class="programlisting">#! /bin/sh</pre><p>...oder...</p><pre class="programlisting">#!/bin/sh</pre><p>... da das Leerzeichen hinter dem <code class="function">#!</code>
	optional ist.</p><p>Wann immer <span class="trademark">UNIX</span>® eine Datei ausführen soll, die mit
	einem <code class="function">#!</code> beginnt, wird angenommen, das
	die Datei ein Skript ist. Es fügt den Befehl an das Ende
	der ersten Zeile an, und versucht dann, dieses
	auszuführen.</p><p>Angenommen, wir haben unser Programm
	<span class="application">pinhole</span> unter
	<span class="application">/usr/local/bin/</span> installiert, dann
	können wir nun Skripte schreiben, um unterschiedliche
	Lochblendendurchmesser für mehrere Brennweiten
	zu berechnen, die normalerweise mit 120er Filmen verwendet
	werden.</p><p>Das Skript könnte wie folgt aussehen:</p><pre class="programlisting">#! /usr/local/bin/pinhole -b -i
# Find the best pinhole diameter
# for the 120 film

### Standard
80

### Wide angle
30, 40, 50, 60, 70

### Telephoto
100, 120, 140</pre><p>Da ein 120er Film ein Film mittlerer Größe ist,
	könnten wir die Datei <span class="application">medium</span>
	nennen.</p><p>Wir können die Datei ausführbar machen und dann
	aufrufen, als wäre es ein Programm:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>chmod 755 medium</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./medium</code></strong></pre><p><span class="trademark">UNIX</span>® wird den letzten Befehl wie folgt
	interpretieren:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>/usr/local/bin/pinhole -b -i ./medium</code></strong></pre><p>Es wird den Befehl ausführen und folgendes
	ausgeben:</p><pre class="screen">80	358	224	256	1562	11
30	219	137	128	586	9
40	253	158	181	781	10
50	283	177	181	977	10
60	310	194	181	1172	10
70	335	209	181	1367	10
100	400	250	256	1953	11
120	438	274	256	2344	11
140	473	296	256	2734	11</pre><p>Lassen Sie uns nun das folgende eingeben:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./medium -c</code></strong></pre><p><span class="trademark">UNIX</span>® wird dieses wie folgt behandeln:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>/usr/local/bin/pinhole -b -i ./medium -c</code></strong></pre><p>Dadurch erhält das Programm zwei
	widersprüchliche Optionen: <em class="parameter"><code>-b</code></em> und
	<em class="parameter"><code>-c</code></em> (Verwende Benders Konstante und
	verwende Connors Konstante). Wir haben unser Programm so
	geschrieben, daß später eingelesene Optionen die
	vorheringen überschreiben&#8212;unser Programm wird also
	Connors Konstante für die Berechnungen verwenden:</p><pre class="screen">80	331	242	256	1826	11
30	203	148	128	685	9
40	234	171	181	913	10
50	262	191	181	1141	10
60	287	209	181	1370	10
70	310	226	256	1598	11
100	370	270	256	2283	11
120	405	296	256	2739	11
140	438	320	362	3196	12</pre><p>Wir entscheiden uns am Ende doch für Benders
	Konstante. Wir wollen die Ergebnisse im CSV-Format in
	einer Datei speichern:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./medium -b -e &gt; bender</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>cat bender</code></strong>
focal length in millimeters,pinhole diameter in microns,F-number,normalized F-number,F-5.6 multiplier,stops from F-5.6
80,358,224,256,1562,11
30,219,137,128,586,9
40,253,158,181,781,10
50,283,177,181,977,10
60,310,194,181,1172,10
70,335,209,181,1367,10
100,400,250,256,1953,11
120,438,274,256,2344,11
140,473,296,256,2734,11
<code class="prompt">%</code></pre></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-caveats"></a>11.14. Vorsichtsmassnahmen</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Daniel</span> <span class="surname">Seuffert</span></span>. </span></div></div></div><p>Assembler-Programmierer, die aufwuchsen mit
      <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> und windows <span class="trademark">Windows</span>® neigen oft
      dazu Shotcuts zu verwenden. Das Lesen der Tastatur-Scancodes und
      das direkte Schreiben in den Grafikspeicher sind zwei klassische
      Beispiele von Gewohnheiten, die unter
      <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> nicht verpönt sind, aber nicht
      als richtig angesehen werden.</p><p>Warum dies? Sowohl das <acronym class="acronym">PC-BIOS</acronym> als auch
      <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> sind notorisch langsam bei der
      Ausführung dieser Operationen.</p><p>Sie mögen versucht sein ähnliche Angewohnheiten
      in der <span class="trademark">UNIX</span>®-Umgebung fortzuführen. Zum Beispiel habe ich
      eine Webseite gesehen, welche erklärt, wie man auf einem
      beliebten <span class="trademark">UNIX</span>®-Ableger die Tastatur-Scancodes
      verwendet.</p><p>Das ist generell eine <span class="emphasis"><em>sehr schlechte
      Idee</em></span> in einer <span class="trademark">UNIX</span>®-Umgebung! Lassen Sie mich
      erklären warum.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-protected"></a>11.14.1. <span class="trademark">UNIX</span>® ist geschützt</h3></div></div></div><p>Zum Einen mag es schlicht nicht möglich sein.
	<span class="trademark">UNIX</span>® läuft im Protected Mode. Nur der Kernel und
	Gerätetreiber dürfen direkt auf die Hardware
	zugreifen. Unter Umständen erlaubt es Ihnen ein
	bestimmter <span class="trademark">UNIX</span>®-Ableger Tastatur-Scancodes auszulesen, aber
	ein wirkliches <span class="trademark">UNIX</span>®-Betriebssystem wird dies zu verhindern
	wissen. Und falls eine Version es Ihnen erlaubt wird es eine
	andere nicht tun, daher kann eine sorgfältig erstellte
	Software über Nacht zu einem überkommenen
	Dinosaurier werden.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-abstraction"></a>11.14.2. <span class="trademark">UNIX</span>® ist eine Abstraktion</h3></div></div></div><p>Aber es gibt einen viel wichtigeren Grund, weshalb Sie
	nicht versuchen sollten, die Hardware direkt anzusprechen
	(natürlich nicht, wenn Sie einen Gerätetreiber
	schreiben), selbst auf den <span class="trademark">UNIX</span>®-ähnlichen Systemen, die
	es Ihnen erlauben:</p><p><span class="emphasis"><em><span class="trademark">UNIX</span>® ist eine Abstraktion!</em></span></p><p>Es gibt einen wichtigen Unterschied in der
	Design-Philosophie zwischen <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> und
	<span class="trademark">UNIX</span>®. <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> wurde entworfen als
	Einzelnutzer-System. Es läuft auf einem Rechner mit einer
	direkt angeschlossenen Tastatur und einem direkt
	angeschlossenem Bildschirm. Die Eingaben des Nutzers kommen
	nahezu immer von dieser Tastatur. Die Ausgabe Ihres Programmes
	erscheint fast immer auf diesem Bildschirm.</p><p>Dies ist NIEMALS garantiert unter <span class="trademark">UNIX</span>®. Es ist sehr
	verbreitet für ein <span class="trademark">UNIX</span>®, daß der Nutzer seine
	Aus- und Eingaben kanalisiert und umleitet:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>program1 | program2 | program3 &gt; file1</code></strong></pre><p>Falls Sie eine Anwendung
	<span class="application">program2</span> geschrieben haben, kommt
	ihre Eingabe nicht von der Tastatur, sondern von der Ausgabe
	von <span class="application">program1</span>. Gleichermassen geht
	Ihre Ausgabe nicht auf den Bildschirm, sondern wird zur
	Eingabe für <span class="application">program3</span>, dessen
	Ausgabe wiederum in <code class="filename">file1</code> endet.</p><p>Aber es gibt noch mehr! Selbst wenn Sie sichergestellt
	haben, daß Ihre Eingabe und Ausgabe zum Terminal kommt
	bzw. gelangt, dann ist immer noch nicht garantiert, daß
	ihr Terminal ein PC ist: Es mag seinen Grafikspeicher nicht
	dort haben, wo Sie ihn erwarten, oder die Tastatur könnte
	keine <acronym class="acronym">PC</acronym>-ähnlichen Scancodes erzeugen
	können. Es mag ein <span class="trademark">Macintosh</span>® oder irgendein anderer
	Rechner sein.</p><p>Sie mögen nun den Kopf schütteln: Mein
	Programm ist in <acronym class="acronym">PC</acronym>-Assembler geschrieben,
	wie kann es auf einem <span class="trademark">Macintosh</span>® laufen? Aber ich habe nicht
	gesagt, daß Ihr Programm auf <span class="trademark">Macintosh</span>® läuft, nur
	sein Terminal mag ein <span class="trademark">Macintosh</span>® sein.</p><p>Unter <span class="trademark">UNIX</span>® muß der Terminal nicht direkt am
	Rechner angeschlossen sein, auf dem die Software läuft,
	er kann sogar auf einem anderen Kontinent sein oder sogar auf
	einem anderen Planeten. Es ist nicht ungewöhnlich,
	daß ein <span class="trademark">Macintosh</span>®-Nutzer in Australien sich auf ein
	<span class="trademark">UNIX</span>®-System in Nordamerika (oder sonstwo) mittels
	<span class="application">telnet</span> verbindet. Die Software
	läuft auf einem Rechner während das Terminal sich
	auf einem anderen Rechner befindet: Falls Sie versuchen
	sollten die Scancodes auszulesen werden Sie die falschen
	Eingaben erhalten!</p><p>Das Gleiche gilt für jede andere Hardware: Eine
	Datei, welche Sie einlesen, mag auf einem Laufwerk sein, auf
	das Sie keinen direkten Zugriff haben. Eine Kamera, deren
	Bilder Sie auslesen, befindet sich möglicherweise in
	einem Space Shuttle, durch Satelliten mit Ihnen
	verbunden.</p><p>Das sind die Gründe, weshalb Sie niemals unter
	<span class="trademark">UNIX</span>® Annahmen treffen dürfen, woher Ihre Daten kommen
	oder gehen. Lassen Sie immer das System den physischen Zugriff
	auf die Hardware regeln.</p><div xmlns="" class="note"><h3 class="admontitle">Anmerkung: </h3><p xmlns="http://www.w3.org/1999/xhtml">Das sind Vorsichtsmassnahmen, keine absoluten Regeln.
	  Ausnahmen sind möglich. Wenn zum Beispiel ein
	  Texteditor bestimmt hat, daß er auf einer lokalen
	  Maschine läuft, dann mag er die Tastatur-Scancodes
	  direkt auslesen, um eine bessere Kontrolle zu
	  gewährleisten. Ich erwähne diese
	  Vorsichtsmassnahmen nicht, um Ihnen zu sagen, was sie tun
	  oder lassen sollen, ich will Ihnen nur bewusst machen,
	  daß es bestimmte Fallstricke gibt, die Sie erwarten,
	  wenn Sie soeben ihn <span class="trademark">UNIX</span>® von <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>
	  angelangt sind. Kreative Menschen brechen oft Regeln und das
	  ist in Ordnung, solange sie wissen welche Regeln und
	  warum.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-acknowledgements"></a>11.15. Danksagungen</h2></div><div><span class="authorgroup">Übersetzt von <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Daniel</span> <span class="surname">Seuffert</span></span>. </span></div></div></div><p>Dieses Handbuch wäre niemals möglich gewesen
      ohne die Hilfe vieler erfahrener FreeBSD-Programmierer aus
      <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hackers" target="_top">FreeBSD technical
  discussions</a>. Viele dieser Personen haben geduldig meine Fragen
      beantwortet und mich in die richtige Richtung gewiesen bei
      meinem Versuch, die tieferen liegenden Mechanismen der
      <span class="trademark">UNIX</span>®-Systemprogrammierung zu erforschen im Allgemeinen und bei
      FreeBSD im Besonderen.</p><p>Thomas M. Sommers öffnete die Türen für
      mich. Seine <a class="link" href="http://www.codebreakers-journal.com/content/view/262/27/" target="_top">Wie
      schreibe ich "Hallo Welt" in FreeBSD-Assembler?</a> Webseite
      war mein erster Kontakt mit Assembler-Programmierung unter
      FreeBSD.</p><p>Jake Burkholder hat die Tür offen gehalten durch das
      bereitwillige Beantworten all meiner Fragen und das
      Zurverfügungstellen von Assembler-Codebeispielen.</p><p>Copyright © 2000-2001 G. Adam Stanislav. Alle Rechte
      vorbehalten.</p></div></div></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="appendices"></a>Teil V. Anhang</h1></div></div></div><div class="toc"><div class="toc-title">Inhaltsverzeichnis</div><dl class="toc"><dt><span class="bibliography"><a href="#idp68549968">Literaturverzeichnis</a></span></dt></dl></div><div class="bibliography"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp68549968"></a>Literaturverzeichnis</h2></div></div></div><div class="biblioentry"><a id="COD"></a><p>[1] <span class="authorgroup"><span class="firstname">Dave</span> <span class="othername">A</span> <span class="surname">Patterson</span> und <span class="firstname">John</span> <span class="othername">L</span> <span class="surname">Hennessy</span>. </span><span class="copyright">Copyright © 1998 Morgan Kaufmann Publishers, Inc.. </span><span class="biblioid">1-55860-428-6. </span><span class="publisher"><span class="publishername">Morgan Kaufmann Publishers,
	    Inc.. </span></span><span class="citetitle"><em class="citetitle">Computer Organization and Design</em>. </span><span class="subtitle">The Hardware / Software Interface. </span><span class="pagenums">1-2. </span></p></div><div class="biblioentry"><a id="idp68561616"></a><p>[2] <span class="authorgroup"><span class="firstname">W.</span> <span class="othername">Richard</span> <span class="surname">Stevens</span>. </span><span class="copyright">Copyright © 1993 Addison Wesley Longman, Inc.. </span><span class="biblioid">0-201-56317-7. </span><span class="publisher"><span class="publishername">Addison Wesley Longman, Inc.. </span></span><span class="citetitle"><em class="citetitle">Advanced Programming in the Unix Environment</em>. </span><span class="pagenums">1-2. </span></p></div><div class="biblioentry"><a id="idp68567120"></a><p>[3] <span class="authorgroup"><span class="firstname">Marshall</span> <span class="othername">Kirk</span> <span class="surname">McKusick</span> und <span class="firstname">George</span> <span class="surname">Neville-Neil</span>. </span><span class="copyright">Copyright © 2004 Addison-Wesley Publishing Company, Inc.. </span><span class="biblioid">0-201-70245-2. </span><span class="publisher"><span class="publishername">Addison-Wesley. </span></span><span class="citetitle"><em class="citetitle">The Design and Implementation of the FreeBSD Operating
	  System</em>. </span><span class="pagenums">1-2. </span></p></div><div class="biblioentry"><a id="Phrack"></a><p>[4] <span class="authorgroup"><span class="firstname">Aleph</span> <span class="surname">One</span>. </span><span class="citetitle"><em class="citetitle">Phrack 49; "Smashing the Stack for Fun and
	  Profit"</em>. </span></p></div><div class="biblioentry"><a id="StackGuard"></a><p>[5] <span class="authorgroup"><span class="firstname">Chrispin</span> <span class="surname">Cowan</span>, <span class="firstname">Calton</span> <span class="surname">Pu</span> und <span class="firstname">Dave</span> <span class="surname">Maier</span>. </span><span class="citetitle"><em class="citetitle">StackGuard; Automatic Adaptive Detection and Prevention
	  of Buffer-Overflow Attacks</em>. </span></p></div><div class="biblioentry"><a id="OpenBSD"></a><p>[6] <span class="authorgroup"><span class="firstname">Todd</span> <span class="surname">Miller</span> und <span class="firstname">Theo</span> <span class="surname">de Raadt</span>. </span><span class="citetitle"><em class="citetitle">strlcpy and strlcat -- consistent, safe string copy and
	  concatenation.</em>. </span></p></div></div></div><div class="index"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp68599888"></a>Stichwortverzeichnis</h1></div></div></div><div class="index"><div class="indexdiv"><h3>A</h3><dl><dt>Arguments, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt></dl></div><div class="indexdiv"><h3>B</h3><dl><dt>Beigesteuerte Software, <a class="indexterm" href="#policies-contributed">Beigesteuerte Software</a></dt><dt>Benutzer-IDs</dt><dd><dl><dt>effective Benutzer-ID, <a class="indexterm" href="#secure-setuid">SetUID-Themen</a></dt><dt>reale Benutzer-ID, <a class="indexterm" href="#secure-setuid">SetUID-Themen</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>C</h3><dl><dt>chroot(), <a class="indexterm" href="#secure-chroot">Die Umgebung ihrer Programme einschränken</a></dt><dt>Core-Team, <a class="indexterm" href="#policies-encumbered">Belastende Dateien</a></dt></dl></div><div class="indexdiv"><h3>D</h3><dl><dt>Datenvalidierung, <a class="indexterm" href="#secure-trust">Vertrauen</a></dt></dl></div><div class="indexdiv"><h3>F</h3><dl><dt>Frame-Pointer, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt></dl></div><div class="indexdiv"><h3>G</h3><dl><dt>GCC, <a class="indexterm" href="#idp65867088">Compiler-basierte Laufzeitüberprüfung
	  von Grenzen</a></dt><dt>GTK, <a class="indexterm" href="#l10n-programming">I18N-konforme Anwendungen programmieren</a></dt></dl></div><div class="indexdiv"><h3>J</h3><dl><dt>Jail, <a class="indexterm" href="#idp65934288">Die Jail-Funktionalität in FreeBSD</a></dt></dl></div><div class="indexdiv"><h3>L</h3><dl><dt>LIFO, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt></dl></div><div class="indexdiv"><h3>M</h3><dl><dt>Morris Internetwurm, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt></dl></div><div class="indexdiv"><h3>N</h3><dl><dt>NUL-Terminierung, <a class="indexterm" href="#idp65856464">Puffer-Überläufe vermeiden</a></dt></dl></div><div class="indexdiv"><h3>O</h3><dl><dt>OpenBSD, <a class="indexterm" href="#idp65856464">Puffer-Überläufe vermeiden</a></dt></dl></div><div class="indexdiv"><h3>P</h3><dl><dt>Perl, <a class="indexterm" href="#idp66018000">Perl und Python</a></dt><dt>Perl Taint-Modus, <a class="indexterm" href="#secure-trust">Vertrauen</a></dt><dt>Ports-Maintainer, <a class="indexterm" href="#policies-maintainer">MAINTAINER eines Makefiles</a></dt><dt>positive Filterung, <a class="indexterm" href="#secure-trust">Vertrauen</a></dt><dt>POSIX.1e Process
	Capabilities, <a class="indexterm" href="#idp65953232">POSIX®.1e Prozess Capabilities</a></dt><dt>ProPolice, <a class="indexterm" href="#idp65867088">Compiler-basierte Laufzeitüberprüfung
	  von Grenzen</a></dt><dt>Prozessabbild</dt><dd><dl><dt>Frame-Pointer, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt><dt>Stack-Pointer, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt></dl></dd><dt>Prüfung von Grenzen</dt><dd><dl><dt>Bibliotheks-basiert, <a class="indexterm" href="#idp65886928">Bibliotheks-basierte Laufzeitüberprüfung
	  von Grenzen</a></dt><dt>Compiler-basiert, <a class="indexterm" href="#idp65867088">Compiler-basierte Laufzeitüberprüfung
	  von Grenzen</a></dt></dl></dd><dt>Puffer-Überlauf, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a>, <a class="indexterm" href="#idp65867088">Compiler-basierte Laufzeitüberprüfung
	  von Grenzen</a></dt><dt>Python, <a class="indexterm" href="#idp66018000">Perl und Python</a></dt></dl></div><div class="indexdiv"><h3>Q</h3><dl><dt>Qt, <a class="indexterm" href="#l10n-programming">I18N-konforme Anwendungen programmieren</a></dt></dl></div><div class="indexdiv"><h3>R</h3><dl><dt>Race-Conditions</dt><dd><dl><dt>Öffnen von Dateien, <a class="indexterm" href="#secure-race-conditions">Race-Conditions</a></dt><dt>Signale, <a class="indexterm" href="#secure-race-conditions">Race-Conditions</a></dt><dt>Zugriffsprüfungen, <a class="indexterm" href="#secure-race-conditions">Race-Conditions</a></dt></dl></dd><dt>Release-Engineer, <a class="indexterm" href="#policies-encumbered">Belastende Dateien</a></dt><dt>Rücksprungadresse, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt></dl></div><div class="indexdiv"><h3>S</h3><dl><dt>seteuid, <a class="indexterm" href="#secure-setuid">SetUID-Themen</a></dt><dt>Stack, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt><dt>Stack-Frame, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt><dt>Stack-Pointer, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt><dt>Stack-Überlauf, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt><dt>StackGuard, <a class="indexterm" href="#idp65867088">Compiler-basierte Laufzeitüberprüfung
	  von Grenzen</a></dt><dt>style, <a class="indexterm" href="#policies-style">Stil-Richtlinien</a></dt></dl></div><div class="indexdiv"><h3>T</h3><dl><dt>TrustedBSD, <a class="indexterm" href="#idp65953232">POSIX®.1e Prozess Capabilities</a></dt></dl></div><div class="indexdiv"><h3>V</h3><dl><dt>Von-Neuman, <a class="indexterm" href="#secure-bufferov">Puffer-Überläufe</a></dt></dl></div><div class="indexdiv"><h3>Z</h3><dl><dt>Zeichenketten-Kopierfunktioen</dt><dd><dl><dt>strncpy, <a class="indexterm" href="#idp65856464">Puffer-Überläufe vermeiden</a></dt></dl></dd><dt>Zeichenketten-Kopierfunktionen</dt><dd><dl><dt>strlcat, <a class="indexterm" href="#idp65856464">Puffer-Überläufe vermeiden</a></dt><dt>strlcpy, <a class="indexterm" href="#idp65856464">Puffer-Überläufe vermeiden</a></dt><dt>strncat, <a class="indexterm" href="#idp65856464">Puffer-Überläufe vermeiden</a></dt></dl></dd></dl></div></div></div></div></body></html>