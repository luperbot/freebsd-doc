<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>章 9. Kernel Debugging</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD Developers' Handbook" /><link rel="up" href="kernel.html" title="部 III. Kernel(核心)" /><link rel="prev" href="kernel.html" title="部 III. Kernel(核心)" /><link rel="next" href="kerneldebug-gdb.html" title="9.2. Debugging a Kernel Crash Dump with kgdb" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">章 9. Kernel Debugging</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="kernel.html">前一頁</a> </td><th width="60%" align="center">部 III. Kernel(核心)</th><td width="20%" align="right"> <a accesskey="n" href="kerneldebug-gdb.html">下一頁</a></td></tr></table><hr /></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kerneldebug"></a>章 9. Kernel Debugging</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Paul</span> <span class="surname">Richards</span></span> 且 <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jörg</span> <span class="surname">Wunsch</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">內容目錄</div><dl class="toc"><dt><span class="sect1"><a href="kerneldebug.html#kerneldebug-obtain">9.1. Obtaining a Kernel Crash Dump</a></span></dt><dt><span class="sect1"><a href="kerneldebug-gdb.html">9.2. Debugging a Kernel Crash Dump with <code class="command">kgdb</code></a></span></dt><dt><span class="sect1"><a href="kerneldebug-ddd.html">9.3. Debugging a Crash Dump with DDD</a></span></dt><dt><span class="sect1"><a href="kerneldebug-post-mortem.html">9.4. Post-Mortem Analysis of a Dump</a></span></dt><dt><span class="sect1"><a href="kerneldebug-online-ddb.html">9.5. On-Line Kernel Debugging Using DDB</a></span></dt><dt><span class="sect1"><a href="kerneldebug-online-gdb.html">9.6. On-Line Kernel Debugging Using Remote GDB</a></span></dt><dt><span class="sect1"><a href="kerneldebug-kld.html">9.7. Debugging Loadable Modules Using GDB</a></span></dt><dt><span class="sect1"><a href="kerneldebug-console.html">9.8. Debugging a Console Driver</a></span></dt><dt><span class="sect1"><a href="kerneldebug-deadlocks.html">9.9. Debugging the Deadlocks</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-obtain"></a>9.1. Obtaining a Kernel Crash Dump</h2></div></div></div><p>When running a development kernel (eg: FreeBSD-CURRENT), such as a
      kernel under extreme conditions (eg: very high load averages,
      tens of thousands of connections, exceedingly high number of
      concurrent users, hundreds of <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a>s, etc.), or using a
      new feature or device driver on FreeBSD-STABLE (eg:
      <acronym class="acronym">PAE</acronym>), sometimes a kernel will panic.  In the
      event that it does, this chapter will demonstrate how to extract
      useful information out of a crash.</p><p>A system reboot is inevitable once a kernel panics.  Once a
      system is rebooted, the contents of a system's physical memory
      (<acronym class="acronym">RAM</acronym>) is lost, as well as any bits that are
      on the swap device before the panic.  To preserve the bits in
      physical memory, the kernel makes use of the swap device as a
      temporary place to store the bits that are in RAM across a
      reboot after a crash.  In doing this, when FreeBSD boots after a
      crash, a kernel image can now be extracted and debugging can
      take place.</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">A swap device that has been configured as a dump
      device still acts as a swap device.  Dumps to non-swap devices
      (such as tapes or CDRWs, for example) are not supported at this time.  A
      <span class="quote">“<span class="quote">swap device</span>”</span> is synonymous with a <span class="quote">“<span class="quote">swap
      partition.</span>”</span></p></div><p>To be able to extract a usable core, it is required that at
      least one swap partition be large enough to hold all of the bits
      in physical memory.  When a kernel panics, before the system
      reboots, the kernel is smart enough to check to see if a swap
      device has been configured as a dump device.  If there is a
      valid dump device, the kernel dumps the contents of what is in
      physical memory to the swap device.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="config-dumpdev"></a>9.1.1. Configuring the Dump Device</h3></div></div></div><p>Before the kernel will dump the contents of its physical
	memory to a dump device, a dump device must be configured.  A
	dump device is specified by using the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a> command
	to tell the kernel where to save kernel crash dumps.  The
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a> program must be called after the swap partition
	has been configured with <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=swapon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">swapon</span>(8)</span></a>.  This is normally
	handled by setting the <code class="varname">dumpdev</code> variable in
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> to the path of the swap device (the
	recommended way to extract a kernel dump).</p><p>Alternatively, the dump device can be hard-coded via the
	<code class="literal">dump</code> clause in the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=config&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">config</span>(5)</span></a> line of
	a kernel configuration file.  This approach is deprecated and should
	be used only if a kernel is crashing before <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a> can be executed.</p><div xmlns="" class="tip"><h3 class="admontitle">提示: </h3><p xmlns="http://www.w3.org/1999/xhtml">Check <code class="filename">/etc/fstab</code> or
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=swapinfo&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">swapinfo</span>(8)</span></a> for a list of swap devices.</p></div><div xmlns="" class="important"><h3 class="admontitle">重要: </h3><p xmlns="http://www.w3.org/1999/xhtml">Make sure the <code class="varname">dumpdir</code>
        specified in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> exists before a kernel
        crash!</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /var/crash</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chmod 700 /var/crash</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">Also, remember that the contents of
	  <code class="filename">/var/crash</code> is sensitive and very likely
	  contains confidential information such as passwords.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="extract-dump"></a>9.1.2. Extracting a Kernel Dump</h3></div></div></div><p>Once a dump has been written to a dump device, the dump
	  must be extracted before the swap device is mounted.
	  To extract a dump
	  from a dump device, use the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> program.  If
	  <code class="varname">dumpdev</code> has been set in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>,
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> will be called automatically on the first
	  multi-user boot after the crash and before the swap device
	  is mounted.  The location of the extracted core is placed in
	  the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> value <code class="varname">dumpdir</code>, by
	  default <code class="filename">/var/crash</code> and will be named
	  <code class="filename">vmcore.0</code>.</p><p>In the event that there is already a file called
          <code class="filename">vmcore.0</code> in
          <code class="filename">/var/crash</code> (or whatever
          <code class="varname">dumpdir</code> is set to), the kernel will
          increment the trailing number for every crash to avoid
          overwriting an existing <code class="filename">vmcore</code> (eg:
          <code class="filename">vmcore.1</code>).  While debugging, it is
          highly likely that you will want to use the highest version
          <code class="filename">vmcore</code> in
          <code class="filename">/var/crash</code> when searching for the right
          <code class="filename">vmcore</code>.</p><div xmlns="" class="tip"><h3 class="admontitle">提示: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you are testing a new kernel but need to boot a different one in
      order to get your system up and running again, boot it only into single
      user mode using the <code class="option">-s</code> flag at the boot prompt, and
      then perform the following steps:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fsck -p</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -a -t ufs</code></strong>       # make sure /var/crash is writable
<code class="prompt">#</code> <strong class="userinput"><code>savecore /var/crash /dev/ad0s1b</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>                  # exit to multi-user</pre><p xmlns="http://www.w3.org/1999/xhtml">This instructs <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> to extract a kernel dump
      from <code class="filename">/dev/ad0s1b</code> and place the contents in
      <code class="filename">/var/crash</code>.  Do not forget to make sure the
      destination directory <code class="filename">/var/crash</code> has enough
      space for the dump.  Also, do not forget to specify the correct path to your swap
      device as it is likely different than
      <code class="filename">/dev/ad0s1b</code>!</p></div><p>The recommended, and certainly the easiest way to automate
        obtaining crash dumps is to use the <code class="varname">dumpdev</code>
        variable in <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="kernel.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="kernel.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="kerneldebug-gdb.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">部 III. Kernel(核心) </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 9.2. Debugging a Kernel Crash Dump with <code class="command">kgdb</code></td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>