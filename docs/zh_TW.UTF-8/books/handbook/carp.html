<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>31.13. Common Access Redundancy Protocol (CARP)</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 使用手冊" /><link rel="up" href="advanced-networking.html" title="章 31. 網路進階練功房" /><link rel="prev" href="network-atm.html" title="31.12. Asynchronous Transfer Mode (ATM)" /><link rel="next" href="appendices.html" title="部 V. 附錄" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">31.13. Common Access Redundancy Protocol (CARP)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="network-atm.html">前一頁</a> </td><th width="60%" align="center">章 31. 網路進階練功房</th><td width="20%" align="right"> <a accesskey="n" href="appendices.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="carp"></a>31.13. Common Access Redundancy Protocol (CARP)</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Tom</span> <span class="surname">Rhodes</span></span>. </span></div></div></div><a id="idp91478480" class="indexterm"></a><a id="idp91478992" class="indexterm"></a><p>The Common Access Redundancy Protocol, or
      <acronym class="acronym">CARP</acronym> allows multiple hosts to share the same
      <acronym class="acronym">IP</acronym> address.  In some configurations, this may
      be used for availability or load balancing.  Hosts may use separate
      <acronym class="acronym">IP</acronym> addresses as well, as in the example provided
      here.</p><p>To enable support for <acronym class="acronym">CARP</acronym>, the FreeBSD
      kernel must be rebuilt with the following option:</p><pre class="programlisting">device	carp</pre><p><acronym class="acronym">CARP</acronym> functionality should now be available
      and may be tuned via several <code class="command">sysctl</code>
      <acronym class="acronym">OID</acronym>s.  Devices themselves may be loaded via
      the <code class="command">ifconfig</code> command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ifconfig carp0 create</code></strong></pre><p>In a real environment, these interfaces will need unique
      identification numbers known as a <acronym class="acronym">VHID</acronym>.  This
      <acronym class="acronym">VHID</acronym> or Virtual Host Identification will be
      used to distinguish the host on the network.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91486288"></a>31.13.1. Using CARP For Server Availability (CARP)</h3></div></div></div><p>One use of <acronym class="acronym">CARP</acronym>, as noted above, is for
	server availability.  This example will provide failover support
	for three hosts, all with unique <acronym class="acronym">IP</acronym>
	addresses and providing the same web content.  These machines will
	act in conjunction with a Round Robin <acronym class="acronym">DNS</acronym>
	configuration.  The failover machine will have two additional
	<acronym class="acronym">CARP</acronym> interfaces, one for each of the content
	server's <acronym class="acronym">IP</acronym>s.  When a failure occurs, the
	failover server should pick up the failed machine's
	<acronym class="acronym">IP</acronym> address.  This means the failure should
	go completely unnoticed to the user.  The failover server
	requires identical content and services as the other content
	servers it is expected to pick up load for.</p><p>The two machines should be configured identically other
	than their issued hostnames and <acronym class="acronym">VHID</acronym>s.
	This example calls these machines
	<code class="systemitem">hosta.example.org</code> and
	<code class="systemitem">hostb.example.org</code> respectively.  First, the
	required lines for a <acronym class="acronym">CARP</acronym> configuration have
	to be added to <code class="filename">rc.conf</code>.  For
	<code class="systemitem">hosta.example.org</code>, the
	<code class="filename">rc.conf</code> file should contain the following
	lines:</p><pre class="programlisting">hostname="hosta.example.org"
ifconfig_fxp0="inet 192.168.1.3 netmask 255.255.255.0"
cloned_interfaces="carp0"
ifconfig_carp0="vhid 1 pass testpast 192.168.1.50/24"</pre><p>On <code class="systemitem">hostb.example.org</code> the following lines
	should be in <code class="filename">rc.conf</code>:</p><pre class="programlisting">hostname="hostb.example.org"
ifconfig_fxp0="inet 192.168.1.4 netmask 255.255.255.0"
cloned_interfaces="carp0"
ifconfig_carp0="vhid 2 pass testpass 192.168.1.51/24"</pre><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">It is very important that the passwords, specified by the
	  <code class="option">pass</code> option to <code class="command">ifconfig</code>,
	  are identical.  The <code class="filename">carp</code> devices will
	  only listen to and accept advertisements from machines with the
	  correct password.  The <acronym class="acronym">VHID</acronym> must also be
	  different for each machine.</p></div><p>The third machine,
	<code class="systemitem">provider.example.org</code>, should be prepared so that
	it may handle failover from either host.  This machine will require
	two <code class="filename">carp</code> devices, one to handle each
	host.  The appropriate <code class="filename">rc.conf</code>
	configuration lines will be similar to the following:</p><pre class="programlisting">hostname="provider.example.org"
ifconfig_fxp0="inet 192.168.1.5 netmask 255.255.255.0"
cloned_interfaces="carp0 carp1"
ifconfig_carp0="vhid 1 advskew 100 pass testpass 192.168.1.50/24"
ifconfig_carp1="vhid 2 advskew 100 pass testpass 192.168.1.51/24"</pre><p>Having the two <code class="filename">carp</code> devices will
        allow <code class="systemitem">provider.example.org</code> to notice and pick
	up the <acronym class="acronym">IP</acronym> address of either machine should
	it stop responding.</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">The default FreeBSD kernel <span class="emphasis"><em>may</em></span> have
	  preemption enabled.  If so,
	  <code class="systemitem">provider.example.org</code> may not relinquish the
	  <acronym class="acronym">IP</acronym> address back to the original content
	  server.  In this case, an administrator may
	  <span class="quote">“<span class="quote">nudge</span>”</span> the interface.  The following command
	  should be issued on
	  <code class="systemitem">provider.example.org</code>:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ifconfig carp0 down &amp;&amp; ifconfig carp0 up</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">This should be done on the <code class="filename">carp</code>
	  interface which corresponds to the correct host.</p></div><p>At this point, <acronym class="acronym">CARP</acronym> should be completely
	enabled and available for testing.  For testing, either networking has
	to be restarted or the machines need to be rebooted.</p><p>More information is always available in the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=carp&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">carp</span>(4)</span></a>
        manual page.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="network-atm.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="advanced-networking.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="appendices.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">31.12. Asynchronous Transfer Mode (ATM) </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 部 V. 附錄</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>