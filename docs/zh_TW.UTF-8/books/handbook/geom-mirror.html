<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>19.3. RAID1 - 鏡射(Mirroring)</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 使用手冊" /><link rel="up" href="geom.html" title="章 19. GEOM: Modular Disk Transformation Framework" /><link rel="prev" href="geom-striping.html" title="19.2. RAID0 - 分散連結(striping)" /><link rel="next" href="geom-raid3.html" title="19.4. RAID3 - Byte-level Striping with Dedicated Parity" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">19.3. RAID1 - 鏡射(Mirroring)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="geom-striping.html">前一頁</a> </td><th width="60%" align="center">章 19. GEOM: Modular Disk Transformation Framework</th><td width="20%" align="right"> <a accesskey="n" href="geom-raid3.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="geom-mirror"></a>19.3. RAID1 - 鏡射(Mirroring)</h2></div></div></div><a id="idp81553360" class="indexterm"></a><a id="idp81554128" class="indexterm"></a><p>許多企業或個人用戶用鏡射(mirroring) 來不中斷系統進行備份。
	鏡射簡單來說就是在 B 磁碟上重覆一份 A 磁碟的資料，
	或者 C+D 磁碟重覆 A+B 磁碟的資料。不論設定如何，
	最重要的是所有磁碟或分割區(partition) 上的資料都會被複製，
	之後可在不中斷服務的情況下復原、備份資料，使儲存的資料更安全。</p><p>開始之前，請先確定系統上有兩個容量相同的磁碟，
	後面的範例假設這兩顆磁碟是 direct access(<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=da&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">da</span>(4)</span></a>)
      <acronym class="acronym">SCSI</acronym> 磁碟。</p><p>首先我們假設 FreeBSD 安裝在第一個磁碟上，且只有兩個分割區(partition)。
	其中一個是交換分割區(swap partition，大小為 <acronym class="acronym">RAM</acronym>
	的兩倍)，而剩下的全用於根目錄(即 <code class="filename">/</code>，
	root file system)。當然要在不同掛載點(mount point) 切出更多分割區
	(partition) 也可以，不過難度會大幅提升，因為必須手動操作 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a>
	和 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fdisk&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fdisk</span>(8)</span></a> 工具。</p><p>重開機並等到系統完全初始化完畢，用 <code class="systemitem">root</code>
	登入。</p><p>建立 <code class="filename">/dev/mirror/gm</code> 裝置並以
       <code class="filename">/dev/da1</code> 連結：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror label -vnb round-robin gm0 /dev/da1</code></strong></pre><p>這時系統應該會回應：</p><pre class="screen">
Metadata value stored on /dev/da1.
Done.</pre><p>初始化 GEOM，這動作會自動載入
      <code class="filename">/boot/kernel/geom_mirror.ko</code>  kernel module：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror load</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">這動作應該會在 <code class="filename">/dev/mirror</code>
	  下建立 <code class="filename">gm0</code> 裝置結點(device node)。</p></div><p>在這個新建的 <code class="filename">gm0</code> 裝置上安置一般的
	<code class="command">fdisk</code> label 和開機磁區：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fdisk -vBI /dev/mirror/gm0</code></strong></pre><p>接著安置 <code class="command">bsdlabel</code> 資訊：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>bsdlabel -wB /dev/mirror/gm0s1</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">如果存在多個 slice 和分割區(partition)，
	  記得修改上兩指令的參數，且另一個磁碟上的 slice 和分割區(partition)
	  大小必須相同。</p></div><p>用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a> 工具在 <code class="filename">gm0s1a</code>
	裝置結點建立預設的檔案系統：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>newfs -U /dev/mirror/gm0s1a</code></strong></pre><p>系統會印出許多資訊和一大堆數字，這是正常的。
	確認是否有認何錯誤，接著就可以將這個裝置掛載到
      <code class="filename">/mnt</code> 掛載點(mount mount)：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount /dev/mirror/gm0s1a /mnt</code></strong></pre><p>接著將原本開機磁碟的資料搬移到新的檔案系統
	 (<code class="filename">/mnt</code>)。範例是用
      <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> 和 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=restore&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">restore</span>(8)</span></a> ，不過用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dd&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">dd</span>(1)</span></a> 也可以。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dump -L -0 -f- / |(cd /mnt &amp;&amp; restore -r -v -f-)</code></strong></pre><p>執行上述指令時，只要將恰當的檔案系統掛在正確的位置，應該就能成功。
	</p><p>接著編輯 <code class="filename">/mnt/etc/fstab</code>
	檔將 swap file 那行移除或註解起來。
      <a href="#ftn.idp81588944" class="footnote" id="idp81588944"><sup class="footnote">[18]</sup></a>請參考下面範例，並根據新磁碟修改其它的檔案系統資訊：</p><pre class="programlisting"># Device                Mountpoint      FStype  Options         Dump    Pass#
#/dev/da0s2b             none            swap    sw              0       0
/dev/mirror/gm0s1a       /               ufs     rw              1       1</pre><p>在目前的根目錄及新的根目錄建立 <code class="filename">boot.conf</code> 檔案，
	這個檔案可以『幫助』系統 <acronym class="acronym">BIOS</acronym> 開機：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>echo "1:da(1,a)/boot/loader" &gt; /boot.config</code></strong></pre><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>echo "1:da(1,a)/boot/loader" &gt; /mnt/boot.config</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">在兩個根目錄上都新增檔案是為了安全起見，
	  如果因為某些原因新的根目錄無法開機，至少還可用原本的根目錄。</p></div><p>接著在 <code class="filename">/boot/loader.conf</code> 新增兩行：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>echo 'geom_mirror_load="YES"' &gt;&gt; /mnt/boot/loader.conf</code></strong></pre><p>這會指示 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a> 在開機時載入
  	<code class="filename">geom_mirror.ko</code>  kernel module。</p><p>重開機：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>shutdown -r now</code></strong></pre><p>如果一切順利，系統應該會從 <code class="filename">gm0s1a</code> 裝置開機，
	接下來出現 <code class="command">login</code> 提示畫面。如果出錯了，
	請參閱下面 Troubleshooting 那一節。 現在可以將
	<code class="filename">da0</code> 磁碟加入 <code class="filename">gm0</code>
	裝置：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gmirror configure -a gm0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gmirror insert gm0 /dev/da0</code></strong></pre><p>其中 <code class="option">-a</code> 旗標告訴 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=gmirror&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">gmirror</span>(8)</span></a>
	  使用「自動同步(automatic synchronization)」，例如自動同步寫入磁碟的動作。
	  manual 說明了如何重建、取代磁碟等，不過 manual 裡的範例是用
      <code class="filename">data</code> 而不是 <code class="filename">gm0</code>。</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp81609424"></a>19.3.1. Troubleshooting</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp81610064"></a>19.3.1.1. 系統無法開機</h4></div></div></div><p>如果開機提示類似這樣：</p><pre class="programlisting">ffs_mountroot: can't find rootvp
Root mount failed: 6
mountroot&gt;</pre><p>請用機器面板上的 Power 按鈕或 reset 按鈕來重開機，並在開機選單選 (6)，
	這樣子，系統就會進入 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a>
	交談模式。這時候，請照下面指令來手動載入所需的 kernel module
	，也就是 <code class="filename">geom_mirror.ko</code>：</p><pre class="screen">OK? <strong class="userinput"><code>load geom_mirror.ko</code></strong>
OK? <strong class="userinput"><code>boot</code></strong></pre><p>如果這樣成功了的話，表示因為某些原因無法自動載入 kernel module。
	請將：</p><pre class="programlisting">options	GEOM_MIRROR</pre><p>加入到核心設定檔(kernel configuration file)，重編並安裝核心。
	  這應該能解決這個問題。</p></div></div><div class="footnotes"><br /><hr class="footnote-hr" /><div id="ftn.idp81588944" class="footnote"><p><a href="#idp81588944" class="para"><sup class="para">[18] </sup></a>請注意，將 <code class="filename">fstab</code> 的 swap file
	那行註解起來，通常表示：您得用別的方法來重建 swap。詳情請參考
	<a class="xref" href="adding-swap-space.html" title="12.13. Adding Swap Space">節 12.13, “Adding Swap Space”</a>。</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="geom-striping.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="geom.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="geom-raid3.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">19.2. RAID0 - 分散連結(striping) </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 19.4. <acronym class="acronym">RAID</acronym>3 - Byte-level Striping with
	Dedicated Parity</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>