<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>31.6. Link Aggregation and Failover</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 使用手冊" /><link rel="up" href="advanced-networking.html" title="章 31. 網路進階練功房" /><link rel="prev" href="network-bridging.html" title="31.5. Bridging" /><link rel="next" href="network-diskless.html" title="31.7. Diskless Operation" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">31.6. Link Aggregation and Failover</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="network-bridging.html">前一頁</a> </td><th width="60%" align="center">章 31. 網路進階練功房</th><td width="20%" align="right"> <a accesskey="n" href="network-diskless.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="network-aggregation"></a>31.6. Link Aggregation and Failover</h2></div><div><span class="authorgroup">Written by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Andrew</span> <span class="surname">Thompson</span></span>. </span></div></div></div><a id="idp90789200" class="indexterm"></a><a id="idp90789712" class="indexterm"></a><a id="idp90790224" class="indexterm"></a><a id="idp90790736" class="indexterm"></a><a id="idp90791248" class="indexterm"></a><a id="idp90791760" class="indexterm"></a><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90792272"></a>31.6.1. Introduction</h3></div></div></div><p>The <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=lagg&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">lagg</span>(4)</span></a> interface allows aggregation of multiple network
	interfaces as one virtual interface for the purpose of providing
	fault-tolerance and high-speed links.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90794192"></a>31.6.2. Operating Modes</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">failover</span></dt><dd><p>Sends and receives traffic only through the master port. If the
	  master port becomes unavailable, the next active port is used. The
	  first interface added is the master port; any interfaces added after
	  that are used as failover devices.</p></dd><dt><span class="term">fec</span></dt><dd><p>Supports Cisco EtherChannel. This is a static setup and does not
	  negotiate aggregation with the peer or exchange frames to monitor the
	  link, if the switch supports LACP then that should be used
	  instead.</p><p>Balances outgoing traffic across the active ports based on hashed
	  protocol header information and accepts incoming traffic from any
	  active port. The hash includes the Ethernet source and destination
	  address, and, if available, the VLAN tag, and the IPv4/IPv6 source
	  and destination address.</p></dd><dt><span class="term">lacp</span></dt><dd><p>Supports the IEEE 802.3ad Link Aggregation Control Protocol
	  (LACP) and the Marker Protocol. LACP will negotiate a set of
	  aggregable links with the peer in to one or more Link Aggregated
	  Groups. Each LAG is composed of ports of the same speed, set to
	  full-duplex operation.  The traffic will be balanced across the ports
	  in the LAG with the greatest total speed, in most cases there will
	  only be one LAG which contains all ports. In the event of changes in
	  physical connectivity, Link Aggregation will quickly converge to a
	  new configuration.</p><p>Balances outgoing traffic across the active ports based on hashed
	  protocol header information and accepts incoming traffic from any
	  active port. The hash includes the Ethernet source and destination
	  address, and, if available, the VLAN tag, and the IPv4/IPv6 source
	  and destination address.</p></dd><dt><span class="term">loadbalance</span></dt><dd><p>This is an alias of <span class="emphasis"><em>fec</em></span> mode.</p></dd><dt><span class="term">roundrobin</span></dt><dd><p>Distributes outgoing traffic using a round-robin scheduler
	  through all active ports and accepts incoming traffic from any active
	  port. This mode will violate Ethernet frame ordering and should be
	  used with caution.</p></dd></dl></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90803664"></a>31.6.3. Examples</h3></div></div></div><div class="example"><a id="networking-lacp-aggregation-cisco"></a><div class="example-title">範例 31.1. LACP aggregation with a Cisco switch</div><div class="example-contents"><p>This example connects two interfaces on a FreeBSD machine to the
	  switch as a single load balanced and fault tolerant link. More interfaces
	  can be added to increase throughput and fault tolerance. Since frame
	  ordering is mandatory on Ethernet links then any traffic between two
	  stations always flows over the same physical link limiting the maximum
	  speed to that of one interface. The transmit algorithm attempts to use as
	  much information as it can to distinguish different traffic flows and
	  balance across the available interfaces.</p><p>On the Cisco switch add the interfaces to the channel group.</p><pre class="screen">interface FastEthernet0/1
 channel-group 1 mode active
 channel-protocol lacp
!
interface FastEthernet0/2
 channel-group 1 mode active
 channel-protocol lacp
!</pre><p>On the FreeBSD machine create the lagg interface.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ifconfig lagg0 create</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>ifconfig lagg0 up laggproto lacp laggport fxp0 laggport fxp1</code></strong></pre><p>View the interface status from ifconfig; ports marked as
	  <span class="emphasis"><em>ACTIVE</em></span> are part of the active aggregation group
	  that has been negotiated with the remote switch and traffic will be
	  transmitted and received.  Use the verbose output of <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ifconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ifconfig</span>(8)</span></a>
	  to view the LAG identifiers.</p><pre class="screen">lagg0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=8&lt;VLAN_MTU&gt;
        ether 00:05:5d:71:8d:b8
        media: Ethernet autoselect
        status: active
        laggproto lacp
        laggport: fxp1 flags=1c&lt;ACTIVE,COLLECTING,DISTRIBUTING&gt;
        laggport: fxp0 flags=1c&lt;ACTIVE,COLLECTING,DISTRIBUTING&gt;</pre><p>The switch will show which ports are active.  For more detail use
	  <strong class="userinput"><code>show lacp neighbor detail</code></strong>.</p><pre class="screen">switch# show lacp neighbor
Flags:  S - Device is requesting Slow LACPDUs
        F - Device is requesting Fast LACPDUs
        A - Device is in Active mode       P - Device is in Passive mode

Channel group 1 neighbors

Partner's information:

                  LACP port                        Oper    Port     Port
Port      Flags   Priority  Dev ID         Age     Key     Number   State
Fa0/1     SA      32768     0005.5d71.8db8  29s    0x146   0x3      0x3D
Fa0/2     SA      32768     0005.5d71.8db8  29s    0x146   0x4      0x3D</pre></div></div><br class="example-break" /><div class="example"><a id="networking-lagg-failover"></a><div class="example-title">範例 31.2. Failover mode</div><div class="example-contents"><p>Failover mode can be used to switch over to another interface if
	  the link is lost on the master.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ifconfig lagg0 create</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>ifconfig lagg0 up laggproto failover laggport fxp0 laggport fxp1</code></strong></pre><pre class="screen">lagg0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=8&lt;VLAN_MTU&gt;
        ether 00:05:5d:71:8d:b8
        media: Ethernet autoselect
        status: active
        laggproto failover
        laggport: fxp1 flags=0&lt;&gt;
        laggport: fxp0 flags=5&lt;MASTER,ACTIVE&gt;</pre><p>Traffic will be transmitted and received on
	  <code class="filename">fxp0</code>.  If the link is lost on
	  <code class="filename">fxp0</code> then <code class="filename">fxp1</code> will
	  become the active link. If the link is restored on the master
	  interface then it will once again become the active link.</p></div></div><br class="example-break" /></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="network-bridging.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="advanced-networking.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="network-diskless.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">31.5. Bridging </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 31.7. Diskless Operation</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>