<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>15.4. 建立和控制 Jail</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 使用手冊" /><link rel="up" href="jails.html" title="章 15. Jails" /><link rel="prev" href="jails-intro.html" title="15.3. 背景故事" /><link rel="next" href="jails-tuning.html" title="15.5. 微調與管理" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">15.4. 建立和控制 Jail</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="jails-intro.html">前一頁</a> </td><th width="60%" align="center">章 15. Jails</th><td width="20%" align="right"> <a accesskey="n" href="jails-tuning.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="jails-build"></a>15.4. 建立和控制 Jail</h2></div></div></div><p>有些系統管理者把 jail 分為下列兩種：<span class="quote">“<span class="quote">complete(完全)</span>”</span>
      jail —— 通常包括完整的 FreeBSD 系統；另一種則為
      <span class="quote">“<span class="quote">service(服務)</span>”</span> jail ——
      專門只跑某單一可能要用特殊權限的程式或 service。  這只是一種概念上的區分
      ，並不影響如何建立 jail 的過程。  至於如何建立 jail 在 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a>
      內有更詳細的說明：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>setenv D /here/is/the/jail</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mkdir -p $D</code></strong> <a id="jailpath"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make world DESTDIR=$D</code></strong> <a id="jailworld"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>cd etc/</code></strong> <a href="#ftn.idp78950736" class="footnote" id="idp78950736"><sup class="footnote">[9]</sup></a>
<code class="prompt">#</code> <strong class="userinput"><code>make distribution DESTDIR=$D</code></strong> <a id="jaildistrib"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
<code class="prompt">#</code> <strong class="userinput"><code>mount -t devfs $D/dev</code></strong> <a id="jaildevfs"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#jailpath"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>首先就是先為 jail 找個家。  該路徑是在 host 系統中的 jail
	  實體位置。  習慣是放在 <code class="filename">/usr/jail/jailname</code>，
	  <em class="replaceable"><code>jailname</code></em> 請替換為該 jail 的 hostname
	  以便辨別。  通常 <code class="filename">/usr</code>
	  會有足夠空間來存放 jail 檔案系統，對於 <span class="quote">“<span class="quote">complete</span>”</span> jail
	  而言，它通常包括了 FreeBSD 預設安裝 base system 所有檔案的拷貝檔。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#jailworld"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>該指令將會在 jail 目錄中安裝所需的 binary、library、manual 說明等
	  。  這些是以傳統的 FreeBSD 方式完成 —— 即首先先編譯所有檔案，
	  接著再裝到目的地。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#jaildistrib"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>使用 <code class="buildtarget">distribution</code> 這個
	  <span class="application">make</span> target 來裝所有會用到的設定檔。
	  簡單來說該動作就是把 <code class="filename">/usr/src/etc/</code> 複製到 jail 環境內的
	  <code class="filename">/etc</code>，也就是
	  <code class="filename">$D/etc/</code>。</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#jaildevfs"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>對於 jail 環境而言，<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">devfs</span>(8)</span></a> 檔案系統的掛載並非必須，
	  但另一方面，幾乎所有應用程式都會需要存取至少一個設備(device)，
	  這主要取決於該程式目的而定。  控制 jail 所能存取的設備非常重要，
	  因為不正確的設定，會讓攻擊者對 jail 有機可趁。  至於如何透過
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">devfs</span>(8)</span></a> 來控制的規則，可以參閱 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">devfs</span>(8)</span></a> 及
	  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=devfs.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">devfs.conf</span>(5)</span></a> 說明。</p></td></tr></table></div><p>裝好 jail 之後，就可以用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a> 工具。  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a>
      需要四項必填參數，這些參數在 <a class="xref" href="jails-intro.html#jails-what" title="15.3.1. 何為 Jail">節 15.3.1, “何為 Jail”</a> 有介紹過。
      除了這四個參數之外，還可以指定其他參數，像是以特定帳號在 jail 中執行
      process。  <code class="option"><em class="replaceable"><code>command</code></em></code>
      參數取決於 jail 類型而定；對於 <span class="emphasis"><em>virtual system(虛擬系統)
      </em></span>，那麼就選擇 <code class="filename">/etc/rc</code>，
      因為它會完成真正 FreeBSD 系統啟動所需的操作。  對於 <span class="emphasis"><em>service(服務)
      </em></span> jail 而言，執行的指令取決於將在 jail 內執行的 service
      或應用程式而定。</p><p>Jail 通常要在系統開機時啟動，因此 FreeBSD 的 <code class="filename">rc</code>
      機制提供一些便利的方式來簡化這些工作：</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>開機時要啟動的 jail 清單要加到 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> 設定檔：</p><pre class="programlisting">jail_enable="YES"   # 若設為 NO 則表示不自動啟動 jail
jail_list="<em class="replaceable"><code>www</code></em>"     # 若有許多 jail 則請以空白隔開來寫</pre></li><li class="step"><p>對於每一筆在 <code class="varname">jail_list</code> 所列出的 jail，
	  也要在 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> 做出相對應的設定：</p><pre class="programlisting">jail_<em class="replaceable"><code>www</code></em>_rootdir="/usr/jail/www"     # jail 的根目錄
jail_<em class="replaceable"><code>www</code></em>_hostname="<em class="replaceable"><code>www</code></em>.example.org"  # jail 的 hostname
jail_<em class="replaceable"><code>www</code></em>_ip="192.168.0.10"           # jail 的 IP address
jail_<em class="replaceable"><code>www</code></em>_devfs_enable="YES"          # 在 jail 內 mount devfs
jail_<em class="replaceable"><code>www</code></em>_devfs_ruleset="<em class="replaceable"><code>www_ruleset</code></em>" # jail 內所用的 devfs 規則表</pre><p>在 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> 所預設的 jail 啟動設定會跑
	  <code class="filename">/etc/rc</code> 內的 jail script，也就是說會假設 jail
	  是完整的虛擬系統。  若要用 service jail 類型，則要另外指定啟動指令，
	  方法是設定對應的
	  <code class="varname">jail_<em class="replaceable"><code>jailname</code></em>_exec_start</code>
	  設定。</p><div xmlns="" class="note"><h3 class="admontitle">注意: </h3><p xmlns="http://www.w3.org/1999/xhtml">若欲知道所有可用的選項清單，請參閱 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> 說明。</p></div></li></ol></div><p>也可以透過手動執行 <code class="filename">/etc/rc.d/jail</code> script
      來啟動或停止 <code class="filename">rc.conf</code> 所設定的 jail：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/jail start www</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/jail stop www</code></strong></pre><p>目前尚無任何方法來很乾淨地關閉 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a>。
      此乃因為正常用來關閉系統的指令，目前尚不能在 jail 中使用。  目前關閉 jail
      最佳的方式，是在 jail 內執行下列指令，或者 jail 外面透過 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=jexec&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">jexec</span>(8)</span></a>
      執行下列指令：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh /etc/rc.shutdown</code></strong></pre><p>詳情請參閱 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a> 說明。</p><div class="footnotes"><br /><hr class="footnote-hr" /><div id="ftn.idp78950736" class="footnote"><p><a href="#idp78950736" class="para"><sup class="para">[9] </sup></a>FreeBSD 6.0(含)
之後就不需這步驟。</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="jails-intro.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="jails.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="jails-tuning.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">15.3. 背景故事 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 15.5. 微調與管理</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>