<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>9.7. Debugging Loadable Modules Using GDB</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD Developers' Handbook" /><link rel="up" href="kerneldebug.html" title="章 9. Kernel Debugging" /><link rel="prev" href="kerneldebug-online-gdb.html" title="9.6. On-Line Kernel Debugging Using Remote GDB" /><link rel="next" href="kerneldebug-console.html" title="9.8. Debugging a Console Driver" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">9.7. Debugging Loadable Modules Using GDB</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="kerneldebug-online-gdb.html">前一頁</a> </td><th width="60%" align="center">章 9. Kernel Debugging</th><td width="20%" align="right"> <a accesskey="n" href="kerneldebug-console.html">下一頁</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-kld"></a>9.7. Debugging Loadable Modules Using GDB</h2></div></div></div><p>When debugging a panic that occurred within a module, or
      using remote GDB against a machine that uses dynamic modules,
      you need to tell GDB how to obtain symbol information for those
      modules.</p><p>First, you need to build the module(s) with debugging
      information:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /sys/modules/linux</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make clean; make COPTS=-g</code></strong></pre><p>If you are using remote GDB, you can run
      <code class="command">kldstat</code> on the target machine to find out
      where the module was loaded:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kldstat</code></strong>
Id Refs Address    Size     Name
 1    4 0xc0100000 1c1678   kernel
 2    1 0xc0a9e000 6000     linprocfs.ko
 3    1 0xc0ad7000 2000     warp_saver.ko
 4    1 0xc0adc000 11000    linux.ko</pre><p>If you are debugging a crash dump, you will need to walk the
      <code class="literal">linker_files</code> list, starting at
      <code class="literal">linker_files-&gt;tqh_first</code> and following the
      <code class="literal">link.tqe_next</code> pointers until you find the
      entry with the <code class="literal">filename</code> you are looking for.
      The <code class="literal">address</code> member of that entry is the load
      address of the module.</p><p>Next, you need to find out the offset of the text section
      within the module:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>objdump --section-headers /sys/modules/linux/linux.ko | grep text</code></strong>
  3 .rel.text     000016e0  000038e0  000038e0  000038e0  2**2
 10 .text         00007f34  000062d0  000062d0  000062d0  2**2</pre><p>The one you want is the <code class="literal">.text</code> section,
      section 10 in the above example.  The fourth hexadecimal field
      (sixth field overall) is the offset of the text section within
      the file. Add this offset to the load address of the module to
      obtain the relocation address for the module's code. In our
      example, we get 0xc0adc000 + 0x62d0 = 0xc0ae22d0.  Use the
      <code class="command">add-symbol-file</code> command in GDB to tell the
      debugger about the module:</p><pre class="screen"><code class="prompt">(kgdb)</code> <strong class="userinput"><code>add-symbol-file /sys/modules/linux/linux.ko 0xc0ae22d0</code></strong>
add symbol table from file "/sys/modules/linux/linux.ko" at text_addr = 0xc0ae22d0?
(y or n) <strong class="userinput"><code>y</code></strong>
Reading symbols from /sys/modules/linux/linux.ko...done.
<code class="prompt">(kgdb)</code></pre><p>You should now have access to all the symbols in the
      module.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="kerneldebug-online-gdb.html">前一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="kerneldebug.html">上一層</a></td><td width="40%" align="right"> <a accesskey="n" href="kerneldebug-console.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">9.6. On-Line Kernel Debugging Using Remote GDB </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 9.8. Debugging a Console Driver</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文及其他文件，可由此下載：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>若有 FreeBSD 方面疑問，請先閱讀
    <a href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;。<br></br>
    關於本文件的問題，請洽詢
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;。</small></p></body></html>