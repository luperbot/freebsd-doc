==========
30.6. IPFW
==========

.. raw:: html

   <div class="navheader">

30.6. IPFW
`????? <firewalls-ipf.html>`__?
???????? 30. Firewalls
?\ `??????? <advanced-networking.html>`__

--------------

.. raw:: html

   </div>

.. raw:: html

   <div class="sect1">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6. IPFW
----------

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? IPFIREWALL (IPFW) ????? ????????? ??? ??????????? ??? ?? FreeBSD.
???? ?????? ??? ??????????? ??? ????????? ??? ??????? ??? Project.
???????????? ???? ????????? ??????? ????? ????????? ??? ??????????
(stateless) ????? ??? ??? ??????? ????????????? ??? ??????????? ???? ???
?????????? ?? ???? Stateful ?????? (Simple Stateful Logic).

?? ????????? ??????? ??? ?? IPFW (??? ?????? ``/etc/rc.firewall`` ???
``/etc/rc.firewall6``) ??? ??????? ???????????? ??? FreeBSD ????? ??????
???? ??? ?? ????????? ?? ?????? ??????? ??????? ???? ?? ???????????????.
?? ?????????? ??? ???????????? ??????????? ????? stateful. ? stateful
?????????? ????? ?????????? ???? ???????????? ???????????, ???? ??? ??
???????????????? ???? ?? ?????????? ?? ???? ????? ??? ????????.

? ??????? ??? ??????? stateless ??? IPFW ???? ????????? ?? ???????????
??????????? ???????? ?? ?????? ??????? ????????? ???? ???? ??? ???????
??????? ??? ?????? ??? ???????? ?? ?? ????????. ?? IPFW ??????????? ????
???????????? ?????? ? ??? ??????? ??????????? ????????, ? ?????? ????
?????? ???????????? ?????????????? ???????. ? ?????????? ?????? ???
??????? ??? IPFW ????????????? ???? ?? ????????? ???????????? ???????
??????? ?? ?? ??? ??????????? ?????????? ??????????? ??? ?????????????
??? ??????????? ??? ??????? ????. ?????? ??????? ??????????? ????? ????
??? ?? ????? ????? ??? ???????? ??? ???????????.

?? IPFW ??????????? ??? ???? ??????????. ?? ?????? ???????? ????? ?
???????????? ??????? ??? firewall ???? ??????, ?? ???????????? ??
?????????? ??????????. ?? ???????? ?????????? ????? ?? ???????
?????????? (logging), ? ??????? ``divert`` ? ?????? ??????????? ??
?????????? NAT, ????? ??? ?? ???????????? ??????????? ??????? ??????: ??
??????? ??????????? ??????? (traffic shaper) dummynet, ? ??????????
????????? ???? ??? ``fwd rule``, ? ?????????? ????????? (bridge) ?????
??? ? ?????????? ????????? (ipstealth). To IPFW ??????????? ???? ??
?????????? IPv4 ??? ??? ?? IPv6.

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.1. ?????????????? ?? IPFW
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? IPFW ?????????????? ???? ?????? ??????????? ??? FreeBSD ?? ???????
??? ?????? ?? ????? ?????? ?? ???????? ????????. ?? ??????? ?? ????????
???????? ?? ??????? ???? ???? ??? ?????????? ``firewall_enable="YES"``
??? ?????? ``/etc/rc.conf``. ??? ?????????? ?? ?????????????? ?? IPFW
???? ???? ??????.

???? ?????????????? ?? ??????? ??? ?? ??? ??????????
``firewall_enable="YES"`` ??? ``rc.conf``, ?? ????? ?? ????? ??????
???????? ?? ???????? ?????? ???? ?? ?????????? ??? ?????????:

.. code:: screen

    ipfw2 initialized, divert disabled, rule-based forwarding disabled, default to deny, logging disabled

?? ??????? ???? ???????????? ?? ?????????? ??????????. ??? ??
?????????????? ??? ????????? ??? ?? ?????? ?? ??????? ????????????,
???????? ??????? ????????? ??? ???????? ?? ?????? ???
``/etc/sysctl.conf``. ???????????? ??? ???????? ????????????, ??
????????????? ? ????????? ???? ???????? ??????????:

.. code:: programlisting

    net.inet.ip.fw.verbose=1
    net.inet.ip.fw.verbose_limit=5

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.2. ???????? ??? ??????
~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ????? ??????????? ?? ?????????????? ?? IPFW ???????????????? ???
???????? ???????? ???? ?????? ??? FreeBSD. ? ?????? ????? ???
??????????? ????? ?????? ????????????.

.. code:: programlisting

    options    IPFIREWALL

? ??????? ???? ??????????? ?? IPFW ?? ????? ??? ??????.

.. code:: programlisting

    options    IPFIREWALL_VERBOSE

??????????? ??? ????????? ??? ??????? ??? ??????? ???? ??? IPFW ???
????????????? ?? ???? ``log`` ???? ?????? ????.

.. code:: programlisting

    options    IPFIREWALL_VERBOSE_LIMIT=5

?????????? ??? ?????? ??? ??????? ??? ????????????? ???? ???
`syslogd(8) <http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&sektion=8>`__
?? ???????????? ?????? ??? ??????????. ? ??????? ????? ??????? ??
??????? ???????????? ??? ????? ????? ????????? ? ?????????. ?? ???? ???
????? ?????? ?? ?????????? ??? ?????? ??????? ?? ????? ??? ???????????
??? ??????? ??????????.

.. code:: programlisting

    options    IPFIREWALL_DEFAULT_TO_ACCEPT

? ??????? ???? ?????? ?? ????? ?? ??????? ???? ??? ?? firewall, ?? ?????
????? ???? ???? ??? ????? ???? ??? ????????? ?? firewall ???.

.. code:: programlisting

    options    IPDIVERT

? ??????? ???? ??????????? ?? ?????????? NAT.

.. raw:: html

   <div class="note" xmlns="">

????????:
~~~~~~~~~

?? firewall ?? ?????????? ??? ?? ?????? ??? ????????????? ??? ??? ????
?? ????????, ?? ??? ?????????? ??? ???????
``IPFIREWALL_DEFAULT_TO_ACCEPT`` ? ?? ??? ????????? ??? ????????? ??????
??? ?? ????????? ????? ??? ?????????.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.3. ???????? ??? ``/etc/rc.conf``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

????????????? ?? firewall:

.. code:: programlisting

    firewall_enable="YES"

??? ?? ????????? ??? ??? ???? ??????????????? ?????? firewall ???
?????????????? ??? ?? FreeBSD, ???????? ?? ?????? ``/etc/rc.firewall``
??? ???????????? ??? ??????? ???? ??? ????????:

.. code:: programlisting

    firewall_type="open"

?? ?????????? ????? ??? ???? ?? ??????? ?????:

.. raw:: html

   <div class="itemizedlist">

-  ``open`` - ????????? ?? ???????? ???? ??? ???????.

-  ``client`` - ??????????? ???? ?? ???????????? ????????.

-  ``simple`` - ??????????? ???????? ?? ??????.

-  ``closed`` - ????????????? ??????? ??? ?????? ???????, ????? ??? ???
   ????????? ??????? (loopback).

-  ``UNKNOWN`` - ????????????? ??? ??????? ??????? ??? firewall.

-  ``filename`` - ?? ?????? ???????? ??? ??????? ??? ???????? ????
   ??????? ??? firewall.

.. raw:: html

   </div>

???????? ?? ??????????????? ??? ????????????? ??????? ??? ?? ?????????
??????????????? ??????? ??? ipfw firewall. ? ???? ????? ???????? ??
????????? ``firewall_type`` ???? ??????? ???????? ??? ??????? ???
???????? ???? *??????? ??? firewall*, ????? ?? ?????? ???????? ????
?????? ??????? ??? ?? ???? ??
`ipfw(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipfw&sektion=8>`__.
?? ?????? ??????? ??? ???????? ????????, ?????????? ??? ??? ???????????
??? ?????????? ??????:

.. code:: programlisting

    add deny in
    add deny out

??? ??? ???? ?????, ????? ?????? ?????? ?? ?????? ?? ?????????
``firewall_script`` ???? ??????? ???????? ???? ??????????? script ???
???????????? ??? ????? ??? ??????? ``ipfw`` ??? ?? ??????????? ???? ???
????????. ??? ?????? ?????? script ?? ????? ????? ?????????? ?? ??
?????? ??????? ??? ??????? ????????, ????? ?? ????????:

.. code:: programlisting

    #!/bin/sh

    ipfw -q flush

    ipfw add deny in
    ipfw add deny out

.. raw:: html

   <div class="note" xmlns="">

????????:
~~~~~~~~~

?? ?????? ??? ???? ??? ``firewall_type`` ???? ?? ``client`` ???? ??
``simple``, ?? ?????? ?? ???????? ??? ?? ?????????????? ??????? ???
??????????? ??? ``/etc/rc.firewall`` ?????????? ?? ??? ????????? ???
????????????? ???????????. ??????????? ?????? ??? ?? ???????????? ???
???????????????? ?? ???? ?? ???????? ????????? ?? ?? ????? ????? ??
????????? ``firewall_script`` ???? ???? ``/etc/ipfw.rules``.

.. raw:: html

   </div>

????????????? ??? ?????????:

.. code:: programlisting

    firewall_logging="YES"

.. raw:: html

   <div class="warning" xmlns="">

?????????????:
~~~~~~~~~~~~~~

?? ???? ?????? ??? ????? ? ????????? ``firewall_logging`` ????? ?? ?????
??? ???? ??? ?????????? sysctl ``net.inet.ip.fw.verbose`` ???? ????
``1`` (????? ?? `??????30.6.1, ??????????????? ??
IPFW? <firewalls-ipfw.html#firewalls-ipfw-enable>`__). ??? ???????
????????? ??? ``rc.conf`` ??? ?? ?????? ???????????? ???? ?????????,
???? ???? ?????? ?? ????????? ???? ??? ???????? ?????????? sysctl ????
???????????, ???? ???? ??? ??????? ``/etc/sysctl.conf``:

.. code:: programlisting

    net.inet.ip.fw.verbose_limit=5

.. raw:: html

   </div>

?? ?? ???????? ??? ?????????? ?? ???? (gateway), ?????? ??????? ????????
?????????? ??????????? ??????? (Network Address Translation, NAT) ????
???
`natd(8) <http://www.FreeBSD.org/cgi/man.cgi?query=natd&sektion=8>`__,
??????????? ?? ????????? ?? `??????31.8, ?Network Address
Translation? <network-natd.html>`__ ??? ??????????? ??????? ?? ???
????????? ??? ??????????? ??? ?????? ``/etc/rc.conf``.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.4. ? ?????? IPFW
~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

? ?????? ``ipfw`` ????? ? ??????? ?????? ??? ??? ???????? ? ????????
??????? ????? ??????????? ???????? ??????? ??? firewall, ????? ????
??????????. ?? ???????? ?? ?? ????? ????? ??? ??????? ????? ??? ??
??????? ???????? ?? ??? ?????????? ??????????? ??? ???????????. ????????
?? ??????? ????? ???? ??????? ??? ?? ??? ?????? ??? ?? ?? ??????????????
??? ?? ???? ????????? ???? ????????. ???????? ?? ??????????????? ?? ????
?????? ??? ?? ??????????????? ???? ????????? ??????? ??? firewall, ???
??? ??? ???? ??????????. ????? ????? ??? ? ???????????? ?????? ???
?????????????? ??? ???????????? ???.

? ?????? ``ipfw`` ????? ?????? ??????? ??? ?? ??????????? ???? ?????????
??????? ??? ??????? ???. ?? ??????? ?????????? ?????? ??? IPFW
?????????? ???????? ??? ??????? ??? ???? ??????, ? ?????? ??????? ????
?????? ????????? ?? ?????. ???? ?? ???????? ??? ???????, ? ?????????? ??
???????? ??? ???? ??? ??????? ????? ???? ?????? ??? ?? ???????????? ?? ?
??????? ?????????? ????????.

??? ?? ????? ????? ???? ??????? ?? ?? ?????:

.. code:: screen

    # ipfw list

??? ?? ????? ??? ????? ???? ??? ???????, ???? ?? ??? ??? ???
?????????????? ????????? ???? ? ???? ???????, ??????:

.. code:: screen

    # ipfw -t list

?? ??????? ?????????? ??????? ??? ?????? ??? ??????? ??? ????????? ????
?? ??? ?????????? ??????. ? ????? ????? ??????? ??? ?????? ??? ??????,
???????????? ??? ??? ?????? ??????? ??? ????????? (????? ?? ??????????
??? ???? ?? ???????????) ??? ????? ??? ??? ???? ??? ??????.

.. code:: screen

    # ipfw -a list

??? ?? ????? ??? ????? ??? ?? ???????????? ???? ???? ?????????? ??? ???
???? ????????? ???????:

.. code:: screen

    # ipfw -d list

??? ?? ????? ??? ???? ?????????? ??????? ??? ????? ?????:

.. code:: screen

    # ipfw -d -e list

??? ?? ?????????? ???? ????????:

.. code:: screen

    # ipfw zero

??? ?? ?????????? ???? ???????? ???? ??? ??? ?????? ?? ??? ??????
*``NUM``*:

.. code:: screen

    # ipfw zero NUM

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5. ?? ?????? ??????? ??? IPFW
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ??????? ???????? ??? IPFW, ???????? ??? ????? ??????? ??? ?????
?????? ??? ?? ?????????? ? ?? ??????????? ?????? ??????? ?? ??? ?????
??? ??????????? ?? ????. ? ?????? ??????????? ????????? ??????? ??????
??????????? ???????? ??? ????????. ?? ?????? ??????? ??? firewall
????????????? ???? ?? ?????? ??? ???????? ??? ?? Internet, ??? ??? ??
?????? ??? ?????????? ??? ?? ??????? ?? ???????? ?? ????. ???? ????????
TCP/IP (?.?. telnet, www, mail, ?.?.?.) ??????????? ??? ?? ??????????
??? ??? ?????????? (privileged) ???? ??? ???????????? ??? ?? ???????
???????? ????????????. ?? ?????? ??? ???????????? ??? ??? ????????????
????????, ???????? ??? ?? ????????? ????????? ??????????????? ???
??-?????????? ???? ??? ?????????? ??? ???????????? ???? ????????? ????
?????????. ???? ?? ???????? ?????????? (????? ??? ???????????) ???????
?? ??????????????? ?? ???????? ???????? ??? ??? ?????????? ??????? ???
?????????? ? ?????????? ??? ???????? ?? ?????????.

???? ??? ?????? ?????????? ??? firewall, ??????????? ?? ???? ??? ?????
??????. ? ???????? ??????????? ????????? ?? ???? ?????????? ???????, ???
??? ????? ???? ??? ?????????, ?? ???? ??? ??????? ?????? ????. ???? ??
?????? ????????? ?? ??? ??????????? ???????? ??????? ??????, ??????????
? ?????? ??? ?????????? ??? ????? ????????? ??? ?????? ????? ??? ?
????????? ??????? ??? ?? ???????????? ?????? ????????????. ?? ???? ??
?????? ??????????, ?? ?????? ??????? ??? ?????????, ????? ? ????????. ??
?? ?????? ??? ????????? ?? ?????? ??? ???? ???????, ?? ?????? ??? ???
??????????? ????????????? ?????? ??? IPFW, ?? ?????? 65535, ? ??????
????????? ?? ???????? ???? ??? ???????, ??? ?? ?????????? ????? ??
??????? ????? ???????? ???? ?????? ????????? ????.

.. raw:: html

   <div class="note" xmlns="">

????????:
~~~~~~~~~

? ????????? ??????????? ???? ??? ??????? ????? ``count``, ``skipto`` ???
``tee``.

.. raw:: html

   </div>

?? ??????? ??? ????????? ???, ?????????? ??? ????? ??????? ??? ?????????
??? ??????? ``keep state``, ``limit``, ``in``, ``out`` ??? ``via``.
????? ????? ??? ?? ??????? ??????????? ??? ??? ?????? ???? firewall
????? inclusive ?? stateful ??????????.

.. raw:: html

   <div class="warning" xmlns="">

?????????????:
~~~~~~~~~~~~~~

?? ?????? ?????? ??????? ???? ????????? ?? ???? ??????? ???? firewall.
?????? ????? ??? ?? ??????????? ??? ??? ?? ??????? ???.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.1. ??????? ???????
^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

???? ??????? ????, ?? ????????????? ??? ???????????? ??????? ???????.
????????? ???? ??? ?????????? ??? ?? ???????????? ??? ????????????
?????? ??????? ??? ??? inclusive firewall. ??? ????? ?????????, ????? ??
?????? manual ???
`ipfw(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipfw&sektion=8>`__.

?? ??????? ????????? ??????-???????. ?? ?????? ????? ?? ?????? ??
?????????????? ?? ???????????? ????? ??? ?? ???????? ???? ?? ????? ???
???????. ?? ??????-??????? ????????? ???????? ?? ?????? ????????.
??????? ?????? ????? ???-???????? ?? ?????? ?????? ?? ????? ??????
??????-??????? ??? ?? ????????????? ?????? ????? ????????????
???-????????.

? ???? ???? ???????, ?????????????? ?? ?? ??????? ``#``, ?? ????? ??????
?? ??????????? ??? ????? ???? ??????? ??????, ? ??? ?? ??? ???? ???
??????. ?? ????? ??????? ??????????.

*``CMD RULE_NUMBER ACTION LOGGING SELECTION         STATEFUL``*

.. raw:: html

   <div class="sect4">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.1.1. CMD
'''''''''''''''

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ?? ????? ? ???????? ???? ???? ?????? ???? ????????? ??????,
???????????? ??????? ??? ????? ? ?????????? *``add``*.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect4">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.1.2. RULE\_NUMBER
''''''''''''''''''''''''

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

???? ??????? ?????????? ?? ??? ?????? ?????? (rule\_number) ???? ???????
1..65535.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect4">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.1.3. ACTION
''''''''''''''''''

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

???? ??????? ?????? ?? ?????????? ?? ??? ? ???????????? ?????????, ??
?????? ??????????? ???? ?? ?????? ????????? ?? ?? ???????? ????????
????? ??? ??????.

*``allow | accept | pass |           permit``*

??? ?? ???????? ????? ?? ???? ??????????: ?? ?????? ????????? ??? ???
??????? ??? firewall. ? ????????? ??? ?? ???????????? ??????
???????????? ?? ???? ??? ??????.

*``check-state``*

??????? ?? ?????? ?? ???? ?? ???????? ?????? ???????. ?? ?????? ???????
??? ?? ?????????, ?? ?????????? ? ???????? ??? ?????? ? ??????
??????????? ??? ???????????? ???????? ??????. ???????????, ? ?????????
??????????? ?? ??? ??????? ??????. ???? ??????? check-state ??? ????
???????? ????????. ?? ??? ??????? ??????? check-state ??? ??????
???????, ? ??????? ??? ?????? ????????? ??????? ???????? ??? ??? ?????
?????? ????? keep-state ? limit.

*``deny | drop``*

??? ?? ??? ?????? ????????? ?? ???? ??????: ?? ?????? ??? ?????????? ??
???? ??? ?????? ?????????????. ? ????????? ????????????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect4">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.1.4. ?????????
'''''''''''''''''''''

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

*``log``* ? *``logamount``*

???? ??? ?????? ????????? ?? ??? ?????? ??? ???????? ?? ???? ``log``,
??????? ????????? ??? ????????? ???? ???
`syslogd(8) <http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&sektion=8>`__
??? ?????????? SECURITY. ? ????????? ????????? ???? ?? ? ??????? ???
??????? ??? ???? ?????????? ????? ??????? ??? ?????????? ??? ?????????
``logamount``. ?? ? ?????????? ???? ??? ???? ??????????, ?? ????
?????????? ?? ???? ??? ???? ??? ?????????? sysctl
``net.inet.ip.fw.verbose_limit``. ??? ???? ??? ???????????, ??? ????????
???? ???????? ??? ??? ?? ??????? ???? ???? ?????????. ????? ? ?????????
?????? ??? ????, ?????? ?? ????? ???????????????? ??? ?? ?? ?????????
??? ??????? ??????????, ? ??? ??????? ??? ?? ???????????? ??????. ?????
??? ?????? ``ipfw reset log``.

.. raw:: html

   <div class="note" xmlns="">

????????:
~~~~~~~~~

? ????????? ??????? ???? ???? ???????????? ???? ?? ????? ????????
???????????? ??? ???????, ??? ???? ??? ?????? ??????? ? ???????? ???.
????? ??? ???? ??? ???????? ?? ??????????? ?? ?????? ??????? ??
?????????????? ??? ?????????.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect4">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.1.5. ???????
'''''''''''''''''''

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ??????-??????? ??? ????????????? ?? ???? ??? ???????,
???????????????? ??? ?? ??????????? ?????????????? ??? ??????? ??? ??
?????? ?? ???????????? ??? ?? ?????????? ?? ?? ?????? ????????? ? ??? ??
??? ??????. ? ??????? ?????? ?? ????? ?? ???? ?? ???????? ??????? ??????
??????????????, ?? ????? ??? ?? ?????? ?? ??????????????? ?? ?? ?????
??? ?????????:

*``udp | tcp | icmp``*

??????? ?????? ?? ??????????????? ?? ?????????? ??? ??????????? ???
?????? ``/etc/protocols``. ? ???? ??? ??????????? ??????????????? ??? ??
????????? ??? ???????????. ????????? ??? ??????????? ?????????.

*``from src to dst``*

?? ?????? ``from`` ??? ``to`` ???????????????? ??? ?? ????????? IP
???????????. ?? ??????? ?????? ?? ?????????? *????* ??? ???? ??? ??? ???
?????????. ? ???? ``any`` ?????? ?? ?????????????? ??? ????????? ??
??????????? ?????????. ? ???? ``me`` ???? ?????? ?????? ???????.
????????? ?? ??????????? ????????? ??? ???? ????????? ?? ?????? ???????
??? ?????????? ???, ????????????????? ???? ?? PC ??? ????? ?????????? ??
firewall. ??????? ???? ?? ??????? ??????? ??? ????? ``from me to any`` ?
``from any to me`` ? ``from any to 0.0.0.0/0`` ?
``from 0.0.0.0/0 to me`` ? ``from any to 0.0.0.0`` ?
``from me to 0.0.0.0``. ?? ??????????? IP ???????????? ?? ???????????
??????? ?????????? ?? ??????? ??? ????????????? ??? ?? ????? ??? ??????
??????????. ??? IP ????????? ?????? ?? ??????????? ?? ???????? ???
?????????? ?? ???????. ?????? ?????? ?? ???????????? ??? ?? ??????? ???
?????? ?????????? (????? CIDR). ????????? ??? ??????????? ?????????.
???????? ?? ??????????????? ?? ????????? ?????????
`net-mgmt/ipcalc <http://www.freebsd.org/cgi/url.cgi?ports/net-mgmt/ipcalc/pkg-descr>`__
??? ??????????? ??? ????? ????????????. ????? ??? ???????? ????????? ???
???????????? ??? ???????????? ???????????: ``http://jodies.de/ipcalc``.

*``port number``*

??????????????? ?? ?????????? ??? ???????????? ???????? ????? (????
????? ?? TCP ??? UDP). ????? ??????????? ?? ??????? ? ??????? ????? ???
????????? ??? ?????? ?? ??????????. ???????? ?? ??????????????? ??
??????? ??? ????????? (???????? ?? ?? ?????? ??? ??????
``/etc/services``) ???? ??? ???? ?????????? ???????? ?????.

*``in | out``*

?? ?? ???????? ?????? ?? ?????????? ?? ?? ????????? ?? ??????? ??
??????????? ? ?? ?????????? ?????? ??????????. ????? ??????????? ??
????? ?? ????? ??? ????????? ??? ?????? ???, ???? ?? ???? ``in`` ???? ??
???? ``out``.

*``via IF``*

????????? ?? ?????? ?? ????? ?????????? ???? ??? ???????? ?? ?? ?????
??? ???????????. ? ???? ``via`` ??????????? ??? ?? ????? ??? ???????? ??
????? ????? ????? ??? ????????? ???? ?? ?????????? ????????????.

*``setup``*

????????? ??? ??????????? ????????? ??? ??????????? ??? ?????? ???????
???? ????????? ??? ?????? TCP.

*``keep-state``*

????????? ??? ??????????? ?????????. ????? ??????? ?????????, ??
firewall ?? ???????????? ??? ???????? ??????, ??? ?????? ? ?????????????
??????????? ????? ?? ????????? ??????????? ?????? ??????????? ?????? ???
?????????? IP ??? ??? ????? ????????? ??? ??????????, ??????????????? ??
???? ??????????.

*``limit {src-addr | src-port | dst-addr |           dst-port}``*

?? firewall ?? ????????? ???? *``N``* ?????? ????????? ?? ???
??????????? ??? ????????????? ?? ???? ??? ??????. ??????? ?? ???????????
???????????? ??? ??? ??????????? ??? ?????? ????????? ??? ??????????.
??? ??????? ?? ??????????????? ???? ???? ?????? ?? ?????????? ``limit``
??? ``keep-state``. ? ??????? ``limit`` ??????? ??? ???? ??????????
stateful ?? ??? ``keep-state``, ????? ??? ???????????? ????? ???
???????????.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.2. ??????? ??? Stateful ???????
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? stateful ???????????, ????????????? ??? ?????? ??? ??????? ?? ??????
??????????? ????????? ??????? ?? ????? ??????????? ??? ????????. ????
?????? ?? ?????????? ?? ??????????? ?? ????????? ?? ??????? ???????
?????????? ????????? ?????? ??? ????????? ??? ??? ?????????. ???????????
?????? ??? ?????????? ?? ?? ??????? ????? ??? ????????????,
????????????? ?? ???????.

? ??????? ``check-state`` ??????????????? ??? ?? ???????????? ?? ????
?????? ??? ??????? ??????? ??? IPFW ?? ???????? ?? ?????? ?? ???? ??
?????????? ??? ????????? ???????. ?? ????????? ????????????, ?? ??????
????????? ??? ?? firewall ??? ????????? ??? ?????? ???, ??? ??? ????
?????? ????????????? ???? ???? ????????? ??????? ??? ?? ??????? ??????
??? ?????????? ?? ????? ?? ???? ?? ???????????? ?????? ???????????
???????????. ?? ????????? ??? ?? ?????? ??? ????????? ?? ?? ????????
??????, ?? ?????????? ??? ?? ???????? ??? ??? ??????? ?????? ???
firewall.

? ?????????? ????????? ??????? ????? ??????? ?? ????????? ????? ??
????????? ???????? ???????????? (flood) SYN. ? ??????? ???? ?????? ??
???????????? ???? ?????? ?????? ????????? ???????. ??? ??? ????????????
???? ??????? ????????, ?? FreeBSD ???????????? ??? ????? ??????? ???
?????????? ``limit``. ? ??????? ???? ?????? ?? ?????????? ??? ?????? ???
??????????? ?????????, ??????????? ?? ????? ????????? ??? ?????????? ???
???????. ????????? ?? ???? ??? ????? ?? ?????? ??? ????????? ??????? ???
????? ????? ???? ?????????????? ? ??????? ??? ?? ???????????? IP
?????????. ?? ? ??????? ????? ????????? ?? ???? ??? ???? ????? ?? ???
??????? ``limit``, ?? ?????? ????????????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.3. ????????? ????????? ??? Firewall
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ????????????? ??? ?????????? ????????? ??? firewall, ????? ???????:
???????? ?? ?????????? ?? ????? ??? ???? ???? ??????????????? ?? ???????
????? ??????? ????? ????????????? ??? ?????????. ?? ???????????
????????????? ?? ?????? ??? ????????????, ??? ??????????? ??? ??? ??????
???????? ??? ??? ?????????????. ?? ???? ??? ?????, ????? ??? ?????????
??????????? ???? ????????? ??? ?????????.

????? ??? ?? ?????????????? ?? ?????????? ??????????, ?? IPFW ??? ??
??????? ??? ???? ??? ??? ????????? ??? ?????? ??????. ? ???????????? ???
firewall ?? ?????????? ?? ?????? ??? ????? ???? ??????? ?? ?????????????
??? ?????????, ??? ?? ????????? ??? ???? ``log`` ???? ??????????
??????????. ???????????, ??????? ????????? ???? ??? ??????? ???
??????????? ?????? (??????? ``deny``), ???? ??? ?????????? ? ???????
????????? ??? ???????????? ICMP pings. ????? ????? ????????, ??
???????????? ??? ????? ??? ??????? ? ??????? ?ipfw default deny
everything? ??? ?? ??????????? ?? ????? ? ??????? ``log``. ?? ??? ?????
????, ???????? ?? ????? ??? ?? ?????? ??? ??? ????????? ?? ?????? ??????
??? ???????.

? ????????? ????????? ????? ?????? ???????. ?? ??? ????? ???????????, ??
??????? ???? ??? ?????? ??? ????????? ??? ?????????? ??? ?? ???????? ??
????? ??? ?? ??????? ??????. ?? ??? ?????? ??? ?????? ????????? ?????
??????? ????????? (DoS), ????? ????? ??? ?????????? ?? ???????? ????
??????? ???. ?? ???????? ???? ??? ???? ????????????? ??? syslogd, ????
???????????? ??? ???? ??????? ??? ?????????? ???, ??? ??????? ????????
???? ??????????.

? ??????? ``IPFIREWALL_VERBOSE_LIMIT=5`` ???? ??????, ?????????? ???
?????? ??? ??????????? ?????? ????????? ??? ?????????? ???? ??????????
??????????
`syslogd(8) <http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&sektion=8>`__
??????? ?? ?? ????????? ??????? ???? ????????????? ??????. ????
?????????????? ???? ? ??????? ???? ??????, ? ??????? ??? ???????????
????????? ???? ????????????? ??????, ????????? ???? ??? ?????? ???
???????????. ??? ??????? ?????? ?????? ??? 200 ?????????? ???????? ?? ??
???? ??????? ???????????. ??? ??????????, ????? ?????????? ???????? ???
??? ???????????? ?????? ?? ????????????? ???????? ??? syslogd. ??
???????? ????? ???????? ?? ????????????? ??? ?? ??????????? ????
???????? ????????:

.. code:: programlisting

    last message repeated 45 times

??? ?? ???????? ?????????? ??? ???????, ????????? ??? ?????????? ???
?????? ``/var/log/security`` ?? ????? ??????????? ??? ??????
``/etc/syslog.conf``.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.4. ?????????? ???? Script ???????
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ???????????? ???????? ??????? ??? IPFW, ??????????? ??? ?????? ???
???????? ???? ??????? ??? ?? ??????? ?? ?????? ????? ???? ?? ?? ??????
?? ?????????? ?? script. ?? ?????? ??????????? ??? ???????? ??????,
????? ??? ?? ??????? ??? firewall ??????? ?? ?????????? ????? ??? ??????
?? ????????????? ?? ??????? ??? ?? ????????? ?? ????. ? ??????? ????
????? ???? ?????? ??? ??? ?????? ???? ???????, ????? ? ?????????? ??????
?? ??????????? ???? ????? ??????????. ????? ????????? ??? ????????
script, ???????? ?? ??????????????? ????????? ???????????? ??? ??
?????????????? ??? ?? ?????????????? ????? ????????????????? ????? ??
?????????? ???????. ???? ???????? ??? ???????? ??????????.

? ??????? ??? ??????????????? ???, ????? ??????? ?? ?? ??????
`sh(1) <http://www.FreeBSD.org/cgi/man.cgi?query=sh&sektion=1>`__,
`csh(1) <http://www.FreeBSD.org/cgi/man.cgi?query=csh&sektion=1>`__ ???
`tcsh(1) <http://www.FreeBSD.org/cgi/man.cgi?query=tcsh&sektion=1>`__.
??????? ??? ?? ????? ??? ?????????? ?????????????, ??????? ?? ???? ???
????????, $. ?? ??????? ???? ??? ??????? ??????? ??? ?? ????????? ?????.
? ???? ??? ?? ???????? ??? ????????? ?????, ?????? ?? ??????????? ??
????? ??????????.

????????? ?? ?????? ??? ??????? ??? ???? ???????? ????????:

.. code:: programlisting

    ############### start of example ipfw rules script #############
    #
    ipfw -q -f flush       # Delete all rules
    # Set defaults
    oif="tun0"             # out interface
    odns="192.0.2.11"      # ISP's DNS server IP address
    cmd="ipfw -q add "     # build rule prefix
    ks="keep-state"        # just too lazy to key this each time
    $cmd 00500 check-state
    $cmd 00502 deny all from any to any frag
    $cmd 00501 deny tcp from any to any established
    $cmd 00600 allow tcp from any to any 80 out via $oif setup $ks
    $cmd 00610 allow tcp from any to $odns 53 out via $oif setup $ks
    $cmd 00611 allow udp from any to $odns 53 out via $oif $ks
    ################### End of example ipfw rules script ############

???? ????? ???. ??? ?????????? ???? ??? ????? ?????????? ?? ???????,
???? ? ?????? ?? ??? ????? ??????????? ??? ???????? ????? ?? ?????
?????????? ?????????????.

?? ?? ???????? ?????????? ???? ??? ?????? ``/etc/ipfw.rules`` ??
?????????? ?? ????????? ?????? ???? ???????, ????????? ??? ????????
??????:

.. code:: screen

    # sh /etc/ipfw.rules

?? ?????? ``/etc/ipfw.rules`` ?????? ?? ????????? ?? ????? ????????
??????, ??? ?? ?????????? ?????? ???? ??????.

?? ?????????? ?? ????????? ?? ???? ??????, ?????????? ??? ????????
??????? ???????????:

.. code:: screen

    # ipfw -q -f flush
    # ipfw -q add check-state
    # ipfw -q add deny all from any to any frag
    # ipfw -q add deny tcp from any to any established
    # ipfw -q add allow tcp from any to any 80 out via tun0 setup keep-state
    # ipfw -q add allow tcp from any to 192.0.2.11 53 out via tun0 setup keep-state
    # ipfw -q add 00611 allow udp from any to 192.0.2.11 53 out via tun0 keep-state

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.5. ?????? ??????? Stateful
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ???????? ?????? ??????? (??? ??? ???????? ??????? ??? NAT) ????? ???
?????????? ?????? ???? inclusive firewall. ??? inclusive firewall
????????? ??? ?????? ???? ??? ??????? ??? ?????????? ?? ???? ???????
???????? (pass) ??? ?????????? ??? ?????????? ??? ?? ????. ?? firewalls
??? ????? ?????????? ?? ???????????? ???????? ??????, ????????? ??
???????? ??? ????????, ???? ?????? ?????? ?? ???????? ??????? ???? ??
firewall ?? ??????????.

??? ?? ??????????? ????????? ????? UNIX(R), ??????????????????? ??? ???
FreeBSD, ????? ?????????? ?? ????????????? ?? ??????? ``lo0`` ??? ??
????????? IP ``127.0.0.1`` ??? ????????? ??????????? ?? ?? ???????????
???????. ?? firewall ?????? ?? ???????? ??????? ??? ?? ?????????? ???
?????????? ?????? ????? ??? ???????, ??? ????????? ?????, ???????.

?? ??????? ??? ??????? ??? ???????? ???????????? ??? ???????????
???????, ????????? ??? ?? ??????? ??? ????????? ??? ??????? Internet. ?
??????? ???? ?????? ?? ????? ??? ?????????? ? ``tun0`` (?? ????????? ???
?????????????? ?? PPP ??????), ? ? ????? ??????? ??? ????????? ???
????????? ? DSL modem ???.

?? ????????? ??? ??? ? ???????????? ?????? ??????? ?????????? ??
????????? ???????? ?????? ???? ??? ?? firewall, ?? ?????? ?? ???????? ??
??????????? ??????? ??? ?? ?????????? ??? ???????? ????????? ??? ???????
??????? ???? ???????? ????? ?/??? ??? Internet.

?? ??????? ?????? ?? ???????????? ?? ????? ?????? ????????: ?????? ????
?? ???????? ???? ?????? ??????????? ? ???????? ????????? ?????????,
?????? ? ??????? ??? ??? ????? ?????????? ?? ?????? ???? ?? ???????
?????? (Internet) ??? ????? ? ??????? ??? ??? ????? ??????????? ??????
??? ?? Internet.

?? ???? ??? ??? ??? ???????? ??? ???????? ??? ?????????? ??? Internet,
?????? ?? ????????????? ?????? ?? ??????? ??? ?????????? ????????? ??
??? ?????????? ??????. ? ?????????? ??????? ??? ???????? ?? ?????? ??
?????????? ??? ?? ?????????? ??? ?? ?????? ??? ?????????????
????????/???????????.

? ??????? ??????????? (Outbound) ??? ?????? ??????? ??? ????????
????????, ???????? ???? ??????? ????? ``allow``. ?? ??????? ?????
????????? ????????????? ??????????? ?????, ?? ??? ?????? ?????????????
?? ???????? ????? ? ???????? ???? ????? ??????????? ? ???????? ??? ??
??????? Internet. ???? ?? ??????? ????? ??? ???????? ``proto``,
``port``, ``in/out`` ??? ``keep-state``. ?? ??????? ????? ``proto tcp``
????????? ??? ??????? ``setup`` ??? ??? ?????????? ??? ??????? ???????
??? ?????????, ???? ?? ????? ? ?????????? ??? ???? ?????? ?????????
(stateful).

???? ??????? ??? ???????????? ??????? (Inbound) ??? ???????? ????????,
???????????? ?????? ?? ??????? ??? ???????????????? ??? ??? ???????? ???
???????????? ???????. ???? ??????? ??? ??? ????????????? ??????. ?
?????? ????? ??? ?? ????????? ?????? ?????? ?? ????? ?? ?????????? ??
?????? ?????????????? ??? ??????? ???????. ?? ?????? ???? ?? ?????? ??
???????????, ???? ?? ?????? ????? ??? ?????? ??????? ?????? ``allow``. ?
???????? ????? ??? ???????? ?? ?????????? ???????????? ?????? ?? ?????
????????? ??? ??? ????? ??????, ???? ??? ????? ???????? ? ?????????
????. ?? ??? ????? ???? ??????????? ? ???? ??? ????????? ???? ??? ???
????????? ??????. ? ?????????? ??????? ?????? ?????????? ??? ??????????
??? ?? ?????? ??? ??????? ????? ?????. ? ??????? ????? ???????????????
??? ??? ?????? ??????? ?????????? ?? ????????? ??? ???????? ??????
?????????? ???? ?????? ??? ????????? ?? ????????? ??? ??????? ???.

?? ?????? ?????? ?? ???????????? ??? ?? ??????? ??? ??? ?? ????? ?????
???????? ?? ?????? ??? ?? ??????????? ??????. ?? ?????? ???? ?? ??????
?? ??????????? ??? ?? ????????????. ?? ??? ????? ????, ? ????????????
??? ???? ????? ????? ?? ?? ?????? ??? ??????? ????? ?? ??????? ???. ???
???????? ??????? ?? ?????? ?? ???????????? ??????? ?? ?? ??????? ???,
???? ??? ??????? ?????. ???? ????????? ????????? ??????? ?? ????????
????? ??? ??? ????????????, ???????? ??? ?????? ``/etc/services/`` ?
????? ?? ``http://www.securitystats.com/tools/portsearch.php`` ???
?????????? ??? ?????? ??? ????? ??? ?? ????? ????? ????? ? ?????? ???.
??????? ??? ???????? ????????? ??? ???? ???????? ????? ???
???????????????? ????? ??? ????????? ??????????? (Trojans):
``http://www.simovits.com/trojans/trojans.html``.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.6. ??? ????????? ??????? ??????? Inclusive
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ???????? ?????? ??????? (??? ????? ??? ??????????? ?????????? NAT)
????? ?????? ?????? ??? ???? ???????. ?????????? firewall ?????
inclusive, ??? ???? ?????????? ?? ??????????? ???????? ???????????.
?????? ?? ???????????? ?? ???? ???? ??? ?? ???? ??? ???????. ?????
?????????? ?? ?????? ???? ??????? ``pass`` ??? ??? ????????? ??? ???
?????? ?? ??????????????. ??? ?? ????????? ??? ????????? ????????????
?????????, ????? ????????? ??? ?????? ????? ``deny`` ???? ??????? ???
????????????. ?? ????? ???? ???????, ?? ?????? ?? ???????? ?? ????? ???
???????? ??? ``dc0`` ??? ?????????? ????? ??? ???????? ??? ????????? ???
??????? Internet. ?? ????????? ??? ?????????????? ?? PPP ??????, ??
????? ??? ???????? ?? ????? ``tun0``.

?? ???????????? ??? ??????? ??? ???????????? ?????? ??? ????? ????? ???
???????.

.. raw:: html

   <div class="itemizedlist">

-  ???? ?? ??????? ??? ????????? ?????? ??? ?????? ???? ???? ?????????
   ?? ?? ??????? Internet, ????????????? ??? ??????? ``keep-state``.

-  ???? ?? ?????????????? ????????? ??? ??????????? ??? ?? ???????
   Internet, ????????? ??? ??????? ``limit``, ??? ??? ??????? ?????????
   ???????????? (flooding).

-  ???? ?? ??????? ????????????? ??? ???????? ``in`` ? ``out`` ??? ??
   ????????????? ??? ?????????? ??? ????????????.

-  ???? ?? ??????? ????????????? ??? ??????? ``via ?????-????????`` ???
   ?? ?????????? ?? ??????? ??? ??? ????? ????????? ?? ??????.

.. raw:: html

   </div>

?? ??????? ??? ????????? ????????, ?? ?????? ?? ??????? ???
``/etc/ipfw.rules``.

.. code:: programlisting

    ################ Start of IPFW rules file ###############################
    # Flush out the list before we begin.
    ipfw -q -f flush

    # Set rules command prefix
    cmd="ipfw -q add"
    pif="dc0"     # public interface name of NIC
                  # facing the public Internet

    #################################################################
    # No restrictions on Inside LAN Interface for private network
    # Not needed unless you have LAN.
    # Change xl0 to your LAN NIC interface name
    #################################################################
    #$cmd 00005 allow all from any to any via xl0

    #################################################################
    # No restrictions on Loopback Interface
    #################################################################
    $cmd 00010 allow all from any to any via lo0

    #################################################################
    # Allow the packet through if it has previous been added to the
    # the "dynamic" rules table by a allow keep-state statement.
    #################################################################
    $cmd 00015 check-state

    #################################################################
    # Interface facing Public Internet (Outbound Section)
    # Check session start requests originating from behind the
    # firewall on the private network or from this gateway server
    # destined for the public Internet.
    #################################################################

    # Allow out access to my ISP's Domain name server.
    # x.x.x.x must be the IP address of your ISP.s DNS
    # Dup these lines if your ISP has more than one DNS server
    # Get the IP addresses from /etc/resolv.conf file
    $cmd 00110 allow tcp from any to x.x.x.x 53 out via $pif setup keep-state
    $cmd 00111 allow udp from any to x.x.x.x 53 out via $pif keep-state

    # Allow out access to my ISP's DHCP server for cable/DSL configurations.
    # This rule is not needed for .user ppp. connection to the public Internet.
    # so you can delete this whole group.
    # Use the following rule and check log for IP address.
    # Then put IP address in commented out rule & delete first rule
    $cmd 00120 allow log udp from any to any 67 out via $pif keep-state
    #$cmd 00120 allow udp from any to x.x.x.x 67 out via $pif keep-state

    # Allow out non-secure standard www function
    $cmd 00200 allow tcp from any to any 80 out via $pif setup keep-state

    # Allow out secure www function https over TLS SSL
    $cmd 00220 allow tcp from any to any 443 out via $pif setup keep-state

    # Allow out send & get email function
    $cmd 00230 allow tcp from any to any 25 out via $pif setup keep-state
    $cmd 00231 allow tcp from any to any 110 out via $pif setup keep-state

    # Allow out FBSD (make install & CVSUP) functions
    # Basically give user root "GOD" privileges.
    $cmd 00240 allow tcp from me to any out via $pif setup keep-state uid root

    # Allow out ping
    $cmd 00250 allow icmp from any to any out via $pif keep-state

    # Allow out Time
    $cmd 00260 allow tcp from any to any 37 out via $pif setup keep-state

    # Allow out nntp news (i.e. news groups)
    $cmd 00270 allow tcp from any to any 119 out via $pif setup keep-state

    # Allow out secure FTP, Telnet, and SCP
    # This function is using SSH (secure shell)
    $cmd 00280 allow tcp from any to any 22 out via $pif setup keep-state

    # Allow out whois
    $cmd 00290 allow tcp from any to any 43 out via $pif setup keep-state

    # deny and log everything else that.s trying to get out.
    # This rule enforces the block all by default logic.
    $cmd 00299 deny log all from any to any out via $pif

    #################################################################
    # Interface facing Public Internet (Inbound Section)
    # Check packets originating from the public Internet
    # destined for this gateway server or the private network.
    #################################################################

    # Deny all inbound traffic from non-routable reserved address spaces
    $cmd 00300 deny all from 192.168.0.0/16 to any in via $pif  #RFC 1918 private IP
    $cmd 00301 deny all from 172.16.0.0/12 to any in via $pif     #RFC 1918 private IP
    $cmd 00302 deny all from 10.0.0.0/8 to any in via $pif          #RFC 1918 private IP
    $cmd 00303 deny all from 127.0.0.0/8 to any in via $pif        #loopback
    $cmd 00304 deny all from 0.0.0.0/8 to any in via $pif            #loopback
    $cmd 00305 deny all from 169.254.0.0/16 to any in via $pif   #DHCP auto-config
    $cmd 00306 deny all from 192.0.2.0/24 to any in via $pif       #reserved for docs
    $cmd 00307 deny all from 204.152.64.0/23 to any in via $pif  #Sun cluster interconnect
    $cmd 00308 deny all from 224.0.0.0/3 to any in via $pif         #Class D & E multicast

    # Deny public pings
    $cmd 00310 deny icmp from any to any in via $pif

    # Deny ident
    $cmd 00315 deny tcp from any to any 113 in via $pif

    # Deny all Netbios service. 137=name, 138=datagram, 139=session
    # Netbios is MS/Windows sharing services.
    # Block MS/Windows hosts2 name server requests 81
    $cmd 00320 deny tcp from any to any 137 in via $pif
    $cmd 00321 deny tcp from any to any 138 in via $pif
    $cmd 00322 deny tcp from any to any 139 in via $pif
    $cmd 00323 deny tcp from any to any 81 in via $pif

    # Deny any late arriving packets
    $cmd 00330 deny all from any to any frag in via $pif

    # Deny ACK packets that did not match the dynamic rule table
    $cmd 00332 deny tcp from any to any established in via $pif

    # Allow traffic in from ISP's DHCP server. This rule must contain
    # the IP address of your ISP.s DHCP server as it.s the only
    # authorized source to send this packet type.
    # Only necessary for cable or DSL configurations.
    # This rule is not needed for .user ppp. type connection to
    # the public Internet. This is the same IP address you captured
    # and used in the outbound section.
    #$cmd 00360 allow udp from any to x.x.x.x 67 in via $pif keep-state

    # Allow in standard www function because I have apache server
    $cmd 00400 allow tcp from any to me 80 in via $pif setup limit src-addr 2

    # Allow in secure FTP, Telnet, and SCP from public Internet
    $cmd 00410 allow tcp from any to me 22 in via $pif setup limit src-addr 2

    # Allow in non-secure Telnet session from public Internet
    # labeled non-secure because ID & PW are passed over public
    # Internet as clear text.
    # Delete this sample group if you do not have telnet server enabled.
    $cmd 00420 allow tcp from any to me 23 in via $pif setup limit src-addr 2

    # Reject & Log all incoming connections from the outside
    $cmd 00499 deny log all from any to any in via $pif

    # Everything else is denied by default
    # deny and log all packets that fell through to see what they are
    $cmd 00999 deny log all from any to any
    ################ End of IPFW rules file ###############################

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.6.5.7. ??? ????????? NAT ?? Stateful ?????? ???????
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ?? ????????????? ? ?????????? NAT ??? IPFW, ??????????? ???????
???????? ?????????. ?? ?????? ?? ?????????? ??? ???????
``option IPDIVERT`` ???? ?? ??? ????????? ???????? ??? ?? IPFIREWALL ???
?????? ????????? ??? ??????. ?? ?????? ?????? ?? ?????????????? ??? ??
????????????? ?? ??? ??? ????????????? ??????.

????? ??? ??? ???????????? ???????? ??? ?? IPFW, ?? ?????? ?? ??????????
??? ??? ???????? ??? ?????? ``/etc/rc.conf``:

.. code:: programlisting

    natd_enable="YES"                   # Enable NATD function
    natd_interface="rl0"                # interface name of public Internet NIC
    natd_flags="-dynamic -m"            # -m = preserve port numbers if possible

? ????? ??????? stateful ???? ?? ??? ?????? ``divert natd`` (NAT),
?????????? ???? ??? ?????? ????????? ??? ???????. ? ???? ????????? ???
??????? ``check-state`` ??? ``divert natd`` ???? ??? ?????? ???????
??????? ???? ???????. ??? ????????? ????? ??? ???? ?????? ?????????? ???
??? ??? ?????? ???? ???????. ??????????????? ??? ??? ????? ????????? ???
?????????? ``skipto``. ??? ?? ?????????????? ? ?????? ``skipto``, ?????
??????????? ?? ????? ????????? ???? ???????, ???? ?? ?????? ?? ????
?????? ?? ????????? ?? ???? ??? ?? ?????????? ??? ??? ?????? ????.

???????? ?? ?????? ??? ????????? (????? ???????? ??????) ???? ???????
????????? ??? ????????? ??? ??? ?? ?????????? ??? ????????? ???? ???
??????? ???? ??? ?????? ???????.

? ??? ??? ???????????? ???????? ?? ??? ????? ??? ??? ?????? ?????? ???
????????? ??? ?????? ???? ???? ???? ?? ????, ???? ????? ?? ?????? ???
?????????, ? ????? ?? ?????? ?? ????????? ?? ?? ???????? ????????
??????? ?????? ??? ?? ??????????? ??? ?? firewall. ????? ????????? ??
????????????? ?? ???? ??? ??????? ?? ???????? 100, 101, 450, 500 ???
510. ?? ??????? ????? ???????? ??? ????????? ??? ??????????? ???
???????????? ???????, ???? ?? ???????????? ???? ??? ???????? ??????
??????????? ?? ????????? ????? ??? ???????? IP ????????? ??? ???????
???????. ??????????? ?????? ??? ???? ?? ??????? allow ??? deny
?????????? ??? ?????????? ??????? ??? ??????? ????? ??? ??? ???????.
??????, ???? ?? ??????????? ???????? ??? ???? ????????? ????????????
????????? (???? ??? ``skipto rule 500``) ???? ?????? 500 ??? ?? ????? ?
????????? ??????????? ??????? (NAT).

?? ?????????? ??? ??? ??????? ??? ??????? ??????? ???????????? ???
???????????? ??? ??? ?? ??? ??? ??????????. ?? ??????????? ?????????????
??? ????? 80 ??? ??? ???????????. ?? ?????? ?????????? ??? firewall. ???
????????? ?? ??? ?????? 100 ????? ????? ?????????? ??? ??? ???????????.
??????? ??? ?????? 101 ????? ????????? ??? ??? ??????????? ??? ???? ???
??????? ????? ???? ???????? ?????? ???????????. ?? ?????? ?????? ??????
???? ?????? 125 ?? ??? ????? ??? ?????????. ????????? ???? ??? ??????
??????? ??? ????????? ??? ??????? Internet. ?? ?????? ???? ????? ?? IP
????????? ??? ???????? ????????? ??? ??????? ???????. ?? ????????? ??
???? ??? ?????? ???????? ??? ?????????. ? ??????? ``keep-state`` ??
???????????? ??? ??? ???????? ??????, ?? ??? ??????????? ???? ??????,
??? ?? ????????? ??? ?????????? ????????. ? ???????? ???? ????? ?????
??? ??????????? ??? ???????? ???? ???????? ??????. ???? ????????? ????
????? ? ?skipto rule 500?. ? ??????? 500 ?????????? ???? NAT ??
????????? IP ??? ???????, ???? ???? ??????? ???? ?? Internet. ???? ?????
????????? ?????????. ?? ?????? ???????????? ???? ??? ????????? ???, ????
????????????? ??? ???????????? ??? ??? ?????? ?? ????????. ?? ??? ????
?????? ?????????? ???? ??? firewall, ???? ?????? ??? ????? ???? ??????
??? ??????. ???? ?? ???? ????????? ?? ??? ?????? 100 ??? ? ?????????
?????????? ??? ??????? ???? ???? ?????? ??? ??????? ???????. ??????,
??????? ? ??????????? ??? ??? ??? ?????? ``check-state`` ? ??????
??????????? ??? ????????? ??? ?????? ????????? ?? ??????? ??? ??
????????????? ??? ?????? ??????. ???????????? ???? ??? ?????????? ???
??????? ??????? ??? ?? ???????, ? ?????? ??????? ??? ??? ?????? ????????
??????????? ???????? ??? ??? ????????????? ???????????. ?? ?????? ????
????????? ??? ??? ?????? ``check-state``, ? ?????? ??????? ???
?????????? ??? ??? ?????????? ??? ??????? ??? ?????????? ???????? ??? ??
???? ??? ????????? ????? ?skipto 500?. ?? ?????? ?????????? ???? ??????
500, ??????? ? ????????? ??? ?????????? ??? ???? NAT ??? ???????????????
??? Internet.

??? ??? ????? ??? ????????????, ????? ?????? ????????????? ?? ????? ????
?????????? ?????????, ????????? ???????? ??? ??? ?????? ``check-state``
??? ???? ???????????? ??????? ``divert natd``. ?? ???? ??? ?????????? ??
??????????????? ????? ? ???????? ???? ??? ????????????? ??????? ??? ?
??????? ???? ??? ??????? ??? ???????????? ??? ???????????? ?????????. ??
?????????? ??? ?????? ??? ??????????? apache ? ?????? ?????????? ???
???????? ?? ?? firewall, ??? ?????????? ?? ?????? site ?? ?????
?????????? ??? ?? ??????? Internet. ? ??????????? ?????? ???? ?????????
????????? ?? ??? ?????? 100 ??? ? IP ????????? ??? ??????????????? ???
?????? IP ??? ??????????? ?? ?? firewall. ?? ?????? ?????? ????????? ???
??????????? ???????? ?????? ?? ???? ??????? ?? ???? ??????? ???
??????????????, ??? ?????? ????????? ?? ??? ?????? 425. ???? ?????????
???? ?????????? ??? ????????. ? ??????? ??? ?? ?????? ???????? ???
???????? ?????? ???????????, ???? ???? ?? ???? ???????????? ? ???????
???????? ???? ????????? ??? ?? ???????????? IP ?? 2. ?? ???? ??? ?????
???????? ?? ????????? ?? ????????? ????? ??????? ????????? (DoS) ???
????? ?? ???????????? ???? ????????????. ? ???????? ??? ?????? ????? ??
``allow``, ??? ???? ?? ?????? ??????????????? ??? ?????? ??????. ??
?????? ??? ????????? ?? ????????, ????????? ??? ??? ??????
``check-state``, ? ?????? ??????????? ??? ?????? ?? ??? ??? ??????
????????, ??? ???????????? ???? ?????? 500 ???? ??????? ? ????????? ???
?????????? ??? ???? NAT. ?? ?????? ?????? ??????????????? ???? ???
???????? ???????????.

????????? ??????? #1:

.. code:: programlisting

    #!/bin/sh
    cmd="ipfw -q add"
    skip="skipto 500"
    pif=rl0
    ks="keep-state"
    good_tcpo="22,25,37,43,53,80,443,110,119"

    ipfw -q -f flush

    $cmd 002 allow all from any to any via xl0  # exclude LAN traffic
    $cmd 003 allow all from any to any via lo0  # exclude loopback traffic

    $cmd 100 divert natd ip from any to any in via $pif
    $cmd 101 check-state

    # Authorized outbound packets
    $cmd 120 $skip udp from any to xx.168.240.2 53 out via $pif $ks
    $cmd 121 $skip udp from any to xx.168.240.5 53 out via $pif $ks
    $cmd 125 $skip tcp from any to any $good_tcpo out via $pif setup $ks
    $cmd 130 $skip icmp from any to any out via $pif $ks
    $cmd 135 $skip udp from any to any 123 out via $pif $ks


    # Deny all inbound traffic from non-routable reserved address spaces
    $cmd 300 deny all from 192.168.0.0/16  to any in via $pif  #RFC 1918 private IP
    $cmd 301 deny all from 172.16.0.0/12   to any in via $pif  #RFC 1918 private IP
    $cmd 302 deny all from 10.0.0.0/8      to any in via $pif  #RFC 1918 private IP
    $cmd 303 deny all from 127.0.0.0/8     to any in via $pif  #loopback
    $cmd 304 deny all from 0.0.0.0/8       to any in via $pif  #loopback
    $cmd 305 deny all from 169.254.0.0/16  to any in via $pif  #DHCP auto-config
    $cmd 306 deny all from 192.0.2.0/24    to any in via $pif  #reserved for docs
    $cmd 307 deny all from 204.152.64.0/23 to any in via $pif  #Sun cluster
    $cmd 308 deny all from 224.0.0.0/3     to any in via $pif  #Class D & E multicast

    # Authorized inbound packets
    $cmd 400 allow udp from xx.70.207.54 to any 68 in $ks
    $cmd 420 allow tcp from any to me 80 in via $pif setup limit src-addr 1


    $cmd 450 deny log ip from any to any

    # This is skipto location for outbound stateful rules
    $cmd 500 divert natd ip from any to any out via $pif
    $cmd 510 allow ip from any to any

    ######################## end of rules  ##################

?? ???????? ??????? ????? ?????? ????? ?? ???? ????????, ???? ?????????
??????????? ?????? ??? ?? ????????? ??? ??????? ?????? ??? IPFW ??
????????? ???????? ??? ???????????.

????????? ??????? #2:

.. code:: programlisting

    #!/bin/sh
    ################ Start of IPFW rules file ###############################
    # Flush out the list before we begin.
    ipfw -q -f flush

    # Set rules command prefix
    cmd="ipfw -q add"
    skip="skipto 800"
    pif="rl0"     # public interface name of NIC
                  # facing the public Internet

    #################################################################
    # No restrictions on Inside LAN Interface for private network
    # Change xl0 to your LAN NIC interface name
    #################################################################
    $cmd 005 allow all from any to any via xl0

    #################################################################
    # No restrictions on Loopback Interface
    #################################################################
    $cmd 010 allow all from any to any via lo0

    #################################################################
    # check if packet is inbound and nat address if it is
    #################################################################
    $cmd 014 divert natd ip from any to any in via $pif

    #################################################################
    # Allow the packet through if it has previous been added to the
    # the "dynamic" rules table by a allow keep-state statement.
    #################################################################
    $cmd 015 check-state

    #################################################################
    # Interface facing Public Internet (Outbound Section)
    # Check session start requests originating from behind the
    # firewall on the private network or from this gateway server
    # destined for the public Internet.
    #################################################################

    # Allow out access to my ISP's Domain name server.
    # x.x.x.x must be the IP address of your ISP's DNS
    # Dup these lines if your ISP has more than one DNS server
    # Get the IP addresses from /etc/resolv.conf file
    $cmd 020 $skip tcp from any to x.x.x.x 53 out via $pif setup keep-state


    # Allow out access to my ISP's DHCP server for cable/DSL configurations.
    $cmd 030 $skip udp from any to x.x.x.x 67 out via $pif keep-state

    # Allow out non-secure standard www function
    $cmd 040 $skip tcp from any to any 80 out via $pif setup keep-state

    # Allow out secure www function https over TLS SSL
    $cmd 050 $skip tcp from any to any 443 out via $pif setup keep-state

    # Allow out send & get email function
    $cmd 060 $skip tcp from any to any 25 out via $pif setup keep-state
    $cmd 061 $skip tcp from any to any 110 out via $pif setup keep-state

    # Allow out FreeBSD (make install & CVSUP) functions
    # Basically give user root "GOD" privileges.
    $cmd 070 $skip tcp from me to any out via $pif setup keep-state uid root

    # Allow out ping
    $cmd 080 $skip icmp from any to any out via $pif keep-state

    # Allow out Time
    $cmd 090 $skip tcp from any to any 37 out via $pif setup keep-state

    # Allow out nntp news (i.e. news groups)
    $cmd 100 $skip tcp from any to any 119 out via $pif setup keep-state

    # Allow out secure FTP, Telnet, and SCP
    # This function is using SSH (secure shell)
    $cmd 110 $skip tcp from any to any 22 out via $pif setup keep-state

    # Allow out whois
    $cmd 120 $skip tcp from any to any 43 out via $pif setup keep-state

    # Allow ntp time server
    $cmd 130 $skip udp from any to any 123 out via $pif keep-state

    #################################################################
    # Interface facing Public Internet (Inbound Section)
    # Check packets originating from the public Internet
    # destined for this gateway server or the private network.
    #################################################################

    # Deny all inbound traffic from non-routable reserved address spaces
    $cmd 300 deny all from 192.168.0.0/16  to any in via $pif  #RFC 1918 private IP
    $cmd 301 deny all from 172.16.0.0/12   to any in via $pif  #RFC 1918 private IP
    $cmd 302 deny all from 10.0.0.0/8      to any in via $pif  #RFC 1918 private IP
    $cmd 303 deny all from 127.0.0.0/8     to any in via $pif  #loopback
    $cmd 304 deny all from 0.0.0.0/8       to any in via $pif  #loopback
    $cmd 305 deny all from 169.254.0.0/16  to any in via $pif  #DHCP auto-config
    $cmd 306 deny all from 192.0.2.0/24    to any in via $pif  #reserved for docs
    $cmd 307 deny all from 204.152.64.0/23 to any in via $pif  #Sun cluster
    $cmd 308 deny all from 224.0.0.0/3     to any in via $pif  #Class D & E multicast

    # Deny ident
    $cmd 315 deny tcp from any to any 113 in via $pif

    # Deny all Netbios service. 137=name, 138=datagram, 139=session
    # Netbios is MS/Windows sharing services.
    # Block MS/Windows hosts2 name server requests 81
    $cmd 320 deny tcp from any to any 137 in via $pif
    $cmd 321 deny tcp from any to any 138 in via $pif
    $cmd 322 deny tcp from any to any 139 in via $pif
    $cmd 323 deny tcp from any to any 81  in via $pif

    # Deny any late arriving packets
    $cmd 330 deny all from any to any frag in via $pif

    # Deny ACK packets that did not match the dynamic rule table
    $cmd 332 deny tcp from any to any established in via $pif

    # Allow traffic in from ISP's DHCP server. This rule must contain
    # the IP address of your ISP's DHCP server as it's the only
    # authorized source to send this packet type.
    # Only necessary for cable or DSL configurations.
    # This rule is not needed for 'user ppp' type connection to
    # the public Internet. This is the same IP address you captured
    # and used in the outbound section.
    $cmd 360 allow udp from x.x.x.x to any 68 in via $pif keep-state

    # Allow in standard www function because I have Apache server
    $cmd 370 allow tcp from any to me 80 in via $pif setup limit src-addr 2

    # Allow in secure FTP, Telnet, and SCP from public Internet
    $cmd 380 allow tcp from any to me 22 in via $pif setup limit src-addr 2

    # Allow in non-secure Telnet session from public Internet
    # labeled non-secure because ID & PW are passed over public
    # Internet as clear text.
    # Delete this sample group if you do not have telnet server enabled.
    $cmd 390 allow tcp from any to me 23 in via $pif setup limit src-addr 2

    # Reject & Log all unauthorized incoming connections from the public Internet
    $cmd 400 deny log all from any to any in via $pif

    # Reject & Log all unauthorized out going connections to the public Internet
    $cmd 450 deny log all from any to any out via $pif

    # This is skipto location for outbound stateful rules
    $cmd 800 divert natd ip from any to any out via $pif
    $cmd 801 allow ip from any to any

    # Everything else is denied by default
    # deny and log all packets that fell through to see what they are
    $cmd 999 deny log all from any to any
    ################ End of IPFW rules file ###############################

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="navfooter">

--------------

+-------------------------------------+-----------------------------+----------------------------------------------+
| `????? <firewalls-ipf.html>`__?     | `???? <firewalls.html>`__   | ?\ `??????? <advanced-networking.html>`__    |
+-------------------------------------+-----------------------------+----------------------------------------------+
| 30.5. ?? IPFILTER (IPF) Firewall?   | `???? <index.html>`__       | ????????? 31. ??????????? ?????? ?????????   |
+-------------------------------------+-----------------------------+----------------------------------------------+

.. raw:: html

   </div>

???? ?? ???????, ??? ???? ???????, ?????? ?? ?????? ???
ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/

| ??? ????????? ??????? ?? ?? FreeBSD, ???????? ???
  `?????????? <http://www.FreeBSD.org/docs.html>`__ ???? ??
  ?????????????? ?? ??? <questions@FreeBSD.org\ >.
|  ??? ????????? ??????? ?? ???? ??? ??????????, ??????? e-mail ????
  <doc@FreeBSD.org\ >.
