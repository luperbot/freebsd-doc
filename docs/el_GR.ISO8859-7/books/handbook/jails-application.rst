========================
16.6. ???????? ??? Jails
========================

.. raw:: html

   <div class="navheader">

16.6. ???????? ??? Jails
`????? <jails-tuning.html>`__?
???????? 16. Jails
?\ `??????? <mac.html>`__

--------------

.. raw:: html

   </div>

.. raw:: html

   <div class="sect1">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

16.6. ???????? ??? Jails
------------------------

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

16.6.1. Service Jails
~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   <div>

?????????? ??? Daniel Gerzo.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

? ??????? ???? ????? ????????? ???? ???? ??? ????????????? ?????? ???
??? Simon L. B. Nielsen ???
``http://simon.nitro.dk/service-jails.html``, ????? ??? ?? ???
?????????? ????? ??? Ken Tom ``<locals@gmail.com>``. ???? ??????? ????
?? ??? ???????? ??? ?? ??????? ??? ??????? FreeBSD ?? ????? ?? ????????
??? ???????? ??????? ?????????, ?? ?? ????? ???
`jail(8) <http://www.FreeBSD.org/cgi/man.cgi?query=jail&sektion=8>`__.
?????????? ??? ?? ??????? ?????? ??????????? RELENG\_6\_0 ??? ??? ?????
?????????? ???? ??? ???????????? ??????????? ??? ?????????.

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

16.6.1.1. ??????????
^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ??? ?? ????????????? ?????????? ?? ?? jails ????? ? ?????????? ???
??????????? ????????????. ???? ?????? ?? ????? ???????? ????? ?? ????
jail ?????? ?? ???????????? ??? ??? ???? ?? ???? ??????????. ??????? ???
????? ???????? ?? ????? ??? ???? jail, ??? ??? ????????? ??? ???????
???? ??????????, ???? ??????? ?????????? ??? ????????? ?? ????? ?????
jails.

.. raw:: html

   <div class="warning" xmlns="">

?????????????:
~~~~~~~~~~~~~~

?? ???????? ????????? ???????????? ???????? ?? ?? FreeBSD ??? ?? ?????
??? ???????? ??????????????? ???. ??? ?? ???????? ?????? ??? ?????????
???? ?????????, ????? ???????? ?? ?????? ??? ????? ?? ???? ???? ????
???? ??
`sysutils/ezjail <http://www.freebsd.org/cgi/url.cgi?ports/sysutils/ezjail/pkg-descr>`__,
?? ????? ??????? ???? ?????????? ????? ??????????? ??? jails ??? FreeBSD
??? ??? ????? ???? ????????????? ??? ?? ???????? ?????????.

.. raw:: html

   </div>

? ???? ???? ???? ???????????? ??? ?? ????? ??????? ?????? ??????????, ??
??? ??????? ??? ?????? ?????? ??? ?? ??????? ???????????? ??????? ??????
??? jails, ?? ???? ?????? ???? ????? - ??????????????? ????????????
?????
`mount\_nullfs(8) <http://www.FreeBSD.org/cgi/man.cgi?query=mount_nullfs&sektion=8>`__
??? ???? ??? ???????? (read only) ???? ???? ? ?????????? ?? ?????
??????????, ??? ? ????? ??????????? jails ??? ???? ???????? ??
?????????? ?????????. ????????, ??????? ???? ???? ????? ??? ??
?????????? ??? ?? ?????????? jails ???? ?????? ??? ?? ?? ????????????.

.. raw:: html

   <div class="note" xmlns="">

????????:
~~~~~~~~~

???????????? ????????? ??????? ?????: ???? HTTP server, ???? DNS server,
???? SMTP server, ???.

.. raw:: html

   </div>

?? ?????? ??? ???????? ????????? ?????:

.. raw:: html

   <div class="itemizedlist">

-  ?????????? ????? ??? ?????????? jails. ???? ???????? ??? *???* ??
   ???????? ??? ?????? installworld ?? ???? jail.

-  ?????? ???????? ??? ???????? jails.

-  ?????? ?????????? ?????????? jails.

-  ?????????? ??????????? ?????????????? ???????? ??? FreeBSD.

-  ??? ??????????? ???????? ????? ???????, ?? ?????????????? ???
   ??????????? ?????????? ??????.

-  ???????????? ????? ??? inodes.

.. raw:: html

   </div>

???? ?????? ??? ???, ? ?????????? ????? ????????? ????????? ??? ???
?????? ???? ??????? template ??? ????? ??? ??????????? ? ???????
????????? (?????? ?? nullfs) ??? ?? ????? ?????? ?? ???? ??????????? ??
???? jail, ???? ?????? ??? ???? ?????? ??? ???? jail ???? ???????? ???
?? ????????? ???? ??? ???????? ??? ??? ??? ???????. ??? ?????? ???????
?????? ?? ????? ??????? ?????????? ??????? ??????, ??? ?????????, ?
?????? ??????? vnode
`md(4) <http://www.FreeBSD.org/cgi/man.cgi?query=md&sektion=4>`__. ???
???????? ??????????, ?? ???????????????? ???????????? ????? nullfs ????
?????? ?? ??????????? ??????? ??? ????????.

? ???? ??? ?????????? ??????? ???????????? ???? ???????? ?????:

.. raw:: html

   <div class="itemizedlist">

-  ???? jail ?? ??????????? ???? ??? ??? ???????? ``/home/j``.

-  ?? ``/home/j/mroot`` ????? ?? template ??? ?? ???? jail ??? ?
   ????????? ???? ????????? ??? ??? ?? jails.

-  ?? ???????????? ???? ????? ????????? ??? ???? jail ???? ??? ???
   ???????? ``/home/j``.

-  ???? jail ?? ???? ???? ???????? ``/s``, ? ?????? ?? ????? ?????????
   ???? ?? ????????? ????? ??? ??????????.

-  ???? jail ?? ???? ?? ???? ????????? ????? ?? ????? ?? ????????? ???
   ``/home/j/skel``.

-  ???? jailspace (?? ????????? ????? ???? jail) ?? ?????? ??
   ???????????? ???? ???????? ``/home/js``.

.. raw:: html

   </div>

.. raw:: html

   <div class="note" xmlns="">

????????:
~~~~~~~~~

??? ???? ???????????? ??? ?? jails ?????????? ???? ??? ??? ????????
``/home``. ???? ?????? ?????? ?? ??????? ?? ????????? ????? ??????, ????
?? ????????? ??? ?? ???????? ????????????.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

16.6.1.2. ????????????? ?? Template
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

? ??????? ???? ?? ?????????? ?? ?????? ??? ??????????? ??????????? ??
????????????? ?? ?????????? template ?? ????? ?? ???????? ?? ????? ???
jails ??? ????? ???? ??? ????????.

????? ??????? ???? ???? ?? ???????????? ?? FreeBSD ??? ????????? ??????
-RELEASE. ??? ?? ????? ????, ???????? ?? ??????????
`???????? <../../../../doc/el_GR.ISO8859-7/books/handbook/makeworld.html>`__
??? ??????????. ??? ????????? ??? ? ?????????? ??? ????? ??????, ??
??????????? buildworld ??? ?? ????????? ?? ??????????. ???????? ??
??????????? ?? ??????
`sysutils/cpdup <http://www.freebsd.org/cgi/url.cgi?ports/sysutils/cpdup/pkg-descr>`__.
?? ???????????????? ?? ????????? ?????????
`portsnap(8) <http://www.FreeBSD.org/cgi/man.cgi?query=portsnap&sektion=8>`__
??? ?? ??????????? ?? ??????? ??? Ports. ??? ???? ???-?????????????,
?????????? ? ???????? ??? `????????? ??? ??
Portsnap <../../../../doc/el_GR.ISO8859-7/books/handbook/portsnap.html>`__
??? ?????????? ??? FreeBSD.

.. raw:: html

   <div class="procedure">

#. ??????, ???????????? ??? ???? ????????? ??? ?? ??????? ??????? ??
   ????? ?? ????? ???? ??? ????????, ??? ?? ????? ?? ???????? ??
   ?????????? (binaries) ??? FreeBSD ??? ?? jails. ??? ????????
   ????????? ???? ???????? ???? ?????????? ?? ?????? ??????? ??????
   (source tree) ??? FreeBSD ??? ???????????? ?? ?????????? ?????? ???
   jail template:

   .. code:: screen

       # mkdir /home/j /home/j/mroot
       # cd /usr/src
       # make installworld DESTDIR=/home/j/mroot

#. ??????? ???? ????? ?? ????????????? ?? ??????? ??? Ports ??? FreeBSD
   ??? ?? jails ???? ?????? ??? ??? FreeBSD source tree, ?? ????? ??
   ????????? ??? ?? mergemaster:

   .. code:: screen

       # cd /home/j/mroot
       # mkdir usr/ports
       # portsnap -p /home/j/mroot/usr/ports fetch extract
       # cpdup /usr/src /home/j/mroot/usr/src

#. ???????????? ?? ??????? ??? ?? ????? ??? ?????????? ???? ???????????
   ??? ???????? ??? ???????:

   .. code:: screen

       # mkdir /home/j/skel /home/j/skel/home /home/j/skel/usr-X11R6 /home/j/skel/distfiles
       # mv etc /home/j/skel
       # mv usr/local /home/j/skel/usr-local
       # mv tmp /home/j/skel
       # mv var /home/j/skel
       # mv root /home/j/skel

#. ?????????????? ?? mergemaster ??? ?? ????????????? ?? ??????
   ????????? ??? ???????. ??? ???????? ????????? ????? ???? ?????
   ?????????? ??? ?????????? ?? mergemaster:

   .. code:: screen

       # mergemaster -t /home/j/skel/var/tmp/temproot -D /home/j/skel -i
       # cd /home/j/skel
       # rm -R bin boot lib libexec mnt proc rescue sbin sys usr dev

#. ????, ???????????? ?????????? ??? ?? ??????? ??????? ??? ?????
   ??????????? ? ???????, ???? ?? ??????? ??????? ??? ????? ???? ???
   ????????. ??????????? ??? ?? ????????? ????? ???????????? ???? ??????
   ?????? ``s/``. ? ?????? ??????????? ????????? ? ? ??????????
   ????????? ?? ????? ?????? ?? ????????? ??? ??????????? ?? ????????.

   .. code:: screen

       # cd /home/j/mroot
       # mkdir s
       # ln -s s/etc etc
       # ln -s s/home home
       # ln -s s/root root
       # ln -s ../s/usr-local usr/local
       # ln -s ../s/usr-X11R6 usr/X11R6
       # ln -s ../../s/distfiles usr/ports/distfiles
       # ln -s s/tmp tmp
       # ln -s s/var var

#. ??? ????????? ????, ???????????? ??? ?????? ??????
   ``/home/j/skel/etc/make.conf`` ?? ?? ???????? ????????:

   .. code:: programlisting

       WRKDIRPREFIX?=  /s/portbuild

   ??????? ?????? ?? ``WRKDIRPREFIX`` ?? ????? ??? ?????, ?? ???????? ??
   ?????????????? ports ??? FreeBSD ???? ?? ???? jail. ????????? ??? ?
   ????????? ??? ports ????? ????? ??? ?????????? ??????? ??? ????
   ??????????? ???? ??? ????????. ? ????????????? ???????? ??? ??
   ``WRKDIRPREFIX`` ????????? ??? ???????????? ??? ports ??? ?????????
   ????? ??? ???? jail.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

16.6.1.3. ????????????? Jails
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

???? ??? ?????? ??? ???????????? FreeBSD jail template, ???????? ??
?????????????? ??? ?? ?????????? ?? jails ??? ``/etc/rc.conf``. ??
?????????? ???? ??????? ?? ?????????? ????? jails: ?NS?, ?MAIL? ???
?WWW?.

.. raw:: html

   <div class="procedure">

#. ???????? ??? ???????? ??????? ??? ?????? ``/etc/fstab``, ???? ?? ????
   ??? ???????? template ??? ?? jails ??? ? ?????????? ????? ?? ?????
   ????????? ??? ?????????? jails:

   .. code:: programlisting

       /home/j/mroot   /home/j/ns     nullfs  ro  0   0
       /home/j/mroot   /home/j/mail   nullfs  ro  0   0
       /home/j/mroot   /home/j/www    nullfs  ro  0   0
       /home/js/ns     /home/j/ns/s   nullfs  rw  0   0
       /home/js/mail   /home/j/mail/s nullfs  rw  0   0
       /home/js/www    /home/j/www/s  nullfs  rw  0   0

   .. raw:: html

      <div class="note" xmlns="">

   ????????:
   ~~~~~~~~~

   ?? ??????????? ??? ????? ??????????? ?? 0 pass number ??? ??????????
   ???? ??? ???????? ??? ??
   `fsck(8) <http://www.FreeBSD.org/cgi/man.cgi?query=fsck&sektion=8>`__,
   ??? ??? ??? ??????????? ?? 0 dump number, ?
   `dump(8) <http://www.FreeBSD.org/cgi/man.cgi?query=dump&sektion=8>`__
   ??? ?? ?????????? ????????? ?????????. ????????, ??? ??????? ?? fsck
   ?? ??????? ??? ???????????? ????? nullfs, ???? ??? ?? dump ?? ?????
   ????????? ??? ?? ???? ??? ???????? nullfs ????????? ??????? ???
   jails. ????? ????? ??? ? ????? ??? ?????? ?0?0? ???? ??? ??????????
   ?????? ???? ???????? ??? ``fstab``.

   .. raw:: html

      </div>

#. ???????? ?? jails ??? ``/etc/rc.conf``:

   .. code:: programlisting

       jail_enable="YES"
       jail_set_hostname_allow="NO"
       jail_list="ns mail www"
       jail_ns_hostname="ns.example.org"
       jail_ns_ip="192.168.3.17"
       jail_ns_rootdir="/home/j/ns"
       jail_ns_devfs_enable="YES"
       jail_mail_hostname="mail.example.org"
       jail_mail_ip="192.168.3.18"
       jail_mail_rootdir="/home/j/mail"
       jail_mail_devfs_enable="YES"
       jail_www_hostname="www.example.org"
       jail_www_ip="62.123.43.14"
       jail_www_rootdir="/home/j/www"
       jail_www_devfs_enable="YES"

   .. raw:: html

      <div class="warning" xmlns="">

   ?????????????:
   ~~~~~~~~~~~~~~

   ? ????? ??? ??? ????? ??????? ?? ????????? ``jail_name``\ \_rootdir
   ?? ??????? ??? ``/usr/home`` ???? ??? ?? ``/home`` ????? ??? ? ??????
   ???????? ??? ??? ???????? ``/home `` ?? ??? ?????? ??????????? ???
   FreeBSD ????? ?? ``/usr/home``. ? ????????? ``jail_name``\ \_rootdir
   *???* ??? ?????? ?? ??????? ???? ???????? ??? ???????????? ?????????
   ?????, ??????????? ?? jails ?? ???????? ?? ??????????. ??????????????
   ?? ????????? ?????????
   `realpath(1) <http://www.FreeBSD.org/cgi/man.cgi?query=realpath&sektion=1>`__
   ??? ?? ????????????? ??? ???? ??? ?? ?????? ?? ????? ???? ?
   ?????????. ????? ?? FreeBSD-SA-07:01.jail Security Advisory ???
   ???????????? ???????????.

   .. raw:: html

      </div>

#. ???????????? ?? ?????????? ?????? ???????????? ??? ?? ??????? ???????
   ???? ????????? ??? ???? jail:

   .. code:: screen

       # mkdir /home/j/ns /home/j/mail /home/j/www

#. ???????????? ?? ????????? template ???? ??? ???? jail. ???????? ???
   ?? ????? ???
   `sysutils/cpdup <http://www.freebsd.org/cgi/url.cgi?ports/sysutils/cpdup/pkg-descr>`__,
   ?? ????? ???????????? ??? ????????????? ?? ????? ????????? ??? ????
   ?????????:

   .. code:: screen

       # mkdir /home/js
       # cpdup /home/j/skel /home/js/ns
       # cpdup /home/j/skel /home/js/mail
       # cpdup /home/j/skel /home/js/www

#. ?? ???? ?? ????, ?? jails ????? ???????????? ??? ????? ?????? ??
   ??????????. ??????????? ?? ????? ??????? ??????? ??? ?? ???? jail,
   ??? ??? ???????? ????????? ??, ??????????????? ?? script
   ``/etc/rc.d/jail``:

   .. code:: screen

       # mount -a
       # /etc/rc.d/jail start

.. raw:: html

   </div>

?? jails ?? ?????? ???? ?? ??????????? ????????. ?? ?? ???????? ?? ?????
????????? ?????, ??????????????? ??? ??????
`jls(8) <http://www.FreeBSD.org/cgi/man.cgi?query=jls&sektion=8>`__. ??
?????? ?? ????? ???? ?????????? ?? ?? ????????:

.. code:: screen

    # jls
       JID  IP Address      Hostname                      Path
         3  192.168.3.17    ns.example.org                /home/j/ns
         2  192.168.3.18    mail.example.org              /home/j/mail
         1  62.123.43.14    www.example.org               /home/j/www

?? ???? ?? ??????, ?? ?????? ?? ???????? ?? ?????????? ?? ???? jail, ??
?????????? ????? ??????? ? ?? ????????? ?????????. ? ????? ``JID``
??????? ?? ?????????????? ????????????? ?????? ???? ??????? jail.
?????????????? ??? ???????? ?????? ??????????? ?? ?????????? ????????
??????????? ??? jail, ?? ``JID`` 3:

.. code:: screen

    # jexec 3 tcsh

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

16.6.1.4. ??????????
^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?????? ??????, ?? ????????? ?? ???????????? ?? ??????? ??? ?? ??? ???
?????? ??? FreeBSD, ???? ??? ?????? ?????????, ???? ????? ???????? ????
??????????? ???? ??????? ?????? ?? ?????? ????? ???????? ??? ?? jails
??? ??? ?????. ? ?????? ??? ??????????????? ??? ??? ?????????? ???
jails, ????????? ??? ?????? ?????????? ????. ????????, ????????????? ??
????? ???????? ??? ??????????? ????, ??? ??? ?? ????????? ?? ??
??????????? ???? ???? ?? ???? ????????? ?????. ??????, ??????? ????
????? ?? ??????????? ?? ??????????? ???????? ??? ????????? ???????????
????????.

.. raw:: html

   <div class="procedure">

#. ?? ????? ???? ????? ?? ???????????? ?? ??????? ??? ?????
   ????????????? ?? jails, ?? ?? ?????? ?????. ??? ???????? ????????????
   ??? ??? ????????? template ????????, ???? ??? ????????, ???
   ``/home/j/mroot2``.

   .. code:: screen

       # mkdir /home/j/mroot2
       # cd /usr/src
       # make installworld DESTDIR=/home/j/mroot2
       # cd /home/j/mroot2
       # cpdup /usr/src usr/src
       # mkdir s

   ?? ``installworld`` ?????????? ???????? ?????????? ??? ??
   ???????????, ??? ?? ?????? ?? ??????????:

   .. code:: screen

       # chflags -R 0 var
       # rm -R etc var root usr/local tmp

#. ???????????? ???? ???? ?????????? ??? ?? ??????? ??????? ????????? -
   ????????:

   .. code:: screen

       # ln -s s/etc etc
       # ln -s s/root root
       # ln -s s/home home
       # ln -s ../s/usr-local usr/local
       # ln -s ../s/usr-X11R6 usr/X11R6
       # ln -s s/tmp tmp
       # ln -s s/var var

#. ???? ????? ? ????? ?????? ??? ?? ??????????? ?? jails:

   .. code:: screen

       # /etc/rc.d/jail stop

#. ?????????????? ?? ?????? ????????? ???????:

   .. code:: screen

       # umount /home/j/ns/s
       # umount /home/j/ns
       # umount /home/j/mail/s
       # umount /home/j/mail
       # umount /home/j/www/s
       # umount /home/j/www

   .. raw:: html

      <div class="note" xmlns="">

   ????????:
   ~~~~~~~~~

   ?? ????????? ??????? ????????? - ???????? ????? ???????????? ???
   ??????? ??????? ???? ????????? (``/s``) ??? ?????? ?? ????? ?? ?????
   ??? ?? ???????????????.

   .. raw:: html

      </div>

#. ??????????? ??? ????? ???? ??? ???????? ????????, ??? ??????????????
   ??? ?? ??? ??????????. ? ?????? ?? ?????????? ?? ????????? ?????????
   ??? ?????? ?????????? ?? ????????? ???????????. ? ?????? ?????????
   ??? ???????????? ??? ??????????? ??? ??????? ?????? ??????????? ???
   ???? ?????????? ??????? ???? ?????????. ??????????? ??? ??????
   ??????? ??? Ports ??? FreeBSD ??? ??? ???????, ??????? ??????????? ??
   ?????????????? ???? ??? inodes:

   .. code:: screen

       # cd /home/j
       # mv mroot mroot.20060601
       # mv mroot2 mroot
       # mv mroot.20060601/usr/ports mroot/usr

#. ?? ???? ?? ?????? ?? ???? ??? ???????? template ????? ??????, ?????
   ?? ???? ??? ???????? ????? ?? ???????????? ???? ?? ????????? ???????
   ??? ?? ?????????? ?? jails:

   .. code:: screen

       # mount -a
       # /etc/rc.d/jail start

.. raw:: html

   </div>

?????????????? ??? ??????
`jls(8) <http://www.FreeBSD.org/cgi/man.cgi?query=jls&sektion=8>`__ ???
?? ???????? ??? ?? jails ????????? ?????. ??? ???????? ?? ?????????? ??
mergemaster ??? ?? ???? jail. ?? ????????? ?? ???????????? ???? ??
?????? ?????????, ??? ??? ?? rc.d scripts.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="navfooter">

--------------

+--------------------------------------------+-------------------------+------------------------------------------------+
| `????? <jails-tuning.html>`__?             | `???? <jails.html>`__   | ?\ `??????? <mac.html>`__                      |
+--------------------------------------------+-------------------------+------------------------------------------------+
| 16.5. ?????????? ??????? ??? ???????????   | `???? <index.html>`__   | ????????? 17. ???????????? ??????? ?????????   |
+--------------------------------------------+-------------------------+------------------------------------------------+

.. raw:: html

   </div>

???? ?? ???????, ??? ???? ???????, ?????? ?? ?????? ???
ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/

| ??? ????????? ??????? ?? ?? FreeBSD, ???????? ???
  `?????????? <http://www.FreeBSD.org/docs.html>`__ ???? ??
  ?????????????? ?? ??? <questions@FreeBSD.org\ >.
|  ??? ????????? ??????? ?? ???? ??? ??????????, ??????? e-mail ????
  <doc@FreeBSD.org\ >.
