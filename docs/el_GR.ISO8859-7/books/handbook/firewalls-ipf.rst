================================
30.5. ?? IPFILTER (IPF) Firewall
================================

.. raw:: html

   <div class="navheader">

30.5. ?? IPFILTER (IPF) Firewall
`????? <firewalls-pf.html>`__?
???????? 30. Firewalls
?\ `??????? <firewalls-ipfw.html>`__

--------------

.. raw:: html

   </div>

.. raw:: html

   <div class="sect1">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5. ?? IPFILTER (IPF) Firewall
--------------------------------

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

? ?????????? ??? IPFILTER ????? ? Darren Reed. ?? IPFILTER ??? ?????????
??? ?? ??????????? ???????: ????? ??? ???????? ???????? ?????? ??? ????
?????????? ??? FreeBSD, ?? NetBSD, ?? OpenBSD, ?? SunOSTM, ?? HP/UX ???
?? SolarisTM. ?? IPFILTER ????? ??? ?????? ??? ?????? ???????? ???
?????????, ??? ??????????? ??????? ?? ???? ???????? ???.

?? IPFILTER ????? ??? firewall ??? ?????????? NAT ??? ?????????? ????
?????? ??? ?????? ?? ????????? ??? ?? ??????????????? ??? ???????????
??????. ?? ??????? ??? firewall ??????? ?? ???????? ?? ???? ? ??
???????????? ???? ??? ?????????? ????????????
`ipf(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipf&sektion=8>`__. ??
??????? ??? ?? NAT ??????? ?? ???????? ?? ???? ? ?? ???????????? ????
??? ?????????? ????????????
`ipnat(1) <http://www.FreeBSD.org/cgi/man.cgi?query=ipnat&sektion=1>`__.
?? ????????? ?????????
`ipfstat(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&sektion=8>`__
?????? ?? ????????? ?????????? ????????? ??? ?? ????? ??? IPFILTER ???
?????????? ???? ??????. ?? ?????????
`ipmon(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipmon&sektion=8>`__
?????? ?? ?????????? ??? ????????? ??? IPFILTER ??? ?????? ??????????
????????? ??? ??????????.

?? IPF ??????? ?????? ??????????????? ??? ?????? ???????????? ???????
??? ????? ?? ????????? ??????? ??? ?????????, ????? ??? ? ???????? ???
?????????????? ???? ??????? ????? stateless. ?? ??? ?????? ??? ??????,
?? IPF ?????????? ??? ?? ???????????? ??? ??????? ?quick? ??? ???
??????? ?keep state? ??? stateful ???????. ?? ???????? ?????
????????????? ????????? ?? ?????? ???????????? ??? ???????. ? ???????
?????????? ??? IPF ???????? ???? ??? ?????? ??????????? ???????? ???
???????????? ??? ???????. ?? ????????? ??????????? ??????????? ???? ??
????????? ????????, ??? ???? ??? ?????????? ?????? ?? ????????????? ????
??? ?????????? ???? ???? ????????? ??? ???????????? firewall.

?? ??????? ??? ??????????? ?? ???? ??? ???????, ?????????? ??? ?????
??????? ??? ????????? ??? ??????? ?quick? ????? ??? ??? stateful ???????
?keep state?. ???? ????? ??? ?? ?????? ??????? ??????????? ??? ???
?????????? ??? ??? ??????? ???? inclusive firewall.

??? ???????????? ??????? ?? ??? ????????? ????? ???????????? ???
???????, ?????: ``http://www.obfuscation.org/ipf/ipf-howto.html#TOC_1``
??? ``http://coombs.anu.edu.au/~avalon/ip-filter.html``.

???????? ?? ????? ?? IPF FAQ ???? ?????????
``http://www.phildev.net/ipf/index.html``.

???????? ?? ?????? ??? ??????????? ???????????? ??? ?????? ????????????
??? IPFILTER ??? ``http://marc.theaimsgroup.com/?l=ipfilter``. ?????????
?????????? ??????????.

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.1. ?????????????? ?? IPF
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? IPF ?????????????? ??? ?????? ??????????? ??? FreeBSD ?? ??????? ??
????? ?????? ?? ???????? ???????. ?? ??????? ?? ???????? ???????? ??
??????? ??? IPF ?? ??????? ? ?????????? ``ipfilter_enable="YES"`` ???
?????? ``/etc/rc.conf``. ?? ??????? ???? ???????????? ?? ??????????????
??? ?????????? ?????????? ??? ?? ??? ??????? ``default pass all``. ???
?? ???????? ???? ??? ?????????? ?? ``block all``, ???????? ????? ??
?????????? ??? ?????? ????????? (block all) ??? ????? ??? ??????? ???.
??? ?????????? ?? ?????????????? ??? ??????? IPF ??? ?????? ??? FreeBSD
??? ?? ????? ????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.2. ???????? ??? ??? ??????
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ????? ??????????? ?? ?????????????? ??? ???????? ???????? ????
?????? ??? FreeBSD ??? ?? ?????????????? ?? IPF. ? ?????????? ???? ???
????? ?????? ???????????. ?? ?????????????? ?? IPF ????????? ????
??????, ??? ?? ?????????????? ???? ?? ?????????? ???????.

??? ?????? ``/usr/src/sys/conf/NOTES`` ?? ?????? ????????????
???????????? IPF ??? ?? ?????? ???????? ??? ??????. ?? ???????? ?????
????????? ?????? ????????:

.. code:: programlisting

    options IPFILTER
    options IPFILTER_LOG
    options IPFILTER_DEFAULT_BLOCK

? ??????? ``options IPFILTER`` ??????????? ??? ?????????? ??? ??
?IPFILTER? firewall.

? ??????? ``options IPFILTER_LOG`` ??????????? ??? ?????????? ??????????
??? IPF, ? ????? ?????? ???? ?????-??????? ?????????? ??????? ``ipl``
??? ???? ?????? ??? ???????????? ??? ??????? ``log``.

? ??????? ``options IPFILTER_DEFAULT_BLOCK`` ??????? ??? ?????????????
???????????, ???? ???? ?????? ??? ??? ????????? ?? ?????? ??????
``pass`` ??? firewall, ?? ???????????? ????????.

?? ???????? ???????? ?? ?????????????? ???? ???? ?????????????? ???
????????????? ??? ????????????? ?????? ??? ?? ??? ????????????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.3. ?????????? ???????? ??? ?? ``rc.conf``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?????????? ??? ???????? ???????????? ??? ``/etc/rc.conf`` ??? ??
?????????????? ?? IPF ???? ??? ???????? ??? ??????????:

.. code:: programlisting

    ipfilter_enable="YES"             # Start ipf firewall
    ipfilter_rules="/etc/ipf.rules"   # loads rules definition text file
    ipmon_enable="YES"                # Start IP monitor log
    ipmon_flags="-Ds"                 # D = start as daemon
                                      # s = log to syslog
                                      # v = log tcp window, ack, seq
                                      # n = map IP & port to names

?? ???? ??? ???? ?? firewall ??????? ?????? LAN ??? ????????????
??????????? ????????? ???????????, ?? ????????? ?? ?????????? ???
???????? ???????????? ??? ?? ?????????????? ?? ?????????? NAT:

.. code:: programlisting

    gateway_enable="YES"              # Enable as LAN gateway
    ipnat_enable="YES"                # Start ipnat function
    ipnat_rules="/etc/ipnat.rules"    # rules definition file for ipnat

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.4. IPF
~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

? ??????
`ipf(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipf&sektion=8>`__
??????????????? ??? ?? ???????? ?? ?????? ??? ???????. ???????????, ??
????????????? ??? ?????? ?? ???? ?????? ??? ??????????????? ??????? ???
?? ??????????????? ?? ???? ??'????????? ???? ?????????????? ??????? ???
firewall:

.. code:: screen

    # ipf -Fa -f /etc/ipf.rules

? ??????? ``-Fa`` ???????? ???? ??????? ??? ???? ??????????? ??????? ???
firewall.

? ??????? ``-f`` ????????? ?? ?????? ??? ??????? ??? ?? ????????.

???? ??? ????? ??? ?????????? ?? ???????? ?? ?????? ??????? ???, ??
?????????? ??? ?????? IPF ??? ????????? ????????, ??? ?? ?????????? ??
???? ??? ????? ???? ??????? ??? firewall ??? ?????????? ??? ??
????????????, ????? ?? ????????? ?? ?????????????? ?? ??????? ???. ?
??????? ???? ????? ???? ?????? ??? ?? ?????????? ????? ???????, ?????
?????? ?? ??????????? ???? ????? ??????.

????? ?? ?????? manual ???
`ipf(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipf&sektion=8>`__ ???
???????????? ??????? ?? ??? ????????? ???????? ??? ???????? ??
??????????????? ?? ??? ?????? ????.

? ??????
`ipf(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipf&sektion=8>`__
???????? ??? ???? ?????? ???????? ?? ?????? ???????. ??? ?? ??????
?????? ??????? ???????? ?? script ?? ?????????? ???????????????.

??????? ?????? ?????? ?? ??????? ??????? IPF ??? ?? ????????????? ???
???? ??? ?????????? ???????????????. ??? ???????????? ???????????, ?????
?? `??????30.5.9, ??????????? Script ??????? ?? ?????????
????????????? <firewalls-ipf.html#firewalls-ipf-rules-script>`__.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.5. IPFSTAT
~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

? ????????????? ??????????? ???
`ipfstat(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&sektion=8>`__
????? ?? ?????? ??? ?? ??????????? ?? ?????? ??? ??????????? ???
?????????????? ?? ?????????? ??? ????????? ??? ??????? ??? ?????? ???
?????? ??? ??????????? ??? ?????????? ??? ?? firewall, ??? ?? ?????? ???
?????????? ??? ????????? ? ??? ??? ????????? ???? ????????? ???? ???
??????? ``ipf -Z``.

????? ?? ?????? manual
`ipfstat(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&sektion=8>`__
??? ????????????.

? ????????????? ?????? ??? ???????
`ipfstat(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&sektion=8>`__
?? ??????? ?? ??? ????????:

.. code:: screen

    input packets: blocked 99286 passed 1255609 nomatch 14686 counted 0
     output packets: blocked 4200 passed 1284345 nomatch 14687 counted 0
     input packets logged: blocked 99286 passed 0
     output packets logged: blocked 0 passed 0
     packets logged: input 0 output 0
     log failures: input 3898 output 0
     fragment state(in): kept 0 lost 0
     fragment state(out): kept 0 lost 0
     packet state(in): kept 169364 lost 0
     packet state(out): kept 431395 lost 0
     ICMP replies: 0 TCP RSTs sent: 0
     Result cache hits(in): 1215208 (out): 1098963
     IN Pullups succeeded: 2 failed: 0
     OUT Pullups succeeded: 0 failed: 0
     Fastroute successes: 0 failures: 0
     TCP cksum fails(in): 0 (out): 0
     Packet log flags set: (0)

???? ?????????????? ? ??????? ``-i`` ??? ?? ??????????? ? ? ???????
``-o`` ??? ?? ?????????? ??????, ? ?????? ?? ????????? ??? ??
??????????? ??? ?????????? ????? ??????? ??? ????? ????????????? ???
??????????????? ??? ??? ?????? ?? ???????? ??????.

? ?????? ``ipfstat -in`` ??????? ??? ?????????? ?????? ??????? ???
??????????? ??????.

? ?????? ``ipfstat -on`` ??????? ??? ?????????? ?????? ??????? ???
?????????? ??????.

? ?????? ?? ??????? ?? ??? ????????:

.. code:: screen

    @1 pass out on xl0 from any to any
    @2 block out on dc0 from any to any
    @3 pass out quick on dc0 proto tcp/udp from any to any keep state

? ?????? ``ipfstat -ih`` ??????? ??? ?????? ??????? ??? ?? ???????????
??????, ???????????? ??????? ??? ??? ???? ?????? ??? ?????? ??? ???????
????? ????? ???? ??????????????.

? ?????? ``ipfstat -oh`` ??????? ??? ?????? ??????? ??? ?? ??????????
??????, ???????????? ??????? ??? ??? ???? ?????? ??? ?????? ??? ???????
????? ????? ???? ??????????????.

? ?????? ?? ??????? ?? ??? ????????:

.. code:: screen

    2451423 pass out on xl0 from any to any
    354727 block out on dc0 from any to any
    430918 pass out quick on dc0 proto tcp/udp from any to any keep state

??? ??? ??? ??? ?????????? ??????????? ??? ??????? ``ipfstat`` ????? ?
??????? ``-t`` ? ????? ??????????? ??? ?????? ???????????, ?? ?????
????? ?? ???? ??? ???????????? ? ??????
`top(1) <http://www.FreeBSD.org/cgi/man.cgi?query=top&sektion=1>`__ ???
?? ?????? ??? ?????? ?????????? ??? ??????????? ??? FreeBSD. ???? ??
firewall ??? ??????? ???????, ? ?????????? ???? ??? ????? ??? ??????????
?? ???????????? ??? ?? ????????? ??? ???? ?? ?????? ??? ??? ?????????.
?? ???????????? ???-???????? ??? ?????? ??? ?????????? ?? ????????? ??
IP ????????? ? ??????????, ??? ????, ? ?? ?????????? ?? ????? ?????? ??
??????????????? ?? ?????????? ?????. ????? ?? ?????? manual ???
`ipfstat(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipfstat&sektion=8>`__
??? ???????????? ????????????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.6. IPMON
~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ?? ???????????? ????? ? ?????? ``ipmon``, ?? ?????? ?? ?????????????
? ??????? ``IPFILTER_LOG`` ???? ??????. ? ?????? ???? ???????? ???
????????????? ??????? ???????????. ? ?????????????? ????????? ??????
??????????? ?????????????? ???? ? ?????? ??????????????? ????? ???
??????? ``-D``.

? ?????? ?????? ?? ?????????????? ?? ?????????? ??????? ???? ??????????
?? ????? ??? ?????????? ?????? ?????????? ???? ?? ???????? ?? ?????????
??? ???????????? ????????. ????? ????? ??? ? ?????? ?? ??? ????? ????
????????? ?? ???????????? ?? FreeBSD ?? ?? IPFILTER. ?? FreeBSD ????
???????????? ?????????? ????????? ??????? ??????????. ??? ???? ?? ????,
????? ???????? ? ????????? ?? ??????? ???? ???
`syslogd(8) <http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&sektion=8>`__
???? ?? ??? ??????????? ??????. ??? ??????????, ? ???????
``ipmon_flags`` ??? ?????? ``rc.conf`` ???????????? ??? ????????
``-Ds``:

.. code:: programlisting

    ipmon_flags="-Ds" # D = start as daemon
                      # s = log to syslog
                      # v = log tcp window, ack, seq
                      # n = map IP & port to names

?? ????????????? ??? ?????????? ????? ???????. ??????? ??? ??????????
??????????? ??????????? ???? ?? ?????? ??? ????????????, ??? ???????????
??? ??? ?????? ????????, ??? ??? ????????? ????. ????? ???? ???
????????? ??????????? ???? ??????????? ?? ???????????? ??? ????????.

????? ??? ???? ?????????????? ??? ?????????? ??????????, ?? IPF ??? ??
?????????? ?????? ?? ??? ???? ????? ? ?????????? ??????? ????? ???????.
? ???????????? ??? firewall ?????????? ??? ?????? ??????? ??? ??? ?????
?? ????????????? ??? ?????????, ??? ????????? ?? ?????? ??? ???? log.
???????????, ? ????????? ?????????????? ???? ?? ??????? ??? ???????????
??????.

????? ???? ??????????? ?? ?????????????? ???? ??????? ??? ????? ???
???????, ??? ?? ?????????? ??? ?????????? ??? ?? ?????? ??? ???????
????? ???? (default deny). ?? ??? ????? ???? ???????? ?? ????? ??? ??
?????? ??? ??? ????????? ?? ?????? ?????? ??? ???.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.7. ????????? ??? IPMON
~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? syslogd ???????????? ?? ???? ??? ?????? ?????? ??? ?? ?????????? ???
????????? ??????????. ???????? ??????? ????????????? ??? ???????????
?facility? ??? ?level?. ???? ?? IPMON ??????????????? ?? ??? ???????
``-Ds``, ???????????? ??? ?????????? ?? ``local0`` ?? ????? ?facility?.
?? ?? ??????????, ???????? ?? ??????????????? ?? ???????? ??????? ???
????????? ?????????? ??? ????????? ??????????:

.. code:: screen

    LOG_INFO - packets logged using the "log" keyword as the action rather than pass or block.
    LOG_NOTICE - packets logged which are also passed
    LOG_WARNING - packets logged which are also blocked
    LOG_ERR - packets which have been logged and which can be considered short

??? ?? ????????? ?? IPFILTER ?? ?????????? ??? ?? ???????? ???
``/var/log/ipfilter.log``, ?? ????????? ?? ????????????? ??? ???? ??
??????. ???? ?????? ?? ????? ?? ??? ???????? ??????:

.. code:: screen

    # touch /var/log/ipfilter.log

? ?????????? ???
`syslogd(8) <http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&sektion=8>`__
?????? ?? ????????? ?? ???????????? ??? ?????? ``/etc/syslog.conf``. ??
?????? ``syslog.conf`` ????????? ????????? ???????? ???? ????? ?? ???
????? ?? syslog ????????????? ?? ???????? ?????????? ??? ??????????? ???
????????? ???? ?? IPF.

????????? ??? ???????? ?????????? ??? ?????? ``/etc/syslog.conf``:

.. code:: programlisting

    local0.* /var/log/ipfilter.log

?? ``local0.*`` ???????? ??? ?? ??????? ????????? ???? ??? ?????????
????? ??? ????? ???? ????????? ??? ???? ???????.

??? ?? ?????????????? ??? ??????? ??? ``/etc/syslog.conf`` ?? ?????? ??
?????????????? ?? ???????? ? ?? ?????????? ??
`syslogd(8) <http://www.FreeBSD.org/cgi/man.cgi?query=syslogd&sektion=8>`__
?? ???????????? ?? ``/etc/syslog.conf``, ?????????? ??? ??????
``/etc/rc.d/syslogd reload``

??? ???????? ?? ????????????? ?? ``/etc/newsyslog.conf`` ???? ??
?????????? ?? ?????? ?????????? ??? ????????????? ????????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.8. ? ????? ??? ????????? ??????????
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ???????? ??? ?????????? ??? ??? ``ipmon`` ???????????? ??? ?????
????????? ??? ?????????? ??? ????? ????????. ?? ????? ??? ????? ????? ??
??? ?? ????????, ????? ?? ????????:

.. raw:: html

   <div class="orderedlist">

#. ? ?????????? ????????? ??? ???????

#. ? ??? ????????? ??? ???????. ???? ??? ????? HH:MM:SS.F, ? ?????
   ?????????? ????, ?????, ???????????? ??? ???????? ????????????? (??
   ????? ?????? ?? ????? ????? ???????? ?????).

#. ?? ????? ??? ???????? ???? ????? ????? ? ??????????? ??? ??????? ?.?.
   ``dc0``.

#. ? ??????? ?????? ??? ? ????? ??????? ??? ??????, ?.?. ``@0:17``.

.. raw:: html

   </div>

???????? ?? ????? ?? ???????? ?? ??? ?????? ``ipfstat -in``:

.. raw:: html

   <div class="orderedlist">

#. ?? ????? ??? ?????????: p ?? ?? ?????? ??????, b ?? ?? ??????
   ???????????, S ??? ??????? ??????, n ?? ??? ???????? ?? ??????
   ??????, L ??? ?????? ?? ?????????. ? ????? ?????????????? ????
   ?????????? ??? ????????, ????? S, p, b, n, L. ?? ???????? P ? ?? B
   ????????? ??? ? ????????? ??? ??????? ????? ???? ??????? ???????
   ???????? ?????????? ??? ??? ???????? ??????? ??????.

#. ?? ???????????. ????????? ???? ?????????????? ??? ???? ?????: ??
   ????????? ??? ?? ???? ????????? (?????????? ?? ?????), ?? ??????? ->
   ??? ??? ????????? ??? ???? ??????????, ?.?.
   ``209.53.17.22,80 -> 198.73.220.17,1722``.

#. ?? ``PR`` ????????????? ??? ?? ????? ? ??? ?????? ??? ???????????,
   ?.?. ``PR tcp``.

#. ?? ``len`` ????????????? ??? ?? ????? ??? ???????????? ??? ??
   ???????? ????? ??? ???????, ?.?. ``len 20 40``.

.. raw:: html

   </div>

?? ????????? ??? ?????? TCP, ?? ??????? ??? ???????? ????? ?? ????? ??
???????? ?? ??? ????? ??? ?? ???????????? ??? ???????? ?? ?????
???????????? ???? ???????? (flags) ??? ????? ?????. ????? ?? ??????
manual
`ipf(5) <http://www.FreeBSD.org/cgi/man.cgi?query=ipf&sektion=5>`__ ???
?? ????? ??? ????????? ??? ??? ??????????? flags.

?? ????????? ??? ?????? ICMP, ?? ???????? ??? ????? ??? ?????, ?? ?????
?? ????? ????? ?ICMP? ??? ?? ??????? ?? ????? ? ????? ??? ????????? ???
??? ???-????????? ICMP, ????????? ?? ??? ??????, ?.?. ICMP 3/3 ??? ???
?????? ?? ??????????? ????? (port unreachable).

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.9. ?????????? Script ??????? ?? ????????? ????????????
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

????????? ???????? ??????? ??? IPF ??????????? ??? ?????? ??????? ??
????? ?????? ?? ?????????? ?? script ?? ?????????? ??????????
?????????????. ?? ?????? ?????? ??? ????????, ????? ??? ?????????? ??
???????? ???? ??? ???? ??? ?????????? ?? ?? ????????? ????? ??? ???? ??
script ??????????, ? ???? ?? ????????????? ?? ????? ???? ??????? ???
????????? ?? ????? ????. ????? ????????? ??? script, ???????? ??
??????????????? ????????? ???????????? ??? ?? ?????????????? ?????
????????????????? ????? ??? ?? ??? ???????????? ?? ?????????? ???????.
???? ???????? ??? ??? ?????????? ??? ?????????.

? ??????? ??? script ??? ??????????????? ???, ????? ??????? ?? ?? ??????
`sh(1) <http://www.FreeBSD.org/cgi/man.cgi?query=sh&sektion=1>`__,
`csh(1) <http://www.FreeBSD.org/cgi/man.cgi?query=csh&sektion=1>`__, ???
`tcsh(1) <http://www.FreeBSD.org/cgi/man.cgi?query=tcsh&sektion=1>`__.

?? ????? ??? ????? ??????? ????????? ???????????? ??????????????? ?? ??
???? ??? ????????: ``$``.

?? ????????? ????? ??? ????? ??? ??????????? ?? ?? $.

? ???? ??? ?? ?????????????? ??? ????????? ?????, ?? ?????? ??
??????????? ?? ????? ?????????? (``"``).

????????? ?? ?????? ??? ??????? ??? ?? ???? ?????????? ?? ?? ????????:

.. code:: programlisting

    ############# Start of IPF rules script ########################

    oif="dc0"            # name of the outbound interface
    odns="192.0.2.11"    # ISP's DNS server IP address
    myip="192.0.2.7"     # my static IP address from ISP
    ks="keep state"
    fks="flags S keep state"

    # You can choose between building /etc/ipf.rules file
    # from this script or running this script "as is".
    #
    # Uncomment only one line and comment out another.
    #
    # 1) This can be used for building /etc/ipf.rules:
    #cat > /etc/ipf.rules << EOF
    #
    # 2) This can be used to run script "as is":
    /sbin/ipf -Fa -f - << EOF

    # Allow out access to my ISP's Domain name server.
    pass out quick on $oif proto tcp from any to $odns port = 53 $fks
    pass out quick on $oif proto udp from any to $odns port = 53 $ks

    # Allow out non-secure standard www function
    pass out quick on $oif proto tcp from $myip to any port = 80 $fks

    # Allow out secure www function https over TLS SSL
    pass out quick on $oif proto tcp from $myip to any port = 443 $fks
    EOF
    ################## End of IPF rules script ########################

???? ????? ???. ??? ???????? ?????????? ??? ????? ?????????? ?? ???????,
???? ? ?????? ?? ??? ????? ??????????? ??? ???????? ????? ?? ?????
?????????????. ?? ?? ???????? ?????????? ?????????? ?? ??? ?????? ?? ??
????? ``/etc/ipf.rules.script``, ?? ?????????? ?? ?????????????? ??????
???? ??????? ?? ??? ???????? ??????:

.. code:: screen

    # sh /etc/ipf.rules.script

??????? ??? ???????? ???? ???????????????? ?????? ??????? ??
?????????????? ????????????: ?? IPF ??? ???????????? ?? ?????????
????????????, ??? ??? ?????? ?? ???????? ???? ?? scripts ?????.

??? ?????? script ?????? ?? ?????????????? ?? ??? ??? ???? ??? ????????
???????:

.. raw:: html

   <div class="itemizedlist">

-  ????????? ?? ?????? ??? ?? ?????? ??? ???????? ?? ``cat``, ???
   ?????????? ?? ?????? ?? ?????? ??? ???????? ?? ``/sbin/ipf``.
   ??????????? ?? ``ipfilter_enable="YES"`` ??? ?????? ``/etc/rc.conf``
   ???? ???????, ??? ????????? ?? script ??? ???? ???? ??? ???? ??????
   ??? ?? ????????????? ? ?? ??????????? ?? ``/etc/ipf.rules``.

-  ??????????????? ?? IPFILTER ??? scripts ????????? ??? ??????????,
   ???????????? ??? ?????????? ``ipfilter_enable="NO"`` (????????? ???
   ??? ????????????? ????) ??? ?????? ``/etc/rc.conf``.

   ????????? ??? script ???? ?? ???????? ???? ???????? ?????????
   ``/usr/local/etc/rc.d/``. ?? script ?? ?????? ?? ???? ??? ????????
   ?????, ???? ``ipf.loadrules.sh``. ? ???????? ``.sh`` ?????
   ???????????.

   .. code:: programlisting

       #!/bin/sh
       sh /etc/ipf.rules.script

   ?? ?????? ?? ???? ?? ??????, ?? ?????? ?? ?????????? ????????,
   ??????? ??? ???????? ??? ??? ?????? ``root``.

   .. code:: screen

       # chmod 700 /usr/local/etc/rc.d/ipf.loadrules.sh

.. raw:: html

   </div>

?? ??????? ??? IPF ?? ??????????? ????? ???? ??? ???????? ??? ??????????
???.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.10. ?? ?????? ??????? ??? IPF
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ??????? ???????? ??? IPF, ???????? ??? ????? ??????? ??? ????? ??????
??? ?? ?????????? ? ?? ??????????? ?????? ??????? ?? ??? ????? ???
??????????? ?? ????. ? ?????? ??????????? ????????? ??????? ??????
??????????? ???????? ??? ????????. ?? ?????? ??????? ??? firewall
????????????? ???? ?? ?????? ??? ???????? ??? ?? Internet, ??? ??? ??
?????? ??? ?????????? ??? ?? ??????? ?? ???????? ?? ????. ???? ????????
TCP/IP (?.?. telnet, www, mail, ?.?.?.) ??????????? ??? ?? ??????????
??? ??? ?????????? (privileged) ???? ??? ???????????? ??? ?? ???????
???????? ????????????. ?? ?????? ??? ???????????? ??? ??? ????????????
????????, ???????? ??? ?? ????????? ????????? ??????????????? ???
??-?????????? ???? ??? ?????????? ??? ???????????? ???? ????????? ????
?????????. ???? ?? ???????? ?????????? (????? ??? ???????????) ???????
?? ??????????????? ?? ???????? ???????? ??? ??? ?????????? ??????? ???
?????????? ? ?????????? ??? ???????? ?? ?????????.

?? IPF ???????? ?????? ??????????????? ??? ?????? ???????????? ???????
??? ????? ?? ?????????? ??????? ??? ?????????, ????? ? ???????? ???
?????????????? ???? ??????? stateless. ?? ??? ?????? ??? ??????, ?? IPF
?????????? ?? ??? ??????? ?quick? ??? ?? ?????????? ???????????
?????????? ???? ??? ???????? ?keep state?. ?? ??? ????? ????,
??????????????? ????????? ? ?????? ???????????? ??? ???????.

?? ??????? ??? ??????????? ?? ???? ??? ??????? ?????????? ??? ?????
??????? ??? ????????? ??? ??????? ?quick? ??? ??? ??????? ?keep state?
??? ?? ????????? ??? ??????????. ????? ????? ??? ?? ??????? ???????????
??? ??? ???????????? ??? ??????? ??????? ???? inclusive firewall.

.. raw:: html

   <div class="warning" xmlns="">

?????????????:
~~~~~~~~~~~~~~

???? ????????? ?? ???? ??????? ??? firewall, ?? ?????? ?? ????? *????
???????????*. ?? ?????? ??????????? ?????????, ?????? ?? *???????????
???* ??? ??? ??????????? ???. ??? ?? ????? ????????, ????? ???????????
?? ?????? ??? ??????? ??? ????????? ??? ??? ?????? ???????, ???? ????
?????????????? ???????? (?.?. ???? ssh).

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11. ?????????? ???????
~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ?????????? ??? ??????? ??? ????????????? ???, ???? ??????????? ????
?? ??????????? ?? ???????? stateful ????????? ??? ?? ?????? ??? ????? ??
?????? ??????? ??? ????????? ????? ??? ? ????????. ??? ??? ????????? ???
?????????? ?????? ???????????, ???????? ?? ?????? manual ???
`ipf(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ipf&sektion=8>`__.

? ?????????? ``#`` ??????????????? ??? ?? ?????????? ??? ???? ????
???????, ??? ?????? ?? ??????????? ??? ????? ???? ??????? ?????? ? ???
???? ??? ??????. ?? ????? ??????? ??????????.

?? ??????? ????????? ??????-???????. ?? ?????? ????? ?? ?????? ??
?????????????? ?? ???????????? ????? ??? ?? ???????? ???? ?? ????? ???
???????. ?? ??????-??????? ????????? ???????? ?? ?????? ????????.
??????? ?????? ????? ???-???????? ?? ?????? ?????? ?? ????? ??????
??????-??????? ??? ?? ????????????? ?????? ???????????? ???-????????.
???? ??? ??? ??? ???????????? ??? ?????????? ??? ???????? ???????? ????
??? ???????? ?? ?????? ???????? ? ????? ???????? ?? ??????????? ???.

*``ACTION IN-OUT OPTIONS SELECTION STATEFUL PROTO       SRC_ADDR,DST_ADDR OBJECT PORT_NUM TCP_FLAG       STATEFUL``*

*``ACTION``* = block \| pass

*``IN-OUT``* = in \| out

*``OPTIONS``* = log \| quick \| on interface-name

*``SELECTION``* = proto value \| source/destination IP \| port = number
\| flags flag-value

*``PROTO``* = tcp/udp \| udp \| tcp \| icmp

*``SRC_ADD,DST_ADDR``* = all \| from object to object

*``OBJECT``* = IP address \| any

*``PORT_NUM``* = port number

*``TCP_FLAG``* = S

*``STATEFUL``* = keep state

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.1. ACTION
^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

? ???????? (action) ??????? ?? ?????? ?? ????? ?? ?? ?????? ?? ?????????
?? ??? ?????? ??? ???????. ???? ??????? *??????* ?? ???????? ???
????????. ?? ????????? ??? ??????????????, ????????? ????????:

?? ``block`` ??????? ??? ?? ?????? ?? ?????? ?? ?????????? ?? ?????????
?? ??? ??????????? ???????? ??? ??????.

?? ``pass`` ??????? ??? ?? ?????? ?? ?????? ?? ??????? ??? ?? firewall,
?? ????????? ?? ??? ??????????? ???????? ??? ??????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.2. IN-OUT
^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

???? ??????? ??? ??????? ?????? ??????????? ?? ???????????? ?? ????????
?? ?????????? ???? ?????? ? ??? ????? ???????. ? ??????? ????-??????
?????? ?? ????? ``in`` ? ``out`` ??? ?? ??? ???????, ? ??????? ??
???????? ???? ?? ?????????? ??????.

?? ``in`` ???????? ??? ? ??????? ?? ?????????? ?? ??? ??????????? ??????
?? ????? ????? ??????? ??? ??????? ??? ????????? ?? ?? ?????????.

?? ``out`` ???????? ??? ? ??????? ?? ?????????? ?? ??? ?????? ???
??????????? ??? ????? ???? ??? ???????? ??? ????????? ?? ?? ?????????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.3. OPTIONS
^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="note" xmlns="">

????????:
~~~~~~~~~

?? ???????? ???????? ?????? ?? ??????????????? ?? ?? ????? ??? ?????????
???.

.. raw:: html

   </div>

?? ``log`` ??????? ??? ? ??????????? ??? ??????? ?? ?????? ??? ??????
?????????? ??? ``ipl`` (???? ???????????? ???? ??????? LOGGING ???
?????????) ?? ?? ?????????? ??? ???????? ?????????? ?? ?? ??????.

To ``quick`` ??????? ??? ?? ?? ?????????? ??? ???????? ?????????? ?? ??
??????, ? ????????????? ??????? ?? ????? ??? ? ?????????? ??????? ??? ??
????????. ? ??????? ???? ????? ??????????? ??? ?? ???????? ??????
???????????? ???????.

?? ``on`` ??????? ?? ????? ??? ???????? ??? ?? ??????????? ????
??????????? ????????. ?? ??????? ??? ???????? ????????? ???? ??????????
? ??????
`ifconfig(8) <http://www.FreeBSD.org/cgi/man.cgi?query=ifconfig&sektion=8>`__.
??????????????? ??? ??????? ????, ? ??????? ?? ???????? ???? ?? ??
?????? ????????? ???? ??? ????????????? ???????? ??? ???? ??
???????????? ?????????? (???????????/??????????). ? ??????? ???? ?????
??????????? ??? ??? ???????? ?????? ???????????? ??? ???????.

???? ??????? ????????? ???? ???????, ?? ???????????? ????????? ????
?????-??????? ?????????? ??????? IPL. ???? ??? ?????? ``log``, ???????
?? ??????????????? ?? ???????? ?????????? (?? ?? ????? ??? ?????????):

?? ``body`` ??????? ??? ?? ????? ????????? ??? ?????? 128 bytes ???
???????????? ??? ???????, ??? ?????????? ?????? ???? ??? ???????????.

? ??????? ``first`` ?????????? ?? ?????????????? ?? ? ??????? ``log``
??????????????? ?? ????????? ?? ??? ``keep state``. ?? ??? ????? ????
??????? ????????? ???? ??? ?????? ??????? (?? ?? ????? ???????? ?
???????????), ??? ??? ???? ??? ????????? ?? ????? ?????????? ?? ???
?????????? ?keep state?.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.4. SELECTION
^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ?????? ??????? ??? ????????????? ?? ???? ??? ???????,
???????????????? ??? ?? ??????????? ????? ????????? ??? ??????? ??
???????????? ??? ?? ?????????? ?? ????????? ? ??? ?? ???? ???????. ???
????-?????? ?????? ?? ???????? ???? ??? ???????????? ??? ????? ??????
??? ??????? ??? ???????? ????????. ?????? ??????? ?? ?????????? ??? ???
????? ??? ??????. ?????????? ?? ???????? ????????? ??????? ?????? ??
?????? ?????? ?? ??????????????? ?? ???? ?? ?????:

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.5. PROTO
^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ``proto`` ????? ? ?????? ????, ??? ?????? ?? ???????? ???? ?? ??????
?????????? ???? ??? ????????? ???????. ? ???? ????????? ?? ????????? ??
??? ???????????? ??????????. ????? ??????????? ?? ?????????????? ??? ??
?????????? ? ???????? ?????? ???????????? ??? ???????.

?? ??????? ??????????? ??? ?????????????? ??? ??????? ??
???????????????, ????? ?? ``tcp/udp | udp | tcp | icmp`` ? ???????????
???? ???????????? ??? ``/etc/protocols``. ???????? ?? ??????????????? ??
?????? ????? ``tcp/udp`` ?? ????? ????????? ???? ?? ?????? TCP ???? ??
UDP. ? ?????? ???? ???????? ?????????? ???? ?? ???????????? ??????, ????
???? ?? ???? ??????, ???????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.6. SRC\_ADDR/DST\_ADDR
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

? ???? ``all`` ????? ?????????? ???????? ?? ??? ????? ?from any to any?
????? ?? ???????? ????? ?????????? ??? ?? ?????????.

???? ??????????????? ?? ``from src to dst``, ?? ?????? ``from`` ???
``to`` ???????? ??????????? IP ??? ?? ??????????????? ??? ?? ?????????.
?? ??????? ?????? ?? ?????????? ??? ??????????? ???? ??? ????????? ???
??? ??? ??????????. ? ???? ``any`` ???? ??? ?????? ???????? ?? ?????????
?? ??????????? ????????? IP. ???????????? ??????: ``from any to any`` ?
``from 0.0.0.0/0 to any`` ? ``from any to 0.0.0.0/0`` ?
``from 0.0.0.0 to any`` ? ``from any to 0.0.0.0``.

??? ??????? ?????? ?? ??????????? ???????? IP ??????????? ??? ???
??????? ?? ?????????? ?????? ?? ?? ????? ??????? ?????????? ?? ??????? /
?????? ??????????. ???????? ?? ??????????????? ?? ????????? ?????????
`net-mgmt/ipcalc <http://www.freebsd.org/cgi/url.cgi?ports/net-mgmt/ipcalc/pkg-descr>`__
??? ??????????? ??? ????? ????????????. ????? ??? ???????? ????????? ???
???????????? ??? ???????????? ???????????: ``http://jodies.de/ipcalc``.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.7. PORT
^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ????????? ?? ?????? ???????????? ???? ????????? ?/??? ?????????? (??
???????) ??????????? ???? ?? ?????? TCP ??? UDP. ???? ??? ??????????
?????????? ?? ?????, ???????? ???? ?? ??????????????? ??? ?????? ???
?????, ???? ?? ????? ??? ??????????? ????????? ??? ?? ??????
``/etc/services``. ???? ? ???? ??????????? ?? ????? ??? ????????????
``from``, ?? ????????? ?? ????? ?? ??? ???? ??? ?????????. ????
??????????? ?? ????? ??? ???????????? ``to``, ?? ????????? ?? ????? ??
?? ???? ??????????. ??? ?? ?????????? ? ???????? ?????? ????????????
???????, ?? ?????? ?????????? ?? ??????? ? ??????? ????? ??? ???????????
``to``. ?????????? ??????: ``from any to any port = 80``

?? ?????????? ??? ??????????? ?? ??? ???? ????, ??????? ?? ?????? ??
??????? ????????????? ???????, ??????????????? ????????????? ????????
?????????. ????? ?????? ??????? ?? ??????????? ????????? ???????? ???
?????.

port "=" \| "!=" \| "<" \| ">" \| "<=" \| ">=" \| "eq" \| "ne" \| "lt"
\| "gt" \| "le" \| "ge".

??? ?? ?????????? ???????? ?????, ?????????????? port "<>" \| "><"

.. raw:: html

   <div class="warning" xmlns="">

?????????????:
~~~~~~~~~~~~~~

???? ??? ??????????? ??? ?? ????????? ??? ????????? ??? ??? ??????????,
?? ???????? ??? ?????????? ????? ???????????? ??? ?? ?????????? ?
???????? ?????? ???????????? ??? ???????.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.8. TCP\_FLAG
^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? flags ????? ?????? ???? ??? ??????????? ??? ??????????? TCP. ?? ????
?????? ?????????????? ??? ?????? flag ?? ??? ?? ????? ??????? ?????????
???? ??????????? ??? ??????? TCP.

? ???????? ?????? ???????????? ??? ???????, ???????????? ??? ?????????
``flags S`` ??? ??? ?????????? ??? ??????? ??? ????????? tcp.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.11.9. STATEFUL
^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ??? ?????? ??? ????????? (pass) ?? ??????? ??? ???????, ? ???????
``keep state`` ??????? ??? ?? ?????? ?? ?????????????? ? ??????????
stateful filtering ???? ?? ?????? ????????? ?? ?? ???????? ????????.

.. raw:: html

   <div class="note" xmlns="">

????????:
~~~~~~~~~

? ??????? ???? ????? ??????????? ??? ?? ?????????? ??? ????????? ???????
???????????? ???????.

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.12. ??????????? ?? ????????? ??? ?????????? (stateful)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? stateful ???????????, ????????????? ??? ?????? ??? ??????? ?? ????
?????? ??????????? ????????? ??????? ?? ????? ??????????? ??? ????????.
???? ?????????????, ? ????????? ??? ?????????? (keep-state) ??????????
???????? ??????????? ??????? ??? ???? ?????? ?? ????? ????????????? ????
?? ???????? ????? ??? ?????????. ???? ?????? ?? ?????????? ??
??????????? ?? ????????????? ?? ??????? ??????? ?????????? ?????????
?????? ??? ????????? ??? ??? ?????????. ??????????? ?????? ???
?????????? ?? ?? ??????? ????? ??? ????????????, ????????????? ??
???????.

? ????????? ??? ?????????? ????????? ?????? ?? ???????? ?? ?????? ICMP
??? ??????????? ?? ??? ???????? TCP ? UDP. ????, ?? ??????? ?????? ICMP
????? 3 code 4 ?? ???????? ???? ?? ???????? ??? ????????? ??? ?? ???
??????????, (? ????? ??????????? ??? ??? ?????????? ?????? ???????????),
?? ???? ????????? ? ???????. ??????????? ?????? ??? ?? ????? ?? IPF
????? ??????? ??? ????????? ??? ????? ???? ??????? ?????????, ?? ???????
????? ??? ?? ????? ??????????? ??????????.

???? ??? ????????? ????? ?? ????????:

?? ?????? ??? ???????????? ?? ???????? ???? ??? ???????? ??? ?????????
??? Internet, ?????????? ?????? ??????? ?? ?? ???????? ??????
???????????. ?? ?? ?????? ????????? ?? ?? ??????? ??? ?????????? ?? ???
?????? ????????, ????????? ??? ?? firewall ??? ?????????? ???????????? ?
????????? ??? ????????????? ????????? ???? ???????? ???????? ??????. ??
???????? ?????? (??? ??? ?????????? ?? ?????? ???????? ?? ???????)
?????????? ??????? ?? ?? ?????? ??????? ??? ?? ?????????? ??????.

?? ?????? ??? ???????? ??? ?? ??????? ??? ????? ????????? ?? ??
Internet, ?????????? ?????? ???? ??? ????????? ?????? ???????????. ?? ??
?????? ????????? ?? ?? ??????? ??? ?????????? ?? ??? ?????? ????????,
????????? ??? ?? firewall ??? ?????????? ???????????? ? ????????? ???
????????????? ????????? ???? ???????? ??????. ?? ???????? ?????? (???
??? ?????????? ?? ?????? ???????? ?? ???????) ?????????? ??????? ?? ??
?????? ??????? ??? ?? ??????????? ??????.

???? ? ??????????? ???????????, ??????????? ??? ??? ???????? ??????
???????????.

?? stateful ??????????? ????????? ?? ?????????? ??? ??????? ??? ????
??????? ? ???????? ??? ???? ?????????. ?? ????????? ??? ??? ????????,
??? ?? ???????? ?????? ??? ?? ???????????? ????????, ??? ????? ???????
?????? ?? ????????????? ?????? ????????. ?? stateful ???????????
???????? ??? ????? ??? ???????????? ?????????? ??????????? ??? ???????,
?? ?????????? ?? ???????? ?? ?????? ???????????? ???????? ???
????????????? ?? ????????????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.13. ?????????? ??????? ??????? ??? ??? Inclusive Firewall
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ???????? ?????? ??????? ??????? ?? ?????????? ??? ?? ???????? ???
????????? ??????? inclusive firewall. ??? inclusive firewall ?????????
?? ??????? ???? ??? ????????? ??? ?????????? ?? ???? ??????? ??? ????
??? ??????? ???????, ??? ?????????? ??? ?? ????????. ?? firewalls ???
???????????? ???? ?????????? (?? ????? ????????? ??? ?network
firewalls?) ?? ?????? ?? ????????? ??????????? ??? ????????. ? ???
??????? ????????? ?? ?? ?????? ?????? (LAN) ?? ????? ????????? ???????,
??? ? ???? ?? ?? ??????? Internet. ???????????, ??? firewall ?????? ??
??????????? ???? ?? ??????? ??? ????? ??????????-???? ???????? ?host
based firewall? ??? ????? ????????? ????????? ??? ???????????? ???
??????????? ?? ?? ??????? ??????.

??? ?? ????????? ????? UNIX(R), ??????????????????? ??? ??? FreeBSD,
????? ?????????? ?? ????????????? ??? ??????? ``lo0`` ??? ??? IP
????????? ``127.0.0.1`` ??? ????????? ??????????? ???? ??? ???? ??
??????????? ???????. ?? firewall ?????? ?? ???????? ??????? ??? ??
?????????? ??? ???????? ??? ????? ???????????? ?????? ??? ??????? ?????
?????????? ???????.

?? ??????? ??? ????????????? ??? ???????? ???? ?? Internet, ?????????
???? ??????? ??? ??????? ??? ????????? ?? ????. ?? ??????? ?????
???????? ???? ??? ??????????? ??? ??? ??? ?????????? ?????? ???
Internet. ? ??????? ???? ?????? ?? ????? ? ``tun0`` ??? ???????????????
??? PPP ??????, ? ????? ??? ? ????? ??????? ??? ????????? ?? ??? DSL
router ? modem.

?? ????????? ??? ??? ? ???????????? ?????? ??????? ?????????? ??
????????? ???????? ?????? ???? ??? ?? firewall, ?? ?????? ?? ???????? ??
??????????? ??????? ??? ?? ?????????? ??? ???????? ????????? ??? ???????
??????? ???? ???????? ????? ?/??? ??? Internet.

?? ??????? ?????? ?? ???????????? ?? ????? ?????? ????????: ?????? ????
?? ???????? ???? ?????? ??????????? ? ???????? ????????? ?????????,
?????? ? ??????? ??? ??? ????? ?????????? ?? ?????? ???? ?? ???????
?????? (Internet) ??? ????? ? ??????? ??? ??? ????? ??????????? ??????
??? ?? Internet.

?? ???? ??? ??? ??? ???????? ??? ???????? ??? ?????????? ??? Internet,
?????? ?? ????????????? ?????? ?? ??????? ??? ?????????? ????????? ??
??? ?????????? ??????. ? ?????????? ??????? ??? ???????? ?? ?????? ??
?????????? ??? ?? ?????????? ??? ?? ?????? ??? ?????????????
????????/???????????.

? ??????? ??? ??????????? (Outbound) ??? ???????? ?????? ???????,
???????? ???? ??????? ????? ``pass`` ?? ?????? ?????????? (????
?????????? ????? ???? ??????????? ????) ?? ????????????? ????????? ??
?????????? ???????? ??? Internet. ???? ?? ??????? ????????? ??? ????????
``quick``, ``on``, ``proto``, ``port`` ??? ``keep state``. ?? ???????
``proto tcp`` ????????????? ??? ??????? ``flag`` ???? ?? ????????????
??? ?????? ??????? ??? ????????? ??? ?? ???????????? ?? ??????????
?????????? ??? ?????????? (stateful).

???? ??????? ??? ???????????? ??????? (Inbound) ??? ???????? ????????,
?????? ???????????? ?? ??????? ??? ???????????????? ??? ??? ???????? ???
???????????? ???????. ???? ??????? ??? ??? ????????????? ??????. ?
?????? ????? ??? ?? ????????? ?????? ?????? ?? ????? ?? ?????????? ??
?????? ?????????????? ??? ??????? ???????. ?? ?????? ???? ?? ?????? ??
???????????, ???? ?? ?????? ????? ??? ?????? ??????? ?????? ``allow``. ?
???????? ????? ??? ???????? ?? ?????????? ???????????? ?????? ?? ?????
????????? ??? ??? ????? ??????, ???? ??? ????? ???????? ? ?????????
????. ?? ??? ????? ???? ??????????? ? ???? ??? ????????? ???? ??? ???
????????? ??????. ? ?????????? ??????? ?????? ?????????? ??? ??????????
??? ?? ?????? ??? ??????? ????? ?????. ? ??????? ????? ???????????????
??? ??? ?????? ??????? ?????????? ?? ????????? ??? ???????? ?????????
?????????? ???? ?????? ??? ????????? ?? ????????? ??? ??????? ???.

?? ?????? ?????? ?? ???????????? ??? ?? ??????? ??? ??? ?? ????? ?????
???????? ?? ?????? ??? ?? ??????????? ??????. ?? ?????? ???? ?? ??????
?? ??????????? ??? ?? ????????????. ?? ??? ????? ????, ? ????????????
??? ???? ????? ????? ?? ?? ?????? ??? ??????? ????? ?? ??????? ???. ???
???????? ??????? ?? ?????? ?? ???????????? ??????? ?? ?? ??????? ???,
???? ??????????? ????? ?? ????????? ?? ?????????? ??? ?? ?????????? ??
??? ??????? ??? ???????. ?? ??????? ?? ??? ??????? ``log first``
??????????? ?? ?????? ???? ??? ????? ???? ??? ???????????????. ? ???????
???? ?????????????? ???? ?????? ``nmap OS fingerprint`` ??? ??????????
??? ???????? ????????. ?? ????????? ?????????
`security/nmap <http://www.freebsd.org/cgi/url.cgi?ports/security/nmap/pkg-descr>`__
??????????????? ????? ??? ????????? ?????, ??? ?????????? ?? ???? ???
????? ?? ???????????? ?? ??????????? ??????? ??? ??????????? ???.

???? ???? ??? ??????? ????????? ??? ?????? ?????? ?? ??? ???????
``log first``, ?? ?????? ?? ?????????? ??? ?????? ``ipfstat -hio`` ???
?? ????? ????? ????? ???? ????????????? ????? ? ??????? ????????. ????
?? ?????? ?? ?.?. ??? ?????? ??????? ???????????? (flood).

????? ?? ?????? ``/etc/services`` ??? ?? ?????? ???????? ????? ??? ???
????????????. ???????? ?????? ?? ???????????? ??? ?????????
``http://www.securitystats.com/tools/portsearch.php`` ??? ?? ??????
????????? ??? ?? ???????????? ????, ???? ?? ????? ???? ????????
??????????.

????? ??? ??????? ????????? ??? ??? ????? ??? ???????????????? ???????
??? ????????? ??????????? (trojans):
``http://www.simovits.com/trojans/trojans.html``.

?? ???????? ?????? ??????? ????? ?????? ?????? ??? ???? ???????.
?????????? firewall ????? ``inclusive``, ??? ???? ?????????? ??
??????????? ???????? ???????????. ?????? ?? ???????????? ?? ???? ????
??? ?? ???? ??? ???????. ????? ?????????? ?? ?????? ???? ??????? ??? ???
????????? ??? ??? ?????? ?? ??????????????.

??? ?? ????????? ??? ????????? ???????????? ?????????, ????? ?????????
??? ?????????? ?????? ????????? (``block``) ???? ??????? ???
???????????? (inbound).

?? ?????? ?? ???????? ?? ????? ??? ???????? ``dc0`` ??? ?????????????,
?? ?? ?????????? ????? ??? ?????? ??????? ??? ??????? ?? ??????? ??? ??
?? Internet. ??? ????? ????????????? ?? PPP ??????, ?? ????? ?? ?????
``tun0``.

????????? ??? ????????? ???????????? ??? ?????? ``/etc/ipf.rules``:

.. code:: programlisting

    #################################################################
    # No restrictions on Inside LAN Interface for private network
    # Not needed unless you have LAN
    #################################################################

    #pass out quick on xl0 all
    #pass in quick on xl0 all

    #################################################################
    # No restrictions on Loopback Interface
    #################################################################
    pass in quick on lo0 all
    pass out quick on lo0 all

    #################################################################
    # Interface facing Public Internet (Outbound Section)
    # Match session start requests originating from behind the
    # firewall on the private network
    # or from this gateway server destined for the public Internet.
    #################################################################

    # Allow out access to my ISP's Domain name server.
    # xxx must be the IP address of your ISP's DNS.
    # Dup these lines if your ISP has more than one DNS server
    # Get the IP addresses from /etc/resolv.conf file
    pass out quick on dc0 proto tcp from any to xxx port = 53 flags S keep state
    pass out quick on dc0 proto udp from any to xxx port = 53 keep state

    # Allow out access to my ISP's DHCP server for cable or DSL networks.
    # This rule is not needed for 'user ppp' type connection to the
    # public Internet, so you can delete this whole group.
    # Use the following rule and check log for IP address.
    # Then put IP address in commented out rule & delete first rule
    pass out log quick on dc0 proto udp from any to any port = 67 keep state
    #pass out quick on dc0 proto udp from any to z.z.z.z port = 67 keep state


    # Allow out non-secure standard www function
    pass out quick on dc0 proto tcp from any to any port = 80 flags S keep state

    # Allow out secure www function https over TLS SSL
    pass out quick on dc0 proto tcp from any to any port = 443 flags S keep state

    # Allow out send & get email function
    pass out quick on dc0 proto tcp from any to any port = 110 flags S keep state
    pass out quick on dc0 proto tcp from any to any port = 25 flags S keep state

    # Allow out Time
    pass out quick on dc0 proto tcp from any to any port = 37 flags S keep state

    # Allow out nntp news
    pass out quick on dc0 proto tcp from any to any port = 119 flags S keep state

    # Allow out gateway & LAN users' non-secure FTP ( both passive & active modes)
    # This function uses the IPNAT built in FTP proxy function coded in
    # the nat rules file to make this single rule function correctly.
    # If you want to use the pkg_add command to install application packages
    # on your gateway system you need this rule.
    pass out quick on dc0 proto tcp from any to any port = 21 flags S keep state

    # Allow out ssh/sftp/scp (telnet/rlogin/FTP replacements)
    # This function is using SSH (secure shell)
    pass out quick on dc0 proto tcp from any to any port = 22 flags S keep state

    # Allow out insecure Telnet
    pass out quick on dc0 proto tcp from any to any port = 23 flags S keep state

    # Allow out FreeBSD CVSup function
    pass out quick on dc0 proto tcp from any to any port = 5999 flags S keep state

    # Allow out ping to public Internet
    pass out quick on dc0 proto icmp from any to any icmp-type 8 keep state

    # Allow out whois from LAN to public Internet
    pass out quick on dc0 proto tcp from any to any port = 43 flags S keep state

    # Block and log only the first occurrence of everything
    # else that's trying to get out.
    # This rule implements the default block
    block out log first quick on dc0 all

    #################################################################
    # Interface facing Public Internet (Inbound Section)
    # Match packets originating from the public Internet
    # destined for this gateway server or the private network.
    #################################################################

    # Block all inbound traffic from non-routable or reserved address spaces
    block in quick on dc0 from 192.168.0.0/16 to any    #RFC 1918 private IP
    block in quick on dc0 from 172.16.0.0/12 to any     #RFC 1918 private IP
    block in quick on dc0 from 10.0.0.0/8 to any        #RFC 1918 private IP
    block in quick on dc0 from 127.0.0.0/8 to any       #loopback
    block in quick on dc0 from 0.0.0.0/8 to any         #loopback
    block in quick on dc0 from 169.254.0.0/16 to any    #DHCP auto-config
    block in quick on dc0 from 192.0.2.0/24 to any      #reserved for docs
    block in quick on dc0 from 204.152.64.0/23 to any   #Sun cluster interconnect
    block in quick on dc0 from 224.0.0.0/3 to any       #Class D & E multicast

    ##### Block a bunch of different nasty things. ############
    # That I do not want to see in the log

    # Block frags
    block in quick on dc0 all with frags

    # Block short tcp packets
    block in quick on dc0 proto tcp all with short

    # block source routed packets
    block in quick on dc0 all with opt lsrr
    block in quick on dc0 all with opt ssrr

    # Block nmap OS fingerprint attempts
    # Log first occurrence of these so I can get their IP address
    block in log first quick on dc0 proto tcp from any to any flags FUP

    # Block anything with special options
    block in quick on dc0 all with ipopts

    # Block public pings
    block in quick on dc0 proto icmp all icmp-type 8

    # Block ident
    block in quick on dc0 proto tcp from any to any port = 113

    # Block all Netbios service. 137=name, 138=datagram, 139=session
    # Netbios is MS/Windows sharing services.
    # Block MS/Windows hosts2 name server requests 81
    block in log first quick on dc0 proto tcp/udp from any to any port = 137
    block in log first quick on dc0 proto tcp/udp from any to any port = 138
    block in log first quick on dc0 proto tcp/udp from any to any port = 139
    block in log first quick on dc0 proto tcp/udp from any to any port = 81

    # Allow traffic in from ISP's DHCP server. This rule must contain
    # the IP address of your ISP's DHCP server as it's the only
    # authorized source to send this packet type. Only necessary for
    # cable or DSL configurations. This rule is not needed for
    # 'user ppp' type connection to the public Internet.
    # This is the same IP address you captured and
    # used in the outbound section.
    pass in quick on dc0 proto udp from z.z.z.z to any port = 68 keep state

    # Allow in standard www function because I have apache server
    pass in quick on dc0 proto tcp from any to any port = 80 flags S keep state

    # Allow in non-secure Telnet session from public Internet
    # labeled non-secure because ID/PW passed over public Internet as clear text.
    # Delete this sample group if you do not have telnet server enabled.
    #pass in quick on dc0 proto tcp from any to any port = 23 flags S keep state

    # Allow in secure FTP, Telnet, and SCP from public Internet
    # This function is using SSH (secure shell)
    pass in quick on dc0 proto tcp from any to any port = 22 flags S keep state

    # Block and log only first occurrence of all remaining traffic
    # coming into the firewall. The logging of only the first
    # occurrence avoids filling up disk with Denial of Service logs.
    # This rule implements the default block.
    block in log first quick on dc0 all
    ################### End of rules file #####################################

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.14. NAT
~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? NAT ????? ????????? ??? ?????? *Network Address Translation* ?
????????? ??????????? ???????. ??? ????? ????? ????????????? ?? ??
Linux(R), ????????? ???? ???? ??? IP Masquerading. ???? ??????????????
?? NAT ??? ?? IP Masquerading ????? ?? ???? ??????. ??? ??? ??? ??????
??????????? ??? ??????? ? ?????????? NAT ??? IPF, ????? ??? ? ??????????
?? ?????? ??? ???????? ?????? ?????? (LAN) ???? ??? ?? firewall ?? ?????
?? ?????????? ??? ???????? ??????? ????????? IP ??? Internet.

???? ?? ???????????? ????? ?? ????? ??????? ?? ?? ????? ????. ?? ISPs
??????? ????????? ????????? ??????????? ?? ?? ?????????? ???????. ????
?????????? ???????? ??? ? ????????? IP ??? ?????????? ??? ???????? ???,
?????? ?? ????? ??????????? ???? ???? ??? ?????? ????? ??? ??
??????????. ??? ???? ??????? DSL modem ??? router, ? ?????? ??????????
???????????????? ???? ???? ??? ?????????????? ?? modem. ? ????????? IP
??? ??? ?????????? ??? ??? ISP ???, ????? ???? ?? ??? ????? ???????? ???
Internet.

?? ?????????? ???? ??? ????? ????? PC ??? ????? ???, ??? ?????????? ??
??? ??????? Internet. ????????, ?? ?????? ?? ????????? ??? ISP ???
??????? ?????????? ??? ???? PC ??? ?? ????????? ????? ??????? ?????????.

?? ?? NAT, ?????????? ???? ??? ?????????? ?? ??? ISP ???. ???????? ?????
?? ????????? ?? ??????? PC ?? ??? ???????? ? switch ??? ????? ??
????????? ?????? ??? ?? FreeBSD ???????? ???. ?? ???????? ???? ??
??????? ?? ???? ??? ??????? ??? ??????? ??? ?? Internet. ?? NAT ??
?????????? ???????? ??? ????????? ??????????? IP ??? ???? ???????????
???? ???????? ??????? IP ????????? ??? ?????, ????? ?? ?????? ?????? ???
?? firewall ??? ???????????? ???? ?? Internet. ??????? ?????? ??? ???
?????????? ????????? ??? ?? ?????? ??? ???????????.

??????? ??? ?????? ??????? ??????????? IP ??? ????? ??????????? ???
????? ?? ?????? ?????? ?? NAT. ??????? ?? ?? RFC 1918, ???????? ??
??????????????? ??? ???? ?? ????? ??? ???????? ????????, ?? ?????? ???
?????????????? ???? ????????? ??? ??????? Internet:

.. raw:: html

   <div class="informaltable">

+-----------------------------+-----+---------------------------------+
| ?????? IP ``10.0.0.0``      | -   | ?????? IP ``10.255.255.255``    |
+-----------------------------+-----+---------------------------------+
| ?????? IP ``172.16.0.0``    | -   | ?????? IP ``172.31.255.255``    |
+-----------------------------+-----+---------------------------------+
| ?????? IP ``192.168.0.0``   | -   | ?????? IP ``192.168.255.255``   |
+-----------------------------+-----+---------------------------------+

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.15. IPNAT
~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ??????? ??? NAT ??????????? ?? ?? ????? ??? ??????? ``ipnat``.
??????, ?? ??????? ??? NAT ????????????? ??? ??????
``/etc/ipnat.rules``. ????? ?? ?????? manual ???
`ipnat(1) <http://www.FreeBSD.org/cgi/man.cgi?query=ipnat&sektion=1>`__
??? ????????????.

??? ?? ???????? ???? ??????? ??? NAT ????? ???? ??????????, ????????????
?? ?????? ??? ???? ????????, ??? ????????? ??? ?????? ``ipnat`` ?? ???
????????? ``-CF`` ??? ?? ?????????? ???? ??????????? ??????? ??? NAT ???
?? ????????? ???? ??? ??????? ???????????? ??? ?????? ???????????.

??? ?? ????????? ???? ??????? ??? NAT ??? ??? ????, ????????? ??? ??????
???? ??? ????????:

.. code:: screen

    # ipnat -CF -f /etc/ipnat.rules

??? ?? ????? ?????? ?????????? ??????? ?? ?? NAT, ?????????????? ???
???????? ??????:

.. code:: screen

    # ipnat -s

??? ?? ????? ??? ????? ?? ??? ????????? ???????????? ??? ?????? NAT,
?????????????? ??? ???????? ??????:

.. code:: screen

    # ipnat -l

??? ?? ?????????????? ??? ????????? ?????????? ????????? ??? ?? ?????
??????????? ??? ??????????? ?? ??? ??????????? ??? ??????? ??? ????
???????? ??????? ??? ???????????? ???? ??????, ??????:

.. code:: screen

    # ipnat -v

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.16. ??????? ??? IPNAT
~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ??????? ??? NAT ????? ?????? ?????????, ??? ????????? ??????
??????????? ???? ?? ????????? ??? ??????? ??? ???????? ???? ??? ???
?????????????? ???????.

? ??????? ??? ??????? ??? ????????????? ???, ???? ??????????? ???? ??
?????????? ?? ?? ?????? ????? ?? ??-???????? ????????????. ??? ??? ?????
????????? ??? ????????, ????? ?? ?????? manual ???
`ipnat(5) <http://www.FreeBSD.org/cgi/man.cgi?query=ipnat&sektion=5>`__.

? ??????? ???? ?????? NAT ??????? ?? ??? ????????:

.. code:: programlisting

    map IF LAN_IP_RANGE -> PUBLIC_ADDRESS

? ??????? ???????? ?? ?? ???? ``map``.

?????????????? ?? *``IF``* ?? ??? ????????? ??????? (?? ????? ???????
??? ????????? ??? Internet).

? ?????????? *``LAN_IP_RANGE``* ????? ? ??????? ??????????? ???
??????????????? ??? ?? ????????? ??? ??????. ???? ?????????????? ??
??????? ?? ???? ??? ?? ``192.168.1.0/24``.

? ?????????? *``PUBLIC_ADDRESS``* ?????? ?? ????? ???? ? ????????? IP
?????????, ???? ? ?????? ???? ``0/32``, ? ????? ???????? ??? ??
?????????????? ? IP ????????? ??? ???? ???????? ??? *``IF``*.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.17. ??? ?????????? ?? NAT
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ?????? ?????? ??? firewall ??? ?? LAN ?? ????????? ?? Internet.
??????? ???????? ??? ??????? ?????????????? ???????????, ???? ??????? ?
??????????? ??? ??? ?? NAT. ?? ??????? ???????????? ??? ??? ????? ???
???? ?? ????, ??? ???????? ? ?????? ??? ?????????. ? ??????? ??????? ??
???? ?? ??????? ??? ??? ????? ??????? ?? ?????? ??? ?? ????????? IP ???
??? ????? ??????????. ???? ?? ????? ??? ???????? ???? ??????? ?????????
?? ?????? ?????? ??? NAT, ? ????????? IP ??? ????????? (??? ??????????
??? ?? ???????? ??????) ????????? ??? ?? ??????????? ?? ????????? ?? ???
??????? ??????????? ??? ??????????? ???? ???????? ?????? ??? ????????
(?????) ??? ?????? NAT. ?? ?????????, ? ????????? ??? ???????
????????????, ??????????????? ?? ??????? ????????? IP ? ????? ?????????
??? ?? ``0/32``. ?? NAT ?????????? ??? ?????????? ???? ????????? ???
??????, ???? ???? ???? ?????????? ? ???????? ??? ?? Internet, ?? ??????
?? ????????????? ???? ???? ?????? ???????? ????????? IP ??? ?? ???????
?????? ??? ???? ??????? ??? ??????? ??? ????????? ???????????.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.18. ?????????????? ?? IPNAT
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ?? ?????????????? ?? IPNAT, ????????? ??? ???????? ??????? ???
``/etc/rc.conf``.

??? ?? ?????????? ??? ???????? ??? ?? ?????????? ?????? ?????? ????????
???????:

.. code:: programlisting

    gateway_enable="YES"

??? ?? ???????? ???????? ?? IPNAT ?? ???? ????????:

.. code:: programlisting

    ipnat_enable="YES"

??? ?? ?????????? ??? ??? ?????????? ?? ??????????? ?? ??????? ???
IPNAT:

.. code:: programlisting

    ipnat_rules="/etc/ipnat.rules"

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.19. ?? NAT ?? ??? ?????? ?????? ??????
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ?????? ?????? ?? ?????? ?????? ???????????, ? ??? ?????? ???
??????????? ??????????? ??? ??? LAN, ? ?????????? ??? ?????????? ????
????? ??? ????????? ??????????? ?? ??? ???????? ??????? ?????????,
?????????? ???????? ????????? ?????, ????? ???????????????? ?????? ?????
?? ????? ??????? ?????, ????????? ?? PC ??? ??????? ?? ???????????.
???????? ??? ?????? ??? ?? ??????????? ???? ?? ????????.

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.19.1. ??????? ??? ????? ??? ?? ???????????????
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

??? ???????????? ??????? NAT ??????? ?? ??? ????????:

.. code:: programlisting

    map dc0 192.168.1.0/24 -> 0/32

???? ???????? ??????, ? ???? ????????? ??? ??????? ????????? ??????????
????? ?? ?????? ????????? ???? ??? IPNAT. ?? ?????????? ??? ????-??????
``portmap``, ???????? ?? ????????? ?? IPNAT ?? ???????????? ????? ???
??????? ?? ??? ??????????? ???????. ??? ??????????, ? ???????? ???????
?? ???????? ?? NAT ?? ???????????? ??? ???? ??? ?????????, ???? ?? ?????
???? ???? ??????? ??? ????????:

.. code:: programlisting

    map dc0 192.168.1.0/24 -> 0/32 portmap tcp/udp 20000:60000

???????? ?????? ?? ????????????? ????? ??????????? ?? ??????????
??????????????? ?? ???? ``auto`` ???? ?? IPNAT ?? ????????? ??? ???? ???
????? ????? ????? ?????????? ??? ?????:

.. code:: programlisting

    map dc0 192.168.1.0/24 -> 0/32 portmap tcp/udp auto

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.19.2. ??????????????? ??? ??????? ????????? ???????????
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? ??? ???? ?????? ?????? ??????, ???? ? ??????? ???????? ??? ?????? ???
??? ???????? ??????? ????????? ??? ??????? ??? ?? ??????? ????? ??????
?????????. ?? ??????? ????????? ??? ????? ???????? ???????????, ???????
?? ??????????????? ?? ???????? (pool)?, ???????????? ???? IPNAT ??
???????? ??? ??? ????? ????? ??????????? ?? ?????? ???? ??? ????? ????
???? ?? ??????? ??????.

??? ??????????, ???? ?? ???????????? ??? ?? ?????? ???? ???? ?????????
???????? IP ?????????? ???? ????????:

.. code:: programlisting

    map dc0 192.168.1.0/24 -> 204.134.75.1

???????? ?? ???????????????? ??? ????? IP ???????????, ???? ?? ?? ?????
?????? ???????:

.. code:: programlisting

    map dc0 192.168.1.0/24 -> 204.134.75.0/255.255.255.0

???? ?? ?????????? CIDR:

.. code:: programlisting

    map dc0 192.168.1.0/24 -> 204.134.75.0/24

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.20. ????????????? ?????
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

????? ????? ???????? ?? ????????????? ????????? ???? ? ????????????
???????????, ????????????, ????? ????????? ??? DNS ?? ??????????? PC ???
?????? ??????. ???? ????????? ????, ? ?????? ??????? ??? ???? ??
?????????? ??????????? ?? ?????????? ?? NAT, ???? ?????????? ?????? ??
??????? ??????? ?????? ?? ???????????? ? ??????????? ?????? ??? ????? PC
??? ???????. ?? IPNAT ???? ??? ?????????? ??????????? ??? ??? ???????
????? ??? ???????????. ??? ??????????, ???? ??? ???? ????????????
??????????? ????????? ???? ????????? LAN ``10.0.10.25`` ??? ? ????????
??????? IP ????? ``20.20.20.5``. ? ??????? ??? ?? ??????? ?? ??????? ??
??? ????????:

.. code:: programlisting

    rdr dc0 20.20.20.5/32 port 80 -> 10.0.10.25 port 80

?:

.. code:: programlisting

    rdr dc0 0.0.0.0/0 port 80 -> 10.0.10.25 port 80

? ??? ??? ??????????? DNS ?? ????????? ??? ?????? ?????? ``10.0.10.33``
? ?????? ?????? ?? ??????? ??????????? ??? ?? ??????? ??????:

.. code:: programlisting

    rdr dc0 20.20.20.5/32 port 53 -> 10.0.10.33 port 53 udp

.. raw:: html

   </div>

.. raw:: html

   <div class="sect2">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.21. FTP ??? NAT
~~~~~~~~~~~~~~~~~~~~

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? FTP ????? ???? ??????????? ??? ???? ????????? ??? ??? ????? ??? ??
Internet ???? ??? ?????? ??? ??????, ???? ?? ?????????? ?????????? ???
????????????? ???? ????????? ?????? ???? ?? ?????????? ??????? ??? ??
????????? ?? ??????????????? ??? ?? ???????? ?????? ? ???? ???? ????.
??? ????? ??????, ??? ??????? ????????? ??????? ?? ??? ????????. ?? ??
??????? ??? ??????, ?? FTP ??????? ??? ???? ????? ??? ??????
????????????? Internet. ??? ?????????? ???? ???? ?? ????????? ??????????
?????????, ???? ?.?. ?? ??????? ??? ??????? ?? ????? ??? ??? ?????? ???
?????? ?? ???? ???????. ?? FTP ???? ??? ??????????? ???????????, ???
?????? ??? ??? ????????. ? ??????? ????? ??? ??? ??????? ? ???????? ???
???????? ?????????. ? ???????? ?????????? ????? ??? ???????, ????? ??
?????? ????????? ???????? ?? ????? ?????? ??? ?????????. ???????? ??
?????? ???? ???? ????????? ??? ??????????? ??? ??? ???????????? ??????
??????????? ???, ??? ``http://www.slacksite.com/other/ftp.html``.

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.21.1. ??????? ??? IPNAT
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

?? IPNAT ???????? ??? ?????? ??????? ??? ????????????? FTP (proxy) ?
????? ?????? ?? ?????????? ???? ????????? ?????? ??? NAT. ?????? ??
?????????????? ??? ?? ?????????? ?????? ??? ?? ?????????? ??? ??????
???? ??????? ? ????????? ????????? FTP, ??? ?? ???????????? ????????
??????????? ??????? ??? ?????? ??? ?? ????????? ???? ??? ?????? ???
????? ??? ??????????????? ??? ?? ?????? ?????????. ???? ????????? ??
???????? ????????? ??? ????????????? ??? ?? ??????? ??? ??????????? ??
?????????? ?? ???????? ??? ?????? ??????? ????? (???? ????? ???????) ???
firewall.

? ???????? ??????? ?????????? ??? ?? ???????? ??? ?? ????????? ??????
(LAN):

.. code:: programlisting

    map dc0 10.0.10.0/29 -> 0/32 proxy port 21 ftp/tcp

? ???????? ??????? ?????????? ??? ?????? FTP ??? ??? ???? (gateway):

.. code:: programlisting

    map dc0 0.0.0.0/0 -> 0/32 proxy port 21 ftp/tcp

? ???????? ??????? ?????????? ??? ??? ?????? ??? ?? ????????? LAN ???
??? ?????? ??? ?????????? FTP:

.. code:: programlisting

    map dc0 10.0.10.0/29 -> 0/32

? ??????? ????????????? ??? FTP ???????????? ???? ??? ??? ????????
?????? ?????????????. ???? ?????? ????????? ?????? ??? ??? ?????? ???
????????? ???? ??????. ?? ????????? ??? ??????? ??? ???? ????????
????????? IP ??? ????????? ??? ?????? FTP, ? ?????????????? FTP
?????????? ??????????? ??????? ??? ?????? ?? ?????? ?????????? ???
??????????? ??? ?????????? ?????? FTP ??? ?????????? ???????? ??? ???
?????????? ????????? NAT. ??? ?? ?????? ??? ??? ??????? ?? ???????? FTP
??? ?????????? ?? ??? ????? ??????, ???? ????????????? ???? ?????
??????, ??????????? ??? ????? ?? ??????? ??? ?? IP ??? ?? ?????
???????????, ??? ??????? ? ?????????? ????????? ???? ??? ?? NAT.

.. raw:: html

   </div>

.. raw:: html

   <div class="sect3">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

30.5.21.2. ??????? ??????? ??? ?? IPNAT
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

???? ??????????????? ? ??????????? FTP, ?????????? ???? ???? ??????? ???
?? NAT.

????? ?? ?????????? FTP, ??????????? ?? ???????? ????? ???????:

.. code:: programlisting

    # Allow out LAN PC client FTP to public Internet
    # Active and passive modes
    pass out quick on rl0 proto tcp from any to any port = 21 flags S keep state

    # Allow out passive mode data channel high order port numbers
    pass out quick on rl0 proto tcp from any to any port > 1024 flags S keep state

    # Active mode let data channel in from FTP server
    pass in quick on rl0 proto tcp from any to any port = 20 flags S keep state

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="navfooter">

--------------

+--------------------------------------------------------+-----------------------------+----------------------------------------+
| `????? <firewalls-pf.html>`__?                         | `???? <firewalls.html>`__   | ?\ `??????? <firewalls-ipfw.html>`__   |
+--------------------------------------------------------+-----------------------------+----------------------------------------+
| 30.4. ?? Packet Filter (PF) ??? ?? ALTQ ??? OpenBSD?   | `???? <index.html>`__       | ?30.6. IPFW                            |
+--------------------------------------------------------+-----------------------------+----------------------------------------+

.. raw:: html

   </div>

???? ?? ???????, ??? ???? ???????, ?????? ?? ?????? ???
ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/

| ??? ????????? ??????? ?? ?? FreeBSD, ???????? ???
  `?????????? <http://www.FreeBSD.org/docs.html>`__ ???? ??
  ?????????????? ?? ??? <questions@FreeBSD.org\ >.
|  ??? ????????? ??????? ?? ???? ??? ??????????, ??????? e-mail ????
  <doc@FreeBSD.org\ >.
