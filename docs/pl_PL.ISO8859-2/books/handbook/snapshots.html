<?xml version="1.0" encoding="iso-8859-2" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-2" /><title>17.14. File System Snapshots</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Podrêcznik FreeBSD" /><link rel="up" href="disks.html" title="Rozdzia³ 17. Storage" /><link rel="prev" href="disks-virtual.html" title="17.13. Network, Memory, and File-Backed File Systems" /><link rel="next" href="quotas.html" title="17.15. File System Quotas" /><link rel="copyright" href="legalnotice.html" title="Informacja Prawna" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">17.14. File System Snapshots</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="disks-virtual.html">Poprzedni</a> </td><th width="60%" align="center">Rozdzia³ 17. Storage</th><td width="20%" align="right"> <a accesskey="n" href="quotas.html">Nastêpny</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="snapshots"></a>17.14. File System Snapshots</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Tom</span> <span class="surname">Rhodes</span></span>. </span></div></div></div><a id="idp89172176" class="indexterm"></a><p>FreeBSD offers a feature in conjunction with
	<a class="link" href="configtuning-disk.html#soft-updates" title="11.12.2. Soft Updates">Soft Updates</a>: File system snapshots.</p><p>Snapshots allow a user to create images of specified file
	systems, and treat them as a file.
	Snapshot files must be created in the file system that the
	action is performed on, and a user may create no more than 20
	snapshots per file system.  Active snapshots are recorded
	in the superblock so they are persistent across unmount and
	remount operations along with system reboots.  When a snapshot
	is no longer required, it can be removed with the standard <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rm&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rm</span>(1)</span></a>
	command.  Snapshots may be removed in any order,
	however all the used space may not be acquired because another snapshot will
	possibly claim some of the released blocks.</p><p>The un-alterable <code class="option">snapshot</code> file flag is set
      by <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mksnap_ffs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mksnap_ffs</span>(8)</span></a> after initial creation of a snapshot file.
	The <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=unlink&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">unlink</span>(1)</span></a> command makes an exception for snapshot files
	since it allows them to be removed.</p><p>Snapshots are created with the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> command.  To place
	a snapshot of <code class="filename">/var</code> in the file
	<code class="filename">/var/snapshot/snap</code> use the following
	command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -u -o snapshot /var/snapshot/snap /var</code></strong></pre><p>Alternatively, you can use <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mksnap_ffs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mksnap_ffs</span>(8)</span></a> to create
	a snapshot:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mksnap_ffs /var /var/snapshot/snap</code></strong></pre><p>One can find snapshot files on a file system (e.g. <code class="filename">/var</code>)
        by using the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=find&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">find</span>(1)</span></a> command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>find /var -flags snapshot</code></strong></pre><p>Once a snapshot has been created, it has several
	uses:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Some administrators will use a snapshot file for backup purposes,
	    because the snapshot can be transfered to CDs or tape.</p></li><li class="listitem"><p>The file system integrity checker, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a>, may be run on the snapshot.
	    Assuming that the file system was clean when it was mounted, you
	    should always get a clean (and unchanging) result.
	    This is essentially what the
	    background <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a> process does.</p></li><li class="listitem"><p>Run the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> utility on the snapshot.
	    A dump will be returned that is consistent with the
	    file system and the timestamp of the snapshot.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a>
	    can also take a snapshot, create a dump image and then
	    remove the snapshot in one command using the
	    <code class="option">-L</code> flag.</p></li><li class="listitem"><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> the snapshot as a frozen image of the file system.
	    To <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> the snapshot
	    <code class="filename">/var/snapshot/snap</code> run:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mdconfig -a -t vnode -f /var/snapshot/snap -u 4</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -r /dev/md4 /mnt</code></strong></pre></li></ul></div><p>You can now walk the hierarchy of your frozen <code class="filename">/var</code>
	file system mounted at <code class="filename">/mnt</code>.  Everything will
	initially be in the same state it was during the snapshot creation time.
	The only exception is that any earlier snapshots will appear
	as zero length files.  When the use of a snapshot has delimited,
	it can be unmounted with:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>umount /mnt</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mdconfig -d -u 4</code></strong></pre><p>For more information about <code class="option">softupdates</code> and
	file system snapshots, including technical papers, you can visit
	Marshall Kirk McKusick's website at
	<code class="uri"><a class="uri" href="http://www.mckusick.com/" target="_top">http://www.mckusick.com/</a></code>.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="disks-virtual.html">Poprzedni</a> </td><td width="20%" align="center"><a accesskey="u" href="disks.html">Pocz±tek rozdzia³u</a></td><td width="40%" align="right"> <a accesskey="n" href="quotas.html">Nastêpny</a></td></tr><tr><td width="40%" align="left" valign="top">17.13. Network, Memory, and File-Backed File Systems </td><td width="20%" align="center"><a accesskey="h" href="index.html">Spis tre¶ci</a></td><td width="40%" align="right" valign="top"> 17.15. File System Quotas</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>