<?xml version="1.0" encoding="iso-8859-2" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-2" /><title>17.4. RAID</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Podrêcznik FreeBSD" /><link rel="up" href="disks.html" title="Rozdzia³ 17. Storage" /><link rel="prev" href="disks-adding.html" title="17.3. Adding Disks" /><link rel="next" href="usb-disks.html" title="17.5. USB Storage Devices" /><link rel="copyright" href="legalnotice.html" title="Informacja Prawna" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">17.4. RAID</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="disks-adding.html">Poprzedni</a> </td><th width="60%" align="center">Rozdzia³ 17. Storage</th><td width="20%" align="right"> <a accesskey="n" href="usb-disks.html">Nastêpny</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="raid"></a>17.4. RAID</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="raid-soft"></a>17.4.1. Software RAID</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd"></a>17.4.1.1. Concatenated Disk Driver (CCD) Configuration</h4></div><div><span class="authorgroup">Original work by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Christopher</span> <span class="surname">Shumway</span></span>. </span></div><div><span class="authorgroup">Revised by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jim</span> <span class="surname">Brown</span></span>. </span></div></div></div><a id="idp88301648" class="indexterm"></a><a id="idp88302416" class="indexterm"></a><p>When choosing a mass storage solution the most important
	  factors to consider are speed, reliability, and cost.  It is
	  rare to have all three in balance; normally a fast, reliable mass
	  storage device is expensive, and to cut back on cost either speed
	  or reliability must be sacrificed.</p><p>In designing the system described below, cost was chosen
          as  the most important factor, followed by speed, then reliability.
          Data transfer speed for this system is ultimately
          constrained by the network.  And while reliability is very important,
          the CCD drive described below serves online data that is already
          fully backed up on CD-R's and can easily be replaced.</p><p>Defining your own requirements is the first step
          in choosing a mass storage solution.  If your requirements prefer
          speed or reliability over cost, your solution will differ from
          the system described in this section.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd-installhw"></a>17.4.1.1.1. Installing the Hardware</h5></div></div></div><p>In addition to the IDE system disk, three Western
            Digital 30GB, 5400 RPM IDE disks form the core
            of the CCD disk described below providing approximately
	    90GB of online storage.  Ideally,
	    each IDE disk would have its own IDE controller
	    and cable, but to minimize cost, additional
	    IDE controllers were not used.  Instead the disks were
	    configured with jumpers so that each IDE controller has
            one master, and one slave.</p><p>Upon reboot, the system BIOS was configured to
	    automatically detect the disks attached.  More importantly,
	    FreeBSD detected them on reboot:</p><pre class="programlisting">ad0: 19574MB &lt;WDC WD205BA&gt; [39770/16/63] at ata0-master UDMA33
ad1: 29333MB &lt;WDC WD307AA&gt; [59598/16/63] at ata0-slave UDMA33
ad2: 29333MB &lt;WDC WD307AA&gt; [59598/16/63] at ata1-master UDMA33
ad3: 29333MB &lt;WDC WD307AA&gt; [59598/16/63] at ata1-slave UDMA33</pre><div xmlns="" class="note"><h3 class="admontitle">Uwaga: </h3><p xmlns="http://www.w3.org/1999/xhtml">If FreeBSD does not detect all the disks, ensure
 	    that you have jumpered them correctly.  Most IDE drives
 	    also have a <span class="quote">"<span class="quote">Cable Select</span>"</span> jumper.  This is
 	    <span class="emphasis"><em>not</em></span> the jumper for the master/slave
 	    relationship.  Consult the drive documentation for help in
 	    identifying the correct jumper.</p></div><p>Next, consider how to attach them as part of the file
 	    system.  You should research both <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=vinum&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">vinum</span>(8)</span></a> (<a class="xref" href="vinum-vinum.html" title="Rozdzia³ 19. The Vinum Volume Manager">Rozdzia³ 19, <em>The Vinum Volume Manager</em></a>) and <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>.  In this
 	    particular configuration, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> was chosen.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd-setup"></a>17.4.1.1.2. Setting Up the CCD</h5></div></div></div><p>The <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> driver allows you to take
  	    several identical disks and concatenate them into one
  	    logical file system.  In order to use
 	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>, you need a kernel with
 	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> support built in.
 	    Add this line to your kernel configuration file, rebuild, and
 	    reinstall the kernel:</p><pre class="programlisting">device   ccd</pre><p>The <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> support can also be
	    loaded as a kernel loadable module.</p><p>To set up <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>, you must first use
 	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a> to label the disks:</p><pre class="programlisting">bsdlabel -r -w ad1 auto
bsdlabel -r -w ad2 auto
bsdlabel -r -w ad3 auto</pre><p>This creates a bsdlabel for <code class="filename">ad1c</code>, <code class="filename">ad2c</code> and <code class="filename">ad3c</code> that
  	    spans the entire disk.</p><p>The next step is to change the disk label type.  You
 	    can use <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">bsdlabel</span>(8)</span></a> to edit the
 	    disks:</p><pre class="programlisting">bsdlabel -e ad1
bsdlabel -e ad2
bsdlabel -e ad3</pre><p>This opens up the current disk label on each disk with
 	    the editor specified by the <code class="envar">EDITOR</code>
 	    environment variable, typically <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=vi&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">vi</span>(1)</span></a>.</p><p>An unmodified disk label will look something like
	    this:</p><pre class="programlisting">8 partitions:
#        size   offset    fstype   [fsize bsize bps/cpg]
  c: 60074784        0    unused        0     0     0   # (Cyl.    0 - 59597)</pre><p>Add a new <code class="literal">e</code> partition for <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> to use. This
 	    can usually be copied from the <code class="literal">c</code> partition,
 	    but the <code class="option">fstype</code> <span class="emphasis"><em>must</em></span>
 	    be <strong class="userinput"><code>4.2BSD</code></strong>.  The disk label should
 	    now look something like this:</p><pre class="programlisting">8 partitions:
#        size   offset    fstype   [fsize bsize bps/cpg]
  c: 60074784        0    unused        0     0     0   # (Cyl.    0 - 59597)
  e: 60074784        0    4.2BSD        0     0     0   # (Cyl.    0 - 59597)</pre></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd-buildingfs"></a>17.4.1.1.3. Building the File System</h5></div></div></div><p>Now that you have all the disks labeled, you must
	    build the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>.  To do that,
	    use  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ccdconfig</span>(8)</span></a>, with options similar to the following:</p><pre class="programlisting">ccdconfig ccd0<a id="co-ccd-dev"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span> 32<a id="co-ccd-interleave"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span> 0<a id="co-ccd-flags"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span> /dev/ad1e<a id="co-ccd-devs"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span> /dev/ad2e /dev/ad3e</pre><p>The use and meaning of each option is shown below:</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co-ccd-dev"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The first argument is the device to configure, in this case,
	    <code class="filename">/dev/ccd0c</code>. The <code class="filename">/dev/</code>
            portion is optional.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-ccd-interleave"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The interleave for the file system.  The interleave
	    defines the size of a stripe in disk blocks, each normally 512 bytes.
	    So, an interleave of 32 would be 16,384 bytes.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-ccd-flags"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Flags for <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ccdconfig</span>(8)</span></a>.  If you want to enable drive
	    mirroring, you can specify a flag here. This
	    configuration does not provide mirroring for
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>, so it is set at 0 (zero).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co-ccd-devs"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The final arguments to <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ccdconfig</span>(8)</span></a>
	    are the devices to place into the array.  Use the complete pathname
	    for each device.</p></td></tr></table></div><p>After running <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccdconfig&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">ccdconfig</span>(8)</span></a> the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>
          is configured. A file system can be installed. Refer to <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a>
          for options, or simply run: </p><pre class="programlisting">newfs /dev/ccd0c</pre></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ccd-auto"></a>17.4.1.1.4. Making it All Automatic</h5></div></div></div><p>Generally, you will want to mount the
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> upon each reboot. To do this, you must
	    configure it first.  Write out your current configuration to
	    <code class="filename">/etc/ccd.conf</code> using the following command:</p><pre class="programlisting">ccdconfig -g &gt; /etc/ccd.conf</pre><p>During reboot, the script <code class="command">/etc/rc</code>
	    runs <code class="command">ccdconfig -C</code> if <code class="filename">/etc/ccd.conf</code>
	    exists. This automatically configures the
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> so it can be mounted.</p><div xmlns="" class="note"><h3 class="admontitle">Uwaga: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you are booting into single user mode, before you can
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>, you
	    need to issue the following command to configure the
	    array:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">ccdconfig -C</pre></div><p>To automatically mount the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a>,
            place an entry for the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ccd</span>(4)</span></a> in
	    <code class="filename">/etc/fstab</code> so it will be mounted at
	    boot time:</p><pre class="programlisting">/dev/ccd0c              /media       ufs     rw      2       2</pre></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="vinum"></a>17.4.1.2. The Vinum Volume Manager</h4></div></div></div><a id="idp88375120" class="indexterm"></a><a id="idp88376016" class="indexterm"></a><p>The Vinum Volume Manager is a block device driver which
	  implements virtual disk drives.  It isolates disk hardware
	  from the block device interface and maps data in ways which
	  result in an increase in flexibility, performance and
	  reliability compared to the traditional slice view of disk
	  storage.  <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=vinum&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">vinum</span>(8)</span></a> implements the RAID-0, RAID-1 and
	  RAID-5 models, both individually and in combination.</p><p>See <a class="xref" href="vinum-vinum.html" title="Rozdzia³ 19. The Vinum Volume Manager">Rozdzia³ 19, <em>The Vinum Volume Manager</em></a> for more
	  information about <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=vinum&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">vinum</span>(8)</span></a>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="raid-hard"></a>17.4.2. Hardware RAID</h3></div></div></div><a id="idp88380880" class="indexterm"></a><p>FreeBSD also supports a variety of hardware <acronym class="acronym">RAID</acronym>
        controllers.  These devices control a <acronym class="acronym">RAID</acronym> subsystem
        without the need for FreeBSD specific software to manage the
        array.</p><p>Using an on-card <acronym class="acronym">BIOS</acronym>, the card controls most  of the disk operations
	itself.  The following is a brief setup description using a Promise <acronym class="acronym">IDE</acronym> <acronym class="acronym">RAID</acronym>
	controller.  When this card is installed and the system is started up, it
	displays a prompt requesting information.  Follow the instructions
	to enter the card's setup screen.  From here, you have the ability to
	combine all the attached drives.  After doing so, the disk(s) will look like
	a single drive to FreeBSD.  Other <acronym class="acronym">RAID</acronym> levels can be set up
	accordingly.
      </p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88405968"></a>17.4.3. Rebuilding ATA RAID1 Arrays</h3></div></div></div><p>FreeBSD allows you to hot-replace a failed disk in an array. This requires
	that you catch it before you reboot.</p><p>You will probably see something like the following in <code class="filename">/var/log/messages</code> or in the <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dmesg&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dmesg</span>(8)</span></a>
	output:</p><pre class="programlisting">ad6 on monster1 suffered a hard error.
ad6: READ command timeout tag=0 serv=0 - resetting
ad6: trying fallback to PIO mode
ata3: resetting devices .. done
ad6: hard error reading fsbn 1116119 of 0-7 (ad6 bn 1116119; cn 1107 tn 4 sn 11)\\
status=59 error=40
ar0: WARNING - mirror lost</pre><p>Using <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=atacontrol&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">atacontrol</span>(8)</span></a>, check for further information:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol list</code></strong>
ATA channel 0:
	Master:      no device present
	Slave:   acd0 &lt;HL-DT-ST CD-ROM GCR-8520B/1.00&gt; ATA/ATAPI rev 0

ATA channel 1:
	Master:      no device present
	Slave:       no device present

ATA channel 2:
	Master:  ad4 &lt;MAXTOR 6L080J4/A93.0500&gt; ATA/ATAPI rev 5
	Slave:       no device present

ATA channel 3:
	Master:  ad6 &lt;MAXTOR 6L080J4/A93.0500&gt; ATA/ATAPI rev 5
	Slave:       no device present

<code class="prompt">#</code> <strong class="userinput"><code>atacontrol status ar0</code></strong>
ar0: ATA RAID1 subdisks: ad4 ad6 status: DEGRADED</pre><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>You will first need to detach the ata channel with the failed
	    disk so you can safely remove it:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol detach ata3</code></strong></pre></li><li class="step"><p>Replace the disk.</p></li><li class="step"><p>Reattach the ata channel:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol attach ata3</code></strong>
Master:  ad6 &lt;MAXTOR 6L080J4/A93.0500&gt; ATA/ATAPI rev 5
Slave:   no device present</pre></li><li class="step"><p>Add the new disk to the array as a spare:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol addspare ar0 ad6</code></strong></pre></li><li class="step"><p>Rebuild the array:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>atacontrol rebuild ar0</code></strong></pre></li><li class="step"><p>It is possible to check on the progress by issuing the
	    following command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dmesg | tail -10</code></strong>
[output removed]
ad6: removed from configuration
ad6: deleted from ar0 disk1
ad6: inserted into ar0 disk1 as spare

<code class="prompt">#</code> <strong class="userinput"><code>atacontrol status ar0</code></strong>
ar0: ATA RAID1 subdisks: ad4 ad6 status: REBUILDING 0% completed</pre></li><li class="step"><p>Wait until this operation completes.</p></li></ol></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="disks-adding.html">Poprzedni</a> </td><td width="20%" align="center"><a accesskey="u" href="disks.html">Pocz±tek rozdzia³u</a></td><td width="40%" align="right"> <a accesskey="n" href="usb-disks.html">Nastêpny</a></td></tr><tr><td width="40%" align="left" valign="top">17.3. Adding Disks </td><td width="20%" align="center"><a accesskey="h" href="index.html">Spis tre¶ci</a></td><td width="40%" align="right" valign="top"> 17.5. USB Storage Devices</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="http://ftp.FreeBSD.org/pub/FreeBSD/doc/">http://ftp.FreeBSD.org/pub/FreeBSD/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="http://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>