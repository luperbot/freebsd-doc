========================
Chapter?2.?Locking Notes
========================

.. raw:: html

   <div class="navheader">

Chapter?2.?Locking Notes
`Prev <boot-kernel.html>`__?
Part?I.?Kernel
?\ `Next <locking-sx.html>`__

--------------

.. raw:: html

   </div>

.. raw:: html

   <div class="chapter">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

Chapter?2.?Locking Notes
------------------------

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="toc">

.. raw:: html

   <div class="toc-title">

Table of Contents

.. raw:: html

   </div>

`2.1. Mutexes <locking.html#locking-mutexes>`__
`2.2. Shared Exclusive Locks <locking-sx.html>`__
`2.3. Atomically Protected Variables <locking-atomic.html>`__

.. raw:: html

   </div>

*This chapter is maintained by the FreeBSD SMP Next Generation Project.*

This document outlines the locking used in the FreeBSD kernel to permit
effective multi-processing within the kernel. Locking can be achieved
via several means. Data structures can be protected by mutexes or
`lockmgr(9) <http://www.FreeBSD.org/cgi/man.cgi?query=lockmgr&sektion=9>`__
locks. A few variables are protected simply by always using atomic
operations to access them.

.. raw:: html

   <div class="sect1">

.. raw:: html

   <div class="titlepage" xmlns="">

.. raw:: html

   <div>

.. raw:: html

   <div>

2.1.?Mutexes
------------

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

A mutex is simply a lock used to guarantee mutual exclusion.
Specifically, a mutex may only be owned by one entity at a time. If
another entity wishes to obtain a mutex that is already owned, it must
wait until the mutex is released. In the FreeBSD kernel, mutexes are
owned by processes.

Mutexes may be recursively acquired, but they are intended to be held
for a short period of time. Specifically, one may not sleep while
holding a mutex. If you need to hold a lock across a sleep, use a
`lockmgr(9) <http://www.FreeBSD.org/cgi/man.cgi?query=lockmgr&sektion=9>`__
lock.

Each mutex has several properties of interest:

.. raw:: html

   <div class="variablelist">

Variable Name
    The name of the struct mtx variable in the kernel source.

Logical Name
    The name of the mutex assigned to it by ``mtx_init``. This name is
    displayed in KTR trace messages and witness errors and warnings and
    is used to distinguish mutexes in the witness code.

Type
    The type of the mutex in terms of the ``MTX_*`` flags. The meaning
    for each flag is related to its meaning as documented in
    `mutex(9) <http://www.FreeBSD.org/cgi/man.cgi?query=mutex&sektion=9>`__.

    .. raw:: html

       <div class="variablelist">

    ``MTX_DEF``
        A sleep mutex

    ``MTX_SPIN``
        A spin mutex

    ``MTX_RECURSE``
        This mutex is allowed to recurse.

    .. raw:: html

       </div>

Protectees
    A list of data structures or data structure members that this entry
    protects. For data structure members, the name will be in the form
    of ``structure name``.\ ``member name``.

Dependent Functions
    Functions that can only be called if this mutex is held.

.. raw:: html

   </div>

.. raw:: html

   <div class="table">

.. raw:: html

   <div class="table-title">

Table?2.1.?Mutex List

.. raw:: html

   </div>

.. raw:: html

   <div class="table-contents">

+-----------------+------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Variable Name   | Logical Name     | Type                              | Protectees                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Dependent Functions                                                                                                                                                                                                                                                                                 |
+=================+==================+===================================+===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+=====================================================================================================================================================================================================================================================================================================+
| sched\_lock     | “sched lock”     | ``MTX_SPIN`` \| ``MTX_RECURSE``   | ``_gmonparam``, ``cnt.v_swtch``, ``cp_time``, ``curpriority``, ``mtx``.\ ``mtx_blocked``, ``mtx``.\ ``mtx_contested``, ``proc``.\ ``p_procq``, ``proc``.\ ``p_slpq``, ``proc``.\ ``p_sflag``, ``proc``.\ ``p_stat``, ``proc``.\ ``p_estcpu``, ``proc``.\ ``p_cpticks`` ``proc``.\ ``p_pctcpu``, ``proc``.\ ``p_wchan``, ``proc``.\ ``p_wmesg``, ``proc``.\ ``p_swtime``, ``proc``.\ ``p_slptime``, ``proc``.\ ``p_runtime``, ``proc``.\ ``p_uu``, ``proc``.\ ``p_su``, ``proc``.\ ``p_iu``, ``proc``.\ ``p_uticks``, ``proc``.\ ``p_sticks``, ``proc``.\ ``p_iticks``, ``proc``.\ ``p_oncpu``, ``proc``.\ ``p_lastcpu``, ``proc``.\ ``p_rqindex``, ``proc``.\ ``p_heldmtx``, ``proc``.\ ``p_blocked``, ``proc``.\ ``p_mtxname``, ``proc``.\ ``p_contested``, ``proc``.\ ``p_priority``, ``proc``.\ ``p_usrpri``, ``proc``.\ ``p_nativepri``, ``proc``.\ ``p_nice``, ``proc``.\ ``p_rtprio``, ``pscnt``, ``slpque``, ``itqueuebits``, ``itqueues``, ``rtqueuebits``, ``rtqueues``, ``queuebits``, ``queues``, ``idqueuebits``, ``idqueues``, ``switchtime``, ``switchticks``   | ``setrunqueue``, ``remrunqueue``, ``mi_switch``, ``chooseproc``, ``schedclock``, ``resetpriority``, ``updatepri``, ``maybe_resched``, ``cpu_switch``, ``cpu_throw``, ``need_resched``, ``resched_wanted``, ``clear_resched``, ``aston``, ``astoff``, ``astpending``, ``calcru``, ``proc_compare``   |
+-----------------+------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| vm86pcb\_lock   | “vm86pcb lock”   | ``MTX_DEF``                       | ``vm86pcb``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ``vm86_bioscall``                                                                                                                                                                                                                                                                                   |
+-----------------+------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Giant           | “Giant”          | ``MTX_DEF`` \| ``MTX_RECURSE``    | nearly everything                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | lots                                                                                                                                                                                                                                                                                                |
+-----------------+------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| callout\_lock   | “callout lock”   | ``MTX_SPIN`` \| ``MTX_RECURSE``   | ``callfree``, ``callwheel``, ``nextsoftcheck``, ``proc``.\ ``p_itcallout``, ``proc``.\ ``p_slpcallout``, ``softticks``, ``ticks``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                     |
+-----------------+------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   </div>

.. raw:: html

   <div class="navfooter">

--------------

+--------------------------------+-------------------------+---------------------------------+
| `Prev <boot-kernel.html>`__?   | `Up <kernel.html>`__    | ?\ `Next <locking-sx.html>`__   |
+--------------------------------+-------------------------+---------------------------------+
| 1.9.?Kernel Initialization?    | `Home <index.html>`__   | ?2.2.?Shared Exclusive Locks    |
+--------------------------------+-------------------------+---------------------------------+

.. raw:: html

   </div>

All FreeBSD documents are available for download at
http://ftp.FreeBSD.org/pub/FreeBSD/doc/

| Questions that are not answered by the
  `documentation <http://www.FreeBSD.org/docs.html>`__ may be sent to
  <freebsd-questions@FreeBSD.org\ >.
|  Send questions about this document to <freebsd-doc@FreeBSD.org\ >.
