<?xml version="1.0" encoding="euc-jp" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=euc-jp" /><title>12.8. ディスクのチューニング</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD ハンドブック" /><link rel="up" href="config-tuning.html" title="第12章 設定とチューニング" /><link rel="prev" href="configtuning-sysctl.html" title="12.7. sysctl によるチューニング" /><link rel="next" href="configtuning-kernel-limits.html" title="12.9. Kernel 制限のチューニング" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">12.8. ディスクのチューニング</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="configtuning-sysctl.html">戻る</a>〓</td><th width="60%" align="center">第12章 設定とチューニング</th><td width="20%" align="right">〓<a accesskey="n" href="configtuning-kernel-limits.html">次へ</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="configtuning-disk"></a>12.8. ディスクのチューニング</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88645200"></a>12.8.1. sysctl 変数</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88645840"></a>12.8.1.1. <code class="varname">vfs.vmiodirenable</code></h4></div></div></div><a id="idp88659024" class="indexterm"></a><p><code class="varname">vfs.vmiodirenable</code> sysctl
	  変数のデフォルトは 1 (オン) で、
	  0 (オフ) または 1 (オン) にセットすることができます。
	このパラメータはディレクトリがシステムによってどのように
	キャッシュされるかを制御します。
	ほとんどのディレクトリは小さく、
	ファイルシステムにおいては単一フラグメント (典型的には 1K)
	であり、バッファキャッシュではさらに小さくなっています
	(典型的には 512 バイト)。
	しかしデフォルトモードで動作している時は、
	大量のメモリを搭載していても
	バッファキャッシュは固定数のディレクトリしかキャッシュしません。
	この sysctl をオンにすると、バッファキャッシュが VM ページキャッシュを、
	ディレクトリをキャッシュするために使うことを可能にします。
	これによる利点は、全てのメモリがディレクトリを
	キャッシュするのに使えるようになるということです。
	欠点は、キャッシュに使われる最小のメモリの大きさが 512 バイトではなく
	物理ページサイズ (大抵は 4K) になることです。
	多数のファイルを操作するサービスを稼動しているなら、
	常にこのオプションをオンにすることを推奨します。
	そのようなサービスには、web キャッシュや大規模なメールシステム、
	ニューズシステムなどが含まれます。
	このオプションは一般にメモリを消費しますが、
	性能を削減することはありません。
	ただし実験して調べてみるべきでしょう。</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88660688"></a>12.8.1.2. <code class="varname">hw.ata.wc</code></h4></div></div></div><a id="idp88661456" class="indexterm"></a><p>FreeBSD 4.3 では IDE のライトキャッシュがオフになりました。
	  これは IDE
	  ディスクへの書き込み帯域幅を減らしてしまうことになりますが、
	  ハードドライブベンダに起因するデータの一貫性に関する
	  重大な問題のために必要なことだと考えられました。
	  基本的には、書き込み完了時期について IDE
	  ドライブが嘘をつくという問題です。
	  IDE ライトキャッシュがオンであると
	  IDE ハードドライブはデータを順番に書きこまないばかりか、
	  ディスクの負荷が高い時にはいくつかのブロックの書き込みを
	  無期限に延期してしまいます。  クラッシュや電源故障の場合、
	  ファイルシステムの重大な破壊をもたらします。
	  したがって私たちはデフォルトを安全側に変更しました。
	  残念ながらこれは大変な性能の低下をもたらし、
	  私たちはあきらめてこのリリース後にオンに戻しました。
	  <code class="varname">hw.ata.wc</code> sysctl 変数を見てデフォルトを
	  チェックしてみるべきです。
	  もし IDE ライトキャッシュがオフになっていたら、
	  hw.ata.wc カーネル変数を 1 に戻すことでオンに戻すことができます。
	  これはブート時にブートローダから行わなければなりません。
	  カーネルがブートした後に行っても効果はありません。</p><p>詳しくは <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ata&amp;sektion=4"><span class="citerefentry"><span class="refentrytitle">ata</span>(4)</span></a> を見てください。</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp88664528"></a>12.8.2. ソフトアップデート</h3></div></div></div><a id="idp88665168" class="indexterm"></a><a id="idp88665680" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tunefs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">tunefs</span>(8)</span></a> プログラムはファイルシステムを細かくチュー
	ニングするのに使えます。このプログラムにはさまざまなオプションがありま
	すが、ここではソフトアップデートをオンオフすることだけを考えま
	す。以下の様にして切り替えます。</p><pre class="screen"><code class="prompt">#</code> tunefs -n enable /filesystem
<code class="prompt">#</code> tunefs -n disable /filesystem</pre><p>ファイルシステムはマウントされているあいだは <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=tunefs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">tunefs</span>(8)</span></a>
        で変更することができません。  ソフトアップデートを有効にする
	いい機会はシングルユーザモードでどのパーティションもマウント
	されていない時です。</p><div xmlns="" class="note"><h3 class="admontitle">注記: </h3><p xmlns="http://www.w3.org/1999/xhtml">FreeBSD 4.5 からは、ファイルシステム生成時に
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a> の <code class="literal">-U</code> オプションを使って
	ソフトアップデートを有効化できるようになりました。</p></div><p>ソフトアップデートはメタデータの性能、
        主にファイルの作成と削除の性能を劇的に改善します。
	すべてのファイルシステムでソフトアップデートを有効にすることを推奨します。
	ソフトアップデートに関して、2 つの欠点を意識すべきです。
	1 つめは、ソフトアップデートはクラッシュ時におけるファイルシス
	テムの一貫性は保証しますが、
	物理ディスクの更新が何秒か (1 分に達することもあります!)
	遅れる可能性が高いことです。
	システムがクラッシュした場合、より多くの作業結果が消えてしまうかもしれません。
	2 つめは、ソフトアップデート
	はファイルシステムブロックを解放するのを遅らせるということです。
	あるファイルシステム (たとえばルートファイルシステム) が満杯近くの時に
	それに対する大規模な更新、たとえば <code class="command">make installworld</code>
	をすると、空き領域を使い果たして更新が失敗してしまうことがあります。
      </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="configtuning-sysctl.html">戻る</a>〓</td><td width="20%" align="center"><a accesskey="u" href="config-tuning.html">上に戻る</a></td><td width="40%" align="right">〓<a accesskey="n" href="configtuning-kernel-limits.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">12.7. sysctl によるチューニング〓</td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top">〓12.9. Kernel 制限のチューニング</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文書、および他の文書は
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>
    からダウンロードできます。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>FreeBSD に関する質問がある場合には、
    <a href="http://www.FreeBSD.org/ja/docs.html">ドキュメント</a> を読んだ上で
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt; まで (英語で) 連絡してください。<br></br>
    本文書に関する質問については、
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt; まで電子メールを (英語で) 送ってください。</small></p></body></html>