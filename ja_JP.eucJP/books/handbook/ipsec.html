<?xml version="1.0" encoding="euc-jp" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=euc-jp" /><title>15.9. IPsec</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD ハンドブック" /><link rel="up" href="security.html" title="第15章 セキュリティ" /><link rel="prev" href="openssl.html" title="15.8. OpenSSL" /><link rel="next" href="openssh.html" title="15.10. OpenSSH" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">15.9. IPsec</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="openssl.html">戻る</a>〓</td><th width="60%" align="center">第15章 セキュリティ</th><td width="20%" align="right">〓<a accesskey="n" href="openssh.html">次へ</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="ipsec"></a>15.9. IPsec</h2></div><div><span class="authorgroup">寄稿: <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="surname">Inoue</span> <span class="firstname">Yoshinobu</span> [FAMILY Given]</span>. </span></div></div></div><a id="idp90413392" class="indexterm"></a><a id="idp90413904" class="indexterm"></a><p><span class="emphasis"><em>訳: 日野 浩志 <code class="email">&lt;<a xmlns="" class="email" href="mailto:hino@ccm.cl.nec.co.jp">hino@ccm.cl.nec.co.jp</a>&gt;</code>, 14 March
	2001.</em></span></p><div xmlns="" class="note"><h3 class="admontitle">終端文字: </h3><p xmlns="http://www.w3.org/1999/xhtml">この節の、また他の節を通して、末尾に <span class="quote">「<span class="quote">^D</span>」</span>
	が置かれている例があることに気づかれるでしょう。
	これは、<span class="keycap"><strong>Control</strong></span> キーを押しながら
	<span class="keycap"><strong>D</strong></span> キーを押すことを意味しています。
	ほかによく使われる文字は <span class="quote">「<span class="quote">^C</span>」</span>
	で、<span class="keycap"><strong>Control</strong></span>　キーを押しながら
	<span class="keycap"><strong>C</strong></span> を押すことを意味しています。</p></div><div xmlns="" class="tip"><h3 class="admontitle">ヒント: </h3><p xmlns="http://www.w3.org/1999/xhtml">FreeBSD の IPsec 実装について説明した HOWTO は、他に
	<code class="uri"><a class="uri" href="http://www.daemonnews.org/200101/ipsec-howto.html" target="_top">http://www.daemonnews.org/200101/ipsec-howto.html</a></code>
	と <code class="uri"><a class="uri" href="http://www.freebsddiary.org/ipsec.php" target="_top">http://www.freebsddiary.org/ipsec.php</a></code>
	があります。</p></div><p>IPsec 機構は、IP 層とソケット層に対して安全な通信を提供します。
      この節ではその使い方を説明します。実装の詳細に関しては <a class="link" href="../../../en_US.ISO8859-1/books/developers-handbook/ipv6.html" target="_top">The
      Developers' Handbook</a> を参照してください。
      
      </p><p>現在の IPsec の実装は、
      トランスポートモードとトンネルモードの両方に対応しています。
      しかし、トンネルモードにはいくつかの制限事項があります。<a class="link" href="http://www.kame.net/newsletter/" target="_top">http://www.kame.net/newsletter/
      </a> にはより総合的な例が載っています。</p><p>ここで述べる機能を利用するには、以下のオプションをカーネルコ
      ンパイル時に指定する必要があることにご注意ください。</p><pre class="programlisting">options          IPSEC              #IP security
options          IPSEC_ESP          #IP security (crypto; define w/IPSEC)</pre><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90428496"></a>15.9.1. IPv4 におけるトランスポートモードの例</h3></div></div></div><p>ホスト A (<code class="systemitem">10.2.3.4</code>)
	とホスト B (<code class="systemitem">10.6.7.8</code>)
	との間に安全なチャネルを配置するために、
	セキュリティアソシエーションを設定しましょう。
	ここでは、少し込み入った例を示します。ホスト A からホストB
	へは old AH のみを使います。ホスト B からホスト A へは
	new AH と new ESP を組み合わせます。</p><p>ここで <span class="quote">「<span class="quote">AH</span>」</span>/<span class="quote">「<span class="quote">new AH</span>」</span>/<span class="quote">「<span class="quote">ESP</span>」</span>/<span class="quote">「<span class="quote">new ESP</span>」</span>
	に対応するアルゴリズムを決めないといけません。
	アルゴリズムの名前を知るには、
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=setkey&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">setkey</span>(8)</span></a> マニュアルページをご覧ください。ここでは、AH に
	MD5 を、new AH には new-HMAC-SHA1 を、new ESP には 8 バイト IV
	の new-DES-expIV を選びました。</p><p>鍵長はそれぞれのアルゴリズムに大きく依存します。たとえば、
	MD5 では鍵長は 16 バイトでなければなりませんし、new-HMAC-SHA1
	では 20 バイトでなければなりませんし、new-DES-expIV では
	8 バイトでなければなりません。ここではそれぞれ
	<span class="quote">「<span class="quote">MYSECRETMYSECRET</span>」</span>,
	<span class="quote">「<span class="quote">KAMEKAMEKAMEKAMEKAME</span>」</span>,
	<span class="quote">「<span class="quote">PASSWORD</span>」</span> とします。</p><p>次に、それぞれのプロトコルに対して SPI
	(セキュリティパラメータインデックス: Security Parameter Index)
	を割り当てます。3 種類のセキュリティヘッダ
	(ホスト A からホスト B に 1 つ、ホスト B から ホスト A に 2 つ)
	を生成するので、この安全なチャネルには 3 つの SPI
	が必要になることに注意してください。さらに、SPI は
	256 以上でなければならないことにも注意してください。
	ここではそれぞれ 1000, 2000, 3000 を割り当てます。</p><pre class="screen">
	           (1)
	ホスト A ------&gt; ホスト B

	(1)PROTO=AH
		ALG=MD5(RFC1826)
		KEY=MYSECRETMYSECRET
		SPI=1000

	           (2.1)
	ホスト A &lt;------ ホスト B
	         &lt;------
	           (2.2)

	(2.1)
	PROTO=AH
		ALG=new-HMAC-SHA1(new AH)
		KEY=KAMEKAMEKAMEKAMEKAME
		SPI=2000

	(2.2)
	PROTO=ESP
		ALG=new-DES-expIV(new ESP)
			IV length = 8
		KEY=PASSWORD
		SPI=3000
</pre><p>次に、セキュリティアソシエーションを設定しましょう。ホスト
	A とホスト B の両方で、<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=setkey&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">setkey</span>(8)</span></a> を実行します。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>setkey -c
    add 10.2.3.4 10.6.7.8 ah-old  1000 -m transport -A keyed-md5 "MYSECRETMYSECRET" ;
    add 10.6.7.8 10.2.3.4 ah  2000 -m transport -A hmac-sha1 "KAMEKAMEKAMEKAMEKAME" ;
    add 10.6.7.8 10.2.3.4 esp 3000 -m transport -E des-cbc "PASSWORD" ;
    ^D</code></strong></pre><p>実際には、セキュリティポリシのエントリが定義されるまでは
	IPsec による通信は行われません。
	この例の場合、両方のホストを設定する必要があります。</p><pre class="screen">
A で:

<code class="prompt">#</code> <strong class="userinput"><code>setkey -c
    spdadd 10.2.3.4 10.6.7.8 any -P out ipsec
	ah/transport/10.2.3.4-10.6.7.8/require ;
    ^D</code></strong>

B で:

<code class="prompt">#</code> <strong class="userinput"><code>setkey -c
    spdadd 10.6.7.8 10.2.3.4 any -P out ipsec
	esp/transport/10.6.7.8-10.2.3.4/require ;
    spdadd 10.6.7.8 10.2.3.4 any -P out ipsec
	ah/transport/10.6.7.8-10.2.3.4/require ;
    ^D</code></strong>


  ホスト A -------------------------------------&gt; ホスト B
  10.2.3.4                                       10.6.7.8
          |                                     |
          ========== old AH keyed-md5 ==========&gt;

          &lt;========= new AH hmac-sha1 ===========
          &lt;========= new ESP des-cbc ============
</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90444368"></a>15.9.2. IPv6 におけるトランスポートモードの例</h3></div></div></div><p>IPv6 を使ったもう一つの例。</p><p>ホスト-A とホスト-B 間の TCP ポート番号 110 番の通信には、
	ESP トランスポートモードが推奨されます。</p><pre class="screen">
              ============ ESP ============
              |                           |
          ホスト-A                      ホスト-B
          fec0::10 -------------------- fec0::11
</pre><p>暗号化アルゴリズムは blowfish-cbc で、その鍵は <span class="quote">「<span class="quote">kamekame</span>」</span>、
	認証アルゴリズムは hmac-sha1 で、その鍵は <span class="quote">「<span class="quote">this is the test
	key</span>」</span> とします。ホスト-A の設定は次のようになります。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>setkey -c &lt;&lt;EOF
    spdadd fec0::10[any] fec0::11[110] tcp -P out ipsec
	esp/transport/fec0::10-fec0::11/use ;
    spdadd fec0::11[110] fec0::10[any] tcp -P in ipsec
	esp/transport/fec0::11-fec0::10/use ;
    add fec0::10 fec0::11 esp 0x10001
	-m transport
	-E blowfish-cbc "kamekame"
	-A hmac-sha1 "this is the test key" ;
    add fec0::11 fec0::10 esp 0x10002
	-m transport
	-E blowfish-cbc "kamekame"
	-A hmac-sha1 "this is the test key" ;
    EOF</code></strong></pre><p>そしてホスト-B の設定は次のようになります。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>setkey -c &lt;&lt;EOF
    spdadd fec0::11[110] fec0::10[any] tcp -P out ipsec
	esp/transport/fec0::11-fec0::10/use ;
    spdadd fec0::10[any] fec0::11[110] tcp -P in ipsec
	esp/transport/fec0::10-fec0::11/use ;
    add fec0::10 fec0::11 esp 0x10001 -m transport
	-E blowfish-cbc "kamekame"
	-A hmac-sha1 "this is the test key" ;
    add fec0::11 fec0::10 esp 0x10002 -m transport
	-E blowfish-cbc "kamekame"
	-A hmac-sha1 "this is the test key" ;
    EOF</code></strong></pre><p>SP の方向に注意してください。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90466512"></a>15.9.3. IPv4 におけるトンネルモードの例</h3></div></div></div><p>2 台のセキュリティゲートウェイ間のトンネルモード</p><p>セキュリティプロトコルは old AH トンネルモード、すなわち
	RFC1826 で指定されるものです。認証アルゴリズムは <span class="quote">「<span class="quote">this is the
	test</span>」</span> を鍵とする keyed-md5 です。</p><pre class="screen">
                             ======= AH =======
                             |                |
     ネットワーク-A   ゲートウェイ-A    ゲートウェイ-B   ネットワーク-B
        10.0.1.0/24 ---- 172.16.0.1 ----- 172.16.0.2 ---- 10.0.2.0/24
</pre><p>ゲートウェイ-A における設定は次のようになります。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>setkey -c &lt;&lt;EOF
    spdadd 10.0.1.0/24 10.0.2.0/24 any -P out ipsec
	ah/tunnel/172.16.0.1-172.16.0.2/require ;
    spdadd 10.0.2.0/24 10.0.1.0/24 any -P in ipsec
	ah/tunnel/172.16.0.2-172.16.0.1/require ;
    add 172.16.0.1 172.16.0.2 ah-old 0x10003 -m any
	-A keyed-md5 "this is the test" ;
    add 172.16.0.2 172.16.0.1 ah-old 0x10004 -m any
	-A keyed-md5 "this is the test" ;

EOF</code></strong></pre><p>上記の例のように、もしポート番号フィールドを書かないと、
	<code class="literal">[any]</code> と同じ意味になります。<code class="literal">-m</code> は使用される SA
	のモードを指定します。<code class="literal">-m any</code>
	はセキュリティプロトコルのモードのワイルドカードを意味します。
	この SA をトンネルモードとトランスポートモードの両方で使用できます。</p><p>そしてゲートウェイ-B では次のようになります。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>setkey -c &lt;&lt;EOF
    spdadd 10.0.2.0/24 10.0.1.0/24 any -P out ipsec
	ah/tunnel/172.16.0.2-172.16.0.1/require ;
    spdadd 10.0.1.0/24 10.0.2.0/24 any -P in ipsec
	ah/tunnel/172.16.0.1-172.16.0.2/require ;
    add 172.16.0.1 172.16.0.2 ah-old 0x10003 -m any
	-A keyed-md5 "this is the test" ;
    add 172.16.0.2 172.16.0.1 ah-old 0x10004 -m any
	-A keyed-md5 "this is the test" ;

EOF</code></strong></pre><p>二台のセキュリティゲートウェイ間の SA の束の作成</p><p>ゲートウェイ-A とゲートウェイ-B の間では、
	AH トランスポートモードと ESP トンネルモードが要求されます。
	この例では、まず ESP トンネルモードが適用され、次に
	AH トランスポートモードが適用されます。</p><pre class="screen">
                            ========== AH =========
                            |  ======= ESP =====  |
                            |  |               |  |
    ネットワーク-A     ゲートウェイ-A     ゲートウェイ-B     ネットワーク-B
    fec0:0:0:1::/64 --- fec0:0:0:1::1 ---- fec0:0:0:2::1 --- fec0:0:0:2::/64
</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90478416"></a>15.9.4. IPv6 におけるトンネルモードの例</h3></div></div></div><p>暗号化アルゴリズムは 3des-cbc, ESP の認証アルゴリズムは
	hmac-sha1 とします。AH の認証アルゴリズムは hmac-md5 とします。
	ゲートウェイ-A での設定は次のようになります。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>setkey -c &lt;&lt;EOF
    spdadd fec0:0:0:1::/64 fec0:0:0:2::/64 any -P out ipsec
	esp/tunnel/fec0:0:0:1::1-fec0:0:0:2::1/require
	ah/transport/fec0:0:0:1::1-fec0:0:0:2::1/require ;
    spdadd fec0:0:0:2::/64 fec0:0:0:1::/64 any -P in ipsec
	esp/tunnel/fec0:0:0:2::1-fec0:0:0:1::1/require
	ah/transport/fec0:0:0:2::1-fec0:0:0:1::1/require ;
    add fec0:0:0:1::1 fec0:0:0:2::1 esp 0x10001 -m tunnel
	-E 3des-cbc "kamekame12341234kame1234"
	-A hmac-sha1 "this is the test key" ;
    add fec0:0:0:1::1 fec0:0:0:2::1 ah 0x10001 -m transport
	-A hmac-md5 "this is the test" ;
    add fec0:0:0:2::1 fec0:0:0:1::1 esp 0x10001 -m tunnel
	-E 3des-cbc "kamekame12341234kame1234"
	-A hmac-sha1 "this is the test key" ;
    add fec0:0:0:2::1 fec0:0:0:1::1 ah 0x10001 -m transport
	-A hmac-md5 "this is the test" ;

    EOF</code></strong></pre><p>異なる通信端での SA の作成</p><p>ホスト-A とゲートウェイ-A の間では
	ESP トンネルモードが要求されています。暗号化アルゴリズムは
	cast128-cbc で、ESP の認証アルゴリズムは hmac-sha1
	です。ホスト-A とホスト-B との間では
	ESP トランスポートモードが推奨されています。
	暗号化アルゴリズムは rc5-cbc で、ESP
	の認証アルゴリズムは hmac-md5 です。</p><pre class="screen">
              ================== ESP =================
              |  ======= ESP =======                 |
              |  |                 |                 |
            ホスト-A        ゲートウェイ-A         ホスト-B
          fec0:0:0:1::1 ---- fec0:0:0:2::1 ---- fec0:0:0:2::2
</pre><p>ホスト-A での設定は次のようになります。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>setkey -c &lt;&lt;EOF
    spdadd fec0:0:0:1::1[any] fec0:0:0:2::2[80] tcp -P out ipsec
	esp/transport/fec0:0:0:1::1-fec0:0:0:2::2/use
	esp/tunnel/fec0:0:0:1::1-fec0:0:0:2::1/require ;
    spdadd fec0:0:0:2::1[80] fec0:0:0:1::1[any] tcp -P in ipsec
	esp/transport/fec0:0:0:2::2-fec0:0:0:l::1/use
	esp/tunnel/fec0:0:0:2::1-fec0:0:0:1::1/require ;
    add fec0:0:0:1::1 fec0:0:0:2::2 esp 0x10001
	-m transport
	-E cast128-cbc "12341234"
	-A hmac-sha1 "this is the test key" ;
    add fec0:0:0:1::1 fec0:0:0:2::1 esp 0x10002
	-E rc5-cbc "kamekame"
	-A hmac-md5 "this is the test" ;
    add fec0:0:0:2::2 fec0:0:0:1::1 esp 0x10003
	-m transport
	-E cast128-cbc "12341234"
	-A hmac-sha1 "this is the test key" ;
    add fec0:0:0:2::1 fec0:0:0:1::1 esp 0x10004
	-E rc5-cbc "kamekame"
	-A hmac-md5 "this is the test" ;

    EOF</code></strong></pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="openssl.html">戻る</a>〓</td><td width="20%" align="center"><a accesskey="u" href="security.html">上に戻る</a></td><td width="40%" align="right">〓<a accesskey="n" href="openssh.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">15.8. OpenSSL〓</td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top">〓15.10. OpenSSH</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文書、および他の文書は
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>
    からダウンロードできます。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>FreeBSD に関する質問がある場合には、
    <a href="http://www.FreeBSD.org/ja/docs.html">ドキュメント</a> を読んだ上で
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt; まで (英語で) 連絡してください。<br></br>
    本文書に関する質問については、
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt; まで電子メールを (英語で) 送ってください。</small></p></body></html>