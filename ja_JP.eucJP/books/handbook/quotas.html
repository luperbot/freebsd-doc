<?xml version="1.0" encoding="euc-jp" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=euc-jp" /><title>16.12. ファイルシステムクォータ</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD ハンドブック" /><link rel="up" href="disks.html" title="第16章 ストレージ" /><link rel="prev" href="snapshots.html" title="16.11. ファイルシステムのスナップショット" /><link rel="next" href="disks-encrypting.html" title="16.13. ディスクパーティションの暗号化" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">16.12. ファイルシステムクォータ</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="snapshots.html">戻る</a>〓</td><th width="60%" align="center">第16章 ストレージ</th><td width="20%" align="right">〓<a accesskey="n" href="disks-encrypting.html">次へ</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="quotas"></a>16.12. ファイルシステムクォータ</h2></div></div></div><a id="idp91751888" class="indexterm"></a><a id="idp91753040" class="indexterm"></a><p>クォータは OS の持っているオプショナルな機能であり、
      ファイルシステム毎にユーザやグループのメンバが使用するディスク容量やファイルの数を制限することができます。
      この機能は、あるユーザやグループに割り当てられるリソースの量を制限することが望ましいようなタイムシェアリングシステムにおいてよく用いられます。
      この機能を用いることによって使用可能なディスク容量の全てを一人のユーザやユーザのグループが使ってしまうことを防ぐことができます。</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91753936"></a>16.12.1. ディスククォータを使うためのシステム設定</h3></div></div></div><p>ディスククォータの設定を始める前に、
	まずはカーネルにクォータが組み込まれていることを確認しましょう。
	カーネルのコンフィグレーションファイルに次の行を入れます。</p><pre class="programlisting">options QUOTA</pre><p>標準の <code class="filename">GENERIC</code> カーネルでは、
	この機能は有効になっていませんので、
	ディスククォータを利用するためには上記を設定後カーネルを構築しなおし、
	作成されたカスタムカーネルをインストールしなければいけません。
	カーネルのコンフィグレーションに関しては
	<a class="xref" href="kernelconfig.html" title="第9章 FreeBSD カーネルのコンフィグレーション">9章<em>FreeBSD カーネルのコンフィグレーション</em></a> をご覧ください。</p><p>次に <code class="filename">/etc/rc.conf</code>
	でディスククォータを有効にする必要があります。
	次の行を加えましょう。</p><pre class="programlisting">enable_quotas="YES"</pre><a id="idp91757776" class="indexterm"></a><p>起動時の動作をさらに細かくコントロールするためにもう一つ設定用の変数があります。
	通常、起動時には <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quotacheck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">quotacheck</span>(8)</span></a>
	によりそれぞれのファイルシステムのクォータの整合性がチェックされます。
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quotacheck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">quotacheck</span>(8)</span></a> の役割は、
	クォータデータベースのデータが正しくファイルシステム上のデータを反映しているか確認することです。
	これはかなり時間を食う処理であり、
	起動にかかる時間に大きな影響を及ぼします。
	このステップをとばしたい人のために
	<code class="filename">/etc/rc.conf</code> に次の変数が用意されています。</p><pre class="programlisting">check_quotas="NO"</pre><p>もし 3.2-RELEASE よりも前の FreeBSD
	を使っているならば設定はもっと単純で、一つの変数のみです。
	次の行を <code class="filename">/etc/rc.conf</code> で設定してください。</p><pre class="programlisting">check_quotas="YES"</pre><p>最後に、ファイルシステム毎にディスククォータを有効にするために
	<code class="filename">/etc/fstab</code> を編集する必要があります。
	ここでユーザもしくはグループ、
	あるいはその両方にクォータを設定することができるのです。</p><p>あるファイルシステム上にユーザ毎のクォータを有効にする場合には、
	<code class="filename">/etc/fstab</code>
	中でクォータを有効にしたいファイルシステムエントリのオプション部に
	<code class="option">userquota</code> を加えます。
	例えば次のようになります。</p><pre class="programlisting">/dev/da1s2g   /home    ufs rw,userquota 1 2</pre><p>同様に、グループクォータを有効にするには
	<code class="option">userquota</code> キーワードの代わりに
	<code class="option">groupquota</code> を用います。
	ユーザとグループの両方のクォータを有効にするには次のようにします。</p><pre class="programlisting">/dev/da1s2g    /home    ufs rw,userquota,groupquota 1 2</pre><p>デフォルトでは、
	クォータファイルはそのファイルシステムのルートディレクトリに
	ユーザ用、グループ用それぞれ
	<code class="filename">quota.user</code>, <code class="filename">quota.group</code>
	という名前で置かれます。さらに詳しい情報は <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fstab&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">fstab</span>(5)</span></a>
	をご覧ください。<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fstab&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">fstab</span>(5)</span></a>
	マニュアルには別の場所を指定することができると書いてはありますが、
	あまり勧められません。なぜなら、
	様々なクォータ関係のユーティリティがそれにうまく対処できるようにないためです。</p><p>この時点で、
	一度システムを再起動して新しいカーネルで立ち上げましょう。
	<code class="filename">/etc/rc</code> が自動的に適当なコマンドを実行し、
	<code class="filename">/etc/fstab</code>
	で有効にした全てのクォータ用に初期ファイルを作ってくれます。
	従って、空のクォータファイルを手で作る必要は一切ありません。</p><p>通常の運用では <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quotacheck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">quotacheck</span>(8)</span></a> や
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quotaon&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">quotaon</span>(8)</span></a>, <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quotaoff&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">quotaoff</span>(8)</span></a>
	といったコマンドを手で動かす必要はないのですが、
	慣れるためにもこれらのマニュアルは読んでおきましょう。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91785936"></a>16.12.2. クォータリミットの設定</h3></div></div></div><a id="idp91786576" class="indexterm"></a><p>一旦クォータを有効にしたら本当に有効になっているのか確認しておきましょう。簡単な方法は次のコマンドを実行することです。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>quota -v</code></strong></pre><p>ディスクの使用状況と、クォータが有効になっているファイルシステムのクォータリミットが一行にまとめて出力されるでしょう。</p><p>さあ、<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=edquota&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">edquota</span>(8)</span></a> でクォータリミットを設定する準備ができました。</p><p>ユーザやグループが使用できるディスク容量や作成できるファイルの数に制限をかけるにはいくつかのオプションがあります。割り当てディスク容量を制限
	(ブロッククォータ) することもファイル数を制限 (inode クォータ)
	することも、両者を組み合わせることもできるのです。
	これらの制限はそれぞれさらに二つのカテゴリ、
	ハードリミットとソフトリミット、に分けることができます。</p><a id="idp91790928" class="indexterm"></a><p>ハードリミットを越えることはできません。
	あるユーザが一旦ハードリミットにたっした場合、
	そのファイルシステムではそれ以上の割り当ては望めません。
	例えばあるファイルシステム上に
	500 ブロックのハードリミットが設定されており現在
	490 ブロックを使用している場合、さらに 10 ブロックしか使えないのです。
	11 ブロックを使おうとすると失敗します。</p><a id="idp91796048" class="indexterm"></a><p>一方、
	ソフトリミットはある限られた時間内であれば越えることができます。
	この時間は猶予期間として知られており、デフォルトでは 1 週間です。
	あるユーザが自分のソフトリミットを猶予期間よりも長い間越えているとソフトリミットはハードリミットに変わり、それ以上使用することはできなくなります。
	ユーザがソフトリミットよりも減らせば猶予期間はリセットされます。</p><p>以下は <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=edquota&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">edquota</span>(8)</span></a>
	コマンドを実行した時に見ることになるであろう例です。
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=edquota&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">edquota</span>(8)</span></a> コマンドが起動されると環境変数
	<code class="envar">EDITOR</code> で指定されるエディタに入ります。
	<code class="envar">EDITOR</code> が設定されていない場合には
	<span class="application">vi</span> が起動されます。
	ここでクォータリミットを編集します。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>edquota -u test</code></strong></pre><pre class="programlisting">Quotas for user test:
/usr: blocks in use: 65, limits (soft = 50, hard = 75)
        inodes in use: 7, limits (soft = 50, hard = 60)
/usr/var: blocks in use: 0, limits (soft = 50, hard = 75)
        inodes in use: 0, limits (soft = 50, hard = 60)</pre><p>通常、クォータが有効になっているファイルシステム毎に 2 行あります。
	一つはブロックリミット用でもう一つは inode リミット用です。
	クォータリミットを変更したいところを書き変えるだけでかまいません。
	たとえばこのユーザのブロックリミットを、ソフトリミットは 50 から 500
	へ、ハードリミットは 75 から 600 に変更する場合、</p><pre class="programlisting">/usr: blocks in use: 65, limits (soft = 50, hard = 75)</pre><p>から</p><pre class="programlisting"> /usr: blocks in use: 65, limits (soft = 500, hard = 600)</pre><p>へ書き換えます。新しいクォータリミットはエディタを終了すれば設定されます。</p><p>ある範囲の UID
	に対してクォータリミットを設定したい場合がありますが、このような時には
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=edquota&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">edquota</span>(8)</span></a> コマンドの <code class="option">-p</code>
	オプションを使うといいでしょう。まず、
	あるユーザに割り当てたいクォータリミットを設定し、次に
	<code class="command">edquota -p protouser startuid-enduid</code>
	を実行するのです。例えばユーザ <code class="systemitem">test</code>
	にお望みのクォータリミットが付いているとしましょう。
	次のコマンドにより 10,000 から 19,999 の間の UID
	に対して同じクォータリミットを付けることができるのです。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>edquota -p test 10000-19999</code></strong></pre><p>さらに詳しいことは <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=edquota&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">edquota</span>(8)</span></a> のマニュアルページをご覧ください。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91812048"></a>16.12.3. クォータリミットとディスク使用状況のチェック</h3></div></div></div><a id="idp91812688" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quota&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">quota</span>(1)</span></a> または <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=repquota&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">repquota</span>(8)</span></a>
	といったコマンドを使ってクォータリミットやディスクの利用状況を確認することができます。
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quota&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">quota</span>(1)</span></a> コマンドは個々のユーザやグループのクォータやディスク利用状況を確認するのに使えます。
	ユーザは自身のクォータ、そして所属するグループのグループのみ確認することができます。
	スーパーユーザのみが他のユーザや所属していないグループのクォータと利用状況を見ることができます。
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=repquota&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">repquota</span>(8)</span></a> コマンドを使うと、クォータが有効になっているファイルシステム用の全てのクォータやディスク容量のサマリを得ることができます。</p><p>以下は二つのファイルシステムにクォータ制限がかけられているユーザに対する<code class="command">quota -v</code> コマンドの出力例です。</p><pre class="programlisting">Disk quotas for user test (uid 1002):
     Filesystem  blocks   quota   limit   grace   files   quota   limit   grace
           /usr      65*     50      75   5days       7      50      60
       /usr/var       0      50      75               0      50      60</pre><a id="idp91822544" class="indexterm"></a><p>上の例で、<code class="filename">/usr</code>
	ファイルシステム上ではこのユーザは現在
	50 ブロックというソフトリミットを 15 ブロックオーバーし
	5 日間の猶予期間が残っています。アスタリスク <code class="literal">*</code>
	はクォータリミットを越えているユーザを示していることに注意してください。</p><p>通常、そのユーザが全く使っていないファイルシステムは、
	クォータリミットが付けられているとしても
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quota&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">quota</span>(1)</span></a> コマンドの出力には現われません。
	<code class="option">-v</code> オプションを用いればそのようなファイルシステム、
	上の例では <code class="filename">/usr/var</code>、
	を表示することができます。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp91826256"></a>16.12.4. NFS 上の クォータ</h3></div></div></div><a id="idp91826896" class="indexterm"></a><p>クォータは NFS サーバ上のクォータサブシステムにより実行されます。
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rpc.rquotad&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">rpc.rquotad</span>(8)</span></a> デーモンにより、NFS クライアント上の <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=quota&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">quota</span>(1)</span></a>
	コマンドは情報を得ることができ、クライアントマシン上のユーザが自分のクォータの統計を見ることができます。</p><p><code class="filename">/etc/inetd.conf</code> において以下のように
	<code class="command">rpc.rquotad</code> を有効にしましょう。</p><pre class="programlisting">rquotad/1      dgram rpc/udp wait root /usr/libexec/rpc.rquotad rpc.rquotad</pre><p>そして以下のように <code class="command">inetd</code> を再起動します。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kill -HUP `cat /var/run/inetd.pid`</code></strong></pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="snapshots.html">戻る</a>〓</td><td width="20%" align="center"><a accesskey="u" href="disks.html">上に戻る</a></td><td width="40%" align="right">〓<a accesskey="n" href="disks-encrypting.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">16.11. ファイルシステムのスナップショット〓</td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top">〓16.13. ディスクパーティションの暗号化</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文書、および他の文書は
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>
    からダウンロードできます。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>FreeBSD に関する質問がある場合には、
    <a href="http://www.FreeBSD.org/ja/docs.html">ドキュメント</a> を読んだ上で
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt; まで (英語で) 連絡してください。<br></br>
    本文書に関する質問については、
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt; まで電子メールを (英語で) 送ってください。</small></p></body></html>