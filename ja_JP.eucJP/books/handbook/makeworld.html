<?xml version="1.0" encoding="euc-jp" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=euc-jp" /><title>18.6. world の再構築</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD ハンドブック" /><link rel="up" href="updating-upgrading.html" title="第18章 FreeBSD のアップデートとアップグレード" /><link rel="prev" href="synching.html" title="18.5. ソースの同期" /><link rel="next" href="small-lan.html" title="18.7. 複数のマシンで追いかける" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">18.6. world の再構築</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="synching.html">戻る</a>〓</td><th width="60%" align="center">第18章 FreeBSD のアップデートとアップグレード</th><td width="20%" align="right">〓<a accesskey="n" href="small-lan.html">次へ</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="makeworld"></a>18.6. world の再構築</h2></div></div></div><a id="idp92752848" class="indexterm"></a><p>FreeBSD-STABLE、FreeBSD-CURRENT などの
      FreeBSD のどれか特定のバージョンについて、
      ローカルのソースツリーを同期させたら、
      そのソースツリーを使ってシステムを再構築できます。
      このプロセスは world の再構築と呼ばれます。</p><p>world を再構築する<span class="emphasis"><em>前</em></span>に、
      以下を行ってください。</p><div class="procedure"><a id="idp92755024"></a><div class="procedure-title">手順18.1 world の構築<span class="emphasis"><em>前</em></span>に行う作業</div><ol class="procedure" type="1"><li class="step"><p>重要なデータを他のシステムやリムーバブルメディアにバックアップし、
	  きちんとバックアップが作成されていることを確認したら、
	  起動可能なインストールメディアを用意してください。
	  システムを再構築する<span class="emphasis"><em>前に</em></span>、
	  バックアップを作成することの重要性は、
	  いくら強調してもし過ぎると言うことはありません。
	  システム全体の再構築は難しい作業ではありませんが、
	  どんなに注意していたとしても、
	  ソースツリーそのものに手違いがあった時には、
	  システムが起動しなくなってしまう状態になることがあるのです。
	  多分、それを使うことはないと思いますが、
	  あとで後悔することのないよう、念のため用意しておきましょう!</p></li><li class="step"><a id="idp92757712" class="indexterm"></a><p>追いかけているブランチに応じて、
	  <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-stable" target="_top">freebsd-stable</a> もしくは <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current" target="_top">freebsd-current</a>
	  の最近のエントリを調べて、
	  既知の問題や影響を受けるシステムを確認してください。
	  既知の問題が同期しているバージョンのコードに影響する場合は、
	  その問題が解決されたことを報告する
	  <span class="quote">「<span class="quote">問題解決 (all clear)</span>」</span>
	  のアナウンスが投稿されるまで待ってから、ソースを同期して、
	  ローカルのソースに必要な修正を入れてください。</p></li><li class="step"><p><code class="filename">/usr/src/UPDATING</code> を読み、
	  同期しているソースのバージョンで必要となるステップがないかどうかを調べて下さい。
	  このファイルには潜在的な問題や特定のコマンドを実行する順などの重要な情報が含まれています。
	  大きなアップグレードでは、world
	  をインストールする前に特定のファイルの名前を変更したり、
	  削除するといった、特別なステップが追加で必要となることがあります。
	  ファイルの最後には、
	  現在推奨されているアップグレードの手順が詳しく正確に説明されています。
	  もし、<code class="filename">UPDATING</code> に書かれている手順が、
	  この節に書かれているものと矛盾していたら、
	  <code class="filename">UPDATING</code> の手順を採用してください。</p></li></ol></div><div xmlns="" class="warning"><h3 class="admontitle"><code xmlns="http://www.w3.org/1999/xhtml" class="command">make world</code> は使わないこと: </h3><p xmlns="http://www.w3.org/1999/xhtml">古いドキュメントの中には、
	<code class="command">make world</code> を使うことを薦めているものがあります。
	これは、重要な手順をいくつか抜かしてしまうので、
	エキスパートでなければ使うべきではありません。
	ほぼあらゆる場合において、<code class="command">make world</code>
	を実行するのは間違っており、
	ここで説明されている手順を用いるべきです。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="canonical-build"></a>18.6.1. システム更新の概要</h3></div></div></div><p>world の構築では、<a class="xref" href="synching.html" title="18.5. ソースの同期">「ソースの同期」</a>
	に書かれている手順で入手したソースを用いて、
	古い FreeBSD のバージョンをアップデートします。</p><p>FreeBSD では、<span class="quote">「<span class="quote">world</span>」</span> は、
	カーネル、コアシステムのバイナリ、
	ライブラリ、プログラミングファイル、組み込みのコンパイラを意味します。
	これらのコンポーネントの構築およびインストールの順番は重要です。</p><p>例えば、古いコンパイラは、
	バグを含み、新しいカーネルをコンパイルできない可能性があります。
	そのため、新しいカーネルは新しいコンパイラで構築しなければならないので、
	新しいコンパイラの構築が必要となりますが、
	必ずしも、
	新しいコンパイラがインストールされている必要はありません。</p><p>新しい world は、
	新しいカーネルの機能に依存している可能性があるので、
	新しい world をインストールする前に、
	新しいカーネルがインストールされていなければなりません。
	古い world は、新しいカーネルでは正しく動かないかも知れません。
	そのため、新しいカーネルをインストールしたら、
	直ちに新しい world をインストールしてください。</p><p>設定の中には、新しい world
	をインストールする前に変更すべきものがありますが、
	古い world を壊す可能性があります。
	そのため、設定のアップデートは 2 つの手順で行われます。
	多くの場合、アップデートのプロセスは、ファイルを置き換えたり、
	追加のみを行い、古いファイルを削除しません。
	このことが問題を引き起こす可能性があるため、
	<code class="filename">/usr/src/UPDATING</code> には、
	手動で削除すべきファイルをどのステップで削除すべきかが書かれています。</p><p>これらを配慮した結果、以下で説明するアップグレードの推奨手順が作られました。</p><div xmlns="" class="note"><h3 class="admontitle">注記: </h3><p xmlns="http://www.w3.org/1999/xhtml"><code class="command">make</code> を実行したときの出力は、
	  ファイルに保存すると良いでしょう。
	  何か障害が発生した場合には、エラーメッセージのコピーを
	  FreeBSD メーリングリストに投稿してください。</p><p xmlns="http://www.w3.org/1999/xhtml">ファイルに保存する最も簡単な方法は、
	  引数として出力の保存先のファイル名を指定して
	  <code class="command">script</code> コマンドを使うことです。
	  <code class="filename">/tmp</code> は、
	  再起動をすると削除されてしまう可能性があるので、
	  このディレクトリには出力を保存しないようにしてください。
	  出力の保存には、<code class="filename">/var/tmp</code> が適しています。
	  次のコマンドを world の構築の直前に行ない、再構築が終了したら
	  <strong class="userinput"><code>exit</code></strong> と入力してください。</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>script <em class="replaceable"><code>/var/tmp/mw.out</code></em></code></strong>
Script started, output file is /var/tmp/mw.out</pre></div><div class="procedure"><a id="idp92797648"></a><div class="procedure-title">手順18.2 world の構築プロセスの概要</div><p>world の構築プロセスで用いられるコマンドは、
	  ここで示されている順番で実行してください。
	  この節では各コマンドの機能についてまとめます。</p><ol class="procedure" type="1"><li class="step"><p>システム上で world の構築が一度でも行われたのであれば、
	    前回の構築の際のコピーが
	    <code class="filename">/usr/obj</code>
	    に存在するはずです。
	    このディレクトリが存在しているのであれば、
	    このディレクトリを削除することで
	    <code class="command">make buildworld</code> の行程にかかる時間を短縮し、
	    依存問題に悩まされるようなトラブルを回避できます。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chflags -R noschg /usr/obj/*</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>rm -rf /usr/obj</code></strong></pre></li><li class="step"><p>新しいコンパイラと関連ツールを最初にコンパイルし、
	    その後、新しいコンパイラで、
	    新しい world の残りの部分をコンパイルします。
	    コンパイルされたものは、
	    <code class="filename">/usr/obj</code> に格納されます。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make buildworld</code></strong></pre></li><li class="step"><p>コンパイラとカーネルのミスマッチを防ぐため、
	    <code class="filename">/usr/obj</code>
	    にある新しいコンパイラを用いて新しいカーネルを構築します。
	    再構築は、ある種のメモリ構造体が変更されたような場合には必須で、
	    <code class="command">ps</code> や <code class="command">top</code>
	    のようなプログラムは、
	    カーネルとソースコードのバージョンが一致しないと正常に動作しないでしょう。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make buildkernel</code></strong></pre></li><li class="step"><p>新しくアップデートされたカーネルで起動できるように、
	    新しいカーネルとカーネルモジュールをディスク上に配置します。
	    <code class="varname">kern.securelevel</code> を 1 より大きくしていて、
	    <span class="emphasis"><em>かつ</em></span> カーネルのバイナリファイルに
	    <code class="literal">noschg</code> のようなフラグを設定している場合は、
	    まず、シングルユーザモードに移行してください。
	    それ以外の場合は、
	    マルチユーザモードでこれらのコマンドを問題なく動かせるはずです。
	    <code class="varname">kern.securelevel</code> について詳しくは
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=init&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">init</span>(8)</span></a> を、ファイルに対するさまざまなフラグについて詳しくは
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=chflags&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">chflags</span>(1)</span></a> をご覧ください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make installkernel</code></strong></pre></li><li class="step"><p>すでに実行されているソフトウェアをアップデートする際の問題を最小限にするため、シングルユーザモードに移行してください。
	    シングルユーザモードに移行することにより、
	    新しいカーネル上で古い world
	    が実行される際の問題も最小限にします。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>shutdown now</code></strong></pre><p>シングルユーザモードに移行したら、UFS
	    でフォーマットされているシステムでは、
	    以下のコマンドを実行してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -u /</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -a -t ufs</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>swapon -a</code></strong></pre><p>もしシステムが ZFS でフォーマットされている場合には、
	    以下の 2 つのコマンドを実行してください。
	    この例では、zpool の名前は <code class="literal">zroot</code>
	    であると仮定します。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>zfs set readonly=off zroot</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>zfs mount -a</code></strong></pre></li><li class="step"><p>オプション: もし、デフォルトの US English
	    以外のキーボードマップが必要であれば、
	    <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=kbdmap&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">kbdmap</span>(1)</span></a> で変更してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kbdmap</code></strong></pre></li><li class="step"><p>その後、どちらのファイルシステムでも、
	    <acronym class="acronym">CMOS</acronym> クロックが地域時間に設定されていて
	    GMT ではない場合
	    (<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=date&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">date</span>(1)</span></a> が正しい時間と地域を表示しないなら当てはまります)
	    には、次のコマンドを実行してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>adjkerntz -i</code></strong></pre></li><li class="step"><p>システムの再構築では、
	    <code class="filename">/etc</code>,
	    <code class="filename">/var</code> や
	    <code class="filename">/usr</code>
	    といったディレクトリに新規に導入されたファイルや、
	    変更された設定ファイルに対する更新は行なわれません。
	    次に、新しい world
	    に対する <code class="filename">/etc</code>
	    の最初の設定ファイルのアップデートを行います。
	    以下のコマンドは
	    <code class="buildtarget">installworld</code>
	    に成功するために本質的なファイルのみを比較します。
	    たとえば、
	    このステップでは、最後のアップデート後に FreeBSD に追加された、
	    新しいグループや新しいシステムアカウント、
	    もしくはスタートアップスクリプトがシステムに追加されることがあります。
	    次のコマンドに関する詳細な情報については、
	    <a class="xref" href="makeworld.html#mergemaster" title="18.6.4. 設定ファイルの同期">「設定ファイルの同期」</a> を参照してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mergemaster -iF</code></strong></pre></li><li class="step"><p><code class="filename">/usr/obj</code>
	    にある新しい world
	    およびシステムのバイナリをインストールします。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make installworld</code></strong></pre></li><li class="step"><p>残りの設定ファイルをアップデートします。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mergemaster -p</code></strong></pre></li><li class="step"><p>使われなくなったファイルを削除します。
	    もし使われなくなったファイルがディスクに残っていると、
	    問題が起きる可能性があるため重要な作業です。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make delete-old</code></strong></pre></li><li class="step"><p>再起動を行い、新しいカーネル、
	    world そして設定ファイルをロードします。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>reboot</code></strong></pre></li><li class="step"><p>古いライブラリを削除する前に、
	    <a class="xref" href="ports-using.html#ports-upgrading" title="5.5.3. ports のアップグレード">「ports のアップグレード」</a>
	    に書かれている手順にしたがって、
	    すべての ports を再構築する必要があります。
	    再構築が終わったら、新しいライブラリと競合することを避けるため、
	    使われなくなったライブラリを削除します。
	    この過程に関する詳細については、<a class="xref" href="makeworld.html#make-delete-old" title="18.6.5. 使われなくなったファイル、ライブラリの削除">「使われなくなったファイル、ライブラリの削除」</a>
	    を参照して下さい。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make delete-old-libs</code></strong></pre></li></ol></div><a id="idp92851792" class="indexterm"></a><p>もしシステムがダウンタイムを持つことができるのであれば、
	システムのコンパイルをマルチユーザモードでおこない、
	インストールのためにシングルユーザモードに移行するという方法ではなく、
	コンパイルをシングルユーザモードで行うことを考えてください。
	システムの再インストールでは、たくさんの重要なシステムファイル、
	すべての標準的なシステムバイナリ、ライブラリ、
	インクルードファイルが変更されるので、
	実際に動作しているシステムにおいて、
	特にアクティブなユーザは、トラブルに見舞われる可能性があります。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="src-updating"></a>18.6.2. 設定ファイル</h3></div></div></div><a id="idp92857808" class="indexterm"></a><p>world
	の構築プロセスでは、いくつかの設定ファイルが使われます。</p><p><code class="filename">/usr/src</code> に置かれている、
	<code class="filename">Makefile</code> には、
	FreeBSD を構成するプログラムの構築方法や、
	どういう順番でそれらを構築すべきかといった指示が記述されています。</p><p><code class="command">make</code> で利用可能なオプションの説明は
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">make.conf</span>(5)</span></a> や、共通の例が
	<code class="filename">/usr/share/examples/etc/make.conf</code> にあります。
	これらの設定を <code class="filename">/etc/make.conf</code> に追加すると、
	<code class="command">make</code> の実行やプログラムの構築方法を設定できます。
	これらのオプションは、
	<code class="command">make</code> が使われる際には常に有効となるため、
	Ports Collection からアプリケーションをコンパイルする時、
	ユーザが書いた C プログラムや FreeBSD
	オペレーティングシステムを構築する際に影響を及ぼします。
	ある設定を変更したことにより、影響が広い範囲におよび、
	驚くべき結果をもたらす可能性があります。
	両方のファイルに書かれているコメントを読むことと、
	デフォルトの設定は、パフォーマンスと安全性の観点から選ばれていることを覚えておいてください。</p><a id="idp92863056" class="indexterm"></a><p><code class="filename">/etc/src.conf</code> は、
	ソースコードを用いたオペレーティングシステムの構築をコントロールします。
	<code class="filename">/etc/make.conf</code> とは異なり、
	<code class="filename">/etc/src.conf</code> に書かれた設定は、
	FreeBSD オペレーティングシステムそのものを構築するときにのみ影響します。
	このファイルで設定可能な多くのオプションについては、
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=src.conf&amp;sektion=5"><span class="citerefentry"><span class="refentrytitle">src.conf</span>(5)</span></a> に記述されています。
	一見したところ無効にされている、
	使われていないカーネルモジュールやビルドオプションに注意してください。
	ときどき予期しなかったり、わずかな影響を与えることがあります。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="make-buildworld"></a>18.6.3. 変数とターゲット</h3></div></div></div><p><code class="command">make</code> の使用における一般的な書式は、
	次のとおりです。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -<em class="replaceable"><code>x</code></em> -D<em class="replaceable"><code>VARIABLE</code></em> <em class="replaceable"><code>target</code></em></code></strong></pre><p>この例では、<code class="option">-<em class="replaceable"><code>x</code></em></code> が
	<code class="command">make</code> に渡されるオプションになります。
	利用可能なオプションについては、<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>
	を参照してください。</p><p>変数を渡すには、変数の名前を
	<code class="option">-D<em class="replaceable"><code>VARIABLE</code></em></code>
	のように指定してください。
	この変数は <code class="filename">Makefile</code> の動作をコントロールします。
	変数の指定は、<code class="filename">/etc/make.conf</code> で設定するか、
	<code class="command">make</code> の実行時に指定するかのどちらかで行います。
	たとえば、以下の変数は、プロファイル版のライブラリを構築しないことを指定します。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -DNO_PROFILE <em class="replaceable"><code>target</code></em></code></strong></pre><p>これは、<code class="filename">/etc/make.conf</code>
	の中で以下のように設定することに対応します。</p><pre class="programlisting">NO_PROFILE=    true     #    Avoid compiling profiled libraries</pre><p><em class="replaceable"><code>target</code></em> は、<code class="command">make</code> に
	どのように動作するのかを指示するためのものです。
	<code class="filename">Makefile</code> は利用可能なターゲットを定義しています。
	ターゲットには、
	システムの再構築に必要な段階を、
	多くのさらに細かい段階に分割するため、
	構築の過程で利用されるものがあります。</p><p>選択肢が分けられていることは、二つの理由から有用です。
	まず第一に、構築作業は稼働中のシステムにまったく影響を与えません。
	そのため、マルチユーザモードで稼働中のシステムでも、安全に
	<code class="buildtarget">buildworld</code> を実行できます。
	ただし、<code class="buildtarget">installworld</code> は
	シングルユーザモードで行なうことをおすすめします。</p><p>第二に、<acronym class="acronym">NFS</acronym> マウントを利用することで、<a class="xref" href="small-lan.html" title="18.7. 複数のマシンで追いかける">「複数のマシンで追いかける」</a> で説明されているように、
	ネットワーク上の複数のマシンをアップグレードすることが可能な点があげられます。</p><p><code class="command">make</code> に
	<code class="option">-j</code> をつけると、
	同時に複数のプロセスを生成できます。
	構築過程の大部分では <acronym class="acronym">CPU</acronym> 性能の限界より
	<acronym class="acronym">I/O</acronym> 性能の限界の方が問題となるため、
	シングル <acronym class="acronym">CPU</acronym> とマルチ <acronym class="acronym">CPU</acronym>
	マシンの両方に効果があります。</p><p>普通のシングル <acronym class="acronym">CPU</acronym> マシンで以下のコマンド
	を実行すると、最大 4 個までのプロセスを同時に実行します。
	メーリングリストに投稿された経験的な報告によると、
	4 個という指定が最も良いパフォーマンスを示すようです。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -j4 buildworld</code></strong></pre><p>マルチ <acronym class="acronym">CPU</acronym> マシンでは、
	<code class="literal">6</code> から <code class="literal">10</code> の間の値を設定し、
	速度がどれくらい向上するか確認してみてください。</p><a id="idp92894416" class="indexterm"></a><div xmlns="" class="note"><h3 class="admontitle">注記: </h3><p xmlns="http://www.w3.org/1999/xhtml"><code class="command">make buildworld</code>
	  に変数を指定した場合は、同じ指定を
          <code class="command">make installworld</code> にも指定しなければなりません。
	  ただし <code class="buildtarget">installworld</code>
	  では、<code class="option">-j</code> を
	  <span class="emphasis"><em>絶対に使ってはいけません</em></span>。</p><p xmlns="http://www.w3.org/1999/xhtml">たとえば、以下のコマンドを実行したなら、</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -DNO_PROFILE buildworld</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">以下のようにしてインストールしなければなりません。</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -DNO_PROFILE installworld</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">もしそうしなかった場合、2 番目のコマンドは、
          <code class="command">make buildworld</code>
	  の段階で構築されていないプロファイル版ライブラリをインストールしようとしてしまうでしょう。</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="mergemaster"></a>18.6.4. 設定ファイルの同期</h3></div><div><span class="authorgroup">寄稿: <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="surname">Rhodes</span> <span class="firstname">Tom</span> [FAMILY Given]</span>. </span></div></div></div><a id="idp92909648" class="indexterm"></a><p>FreeBSD の <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> Bourne シェルスクリプトは、
	<code class="filename">/etc</code> にある設定ファイルと、
	<code class="filename">/usr/src/etc</code>
	にある設定ファイルの違いを確認するためのものです。
	システムの設定ファイルをソースツリーにある設定ファイルにアップデートするには、
        この方法を使用してください。</p><p><code class="command">mergemaster</code> を使う前に、
	既存の <code class="filename">/etc</code>
	をどこか安全な場所にコピーしておきましょう。
	再帰的なコピーを行なう <code class="option">-R</code> と、
	ファイルの更新時間や所有者などを保存する
	<code class="option">-p</code> と共に実行してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp -Rp /etc /etc.old</code></strong></pre><p><code class="command">mergemaster</code> を実行すると、
	<code class="filename">/</code> を起点とした一時的なルート環境を構築し、
	さまざまなシステム設定ファイルを
	(訳注: デフォルトでは <code class="filename">/var/tmp/temproot</code> に)
	置いていきます。
	これらのファイルは現在システムにインストールされているファイルと比較されます。
	異なるファイルは <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a> 形式で示され、
	<code class="option">+</code> の記号は追加または変更された行を表し、
	<code class="option">-</code> は完全に削除されたか新しく置き換えられた行を表します。
	ファイルの違いの表示方法についてのより詳しい情報は、
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">diff</span>(1)</span></a> を参照してください。</p><p>次に <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mergemaster</span>(8)</span></a> は違いのあるファイルをそれぞれ示し、
	選択可能なオプションを表示します。
	ここでは、新しいファイルを削除するか、
	一時ファイルをそのままインストールするか、
	一時ファイルと現在インストールされているファイルを統合するか、
	もしくは結果をもう一度見るかを選択できます。</p><p>一時ファイルの削除を選ぶと、<code class="command">mergemaster</code>
	に現在のファイルを変更しないで新しいバージョンを削除せよと伝えます。
	この選択は、お勧めできません。
	<code class="command">mergemaster</code>
	のプロンプトで <span class="keycap"><strong>?</strong></span> とタイプすれば、
	いつでもヘルプが見られます。
	ファイルのスキップを選ぶと、他のすべてのファイルを終えたあと、
	もう一度そのファイルが提示されます。</p><p>一時ファイルをそのままインストールすることを選ぶと、
	現在のファイルを新しいファイルで置き換えます。
	ほとんどの手を加えていないファイルは、
	これが一番よい選択です。</p><p>ファイルの統合を選んだ場合、
	テキストエディタが起動され、両方のファイルの中身が提示されます。
	画面上に並ぶ両方のファイルを見て新しいファイルを作成するために両方から必要な部分を選択し、
	2 つのファイルを統合することができます。
	並んでいるファイルを比較するとき、
	<span class="keycap"><strong>l</strong></span> で左側の中身を選択し、
	<span class="keycap"><strong>r</strong></span> で右側の中身を選択します。
	最終出力は左右両方の部分でできたファイルになるでしょう。
	このファイルをインストールすることができます。
	たいてい、このオプションはユーザが設定を変更したファイルに使われます。</p><p>結果をもう一度見る、を選択すると、
	ファイルの相異点をもう一度見ることができます。</p><p><code class="command">mergemaster</code>
	がシステムファイルの比較を終えたあと、
	他のオプションについてもプロンプトが表示されます。
	たとえば、
	パスワードファイルを再構築するかどうかを尋ねることがあります。
	最後に残った一時ファイルを削除するかどうかを尋ねて終了します。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="make-delete-old"></a>18.6.5. 使われなくなったファイル、ライブラリの削除</h3></div><div><span class="authorgroup">ベースとなったノートの提供: <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="surname">Shterenlikht</span> <span class="firstname">Anton</span> [FAMILY Given]</span>. </span></div></div></div><a id="idp92953424" class="indexterm"></a><p>FreeBSD の開発サイクルにおいて、
	ファイルやシステムの一部が使われなくなることがあります。
	それらの機能が別の場所で実装されたり、
	ライブラリのバージョン番号が変わったり、
	システムから完全に削除されることがあるためです。
	システムのアップデート時に削除が必要になるのは、
	古いファイル、ライブラリそしてディレクトリです。
	これらのファイルを削除することで、
	記憶媒体やバックアップ媒体において不必要な容量を占めている古いファイルが、
	システム上に散乱することがなくなります。
	また、古いライブラリのセキュリティや安定性に問題があると、
	ライブラリを新しくしてシステムを安定な状態にし、
	古いライブラリによりシステムがクラッシュすることを防がなければなりません。
	使われなくなったファイル、ディレクトリ、ライブラリは
	<code class="filename">/usr/src/ObsoleteFiles.inc</code>
	にまとめられています。以下の手順により、
	アップグレードの過程でこれらのファイルを削除できます。</p><p>
	<code class="command">make installworld</code>
	と、その後の <code class="command">mergemaster</code> が無事に終わったら、
	使われなくなったファイルやライブラリを確認してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make check-old</code></strong></pre><p>見つかった古いファイルは、以下のコマンドで削除できます。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make delete-old</code></strong></pre><p>使われなくなったファイルを削除する際、
	ファイルごとに確認が求められます。
	確認を省略し、自動的にファイルを削除するには、
	以下のように <code class="varname">BATCH_DELETE_OLD_FILES</code>
	を設定してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -DBATCH_DELETE_OLD_FILES delete-old</code></strong></pre><p><code class="command">yes</code>
	をコマンドへパイプでつなげても省略できます。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>yes|make delete-old</code></strong></pre><div xmlns="" class="warning"><h3 class="admontitle">Warning: </h3><p xmlns="http://www.w3.org/1999/xhtml">使われなくなったファイルを削除すると、
	  削除したファイルに依存していたアプリケーションは壊れてしまいます。
	  特に、古いライブラリを削除する場合に起こり得ます。
	  通常、<code class="command">make
	    delete-old-libs</code>
	  を実行する前に、
	  これらの古いライブラリを使っているプログラム、ports、
	  ライブラリを再構築する必要があります。</p></div><p>共有ライブラリをチェックするユーティリティとして、
	<a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/sysutils/libchk/pkg-descr">sysutils/libchk</a> や
	<a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/sysutils/bsdadminscripts/pkg-descr">sysutils/bsdadminscripts</a>
	を利用できます。</p><p>使われなくなった共有ライブラリは、
	新しいライブラリと競合し、以下のようなメッセージを表示することがあります。</p><pre class="screen">/usr/bin/ld: warning: libz.so.4, needed by /usr/local/lib/libtiff.so, may conflict with libz.so.5
/usr/bin/ld: warning: librpcsvc.so.4, needed by /usr/local/lib/libXext.so, may conflict with librpcsvc.so.5</pre><p>この問題を解決するには、
	まずライブラリがどの port によってインストールされたかを調べて下さい。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>pkg which /usr/local/lib/libtiff.so</code></strong>
  /usr/local/lib/libtiff.so was installed by package tiff-3.9.4
<code class="prompt">#</code> <strong class="userinput"><code>pkg which /usr/local/lib/libXext.so</code></strong>
  /usr/local/lib/libXext.so was installed by package libXext-1.1.1,1</pre><p>見つかった port をアンインストールし、
	再構築、再インストールしてください。
	この過程は <a xmlns="" class="package" href="http://www.freebsd.org/cgi/url.cgi?ports/ports-mgmt/portmaster/pkg-descr">ports-mgmt/portmaster</a>
	で自動化できます。
	すべての ports が再構築され、
	古いライブラリがどこにも使われていないことを確認したら、
	以下のコマンドで古いライブラリを削除してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make delete-old-libs</code></strong></pre><p>もしちょっとした問題があった場合でも、
        システムの一部を再構築するのは簡単です。
	たとえば、アップグレードや <code class="filename">/etc</code>
	のマージの途中で誤って
	<code class="filename">/etc/magic</code> を削除してしまい、
	その結果 <code class="command">file</code>
	が動作しなくなってしまったような場合には、
	次のコマンドを実行して修復してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src/usr.bin/file</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make all install</code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="updating-questions"></a>18.6.6. よくある質問</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">変更が行なわれたら、
	    その度にシステムの再構築が必要になるのでしょうか?</span></dt><dd><p>それは変更の内容によります。
	      たとえば、<span class="application">svn</span> を実行したとき、
	      次にあげるようなファイルが更新されていたとします。</p><pre class="screen"><code class="filename">src/games/cribbage/instr.c</code>
<code class="filename">src/games/sail/pl_main.c</code>
<code class="filename">src/release/sysinstall/config.c</code>
<code class="filename">src/release/sysinstall/media.c</code>
<code class="filename">src/share/mk/bsd.port.mk</code></pre><p>このときには、改めてシステム全体を再構築する必要はないでしょう。
	      そのかわり、適切なサブディレクトリに移って
	      <code class="command">make all install</code> を行ってください。
	      しかし、たとえば <code class="filename">src/lib/libc/stdlib</code>
	      のような大きな変更が行なわれた場合には、
	      システム全体を再構築することを検討してください。</p><p>2 週間ごとにシステムを再構築して、
	      その 2 週間分の変更を取り込むユーザもいますし、
	      変更のあった部分だけ再構築し、
	      すべての依存関係を確かめたいと考えるユーザもいます。
	      それらはどのくらいの頻度でアップグレードしたいか、
	      そして FreeBSD-STABLE か FreeBSD-CURRENT
	      のどちらを追いかけているのかにもよります。</p></dd><dt><span class="term">どうして
	      signal 11<a id="idp92988624" class="indexterm"></a>
	      (もしくは他のシグナル番号) のエラーがたくさん出て
	      コンパイルが失敗するのでしょうか？</span></dt><dd><p>これは通常、ハードウェアに問題があることを示しています。
	      world の再構築は、
	      ハードウェア (特にメモリ)
	      に対する負荷耐久試験を行なうための有効な手段です。
	      本当にこの問題によるものかどうかは、
	      <span class="application">make</span>
	      をもう一度実行し、異なる段階で異常終了が発生するか、
	      ということから確認できます。</p><p>このエラーに対応するには、RAM を始めとして、
	      マシンの部品をメモリから交換して、
	      どの部分が悪いのかを調べてみてください。</p></dd><dt><span class="term">終了したら <code class="filename">/usr/obj</code>
	      を削除してもかまいませんか?</span></dt><dd><p>このディレクトリには、
	      コンパイルの段階で生成された
	      すべてのオブジェクトファイルが含まれています。
	      通常 <code class="command">make buildworld</code> の最初の段階では、
	      このディレクトリを削除して新しくつくり直すようになっています。
	      構築終了後も <code class="filename">/usr/obj</code>
	      を保存しておいても、あまり意味はありません。
	      削除すれば、だいたい 2GB
	      のディスクスペースを解放することができます。</p></dd><dt><span class="term">構築を中断した場合、
	    その構築を途中から再開することはできますか?</span></dt><dd><p>それは、問題が起こるまでに、
	      どれだけの作業を終えているかによります。
	      一般的に <code class="command">make buildworld</code> は、
	      基本的なツールや、
	      システムライブラリの新しいコピーを作成します。
	      その後、これらのツールやライブラリがインストールされてから、
	      自分自身の再構築に使われ、もう一度、インストールされます。
	      システムの残りの部分がその新しいシステムファイルを用いて作り直されます。</p><p>再構築の最終段階では、
	      まったく安全に以下のコマンドを実行することができます。
	      これは、前回の <code class="command">make buildworld</code>
	      の作業をやり直しません。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make -DNO_CLEAN all</code></strong></pre><p>次のメッセージ</p><pre class="screen">--------------------------------------------------------------
Building everything..
--------------------------------------------------------------</pre><p>が <code class="command">make buildworld</code> の出力にある場合には、
	      上のようにしてもほとんど悪影響が現れることはありません。</p><p>もしこのメッセージがない場合には、
	      安全を確保し、後悔するようなことがないよう、
              システムの再構築を最初からやり直しましょう。</p></dd><dt><span class="term">make world を高速化できますか?</span></dt><dd><p>いくつかの方法で build world のプロセスを高速化できます。
	      たとえば、全体のプロセスは、
	      シングルユーザモードで動かすことで高速になります。
	      しかしながら、この方法では、プロセスが完了するまで、
	      ユーザがシステムにアクセスすることはできません。</p><p>ファイルシステムを注意深く設計したり、
	      ZFS データセットを使うことでも変わります。
	      <code class="filename">/usr/src</code> と
	      <code class="filename">/usr/obj</code>
	      を、異なるディスク上の別のファイルシステムに置くことを検討してください。
	      また可能ならば、
	      異なるディスクコントローラに接続された異なるディスクにファイルシステムを置いてください。
	      <code class="filename">/usr/src</code>
	      をマウントする時には、
	      最後にアクセスされた時刻の書き込みを抑制するように、
	      <code class="option">noatime</code>
	      オプションを付けてマウントしてください。
	      もし、<code class="filename">/usr/src</code> が、
	      独立したファイルシステムではないときには、
	      <code class="option">noatime</code> オプションで、<code class="filename">/usr</code>
	      を再マウントしてください。</p><p><code class="filename">/usr/obj</code>
	      のあるファイルシステムを、<code class="option">async</code>
	      オプションをつけてマウントもしくは再マウントしてください。
	      これによって、ディスクへの書き込みが非同期になります。
	      つまり、書き込み命令はすぐに完了するのに対し、
	      実際にデータがディスクに書き込まれるのは、その数秒後になります。
	      これによって、書き込み処理の一括化が可能になるため、
	      劇的なパフォーマンスの向上が期待できます。
	      
	    </p><div xmlns="" class="warning"><h3 class="admontitle">警告: </h3><p xmlns="http://www.w3.org/1999/xhtml">
		このオプションを指定すると、ファイルシステムは
		壊れやすくなってしまうことに注意してください。
		このオプションを付けていて、突然電源が落ちた場合には、
		再起動後にファイルシステムが復旧不能になる可能性が
		非常に高くなります。</p><p xmlns="http://www.w3.org/1999/xhtml">もし、<code class="filename">/usr/obj</code>
		が、ファイルシステムにある唯一のディレクトリであれば、
		これは問題になりません。
                しかし、同じファイルシステムに、
		他の貴重なデータを置いているときには、
		このオプションを有効にする前に、
		バックアップをきちんと取っておきましょう。</p></div><p><code class="filename">/etc/make.conf</code> に
	      <span class="quote">「<span class="quote">NO_PROFILE=true</span>」</span> をセットして、
	      プロファイル版の作成を無効化してください。</p><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> に
	      <code class="option">-j<em class="replaceable"><code>n</code></em></code>
	      を指定して、複数のプロセスを並列に実行させてください。
	      これは、単一のプロセッサでも複数のプロセッサでも、
	      同様に恩恵を得ることができます。</p></dd><dt><span class="term">なにか悪いことがあったらどうすればいいですか?</span></dt><dd><p>まず、自分の環境に前のビルドの余計なゴミが残っていないことをはっきりと確認してください。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>chflags -R noschg /usr/obj/usr</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>rm -rf /usr/obj/usr</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make cleandir</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make cleandir</code></strong></pre><p>ええ、<code class="command">make cleandir</code>
	      は本当に 2 回実行するのです。</p><p>そして、<code class="command">make buildworld</code> を行い、
	      全プロセスを最初からやり直してください。</p><p>まだ問題があれば、エラーと <code class="command">uname -a</code>
	      の出力を <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions" target="_top">FreeBSD general questions メーリングリスト</a> に送ってください。
	      設定についてさらに質問されても答えられるよう用意してください!</p></dd></dl></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="synching.html">戻る</a>〓</td><td width="20%" align="center"><a accesskey="u" href="updating-upgrading.html">上に戻る</a></td><td width="40%" align="right">〓<a accesskey="n" href="small-lan.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">18.5. ソースの同期〓</td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top">〓18.7. 複数のマシンで追いかける</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文書、および他の文書は
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>
    からダウンロードできます。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>FreeBSD に関する質問がある場合には、
    <a href="http://www.FreeBSD.org/ja/docs.html">ドキュメント</a> を読んだ上で
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt; まで (英語で) 連絡してください。<br></br>
    本文書に関する質問については、
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt; まで電子メールを (英語で) 送ってください。</small></p></body></html>