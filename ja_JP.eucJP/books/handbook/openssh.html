<?xml version="1.0" encoding="euc-jp" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=euc-jp" /><title>15.10. OpenSSH</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD ハンドブック" /><link rel="up" href="security.html" title="第15章 セキュリティ" /><link rel="prev" href="ipsec.html" title="15.9. IPsec" /><link rel="next" href="fs-acl.html" title="15.11. ファイルシステムアクセス制御リスト" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">15.10. OpenSSH</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ipsec.html">戻る</a>〓</td><th width="60%" align="center">第15章 セキュリティ</th><td width="20%" align="right">〓<a accesskey="n" href="fs-acl.html">次へ</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="openssh"></a>15.10. OpenSSH</h2></div><div><span class="authorgroup">寄稿: <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="surname">Lee</span> <span class="firstname">Chern</span> [FAMILY Given]</span>. </span></div></div></div><a id="idp90490064" class="indexterm"></a><a id="idp90490576" class="indexterm"></a><p>セキュアシェル (secure shell)
      はリモートマシンへのセキュアなアクセスに使われるネットワーク接続ツールの集合です。
      これは <code class="command">rlogin</code>,
      <code class="command">rsh</code>, <code class="command">rcp</code>,
      <code class="command">telnet</code> をそのまま置き換えて使えます。
      また、他のあらゆる TCP/IP 接続を
      ssh 経由でセキュアにトンネル/フォワードすることもできます。
      ssh はすべてのトラフィックを暗号化し、
      盗聴や接続の乗っ取り等のネットワークレベルの攻撃を事実上無効化します。</p><p>OpenSSH は OpenBSD プロジェクトによって維持管理されており、SSH v1.2.12
      に最新のすべてのバグ修正と更新を適用したものをベースにしています。
      OpenSSH クライアントは SSH プロトコル 1 と 2 の両方に互換性があります。
      OpenSSH は FreeBSD 4.0 以降ベースシステムに取り込まれています。</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90494032"></a>15.10.1. OpenSSH を使うことの利点</h3></div></div></div><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=telnet&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">telnet</span>(1)</span></a> や <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rlogin&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rlogin</span>(1)</span></a>
	を使う場合、一般にデータはネットワークを平文で流れます。
	ネットワークをクライアントとサーバの間のどこかで盗聴することで
	あなたのユーザ/パスワード情報やセション中を流れるデータを盗むことが可能です。
	OpenSSH はこれらを予防する為にさまざまな認証と暗号化の方法を提供します。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90496592"></a>15.10.2. sshd を有効にする</h3></div></div></div><a id="idp90497232" class="indexterm"></a><p><code class="filename">rc.conf</code> ファイルに
	以下の行を追加してください。</p><pre class="screen">sshd_enable="YES"</pre><p>次に起動したときから
	<span class="application">ssh</span> デーモンが起動します。
	もしくは単に <span class="application">sshd</span>
	デーモンを実行しても構いません。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90505040"></a>15.10.3. SSH クライアント</h3></div></div></div><a id="idp90505680" class="indexterm"></a><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a> ユーティリティは
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rlogin&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rlogin</span>(1)</span></a> と同様に働きます。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ssh user@example.com</code></strong>
Host key not found from the list of known hosts.
Are you sure you want to continue connecting (yes/no)? <strong class="userinput"><code>yes</code></strong>
Host 'example.com' added to the list of known hosts.
user@example.com's password: <strong class="userinput"><code>*******</code></strong></pre><p>ログインは <code class="command">rlogin</code> や <code class="command">telnet</code>
	でセッションを張った時と同様に続きます。
	SSH はクライアントが接続した時、
	サーバの信頼性の検証のために鍵指紋システム
	(key fingerprint system) を利用します。
	初めての接続の際にのみ、ユーザは <code class="literal">yes</code> と入力することを要求されます。
	これ以降の login では保存されていた鍵指紋を照合することで検証されます。
	SSH クライアントは保存されていた鍵指紋が
	login しようとした際に送られてきたものと異なっていた場合には警告を表示します。
	指紋は <code class="filename">~/.ssh/known_hosts</code> に、また
	SSH v2 指紋の場合は <code class="filename">~/.ssh/known_hosts2</code>
	に保存されます。</p><p>デフォルトでは、OpenSSH サーバは SSH v1 と SSH v2
	両方の接続を受け付けるように設定されています。
	クライアントはそのどちらかを選択できます。
	バージョン 2 は、旧バージョンよりも堅固で安全です。</p><p><code class="command">ssh</code> に、プロトコル v1 と v2
	についてそれぞれ、引数 <code class="option">-1</code> または <code class="option">-2</code>
	を渡すことで、利用するプロトコルを強制できます。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90518736"></a>15.10.4. Secure copy</h3></div></div></div><a id="idp90519376" class="indexterm"></a><a id="idp90520528" class="indexterm"></a><p><code class="command">scp</code> コマンドは
	<code class="command">rcp</code> と同様に働きます。
	安全な方法で行っているほかは、ローカルのファイルをリモートマシンへ、
	あるいはリモートマシンのファイルをローカルにコピーするのは同じです。</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code> scp user@example.com:/COPYRIGHT COPYRIGHT</code></strong>
user@example.com's password: <strong class="userinput"><code>*******</code></strong>
COPYRIGHT            100% |*****************************|  4735
00:00
<code class="prompt">#</code></pre><p>前回の例でこのホストの指紋がすでに保存されていれば
	この <code class="command">scp</code> を使う時に検証が行なわれます。</p><p><code class="command">scp</code> に渡される引数は、<code class="command">cp</code>
	のものと似ており、ファイル (1 つまたは複数) が
	1 つめの引数になり、コピー先が 2 つめの引数になります。
	ファイルはネットワーク越しに SSH を通して送られるので、
	引数に指定するファイルには
	<code class="option">user@host:&lt;path_to_remote_file&gt;</code>
	という形式をとるものがあります。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90526288"></a>15.10.5. 設定</h3></div></div></div><a id="idp90526928" class="indexterm"></a><p>システム全体の設定ファイルは、OpenSSH デーモン、
	クライアントの両方とも <code class="filename">/etc/ssh</code>
	ディレクトリにあります。</p><p><code class="filename">ssh_config</code> はクライアントの動作設定、
	<code class="filename">sshd_config</code>
	はデーモンの動作設定を行ないます。</p><p>さらに、<code class="filename">rc.conf</code> オプションの
	<code class="option">sshd_program</code>
	(デフォルトは <code class="filename">/usr/sbin/sshd</code>) と
	<code class="option">sshd_flags</code>
	により、詳細な設定が行えます。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90532048"></a>15.10.6. ssh-keygen</h3></div></div></div><p>パスワードの代わりに <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-keygen&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-keygen</span>(1)</span></a>
	を使ってユーザの認証用の RSA 暗号鍵を作ることができます。</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ssh-keygen</code></strong>
Initializing random number generator...
Generating p:  .++ (distance 66)
Generating q:  ..............................++ (distance 498)
Computing the keys...
Key generation complete.
Enter file in which to save the key (/home/user/.ssh/identity):
Enter passphrase:
Enter the same passphrase again:
Your identification has been saved in /home/user/.ssh/identity.
...</pre><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-keygen&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-keygen</span>(1)</span></a> は認証に使う為の公開鍵と秘密鍵のペアを作ります。
	秘密鍵は <code class="filename">~/.ssh/identity</code> に保存され、
	公開鍵は <code class="filename">~/.ssh/identity.pub</code> に保存されます。
	公開鍵はリモートマシンの <code class="filename">~/.ssh/authorized_keys</code>
	にも置かなければなりません。</p><p>これでパスワードの代わり
	RSA 認証を使ってリモートマシンに接続できるようになったはずです。</p><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-keygen&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-keygen</span>(1)</span></a> でパスフレーズを使っている場合は、
	ユーザは秘密鍵を使うために毎回パスフレーズの入力を行なう必要があります。</p><p>同じ目的で、<code class="command">ssh-keygen -d</code>
	(FreeBSD FreeBSD-CURRENT では
	<code class="command">ssh-keygen -t dsa</code>)
	コマンドを使って SSH v2 DSA 鍵を生成することもできます。
	これは、SSH v2 セッション専用の DSA 公開/秘密鍵を生成します。
	公開鍵は <code class="filename">~/.ssh/id_dsa.pub</code>
	に保存され、秘密鍵は <code class="filename">~/.ssh/id_dsa</code>
	に置かれます。</p><p>DSA 公開鍵はリモートマシンの
	<code class="filename">~/.ssh/authorized_keys2</code>
	内におきます。</p><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-agent&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-agent</span>(1)</span></a> と <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-add&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-add</span>(1)</span></a> は
	複数のパスワード化された秘密鍵の管理に使われます。</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90547280"></a>15.10.7. SSH トンネリング</h3></div></div></div><a id="idp90547920" class="indexterm"></a><p>OpenSSH は暗号化されたセッションの中に他のプロトコルを
	カプセル化するトンネルを作ることができます。</p><p>以下のコマンドは <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a> で telnet
	用のトンネルを作成します。</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ssh -2 -N -f -L 5023:localhost:23 user@foo.example.com</code></strong>
<code class="prompt">%</code></pre><p><code class="command">ssh</code> コマンドは、
	次のオプションとともに利用します。</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-2</code></span></dt><dd><p><code class="command">ssh</code> にプロトコルバージョン 2
	      を使うことを指示します。(古い ssh
	      サーバを使っているときには指定しないでください)</p></dd><dt><span class="term"><code class="option">-N</code></span></dt><dd><p>はトンネルだけでコマンドはないことを示します。
	      省略されると <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a> は通常のセッションを開始します。</p></dd><dt><span class="term"><code class="option">-f</code></span></dt><dd><p><code class="command">ssh</code>
	      にバックグラウンド実行を強制します。</p></dd><dt><span class="term"><code class="option">-L</code></span></dt><dd><p>ローカルトンネルを
	      <em class="replaceable"><code>localport:remotehost:remoteport</code></em>
	      という形式で指定します。</p></dd><dt><span class="term"><code class="option">user@foo.example.com</code></span></dt><dd><p>リモートの SSH サーバです。</p></dd></dl></div><p>SSH のトンネルは <code class="systemitem">localhost</code>
	の指定されたポートに listen
	するソケットを作ることで実現されています。
	SSH はローカルのホスト/ポートで受けた接続すべてを SSH
	接続経由で指定されたリモートホストのポートへ転送します。</p><p>この例では、<code class="systemitem">localhost</code> のポート
	<em class="replaceable"><code>5023</code></em>	がリモートマシンの
	<code class="systemitem">localhost</code> のポート <em class="replaceable"><code>23</code></em>
	に転送されるようになっています。
 	<em class="replaceable"><code>23</code></em> は telnet なのでこれは SSH
 	トンネルを通るセキュアな telnet セッションを作ります。</p><p>このようにして SMTP や POP3, FTP 等のセキュアではない TCP
	プロトコルをカプセル化することができます。</p><div class="example"><a id="idp90570832"></a><div class="example-title">例15.1 SSH を用いた SMTP 用の安全なトンネルの作成</div><div class="example-contents"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ssh -2 -N -f -L 5025:localhost:25 user@mailserver.example.com</code></strong>

user@mailserver.example.com's password: <strong class="userinput"><code>*****</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>telnet localhost 5025</code></strong>
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 mailserver.example.com ESMTP</pre><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-keygen&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-keygen</span>(1)</span></a>
	  と別のユーザアカウントを組み合わせて使うことでより透過的で悩まずに済むような
	  SSH のトンネル環境を作ることができます。
	  パスワードを入力するところで暗号鍵を使い、
	  トンネルは別のユーザ権限で実行することが可能です。</p></div></div><br class="example-break" /><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90579152"></a>15.10.7.1. 実用的な SSH トンネルの例</h4></div></div></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90579792"></a>15.10.7.1.1. POP3 サーバへの安全な接続</h5></div></div></div><p>仕事で、外部からの接続を受ける SSH サーバがあるとします。
	    同じオフィスのネットワークには、POP3
	    サーバが動いているメールサーバがあるとします。
	    ネットワークもしくはあなたの家とオフィスの間のネットワーク経路は、
	    完全に信頼できるものかもしれませんし、そうではないかもしれません。
	    そのため、電子メールは安全なやり方で見るようにしなければなりません。
	    解決策は、オフィスの SSH サーバへの SSH 接続を行い、
	    メールサーバへのトンネルを作成することです。</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ssh -2 -N -f -L 2110:mail.example.com:110 user@ssh-server.example.com</code></strong>
user@ssh-server.example.com's password: <strong class="userinput"><code>******</code></strong></pre><p>トンネルが作成されて動作したら、
	    メールクライアントに対し <code class="systemitem">localhost</code>
	    のポート 2110 に POP3 リクエストを送るように指示できます。
	    そこへの接続は、トンネルを経由して安全に
	    <code class="systemitem">mail.example.com</code> に転送されます。</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90583376"></a>15.10.7.1.2. 厳格なファイアウォールをすり抜ける</h5></div></div></div><p>内向けの接続をフィルタするだけでなく、
	    外向けの接続もフィルタして、
	    極端に厳しいファイアウォールルールを課すネットワーク管理者もいます。
	    リモートのマシンには、SSH 接続と web サーフィンのための
	    22 番および 80 番ポートにしか接続させてもらえないかもしれません。</p><p>あなたは、それ以外の (もしかすると仕事に関係ない)
	    サービスにアクセスしたくなるかもしれません。
	    例えば、音楽ストリーミングを行う
	    Ogg Vorbis サーバといったものです。
	    この Ogg Vorbis サーバが 22 番または
	    80 番ポート以外でストリーミングを行っていたら、
	    あなたはそのサーバに接続できないでしょう。</p><p>それに対する解決策は、
	    あなたが接続しているネットワークのファイアウォールの外部にあるマシンに対して
	    SSH 接続を行い、Ogg Vorbis
	    サーバへのトンネルに利用することです。</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ssh -2 -N -f -L 8888:music.example.com:8000 user@unfirewalled.myserver.com</code></strong>
user@unfirewalled.myserver.com's password: <strong class="userinput"><code>*******</code></strong></pre><p>ストリーミングクライアントを <code class="systemitem">localhost</code>
	    の 8888 番ポートに向けると、<code class="systemitem">music.example.com</code>
	    の 8000 番ポートに転送され、
	    ファイアウォールをすり抜けられます。</p></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp90588112"></a>15.10.8. もっと詳しく知りたい人へ</h3></div></div></div><p><a class="link" href="http://www.openssh.com/" target="_top">OpenSSH</a></p><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a> <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=scp&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">scp</span>(1)</span></a> <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-keygen&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-keygen</span>(1)</span></a>
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-agent&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-agent</span>(1)</span></a> <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=ssh-add&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">ssh-add</span>(1)</span></a></p><p><a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a> <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=sftp-server&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">sftp-server</span>(8)</span></a></p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ipsec.html">戻る</a>〓</td><td width="20%" align="center"><a accesskey="u" href="security.html">上に戻る</a></td><td width="40%" align="right">〓<a accesskey="n" href="fs-acl.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">15.9. IPsec〓</td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top">〓15.11. ファイルシステムアクセス制御リスト</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文書、および他の文書は
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>
    からダウンロードできます。</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>FreeBSD に関する質問がある場合には、
    <a href="http://www.FreeBSD.org/ja/docs.html">ドキュメント</a> を読んだ上で
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt; まで (英語で) 連絡してください。<br></br>
    本文書に関する質問については、
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt; まで電子メールを (英語で) 送ってください。</small></p></body></html>