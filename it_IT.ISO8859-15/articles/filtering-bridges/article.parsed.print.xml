<?xml version="1.0" encoding="iso-8859-15"?>
<!--
     The FreeBSD Italian Documentation Project

     $FreeBSD$
     Original revision: 1.21
-->
<article xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:lang="it">
  <info><title xmlns:xlink="http://www.w3.org/1999/xlink">Filtering Bridges</title>
    

    <authorgroup xmlns:xlink="http://www.w3.org/1999/xlink">
      <author xmlns:xlink="http://www.w3.org/1999/xlink"><personname xmlns:xlink="http://www.w3.org/1999/xlink"><firstname xmlns:xlink="http://www.w3.org/1999/xlink">Alex</firstname><surname xmlns:xlink="http://www.w3.org/1999/xlink">Dupre</surname></personname><affiliation xmlns:xlink="http://www.w3.org/1999/xlink">
          <address xmlns:xlink="http://www.w3.org/1999/xlink"><email xmlns:xlink="http://www.w3.org/1999/xlink">ale@FreeBSD.org</email></address>
        </affiliation></author>
    </authorgroup>

    <legalnotice xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="trademarks" role="trademarks">
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">FreeBSD è un marchio registrato della
  FreeBSD Foundation.</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">3Com e HomeConnect sono marchi registrati
  della 3Com Corporation.</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">Intel, Celeron, EtherExpress, i386,
  i486, Itanium, Pentium, e Xeon sono marchi o marchi registrati della
  Intel Corporation o delle sue sussidiarie negli Stati Uniti e in altri
  paesi.</para>
      <para xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">Molti dei nomi identificativi usati dai
  produttori e dai venditori per distinguere i loro prodotti sono anche dei
  marchi.  Quando questi nomi appaiono nel libro, e il FreeBSD Project
  è al corrente del marchio, vengono fatti seguire dal simbolo
  <quote xmlns:xlink="http://www.w3.org/1999/xlink">TM</quote> o <quote xmlns:xlink="http://www.w3.org/1999/xlink">®</quote>.</para>
    </legalnotice>

    <pubdate xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</pubdate>

    <releaseinfo xmlns:xlink="http://www.w3.org/1999/xlink">$FreeBSD$</releaseinfo>

    <abstract xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">Spesso è utile dividere una rete fisica (come una Ethernet)
        in due segmenti separati, senza dover creare sottoreti e usare un router
        per collegarli assieme.  Il dispositivo che collega due reti insieme in
        questo modo è chiamato bridge.  Un sistema FreeBSD con due
        interfacce di rete è sufficiente per raggiungere lo scopo.</para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Un bridge funziona individuando gli indirizzi del livello
        <acronym xmlns:xlink="http://www.w3.org/1999/xlink">MAC</acronym> (indirizzi Ethernet) dei dispositivi collegati ad
        ognuna delle sue interfacce di rete e inoltrando il traffico tra le due
        reti solo se il mittente e il destinatario si trovano su segmenti
        differenti.  Sotto molti punti di vista un brigde è simile a uno
        switch Ethernet con solo due porte.</para>
    </abstract>
  </info>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="filtering-bridges-why">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Perché usare un filtering bridge?</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Sempre più frequentemente, grazie all'abbassamento dei costi
      delle connessioni a banda larga (xDSL) e a causa della riduzione del
      numero di indirizzi IPv4 disponibili, molte società si ritrovano
      collegate ad Internet 24 ore su 24 e con un numero esiguo (a volte nemmeno
      una potenza di 2) di indirizzi IP.  In situazioni come queste spesso
      è desiderabile avere un firewall che regoli i permessi di ingresso
      e uscita per il traffico da e verso Internet, ma una soluzione basata
      sulle funzionalità di packet filtering dei router può non
      essere applicabile, vuoi per problemi di suddivisione delle sottoreti,
      vuoi perché il router è di proprietà del fornitore di
      accesso (<acronym xmlns:xlink="http://www.w3.org/1999/xlink">ISP</acronym>), vuoi perché il router non
      supporta tali funzionalità.  È in questi casi che l'utilizzo
      di un filtering bridge diventa altamente consigliato.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Un firewall basato su bridge può essere configurato e inserito
      direttamente tra il router xDSL e il vostro hub/switch Ethernet senza
      alcun problema di assegnazione di indirizzi IP.</para>

    <note xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">La traduzione italiana di <quote xmlns:xlink="http://www.w3.org/1999/xlink">firewall</quote> è
	<quote xmlns:xlink="http://www.w3.org/1999/xlink">muro anti incendio</quote>, <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">non</emphasis>
	<quote xmlns:xlink="http://www.w3.org/1999/xlink">muro di fuoco</quote> come molti pensano.  Nel corso
        dell'articolo, comunque, manterrò i termini tecnici nella loro
        lingua originale in modo da non creare confusione o
        ambiguità.</para>
    </note>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="filtering-bridges-how">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Metodi d'installazione</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Aggiungere le funzionalità di bridge a una macchina FreeBSD non
      è difficile.  Dalla release 4.5 è possibile caricare tali
      funzionalità come moduli anziché dover ricompilare il
      kernel, semplificando di gran lunga la procedura.  Nelle prossime
      sottosezioni spiegherò entrambi i metodi di installazione.</para>

    <important xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink"><emphasis xmlns:xlink="http://www.w3.org/1999/xlink">Non</emphasis> seguite entrambe le istruzioni: le
        procedure sono <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">a esclusione</emphasis>.  Scegliete
        l'alternativa che meglio si adatta alle vostre esigenze e
        capacità.</para>
    </important>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Prima di continuare è necessario assicurarsi di avere almeno
      due schede di rete Ethernet che supportino la modalità promiscua
      sia in ricezione che in trasmissione, difatti devono essere in grado di
      inviare pacchetti Ethernet con qualunque indirizzo, non solo il loro.
      Inoltre, per avere un buon rendimento, le schede dovrebbero essere di
      tipo PCI bus mastering.  Le scelte migliori sono ancora le Intel
      <trademark xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">EtherExpress</trademark> Pro seguite dalle <trademark xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" class="registered">3Com</trademark> 3c9xx subito dopo.  Per
      comodità nella configurazione del firewall può essere
      utile avere due schede di marche differenti (che usino drivers
      differenti) in modo da distinguere chiaramente quale interfaccia sia
      collegata al router e quale alla rete interna.</para>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="filtering-bridges-kernel">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Configurazione del Kernel</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Così avete deciso di utilizzare il più vecchio e
        collaudato metodo di installazione.  Per prima cosa bisogna
	aggiungere le seguenti righe al file di configurazione del
	kernel:</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">options BRIDGE
options IPFIREWALL
options IPFIREWALL_VERBOSE</programlisting>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">La prima riga serve a compilare il supporto per il bridge, la
        seconda il firewall e la terza le funzioni di logging del firewall.
      </para>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Adesso è necessario compilare e installare il nuovo kernel.
        Si possono trovare le istruzioni nella sezione <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.FreeBSD.org/doc/it_IT.ISO8859-15/books/handbook/kernelconfig-building.html">
        Building and Installing a Custom Kernel</link> dell'handbook.</para>
    </sect2>

    <sect2 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="filtering-bridges-modules">
      <title xmlns:xlink="http://www.w3.org/1999/xlink">Caricamento dei Moduli</title>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">Se avete deciso di usare il nuovo e più semplice metodo di
        installazione, l'unica cosa da fare è aggiungere la seguente riga
        al file <filename xmlns:xlink="http://www.w3.org/1999/xlink">/boot/loader.conf</filename>:</para>

      <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">bridge_load="YES"</programlisting>

      <para xmlns:xlink="http://www.w3.org/1999/xlink">In questo modo all'avvio della macchina verrà caricato
        insieme al kernel anche il modulo <filename xmlns:xlink="http://www.w3.org/1999/xlink">bridge.ko</filename>.  Non
        è necessario invece aggiungere una riga per il modulo
        <filename xmlns:xlink="http://www.w3.org/1999/xlink">ipfw.ko</filename> in quanto verrà caricato in
        automatico dallo script <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.network</filename> dopo aver
        seguito i passi della prossima sezione.</para>
    </sect2>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="filtering-bridges-finalprep">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Preparativi finali</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Prima di riavviare per caricare il nuovo kernel o i moduli richiesti
      (a seconda del metodo che avete scelto in precedenza), bisogna effettuare
      alcune modifiche al file <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.conf</filename>.  La regola di
      default del firewall è di rifiutare tutti i pacchetti IP.  Per
      iniziare attiviamo il firewall in modalità <option xmlns:xlink="http://www.w3.org/1999/xlink">open</option>,
      in modo da verificare il suo funzionamento senza alcun problema di
      filtraggio pacchetti (nel caso stiate eseguendo questa procedura da
      remoto, tale accorgimento vi consentirà di non rimanere
      erroneamente tagliati fuori dalla rete).
      Inserite queste linee nel file <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.conf</filename>:</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">firewall_enable="YES"
firewall_type="open"
firewall_quiet="YES"
firewall_logging="YES"</programlisting>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">La prima riga serve ad attivare il firewall (e a caricare il modulo
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">ipfw.ko</filename> nel caso non fosse già compilato nel
      kernel), la seconda a impostarlo in modalità
      <option xmlns:xlink="http://www.w3.org/1999/xlink">open</option> (come descritto nel file
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.firewall</filename>), la terza a non
      visualizzare il caricamento delle regole e la quarta ad abilitare il
      supporto per il logging.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Per quanto riguarda la configurazione delle interfacce di rete, il
      metodo più utilizzato è quello di assegnare un IP a solo una
      delle schede di rete, ma il bridge funziona egualmente anche se entrambe o
      nessuna delle interfacce ha IP settati.  In quest'ultimo caso (IP-less) la
      macchina bridge sarà ancora più nascosta in quanto
      inaccessibile dalla rete: per configurarla occorrerà quindi entrare
      da console o tramite una terza interfaccia di rete separata dal bridge.  A
      volte all'avvio della macchina qualche programma richiede di accedere alla
      rete, per esempio per una risoluzione di dominio: in questo caso è
      necessario assegnare un IP all'interfaccia esterna (quella collegata a
      Internet, dove risiede il server <acronym xmlns:xlink="http://www.w3.org/1999/xlink">DNS</acronym>), visto che il
      bridge verrà attivato alla fine della procedura di avvio.  Questo
      vuol dire che l'interfaccia <filename xmlns:xlink="http://www.w3.org/1999/xlink">fxp0</filename> (nel nostro
      caso) deve essere menzionata nella sezione ifconfig del file
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.conf</filename>, mentre la <filename xmlns:xlink="http://www.w3.org/1999/xlink">xl0</filename>
      no.  Assegnare IP a entrambe le schede di rete non ha molto senso, a meno
      che durante la procedura di avvio non si debba accedere a servizi presenti
      su entrambi i segmenti Ethernet.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">C'è un'altra cosa importante da sapere.  Quando si utilizza IP
      sopra Ethernet ci sono due protocolli Ethernet in uso: uno è IP,
      l'altro è <acronym xmlns:xlink="http://www.w3.org/1999/xlink">ARP</acronym>.  <acronym xmlns:xlink="http://www.w3.org/1999/xlink">ARP</acronym> permette
      la conversione dell'indirizzo IP di una macchina nel suo indirizzo
      Ethernet (livello <acronym xmlns:xlink="http://www.w3.org/1999/xlink">MAC</acronym>).  Affinché due macchine
      separate dal bridge riescano a comunicare tra loro è necessario che
      il bridge lasci passare i pacchetti <acronym xmlns:xlink="http://www.w3.org/1999/xlink">ARP</acronym>.  Tale
      protocollo non fa parte del livello IP, visto che è presente solo
      con IP sopra Ethernet.  Il firewall di FreeBSD agisce esclusivamente sul
      livello IP e quindi tutti i pacchetti non IP (compreso
      <acronym xmlns:xlink="http://www.w3.org/1999/xlink">ARP</acronym>) verranno inoltrati senza essere filtrati, anche se
      il firewall è configurato per non lasciar passare nulla.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Ora è arrivato il momento di riavviare la macchina e usarla
      come in precedenza: appariranno dei nuovi messaggi riguardo al bridge e al
      firewall, ma il bridge non sarà attivato e il firewall, essendo in
      modalità <option xmlns:xlink="http://www.w3.org/1999/xlink">open</option>, non impedirà nessuna
      operazione.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Se ci dovessero essere dei problemi, è il caso di scoprire ora
      da cosa derivino e risolverli prima di continuare.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="filtering-bridges-enabling">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Attivazione del Bridge</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">A questo punto, per attivare il bridge, bisogna eseguire i seguenti
      comandi (avendo l'accortezza di sostituire i nomi delle due interfacce di
      rete <filename xmlns:xlink="http://www.w3.org/1999/xlink">fxp0</filename> e <filename xmlns:xlink="http://www.w3.org/1999/xlink">xl0</filename> con i
      propri):</para>

    <screen xmlns:xlink="http://www.w3.org/1999/xlink"><prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">sysctl net.link.ether.bridge.config=fxp0:0,xl0:0</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">sysctl net.link.ether.bridge.ipfw=1</userinput>
<prompt xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">#</prompt> <userinput xmlns:xlink="http://www.w3.org/1999/xlink">sysctl net.link.ether.bridge.enable=1</userinput></screen>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">La prima riga specifica tra quali interfacce va attivato il bridge,
      la seconda abilita il firewall sul bridge ed infine la terza attiva il
      bridge.</para>

    <note xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">Se hai FreeBSD 5.1-RELEASE o precedenti le variabili sysctl
        sono chiamate in modo differente.  Guarda <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">bridge</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">4</manvolnum></citerefentry> per i
        dettagli.</para>
    </note>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">A questo punto dovrebbe essere possibile inserire la macchina tra
      due gruppi di host senza che venga compromessa qualsiasi
      possibilità di comunicazione tra di loro.  Se è così,
      il prossimo passo è quello di aggiungere le parti
      <literal xmlns:xlink="http://www.w3.org/1999/xlink">net.link.ether.bridge.[blah]=[blah]</literal>
      di queste righe al file <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/sysctl.conf</filename>, in modo che
      vengano eseguite all'avvio della macchina.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="filtering-bridges-ipfirewall">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Configurazione del Firewall</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Ora è arrivato il momento di creare il proprio file con le
      regole per il firewall, in modo da rendere sicura la rete interna.
      Ci sono delle complicazioni nel fare questo, perché non tutte le
      funzionalità del firewall sono disponibili sui pacchetti inoltrati
      dal bridge.  Inoltre, c'è una differenza tra i pacchetti che stanno
      per essere inoltrati dal bridge e quelli indirizzati alla macchina locale.
      In generale, i pacchetti che entrano nel bridge vengono processati dal
      firewall solo una volta, non due come al solito; infatti vengono filtrati
      solo in ingresso, quindi qualsiasi regola che usi <option xmlns:xlink="http://www.w3.org/1999/xlink">out</option>
      oppure <option xmlns:xlink="http://www.w3.org/1999/xlink">xmit</option> non verrà mai eseguita.  Personalmente
      uso <option xmlns:xlink="http://www.w3.org/1999/xlink">in via</option> che è una sintassi più antica,
      ma che ha un senso quando la si legge.
      Un'altra limitazione è che si possono usare solo i comandi
      <option xmlns:xlink="http://www.w3.org/1999/xlink">pass</option> e <option xmlns:xlink="http://www.w3.org/1999/xlink">drop</option> per i pacchetti filtrati
      dal bridge.  Cose avanzate come <option xmlns:xlink="http://www.w3.org/1999/xlink">divert</option>,
      <option xmlns:xlink="http://www.w3.org/1999/xlink">forward</option> o <option xmlns:xlink="http://www.w3.org/1999/xlink">reject</option> non sono disponibili.
      Queste opzioni possono ancora essere usate, ma solo per il traffico da
      e verso la macchina bridge stessa (sempre che le sia stato assegnato
      un IP).</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Nuovo in FreeBSD 4.0 è il concetto di stateful filtering.
      Questo è un grande miglioramento per il traffico
      <acronym xmlns:xlink="http://www.w3.org/1999/xlink">UDP</acronym>, che consiste tipicamente di una richiesta in
      uscita, seguita a breve termine da una risposta con la stessa coppia di
      indirizzi IP e numeri di porta (ma con mittente e destinatario invertiti,
      ovviamente).  Per i firewall che non supportano il mantenimento di stato,
      non c'è modo di gestire questo breve scambio di dati come una
      sessione unica.  Ma con un firewall che può
      <quote xmlns:xlink="http://www.w3.org/1999/xlink">ricordarsi</quote> di un pacchetto <acronym xmlns:xlink="http://www.w3.org/1999/xlink">UDP</acronym> in
      uscita e permette una risposta nei minuti successivi, gestire i
      servizi <acronym xmlns:xlink="http://www.w3.org/1999/xlink">UDP</acronym> è semplice.
      L'esempio seguente mostra come fare.  La stessa cosa è
      possibile farla con i pacchetti <acronym xmlns:xlink="http://www.w3.org/1999/xlink">TCP</acronym>.  Questo
      permette di evitare qualche tipo di attacco denial of service e altri
      sporchi trucchi, ma tipicamente fa anche crescere velocemente la
      tabella di stato.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Vediamo un esempio di configurazione.  Bisogna notare che all'inizio
      del file <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.firewall</filename> ci sono già delle
      regole standard per l'interfaccia di loopback
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">lo0</filename>, quindi non ce ne occuperemo più ora.
      Le regole personalizzate andrebbero messe in un file a parte (per esempio
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.firewall.local</filename>) e caricate all'avvio
      modificando la riga del file <filename xmlns:xlink="http://www.w3.org/1999/xlink">/etc/rc.conf</filename> dove era
      stata definita la modalità <option xmlns:xlink="http://www.w3.org/1999/xlink">open</option> con:</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">firewall_type="/etc/rc.firewall.local"</programlisting>

    <important xmlns:xlink="http://www.w3.org/1999/xlink">
      <para xmlns:xlink="http://www.w3.org/1999/xlink">Bisogna specificare il path <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">completo</emphasis>
        del file, altrimenti non verrà caricato con il rischio di
        rimanere tagliati fuori dalla rete.</para>
    </important>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Per il nostro esempio immaginiamo di avere l'interfaccia
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">fxp0</filename> collegata all'esterno (Internet) e la
      <filename xmlns:xlink="http://www.w3.org/1999/xlink">xl0</filename> verso l'interno (<acronym xmlns:xlink="http://www.w3.org/1999/xlink">LAN</acronym>).
      La macchina bridge ha assegnato l'IP
      <systemitem xmlns:xlink="http://www.w3.org/1999/xlink" class="ipaddress">1.2.3.4</systemitem>
      (è impossibile che il vostro <acronym xmlns:xlink="http://www.w3.org/1999/xlink">ISP</acronym> vi assegni un
      indirizzo simile a questo, ma per l'esempio va bene).</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink"># Le connessioni di cui abbiamo mantenuto lo stato vengono fatte passare subito
add check-state

# Esclude le reti locali definite nell'RFC 1918
add drop all from 10.0.0.0/8 to any in via fxp0
add drop all from 172.16.0.0/12 to any in via fxp0
add drop all from 192.168.0.0/16 to any in via fxp0

# Permette alla macchina bridge di connettersi con chi vuole
# (se la macchina è IP-less non includere questi comandi)
add pass tcp from 1.2.3.4 to any setup keep-state
add pass udp from 1.2.3.4 to any keep-state
add pass ip from 1.2.3.4 to any

# Permette agli host della rete interna di connettersi con chi vogliono
add pass tcp from any to any in via xl0 setup keep-state
add pass udp from any to any in via xl0 keep-state
add pass ip from any to any in via xl0

# Sezione TCP
# Permette SSH
add pass tcp from any to any 22 in via fxp0 setup keep-state
# Permette SMTP solo verso il mail server
add pass tcp from any to relay 25 in via fxp0 setup keep-state
# Permette i trasferimenti di zona solo dal name server secondario [dns2.nic.it]
add pass tcp from 193.205.245.8 to ns 53 in via fxp0 setup keep-state
# Lascia passare i controlli ident:
# è meglio che aspettare che vadano in timeout
add pass tcp from any to any 113 in via fxp0 setup keep-state
# Permette connessioni nel range di "quarantena".
add pass tcp from any to any 49152-65535 in via fxp0 setup keep-state

# Sezione UDP
# Permette DNS solo verso il name server
add pass udp from any to ns 53 in via fxp0 keep-state
# Permette connessioni nel range di "quarantena".
add pass udp from any to any 49152-65535 in via fxp0 keep-state

# Sezione ICMP
# Abilita le funzioni di 'ping'
add pass icmp from any to any icmptypes 8 keep-state
# Permette il passaggio dei messaggi di errori del comando 'traceroute'
add pass icmp from any to any icmptypes 3
add pass icmp from any to any icmptypes 11

# Tutto il resto è sospetto
add drop log all from any to any</programlisting>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Coloro che hanno configurato un firewall in precedenza potrebbero aver
      notato che manca qualcosa.  In particolare, non ci sono regole contro lo
      spoofing, difatti <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">non</emphasis> abbiamo aggiunto:</para>

    <programlisting xmlns:xlink="http://www.w3.org/1999/xlink">add deny all from 1.2.3.4/8 to any in via fxp0</programlisting>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Ovvero, non far entrare dall'esterno pacchetti che affermano di venire
      dalla rete interna.  Questa è una cosa che solitamente viene fatta
      per essere sicuri che qualcuno non provi a eludere il packet filter,
      generando falsi pacchetti che sembrano venire dall'interno.  Il problema
      è che c'è <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">almeno</emphasis> un host
      sull'interfaccia esterna che non si può ignorare: il router.
      Solitamente, però, gli <acronym xmlns:xlink="http://www.w3.org/1999/xlink">ISP</acronym> eseguono il controllo
      anti-spoof sui loro router e quindi non ce ne dobbiamo preoccupare.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">L'ultima riga sembra un duplicato della regola di default, ovvero non
      far passare nulla che non sia stato specificatamente permesso.  In
      verità c'è una differenza: tutto il traffico sospetto
      verrà loggato.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Ci sono due regole per permettere il traffico <acronym xmlns:xlink="http://www.w3.org/1999/xlink">SMTP</acronym>
      e <acronym xmlns:xlink="http://www.w3.org/1999/xlink">DNS</acronym> verso il mail server e il name server, se ne
      avete.  Ovviamente l'intero set di regole deve essere personalizzato
      per le proprie esigenze, questo non è altro che uno specifico
      esempio (il formato delle regole è spiegato dettagliatamente nella
      man page <citerefentry xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"><refentrytitle xmlns:xlink="http://www.w3.org/1999/xlink">ipfw</refentrytitle><manvolnum xmlns:xlink="http://www.w3.org/1999/xlink">8</manvolnum></citerefentry>).  Bisogna notare che, affinché
      <quote xmlns:xlink="http://www.w3.org/1999/xlink">relay</quote> e <quote xmlns:xlink="http://www.w3.org/1999/xlink">ns</quote>
      siano interpretati correttamente, la risoluzione dei nomi deve funzionare
      <emphasis xmlns:xlink="http://www.w3.org/1999/xlink">prima</emphasis> che il bridge sia attivato.  Questo è un
      chiaro esempio che dimostra l'importanza di settare l'IP sulla corretta
      scheda di rete.  In alternativa è possibile specificare
      direttamente l'indirizzo IP anziché il nome host (cosa necessaria
      se la macchina è IP-less).</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Le persone che sono solite configurare un firewall probabilmente
      avranno sempre usato una regola <option xmlns:xlink="http://www.w3.org/1999/xlink">reset</option> o
      <option xmlns:xlink="http://www.w3.org/1999/xlink">forward</option> per i pacchetti
      ident (porta 113 <acronym xmlns:xlink="http://www.w3.org/1999/xlink">TCP</acronym>).  Sfortunatamente, questa non
      è una scelta applicabile con il bridge, quindi la cosa migliore
      è lasciarli passare fino alla destinazione.  Finché la
      macchina di destinazione non ha un demone ident attivo, questa tecnica
      è relativamente sicura.  L'alternativa è proibire le
      connessioni sulla porta 113, creando qualche problema con servizi tipo
      <acronym xmlns:xlink="http://www.w3.org/1999/xlink">IRC</acronym> (le richieste ident devono andare in
      timeout).</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">L'unica altra cosa un po' particolare che potete aver notato è
      che c'è una regola per lasciar comunicare la macchina bridge e
      un'altra per gli host della rete interna.  Ricordate che questo è
      dovuto al fatto che i due tipi di traffico prendono percorsi differenti
      attraverso il kernel e di conseguenza anche dentro il packet filter.  La
      rete interna passerà attraverso il bridge, mentre la macchina
      locale userà il normale stack IP per le connessioni.  Perciò
      due regole per gestire due casi differenti.  Le regole <literal xmlns:xlink="http://www.w3.org/1999/xlink">in via
      fxp0</literal> funzionano in entrambi i casi.
      In generale, se usate regole <option xmlns:xlink="http://www.w3.org/1999/xlink">in via</option> attraverso il
      packet filter, dovrete fare un'eccezione per i pacchetti generati
      localmente, in quanto non entrano tramite nessuna interfaccia.</para>
  </sect1>

  <sect1 xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="filtering-bridges-contributors">
    <title xmlns:xlink="http://www.w3.org/1999/xlink">Contributi</title>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Alcune parti di questo articolo sono state prese, tradotte e
      adattate da testi sui bridge, appartenenti alla documentazione di FreeBSD
      in lingua inglese, a cura di Nick Sayer e Steve Peterson.</para>

    <para xmlns:xlink="http://www.w3.org/1999/xlink">Un grosso ringraziamento va a Luigi Rizzo per l'implementazione
      delle funzionalità di bridging in FreeBSD e per il tempo che mi ha
      dedicato rispondendo ad alcune mie domande a riguardo.</para>
  </sect1>
</article>
